{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debugging and Memory Analysis - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">üíª</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        ÌïúÍµ≠Ïñ¥
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">‚òÄÔ∏è</span>
                    <span class="theme-icon dark">üåô</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/C_Programming/">C Programming</a>
    <span class="separator">/</span>
    <span class="current">Debugging and Memory Analysis</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Debugging and Memory Analysis</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/C_Programming/17_Project_Serial_Communication.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Project 16: Serial Communication</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/C_Programming/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/C_Programming/19_Advanced_Embedded_Protocols.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Advanced Embedded Protocols</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#debugging-basics">Debugging Basics</a><ul>
<li><a href="#debug-build">Debug Build</a></li>
<li><a href="#printf-debugging">printf Debugging</a></li>
<li><a href="#assert-macro">assert Macro</a></li>
</ul>
</li>
<li><a href="#gdb-debugger">GDB Debugger</a><ul>
<li><a href="#starting-gdb">Starting GDB</a></li>
<li><a href="#basic-commands">Basic Commands</a></li>
<li><a href="#breakpoints">Breakpoints</a></li>
<li><a href="#inspecting-variables">Inspecting Variables</a></li>
<li><a href="#memory-inspection">Memory Inspection</a></li>
<li><a href="#stack-trace">Stack Trace</a></li>
<li><a href="#watchpoints">Watchpoints</a></li>
<li><a href="#gdb-practical-example">GDB Practical Example</a></li>
<li><a href="#gdb-tui-mode">GDB TUI Mode</a></li>
</ul>
</li>
<li><a href="#valgrind-memory-analysis">Valgrind Memory Analysis</a><ul>
<li><a href="#installing-valgrind">Installing Valgrind</a></li>
<li><a href="#basic-usage">Basic Usage</a></li>
<li><a href="#memcheck-tool">Memcheck Tool</a></li>
<li><a href="#memory-leak-example">Memory Leak Example</a></li>
<li><a href="#leak-types">Leak Types</a></li>
<li><a href="#invalid-memory-access">Invalid Memory Access</a></li>
</ul>
</li>
<li><a href="#addresssanitizer">AddressSanitizer</a><ul>
<li><a href="#using-asan">Using ASan</a></li>
<li><a href="#asan-advantages">ASan Advantages</a></li>
<li><a href="#asan-example">ASan Example</a></li>
<li><a href="#other-sanitizers">Other Sanitizers</a></li>
<li><a href="#ubsan-example">UBSan Example</a></li>
</ul>
</li>
<li><a href="#common-memory-bugs">Common Memory Bugs</a><ul>
<li><a href="#1-buffer-overflow">1. Buffer Overflow</a></li>
<li><a href="#2-use-after-free">2. Use After Free</a></li>
<li><a href="#3-double-free">3. Double Free</a></li>
<li><a href="#4-memory-leak">4. Memory Leak</a></li>
<li><a href="#5-uninitialized-memory">5. Uninitialized Memory</a></li>
<li><a href="#6-stack-overflow">6. Stack Overflow</a></li>
</ul>
</li>
<li><a href="#debugging-strategies">Debugging Strategies</a><ul>
<li><a href="#1-make-it-reproducible">1. Make It Reproducible</a></li>
<li><a href="#2-binary-search-for-bug-location">2. Binary Search for Bug Location</a></li>
<li><a href="#3-defensive-programming">3. Defensive Programming</a></li>
<li><a href="#4-logging-levels">4. Logging Levels</a></li>
</ul>
</li>
<li><a href="#exercises">Exercises</a><ul>
<li><a href="#problem-1-find-memory-leaks">Problem 1: Find Memory Leaks</a></li>
<li><a href="#problem-2-using-gdb">Problem 2: Using GDB</a></li>
</ul>
</li>
<li><a href="#next-step">Next Step</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="debugging-and-memory-analysis">Debugging and Memory Analysis<a class="header-link" href="#debugging-and-memory-analysis" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="header-link" href="#overview" title="Permanent link">&para;</a></h2>
<p>Effective debugging is a core competency for programmers. In this chapter, we learn how to find bugs and solve memory issues using the GDB debugger, Valgrind memory analysis tool, and AddressSanitizer.</p>
<p><strong>Difficulty</strong>: Advanced</p>
<p><strong>Prerequisites</strong>: Pointers, dynamic memory allocation</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#debugging-basics">Debugging Basics</a></li>
<li><a href="#gdb-debugger">GDB Debugger</a></li>
<li><a href="#valgrind-memory-analysis">Valgrind Memory Analysis</a></li>
<li><a href="#addresssanitizer">AddressSanitizer</a></li>
<li><a href="#common-memory-bugs">Common Memory Bugs</a></li>
<li><a href="#debugging-strategies">Debugging Strategies</a></li>
</ol>
<hr />
<h2 id="debugging-basics">Debugging Basics<a class="header-link" href="#debugging-basics" title="Permanent link">&para;</a></h2>
<h3 id="debug-build">Debug Build<a class="header-link" href="#debug-build" title="Permanent link">&para;</a></h3>
<p>To debug, you must compile with the <code>-g</code> flag.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Include debug symbols</span>
gcc<span class="w"> </span>-g<span class="w"> </span>-Wall<span class="w"> </span>-Wextra<span class="w"> </span>program.c<span class="w"> </span>-o<span class="w"> </span>program

<span class="c1"># Without optimization (easier debugging)</span>
gcc<span class="w"> </span>-g<span class="w"> </span>-O0<span class="w"> </span>-Wall<span class="w"> </span>-Wextra<span class="w"> </span>program.c<span class="w"> </span>-o<span class="w"> </span>program

<span class="c1"># Debug + optimization (tracking release bugs)</span>
gcc<span class="w"> </span>-g<span class="w"> </span>-O2<span class="w"> </span>-Wall<span class="w"> </span>-Wextra<span class="w"> </span>program.c<span class="w"> </span>-o<span class="w"> </span>program
</code></pre></div>

<h3 id="printf-debugging">printf Debugging<a class="header-link" href="#printf-debugging" title="Permanent link">&para;</a></h3>
<p>The most basic debugging method.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="cp">#define DEBUG 1</span>

<span class="cp">#if DEBUG</span>
<span class="w">    </span><span class="cp">#define DEBUG_PRINT(fmt, ...) \</span>
<span class="cp">        fprintf(stderr, &quot;[DEBUG] %s:%d: &quot; fmt &quot;\n&quot;, \</span>
<span class="cp">                __FILE__, __LINE__, ##__VA_ARGS__)</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="cp">#define DEBUG_PRINT(fmt, ...) ((void)0)</span>
<span class="cp">#endif</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;calculate called: a=%d, b=%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;result=%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculate</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="s">&quot;main: x=%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="assert-macro">assert Macro<a class="header-link" href="#assert-macro" title="Permanent link">&para;</a></h3>
<p>Used for precondition verification.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;assert.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">divide</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;Division by zero!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">process_array</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">arr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">arr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;Array is NULL!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;Size must be positive!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<blockquote>
<p><strong>Note</strong>: To disable assert in release builds, use the <code>-DNDEBUG</code> flag</p>
</blockquote>
<hr />
<h2 id="gdb-debugger">GDB Debugger<a class="header-link" href="#gdb-debugger" title="Permanent link">&para;</a></h2>
<h3 id="starting-gdb">Starting GDB<a class="header-link" href="#starting-gdb" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Load program</span>
gdb<span class="w"> </span>./program

<span class="c1"># With arguments</span>
gdb<span class="w"> </span>--args<span class="w"> </span>./program<span class="w"> </span>arg1<span class="w"> </span>arg2

<span class="c1"># Attach to running process</span>
gdb<span class="w"> </span>-p<span class="w"> </span>&lt;pid&gt;

<span class="c1"># Analyze core dump</span>
gdb<span class="w"> </span>./program<span class="w"> </span>core
</code></pre></div>

<h3 id="basic-commands">Basic Commands<a class="header-link" href="#basic-commands" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Command</th>
<th>Shortcut</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>run</code></td>
<td><code>r</code></td>
<td>Run program</td>
</tr>
<tr>
<td><code>continue</code></td>
<td><code>c</code></td>
<td>Continue execution</td>
</tr>
<tr>
<td><code>next</code></td>
<td><code>n</code></td>
<td>Next line (don't enter functions)</td>
</tr>
<tr>
<td><code>step</code></td>
<td><code>s</code></td>
<td>Next line (enter functions)</td>
</tr>
<tr>
<td><code>finish</code></td>
<td><code>fin</code></td>
<td>Run to end of current function</td>
</tr>
<tr>
<td><code>quit</code></td>
<td><code>q</code></td>
<td>Exit GDB</td>
</tr>
</tbody>
</table>
<h3 id="breakpoints">Breakpoints<a class="header-link" href="#breakpoints" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Set at line number</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="k">break</span><span class="w"> </span>main.c:15
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>b<span class="w"> </span><span class="m">15</span>

<span class="c1"># Set at function</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="k">break</span><span class="w"> </span>main
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="k">break</span><span class="w"> </span>calculate

<span class="c1"># Conditional breakpoint</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">5</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="k">break</span><span class="w"> </span>process<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">ptr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>NULL

<span class="c1"># List breakpoints</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>info<span class="w"> </span>breakpoints
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>info<span class="w"> </span>b

<span class="c1"># Delete breakpoint</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>delete<span class="w"> </span><span class="m">1</span><span class="w">        </span><span class="c1"># Delete #1</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>delete<span class="w">          </span><span class="c1"># Delete all</span>

<span class="c1"># Disable/enable breakpoint</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>disable<span class="w"> </span><span class="m">2</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="nb">enable</span><span class="w"> </span><span class="m">2</span>
</code></pre></div>

<h3 id="inspecting-variables">Inspecting Variables<a class="header-link" href="#inspecting-variables" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Print variable</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>print<span class="w"> </span>x
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>x
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>arr<span class="o">[</span><span class="m">0</span><span class="o">]</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>*ptr
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>ptr-&gt;field

<span class="c1"># Expressions</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>x<span class="w"> </span>+<span class="w"> </span>y
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>sizeof<span class="o">(</span>struct<span class="w"> </span>data<span class="o">)</span>

<span class="c1"># Print array</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>*arr@10<span class="w">        </span><span class="c1"># 10 elements</span>

<span class="c1"># Format specifiers</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p/x<span class="w"> </span>value<span class="w">        </span><span class="c1"># Hexadecimal</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p/t<span class="w"> </span>value<span class="w">        </span><span class="c1"># Binary</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p/d<span class="w"> </span>value<span class="w">        </span><span class="c1"># Decimal</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p/c<span class="w"> </span>value<span class="w">        </span><span class="c1"># Character</span>

<span class="c1"># Print all local variables</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>info<span class="w"> </span>locals

<span class="c1"># Global variables</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>info<span class="w"> </span>variables
</code></pre></div>

<h3 id="memory-inspection">Memory Inspection<a class="header-link" href="#memory-inspection" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Examine memory contents</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>x/10xb<span class="w"> </span>ptr<span class="w">       </span><span class="c1"># 10 bytes, hex</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>x/10dw<span class="w"> </span>ptr<span class="w">       </span><span class="c1"># 10 words, decimal</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>x/s<span class="w"> </span>str<span class="w">          </span><span class="c1"># String</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>x/10i<span class="w"> </span>func<span class="w">       </span><span class="c1"># 10 instructions (disassemble)</span>

<span class="c1"># Format: x/[count][format][size]</span>
<span class="c1"># Format: x(hex), d(decimal), s(string), i(instruction)</span>
<span class="c1"># Size: b(byte), h(2 bytes), w(4 bytes), g(8 bytes)</span>
</code></pre></div>

<h3 id="stack-trace">Stack Trace<a class="header-link" href="#stack-trace" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Backtrace (call stack)</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>backtrace
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>bt

<span class="c1"># Select specific frame</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>frame<span class="w"> </span><span class="m">2</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>f<span class="w"> </span><span class="m">2</span>

<span class="c1"># Frame info</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>info<span class="w"> </span>frame

<span class="c1"># Move up/down frames</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>up
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>down
</code></pre></div>

<h3 id="watchpoints">Watchpoints<a class="header-link" href="#watchpoints" title="Permanent link">&para;</a></h3>
<p>Stops when a variable is modified.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Write watchpoint</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>watch<span class="w"> </span>x
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>watch<span class="w"> </span>arr<span class="o">[</span><span class="m">5</span><span class="o">]</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>watch<span class="w"> </span>*ptr

<span class="c1"># Read watchpoint</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>rwatch<span class="w"> </span>x

<span class="c1"># Read/write watchpoint</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>awatch<span class="w"> </span>x

<span class="c1"># List watchpoints</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>info<span class="w"> </span>watchpoints
</code></pre></div>

<h3 id="gdb-practical-example">GDB Practical Example<a class="header-link" href="#gdb-practical-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// buggy.c - Code with a bug</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">sum_array</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">arr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// Bug: should use &lt; instead of &lt;=</span>
<span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">numbers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum_array</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Total: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="p">);</span>

<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">numbers</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>gcc<span class="w"> </span>-g<span class="w"> </span>-O0<span class="w"> </span>buggy.c<span class="w"> </span>-o<span class="w"> </span>buggy
$<span class="w"> </span>gdb<span class="w"> </span>./buggy

<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="k">break</span><span class="w"> </span>sum_array
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>run
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>print<span class="w"> </span>size
<span class="nv">$1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>print<span class="w"> </span>arr<span class="o">[</span><span class="m">0</span><span class="o">]</span>
<span class="nv">$2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>next
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>print<span class="w"> </span>i
<span class="nv">$3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>watch<span class="w"> </span>sum
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="k">continue</span>
<span class="c1"># Stops each time sum changes</span>
</code></pre></div>

<h3 id="gdb-tui-mode">GDB TUI Mode<a class="header-link" href="#gdb-tui-mode" title="Permanent link">&para;</a></h3>
<p>Debug while viewing source code with text user interface.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Start TUI mode</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>tui<span class="w"> </span><span class="nb">enable</span>
<span class="c1"># Or at startup</span>
$<span class="w"> </span>gdb<span class="w"> </span>-tui<span class="w"> </span>./program

<span class="c1"># Change layout</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>layout<span class="w"> </span>src<span class="w">       </span><span class="c1"># Source code</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>layout<span class="w"> </span>asm<span class="w">       </span><span class="c1"># Assembly</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>layout<span class="w"> </span>split<span class="w">     </span><span class="c1"># Source + Assembly</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>layout<span class="w"> </span>regs<span class="w">      </span><span class="c1"># Registers</span>

<span class="c1"># Exit TUI mode</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>tui<span class="w"> </span>disable
</code></pre></div>

<hr />
<h2 id="valgrind-memory-analysis">Valgrind Memory Analysis<a class="header-link" href="#valgrind-memory-analysis" title="Permanent link">&para;</a></h2>
<h3 id="installing-valgrind">Installing Valgrind<a class="header-link" href="#installing-valgrind" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Ubuntu/Debian</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>valgrind

<span class="c1"># macOS (Intel only)</span>
brew<span class="w"> </span>install<span class="w"> </span>valgrind

<span class="c1"># CentOS/RHEL</span>
sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>valgrind
</code></pre></div>

<h3 id="basic-usage">Basic Usage<a class="header-link" href="#basic-usage" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Run memory check</span>
valgrind<span class="w"> </span>./program

<span class="c1"># Detailed output</span>
valgrind<span class="w"> </span>--leak-check<span class="o">=</span>full<span class="w"> </span>./program

<span class="c1"># More detailed info</span>
valgrind<span class="w"> </span>--leak-check<span class="o">=</span>full<span class="w"> </span>--show-leak-kinds<span class="o">=</span>all<span class="w"> </span>./program

<span class="c1"># Save to log file</span>
valgrind<span class="w"> </span>--log-file<span class="o">=</span>valgrind.log<span class="w"> </span>./program
</code></pre></div>

<h3 id="memcheck-tool">Memcheck Tool<a class="header-link" href="#memcheck-tool" title="Permanent link">&para;</a></h3>
<p>The most commonly used Valgrind tool.</p>
<div class="highlight"><pre><span></span><code>valgrind<span class="w"> </span>--tool<span class="o">=</span>memcheck<span class="w"> </span>--leak-check<span class="o">=</span>full<span class="w"> </span><span class="se">\</span>
<span class="w">         </span>--track-origins<span class="o">=</span>yes<span class="w"> </span>./program
</code></pre></div>

<table>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--leak-check=full</code></td>
<td>Detailed leak information</td>
</tr>
<tr>
<td><code>--show-leak-kinds=all</code></td>
<td>Show all types of leaks</td>
</tr>
<tr>
<td><code>--track-origins=yes</code></td>
<td>Track origin of uninitialized values</td>
</tr>
<tr>
<td><code>--verbose</code></td>
<td>Verbose output</td>
</tr>
</tbody>
</table>
<h3 id="memory-leak-example">Memory Leak Example<a class="header-link" href="#memory-leak-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// leak.c</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">create_leak</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="w">    </span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// free(ptr); missing!</span>
<span class="p">}</span>

<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">duplicate_string</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">copy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">copy</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">copy</span><span class="p">;</span><span class="w">  </span><span class="c1">// Caller must free</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">create_leak</span><span class="p">();</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">duplicate_string</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// free(str); missing!</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>gcc<span class="w"> </span>-g<span class="w"> </span>leak.c<span class="w"> </span>-o<span class="w"> </span>leak
$<span class="w"> </span>valgrind<span class="w"> </span>--leak-check<span class="o">=</span>full<span class="w"> </span>./leak

<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w"> </span>HEAP<span class="w"> </span>SUMMARY:
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w">     </span><span class="k">in</span><span class="w"> </span>use<span class="w"> </span>at<span class="w"> </span>exit:<span class="w"> </span><span class="m">406</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w">   </span>total<span class="w"> </span>heap<span class="w"> </span>usage:<span class="w"> </span><span class="m">2</span><span class="w"> </span>allocs,<span class="w"> </span><span class="m">0</span><span class="w"> </span>frees,<span class="w"> </span><span class="m">406</span><span class="w"> </span>bytes<span class="w"> </span><span class="nv">allocated</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w"> </span><span class="m">6</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>blocks<span class="w"> </span>are<span class="w"> </span>definitely<span class="w"> </span>lost<span class="w"> </span><span class="k">in</span><span class="w"> </span>loss<span class="w"> </span>record<span class="w"> </span><span class="m">1</span><span class="w"> </span>of<span class="w"> </span><span class="nv">2</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w">    </span>at<span class="w"> </span>0x4C2FB0F:<span class="w"> </span>malloc<span class="w"> </span><span class="o">(</span>vg_replace_malloc.c:299<span class="o">)</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x10871B:<span class="w"> </span>duplicate_string<span class="w"> </span><span class="o">(</span>leak.c:11<span class="o">)</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108751:<span class="w"> </span>main<span class="w"> </span><span class="o">(</span>leak.c:18<span class="o">)</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w"> </span><span class="m">400</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>blocks<span class="w"> </span>are<span class="w"> </span>definitely<span class="w"> </span>lost<span class="w"> </span><span class="k">in</span><span class="w"> </span>loss<span class="w"> </span>record<span class="w"> </span><span class="m">2</span><span class="w"> </span>of<span class="w"> </span><span class="nv">2</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w">    </span>at<span class="w"> </span>0x4C2FB0F:<span class="w"> </span>malloc<span class="w"> </span><span class="o">(</span>vg_replace_malloc.c:299<span class="o">)</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x1086E2:<span class="w"> </span>create_leak<span class="w"> </span><span class="o">(</span>leak.c:5<span class="o">)</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108745:<span class="w"> </span>main<span class="w"> </span><span class="o">(</span>leak.c:16<span class="o">)</span>
</code></pre></div>

<h3 id="leak-types">Leak Types<a class="header-link" href="#leak-types" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>definitely lost</td>
<td>Definite leak (pointer lost)</td>
</tr>
<tr>
<td>indirectly lost</td>
<td>Indirect leak (was accessible through another block)</td>
</tr>
<tr>
<td>possibly lost</td>
<td>Possible leak (pointer points to middle of block)</td>
</tr>
<tr>
<td>still reachable</td>
<td>Still accessible at program exit</td>
</tr>
</tbody>
</table>
<h3 id="invalid-memory-access">Invalid Memory Access<a class="header-link" href="#invalid-memory-access" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// invalid.c</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Reading uninitialized value</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// Out of bounds write</span>
<span class="w">    </span><span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Out of bounds read</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">arr</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Use After Free</span>
<span class="w">    </span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Double free</span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">arr</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>valgrind<span class="w"> </span>--track-origins<span class="o">=</span>yes<span class="w"> </span>./invalid

<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w"> </span>Conditional<span class="w"> </span>jump<span class="w"> </span>or<span class="w"> </span>move<span class="w"> </span>depends<span class="w"> </span>on<span class="w"> </span>uninitialised<span class="w"> </span>value<span class="o">(</span>s<span class="o">)</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w">    </span>at<span class="w"> </span>0x108691:<span class="w"> </span>main<span class="w"> </span><span class="o">(</span>invalid.c:8<span class="o">)</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w">  </span>Uninitialised<span class="w"> </span>value<span class="w"> </span>was<span class="w"> </span>created<span class="w"> </span>by<span class="w"> </span>a<span class="w"> </span>heap<span class="w"> </span><span class="nv">allocation</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w">    </span>at<span class="w"> </span>0x4C2FB0F:<span class="w"> </span>malloc<span class="w"> </span><span class="o">(</span>vg_replace_malloc.c:299<span class="o">)</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108671:<span class="w"> </span>main<span class="w"> </span><span class="o">(</span>invalid.c:5<span class="o">)</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w"> </span>Invalid<span class="w"> </span>write<span class="w"> </span>of<span class="w"> </span>size<span class="w"> </span><span class="nv">4</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w">    </span>at<span class="w"> </span>0x1086A1:<span class="w"> </span>main<span class="w"> </span><span class="o">(</span>invalid.c:11<span class="o">)</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w">  </span>Address<span class="w"> </span>0x522d054<span class="w"> </span>is<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span>after<span class="w"> </span>a<span class="w"> </span>block<span class="w"> </span>of<span class="w"> </span>size<span class="w"> </span><span class="m">20</span><span class="w"> </span>alloc<span class="err">&#39;</span>d
</code></pre></div>

<hr />
<h2 id="addresssanitizer">AddressSanitizer<a class="header-link" href="#addresssanitizer" title="Permanent link">&para;</a></h2>
<h3 id="using-asan">Using ASan<a class="header-link" href="#using-asan" title="Permanent link">&para;</a></h3>
<p>Add flags when compiling.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># GCC</span>
gcc<span class="w"> </span>-fsanitize<span class="o">=</span>address<span class="w"> </span>-g<span class="w"> </span>program.c<span class="w"> </span>-o<span class="w"> </span>program

<span class="c1"># Clang</span>
clang<span class="w"> </span>-fsanitize<span class="o">=</span>address<span class="w"> </span>-g<span class="w"> </span>program.c<span class="w"> </span>-o<span class="w"> </span>program

<span class="c1"># Additional options</span>
gcc<span class="w"> </span>-fsanitize<span class="o">=</span>address<span class="w"> </span>-fno-omit-frame-pointer<span class="w"> </span>-g<span class="w"> </span>program.c<span class="w"> </span>-o<span class="w"> </span>program
</code></pre></div>

<h3 id="asan-advantages">ASan Advantages<a class="header-link" href="#asan-advantages" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Valgrind</th>
<th>ASan</th>
</tr>
</thead>
<tbody>
<tr>
<td>Speed</td>
<td>10-50x slower</td>
<td>2x slower</td>
</tr>
<tr>
<td>Memory usage</td>
<td>2x</td>
<td>3x</td>
</tr>
<tr>
<td>Stack overflow</td>
<td>X</td>
<td>O</td>
</tr>
<tr>
<td>Global variable overflow</td>
<td>X</td>
<td>O</td>
</tr>
<tr>
<td>Recompilation required</td>
<td>X</td>
<td>O</td>
</tr>
</tbody>
</table>
<h3 id="asan-example">ASan Example<a class="header-link" href="#asan-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// asan_test.c</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Heap buffer overflow</span>
<span class="w">    </span><span class="n">arr</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span>

<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">arr</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Use After Free</span>
<span class="w">    </span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>gcc<span class="w"> </span>-fsanitize<span class="o">=</span>address<span class="w"> </span>-g<span class="w"> </span>asan_test.c<span class="w"> </span>-o<span class="w"> </span>asan_test
$<span class="w"> </span>./asan_test

<span class="o">=================================================================</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span>ERROR:<span class="w"> </span>AddressSanitizer:<span class="w"> </span>heap-buffer-overflow<span class="w"> </span>on<span class="w"> </span>address<span class="w"> </span>0x604000000028
WRITE<span class="w"> </span>of<span class="w"> </span>size<span class="w"> </span><span class="m">4</span><span class="w"> </span>at<span class="w"> </span>0x604000000028<span class="w"> </span>thread<span class="w"> </span>T0
<span class="w">    </span><span class="c1">#0 0x4011a3 in main asan_test.c:8</span>
<span class="w">    </span><span class="c1">#1 0x7f123456789a in __libc_start_main</span>

0x604000000028<span class="w"> </span>is<span class="w"> </span>located<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>right<span class="w"> </span>of<span class="w"> </span><span class="m">40</span>-byte<span class="w"> </span>region
allocated<span class="w"> </span>by<span class="w"> </span>thread<span class="w"> </span>T0<span class="w"> </span>here:
<span class="w">    </span><span class="c1">#0 0x7f1234567890 in malloc</span>
<span class="w">    </span><span class="c1">#1 0x401157 in main asan_test.c:5</span>
</code></pre></div>

<h3 id="other-sanitizers">Other Sanitizers<a class="header-link" href="#other-sanitizers" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Undefined behavior check</span>
gcc<span class="w"> </span>-fsanitize<span class="o">=</span>undefined<span class="w"> </span>-g<span class="w"> </span>program.c<span class="w"> </span>-o<span class="w"> </span>program

<span class="c1"># Thread error check</span>
gcc<span class="w"> </span>-fsanitize<span class="o">=</span>thread<span class="w"> </span>-g<span class="w"> </span>program.c<span class="w"> </span>-o<span class="w"> </span>program<span class="w"> </span>-pthread

<span class="c1"># Combine multiple sanitizers</span>
gcc<span class="w"> </span>-fsanitize<span class="o">=</span>address,undefined<span class="w"> </span>-g<span class="w"> </span>program.c<span class="w"> </span>-o<span class="w"> </span>program
</code></pre></div>

<h3 id="ubsan-example">UBSan Example<a class="header-link" href="#ubsan-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// ubsan_test.c</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;limits.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INT_MAX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// Integer overflow (undefined behavior)</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">};</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span><span class="w">  </span><span class="c1">// Array out of bounds</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// *ptr = 42;  // NULL dereference</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>gcc<span class="w"> </span>-fsanitize<span class="o">=</span>undefined<span class="w"> </span>-g<span class="w"> </span>ubsan_test.c<span class="w"> </span>-o<span class="w"> </span>ubsan_test
$<span class="w"> </span>./ubsan_test

ubsan_test.c:7:15:<span class="w"> </span>runtime<span class="w"> </span>error:<span class="w"> </span>signed<span class="w"> </span>integer<span class="w"> </span>overflow:
<span class="m">2147483647</span><span class="w"> </span>+<span class="w"> </span><span class="m">1</span><span class="w"> </span>cannot<span class="w"> </span>be<span class="w"> </span>represented<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s1">&#39;int&#39;</span>
</code></pre></div>

<hr />
<h2 id="common-memory-bugs">Common Memory Bugs<a class="header-link" href="#common-memory-bugs" title="Permanent link">&para;</a></h2>
<h3 id="1-buffer-overflow">1. Buffer Overflow<a class="header-link" href="#1-buffer-overflow" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Problem</span>
<span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;This is too long!&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// Overflow</span>

<span class="c1">// Solution</span>
<span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="n">strncpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;This is too long!&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>

<span class="c1">// Or use snprintf</span>
<span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;This is too long!&quot;</span><span class="p">);</span>
</code></pre></div>

<h3 id="2-use-after-free">2. Use After Free<a class="header-link" href="#2-use-after-free" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Problem</span>
<span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span>
<span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span><span class="w">  </span><span class="c1">// Accessing freed memory</span>

<span class="c1">// Solution</span>
<span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span>
<span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w">  </span><span class="c1">// Set to NULL after free</span>
</code></pre></div>

<h3 id="3-double-free">3. Double Free<a class="header-link" href="#3-double-free" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Problem</span>
<span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w">  </span><span class="c1">// Double free</span>

<span class="c1">// Solution</span>
<span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w">  </span><span class="c1">// free(NULL) is safe</span>
<span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w">   </span><span class="c1">// OK</span>
</code></pre></div>

<h3 id="4-memory-leak">4. Memory Leak<a class="header-link" href="#4-memory-leak" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Problem</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error_condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">  </span><span class="c1">// Leak!</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Solution 1: Using goto</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error_condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">cleanup</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="nl">cleanup</span><span class="p">:</span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Solution 2: Structured</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">error_condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Normal processing</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="5-uninitialized-memory">5. Uninitialized Memory<a class="header-link" href="#5-uninitialized-memory" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Problem</span>
<span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w">  </span><span class="c1">// Garbage value</span>

<span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w">  </span><span class="c1">// Garbage value</span>

<span class="c1">// Solution</span>
<span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calloc</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span><span class="w">  </span><span class="c1">// Initialized to 0</span>
<span class="c1">// Or</span>
<span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="n">memset</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</code></pre></div>

<h3 id="6-stack-overflow">6. Stack Overflow<a class="header-link" href="#6-stack-overflow" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Problem: Infinite recursion</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">infinite</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">infinite</span><span class="p">();</span><span class="w">  </span><span class="c1">// Stack overflow</span>
<span class="p">}</span>

<span class="c1">// Problem: Large local variable</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">big_local</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">huge_array</span><span class="p">[</span><span class="mi">1000000</span><span class="p">];</span><span class="w">  </span><span class="c1">// Potential stack overflow</span>
<span class="p">}</span>

<span class="c1">// Solution: Dynamic allocation</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">use_heap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">1000000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="debugging-strategies">Debugging Strategies<a class="header-link" href="#debugging-strategies" title="Permanent link">&para;</a></h2>
<h3 id="1-make-it-reproducible">1. Make It Reproducible<a class="header-link" href="#1-make-it-reproducible" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Fix random seed</span>
<span class="n">srand</span><span class="p">(</span><span class="mi">12345</span><span class="p">);</span><span class="w">  </span><span class="c1">// Always same results</span>

<span class="c1">// Log inputs</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">log_input</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="s">&quot;input.log&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">);</span>
<span class="w">    </span><span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2-binary-search-for-bug-location">2. Binary Search for Bug Location<a class="header-link" href="#2-binary-search-for-bug-location" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Comment out half the code and check if bug occurs</span>
<span class="c1">// Repeat by halving the section with the bug</span>

<span class="c1">// Using git bisect</span>
<span class="c1">// $ git bisect start</span>
<span class="c1">// $ git bisect bad HEAD</span>
<span class="c1">// $ git bisect good v1.0</span>
</code></pre></div>

<h3 id="3-defensive-programming">3. Defensive Programming<a class="header-link" href="#3-defensive-programming" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Validate at function start</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">process_data</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Precondition checks</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Error: data is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Error: size is 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Processing logic...</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="4-logging-levels">4. Logging Levels<a class="header-link" href="#4-logging-levels" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LOG_ERROR</span><span class="p">,</span>
<span class="w">    </span><span class="n">LOG_WARNING</span><span class="p">,</span>
<span class="w">    </span><span class="n">LOG_INFO</span><span class="p">,</span>
<span class="w">    </span><span class="n">LOG_DEBUG</span>
<span class="p">}</span><span class="w"> </span><span class="n">LogLevel</span><span class="p">;</span>

<span class="n">LogLevel</span><span class="w"> </span><span class="n">current_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LOG_INFO</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">log_message</span><span class="p">(</span><span class="n">LogLevel</span><span class="w"> </span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">fmt</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">current_level</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">level_str</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;ERROR&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;WARN&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;INFO&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;DEBUG&quot;</span><span class="p">};</span>

<span class="w">    </span><span class="kt">va_list</span><span class="w"> </span><span class="n">args</span><span class="p">;</span>
<span class="w">    </span><span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="p">);</span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[%s] &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">level_str</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>
<span class="w">    </span><span class="n">vfprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Usage</span>
<span class="n">log_message</span><span class="p">(</span><span class="n">LOG_DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Processing item %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="n">log_message</span><span class="p">(</span><span class="n">LOG_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to open file: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
</code></pre></div>

<hr />
<h2 id="exercises">Exercises<a class="header-link" href="#exercises" title="Permanent link">&para;</a></h2>
<h3 id="problem-1-find-memory-leaks">Problem 1: Find Memory Leaks<a class="header-link" href="#problem-1-find-memory-leaks" title="Permanent link">&para;</a></h3>
<p>Find and fix all memory leaks in the following code.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">scores</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">num_scores</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">Student</span><span class="p">;</span>

<span class="n">Student</span><span class="w"> </span><span class="o">*</span><span class="nf">create_student</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_scores</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Student</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Student</span><span class="p">));</span>
<span class="w">    </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">scores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">num_scores</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="w">    </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">num_scores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_scores</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">process_students</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Student</span><span class="w"> </span><span class="o">*</span><span class="n">students</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="w">    </span><span class="n">students</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_student</span><span class="p">(</span><span class="s">&quot;Alice&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">    </span><span class="n">students</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_student</span><span class="p">(</span><span class="s">&quot;Bob&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="n">students</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_student</span><span class="p">(</span><span class="s">&quot;Charlie&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// No cleanup after processing!</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">process_students</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>View Solution</summary>


<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">free_student</span><span class="p">(</span><span class="n">Student</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">scores</span><span class="p">);</span>
<span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">process_students</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Student</span><span class="w"> </span><span class="o">*</span><span class="n">students</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="w">    </span><span class="n">students</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_student</span><span class="p">(</span><span class="s">&quot;Alice&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">    </span><span class="n">students</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_student</span><span class="p">(</span><span class="s">&quot;Bob&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="n">students</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_student</span><span class="p">(</span><span class="s">&quot;Charlie&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Cleanup</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">free_student</span><span class="p">(</span><span class="n">students</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>



</details>

<h3 id="problem-2-using-gdb">Problem 2: Using GDB<a class="header-link" href="#problem-2-using-gdb" title="Permanent link">&para;</a></h3>
<p>Debug the following code that causes a segmentation fault using GDB.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">recursive</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>
<span class="w">    </span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">recursive</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">recursive</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>Solution</summary>


<div class="highlight"><pre><span></span><code>$<span class="w"> </span>gcc<span class="w"> </span>-g<span class="w"> </span>-O0<span class="w"> </span>program.c<span class="w"> </span>-o<span class="w"> </span>program
$<span class="w"> </span>gdb<span class="w"> </span>./program
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>run
<span class="c1"># Segmentation fault occurs</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>bt
<span class="c1"># Stack overflow confirmed - recursive function called too many times</span>

<span class="c1"># Solution: Reduce recursion depth or use iteration</span>
</code></pre></div>



</details>

<hr />
<h2 id="next-step">Next Step<a class="header-link" href="#next-step" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="./19_Advanced_Embedded_Protocols.md">19_Advanced_Embedded_Protocols.md</a> - PWM, I2C, SPI</li>
</ul>
<hr />
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://www.gnu.org/software/gdb/documentation/">GDB Official Documentation</a></li>
<li><a href="https://valgrind.org/docs/manual/">Valgrind Official Documentation</a></li>
<li><a href="https://github.com/google/sanitizers/wiki/AddressSanitizer">AddressSanitizer Wiki</a></li>
<li><a href="https://sourceware.org/gdb/current/onlinedocs/gdb/">Debugging with GDB (Book)</a></li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/C_Programming/17_Project_Serial_Communication.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Project 16: Serial Communication</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/C_Programming/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/C_Programming/19_Advanced_Embedded_Protocols.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Advanced Embedded Protocols</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">‚Üë</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}