{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Compiler Infrastructure - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Compiler_Design/">Compiler Design</a>
    <span class="separator">/</span>
    <span class="current">Modern Compiler Infrastructure</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Modern Compiler Infrastructure</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Compiler_Design/15_Interpreters_and_Virtual_Machines.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Interpreters and Virtual Machines</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Compiler_Design/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-llvm-overview">1. LLVM Overview</a><ul>
<li><a href="#11-what-is-llvm">1.1 What is LLVM?</a></li>
<li><a href="#12-llvm-architecture">1.2 LLVM Architecture</a></li>
<li><a href="#13-the-three-phase-design">1.3 The Three-Phase Design</a></li>
<li><a href="#14-compiling-with-llvm-using-clang">1.4 Compiling with LLVM (Using Clang)</a></li>
</ul>
</li>
<li><a href="#2-llvm-ir-in-detail">2. LLVM IR in Detail</a><ul>
<li><a href="#21-ir-structure">2.1 IR Structure</a></li>
<li><a href="#22-type-system">2.2 Type System</a></li>
<li><a href="#23-ssa-and-instructions">2.3 SSA and Instructions</a></li>
<li><a href="#24-memory-instructions">2.4 Memory Instructions</a></li>
<li><a href="#25-control-flow">2.5 Control Flow</a></li>
<li><a href="#26-function-calls">2.6 Function Calls</a></li>
<li><a href="#27-complete-llvm-ir-example">2.7 Complete LLVM IR Example</a></li>
<li><a href="#28-generating-llvm-ir-from-python">2.8 Generating LLVM IR from Python</a></li>
</ul>
</li>
<li><a href="#3-writing-llvm-passes">3. Writing LLVM Passes</a><ul>
<li><a href="#31-pass-types">3.1 Pass Types</a></li>
<li><a href="#32-the-pass-pipeline">3.2 The Pass Pipeline</a></li>
<li><a href="#33-simulating-an-llvm-pass-in-python">3.3 Simulating an LLVM Pass in Python</a></li>
<li><a href="#34-real-llvm-pass-example-c-sketch">3.4 Real LLVM Pass Example (C++ Sketch)</a></li>
</ul>
</li>
<li><a href="#4-mlir-multi-level-ir">4. MLIR: Multi-Level IR</a><ul>
<li><a href="#41-the-problem-mlir-solves">4.1 The Problem MLIR Solves</a></li>
<li><a href="#42-mlir-concepts">4.2 MLIR Concepts</a></li>
<li><a href="#43-key-mlir-dialects">4.3 Key MLIR Dialects</a></li>
<li><a href="#44-progressive-lowering">4.4 Progressive Lowering</a></li>
</ul>
</li>
<li><a href="#5-gcc-internals">5. GCC Internals</a><ul>
<li><a href="#51-gcc-architecture">5.1 GCC Architecture</a></li>
<li><a href="#52-gimple">5.2 GIMPLE</a></li>
<li><a href="#53-rtl-register-transfer-language">5.3 RTL (Register Transfer Language)</a></li>
<li><a href="#54-llvm-vs-gcc-comparison">5.4 LLVM vs GCC Comparison</a></li>
</ul>
</li>
<li><a href="#6-domain-specific-languages">6. Domain-Specific Languages</a><ul>
<li><a href="#61-what-is-a-dsl">6.1 What is a DSL?</a></li>
<li><a href="#62-dsl-design-principles">6.2 DSL Design Principles</a></li>
<li><a href="#63-building-an-external-dsl">6.3 Building an External DSL</a></li>
<li><a href="#64-embedded-dsls">6.4 Embedded DSLs</a></li>
</ul>
</li>
<li><a href="#7-compiler-construction-tools">7. Compiler Construction Tools</a><ul>
<li><a href="#71-antlr">7.1 ANTLR</a></li>
<li><a href="#72-tree-sitter">7.2 Tree-sitter</a></li>
<li><a href="#73-tool-comparison">7.3 Tool Comparison</a></li>
</ul>
</li>
<li><a href="#8-language-server-protocol">8. Language Server Protocol</a><ul>
<li><a href="#81-what-is-lsp">8.1 What is LSP?</a></li>
<li><a href="#82-lsp-architecture">8.2 LSP Architecture</a></li>
<li><a href="#83-lsp-capabilities">8.3 LSP Capabilities</a></li>
<li><a href="#84-building-a-simple-language-server">8.4 Building a Simple Language Server</a></li>
</ul>
</li>
<li><a href="#9-incremental-compilation">9. Incremental Compilation</a><ul>
<li><a href="#91-the-problem">9.1 The Problem</a></li>
<li><a href="#92-dependency-tracking">9.2 Dependency Tracking</a></li>
<li><a href="#93-incremental-compilation-in-practice">9.3 Incremental Compilation in Practice</a></li>
</ul>
</li>
<li><a href="#10-profile-guided-optimization">10. Profile-Guided Optimization</a><ul>
<li><a href="#101-what-is-pgo">10.1 What is PGO?</a></li>
<li><a href="#102-pgo-optimization-decisions">10.2 PGO Optimization Decisions</a></li>
<li><a href="#103-using-pgo-with-clanggcc">10.3 Using PGO with Clang/GCC</a></li>
<li><a href="#104-simulating-pgo">10.4 Simulating PGO</a></li>
</ul>
</li>
<li><a href="#11-link-time-optimization">11. Link-Time Optimization</a><ul>
<li><a href="#111-what-is-lto">11.1 What is LTO?</a></li>
<li><a href="#112-full-lto-vs-thinlto">11.2 Full LTO vs ThinLTO</a></li>
<li><a href="#113-what-lto-enables">11.3 What LTO Enables</a></li>
</ul>
</li>
<li><a href="#12-compiler-verification">12. Compiler Verification</a><ul>
<li><a href="#121-why-verify-compilers">12.1 Why Verify Compilers?</a></li>
<li><a href="#122-approaches-to-compiler-correctness">12.2 Approaches to Compiler Correctness</a></li>
<li><a href="#123-compcert-a-verified-compiler">12.3 CompCert: A Verified Compiler</a></li>
<li><a href="#124-alive2-llvm-ir-verification">12.4 Alive2: LLVM IR Verification</a></li>
</ul>
</li>
<li><a href="#13-summary">13. Summary</a></li>
<li><a href="#14-exercises">14. Exercises</a><ul>
<li><a href="#exercise-1-llvm-ir-by-hand">Exercise 1: LLVM IR by Hand</a></li>
<li><a href="#exercise-2-optimization-pass">Exercise 2: Optimization Pass</a></li>
<li><a href="#exercise-3-dsl-design-and-implementation">Exercise 3: DSL Design and Implementation</a></li>
<li><a href="#exercise-4-incremental-compilation">Exercise 4: Incremental Compilation</a></li>
<li><a href="#exercise-5-pgo-simulator">Exercise 5: PGO Simulator</a></li>
<li><a href="#exercise-6-translation-validator">Exercise 6: Translation Validator</a></li>
</ul>
</li>
<li><a href="#15-references">15. References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="modern-compiler-infrastructure">Modern Compiler Infrastructure<a class="header-link" href="#modern-compiler-infrastructure" title="Permanent link">&para;</a></h1>
<p><strong>Previous</strong>: <a href="./15_Interpreters_and_Virtual_Machines.md">15. Interpreters and Virtual Machines</a></p>
<hr />
<p>Modern compilers are not monolithic programs built from scratch. They are assembled from reusable infrastructure -- intermediate representations, optimization passes, code generators, and tooling frameworks -- that can be shared across many languages. The LLVM project exemplifies this philosophy: dozens of languages (C, C++, Rust, Swift, Julia, Zig, and more) share the same optimizer and code generators.</p>
<p>This lesson explores the infrastructure that powers modern compilers: LLVM's architecture and IR, MLIR's multi-level approach, GCC's internals, domain-specific language (DSL) design, compiler construction tools, and advanced compilation techniques like PGO and LTO.</p>
<p><strong>Difficulty</strong>: â­â­â­â­</p>
<p><strong>Prerequisites</strong>: <a href="./09_Intermediate_Representations.md">09. Intermediate Representations</a>, <a href="./11_Code_Generation.md">11. Code Generation</a>, <a href="./12_Optimization_Local_and_Global.md">12. Optimization -- Local and Global</a></p>
<p><strong>Learning Objectives</strong>:
- Describe LLVM's modular architecture and pass pipeline
- Read and write LLVM IR, including types, instructions, and SSA form
- Understand how to write an LLVM optimization pass
- Explain MLIR's multi-level IR philosophy and dialects
- Compare LLVM and GCC internal representations (GIMPLE, RTL)
- Design and implement domain-specific languages (DSLs)
- Use compiler construction tools (ANTLR, Tree-sitter)
- Understand the Language Server Protocol (LSP)
- Explain incremental compilation strategies
- Apply profile-guided optimization (PGO) and link-time optimization (LTO)
- Reason about compiler verification approaches</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-llvm-overview">LLVM Overview</a></li>
<li><a href="#2-llvm-ir-in-detail">LLVM IR in Detail</a></li>
<li><a href="#3-writing-llvm-passes">Writing LLVM Passes</a></li>
<li><a href="#4-mlir-multi-level-ir">MLIR: Multi-Level IR</a></li>
<li><a href="#5-gcc-internals">GCC Internals</a></li>
<li><a href="#6-domain-specific-languages">Domain-Specific Languages</a></li>
<li><a href="#7-compiler-construction-tools">Compiler Construction Tools</a></li>
<li><a href="#8-language-server-protocol">Language Server Protocol</a></li>
<li><a href="#9-incremental-compilation">Incremental Compilation</a></li>
<li><a href="#10-profile-guided-optimization">Profile-Guided Optimization</a></li>
<li><a href="#11-link-time-optimization">Link-Time Optimization</a></li>
<li><a href="#12-compiler-verification">Compiler Verification</a></li>
<li><a href="#13-summary">Summary</a></li>
<li><a href="#14-exercises">Exercises</a></li>
<li><a href="#15-references">References</a></li>
</ol>
<hr />
<h2 id="1-llvm-overview">1. LLVM Overview<a class="header-link" href="#1-llvm-overview" title="Permanent link">&para;</a></h2>
<h3 id="11-what-is-llvm">1.1 What is LLVM?<a class="header-link" href="#11-what-is-llvm" title="Permanent link">&para;</a></h3>
<p><strong>LLVM</strong> (originally "Low Level Virtual Machine," now just a name) is a collection of modular compiler and toolchain technologies. Its core idea is a well-defined intermediate representation (LLVM IR) that decouples language-specific frontends from target-specific backends.</p>
<div class="highlight"><pre><span></span><code>Language Frontends:              LLVM Core:              Target Backends:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”                                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Clang â”‚â”€â”€â”€â”                                        â”Œâ”€â”€â–¶â”‚  x86-64  â”‚
â”‚ (C/C++)â”‚   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚          â”‚   â”‚          â”‚        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”œâ”€â”€â”€â–¶â”‚ LLVM IR  â”‚â”€â”€â–¶â”‚Optimizer â”‚â”€â”€â–¶â”€â”€â”€â”€â”€â”¼â”€â”€â–¶â”‚  ARM64   â”‚
â”‚ Rust  â”‚â”€â”€â”€â”¤    â”‚          â”‚   â”‚ (Passes) â”‚        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚(rustc)â”‚   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                                        â”œâ”€â”€â–¶â”‚  RISC-V  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”‚                                        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ Swift â”‚â”€â”€â”€â”¤                                        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       â”‚   â”‚                                        â””â”€â”€â–¶â”‚  WASM    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ Julia â”‚â”€â”€â”€â”˜
â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="12-llvm-architecture">1.2 LLVM Architecture<a class="header-link" href="#12-llvm-architecture" title="Permanent link">&para;</a></h3>
<p>LLVM consists of several key components:</p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>LLVM Core</strong></td>
<td>IR definition, optimization passes, code generation</td>
</tr>
<tr>
<td><strong>Clang</strong></td>
<td>C/C++/Objective-C frontend</td>
</tr>
<tr>
<td><strong>LLDB</strong></td>
<td>Debugger</td>
</tr>
<tr>
<td><strong>libc++</strong></td>
<td>C++ standard library</td>
</tr>
<tr>
<td><strong>compiler-rt</strong></td>
<td>Runtime support (sanitizers, profiling)</td>
</tr>
<tr>
<td><strong>LLD</strong></td>
<td>Linker</td>
</tr>
<tr>
<td><strong>MLIR</strong></td>
<td>Multi-Level IR framework</td>
</tr>
<tr>
<td><strong>Polly</strong></td>
<td>Polyhedral optimization pass</td>
</tr>
</tbody>
</table>
<h3 id="13-the-three-phase-design">1.3 The Three-Phase Design<a class="header-link" href="#13-the-three-phase-design" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Phase 1: Frontend          Phase 2: Optimizer       Phase 3: Backend
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚       â”‚                  â”‚     â”‚                 â”‚
â”‚ Source Code     â”‚       â”‚ LLVM IR          â”‚     â”‚ Machine Code    â”‚
â”‚     â”‚           â”‚       â”‚     â”‚            â”‚     â”‚     â”‚           â”‚
â”‚     â–¼           â”‚       â”‚     â–¼            â”‚     â”‚     â–¼           â”‚
â”‚  Lexing         â”‚       â”‚ Analysis Passes  â”‚     â”‚ Instruction     â”‚
â”‚  Parsing        â”‚       â”‚ Transform Passes â”‚     â”‚ Selection       â”‚
â”‚  Semantic       â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚â”€â”€â”€â”€â–¶â”‚ Register Alloc  â”‚
â”‚  Analysis       â”‚       â”‚ Optimization     â”‚     â”‚ Instruction     â”‚
â”‚  IR Generation  â”‚       â”‚ Levels:          â”‚     â”‚ Scheduling      â”‚
â”‚                 â”‚       â”‚  -O0, -O1, -O2,  â”‚     â”‚ Code Emission   â”‚
â”‚                 â”‚       â”‚  -O3, -Os, -Oz   â”‚     â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p>The beauty of this design: adding a new language requires only writing a frontend that generates LLVM IR. Adding a new target architecture requires only writing a backend. Both benefit from all existing optimizations.</p>
<h3 id="14-compiling-with-llvm-using-clang">1.4 Compiling with LLVM (Using Clang)<a class="header-link" href="#14-compiling-with-llvm-using-clang" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Generate LLVM IR from C code</span>
clang<span class="w"> </span>-S<span class="w"> </span>-emit-llvm<span class="w"> </span>hello.c<span class="w"> </span>-o<span class="w"> </span>hello.ll

<span class="c1"># Optimize LLVM IR</span>
opt<span class="w"> </span>-O2<span class="w"> </span>hello.ll<span class="w"> </span>-o<span class="w"> </span>hello_opt.ll

<span class="c1"># Compile LLVM IR to assembly</span>
llc<span class="w"> </span>hello_opt.ll<span class="w"> </span>-o<span class="w"> </span>hello.s

<span class="c1"># Or compile directly to object file</span>
clang<span class="w"> </span>-c<span class="w"> </span>hello.c<span class="w"> </span>-O2<span class="w"> </span>-o<span class="w"> </span>hello.o

<span class="c1"># View the optimization pipeline</span>
clang<span class="w"> </span>-O2<span class="w"> </span>-mllvm<span class="w"> </span>-print-after-all<span class="w"> </span>hello.c<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-100
</code></pre></div>

<hr />
<h2 id="2-llvm-ir-in-detail">2. LLVM IR in Detail<a class="header-link" href="#2-llvm-ir-in-detail" title="Permanent link">&para;</a></h2>
<h3 id="21-ir-structure">2.1 IR Structure<a class="header-link" href="#21-ir-structure" title="Permanent link">&para;</a></h3>
<p>LLVM IR is a typed, SSA-based intermediate representation. It exists in three isomorphic forms:
- <strong>Human-readable text</strong> (<code>.ll</code> files)
- <strong>Dense binary encoding</strong> (bitcode, <code>.bc</code> files)
- <strong>In-memory data structures</strong> (C++ objects)</p>
<p>A module (translation unit) contains:</p>
<div class="highlight"><pre><span></span><code><span class="c">; Module-level structure</span>
<span class="k">source_filename</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;example.c&quot;</span>
<span class="k">target</span><span class="w"> </span><span class="k">datalayout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;e-m:o-i64:64-i128:128-n32:64-S128&quot;</span>
<span class="k">target</span><span class="w"> </span><span class="k">triple</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;arm64-apple-macosx14.0.0&quot;</span>

<span class="c">; Global variables</span>
<span class="vg">@global_var</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">42</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
<span class="vg">@hello_str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">constant</span><span class="w"> </span><span class="p">[</span><span class="m">12</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="k">c</span><span class="s">&quot;Hello World\00&quot;</span>

<span class="c">; Function declarations (external)</span>
<span class="k">declare</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@printf</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="k">nocapture</span><span class="w"> </span><span class="k">readonly</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>

<span class="c">; Function definitions</span>
<span class="k">define</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv">%x</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%x</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
<span class="w">  </span><span class="nv">%val</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%x</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
<span class="w">  </span><span class="nv">%result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%val</span><span class="p">,</span><span class="w"> </span><span class="m">32</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%result</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="22-type-system">2.2 Type System<a class="header-link" href="#22-type-system" title="Permanent link">&para;</a></h3>
<p>LLVM IR has a rich type system:</p>
<div class="highlight"><pre><span></span><code><span class="c">; Integer types</span>
<span class="kt">i1</span><span class="w">        </span><span class="c">; 1-bit (boolean)</span>
<span class="kt">i8</span><span class="w">        </span><span class="c">; 8-bit (byte/char)</span>
<span class="kt">i16</span><span class="w">       </span><span class="c">; 16-bit (short)</span>
<span class="kt">i32</span><span class="w">       </span><span class="c">; 32-bit (int)</span>
<span class="kt">i64</span><span class="w">       </span><span class="c">; 64-bit (long)</span>
<span class="kt">i128</span><span class="w">      </span><span class="c">; 128-bit</span>

<span class="c">; Floating point types</span>
<span class="kt">half</span><span class="w">      </span><span class="c">; 16-bit float</span>
<span class="kt">float</span><span class="w">     </span><span class="c">; 32-bit float</span>
<span class="kt">double</span><span class="w">    </span><span class="c">; 64-bit float</span>

<span class="c">; Pointer type</span>
<span class="kt">ptr</span><span class="w">       </span><span class="c">; opaque pointer (LLVM 15+)</span>
<span class="kt">i32</span><span class="p">*</span><span class="w">      </span><span class="c">; typed pointer (legacy)</span>

<span class="c">; Array type</span>
<span class="p">[</span><span class="m">10</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">]</span><span class="w">         </span><span class="c">; Array of 10 i32s</span>
<span class="p">[</span><span class="m">3</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="p">[</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">float</span><span class="p">]]</span><span class="w">  </span><span class="c">; 3x4 matrix of floats</span>

<span class="c">; Structure types</span>
<span class="p">{</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="p">}</span><span class="w">           </span><span class="c">; Literal struct</span>
<span class="nv">%struct.Point</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">}</span><span class="w">  </span><span class="c">; Named struct</span>

<span class="c">; Vector type (SIMD)</span>
<span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">float</span><span class="p">&gt;</span><span class="w">    </span><span class="c">; 4-element float vector</span>
<span class="p">&lt;</span><span class="m">8</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w">      </span><span class="c">; 8-element int vector</span>

<span class="c">; Function type</span>
<span class="kt">i32</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w">      </span><span class="c">; Function taking two i32s, returning i32</span>
<span class="k">void</span><span class="w"> </span><span class="p">(</span><span class="kt">i8</span><span class="p">*,</span><span class="w"> </span><span class="p">...)</span><span class="w">     </span><span class="c">; Variadic function</span>
</code></pre></div>

<h3 id="23-ssa-and-instructions">2.3 SSA and Instructions<a class="header-link" href="#23-ssa-and-instructions" title="Permanent link">&para;</a></h3>
<p>All values in LLVM IR are in <strong>Static Single Assignment (SSA)</strong> form: each variable is defined exactly once. Phi nodes ($\phi$-functions) merge values at control flow join points.</p>
<div class="highlight"><pre><span></span><code><span class="c">; Arithmetic instructions</span>
<span class="nv">%sum</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="nv">%b</span><span class="w">          </span><span class="c">; Integer addition</span>
<span class="nv">%diff</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">sub</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="nv">%b</span><span class="w">         </span><span class="c">; Integer subtraction</span>
<span class="nv">%prod</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">mul</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="nv">%b</span><span class="w">         </span><span class="c">; Integer multiplication</span>
<span class="nv">%quot</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">sdiv</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="nv">%b</span><span class="w">        </span><span class="c">; Signed integer division</span>
<span class="nv">%rem</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">srem</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="nv">%b</span><span class="w">         </span><span class="c">; Signed remainder</span>

<span class="nv">%fsum</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">fadd</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv">%x</span><span class="p">,</span><span class="w"> </span><span class="nv">%y</span><span class="w">     </span><span class="c">; Floating-point addition</span>
<span class="nv">%fprod</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">fmul</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nv">%x</span><span class="p">,</span><span class="w"> </span><span class="nv">%y</span><span class="w">     </span><span class="c">; Floating-point multiplication</span>

<span class="c">; nsw/nuw flags: no signed/unsigned wrap (enables optimizations)</span>
<span class="nv">%safe_add</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="nv">%b</span>

<span class="c">; Comparison</span>
<span class="nv">%cmp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">eq</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="nv">%b</span><span class="w">      </span><span class="c">; Integer compare (eq, ne, slt, sgt, sle, sge)</span>
<span class="nv">%fcmp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">fcmp</span><span class="w"> </span><span class="k">olt</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv">%x</span><span class="p">,</span><span class="w"> </span><span class="nv">%y</span><span class="w"> </span><span class="c">; Float compare (olt, ogt, oeq, ...)</span>

<span class="c">; Bitwise</span>
<span class="nv">%and</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="nv">%b</span>
<span class="nv">%or</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="nv">%b</span>
<span class="nv">%xor</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">xor</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="nv">%b</span>
<span class="nv">%shl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">shl</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="w">           </span><span class="c">; Shift left by 2</span>

<span class="c">; Conversion</span>
<span class="nv">%ext</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">sext</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="kt">i64</span><span class="w">      </span><span class="c">; Sign-extend i32 to i64</span>
<span class="nv">%trunc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">trunc</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv">%b</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="kt">i32</span><span class="w">   </span><span class="c">; Truncate i64 to i32</span>
<span class="nv">%fp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">sitofp</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="kt">double</span><span class="w">  </span><span class="c">; Signed int to floating point</span>
<span class="nv">%int</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">fptosi</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv">%x</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="c">; Floating point to signed int</span>
<span class="nv">%cast</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">bitcast</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%p</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="c">; Reinterpret bits (same size)</span>
</code></pre></div>

<h3 id="24-memory-instructions">2.4 Memory Instructions<a class="header-link" href="#24-memory-instructions" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c">; Stack allocation</span>
<span class="nv">%ptr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w">         </span><span class="c">; Allocate 4 bytes on stack</span>
<span class="nv">%arr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="p">[</span><span class="m">100</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">],</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="c">; Array on stack</span>

<span class="c">; Load and store</span>
<span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">42</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%ptr</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w">    </span><span class="c">; *ptr = 42</span>
<span class="nv">%val</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%ptr</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="c">; val = *ptr</span>

<span class="c">; GEP (GetElementPtr) -- address computation without memory access</span>
<span class="c">; This is one of the most important (and confusing) LLVM instructions</span>
<span class="nv">%struct.Point</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">}</span>

<span class="nv">%p</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="nv">%struct.Point</span>
<span class="c">; Get pointer to the second field (y):</span>
<span class="nv">%y_ptr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="nv">%struct.Point</span><span class="p">,</span><span class="w"> </span><span class="nv">%struct.Point</span><span class="p">*</span><span class="w"> </span><span class="nv">%p</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">1</span>
<span class="c">; First index (i32 0): which struct in an array (0th)</span>
<span class="c">; Second index (i32 1): which field (1 = second field)</span>
</code></pre></div>

<h3 id="25-control-flow">2.5 Control Flow<a class="header-link" href="#25-control-flow" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c">; Unconditional branch</span>
<span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%target</span>

<span class="c">; Conditional branch</span>
<span class="nv">%cond</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">slt</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="nv">%n</span>
<span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cond</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%loop_body</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%loop_exit</span>

<span class="c">; Phi nodes (SSA merge at join points)</span>
<span class="k">define</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@abs</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv">%is_neg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">slt</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%x</span><span class="p">,</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%is_neg</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%negative</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%done</span>

<span class="nl">negative:</span>
<span class="w">  </span><span class="nv">%neg_x</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">sub</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="nv">%x</span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%done</span>

<span class="nl">done:</span>
<span class="w">  </span><span class="c">; Phi node: value depends on which predecessor we came from</span>
<span class="w">  </span><span class="nv">%result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">%x</span><span class="p">,</span><span class="w"> </span><span class="nv">%entry</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">%neg_x</span><span class="p">,</span><span class="w"> </span><span class="nv">%negative</span><span class="w"> </span><span class="p">]</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%result</span>
<span class="p">}</span>

<span class="c">; Switch</span>
<span class="k">switch</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%val</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%default</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%case0</span>
<span class="w">  </span><span class="kt">i32</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%case1</span>
<span class="w">  </span><span class="kt">i32</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%case2</span>
<span class="p">]</span>
</code></pre></div>

<h3 id="26-function-calls">2.6 Function Calls<a class="header-link" href="#26-function-calls" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c">; Direct call</span>
<span class="nv">%result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@add</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%b</span><span class="p">)</span>

<span class="c">; Call with attributes</span>
<span class="nv">%result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@pure_func</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%x</span><span class="p">)</span><span class="w"> </span><span class="k">nounwind</span><span class="w"> </span><span class="k">readnone</span>

<span class="c">; Tail call (enables tail call optimization)</span>
<span class="nv">%result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">tail</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@recursive_func</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%n</span><span class="p">)</span>

<span class="c">; Invoke (call that may throw an exception)</span>
<span class="nv">%result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">invoke</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@may_throw</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%x</span><span class="p">)</span>
<span class="w">          </span><span class="k">to</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%normal</span><span class="w"> </span><span class="k">unwind</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%exception</span>
</code></pre></div>

<h3 id="27-complete-llvm-ir-example">2.7 Complete LLVM IR Example<a class="header-link" href="#27-complete-llvm-ir-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c">; Factorial function in LLVM IR</span>
<span class="k">define</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@factorial</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv">%cmp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">sle</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%n</span><span class="p">,</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%base_case</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%recursive_case</span>

<span class="nl">base_case:</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">1</span>

<span class="nl">recursive_case:</span>
<span class="w">  </span><span class="nv">%n_minus_1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">sub</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%n</span><span class="p">,</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="nv">%sub_result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@factorial</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%n_minus_1</span><span class="p">)</span>
<span class="w">  </span><span class="nv">%result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">mul</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%n</span><span class="p">,</span><span class="w"> </span><span class="nv">%sub_result</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%result</span>
<span class="p">}</span>

<span class="c">; Iterative version (more optimizable)</span>
<span class="k">define</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@factorial_iter</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%loop</span>

<span class="nl">loop:</span>
<span class="w">  </span><span class="nv">%i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nv">%entry</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">%next_i</span><span class="p">,</span><span class="w"> </span><span class="nv">%loop</span><span class="w"> </span><span class="p">]</span>
<span class="w">  </span><span class="nv">%acc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nv">%entry</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">%next_acc</span><span class="p">,</span><span class="w"> </span><span class="nv">%loop</span><span class="w"> </span><span class="p">]</span>
<span class="w">  </span><span class="nv">%cmp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">sle</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="nv">%n</span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%body</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%done</span>

<span class="nl">body:</span>
<span class="w">  </span><span class="nv">%next_acc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">mul</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%acc</span><span class="p">,</span><span class="w"> </span><span class="nv">%i</span>
<span class="w">  </span><span class="nv">%next_i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%loop</span>

<span class="nl">done:</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%acc</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="28-generating-llvm-ir-from-python">2.8 Generating LLVM IR from Python<a class="header-link" href="#28-generating-llvm-ir-from-python" title="Permanent link">&para;</a></h3>
<p>We can generate LLVM IR programmatically using the <code>llvmlite</code> library:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># pip install llvmlite</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_llvm_ir_example</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate LLVM IR for a simple function using llvmlite.</span>

<span class="sd">    Function: int add(int a, int b) { return a + b; }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">llvmlite</span><span class="w"> </span><span class="kn">import</span> <span class="n">ir</span><span class="p">,</span> <span class="n">binding</span>

        <span class="c1"># Create module</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">ir</span><span class="o">.</span><span class="n">Module</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;example&#39;</span><span class="p">)</span>
        <span class="n">module</span><span class="o">.</span><span class="n">triple</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="n">get_default_triple</span><span class="p">()</span>

        <span class="c1"># Define function type: i32 (i32, i32)</span>
        <span class="n">func_type</span> <span class="o">=</span> <span class="n">ir</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">(</span><span class="n">ir</span><span class="o">.</span><span class="n">IntType</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
                                     <span class="p">[</span><span class="n">ir</span><span class="o">.</span><span class="n">IntType</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="n">ir</span><span class="o">.</span><span class="n">IntType</span><span class="p">(</span><span class="mi">32</span><span class="p">)])</span>

        <span class="c1"># Create function</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">ir</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">func_type</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">)</span>
        <span class="n">func</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
        <span class="n">func</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>

        <span class="c1"># Create basic block</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">append_basic_block</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;entry&#39;</span><span class="p">)</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">ir</span><span class="o">.</span><span class="n">IRBuilder</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

        <span class="c1"># Generate instructions</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">func</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;result&#39;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">ret</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generated LLVM IR:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>

        <span class="c1"># --- More complex example: factorial ---</span>
        <span class="n">fact_type</span> <span class="o">=</span> <span class="n">ir</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">(</span><span class="n">ir</span><span class="o">.</span><span class="n">IntType</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="p">[</span><span class="n">ir</span><span class="o">.</span><span class="n">IntType</span><span class="p">(</span><span class="mi">32</span><span class="p">)])</span>
        <span class="n">fact_func</span> <span class="o">=</span> <span class="n">ir</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">fact_type</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;factorial&#39;</span><span class="p">)</span>
        <span class="n">fact_func</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span>

        <span class="n">entry</span> <span class="o">=</span> <span class="n">fact_func</span><span class="o">.</span><span class="n">append_basic_block</span><span class="p">(</span><span class="s1">&#39;entry&#39;</span><span class="p">)</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">fact_func</span><span class="o">.</span><span class="n">append_basic_block</span><span class="p">(</span><span class="s1">&#39;loop&#39;</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">fact_func</span><span class="o">.</span><span class="n">append_basic_block</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="n">fact_func</span><span class="o">.</span><span class="n">append_basic_block</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">)</span>

        <span class="c1"># Entry block</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">ir</span><span class="o">.</span><span class="n">IRBuilder</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">branch</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>

        <span class="c1"># Loop header</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">ir</span><span class="o">.</span><span class="n">IRBuilder</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">phi</span><span class="p">(</span><span class="n">ir</span><span class="o">.</span><span class="n">IntType</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">phi</span><span class="p">(</span><span class="n">ir</span><span class="o">.</span><span class="n">IntType</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;acc&#39;</span><span class="p">)</span>
        <span class="n">i</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">ir</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">ir</span><span class="o">.</span><span class="n">IntType</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">entry</span><span class="p">)</span>
        <span class="n">acc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">ir</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">ir</span><span class="o">.</span><span class="n">IntType</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">entry</span><span class="p">)</span>

        <span class="n">cmp</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">icmp_signed</span><span class="p">(</span><span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fact_func</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cmp&#39;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">cbranch</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>

        <span class="c1"># Body</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">ir</span><span class="o">.</span><span class="n">IRBuilder</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">next_acc</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;next_acc&#39;</span><span class="p">)</span>
        <span class="n">next_i</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ir</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">ir</span><span class="o">.</span><span class="n">IntType</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;next_i&#39;</span><span class="p">)</span>
        <span class="n">i</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">next_i</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
        <span class="n">acc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">next_acc</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">branch</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>

        <span class="c1"># Done</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">ir</span><span class="o">.</span><span class="n">IRBuilder</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">ret</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">With factorial:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;llvmlite not installed. Install with: pip install llvmlite&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Here is what the generated IR would look like:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;; ModuleID = &#39;example&#39;</span>
<span class="s2">target triple = &quot;arm64-apple-macosx14.0.0&quot;</span>

<span class="s2">define i32 @add(i32 </span><span class="si">%a</span><span class="s2">, i32 %b) {</span>
<span class="s2">entry:</span>
<span class="s2">  </span><span class="si">%r</span><span class="s2">esult = add i32 </span><span class="si">%a</span><span class="s2">, %b</span>
<span class="s2">  ret i32 </span><span class="si">%r</span><span class="s2">esult</span>
<span class="s2">}</span>

<span class="s2">define i32 @factorial(i32 %n) {</span>
<span class="s2">entry:</span>
<span class="s2">  br label </span><span class="si">%lo</span><span class="s2">op</span>

<span class="s2">loop:</span>
<span class="s2">  </span><span class="si">%i</span><span class="s2"> = phi i32 [ 1, </span><span class="si">%e</span><span class="s2">ntry ], [ %next_i, %body ]</span>
<span class="s2">  </span><span class="si">%a</span><span class="s2">cc = phi i32 [ 1, </span><span class="si">%e</span><span class="s2">ntry ], [ %next_acc, %body ]</span>
<span class="s2">  </span><span class="si">%c</span><span class="s2">mp = icmp sle i32 </span><span class="si">%i</span><span class="s2">, %n</span>
<span class="s2">  br i1 </span><span class="si">%c</span><span class="s2">mp, label %body, label </span><span class="si">%d</span><span class="s2">one</span>

<span class="s2">body:</span>
<span class="s2">  %next_acc = mul i32 </span><span class="si">%a</span><span class="s2">cc, </span><span class="si">%i</span>
<span class="s2">  %next_i = add i32 </span><span class="si">%i</span><span class="s2">, 1</span>
<span class="s2">  br label </span><span class="si">%lo</span><span class="s2">op</span>

<span class="s2">done:</span>
<span class="s2">  ret i32 </span><span class="si">%a</span><span class="s2">cc</span>
<span class="s2">}&quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">generate_llvm_ir_example</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="3-writing-llvm-passes">3. Writing LLVM Passes<a class="header-link" href="#3-writing-llvm-passes" title="Permanent link">&para;</a></h2>
<h3 id="31-pass-types">3.1 Pass Types<a class="header-link" href="#31-pass-types" title="Permanent link">&para;</a></h3>
<p>LLVM organizes optimizations as <strong>passes</strong> that transform or analyze IR:</p>
<table>
<thead>
<tr>
<th>Pass Type</th>
<th>Scope</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Module Pass</strong></td>
<td>Entire module</td>
<td>Interprocedural analysis</td>
</tr>
<tr>
<td><strong>Function Pass</strong></td>
<td>Single function</td>
<td>Dead code elimination</td>
</tr>
<tr>
<td><strong>Loop Pass</strong></td>
<td>Single loop</td>
<td>Loop unrolling</td>
</tr>
<tr>
<td><strong>Basic Block Pass</strong></td>
<td>Single basic block</td>
<td>Peephole optimization</td>
</tr>
<tr>
<td><strong>Analysis Pass</strong></td>
<td>Read-only</td>
<td>Dominator tree computation</td>
</tr>
</tbody>
</table>
<h3 id="32-the-pass-pipeline">3.2 The Pass Pipeline<a class="header-link" href="#32-the-pass-pipeline" title="Permanent link">&para;</a></h3>
<p>LLVM's optimizer runs passes in a carefully ordered pipeline:</p>
<div class="highlight"><pre><span></span><code><span class="o">-</span><span class="n">O2</span><span class="w"> </span><span class="n">Pipeline</span><span class="w"> </span><span class="p">(</span><span class="n">simplified</span><span class="p">):</span>
<span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">Simplify</span><span class="w"> </span><span class="n">CFG</span>
<span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">SROA</span><span class="w"> </span><span class="p">(</span><span class="n">Scalar</span><span class="w"> </span><span class="n">Replacement</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Aggregates</span><span class="p">)</span>
<span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="n">Early</span><span class="w"> </span><span class="n">CSE</span><span class="w"> </span><span class="p">(</span><span class="n">Common</span><span class="w"> </span><span class="n">Subexpression</span><span class="w"> </span><span class="n">Elimination</span><span class="p">)</span>
<span class="w">  </span><span class="mf">4.</span><span class="w"> </span><span class="n">Inlining</span>
<span class="w">  </span><span class="mf">5.</span><span class="w"> </span><span class="n">Simplify</span><span class="w"> </span><span class="n">CFG</span>
<span class="w">  </span><span class="mf">6.</span><span class="w"> </span><span class="n">Instruction</span><span class="w"> </span><span class="n">Combining</span>
<span class="w">  </span><span class="mf">7.</span><span class="w"> </span><span class="n">Reassociate</span>
<span class="w">  </span><span class="mf">8.</span><span class="w"> </span><span class="n">Loop</span><span class="w"> </span><span class="n">passes</span><span class="p">:</span>
<span class="w">     </span><span class="n">a</span><span class="o">.</span><span class="w"> </span><span class="n">Loop</span><span class="w"> </span><span class="n">rotation</span>
<span class="w">     </span><span class="n">b</span><span class="o">.</span><span class="w"> </span><span class="n">LICM</span><span class="w"> </span><span class="p">(</span><span class="n">Loop</span><span class="o">-</span><span class="n">Invariant</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="n">Motion</span><span class="p">)</span>
<span class="w">     </span><span class="n">c</span><span class="o">.</span><span class="w"> </span><span class="n">Induction</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">simplification</span>
<span class="w">     </span><span class="n">d</span><span class="o">.</span><span class="w"> </span><span class="n">Loop</span><span class="w"> </span><span class="n">unrolling</span>
<span class="w">  </span><span class="mf">9.</span><span class="w"> </span><span class="n">GVN</span><span class="w"> </span><span class="p">(</span><span class="n">Global</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="n">Numbering</span><span class="p">)</span>
<span class="w">  </span><span class="mf">10.</span><span class="w"> </span><span class="n">Dead</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="n">Elimination</span>
<span class="w">  </span><span class="mf">11.</span><span class="w"> </span><span class="n">Simplify</span><span class="w"> </span><span class="n">CFG</span>
<span class="w">  </span><span class="mf">12.</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="p">(</span><span class="n">more</span><span class="w"> </span><span class="n">passes</span><span class="p">)</span>
</code></pre></div>

<h3 id="33-simulating-an-llvm-pass-in-python">3.3 Simulating an LLVM Pass in Python<a class="header-link" href="#33-simulating-an-llvm-pass-in-python" title="Permanent link">&para;</a></h3>
<p>Since writing actual LLVM passes requires C++, we can simulate the concept in Python:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LLVMIRSimulator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate LLVM IR and optimization passes in Python.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a function with basic blocks.</span>
<span class="sd">        blocks: dict of block_name -&gt; list of instructions</span>
<span class="sd">        Each instruction: (result, opcode, operands...)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">blocks</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print IR in LLVM-like format.&quot;&quot;&quot;</span>
        <span class="n">funcs</span> <span class="o">=</span> <span class="p">{</span><span class="n">func_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">func_name</span><span class="p">]}</span> <span class="k">if</span> <span class="n">func_name</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">blocks</span> <span class="ow">in</span> <span class="n">funcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;define @</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">() </span><span class="se">{{</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">block_name</span><span class="p">,</span> <span class="n">instructions</span> <span class="ow">in</span> <span class="n">blocks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">block_name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ret&#39;</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ret </span><span class="si">{</span><span class="n">instr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;br&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  br label %</span><span class="si">{</span><span class="n">instr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  br i1 </span><span class="si">{</span><span class="n">instr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">, label %</span><span class="si">{</span><span class="n">instr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">, label %</span><span class="si">{</span><span class="n">instr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;phi&#39;</span><span class="p">:</span>
                        <span class="n">pairs</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">, %</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2"> ]&quot;</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">instr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> = phi </span><span class="si">{</span><span class="n">pairs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ops</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">instr</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ops</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">OptimizationPass</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for optimization passes.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changes</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_on_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override this to implement the pass. Returns modified blocks.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">blocks</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Pass(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, changes=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">changes</span><span class="si">}</span><span class="s2">)&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ConstantFoldingPass</span><span class="p">(</span><span class="n">OptimizationPass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constant folding: evaluate operations on constants at compile time.</span>

<span class="sd">    Example: %x = add 3, 4  --&gt;  %x = 7</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;Constant Folding&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_on_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;add&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span>
            <span class="s1">&#39;sub&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">,</span>
            <span class="s1">&#39;mul&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">new_blocks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">block_name</span><span class="p">,</span> <span class="n">instructions</span> <span class="ow">in</span> <span class="n">blocks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_instructions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ops</span> <span class="ow">and</span>
                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">instr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span>
                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">instr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">ops</span><span class="p">[</span><span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]](</span><span class="n">instr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">instr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="c1"># Replace with constant</span>
                    <span class="n">new_instructions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changes</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [ConstFold] </span><span class="si">{</span><span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">instr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> --&gt; </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_instructions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
            <span class="n">new_blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_instructions</span>

        <span class="k">return</span> <span class="n">new_blocks</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DeadCodeEliminationPass</span><span class="p">(</span><span class="n">OptimizationPass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dead code elimination: remove instructions whose results are never used.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;Dead Code Elimination&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_on_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
        <span class="c1"># Collect all used values</span>
        <span class="n">used_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">block_name</span><span class="p">,</span> <span class="n">instructions</span> <span class="ow">in</span> <span class="n">blocks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
                <span class="c1"># All operands (positions 2+) that are string references</span>
                <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="n">instr</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">operand</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">):</span>
                        <span class="n">used_values</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">operand</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">elem</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">):</span>
                                        <span class="n">used_values</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>

        <span class="c1"># Remove instructions whose results are not used</span>
        <span class="n">new_blocks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">block_name</span><span class="p">,</span> <span class="n">instructions</span> <span class="ow">in</span> <span class="n">blocks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_instructions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Keep terminators and side-effecting instructions</span>
                <span class="k">if</span> <span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="s1">&#39;br&#39;</span><span class="p">,</span> <span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">):</span>
                    <span class="n">new_instructions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">used_values</span> <span class="ow">or</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_instructions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changes</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [DCE] Removed: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
            <span class="n">new_blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_instructions</span>

        <span class="k">return</span> <span class="n">new_blocks</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ConstantPropagationPass</span><span class="p">(</span><span class="n">OptimizationPass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constant propagation: replace uses of variables known to be constant.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;Constant Propagation&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_on_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
        <span class="c1"># Find all constant definitions</span>
        <span class="n">constants</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">block_name</span><span class="p">,</span> <span class="n">instructions</span> <span class="ow">in</span> <span class="n">blocks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;const&#39;</span><span class="p">:</span>
                    <span class="n">constants</span><span class="p">[</span><span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">instr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">constants</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">blocks</span>

        <span class="c1"># Replace uses of constants</span>
        <span class="n">new_blocks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">block_name</span><span class="p">,</span> <span class="n">instructions</span> <span class="ow">in</span> <span class="n">blocks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_instructions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
                <span class="n">new_instr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_instr</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_instr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">new_instr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">constants</span><span class="p">:</span>
                        <span class="n">old_val</span> <span class="o">=</span> <span class="n">new_instr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">new_instr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="n">old_val</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">changes</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [ConstProp] </span><span class="si">{</span><span class="n">old_val</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">constants</span><span class="p">[</span><span class="n">old_val</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">new_instructions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">new_instr</span><span class="p">))</span>
            <span class="n">new_blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_instructions</span>

        <span class="k">return</span> <span class="n">new_blocks</span>


<span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_pass_pipeline</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate an optimization pass pipeline.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== LLVM-style Pass Pipeline ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">ir</span> <span class="o">=</span> <span class="n">LLVMIRSimulator</span><span class="p">()</span>

    <span class="c1"># Function with optimization opportunities</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;</span><span class="si">%a</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;%b&#39;</span><span class="p">,</span> <span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;</span><span class="si">%c</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%a</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%b&#39;</span><span class="p">),</span>       <span class="c1"># Can be constant folded (after prop)</span>
            <span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;mul&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>              <span class="c1"># Can be constant folded</span>
            <span class="p">(</span><span class="s1">&#39;</span><span class="si">%e</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%c</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>        <span class="c1"># Can be constant folded</span>
            <span class="p">(</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1">nused&#39;</span><span class="p">,</span> <span class="s1">&#39;mul&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%a</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%b&#39;</span><span class="p">),</span>   <span class="c1"># Dead code</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%e</span><span class="s1">&#39;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">})</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Before optimization:&quot;</span><span class="p">)</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;compute&#39;</span><span class="p">)</span>

    <span class="c1"># Run passes</span>
    <span class="n">passes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ConstantFoldingPass</span><span class="p">(),</span>
        <span class="n">ConstantPropagationPass</span><span class="p">(),</span>
        <span class="n">ConstantFoldingPass</span><span class="p">(),</span>      <span class="c1"># Run again after propagation</span>
        <span class="n">DeadCodeEliminationPass</span><span class="p">(),</span>
    <span class="p">]</span>

    <span class="n">blocks</span> <span class="o">=</span> <span class="n">ir</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="s1">&#39;compute&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">passes</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">run_on_function</span><span class="p">(</span><span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="n">blocks</span><span class="p">)</span>

    <span class="n">ir</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="s1">&#39;compute&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blocks</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">After optimization:&quot;</span><span class="p">)</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;compute&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pass summary:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">passes</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">demonstrate_pass_pipeline</span><span class="p">()</span>
</code></pre></div>

<h3 id="34-real-llvm-pass-example-c-sketch">3.4 Real LLVM Pass Example (C++ Sketch)<a class="header-link" href="#34-real-llvm-pass-example-c-sketch" title="Permanent link">&para;</a></h3>
<p>For reference, here is what a real LLVM pass looks like in C++ (New Pass Manager, LLVM 14+):</p>
<div class="highlight"><pre><span></span><code><span class="c1">// MyPass.h</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/IR/PassManager.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/IR/Function.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/Support/raw_ostream.h&quot;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">MyCountPass</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">PassInfoMixin</span><span class="o">&lt;</span><span class="n">MyCountPass</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">PreservedAnalyses</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Function</span><span class="w"> </span><span class="o">&amp;</span><span class="n">F</span><span class="p">,</span>
<span class="w">                                 </span><span class="n">llvm</span><span class="o">::</span><span class="n">FunctionAnalysisManager</span><span class="w"> </span><span class="o">&amp;</span><span class="n">AM</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BB</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">BB</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Function &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">F</span><span class="p">.</span><span class="n">getName</span><span class="p">()</span>
<span class="w">                      </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; has &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; instructions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">PreservedAnalyses</span><span class="o">::</span><span class="n">all</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Register the pass</span>
<span class="c1">// In a plugin:</span>
<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="n">LLVM_ATTRIBUTE_WEAK</span><span class="w"> </span><span class="o">::</span><span class="n">llvm</span><span class="o">::</span><span class="n">PassPluginLibraryInfo</span>
<span class="n">llvmGetPassPluginInfo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">LLVM_PLUGIN_API_VERSION</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;MyPass&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">LLVM_VERSION_STRING</span><span class="p">,</span>
<span class="w">            </span><span class="p">[](</span><span class="n">PassBuilder</span><span class="w"> </span><span class="o">&amp;</span><span class="n">PB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">PB</span><span class="p">.</span><span class="n">registerPipelineParsingCallback</span><span class="p">(</span>
<span class="w">                    </span><span class="p">[](</span><span class="n">StringRef</span><span class="w"> </span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">FunctionPassManager</span><span class="w"> </span><span class="o">&amp;</span><span class="n">FPM</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;my-count-pass&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">FPM</span><span class="p">.</span><span class="n">addPass</span><span class="p">(</span><span class="n">MyCountPass</span><span class="p">());</span>
<span class="w">                            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">                    </span><span class="p">});</span>
<span class="w">            </span><span class="p">}};</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="4-mlir-multi-level-ir">4. MLIR: Multi-Level IR<a class="header-link" href="#4-mlir-multi-level-ir" title="Permanent link">&para;</a></h2>
<h3 id="41-the-problem-mlir-solves">4.1 The Problem MLIR Solves<a class="header-link" href="#41-the-problem-mlir-solves" title="Permanent link">&para;</a></h3>
<p>Different domains need different levels of abstraction:</p>
<div class="highlight"><pre><span></span><code><span class="n">High</span><span class="o">-</span><span class="n">level</span><span class="p">:</span><span class="w">    </span><span class="n">TensorFlow</span><span class="w"> </span><span class="n">graph</span><span class="w"> </span><span class="n">ops</span><span class="w"> </span><span class="p">(</span><span class="n">matmul</span><span class="p">,</span><span class="w"> </span><span class="n">conv2d</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">)</span>
<span class="w">               </span><span class="err">â†“</span>
<span class="n">Mid</span><span class="o">-</span><span class="n">level</span><span class="p">:</span><span class="w">     </span><span class="n">Affine</span><span class="w"> </span><span class="n">loops</span><span class="p">,</span><span class="w"> </span><span class="n">tensor</span><span class="w"> </span><span class="n">operations</span>
<span class="w">               </span><span class="err">â†“</span>
<span class="n">Low</span><span class="o">-</span><span class="n">level</span><span class="p">:</span><span class="w">     </span><span class="n">LLVM</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="p">(</span><span class="n">scalar</span><span class="w"> </span><span class="n">operations</span><span class="p">,</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">loads</span><span class="o">/</span><span class="n">stores</span><span class="p">)</span>
<span class="w">               </span><span class="err">â†“</span>
<span class="n">Machine</span><span class="p">:</span><span class="w">       </span><span class="n">Target</span><span class="o">-</span><span class="n">specific</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="n">instructions</span>
</code></pre></div>

<p>Traditionally, each level has its own IR with its own optimization framework. MLIR provides a <strong>single, extensible framework</strong> for multiple levels.</p>
<h3 id="42-mlir-concepts">4.2 MLIR Concepts<a class="header-link" href="#42-mlir-concepts" title="Permanent link">&para;</a></h3>
<p><strong>Dialects</strong>: MLIR organizes operations into dialects -- namespaced collections of operations, types, and attributes.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Affine dialect (structured loops and memory access)</span>
<span class="n">func</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="err">@</span><span class="n">matmul</span><span class="p">(</span><span class="o">%</span><span class="n">A</span><span class="o">:</span><span class="w"> </span><span class="n">memref</span><span class="o">&lt;</span><span class="mi">256</span><span class="n">x256xf32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">B</span><span class="o">:</span><span class="w"> </span><span class="n">memref</span><span class="o">&lt;</span><span class="mi">256</span><span class="n">x256xf32</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">                    </span><span class="o">%</span><span class="n">C</span><span class="o">:</span><span class="w"> </span><span class="n">memref</span><span class="o">&lt;</span><span class="mi">256</span><span class="n">x256xf32</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">affine</span><span class="p">.</span><span class="k">for</span><span class="w"> </span><span class="nf">%i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">affine</span><span class="p">.</span><span class="k">for</span><span class="w"> </span><span class="nf">%j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">affine</span><span class="p">.</span><span class="k">for</span><span class="w"> </span><span class="nf">%k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nf">%a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">affine</span><span class="p">.</span><span class="n">load</span><span class="w"> </span><span class="o">%</span><span class="n">A</span><span class="p">[</span><span class="nf">%i</span><span class="p">,</span><span class="w"> </span><span class="nf">%k</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">memref</span><span class="o">&lt;</span><span class="mi">256</span><span class="n">x256xf32</span><span class="o">&gt;</span>
<span class="w">        </span><span class="nf">%b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">affine</span><span class="p">.</span><span class="n">load</span><span class="w"> </span><span class="o">%</span><span class="n">B</span><span class="p">[</span><span class="nf">%k</span><span class="p">,</span><span class="w"> </span><span class="nf">%j</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">memref</span><span class="o">&lt;</span><span class="mi">256</span><span class="n">x256xf32</span><span class="o">&gt;</span>
<span class="w">        </span><span class="nf">%c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">affine</span><span class="p">.</span><span class="n">load</span><span class="w"> </span><span class="o">%</span><span class="n">C</span><span class="p">[</span><span class="nf">%i</span><span class="p">,</span><span class="w"> </span><span class="nf">%j</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">memref</span><span class="o">&lt;</span><span class="mi">256</span><span class="n">x256xf32</span><span class="o">&gt;</span>
<span class="w">        </span><span class="nf">%prod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arith</span><span class="p">.</span><span class="n">mulf</span><span class="w"> </span><span class="nf">%a</span><span class="p">,</span><span class="w"> </span><span class="nf">%b</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">f32</span>
<span class="w">        </span><span class="nf">%sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arith</span><span class="p">.</span><span class="n">addf</span><span class="w"> </span><span class="nf">%c</span><span class="p">,</span><span class="w"> </span><span class="nf">%prod</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">f32</span>
<span class="w">        </span><span class="n">affine</span><span class="p">.</span><span class="n">store</span><span class="w"> </span><span class="nf">%sum</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">C</span><span class="p">[</span><span class="nf">%i</span><span class="p">,</span><span class="w"> </span><span class="nf">%j</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">memref</span><span class="o">&lt;</span><span class="mi">256</span><span class="n">x256xf32</span><span class="o">&gt;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="43-key-mlir-dialects">4.3 Key MLIR Dialects<a class="header-link" href="#43-key-mlir-dialects" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Dialect</th>
<th>Purpose</th>
<th>Level</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>func</code></td>
<td>Functions, calls</td>
<td>High</td>
</tr>
<tr>
<td><code>arith</code></td>
<td>Arithmetic operations</td>
<td>Mid</td>
</tr>
<tr>
<td><code>affine</code></td>
<td>Affine loops and memory</td>
<td>Mid</td>
</tr>
<tr>
<td><code>linalg</code></td>
<td>Linear algebra operations</td>
<td>Mid-High</td>
</tr>
<tr>
<td><code>tensor</code></td>
<td>Tensor types and ops</td>
<td>Mid-High</td>
</tr>
<tr>
<td><code>memref</code></td>
<td>Memory references</td>
<td>Mid-Low</td>
</tr>
<tr>
<td><code>scf</code></td>
<td>Structured control flow (for, if, while)</td>
<td>Mid</td>
</tr>
<tr>
<td><code>cf</code></td>
<td>Unstructured control flow (branch, switch)</td>
<td>Low</td>
</tr>
<tr>
<td><code>llvm</code></td>
<td>LLVM IR operations</td>
<td>Low</td>
</tr>
<tr>
<td><code>gpu</code></td>
<td>GPU operations</td>
<td>Target-specific</td>
</tr>
</tbody>
</table>
<h3 id="44-progressive-lowering">4.4 Progressive Lowering<a class="header-link" href="#44-progressive-lowering" title="Permanent link">&para;</a></h3>
<p>MLIR's key innovation: <strong>progressive lowering</strong> transforms high-level operations into lower-level ones through a series of dialect conversions.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_progressive_lowering</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate MLIR-style progressive lowering.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Progressive Lowering ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;TensorFlow Dialect&#39;</span><span class="p">,</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">  </span><span class="si">%r</span><span class="s1">esult = tf.MatMul(%A, %B) : tensor&lt;256x256xf32&gt;</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;High-level: single operation for matrix multiply&#39;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Linalg Dialect&#39;</span><span class="p">,</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">  linalg.matmul</span>
<span class="s1">    ins(%A, %B : tensor&lt;256x256xf32&gt;, tensor&lt;256x256xf32&gt;)</span>
<span class="s1">    outs(%C : tensor&lt;256x256xf32&gt;) -&gt; tensor&lt;256x256xf32&gt;</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Mid-high: generic linear algebra operation&#39;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Affine Dialect&#39;</span><span class="p">,</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">  affine.for </span><span class="si">%i</span><span class="s1"> = 0 to 256 {</span>
<span class="s1">    affine.for %j = 0 to 256 {</span>
<span class="s1">      affine.for %k = 0 to 256 {</span>
<span class="s1">        </span><span class="si">%a</span><span class="s1"> = affine.load %A[</span><span class="si">%i</span><span class="s1">, %k]</span>
<span class="s1">        %b = affine.load %B[%k, %j]</span>
<span class="s1">        %prod = arith.mulf </span><span class="si">%a</span><span class="s1">, %b</span>
<span class="s1">        </span><span class="si">%c</span><span class="s1"> = affine.load %C[</span><span class="si">%i</span><span class="s1">, %j]</span>
<span class="s1">        </span><span class="si">%s</span><span class="s1">um = arith.addf </span><span class="si">%c</span><span class="s1">, %prod</span>
<span class="s1">        affine.store </span><span class="si">%s</span><span class="s1">um, %C[</span><span class="si">%i</span><span class="s1">, %j]</span>
<span class="s1">      }</span>
<span class="s1">    }</span>
<span class="s1">  }</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Mid: explicit loops with affine analysis&#39;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;SCF + MemRef Dialect&#39;</span><span class="p">,</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">  scf.for </span><span class="si">%i</span><span class="s1"> = 0 to 256 step 1 {</span>
<span class="s1">    scf.for %j = 0 to 256 step 1 {</span>
<span class="s1">      scf.for %k = 0 to 256 step 1 {</span>
<span class="s1">        </span><span class="si">%a</span><span class="s1">ddr_a = memref.load %A[</span><span class="si">%i</span><span class="s1">, %k]</span>
<span class="s1">        </span><span class="si">%a</span><span class="s1">ddr_b = memref.load %B[%k, %j]</span>
<span class="s1">        %prod = arith.mulf </span><span class="si">%a</span><span class="s1">ddr_a, </span><span class="si">%a</span><span class="s1">ddr_b</span>
<span class="s1">        ...</span>
<span class="s1">      }</span>
<span class="s1">    }</span>
<span class="s1">  }</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Mid-low: structured loops with explicit memory&#39;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;LLVM Dialect&#39;</span><span class="p">,</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">  llvm.br ^loop_header</span>
<span class="s1">  ^loop_header:</span>
<span class="s1">    </span><span class="si">%i</span><span class="s1"> = llvm.phi [%zero, ^entry], [%next_i, ^loop_latch]</span>
<span class="s1">    </span><span class="si">%c</span><span class="s1">mp = llvm.icmp &quot;slt&quot; </span><span class="si">%i</span><span class="s1">, %n</span>
<span class="s1">    llvm.cond_br </span><span class="si">%c</span><span class="s1">mp, ^loop_body, ^loop_exit</span>
<span class="s1">  ^loop_body:</span>
<span class="s1">    </span><span class="si">%a</span><span class="s1">ddr = llvm.getelementptr %base[</span><span class="si">%i</span><span class="s1">]</span>
<span class="s1">    %val = llvm.load </span><span class="si">%a</span><span class="s1">ddr</span>
<span class="s1">    ...</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Low: maps directly to LLVM IR&#39;</span>
        <span class="p">},</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">levels</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Level </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  (</span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="s1">&#39;â”€&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">40</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    â†“  Lowering pass&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="s1">&#39;â”€&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">40</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">demonstrate_progressive_lowering</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="5-gcc-internals">5. GCC Internals<a class="header-link" href="#5-gcc-internals" title="Permanent link">&para;</a></h2>
<h3 id="51-gcc-architecture">5.1 GCC Architecture<a class="header-link" href="#51-gcc-architecture" title="Permanent link">&para;</a></h3>
<p>GCC (GNU Compiler Collection) uses a different internal architecture than LLVM:</p>
<div class="highlight"><pre><span></span><code><span class="nx">GCC</span><span class="w"> </span><span class="nx">Compilation</span><span class="w"> </span><span class="nx">Pipeline</span><span class="p">:</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                         </span><span class="nx">GCC</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Source</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="nx">Frontend</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="nx">GENERIC</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="nx">GIMPLE</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="nx">SSA</span><span class="w"> </span><span class="nx">GIMPLE</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">             </span><span class="p">(</span><span class="nx">parser</span><span class="p">)</span><span class="w">    </span><span class="p">(</span><span class="nx">lang</span><span class="o">-</span><span class="w">      </span><span class="p">(</span><span class="nx">simplified</span><span class="w">  </span><span class="p">(</span><span class="nx">SSA</span><span class="w"> </span><span class="nx">form</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                          </span><span class="nx">specific</span><span class="w">    </span><span class="mi">3</span><span class="o">-</span><span class="kd">addr</span><span class="w">      </span><span class="nx">with</span><span class="w"> </span><span class="nx">phi</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                          </span><span class="nx">AST</span><span class="p">)</span><span class="w">        </span><span class="nx">code</span><span class="p">)</span><span class="w">       </span><span class="nx">nodes</span><span class="p">)</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">SSA</span><span class="w"> </span><span class="nx">GIMPLE</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="nx">Tree</span><span class="w"> </span><span class="nx">SSA</span><span class="w"> </span><span class="nx">Optimizations</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="nx">Optimized</span><span class="w"> </span><span class="nx">GIMPLE</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                 </span><span class="p">(</span><span class="nx">SRA</span><span class="p">,</span><span class="w"> </span><span class="nx">DCE</span><span class="p">,</span><span class="w"> </span><span class="nx">PRE</span><span class="p">,</span><span class="w"> </span><span class="nx">SCCP</span><span class="p">,</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="nx">loop</span><span class="w"> </span><span class="nx">opts</span><span class="p">,</span><span class="w"> </span><span class="nx">vectorize</span><span class="p">)</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Optimized</span><span class="w"> </span><span class="nx">GIMPLE</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="nx">RTL</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="nx">RTL</span><span class="w"> </span><span class="nx">Optimizations</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="nx">Assembly</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                       </span><span class="p">(</span><span class="nx">Register</span><span class="w"> </span><span class="nx">Transfer</span><span class="w">    </span><span class="p">(</span><span class="nx">register</span><span class="w"> </span><span class="nx">alloc</span><span class="p">,</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                        </span><span class="nx">Language</span><span class="p">)</span><span class="w">             </span><span class="nx">instruction</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                              </span><span class="nx">scheduling</span><span class="p">)</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="52-gimple">5.2 GIMPLE<a class="header-link" href="#52-gimple" title="Permanent link">&para;</a></h3>
<p>GIMPLE is GCC's high-level intermediate representation. It is a simplified, three-address form of the AST.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Source C code:</span>
<span class="kt">int</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// GIMPLE representation:</span>
<span class="n">sum_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">i_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">goto</span><span class="w"> </span><span class="o">&lt;</span><span class="n">bb</span><span class="w"> </span><span class="mi">3</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">&lt;</span><span class="n">bb</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;:</span>
<span class="n">_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="n">i_2</span><span class="p">];</span>
<span class="n">_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="n">sum_5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_4</span><span class="p">;</span>
<span class="n">i_6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="o">&lt;</span><span class="n">bb</span><span class="w"> </span><span class="mi">3</span><span class="o">&gt;:</span>
<span class="cp"># sum_1 = PHI &lt;sum_5(bb2), 0(bb1)&gt;</span>
<span class="cp"># i_2 = PHI &lt;i_6(bb2), 0(bb1)&gt;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_7</span><span class="p">)</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="o">&lt;</span><span class="n">bb</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">else</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="o">&lt;</span><span class="n">bb</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">&lt;</span><span class="n">bb</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;:</span>
<span class="k">return</span><span class="w"> </span><span class="n">sum_1</span><span class="p">;</span>
</code></pre></div>

<h3 id="53-rtl-register-transfer-language">5.3 RTL (Register Transfer Language)<a class="header-link" href="#53-rtl-register-transfer-language" title="Permanent link">&para;</a></h3>
<p>RTL is GCC's low-level IR, close to machine instructions:</p>
<div class="highlight"><pre><span></span><code><span class="p">;;</span><span class="w"> </span><span class="n">RTL</span><span class="w"> </span><span class="k">for</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>
<span class="p">(</span><span class="n">set</span><span class="w"> </span><span class="p">(</span><span class="n">reg</span><span class="p">:</span><span class="n">SI</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="n">plus</span><span class="p">:</span><span class="n">SI</span><span class="w"> </span><span class="p">(</span><span class="n">reg</span><span class="p">:</span><span class="n">SI</span><span class="w"> </span><span class="mi">101</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">reg</span><span class="p">:</span><span class="n">SI</span><span class="w"> </span><span class="mi">102</span><span class="p">)))</span>

<span class="p">;;</span><span class="w"> </span><span class="n">RTL</span><span class="w"> </span><span class="k">for</span><span class="p">:</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">goto</span><span class="w"> </span><span class="n">L1</span>
<span class="p">(</span><span class="n">set</span><span class="w"> </span><span class="p">(</span><span class="n">reg</span><span class="p">:</span><span class="n">CC</span><span class="w"> </span><span class="mi">17</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="n">compare</span><span class="p">:</span><span class="n">CC</span><span class="w"> </span><span class="p">(</span><span class="n">reg</span><span class="p">:</span><span class="n">SI</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="n">const_int</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="p">(</span><span class="n">set</span><span class="w"> </span><span class="p">(</span><span class="n">pc</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="n">if_then_else</span><span class="w"> </span><span class="p">(</span><span class="n">lt</span><span class="w"> </span><span class="p">(</span><span class="n">reg</span><span class="p">:</span><span class="n">CC</span><span class="w"> </span><span class="mi">17</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">const_int</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">                   </span><span class="p">(</span><span class="n">label_ref</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="n">pc</span><span class="p">)))</span>
</code></pre></div>

<h3 id="54-llvm-vs-gcc-comparison">5.4 LLVM vs GCC Comparison<a class="header-link" href="#54-llvm-vs-gcc-comparison" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">llvm_vs_gcc_comparison</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compare LLVM and GCC architectures.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== LLVM vs GCC ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">comparison</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;Architecture&#39;</span><span class="p">,</span> <span class="s1">&#39;Modular library&#39;</span><span class="p">,</span> <span class="s1">&#39;Monolithic compiler&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;License&#39;</span><span class="p">,</span> <span class="s1">&#39;Apache 2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;GPL v3&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;High-level IR&#39;</span><span class="p">,</span> <span class="s1">&#39;LLVM IR (one level)&#39;</span><span class="p">,</span> <span class="s1">&#39;GENERIC -&gt; GIMPLE (two levels)&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Low-level IR&#39;</span><span class="p">,</span> <span class="s1">&#39;SelectionDAG -&gt; MachineIR&#39;</span><span class="p">,</span> <span class="s1">&#39;RTL&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;SSA form&#39;</span><span class="p">,</span> <span class="s1">&#39;Core IR is SSA&#39;</span><span class="p">,</span> <span class="s1">&#39;GIMPLE SSA (separate phase)&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Reusability&#39;</span><span class="p">,</span> <span class="s1">&#39;Library-based (easy to embed)&#39;</span><span class="p">,</span> <span class="s1">&#39;Hard to use as library&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Frontend API&#39;</span><span class="p">,</span> <span class="s1">&#39;Clean C++ API&#39;</span><span class="p">,</span> <span class="s1">&#39;Plugin API (limited)&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Targets&#39;</span><span class="p">,</span> <span class="s1">&#39;~20 targets&#39;</span><span class="p">,</span> <span class="s1">&#39;~50+ targets&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Diagnostics&#39;</span><span class="p">,</span> <span class="s1">&#39;Excellent (Clang)&#39;</span><span class="p">,</span> <span class="s1">&#39;Good (improved recently)&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;LTO&#39;</span><span class="p">,</span> <span class="s1">&#39;ThinLTO + Full LTO&#39;</span><span class="p">,</span> <span class="s1">&#39;Full LTO&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Build speed&#39;</span><span class="p">,</span> <span class="s1">&#39;Fast (Clang)&#39;</span><span class="p">,</span> <span class="s1">&#39;Moderate&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Optimization&#39;</span><span class="p">,</span> <span class="s1">&#39;Strong, especially SIMD&#39;</span><span class="p">,</span> <span class="s1">&#39;Strong, wider target support&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Aspect&#39;</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;LLVM&#39;</span><span class="si">:</span><span class="s2">&lt;30</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;GCC&#39;</span><span class="si">:</span><span class="s2">&lt;30</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">aspect</span><span class="p">,</span> <span class="n">llvm</span><span class="p">,</span> <span class="n">gcc</span> <span class="ow">in</span> <span class="n">comparison</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">aspect</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">llvm</span><span class="si">:</span><span class="s2">&lt;30</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">gcc</span><span class="si">:</span><span class="s2">&lt;30</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">llvm_vs_gcc_comparison</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="6-domain-specific-languages">6. Domain-Specific Languages<a class="header-link" href="#6-domain-specific-languages" title="Permanent link">&para;</a></h2>
<h3 id="61-what-is-a-dsl">6.1 What is a DSL?<a class="header-link" href="#61-what-is-a-dsl" title="Permanent link">&para;</a></h3>
<p>A <strong>domain-specific language</strong> (DSL) is a programming language tailored to a specific problem domain. Unlike general-purpose languages (GPLs), DSLs sacrifice generality for expressiveness and ease of use in their domain.</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
<th>Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>External DSL</strong></td>
<td>Separate language with own parser</td>
<td>SQL, HTML, CSS, regex, Makefile</td>
</tr>
<tr>
<td><strong>Internal/Embedded DSL</strong></td>
<td>Hosted within a GPL</td>
<td>SQLAlchemy (Python), Kotlin DSLs, Scala implicits</td>
</tr>
</tbody>
</table>
<h3 id="62-dsl-design-principles">6.2 DSL Design Principles<a class="header-link" href="#62-dsl-design-principles" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Domain focus</strong>: Express domain concepts directly, not programming concepts</li>
<li><strong>Abstraction</strong>: Hide irrelevant details</li>
<li><strong>Notation</strong>: Match domain experts' notation</li>
<li><strong>Safety</strong>: Prevent errors that don't make sense in the domain</li>
<li><strong>Composition</strong>: Allow combining DSL elements naturally</li>
</ol>
<h3 id="63-building-an-external-dsl">6.3 Building an External DSL<a class="header-link" href="#63-building-an-external-dsl" title="Permanent link">&para;</a></h3>
<p>Let us build a simple DSL for defining data processing pipelines:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span>


<span class="c1"># --- AST Nodes ---</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PipelineAST</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;StageAST&#39;</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">StageAST</span><span class="p">:</span>
    <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">arguments</span><span class="p">:</span> <span class="nb">dict</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FilterAST</span><span class="p">(</span><span class="n">StageAST</span><span class="p">):</span>
    <span class="n">condition</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TransformAST</span><span class="p">(</span><span class="n">StageAST</span><span class="p">):</span>
    <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AggregateAST</span><span class="p">(</span><span class="n">StageAST</span><span class="p">):</span>
    <span class="n">function</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">column</span><span class="p">:</span> <span class="nb">str</span>


<span class="c1"># --- Parser ---</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PipelineDSLParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parser for a simple data pipeline DSL.</span>

<span class="sd">    Syntax:</span>
<span class="sd">        pipeline &quot;name&quot; {</span>
<span class="sd">            read csv &quot;data.csv&quot;</span>
<span class="sd">            filter where age &gt; 18</span>
<span class="sd">            transform salary * 1.1 as adjusted_salary</span>
<span class="sd">            group by department</span>
<span class="sd">            aggregate sum(salary) as total_salary</span>
<span class="sd">            write csv &quot;output.csv&quot;</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                      <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PipelineAST</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse the entire DSL source.&quot;&quot;&quot;</span>
        <span class="c1"># Parse pipeline header</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;pipeline\s+&quot;([^&quot;]+)&quot;\s*\{&#39;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected &#39;pipeline </span><span class="se">\&quot;</span><span class="s2">name</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">{{</span><span class="s2">&#39;, got: </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Parse stages</span>
        <span class="n">stages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;}&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">stages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_stage</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">PipelineAST</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">stages</span><span class="o">=</span><span class="n">stages</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StageAST</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a single pipeline stage.&quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;read&#39;</span><span class="p">:</span>
            <span class="n">fmt_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+)\s+&quot;([^&quot;]+)&quot;&#39;</span><span class="p">,</span> <span class="n">rest</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fmt_match</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">StageAST</span><span class="p">(</span>
                    <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;read&#39;</span><span class="p">,</span>
                    <span class="n">arguments</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">fmt_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                               <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">fmt_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)}</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FilterAST</span><span class="p">(</span>
                <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span>
                <span class="n">arguments</span><span class="o">=</span><span class="p">{},</span>
                <span class="n">condition</span><span class="o">=</span><span class="n">rest</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;where &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;transform&#39;</span><span class="p">:</span>
            <span class="c1"># Parse &quot;expression as new_name&quot;</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(.+)\s+as\s+(\w+)&#39;</span><span class="p">,</span> <span class="n">rest</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">TransformAST</span><span class="p">(</span>
                    <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;transform&#39;</span><span class="p">,</span>
                    <span class="n">arguments</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;new_column&#39;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)},</span>
                    <span class="n">expression</span><span class="o">=</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">StageAST</span><span class="p">(</span>
                <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span>
                <span class="n">arguments</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;by&#39;</span><span class="p">:</span> <span class="n">rest</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;by &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)}</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;aggregate&#39;</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+)\((\w+)\)\s+as\s+(\w+)&#39;</span><span class="p">,</span> <span class="n">rest</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AggregateAST</span><span class="p">(</span>
                    <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;aggregate&#39;</span><span class="p">,</span>
                    <span class="n">arguments</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;as&#39;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)},</span>
                    <span class="n">function</span><span class="o">=</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">column</span><span class="o">=</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;write&#39;</span><span class="p">:</span>
            <span class="n">fmt_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+)\s+&quot;([^&quot;]+)&quot;&#39;</span><span class="p">,</span> <span class="n">rest</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fmt_match</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">StageAST</span><span class="p">(</span>
                    <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;write&#39;</span><span class="p">,</span>
                    <span class="n">arguments</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">fmt_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                               <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">fmt_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)}</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">StageAST</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="n">rest</span><span class="p">})</span>


<span class="c1"># --- Code Generator ---</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PythonCodeGenerator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate Python code from the pipeline AST.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">:</span> <span class="n">PipelineAST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;# Generated pipeline: </span><span class="si">{</span><span class="n">pipeline</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;import pandas as pd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stage</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">stages</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;read&#39;</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df = pd.read_csv(&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">stage</span><span class="o">.</span><span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df = df[df.eval(&#39;</span><span class="si">{</span><span class="n">stage</span><span class="o">.</span><span class="n">condition</span><span class="si">}</span><span class="s2">&#39;)]&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">stage</span><span class="o">.</span><span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;transform&#39;</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;new_column&#39;</span><span class="p">]</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df[&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;] = df.eval(&#39;</span><span class="si">{</span><span class="n">stage</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">stage</span><span class="o">.</span><span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;by&#39;</span><span class="p">]</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df = df.groupby(&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">stage</span><span class="o">.</span><span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;aggregate&#39;</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">function</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">column</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;as&#39;</span><span class="p">]</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df = df.agg(</span><span class="se">{{</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;: &#39;</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">}}</span><span class="s2">)&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;.rename(columns=</span><span class="se">{{</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;: &#39;</span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">}}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">stage</span><span class="o">.</span><span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;write&#39;</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df.to_csv(&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;, index=False)&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_dsl</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate the pipeline DSL.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Data Pipeline DSL ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">dsl_source</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">pipeline &quot;employee_analysis&quot; {</span>
<span class="s1">    read csv &quot;employees.csv&quot;</span>
<span class="s1">    filter where age &gt; 25</span>
<span class="s1">    transform salary * 1.1 as adjusted_salary</span>
<span class="s1">    group by department</span>
<span class="s1">    aggregate sum(adjusted_salary) as total_adjusted</span>
<span class="s1">    write csv &quot;department_totals.csv&quot;</span>
<span class="s1">}</span>
<span class="s1">&#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DSL Source:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dsl_source</span><span class="p">)</span>

    <span class="c1"># Parse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">PipelineDSLParser</span><span class="p">(</span><span class="n">dsl_source</span><span class="p">)</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parsed AST:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pipeline: </span><span class="si">{</span><span class="n">ast</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">stages</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Stage: </span><span class="si">{</span><span class="n">stage</span><span class="o">.</span><span class="n">operation</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">stage</span><span class="o">.</span><span class="n">arguments</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Generate Python code</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">PythonCodeGenerator</span><span class="p">()</span>
    <span class="n">python_code</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generated Python Code:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">python_code</span><span class="p">)</span>

<span class="n">demonstrate_dsl</span><span class="p">()</span>
</code></pre></div>

<h3 id="64-embedded-dsls">6.4 Embedded DSLs<a class="header-link" href="#64-embedded-dsls" title="Permanent link">&para;</a></h3>
<p>An <strong>embedded DSL</strong> (EDSL) uses the host language's syntax to create a domain-specific feel:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">QueryBuilder</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Embedded DSL for building SQL queries in Python.</span>
<span class="sd">    Uses method chaining (fluent interface) for a DSL-like feel.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_table</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where_clauses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Enable chaining</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">from_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">and_where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">on</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JOIN </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> ON </span><span class="si">{</span><span class="n">on</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">left_join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">on</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LEFT JOIN </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> ON </span><span class="si">{</span><span class="n">on</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;ASC&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">n</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the SQL string.&quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FROM </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">join</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">join</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where_clauses</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WHERE </span><span class="si">{</span><span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_where_clauses</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ORDER BY </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LIMIT </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_embedded_dsl</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate the embedded SQL DSL.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Embedded SQL DSL ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">QueryBuilder</span><span class="p">()</span>
             <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;e.name&#39;</span><span class="p">,</span> <span class="s1">&#39;e.salary&#39;</span><span class="p">,</span> <span class="s1">&#39;d.name AS department&#39;</span><span class="p">)</span>
             <span class="o">.</span><span class="n">from_table</span><span class="p">(</span><span class="s1">&#39;employees e&#39;</span><span class="p">)</span>
             <span class="o">.</span><span class="n">left_join</span><span class="p">(</span><span class="s1">&#39;departments d&#39;</span><span class="p">,</span> <span class="s1">&#39;e.dept_id = d.id&#39;</span><span class="p">)</span>
             <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;e.salary &gt; 50000&#39;</span><span class="p">)</span>
             <span class="o">.</span><span class="n">and_where</span><span class="p">(</span><span class="s1">&#39;e.active = true&#39;</span><span class="p">)</span>
             <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;e.salary&#39;</span><span class="p">,</span> <span class="s1">&#39;DESC&#39;</span><span class="p">)</span>
             <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generated SQL:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

<span class="n">demonstrate_embedded_dsl</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="7-compiler-construction-tools">7. Compiler Construction Tools<a class="header-link" href="#7-compiler-construction-tools" title="Permanent link">&para;</a></h2>
<h3 id="71-antlr">7.1 ANTLR<a class="header-link" href="#71-antlr" title="Permanent link">&para;</a></h3>
<p><strong>ANTLR</strong> (ANother Tool for Language Recognition) is a powerful parser generator that creates parsers from grammar specifications.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// ANTLR grammar for a simple expression language</span>
<span class="nx">grammar</span><span class="w"> </span><span class="nx">Expr</span><span class="p">;</span>

<span class="c1">// Parser rules</span>
<span class="nx">program</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">statement</span><span class="o">+</span><span class="w"> </span><span class="p">;</span>

<span class="nx">statement</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">assignment</span>
<span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nx">printStmt</span>
<span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nx">ifStmt</span>
<span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nx">whileStmt</span>
<span class="w">          </span><span class="p">;</span>

<span class="nx">assignment</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">ID</span><span class="w"> </span><span class="sc">&#39;=&#39;</span><span class="w"> </span><span class="nx">expr</span><span class="w"> </span><span class="sc">&#39;;&#39;</span><span class="w"> </span><span class="p">;</span>
<span class="nx">printStmt</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">print</span><span class="sc">&#39; &#39;</span><span class="p">(</span><span class="err">&#39;</span><span class="w"> </span><span class="nx">expr</span><span class="w"> </span><span class="sc">&#39;)&#39;</span><span class="w"> </span><span class="sc">&#39;;&#39;</span><span class="w"> </span><span class="p">;</span>
<span class="nx">ifStmt</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="k">if</span><span class="sc">&#39; &#39;</span><span class="p">(</span><span class="err">&#39;</span><span class="w"> </span><span class="nx">expr</span><span class="w"> </span><span class="sc">&#39;)&#39;</span><span class="w"> </span><span class="nx">block</span><span class="w"> </span><span class="p">(</span><span class="err">&#39;</span><span class="k">else</span><span class="err">&#39;</span><span class="w"> </span><span class="nx">block</span><span class="p">)?</span><span class="w"> </span><span class="p">;</span>
<span class="nx">whileStmt</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="k">while</span><span class="sc">&#39; &#39;</span><span class="p">(</span><span class="err">&#39;</span><span class="w"> </span><span class="nx">expr</span><span class="w"> </span><span class="sc">&#39;)&#39;</span><span class="w"> </span><span class="nx">block</span><span class="w"> </span><span class="p">;</span>
<span class="nx">block</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="sc">&#39;{&#39;</span><span class="w"> </span><span class="nx">statement</span><span class="o">*</span><span class="w"> </span><span class="sc">&#39;}&#39;</span><span class="w"> </span><span class="p">;</span>

<span class="nx">expr</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">expr</span><span class="w"> </span><span class="p">(</span><span class="sc">&#39;*&#39;</span><span class="o">|</span><span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">expr</span><span class="w">     </span><span class="err">#</span><span class="w"> </span><span class="nx">MulDiv</span>
<span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">expr</span><span class="w"> </span><span class="p">(</span><span class="sc">&#39;+&#39;</span><span class="o">|</span><span class="sc">&#39;-&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">expr</span><span class="w">     </span><span class="err">#</span><span class="w"> </span><span class="nx">AddSub</span>
<span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">expr</span><span class="w"> </span><span class="p">(</span><span class="sc">&#39;&lt;&#39;</span><span class="o">|</span><span class="sc">&#39;&gt;&#39;</span><span class="o">|</span><span class="err">&#39;</span><span class="o">==</span><span class="err">&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">expr</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">Compare</span>
<span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="sc">&#39;(&#39;</span><span class="w"> </span><span class="nx">expr</span><span class="w"> </span><span class="sc">&#39;)&#39;</span><span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="nx">Parens</span>
<span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">ID</span><span class="w">                      </span><span class="err">#</span><span class="w"> </span><span class="nx">Identifier</span>
<span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">INT</span><span class="w">                     </span><span class="err">#</span><span class="w"> </span><span class="nx">Integer</span>
<span class="w">     </span><span class="p">;</span>

<span class="c1">// Lexer rules</span>
<span class="nx">ID</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nx">a</span><span class="o">-</span><span class="nx">zA</span><span class="o">-</span><span class="nx">Z_</span><span class="p">][</span><span class="nx">a</span><span class="o">-</span><span class="nx">zA</span><span class="o">-</span><span class="nx">Z_0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="w"> </span><span class="p">;</span>
<span class="nx">INT</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="w"> </span><span class="p">;</span>
<span class="nx">WS</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="err">\</span><span class="nx">t</span><span class="err">\</span><span class="nx">r</span><span class="err">\</span><span class="nx">n</span><span class="p">]</span><span class="o">+</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">skip</span><span class="w"> </span><span class="p">;</span>
<span class="nx">COMMENT</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="c1">//&#39; ~[\r\n]* -&gt; skip ;</span>
</code></pre></div>

<p>ANTLR generates a lexer, parser, and parse tree from this grammar. It supports many target languages (Java, Python, C++, JavaScript, Go, etc.).</p>
<h3 id="72-tree-sitter">7.2 Tree-sitter<a class="header-link" href="#72-tree-sitter" title="Permanent link">&para;</a></h3>
<p><strong>Tree-sitter</strong> is a parser generator designed for incremental parsing -- ideal for code editors and language tooling.</p>
<p>Key features:
- <strong>Incremental</strong>: After editing a file, only re-parses the changed portion
- <strong>Error-tolerant</strong>: Produces a valid parse tree even for syntactically incorrect code
- <strong>Fast</strong>: Parses most files in under a millisecond
- <strong>Concrete syntax tree</strong>: Preserves all tokens (whitespace, comments) for exact round-tripping</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_tree_sitter_concept</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Demonstrate Tree-sitter&#39;s incremental parsing concept.</span>
<span class="sd">    (Actual Tree-sitter requires C bindings; this simulates the behavior.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Tree-sitter Incremental Parsing ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">IncrementalParser</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulated incremental parser.&quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Full parse.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_tree</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">edit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">new_text</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Incremental edit: only re-parse the changed region.</span>

<span class="sd">            In real Tree-sitter:</span>
<span class="sd">            1. Apply the edit to the old tree</span>
<span class="sd">            2. Re-lex only the changed region</span>
<span class="sd">            3. Re-parse only affected subtrees</span>
<span class="sd">            4. Reuse unchanged subtrees from the old tree</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">old_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">old_source</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_text</span> <span class="o">+</span> <span class="n">old_source</span><span class="p">[</span><span class="n">end</span><span class="p">:]</span>

            <span class="c1"># In reality, Tree-sitter would:</span>
            <span class="c1"># - Identify which tree nodes are invalidated</span>
            <span class="c1"># - Re-parse only those regions</span>
            <span class="c1"># - Reuse all other nodes from the old tree</span>

            <span class="n">changed_region</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_text</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Edit at [</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">] -&gt; &#39;</span><span class="si">{</span><span class="n">new_text</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Only re-parsing characters </span><span class="si">{</span><span class="n">changed_region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Reusing tree nodes outside this range&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_build_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Simplified tree building.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;program&#39;</span><span class="p">,</span> <span class="s1">&#39;children&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">IncrementalParser</span><span class="p">()</span>

    <span class="c1"># Initial parse</span>
    <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;let x = 10;</span><span class="se">\n</span><span class="s2">let y = 20;</span><span class="se">\n</span><span class="s2">let z = x + y;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial source:</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="c1"># Edit: change &quot;10&quot; to &quot;42&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Edit: change &#39;10&#39; to &#39;42&#39;&quot;</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;42&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  New source: </span><span class="si">{</span><span class="n">parser</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Key insight: Tree-sitter re-parses only the changed region,&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;not the entire file. For large files, this is orders of magnitude faster.&quot;</span><span class="p">)</span>

<span class="n">demonstrate_tree_sitter_concept</span><span class="p">()</span>
</code></pre></div>

<h3 id="73-tool-comparison">7.3 Tool Comparison<a class="header-link" href="#73-tool-comparison" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">tool_comparison</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compare parser generator tools.&quot;&quot;&quot;</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;ANTLR&#39;</span><span class="p">,</span> <span class="s1">&#39;LL(*)&#39;</span><span class="p">,</span> <span class="s1">&#39;Java,Py,C++,JS,Go&#39;</span><span class="p">,</span> <span class="s1">&#39;Full parse tree&#39;</span><span class="p">,</span> <span class="s1">&#39;Language implementation&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Tree-sitter&#39;</span><span class="p">,</span> <span class="s1">&#39;GLR&#39;</span><span class="p">,</span> <span class="s1">&#39;C (bindings)&#39;</span><span class="p">,</span> <span class="s1">&#39;Incremental CST&#39;</span><span class="p">,</span> <span class="s1">&#39;Editors, tooling&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Yacc/Bison&#39;</span><span class="p">,</span> <span class="s1">&#39;LALR(1)&#39;</span><span class="p">,</span> <span class="s1">&#39;C, C++&#39;</span><span class="p">,</span> <span class="s1">&#39;Action-based&#39;</span><span class="p">,</span> <span class="s1">&#39;Traditional compilers&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;PEG.js/Pest&#39;</span><span class="p">,</span> <span class="s1">&#39;PEG&#39;</span><span class="p">,</span> <span class="s1">&#39;JS/Rust&#39;</span><span class="p">,</span> <span class="s1">&#39;Full parse tree&#39;</span><span class="p">,</span> <span class="s1">&#39;Simple languages&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Lark&#39;</span><span class="p">,</span> <span class="s1">&#39;Earley/LALR&#39;</span><span class="p">,</span> <span class="s1">&#39;Python&#39;</span><span class="p">,</span> <span class="s1">&#39;Parse tree&#39;</span><span class="p">,</span> <span class="s1">&#39;Python projects&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Nom&#39;</span><span class="p">,</span> <span class="s1">&#39;Combinator&#39;</span><span class="p">,</span> <span class="s1">&#39;Rust&#39;</span><span class="p">,</span> <span class="s1">&#39;Custom&#39;</span><span class="p">,</span> <span class="s1">&#39;Binary formats, protocols&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Parser Generator Comparison ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Tool&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Algorithm&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Languages&#39;</span><span class="si">:</span><span class="s2">&lt;18</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Best For&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">algo</span><span class="p">,</span> <span class="n">langs</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">best_for</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">algo</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">langs</span><span class="si">:</span><span class="s2">&lt;18</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">best_for</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">tool_comparison</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="8-language-server-protocol">8. Language Server Protocol<a class="header-link" href="#8-language-server-protocol" title="Permanent link">&para;</a></h2>
<h3 id="81-what-is-lsp">8.1 What is LSP?<a class="header-link" href="#81-what-is-lsp" title="Permanent link">&para;</a></h3>
<p>The <strong>Language Server Protocol</strong> (LSP), developed by Microsoft, standardizes the interface between code editors and language-specific tooling. Before LSP, every editor needed a custom plugin for every language (M editors times N languages = M*N implementations). LSP reduces this to M + N.</p>
<div class="highlight"><pre><span></span><code><span class="nx">Without</span><span class="w"> </span><span class="nx">LSP</span><span class="p">:</span><span class="w">                        </span><span class="nx">With</span><span class="w"> </span><span class="nx">LSP</span><span class="p">:</span>

<span class="w">  </span><span class="nx">VS</span><span class="w"> </span><span class="nx">Code</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="w"> </span><span class="nx">C</span><span class="w"> </span><span class="nx">plugin</span><span class="w">              </span><span class="nx">VS</span><span class="w"> </span><span class="nx">Code</span><span class="w"> </span><span class="err">â”€â”€â”</span>
<span class="w">  </span><span class="nx">VS</span><span class="w"> </span><span class="nx">Code</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="w"> </span><span class="nx">Python</span><span class="w"> </span><span class="nx">plugin</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="w">  </span><span class="nx">VS</span><span class="w"> </span><span class="nx">Code</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="w"> </span><span class="nx">Rust</span><span class="w"> </span><span class="nx">plugin</span><span class="w">           </span><span class="nx">Vim</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”¤</span><span class="w">   </span><span class="nx">LSP</span><span class="w">    </span><span class="err">â”Œâ”€â”€</span><span class="w"> </span><span class="nx">C</span><span class="w"> </span><span class="nx">server</span>
<span class="w">  </span><span class="nx">Vim</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="nx">C</span><span class="w"> </span><span class="nx">plugin</span><span class="w">              </span><span class="nx">Emacs</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”¤</span><span class="w"> </span><span class="nx">Protocol</span><span class="w"> </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Python</span><span class="w"> </span><span class="nx">server</span>
<span class="w">  </span><span class="nx">Vim</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="nx">Python</span><span class="w"> </span><span class="nx">plugin</span><span class="w">         </span><span class="nx">Sublime</span><span class="w"> </span><span class="err">â”€â”€â”˜</span><span class="w">          </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Rust</span><span class="w"> </span><span class="nx">server</span>
<span class="w">  </span><span class="nx">Vim</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="nx">Rust</span><span class="w"> </span><span class="nx">plugin</span><span class="w">                                </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="o">...</span>
<span class="w">  </span><span class="nx">Emacs</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="nx">C</span><span class="w"> </span><span class="nx">plugin</span>
<span class="w">  </span><span class="nx">Emacs</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="nx">Python</span><span class="w"> </span><span class="nx">plugin</span><span class="w">         </span><span class="nx">M</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">N</span><span class="w"> </span><span class="nx">implementations</span>
<span class="w">  </span><span class="nx">Emacs</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="nx">Rust</span><span class="w"> </span><span class="nx">plugin</span><span class="w">           </span><span class="p">(</span><span class="nx">instead</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">N</span><span class="p">)</span>
<span class="w">  </span><span class="o">...</span>

<span class="w">  </span><span class="nx">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">N</span><span class="w"> </span><span class="nx">implementations</span>
</code></pre></div>

<h3 id="82-lsp-architecture">8.2 LSP Architecture<a class="header-link" href="#82-lsp-architecture" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         JSON-RPC          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚ â—€â”€â”€â”€ notifications â”€â”€â”€â”€â”€â”€  â”‚                  â”‚
â”‚    Editor    â”‚ â”€â”€â”€â”€â”€ requests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚  Language Server  â”‚
â”‚   (Client)   â”‚ â—€â”€â”€â”€ responses â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                  â”‚
â”‚              â”‚                            â”‚  - Parser         â”‚
â”‚  VS Code     â”‚  textDocument/didOpen      â”‚  - Type checker   â”‚
â”‚  Vim         â”‚  textDocument/completion   â”‚  - Diagnostics    â”‚
â”‚  Emacs       â”‚  textDocument/definition   â”‚  - Formatter      â”‚
â”‚  Sublime     â”‚  textDocument/references   â”‚  - Refactoring    â”‚
â”‚              â”‚  textDocument/hover        â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="83-lsp-capabilities">8.3 LSP Capabilities<a class="header-link" href="#83-lsp-capabilities" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">lsp_capabilities</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show key LSP capabilities.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== LSP Capabilities ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">capabilities</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;textDocument/completion&#39;</span><span class="p">,</span> <span class="s1">&#39;Auto-completion suggestions&#39;</span><span class="p">,</span>
         <span class="s1">&#39;User types &quot;obj.&quot; -&gt; server suggests methods&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;textDocument/hover&#39;</span><span class="p">,</span> <span class="s1">&#39;Type info and docs on hover&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Hover over function -&gt; show signature and docstring&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;textDocument/definition&#39;</span><span class="p">,</span> <span class="s1">&#39;Go to definition&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Click on function call -&gt; jump to its definition&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;textDocument/references&#39;</span><span class="p">,</span> <span class="s1">&#39;Find all references&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Find all places where a symbol is used&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;textDocument/rename&#39;</span><span class="p">,</span> <span class="s1">&#39;Rename symbol&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Rename a variable across all files&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;textDocument/diagnostics&#39;</span><span class="p">,</span> <span class="s1">&#39;Error and warning diagnostics&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Red underlines for errors, yellow for warnings&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;textDocument/formatting&#39;</span><span class="p">,</span> <span class="s1">&#39;Code formatting&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Auto-format according to style rules&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;textDocument/codeAction&#39;</span><span class="p">,</span> <span class="s1">&#39;Quick fixes and refactorings&#39;</span><span class="p">,</span>
         <span class="s1">&#39;&quot;Extract method&quot;, &quot;Import missing module&quot;&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;textDocument/signatureHelp&#39;</span><span class="p">,</span> <span class="s1">&#39;Function signature help&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Show parameter types while typing arguments&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;textDocument/foldingRange&#39;</span><span class="p">,</span> <span class="s1">&#39;Code folding&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Collapse/expand functions, classes, regions&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">capabilities</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Example: </span><span class="si">{</span><span class="n">example</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">lsp_capabilities</span><span class="p">()</span>
</code></pre></div>

<h3 id="84-building-a-simple-language-server">8.4 Building a Simple Language Server<a class="header-link" href="#84-building-a-simple-language-server" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SimpleLSPServer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simplified Language Server Protocol server.</span>
<span class="sd">    Demonstrates the core request/response pattern.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">documents</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># uri -&gt; content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle an LSP request.&quot;&quot;&quot;</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;handle_</span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unknown method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_textDocument_didOpen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle document open notification.&quot;&quot;&quot;</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;textDocument&#39;</span><span class="p">][</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;textDocument&#39;</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">documents</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>

        <span class="c1"># Analyze for diagnostics</span>
        <span class="n">diagnostics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;textDocument/publishDiagnostics&#39;</span><span class="p">,</span>
                <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">uri</span><span class="p">,</span> <span class="s1">&#39;diagnostics&#39;</span><span class="p">:</span> <span class="n">diagnostics</span><span class="p">}}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_textDocument_completion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle completion request.&quot;&quot;&quot;</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;textDocument&#39;</span><span class="p">][</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>

        <span class="c1"># Simple keyword completion</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;if&#39;</span><span class="p">,</span> <span class="s1">&#39;else&#39;</span><span class="p">,</span> <span class="s1">&#39;while&#39;</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="s1">&#39;def&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;import&#39;</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="s1">&#39;print&#39;</span><span class="p">]</span>

        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">documents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># Get the partial word being typed</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;character&#39;</span><span class="p">]</span>
        <span class="n">partial</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isalnum</span><span class="p">():</span>
                <span class="n">partial</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">partial</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Filter keywords</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">kw</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>  <span class="c1"># Keyword</span>
             <span class="s1">&#39;detail&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Keyword: </span><span class="si">{</span><span class="n">kw</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">keywords</span> <span class="k">if</span> <span class="n">kw</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">partial</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_textDocument_hover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle hover request.&quot;&quot;&quot;</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;textDocument&#39;</span><span class="p">][</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>

        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">documents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]]</span>
            <span class="c1"># Simple: return the line content</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;contents&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;markdown&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;```</span><span class="se">\n</span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s1">```&#39;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simple static analysis for diagnostics.&quot;&quot;&quot;</span>
        <span class="n">diagnostics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="c1"># Check for common issues</span>
            <span class="k">if</span> <span class="s1">&#39;eval(&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">diagnostics</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;character&#39;</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;eval(&#39;</span><span class="p">)},</span>
                        <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;character&#39;</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;eval(&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">},</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># Warning</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Use of eval() is a security risk&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;simple-lsp&#39;</span><span class="p">,</span>
                <span class="p">})</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">120</span><span class="p">:</span>
                <span class="n">diagnostics</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;character&#39;</span><span class="p">:</span> <span class="mi">120</span><span class="p">},</span>
                        <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;character&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)},</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># Information</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Line exceeds 120 characters (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;simple-lsp&#39;</span><span class="p">,</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">diagnostics</span>


<span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_lsp</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate LSP server behavior.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Simple LSP Server Demo ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">SimpleLSPServer</span><span class="p">()</span>

    <span class="c1"># Simulate document open</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="s1">&#39;textDocument/didOpen&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;textDocument&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="s1">&#39;file:///example.py&#39;</span><span class="p">,</span>
            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;x = eval(input())</span><span class="se">\n</span><span class="s1">print(x)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;y = &#39;</span> <span class="o">+</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">130</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Diagnostics on open:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">diag</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;diagnostics&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Line </span><span class="si">{</span><span class="n">diag</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">diag</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Simulate completion</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="s1">&#39;textDocument/completion&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;textDocument&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="s1">&#39;file:///example.py&#39;</span><span class="p">},</span>
        <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;character&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
    <span class="p">})</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Completions for partial word:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="p">[])[:</span><span class="mi">5</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">demonstrate_lsp</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="9-incremental-compilation">9. Incremental Compilation<a class="header-link" href="#9-incremental-compilation" title="Permanent link">&para;</a></h2>
<h3 id="91-the-problem">9.1 The Problem<a class="header-link" href="#91-the-problem" title="Permanent link">&para;</a></h3>
<p>Large projects take a long time to compile. After changing one file, recompiling everything is wasteful. <strong>Incremental compilation</strong> only recompiles what has changed.</p>
<h3 id="92-dependency-tracking">9.2 Dependency Tracking<a class="header-link" href="#92-dependency-tracking" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>


<span class="k">class</span><span class="w"> </span><span class="nc">IncrementalCompiler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulates incremental compilation with dependency tracking.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_timestamps</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1"># file -&gt; last modified time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_cache</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1"># file -&gt; compiled result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>  <span class="c1"># file -&gt; set of files it depends on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reverse_deps</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>  <span class="c1"># file -&gt; set of files that depend on it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">depends_on</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Record that source depends on depends_on.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">depends_on</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reverse_deps</span><span class="p">[</span><span class="n">depends_on</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compile_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile a single file (simulated).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Compiling: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Simulate compilation</span>
        <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;compiled(</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_cache</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_timestamps</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">needs_recompilation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">current_mtime</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a file needs recompilation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Never compiled</span>

        <span class="k">if</span> <span class="n">current_mtime</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_timestamps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Source file changed</span>

        <span class="c1"># Check if any dependency changed</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">set</span><span class="p">()):</span>
            <span class="n">dep_mtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_timestamps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dep_mtime</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_timestamps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Dependency changed</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files_with_mtimes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Incremental build: only compile files that need it.</span>

<span class="sd">        files_with_mtimes: dict of filename -&gt; (content, mtime)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Determine what needs recompilation</span>
        <span class="n">to_compile</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">mtime</span><span class="p">)</span> <span class="ow">in</span> <span class="n">files_with_mtimes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_recompilation</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mtime</span><span class="p">):</span>
                <span class="n">to_compile</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># Also recompile reverse dependencies of changed files</span>
        <span class="n">worklist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">to_compile</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">worklist</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">worklist</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">rdep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_deps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">set</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">rdep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">to_compile</span> <span class="ow">and</span> <span class="n">rdep</span> <span class="ow">in</span> <span class="n">files_with_mtimes</span><span class="p">:</span>
                    <span class="n">to_compile</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rdep</span><span class="p">)</span>
                    <span class="n">worklist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rdep</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">to_compile</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Nothing to compile (all up to date)&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Topological sort for correct compilation order</span>
        <span class="n">compiled</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">compile_with_deps</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">compiled</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">set</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">to_compile</span><span class="p">:</span>
                    <span class="n">compile_with_deps</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
            <span class="n">content</span><span class="p">,</span> <span class="n">mtime</span> <span class="o">=</span> <span class="n">files_with_mtimes</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compile_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
            <span class="n">compiled</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">to_compile</span><span class="p">:</span>
            <span class="n">compile_with_deps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Compiled </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compile_count</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files_with_mtimes</span><span class="p">)</span><span class="si">}</span><span class="s2"> files&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_incremental_compilation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show incremental compilation behavior.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Incremental Compilation ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">compiler</span> <span class="o">=</span> <span class="n">IncrementalCompiler</span><span class="p">()</span>

    <span class="c1"># Define dependencies: main.c depends on util.h and math.h</span>
    <span class="n">compiler</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="s1">&#39;main.c&#39;</span><span class="p">,</span> <span class="s1">&#39;util.h&#39;</span><span class="p">)</span>
    <span class="n">compiler</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="s1">&#39;main.c&#39;</span><span class="p">,</span> <span class="s1">&#39;math.h&#39;</span><span class="p">)</span>
    <span class="n">compiler</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="s1">&#39;util.c&#39;</span><span class="p">,</span> <span class="s1">&#39;util.h&#39;</span><span class="p">)</span>
    <span class="n">compiler</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="s1">&#39;math.c&#39;</span><span class="p">,</span> <span class="s1">&#39;math.h&#39;</span><span class="p">)</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Build 1: Full build</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Build 1: Initial (full) build&quot;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;util.h&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;header&#39;</span><span class="p">,</span> <span class="n">now</span><span class="p">),</span>
        <span class="s1">&#39;math.h&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;header&#39;</span><span class="p">,</span> <span class="n">now</span><span class="p">),</span>
        <span class="s1">&#39;main.c&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;main code&#39;</span><span class="p">,</span> <span class="n">now</span><span class="p">),</span>
        <span class="s1">&#39;util.c&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;util code&#39;</span><span class="p">,</span> <span class="n">now</span><span class="p">),</span>
        <span class="s1">&#39;math.c&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;math code&#39;</span><span class="p">,</span> <span class="n">now</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">compiler</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

    <span class="c1"># Build 2: Nothing changed</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Build 2: No changes&quot;</span><span class="p">)</span>
    <span class="n">compiler</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

    <span class="c1"># Build 3: Changed util.h (should recompile main.c and util.c)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Build 3: Modified util.h&quot;</span><span class="p">)</span>
    <span class="n">files</span><span class="p">[</span><span class="s1">&#39;util.h&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;modified header&#39;</span><span class="p">,</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">compiler</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

    <span class="c1"># Build 4: Changed only math.c</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Build 4: Modified only math.c&quot;</span><span class="p">)</span>
    <span class="n">files</span><span class="p">[</span><span class="s1">&#39;math.c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;modified math code&#39;</span><span class="p">,</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">compiler</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

<span class="n">demonstrate_incremental_compilation</span><span class="p">()</span>
</code></pre></div>

<h3 id="93-incremental-compilation-in-practice">9.3 Incremental Compilation in Practice<a class="header-link" href="#93-incremental-compilation-in-practice" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>System</th>
<th>Strategy</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Rust (cargo)</strong></td>
<td>Per-crate compilation, query-based incremental within crates</td>
</tr>
<tr>
<td><strong>Go</strong></td>
<td>Per-package compilation, fast full builds</td>
</tr>
<tr>
<td><strong>Java (javac)</strong></td>
<td>Per-file compilation, dependency tracking</td>
</tr>
<tr>
<td><strong>C/C++ (make)</strong></td>
<td>Per-file compilation, timestamp-based rebuild</td>
</tr>
<tr>
<td><strong>TypeScript</strong></td>
<td>Per-project, in-memory incremental</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="10-profile-guided-optimization">10. Profile-Guided Optimization<a class="header-link" href="#10-profile-guided-optimization" title="Permanent link">&para;</a></h2>
<h3 id="101-what-is-pgo">10.1 What is PGO?<a class="header-link" href="#101-what-is-pgo" title="Permanent link">&para;</a></h3>
<p><strong>Profile-Guided Optimization (PGO)</strong> uses runtime profiling data to make better optimization decisions. The compiler first generates instrumented code, runs it on representative inputs to collect profile data, then recompiles using the profile.</p>
<div class="highlight"><pre><span></span><code>Phase 1: Instrumented Build
  Source â”€â”€â–¶ Compiler (-fprofile-generate) â”€â”€â–¶ Instrumented Binary

Phase 2: Profile Collection
  Instrumented Binary + Training Input â”€â”€â–¶ Profile Data (.profdata)

Phase 3: Optimized Build
  Source + Profile Data â”€â”€â–¶ Compiler (-fprofile-use) â”€â”€â–¶ Optimized Binary
</code></pre></div>

<h3 id="102-pgo-optimization-decisions">10.2 PGO Optimization Decisions<a class="header-link" href="#102-pgo-optimization-decisions" title="Permanent link">&para;</a></h3>
<p>Profile data enables several optimizations:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pgo_optimizations</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show what PGO enables.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== PGO Optimization Decisions ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">optimizations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Branch Prediction Hints&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Mark likely/unlikely branches based on observed frequencies&#39;</span><span class="p">,</span>
            <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">  // Profile says: condition is true 95</span><span class="si">% o</span><span class="s1">f the time</span>
<span class="s1">  if (likely(x &gt; 0)) {  // Hot path: optimized layout</span>
<span class="s1">      process(x);</span>
<span class="s1">  } else {              // Cold path: moved out of line</span>
<span class="s1">      handle_error(x);</span>
<span class="s1">  }</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="s1">&#39;Better instruction cache utilization, fewer branch mispredictions&#39;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Function Inlining&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Inline hot call sites, don</span><span class="se">\&#39;</span><span class="s1">t inline cold ones&#39;</span><span class="p">,</span>
            <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">  // Profile says: parse_header called 1M times, parse_trailer called 100 times</span>
<span class="s1">  // Inline parse_header (hot), don&#39;t inline parse_trailer (cold)</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="s1">&#39;Better code size/speed trade-off&#39;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Basic Block Layout&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Place hot blocks together, cold blocks separately&#39;</span><span class="p">,</span>
            <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">  // Hot path blocks placed sequentially for better i-cache usage</span>
<span class="s1">  // Cold blocks (error handling) moved to end of function</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="s1">&#39;Better instruction cache hit rate&#39;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Register Allocation&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Prioritize register allocation for hot paths&#39;</span><span class="p">,</span>
            <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">  // Variables used in hot loops get registers</span>
<span class="s1">  // Variables used only in cold paths get stack slots</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="s1">&#39;Fewer memory accesses in hot code&#39;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Virtual Call Devirtualization&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Convert virtual calls to direct calls based on observed types&#39;</span><span class="p">,</span>
            <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">  // Profile: 99</span><span class="si">% o</span><span class="s1">f calls to shape.area() are on Circle objects</span>
<span class="s1">  if (shape is Circle) {     // Speculative devirtualization</span>
<span class="s1">      circle_area(shape);    // Direct call (inlinable)</span>
<span class="s1">  } else {</span>
<span class="s1">      shape.area();          // Virtual call fallback</span>
<span class="s1">  }</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="s1">&#39;Enables inlining of virtual methods&#39;</span>
        <span class="p">},</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">optimizations</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Impact: </span><span class="si">{</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;impact&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

<span class="n">pgo_optimizations</span><span class="p">()</span>
</code></pre></div>

<h3 id="103-using-pgo-with-clanggcc">10.3 Using PGO with Clang/GCC<a class="header-link" href="#103-using-pgo-with-clanggcc" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Clang PGO workflow:</span>

<span class="c1"># Step 1: Build with instrumentation</span>
clang<span class="w"> </span>-fprofile-instr-generate<span class="w"> </span>-O2<span class="w"> </span>program.c<span class="w"> </span>-o<span class="w"> </span>program_instrumented

<span class="c1"># Step 2: Run with representative input</span>
./program_instrumented<span class="w"> </span>&lt;<span class="w"> </span>training_input.txt
<span class="c1"># This generates default.profraw</span>

<span class="c1"># Step 3: Merge profile data</span>
llvm-profdata<span class="w"> </span>merge<span class="w"> </span>default.profraw<span class="w"> </span>-output<span class="o">=</span>program.profdata

<span class="c1"># Step 4: Build with profile data</span>
clang<span class="w"> </span>-fprofile-instr-use<span class="o">=</span>program.profdata<span class="w"> </span>-O2<span class="w"> </span>program.c<span class="w"> </span>-o<span class="w"> </span>program_optimized

<span class="c1"># Typical speedup: 10-20% for large applications</span>
</code></pre></div>

<h3 id="104-simulating-pgo">10.4 Simulating PGO<a class="header-link" href="#104-simulating-pgo" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">simulate_pgo</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulate PGO&#39;s effect on branch layout.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== PGO Simulation ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Simulated function with branches</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

    <span class="c1"># Generate &quot;execution profile&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;branch_A_true&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;branch_A_false&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;branch_B_true&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;branch_B_false&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>  <span class="c1"># Branch A: taken 99% of the time</span>
            <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;branch_A_true&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;branch_A_false&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">150</span><span class="p">:</span>  <span class="c1"># Branch B: taken ~1% of the time</span>
            <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;branch_B_true&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;branch_B_false&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Profile data collected:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">branch</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">pct</span> <span class="o">=</span> <span class="n">count</span> <span class="o">/</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">PGO decisions:&quot;</span><span class="p">)</span>
    <span class="n">a_ratio</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;branch_A_true&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">b_ratio</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;branch_B_true&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">n</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Branch A (</span><span class="si">{</span><span class="n">a_ratio</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% true):&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    -&gt; Predict TRUE, place true-path first (fall-through)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    -&gt; Move false-path out-of-line&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Branch B (</span><span class="si">{</span><span class="n">b_ratio</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% true):&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    -&gt; Predict FALSE, place false-path first (fall-through)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    -&gt; Move true-path out-of-line&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Code layout:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Without PGO:              With PGO:</span>
<span class="s2">  func:                     func:</span>
<span class="s2">    cmp x, 50                 cmp x, 50</span>
<span class="s2">    jle .else_A               jle .cold_A       (rarely taken)</span>
<span class="s2">    ; true path A             ; true path A     (fall-through: hot)</span>
<span class="s2">    ...                       ...</span>
<span class="s2">    jmp .end_A                cmp x, 150</span>
<span class="s2">  .else_A:                    jg .cold_B        (rarely taken)</span>
<span class="s2">    ; false path A            ; false path B    (fall-through: hot)</span>
<span class="s2">    ...                       ...</span>
<span class="s2">  .end_A:                     ret</span>
<span class="s2">    cmp x, 150</span>
<span class="s2">    jle .else_B             ; Cold section (separate cache lines):</span>
<span class="s2">    ; true path B           .cold_A:</span>
<span class="s2">    ...                       ; false path A</span>
<span class="s2">    jmp .end_B                jmp .back_A</span>
<span class="s2">  .else_B:                  .cold_B:</span>
<span class="s2">    ; false path B            ; true path B</span>
<span class="s2">    ...                       jmp .back_B</span>
<span class="s2">  .end_B:</span>
<span class="s2">    ret</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">simulate_pgo</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="11-link-time-optimization">11. Link-Time Optimization<a class="header-link" href="#11-link-time-optimization" title="Permanent link">&para;</a></h2>
<h3 id="111-what-is-lto">11.1 What is LTO?<a class="header-link" href="#111-what-is-lto" title="Permanent link">&para;</a></h3>
<p><strong>Link-Time Optimization (LTO)</strong> defers some optimizations to link time, when the compiler has visibility across all translation units (source files). This enables:</p>
<ul>
<li>Cross-module inlining</li>
<li>Interprocedural constant propagation</li>
<li>Dead function elimination across modules</li>
<li>Whole-program devirtualization</li>
</ul>
<div class="highlight"><pre><span></span><code>Without LTO:
  a.c â”€â”€â–¶ a.o â”€â”€â”
  b.c â”€â”€â–¶ b.o â”€â”€â”¤â”€â”€â–¶ Linker â”€â”€â–¶ binary
  c.c â”€â”€â–¶ c.o â”€â”€â”˜
  (each .o optimized independently)

With LTO:
  a.c â”€â”€â–¶ a.bc â”€â”€â”
  b.c â”€â”€â–¶ b.bc â”€â”€â”¤â”€â”€â–¶ LTO Optimizer â”€â”€â–¶ Linker â”€â”€â–¶ binary
  c.c â”€â”€â–¶ c.bc â”€â”€â”˜
  (.bc = LLVM bitcode, optimized together)
</code></pre></div>

<h3 id="112-full-lto-vs-thinlto">11.2 Full LTO vs ThinLTO<a class="header-link" href="#112-full-lto-vs-thinlto" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Full LTO</th>
<th>ThinLTO</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Scope</strong></td>
<td>Merges all modules into one</td>
<td>Keeps modules separate</td>
</tr>
<tr>
<td><strong>Link time</strong></td>
<td>Slow (single-threaded)</td>
<td>Fast (parallelizable)</td>
</tr>
<tr>
<td><strong>Memory</strong></td>
<td>High (entire program in memory)</td>
<td>Low (summary-based)</td>
</tr>
<tr>
<td><strong>Optimization quality</strong></td>
<td>Best (full visibility)</td>
<td>Nearly as good (95%+)</td>
</tr>
<tr>
<td><strong>Incremental</strong></td>
<td>No (re-optimizes everything)</td>
<td>Yes (per-module)</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="c1"># Full LTO with Clang</span>
clang<span class="w"> </span>-flto<span class="w"> </span>-O2<span class="w"> </span>a.c<span class="w"> </span>b.c<span class="w"> </span>c.c<span class="w"> </span>-o<span class="w"> </span>program

<span class="c1"># ThinLTO (recommended for large projects)</span>
clang<span class="w"> </span>-flto<span class="o">=</span>thin<span class="w"> </span>-O2<span class="w"> </span>a.c<span class="w"> </span>b.c<span class="w"> </span>c.c<span class="w"> </span>-o<span class="w"> </span>program
</code></pre></div>

<h3 id="113-what-lto-enables">11.3 What LTO Enables<a class="header-link" href="#113-what-lto-enables" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">lto_example</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show what LTO enables that per-file compilation cannot.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== LTO Optimizations ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example: Cross-module inlining</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  // util.c&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  int square(int x) { return x * x; }&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  // main.c&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  extern int square(int);&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  int main() { return square(5); }&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Without LTO: square() is a function call&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  With LTO:    square(5) is inlined -&gt; return 25&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;               Constant folded -&gt; return 25&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;               (zero runtime cost!)&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Example: Dead code elimination</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  // util.c&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  void used_function() { ... }&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  void unused_function() { ... }  // 10,000 lines&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Without LTO: both functions in binary (linker can&#39;t tell)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  With LTO:    unused_function() eliminated (smaller binary)&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Example: Interprocedural constant propagation</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  // config.c&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  int get_mode() { return 3; }  // Always returns 3&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  // engine.c&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  int mode = get_mode();&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  if (mode == 1) { ... }  // Dead code (mode is always 3)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  if (mode == 2) { ... }  // Dead code&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  if (mode == 3) { ... }  // Only this branch survives&quot;</span><span class="p">)</span>

<span class="n">lto_example</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="12-compiler-verification">12. Compiler Verification<a class="header-link" href="#12-compiler-verification" title="Permanent link">&para;</a></h2>
<h3 id="121-why-verify-compilers">12.1 Why Verify Compilers?<a class="header-link" href="#121-why-verify-compilers" title="Permanent link">&para;</a></h3>
<p>Compilers are critical infrastructure: a bug in the compiler can introduce bugs in every program it compiles. Compiler verification ensures that the compiled code is semantically equivalent to the source.</p>
<h3 id="122-approaches-to-compiler-correctness">12.2 Approaches to Compiler Correctness<a class="header-link" href="#122-approaches-to-compiler-correctness" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Approach</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Testing</strong></td>
<td>Run test suites, fuzz testing</td>
<td>GCC/LLVM test suites, Csmith</td>
</tr>
<tr>
<td><strong>Translation validation</strong></td>
<td>Verify each compilation instance</td>
<td>Alive2 (for LLVM)</td>
</tr>
<tr>
<td><strong>Verified compiler</strong></td>
<td>Mathematically prove correctness</td>
<td>CompCert</td>
</tr>
<tr>
<td><strong>Randomized testing</strong></td>
<td>Generate random programs, compare outputs</td>
<td>Csmith, YARPGen</td>
</tr>
</tbody>
</table>
<h3 id="123-compcert-a-verified-compiler">12.3 CompCert: A Verified Compiler<a class="header-link" href="#123-compcert-a-verified-compiler" title="Permanent link">&para;</a></h3>
<p><strong>CompCert</strong> is a C compiler mathematically proven correct using the Coq proof assistant. Its correctness theorem states:</p>
<blockquote>
<p>For every source program $S$ and compiled program $C$, if $S$ has defined behavior, then the observable behavior of $C$ is identical to that of $S$.</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compiler_verification_overview</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Overview of compiler verification approaches.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Compiler Verification ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CompCert correctness theorem (informal):&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  For all source programs S with defined behavior:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  semantics(compile(S)) = semantics(S)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Translation validation (Alive2 for LLVM):&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  For each optimization pass applied:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Verify: semantics(optimized_IR) âŠ† semantics(original_IR)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  (optimized code may have fewer behaviors, e.g., removing UB)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fuzzing (Csmith):&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  1. Generate random C programs (avoiding UB)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  2. Compile with multiple compilers/optimization levels&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  3. Run all binaries -- outputs must match&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  4. Any mismatch indicates a compiler bug&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Csmith has found 400+ bugs in GCC and LLVM!&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># Simple equivalence checker</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simple translation validation example:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Original:   x = a + 0&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Optimized:  x = a&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Valid? YES (adding zero is identity)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Original:   x = a * 2&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Optimized:  x = a &lt;&lt; 1&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Valid? YES (for unsigned; need to check overflow for signed)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Original:   x = a / b&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Optimized:  x = a &gt;&gt; log2(b)  (when b is power of 2)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Valid? Only if a &gt;= 0 and b &gt; 0 (signed division rounds toward zero)&quot;</span><span class="p">)</span>

<span class="n">compiler_verification_overview</span><span class="p">()</span>
</code></pre></div>

<h3 id="124-alive2-llvm-ir-verification">12.4 Alive2: LLVM IR Verification<a class="header-link" href="#124-alive2-llvm-ir-verification" title="Permanent link">&para;</a></h3>
<p><strong>Alive2</strong> automatically verifies LLVM optimization passes by checking that the optimized IR refines the original IR for all possible inputs.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">alive2_example</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulate Alive2-style verification.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Alive2-style Verification ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">optimizations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Strength reduction: x * 2 -&gt; x + x&#39;</span><span class="p">,</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;optimized&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span>
            <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;x / 2 -&gt; x &gt;&gt; 1 (signed)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">//</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="p">((</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;optimized&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Differs for negative odd numbers!</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;x + 0 -&gt; x&#39;</span><span class="p">,</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;optimized&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
            <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">optimizations</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimization: </span><span class="si">{</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Test with various inputs</span>
        <span class="n">test_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="mi">127</span><span class="p">,</span> <span class="o">-</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">all_match</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">counterexample</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">test_values</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">orig_result</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;original&#39;</span><span class="p">](</span><span class="n">val</span><span class="p">)</span>
                <span class="n">opt_result</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;optimized&#39;</span><span class="p">](</span><span class="n">val</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">orig_result</span> <span class="o">!=</span> <span class="n">opt_result</span><span class="p">:</span>
                    <span class="n">all_match</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">counterexample</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">orig_result</span><span class="p">,</span> <span class="n">opt_result</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">all_match</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Result: VALID (all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_values</span><span class="p">)</span><span class="si">}</span><span class="s2"> test values match)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">optim</span> <span class="o">=</span> <span class="n">counterexample</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Result: INVALID!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Counterexample: x = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Original:  </span><span class="si">{</span><span class="n">orig</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Optimized: </span><span class="si">{</span><span class="n">optim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

<span class="n">alive2_example</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="13-summary">13. Summary<a class="header-link" href="#13-summary" title="Permanent link">&para;</a></h2>
<p>Modern compiler infrastructure has evolved from monolithic, language-specific compilers to modular, reusable frameworks:</p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Purpose</th>
<th>Key Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>LLVM IR</strong></td>
<td>Universal optimization target</td>
<td>Used by Clang, Rust, Swift, Julia</td>
</tr>
<tr>
<td><strong>MLIR</strong></td>
<td>Multi-level IR framework</td>
<td>TensorFlow, hardware compilers</td>
</tr>
<tr>
<td><strong>Passes</strong></td>
<td>Modular optimization</td>
<td>Constant folding, DCE, inlining</td>
</tr>
<tr>
<td><strong>DSLs</strong></td>
<td>Domain-specific expressiveness</td>
<td>SQL, HTML, shader languages</td>
</tr>
<tr>
<td><strong>ANTLR</strong></td>
<td>Parser generation</td>
<td>Language tooling</td>
</tr>
<tr>
<td><strong>Tree-sitter</strong></td>
<td>Incremental parsing</td>
<td>Editor integration</td>
</tr>
<tr>
<td><strong>LSP</strong></td>
<td>Editor-language bridge</td>
<td>VS Code, vim, emacs</td>
</tr>
<tr>
<td><strong>PGO</strong></td>
<td>Runtime-informed optimization</td>
<td>10-20% speedup</td>
</tr>
<tr>
<td><strong>LTO</strong></td>
<td>Cross-module optimization</td>
<td>Whole-program analysis</td>
</tr>
<tr>
<td><strong>Verification</strong></td>
<td>Compiler correctness</td>
<td>CompCert, Alive2, Csmith</td>
</tr>
</tbody>
</table>
<p>Key principles:</p>
<ol>
<li><strong>Modularity</strong>: Separating frontends, optimizers, and backends enables reuse and rapid language development.</li>
<li><strong>IR design matters</strong>: A well-designed IR (like LLVM IR) becomes the foundation for an entire ecosystem.</li>
<li><strong>Multiple levels of abstraction</strong>: MLIR recognizes that different domains need different IR levels.</li>
<li><strong>Tooling is essential</strong>: Modern language development is as much about tooling (LSP, Tree-sitter, formatters) as about the compiler itself.</li>
<li><strong>Optimization is never-ending</strong>: PGO, LTO, and runtime optimization continue to find improvements that static compilation alone cannot.</li>
<li><strong>Correctness is paramount</strong>: As compilers grow more complex, formal verification and automated testing become increasingly important.</li>
</ol>
<hr />
<h2 id="14-exercises">14. Exercises<a class="header-link" href="#14-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-llvm-ir-by-hand">Exercise 1: LLVM IR by Hand<a class="header-link" href="#exercise-1-llvm-ir-by-hand" title="Permanent link">&para;</a></h3>
<p>Write LLVM IR (textual form) for the following functions:</p>
<p>(a) <code>int max(int a, int b)</code> -- returns the larger of two integers using a conditional branch and phi node.</p>
<p>(b) <code>int sum_array(int* arr, int n)</code> -- sums all elements of an array using a loop with phi nodes.</p>
<p>(c) <code>int fibonacci(int n)</code> -- iterative Fibonacci using a loop.</p>
<p>Verify your IR is syntactically correct by checking it follows SSA form (each <code>%name</code> defined exactly once).</p>
<h3 id="exercise-2-optimization-pass">Exercise 2: Optimization Pass<a class="header-link" href="#exercise-2-optimization-pass" title="Permanent link">&para;</a></h3>
<p>Implement a <strong>strength reduction</strong> pass (in Python, simulating LLVM IR) that:
(a) Replaces <code>x * 2</code> with <code>x + x</code>.
(b) Replaces <code>x * power_of_2</code> with <code>x &lt;&lt; log2(power_of_2)</code>.
(c) Replaces <code>x / power_of_2</code> with <code>x &gt;&gt; log2(power_of_2)</code> (unsigned only).</p>
<p>Test on a function that uses these patterns and verify the output is correct.</p>
<h3 id="exercise-3-dsl-design-and-implementation">Exercise 3: DSL Design and Implementation<a class="header-link" href="#exercise-3-dsl-design-and-implementation" title="Permanent link">&para;</a></h3>
<p>Design and implement a DSL for one of the following domains:</p>
<p>(a) <strong>State machines</strong>: A DSL for defining finite state machines with states, transitions, and actions.
(b) <strong>Build systems</strong>: A simplified Makefile-like DSL for defining build rules and dependencies.
(c) <strong>Data validation</strong>: A DSL for defining validation rules on structured data (like JSON Schema but simpler).</p>
<p>Your implementation should include: a parser (can use Python's <code>re</code> or a simple recursive descent), an AST, and a code generator that produces runnable Python code.</p>
<h3 id="exercise-4-incremental-compilation">Exercise 4: Incremental Compilation<a class="header-link" href="#exercise-4-incremental-compilation" title="Permanent link">&para;</a></h3>
<p>Extend the incremental compiler from Section 9 to:
(a) Track dependencies at the symbol level (not just file level) -- if function <code>foo</code> in <code>a.c</code> changes but function <code>bar</code> in <code>a.c</code> doesn't, only recompile files that depend on <code>foo</code>.
(b) Handle circular dependencies (detect and report them).
(c) Persist the dependency graph to disk so it survives across invocations.</p>
<h3 id="exercise-5-pgo-simulator">Exercise 5: PGO Simulator<a class="header-link" href="#exercise-5-pgo-simulator" title="Permanent link">&para;</a></h3>
<p>Build a PGO simulator that:
(a) Takes a simple program (represented as a CFG with basic blocks and branch probabilities).
(b) Simulates execution with given input to collect branch frequencies.
(c) Uses the profile to reorder basic blocks (hot paths first, cold paths moved to the end).
(d) Calculates the expected improvement in instruction cache hit rate.</p>
<h3 id="exercise-6-translation-validator">Exercise 6: Translation Validator<a class="header-link" href="#exercise-6-translation-validator" title="Permanent link">&para;</a></h3>
<p>Implement a simple translation validator that checks whether two simple expressions are equivalent:
(a) Support integer arithmetic: <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>&lt;&lt;</code>, <code>&gt;&gt;</code>.
(b) Support constant folding verification (e.g., <code>3 + 4</code> equals <code>7</code>).
(c) Support algebraic identities (e.g., <code>x + 0 = x</code>, <code>x * 1 = x</code>).
(d) Use symbolic execution with concrete test values to find counterexamples.
(e) Report whether the transformation is valid or provide a counterexample.</p>
<hr />
<h2 id="15-references">15. References<a class="header-link" href="#15-references" title="Permanent link">&para;</a></h2>
<ol>
<li>Lattner, C. (2002). "LLVM: An Infrastructure for Multi-Level Intermediate Representation." Master's thesis, University of Illinois.</li>
<li>Lattner, C., Amini, M., Bondhugula, U., et al. (2021). "MLIR: Scaling Compiler Infrastructure for Domain Specific Computation." <em>CGO</em>.</li>
<li>LLVM Language Reference Manual. <a href="https://llvm.org/docs/LangRef.html">llvm.org/docs/LangRef.html</a>.</li>
<li>Leroy, X. (2009). "Formal Verification of a Realistic Compiler." <em>Communications of the ACM</em>, 52(7).</li>
<li>Lopes, N. V., Lee, J., Hur, C.-K., Liu, Z., &amp; Regehr, J. (2021). "Alive2: Bounded Translation Validation for LLVM." <em>PLDI</em>.</li>
<li>Yang, X., Chen, Y., Eide, E., &amp; Regehr, J. (2011). "Finding and Understanding Bugs in C Compilers." <em>PLDI</em>.</li>
<li>Parr, T. (2013). <em>The Definitive ANTLR 4 Reference</em>. Pragmatic Bookshelf.</li>
<li>Brunsfeld, M. (2018). "Tree-sitter -- A new parsing system for programming tools." GitHub.</li>
<li>Microsoft. "Language Server Protocol Specification." <a href="https://microsoft.github.io/language-server-protocol/">microsoft.github.io/language-server-protocol</a>.</li>
<li>Stallman, R. M. (2023). <em>GCC Internals Manual</em>. Free Software Foundation.</li>
</ol>
<hr />
<p><a href="./15_Interpreters_and_Virtual_Machines.md">Previous: 15. Interpreters and Virtual Machines</a> | <a href="./00_Overview.md">Overview</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Compiler_Design/15_Interpreters_and_Virtual_Machines.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Interpreters and Virtual Machines</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Compiler_Design/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}