{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Branch Prediction - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Computer_Architecture/">Computer Architecture</a>
    <span class="separator">/</span>
    <span class="current">Branch Prediction</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Branch Prediction</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Computer_Architecture/11_Pipelining.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Pipelining</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Computer_Architecture/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Computer_Architecture/13_Superscalar_Out_of_Order.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Superscalar and Out-of-Order Execution</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-control-hazards-and-branch-problem">1. Control Hazards and Branch Problem</a><ul>
<li><a href="#pipeline-bubbles-from-branches">Pipeline Bubbles from Branches</a></li>
<li><a href="#branch-penalty">Branch Penalty</a></li>
<li><a href="#necessity-of-branch-prediction">Necessity of Branch Prediction</a></li>
</ul>
</li>
<li><a href="#2-static-branch-prediction">2. Static Branch Prediction</a><ul>
<li><a href="#21-always-not-taken">2.1 Always Not Taken</a></li>
<li><a href="#22-always-taken">2.2 Always Taken</a></li>
<li><a href="#23-btfn-backward-taken-forward-not-taken">2.3 BTFN (Backward Taken, Forward Not Taken)</a></li>
</ul>
</li>
<li><a href="#3-dynamic-branch-prediction">3. Dynamic Branch Prediction</a><ul>
<li><a href="#31-1-bit-predictor">3.1 1-bit Predictor</a></li>
<li><a href="#limitations-of-1-bit-predictor">Limitations of 1-bit Predictor</a></li>
<li><a href="#32-2-bit-predictor">3.2 2-bit Predictor</a></li>
<li><a href="#2-bit-predictor-operation-example">2-bit Predictor Operation Example</a></li>
<li><a href="#33-branch-history-table-bht">3.3 Branch History Table (BHT)</a></li>
<li><a href="#34-correlating-predictor">3.4 Correlating Predictor</a></li>
<li><a href="#35-tournament-predictor">3.5 Tournament Predictor</a></li>
</ul>
</li>
<li><a href="#4-branch-target-buffer">4. Branch Target Buffer</a><ul>
<li><a href="#btb-branch-target-buffer">BTB (Branch Target Buffer)</a></li>
<li><a href="#btb-operation-flow">BTB Operation Flow</a></li>
</ul>
</li>
<li><a href="#5-speculative-execution">5. Speculative Execution</a><ul>
<li><a href="#concept">Concept</a></li>
<li><a href="#misprediction-recovery">Misprediction Recovery</a></li>
<li><a href="#impact-of-misprediction-rate">Impact of Misprediction Rate</a></li>
</ul>
</li>
<li><a href="#6-practice-problems">6. Practice Problems</a><ul>
<li><a href="#basic-problems">Basic Problems</a></li>
<li><a href="#analysis-problems">Analysis Problems</a></li>
<li><a href="#advanced-problems">Advanced Problems</a></li>
</ul>
</li>
<li><a href="#next-steps">Next Steps</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="branch-prediction">Branch Prediction<a class="header-link" href="#branch-prediction" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="header-link" href="#overview" title="Permanent link">&para;</a></h2>
<p>Branch prediction is a technique that improves pipeline performance by predicting the outcome of conditional branch instructions in advance. Modern processors achieve prediction accuracy of over 90%.</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-control-hazards-and-branch-problem">Control Hazards and Branch Problem</a></li>
<li><a href="#2-static-branch-prediction">Static Branch Prediction</a></li>
<li><a href="#3-dynamic-branch-prediction">Dynamic Branch Prediction</a></li>
<li><a href="#4-branch-target-buffer">Branch Target Buffer</a></li>
<li><a href="#5-speculative-execution">Speculative Execution</a></li>
<li><a href="#6-practice-problems">Practice Problems</a></li>
</ol>
<hr />
<h2 id="1-control-hazards-and-branch-problem">1. Control Hazards and Branch Problem<a class="header-link" href="#1-control-hazards-and-branch-problem" title="Permanent link">&para;</a></h2>
<h3 id="pipeline-bubbles-from-branches">Pipeline Bubbles from Branches<a class="header-link" href="#pipeline-bubbles-from-branches" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">beq</span><span class="w"> </span><span class="err">$</span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">target</span>
<span class="k">add</span><span class="w"> </span><span class="err">$</span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">s2</span><span class="w">     </span><span class="err">#</span><span class="w"> </span><span class="n">Should</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">execute</span><span class="vm">?</span>
<span class="n">sub</span><span class="w"> </span><span class="err">$</span><span class="n">s3</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">s4</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">s5</span><span class="w">     </span><span class="err">#</span><span class="w"> </span><span class="n">Should</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">execute</span><span class="vm">?</span>
<span class="p">...</span>
<span class="nl">target</span><span class="p">:</span>
<span class="ow">or</span><span class="w">  </span><span class="err">$</span><span class="n">s6</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">s7</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">s8</span>

<span class="nc">Time</span><span class="err">:</span><span class="w">    </span><span class="mi">1</span><span class="w">    </span><span class="mi">2</span><span class="w">    </span><span class="mi">3</span><span class="w">    </span><span class="mi">4</span><span class="w">    </span><span class="mi">5</span><span class="w">    </span><span class="mi">6</span><span class="w">    </span><span class="mi">7</span>
<span class="nl">beq</span><span class="p">:</span><span class="w">    </span><span class="k">IF</span><span class="w">   </span><span class="n">ID</span><span class="w">  </span><span class="o">[</span><span class="n">EX</span><span class="o">]</span><span class="w">  </span><span class="n">MEM</span><span class="w">  </span><span class="n">WB</span>
<span class="w">                  </span><span class="err">â†‘</span>
<span class="w">             </span><span class="n">Branch</span><span class="w"> </span><span class="n">decision</span>
<span class="k">add</span><span class="err">:</span><span class="w">         </span><span class="k">IF</span><span class="w">   </span><span class="n">ID</span><span class="w">   </span><span class="err">â†</span><span class="w"> </span><span class="n">May</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="n">flush</span>
<span class="nl">sub</span><span class="p">:</span><span class="w">              </span><span class="k">IF</span><span class="w">   </span><span class="err">â†</span><span class="w"> </span><span class="n">May</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="n">flush</span>
</code></pre></div>

<h3 id="branch-penalty">Branch Penalty<a class="header-link" href="#branch-penalty" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Penalty based on decision timing:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Decision Stage â”‚    Penalty     â”‚   Note    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ID stage       â”‚   1 cycle      â”‚ Early MIPSâ”‚
â”‚   EX stage       â”‚   2 cycles     â”‚ Typical   â”‚
â”‚   MEM stage      â”‚   3 cycles     â”‚ Complex   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Modern processors: 10-20 cycle pipelines
â†’ Branch prediction essential!
</code></pre></div>

<h3 id="necessity-of-branch-prediction">Necessity of Branch Prediction<a class="header-link" href="#necessity-of-branch-prediction" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Branch frequency: ~20% (1 in every 5 instructions)

Always stall without prediction:
CPI = 1 + 0.2 Ã— 3 = 1.6  (assuming 3 cycle penalty)

90% accurate prediction:
CPI = 1 + 0.2 Ã— 0.1 Ã— 3 = 1.06

Performance improvement: 1.6/1.06 = 1.5x
</code></pre></div>

<hr />
<h2 id="2-static-branch-prediction">2. Static Branch Prediction<a class="header-link" href="#2-static-branch-prediction" title="Permanent link">&para;</a></h2>
<h3 id="21-always-not-taken">2.1 Always Not Taken<a class="header-link" href="#21-always-not-taken" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Strategy</span><span class="o">:</span><span class="w"> </span><span class="n">Predict</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">branches</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">taken</span>

<span class="n">Pros</span><span class="o">:</span><span class="w"> </span><span class="n">Simple</span><span class="w"> </span><span class="n">implementation</span>
<span class="n">Cons</span><span class="o">:</span><span class="w"> </span><span class="n">Poor</span><span class="w"> </span><span class="n">performance</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">loops</span>

<span class="k">for</span><span class="w"> </span><span class="o">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="o">;</span><span class="w"> </span><span class="n">i</span><span class="o">++)</span><span class="w">  </span><span class="c1">// 99 times taken, 1 time not taken</span>
<span class="w">                           </span><span class="c1">// Prediction accuracy: 1%</span>
</code></pre></div>

<h3 id="22-always-taken">2.2 Always Taken<a class="header-link" href="#22-always-taken" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Strategy</span><span class="o">:</span><span class="w"> </span><span class="n">Predict</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">branches</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">taken</span>

<span class="n">Pros</span><span class="o">:</span><span class="w"> </span><span class="n">Good</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">loops</span>
<span class="n">Cons</span><span class="o">:</span><span class="w"> </span><span class="n">Requires</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">calculation</span>

<span class="k">for</span><span class="w"> </span><span class="o">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="o">;</span><span class="w"> </span><span class="n">i</span><span class="o">++)</span><span class="w">  </span><span class="c1">// Prediction accuracy: 99%</span>
</code></pre></div>

<h3 id="23-btfn-backward-taken-forward-not-taken">2.3 BTFN (Backward Taken, Forward Not Taken)<a class="header-link" href="#23-btfn-backward-taken-forward-not-taken" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nv">Strategy</span>:
<span class="o">-</span><span class="w"> </span><span class="nv">Backward</span><span class="w"> </span><span class="nv">branches</span><span class="w"> </span><span class="ss">(</span><span class="nv">loops</span><span class="ss">)</span>:<span class="w"> </span><span class="nv">Predict</span><span class="w"> </span><span class="nv">Taken</span>
<span class="o">-</span><span class="w"> </span><span class="nv">Forward</span><span class="w"> </span><span class="nv">branches</span><span class="w"> </span><span class="ss">(</span><span class="k">if</span><span class="w"> </span><span class="nv">statements</span><span class="ss">)</span>:<span class="w"> </span><span class="nv">Predict</span><span class="w"> </span><span class="nv">Not</span><span class="w"> </span><span class="nv">Taken</span>

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">     </span><span class="nv">Prediction</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">Branch</span><span class="w"> </span><span class="nv">Direction</span><span class="w">       </span>â”‚
â”‚<span class="w">                                         </span>â”‚
â”‚<span class="w">  </span><span class="nv">PC</span><span class="o">=</span><span class="mi">100</span>:<span class="w">  </span><span class="nv">beq</span><span class="w"> </span><span class="nv">label</span><span class="w">    </span><span class="ss">(</span><span class="nv">label</span><span class="o">=</span><span class="mi">80</span><span class="ss">)</span><span class="w">       </span>â”‚
â”‚<span class="w">           </span>â†‘<span class="w">                             </span>â”‚
â”‚<span class="w">           </span><span class="nv">Backward</span><span class="w"> </span><span class="nv">branch</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">Predict</span><span class="w"> </span><span class="nv">Taken</span>â”‚
â”‚<span class="w">                                         </span>â”‚
â”‚<span class="w">  </span><span class="nv">PC</span><span class="o">=</span><span class="mi">100</span>:<span class="w">  </span><span class="nv">beq</span><span class="w"> </span><span class="nv">label</span><span class="w">    </span><span class="ss">(</span><span class="nv">label</span><span class="o">=</span><span class="mi">120</span><span class="ss">)</span><span class="w">      </span>â”‚
â”‚<span class="w">           </span>â†‘<span class="w">                             </span>â”‚
â”‚<span class="w">           </span><span class="nv">Forward</span><span class="w"> </span><span class="nv">branch</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">Predict</span><span class="w"> </span><span class="nv">Not</span><span class="w"> </span><span class="nv">Taken</span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

<span class="k">Loop</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="nv">jumping</span><span class="w"> </span><span class="nv">back</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">start</span>:<span class="w"> </span><span class="nv">Backward</span><span class="w"> </span><span class="nv">branch</span>
<span class="k">if</span><span class="w"> </span><span class="nv">statement</span><span class="w"> </span><span class="nv">jumping</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="k">else</span>:<span class="w"> </span><span class="nv">Forward</span><span class="w"> </span><span class="nv">branch</span>
</code></pre></div>

<hr />
<h2 id="3-dynamic-branch-prediction">3. Dynamic Branch Prediction<a class="header-link" href="#3-dynamic-branch-prediction" title="Permanent link">&para;</a></h2>
<h3 id="31-1-bit-predictor">3.1 1-bit Predictor<a class="header-link" href="#31-1-bit-predictor" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">           </span><span class="mi">1</span><span class="o">-</span><span class="nv">bit</span><span class="w"> </span><span class="nv">Predictor</span><span class="w">               </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">  </span><span class="nv">State</span>:<span class="w"> </span><span class="nv">Taken</span><span class="ss">(</span><span class="mi">1</span><span class="ss">)</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">Not</span><span class="w"> </span><span class="nv">Taken</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span><span class="w">        </span>â”‚
â”‚<span class="w">                                         </span>â”‚
â”‚<span class="w">  </span><span class="nv">Operation</span>:<span class="w">                             </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Predict</span><span class="w"> </span><span class="nv">based</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">current</span><span class="w"> </span><span class="nv">state</span><span class="w">       </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Flip</span><span class="w"> </span><span class="nv">state</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">wrong</span><span class="w">                  </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

<span class="nv">State</span><span class="w"> </span><span class="nv">transition</span>:
<span class="w">     </span><span class="nv">Wrong</span><span class="w">        </span><span class="nv">Wrong</span>
<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">   </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
<span class="w">  </span>â”‚<span class="w">        </span>â”‚<span class="w">   </span>â”‚<span class="w">        </span>â”‚
<span class="w">  </span>â–¼<span class="w">        </span>â”‚<span class="w">   </span>â–¼<span class="w">        </span>â”‚
â”Œâ”€â”€â”€â”€â”<span class="w">     </span>â”‚<span class="w"> </span>â”Œâ”€â”€â”€â”€â”<span class="w">     </span>â”‚
â”‚<span class="w"> </span><span class="nv">NT</span><span class="w"> </span>â”‚â—€â”€â”€â”€â”€â”´â”€â”‚<span class="w"> </span><span class="nv">T</span><span class="w">  </span>â”‚â—€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”˜<span class="w">  </span><span class="nv">Right</span><span class="w"> </span>â””â”€â”€â”€â”€â”˜<span class="w">  </span><span class="nv">Right</span>

<span class="nv">Problem</span>:<span class="w"> </span><span class="nv">Always</span><span class="w"> </span><span class="nv">wrong</span><span class="w"> </span><span class="nv">twice</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="k">loop</span><span class="w"> </span><span class="nv">start</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="k">end</span>
</code></pre></div>

<h3 id="limitations-of-1-bit-predictor">Limitations of 1-bit Predictor<a class="header-link" href="#limitations-of-1-bit-predictor" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="mf">100</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="n">iterations</span><span class="p">:</span>
<span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="mf">...</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">N</span><span class="w">  </span><span class="p">(</span><span class="mf">99</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="n">N</span><span class="p">)</span>
<span class="w">                 </span><span class="err">â†‘</span><span class="w"> </span><span class="n">Loop</span><span class="w"> </span><span class="n">exit</span>

<span class="n">Prediction</span><span class="p">:</span><span class="w">   </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="mf">...</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">N</span>
<span class="n">Actual</span><span class="p">:</span><span class="w">       </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="mf">...</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="err">â†</span>
<span class="w">                      </span><span class="err">â†‘</span><span class="w"> </span><span class="n">Wrong</span><span class="w"> </span><span class="p">(</span><span class="n">predicted</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="n">N</span><span class="p">)</span>

<span class="kr">Next</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="n">start</span><span class="p">:</span>
<span class="n">Prediction</span><span class="p">:</span><span class="w">   </span><span class="n">N</span><span class="w"> </span><span class="err">â†</span><span class="w"> </span><span class="n">Wrong</span><span class="w"> </span><span class="p">(</span><span class="n">predicted</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="n">T</span><span class="p">)</span>

<span class="mf">2</span><span class="w"> </span><span class="n">mispredictions</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="mf">98</span><span class="err">%</span><span class="w"> </span><span class="n">accuracy</span>
</code></pre></div>

<h3 id="32-2-bit-predictor">3.2 2-bit Predictor<a class="header-link" href="#32-2-bit-predictor" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">              </span><span class="mi">2</span><span class="o">-</span><span class="nv">bit</span><span class="w"> </span><span class="nv">Saturating</span><span class="w"> </span><span class="nv">Counter</span><span class="w">           </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="nv">states</span>:<span class="w">                                      </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="mi">00</span>:<span class="w"> </span><span class="nv">Strongly</span><span class="w"> </span><span class="nv">Not</span><span class="w"> </span><span class="nv">Taken</span><span class="w">                       </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="mi">01</span>:<span class="w"> </span><span class="nv">Weakly</span><span class="w"> </span><span class="nv">Not</span><span class="w"> </span><span class="nv">Taken</span><span class="w">                         </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span>:<span class="w"> </span><span class="nv">Weakly</span><span class="w"> </span><span class="nv">Taken</span><span class="w">                             </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="mi">11</span>:<span class="w"> </span><span class="nv">Strongly</span><span class="w"> </span><span class="nv">Taken</span><span class="w">                           </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

<span class="nv">State</span><span class="w"> </span><span class="nv">transition</span><span class="w"> </span><span class="nv">diagram</span>:
<span class="w">        </span><span class="nv">N</span><span class="w">              </span><span class="nv">N</span><span class="w">              </span><span class="nv">N</span>
<span class="w">   </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">     </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">     </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
<span class="w">   </span>â”‚<span class="w">        </span>â–¼<span class="w">     </span>â”‚<span class="w">        </span>â–¼<span class="w">     </span>â”‚<span class="w">        </span>â–¼
â”Œâ”€â”€â”´â”€â”€â”<span class="w">  </span>â”Œâ”€â”€â”´â”€â”€â”<span class="w">  </span>â”Œâ”€â”€â”´â”€â”€â”<span class="w">  </span>â”Œâ”€â”€â”´â”€â”€â”
â”‚<span class="w"> </span><span class="nv">SNT</span><span class="w"> </span>â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">WNT</span><span class="w"> </span>â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">WT</span><span class="w">  </span>â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">ST</span><span class="w">  </span>â”‚
â”‚<span class="w"> </span><span class="mi">00</span><span class="w">  </span>â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="mi">01</span><span class="w">  </span>â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="mi">10</span><span class="w">  </span>â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="mi">11</span><span class="w">  </span>â”‚
â””â”€â”€â”¬â”€â”€â”˜<span class="w">  </span>â””â”€â”€â”¬â”€â”€â”˜<span class="w">  </span>â””â”€â”€â”¬â”€â”€â”˜<span class="w">  </span>â””â”€â”€â”¬â”€â”€â”˜
<span class="w">   </span>â”‚<span class="w">        </span>â–²<span class="w">     </span>â”‚<span class="w">        </span>â–²<span class="w">     </span>â”‚<span class="w">        </span>â–²
<span class="w">   </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">     </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">     </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<span class="w">        </span><span class="nv">T</span><span class="w">              </span><span class="nv">T</span><span class="w">              </span><span class="nv">T</span>

<span class="nv">Prediction</span>:<span class="w"> </span><span class="nv">Taken</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">upper</span><span class="w"> </span><span class="nv">bit</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="mi">1</span>,<span class="w"> </span><span class="nv">Not</span><span class="w"> </span><span class="nv">Taken</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>

<h3 id="2-bit-predictor-operation-example">2-bit Predictor Operation Example<a class="header-link" href="#2-bit-predictor-operation-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="mf">100</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="n">iterations</span><span class="p">:</span>
<span class="n">Actual</span><span class="p">:</span><span class="w">   </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="mf">...</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="mf">...</span><span class="w"> </span><span class="p">(</span><span class="kr">next</span><span class="w"> </span><span class="n">loop</span><span class="p">)</span>

<span class="n">State</span><span class="p">:</span><span class="w">  </span><span class="n">ST</span><span class="w"> </span><span class="n">ST</span><span class="w"> </span><span class="n">ST</span><span class="w"> </span><span class="mf">...</span><span class="w"> </span><span class="n">ST</span><span class="w"> </span><span class="n">WT</span><span class="w"> </span><span class="n">ST</span><span class="w"> </span><span class="n">ST</span><span class="w"> </span><span class="n">ST</span><span class="w"> </span><span class="mf">...</span>
<span class="n">Pred</span><span class="p">:</span><span class="w">    </span><span class="n">T</span><span class="w">  </span><span class="n">T</span><span class="w">  </span><span class="n">T</span><span class="w"> </span><span class="mf">...</span><span class="w">  </span><span class="n">T</span><span class="w">  </span><span class="n">T</span><span class="w">  </span><span class="n">T</span><span class="w">  </span><span class="n">T</span><span class="w">  </span><span class="n">T</span><span class="w"> </span><span class="mf">...</span>
<span class="n">Correct</span><span class="p">:</span><span class="w"> </span><span class="err">âœ“</span><span class="w">  </span><span class="err">âœ“</span><span class="w">  </span><span class="err">âœ“</span><span class="w"> </span><span class="mf">...</span><span class="w"> </span><span class="err">âœ“</span><span class="w">  </span><span class="err">âœ—</span><span class="w">  </span><span class="err">âœ“</span><span class="w">  </span><span class="err">âœ“</span><span class="w">  </span><span class="err">âœ“</span><span class="w"> </span><span class="mf">...</span>

<span class="kr">On</span><span class="n">ly</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="n">misprediction</span><span class="err">!</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">loop</span>
<span class="mf">99</span><span class="err">%</span><span class="o">+</span><span class="w"> </span><span class="n">accuracy</span>
</code></pre></div>

<h3 id="33-branch-history-table-bht">3.3 Branch History Table (BHT)<a class="header-link" href="#33-branch-history-table-bht" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Branch History Table (BHT)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚   PC[9:2] â”€â”€â”€â–¶ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                â”‚ Index   â”‚                     â”‚
â”‚                â”‚  256    â”‚                     â”‚
â”‚                â”‚ entries â”‚                     â”‚
â”‚                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                     â”‚
â”‚                     â”‚                          â”‚
â”‚                     â–¼                          â”‚
â”‚              2-bit counter                     â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Uses part of PC as index
- Each entry stores a 2-bit counter
- Multiple branches can map to same index (aliasing)
</code></pre></div>

<h3 id="34-correlating-predictor">3.4 Correlating Predictor<a class="header-link" href="#34-correlating-predictor" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Idea</span><span class="o">:</span><span class="w"> </span><span class="n">Other</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="n">outcomes</span><span class="w"> </span><span class="n">affect</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">branch</span>

<span class="n">Example</span><span class="w"> </span><span class="n">code</span><span class="o">:</span>
<span class="k">if</span><span class="w"> </span><span class="o">(</span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w">     </span><span class="c1">// B1</span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="k">if</span><span class="w"> </span><span class="o">(</span><span class="n">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w">     </span><span class="c1">// B2</span>
<span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="k">if</span><span class="w"> </span><span class="o">(</span><span class="n">a</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">b</span><span class="o">)</span><span class="w">     </span><span class="c1">// B3: Correlated with B1, B2 outcomes!</span>
<span class="w">    </span><span class="o">...</span>

<span class="o">(</span><span class="n">m</span><span class="o">,</span><span class="w"> </span><span class="n">n</span><span class="o">)</span><span class="w"> </span><span class="n">predictor</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">m</span><span class="o">:</span><span class="w"> </span><span class="n">Record</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="n">outcomes</span><span class="w"> </span><span class="o">(</span><span class="n">Global</span><span class="w"> </span><span class="n">History</span><span class="o">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">n</span><span class="o">:</span><span class="w"> </span><span class="n">n</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">counter</span>

<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="n">Correlating</span><span class="w"> </span><span class="n">Predictor</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Global</span><span class="w"> </span><span class="n">History</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="o">(</span><span class="mi">00</span><span class="o">,</span><span class="w"> </span><span class="mi">01</span><span class="o">,</span><span class="w"> </span><span class="mi">10</span><span class="o">,</span><span class="w"> </span><span class="mi">11</span><span class="o">)</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Per</span><span class="w"> </span><span class="n">history</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">counter</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Total</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">2</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">counters</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="35-tournament-predictor">3.5 Tournament Predictor<a class="header-link" href="#35-tournament-predictor" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Tournament Predictor                  â”‚
â”‚                                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  PC â”€â”€â”€â–¶â”‚  Selector   â”‚ (2-bit counter)        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                â”‚                               â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚         â–¼             â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚   Local    â”‚ â”‚   Global   â”‚                 â”‚
â”‚  â”‚ Predictor  â”‚ â”‚ Predictor  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚             â”‚                        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                â–¼                               â”‚
â”‚           MUX (select)                         â”‚
â”‚                â”‚                               â”‚
â”‚                â–¼                               â”‚
â”‚            Prediction                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

- Local: Uses individual branch history
- Global: Uses overall branch history
- Selector: Learns which predictor is more accurate
</code></pre></div>

<hr />
<h2 id="4-branch-target-buffer">4. Branch Target Buffer<a class="header-link" href="#4-branch-target-buffer" title="Permanent link">&para;</a></h2>
<h3 id="btb-branch-target-buffer">BTB (Branch Target Buffer)<a class="header-link" href="#btb-branch-target-buffer" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nx">Stores</span><span class="w"> </span><span class="nx">whether</span><span class="w"> </span><span class="nx">instruction</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">branch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="nx">address</span>

<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="nx">Branch</span><span class="w"> </span><span class="nx">Target</span><span class="w"> </span><span class="nx">Buffer</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">    </span><span class="nx">Tag</span><span class="w">    </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Target</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Prediction</span><span class="w"> </span><span class="p">(</span><span class="nx">optional</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mh">0x1000</span><span class="o">...</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="mh">0x2000</span><span class="w">  </span><span class="err">â”‚</span><span class="w">        </span><span class="nx">ST</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mh">0x1100</span><span class="o">...</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="mh">0x1500</span><span class="w">  </span><span class="err">â”‚</span><span class="w">        </span><span class="nx">WT</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mh">0x2000</span><span class="o">...</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="mh">0x1800</span><span class="w">  </span><span class="err">â”‚</span><span class="w">        </span><span class="nx">SNT</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="o">...</span><span class="w">    </span><span class="err">â”‚</span><span class="w">   </span><span class="o">...</span><span class="w">    </span><span class="err">â”‚</span><span class="w">        </span><span class="o">...</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="nx">BTB</span><span class="w"> </span><span class="nx">lookup</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">IF</span><span class="w"> </span><span class="nx">stage</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="nx">Hit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">Taken</span><span class="w"> </span><span class="nx">prediction</span><span class="p">:</span><span class="w"> </span><span class="nx">Jump</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="nx">immediately</span>
<span class="o">-</span><span class="w"> </span><span class="nx">Miss</span><span class="p">:</span><span class="w"> </span><span class="nx">Normal</span><span class="w"> </span><span class="nx">execution</span><span class="p">,</span><span class="w"> </span><span class="nx">update</span><span class="w"> </span><span class="nx">BTB</span><span class="w"> </span><span class="nx">later</span>
</code></pre></div>

<h3 id="btb-operation-flow">BTB Operation Flow<a class="header-link" href="#btb-operation-flow" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                </span><span class="nx">IF</span><span class="w"> </span><span class="nx">Stage</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="nx">PC</span><span class="w"> </span><span class="err">â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">BTB</span><span class="w"> </span><span class="nx">Lookup</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">              </span><span class="err">â–¼</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Hit</span><span class="p">?</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="nx">No</span><span class="w">      </span><span class="err">â”‚</span><span class="w">      </span><span class="nx">Yes</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="err">â–¼</span><span class="w">       </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â–¼</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="nx">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w">     </span><span class="err">â”‚</span><span class="w">   </span><span class="nx">Taken</span><span class="w"> </span><span class="nx">prediction</span><span class="p">?</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span><span class="w">   </span><span class="nx">Yes</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">No</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â–¼</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â–¼</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Target</span><span class="w">  </span><span class="nx">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span><span class="w">   </span><span class="kd">addr</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="5-speculative-execution">5. Speculative Execution<a class="header-link" href="#5-speculative-execution" title="Permanent link">&para;</a></h2>
<h3 id="concept">Concept<a class="header-link" href="#concept" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Execute instructions on predicted path before branch result confirmed

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Speculative Execution                 â”‚
â”‚                                                 â”‚
â”‚   beq prediction: Taken                         â”‚
â”‚      â”‚                                          â”‚
â”‚      â–¼                                          â”‚
â”‚   Execute target instructions speculatively     â”‚
â”‚      â”‚                                          â”‚
â”‚      â–¼                                          â”‚
â”‚   Branch result confirmed                       â”‚
â”‚      â”‚                                          â”‚
â”‚   â”Œâ”€â”€â”´â”€â”€â”                                      â”‚
â”‚   â”‚     â”‚                                      â”‚
â”‚ Correct Wrong                                   â”‚
â”‚ prediction prediction                           â”‚
â”‚   â”‚     â”‚                                      â”‚
â”‚   â–¼     â–¼                                      â”‚
â”‚ Commit Discard                                  â”‚
â”‚ result (flush)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="misprediction-recovery">Misprediction Recovery<a class="header-link" href="#misprediction-recovery" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">On</span><span class="w"> </span><span class="nl">misprediction:</span>
<span class="mf">1.</span><span class="w"> </span><span class="n">Pipeline</span><span class="w"> </span><span class="n">flush</span><span class="w"> </span><span class="p">(</span><span class="n">remove</span><span class="w"> </span><span class="n">speculative</span><span class="w"> </span><span class="n">instructions</span><span class="p">)</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Restore</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="n">state</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">Re</span><span class="o">-</span><span class="n">execute</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">correct</span><span class="w"> </span><span class="n">path</span>

<span class="n">Recovery</span><span class="w"> </span><span class="nl">cost:</span>
<span class="o">-</span><span class="w"> </span><span class="n">Proportional</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">pipeline</span><span class="w"> </span><span class="n">depth</span>
<span class="o">-</span><span class="w"> </span><span class="n">Modern</span><span class="w"> </span><span class="nl">processors:</span><span class="w"> </span><span class="mh">10</span><span class="o">-</span><span class="mh">20</span><span class="w"> </span><span class="n">cycle</span><span class="w"> </span><span class="n">penalty</span>
</code></pre></div>

<h3 id="impact-of-misprediction-rate">Impact of Misprediction Rate<a class="header-link" href="#impact-of-misprediction-rate" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>CPI = CPI_base + (branch ratio) Ã— (misprediction rate) Ã— (penalty)

Example:
<span class="k">-</span> CPI_base = 1
<span class="k">-</span> Branch ratio = 20%
<span class="k">-</span> Penalty = 15 cycles

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Misprediction  â”‚      CPI         â”‚
â”‚    Rate        â”‚                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     10%        â”‚ 1 + 0.2Ã—0.1Ã—15   â”‚
â”‚                â”‚ = 1.30           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      5%        â”‚ 1 + 0.2Ã—0.05Ã—15  â”‚
â”‚                â”‚ = 1.15           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      2%        â”‚ 1 + 0.2Ã—0.02Ã—15  â”‚
â”‚                â”‚ = 1.06           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      1%        â”‚ 1 + 0.2Ã—0.01Ã—15  â”‚
â”‚                â”‚ = 1.03           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="6-practice-problems">6. Practice Problems<a class="header-link" href="#6-practice-problems" title="Permanent link">&para;</a></h2>
<h3 id="basic-problems">Basic Problems<a class="header-link" href="#basic-problems" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>What are the 3 static branch prediction methods?</p>
</li>
<li>
<p>What are the 4 states of a 2-bit predictor?</p>
</li>
<li>
<p>For the sequence below, what are the predictions of a 1-bit predictor (initial state T)?
   <code>T T N T T N T T</code></p>
</li>
</ol>
<h3 id="analysis-problems">Analysis Problems<a class="header-link" href="#analysis-problems" title="Permanent link">&para;</a></h3>
<ol>
<li>How does a 2-bit predictor (initial ST) behave for this loop?</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// loop body</span>
<span class="p">}</span>
</code></pre></div>

<ol>
<li>With 25% branch ratio, 10 cycle penalty, and 95% prediction accuracy, what is the CPI?</li>
</ol>
<h3 id="advanced-problems">Advanced Problems<a class="header-link" href="#advanced-problems" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>Explain why tournament predictors are better than single predictors.</p>
</li>
<li>
<p>Compare branch handling with and without BTB.</p>
</li>
</ol>
<details>
<summary>Answers</summary>

1. Always Not Taken, Always Taken, BTFN (Backward Taken, Forward Not Taken)

2. Strongly Not Taken (00), Weakly Not Taken (01), Weakly Taken (10), Strongly Taken (11)

3.

<div class="highlight"><pre><span></span><code><span class="n">Actual</span><span class="o">:</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span>
<span class="n">Pred</span><span class="o">:</span><span class="w">   </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="n">T</span>
<span class="n">State</span><span class="o">:</span><span class="w">  </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span>
<span class="n">Correct</span><span class="o">:</span><span class="w"> </span><span class="err">âœ“</span><span class="w"> </span><span class="err">âœ“</span><span class="w"> </span><span class="err">âœ—</span><span class="w"> </span><span class="err">âœ—</span><span class="w"> </span><span class="err">âœ“</span><span class="w"> </span><span class="err">âœ—</span><span class="w"> </span><span class="err">âœ—</span><span class="w"> </span><span class="err">âœ“</span><span class="w">  </span><span class="o">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="o">%)</span>
</code></pre></div>



4.

<div class="highlight"><pre><span></span><code><span class="n">Iterations</span><span class="o">:</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">(</span><span class="mi">4</span><span class="w"> </span><span class="n">iterations</span><span class="o">)</span>
<span class="n">State</span><span class="o">:</span><span class="w"> </span><span class="n">ST</span><span class="w"> </span><span class="n">ST</span><span class="w"> </span><span class="n">ST</span><span class="w"> </span><span class="n">WT</span><span class="w"> </span><span class="n">WT</span>
<span class="n">Pred</span><span class="o">:</span><span class="w">  </span><span class="n">T</span><span class="w">  </span><span class="n">T</span><span class="w">  </span><span class="n">T</span><span class="w">  </span><span class="n">T</span><span class="w">  </span><span class="n">T</span>
<span class="n">Correct</span><span class="o">:</span><span class="w"> </span><span class="err">âœ“</span><span class="w">  </span><span class="err">âœ“</span><span class="w">  </span><span class="err">âœ“</span><span class="w">  </span><span class="err">âœ—</span>
</code></pre></div>


1 failure in 4 = 75% accuracy

5. CPI = 1 + 0.25 Ã— 0.05 Ã— 10 = 1.125

6. Tournament predictors use both Local and Global predictors, selectively choosing the more accurate one for each branch. Some branches have important local patterns while others have important global correlations.

7.
- Without BTB: Branch type and target discovered only at ID or EX stage, penalty incurred
- With BTB: On BTB hit in IF stage, can jump to target immediately, minimizing penalty

</details>

<hr />
<h2 id="next-steps">Next Steps<a class="header-link" href="#next-steps" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="./13_Superscalar_Out_of_Order.md">13_Superscalar_Out_of_Order.md</a> - ILP and Out-of-Order Execution</li>
</ul>
<hr />
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li>Computer Architecture: A Quantitative Approach, Chapter 3 (Hennessy &amp; Patterson)</li>
<li><a href="https://www.jilp.org/cbp2016/">Branch Prediction Competition</a></li>
<li><a href="https://www.agner.org/optimize/">Agner Fog's Microarchitecture Guide</a></li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Computer_Architecture/11_Pipelining.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Pipelining</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Computer_Architecture/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Computer_Architecture/13_Superscalar_Out_of_Order.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Superscalar and Out-of-Order Execution</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}