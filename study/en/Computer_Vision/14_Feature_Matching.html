{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature Matching - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">üíª</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        ÌïúÍµ≠Ïñ¥
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">‚òÄÔ∏è</span>
                    <span class="theme-icon dark">üåô</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Computer_Vision/">Computer Vision</a>
    <span class="separator">/</span>
    <span class="current">Feature Matching</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Feature Matching</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Computer_Vision/13_Feature_Detection.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Feature Detection</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Computer_Vision/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Computer_Vision/15_Object_Detection_Basics.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Object Detection Basics</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-feature-matching-fundamentals">1. Feature Matching Fundamentals</a><ul>
<li><a href="#matching-process">Matching Process</a></li>
<li><a href="#dmatch-structure">DMatch Structure</a></li>
</ul>
</li>
<li><a href="#2-bfmatcher">2. BFMatcher</a><ul>
<li><a href="#concept">Concept</a></li>
<li><a href="#cv2bfmatcher">cv2.BFMatcher</a></li>
<li><a href="#crosscheck-option">crossCheck Option</a></li>
<li><a href="#knnmatch">knnMatch</a></li>
</ul>
</li>
<li><a href="#3-flann-based-matcher">3. FLANN-based Matcher</a><ul>
<li><a href="#concept_1">Concept</a></li>
<li><a href="#flann-usage">FLANN Usage</a></li>
<li><a href="#flann-for-orb-binary">FLANN for ORB (Binary)</a></li>
</ul>
</li>
<li><a href="#4-distance-metrics">4. Distance Metrics</a><ul>
<li><a href="#distance-types">Distance Types</a></li>
<li><a href="#recommended-metrics-per-descriptor">Recommended Metrics per Descriptor</a></li>
</ul>
</li>
<li><a href="#5-match-filtering">5. Match Filtering</a><ul>
<li><a href="#lowes-ratio-test">Lowe's Ratio Test</a></li>
<li><a href="#distance-based-filtering">Distance-based Filtering</a></li>
<li><a href="#symmetric-matching">Symmetric Matching</a></li>
</ul>
</li>
<li><a href="#6-homography-and-ransac">6. Homography and RANSAC</a><ul>
<li><a href="#homography-concept">Homography Concept</a></li>
<li><a href="#cv2findhomography">cv2.findHomography()</a></li>
<li><a href="#understanding-ransac">Understanding RANSAC</a></li>
</ul>
</li>
<li><a href="#7-image-stitching-basics">7. Image Stitching Basics</a><ul>
<li><a href="#simple-panorama">Simple Panorama</a></li>
<li><a href="#using-opencv-stitcher">Using OpenCV Stitcher</a></li>
</ul>
</li>
<li><a href="#8-practice-problems">8. Practice Problems</a><ul>
<li><a href="#problem-1-find-optimal-matching-parameters">Problem 1: Find Optimal Matching Parameters</a></li>
<li><a href="#problem-2-multiple-object-detection">Problem 2: Multiple Object Detection</a></li>
<li><a href="#problem-3-real-time-object-tracking">Problem 3: Real-time Object Tracking</a></li>
<li><a href="#recommended-problems">Recommended Problems</a></li>
</ul>
</li>
<li><a href="#next-steps">Next Steps</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="feature-matching">Feature Matching<a class="header-link" href="#feature-matching" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="header-link" href="#overview" title="Permanent link">&para;</a></h2>
<p>Feature matching is the process of finding and connecting identical feature points across two images. It is used in object recognition, image stitching, 3D reconstruction, object tracking, and more. In this lesson, we will learn about BFMatcher, FLANN, distance metrics, Lowe's ratio test, Homography, and RANSAC.</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-feature-matching-fundamentals">Feature Matching Fundamentals</a></li>
<li><a href="#2-bfmatcher">BFMatcher</a></li>
<li><a href="#3-flann-based-matcher">FLANN-based Matcher</a></li>
<li><a href="#4-distance-metrics">Distance Metrics</a></li>
<li><a href="#5-match-filtering">Match Filtering</a></li>
<li><a href="#6-homography-and-ransac">Homography and RANSAC</a></li>
<li><a href="#7-image-stitching-basics">Image Stitching Basics</a></li>
<li><a href="#8-practice-problems">Practice Problems</a></li>
</ol>
<hr />
<h2 id="1-feature-matching-fundamentals">1. Feature Matching Fundamentals<a class="header-link" href="#1-feature-matching-fundamentals" title="Permanent link">&para;</a></h2>
<h3 id="matching-process">Matching Process<a class="header-link" href="#matching-process" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>+---------------------------------------------------------------------+
|                     Feature Matching Pipeline                        |
+---------------------------------------------------------------------+
|                                                                      |
|   Image 1                        Image 2                             |
|   +---------+                     +---------+                        |
|   | <span class="gs">*  *</span>    |                     |   <span class="gs">*  *</span>  |                        |
|   |    <span class="gs">*  *</span> |                     | <span class="gs">*    *</span>  |                        |
|   |  <span class="gs">*      |                     |   *</span>     |                        |
|   +---------+                     +---------+                        |
|       |                               |                              |
|       v                               v                              |
|  +----------+                   +----------+                         |
|  | Feature  |                   | Feature  |                         |
|  | Detection|                   | Detection|                         |
|  +----+-----+                   +----+-----+                         |
|       |                               |                              |
|       v                               v                              |
|  +----------+                   +----------+                         |
|  |Descriptor|                   |Descriptor|                         |
|  | Compute  |                   | Compute  |                         |
|  +----+-----+                   +----+-----+                         |
|       |                               |                              |
|       +----------+-------------------+                               |
|                  v                                                   |
|           +--------------+                                           |
|           |   Matching   |                                           |
|           | (BFMatcher   |                                           |
|           |  or FLANN)   |                                           |
|           +------+-------+                                           |
|                  v                                                   |
|           +--------------+                                           |
|           | Filtering    |                                           |
|           | (Ratio Test, |                                           |
|           |  RANSAC)     |                                           |
|           +--------------+                                           |
|                                                                      |
+---------------------------------------------------------------------+
</code></pre></div>

<h3 id="dmatch-structure">DMatch Structure<a class="header-link" href="#dmatch-structure" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="c1"># DMatch attributes</span>
<span class="c1"># match.queryIdx  : Descriptor index in query (first) image</span>
<span class="c1"># match.trainIdx  : Descriptor index in train (second) image</span>
<span class="c1"># match.imgIdx    : Index of train image (when matching multiple images)</span>
<span class="c1"># match.distance  : Distance between descriptors (similarity)</span>
</code></pre></div>

<hr />
<h2 id="2-bfmatcher">2. BFMatcher<a class="header-link" href="#2-bfmatcher" title="Permanent link">&para;</a></h2>
<h3 id="concept">Concept<a class="header-link" href="#concept" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nf">BFMatcher </span><span class="p">(</span><span class="n">Brute</span><span class="o">-</span><span class="n">Force</span><span class="w"> </span><span class="n">Matcher</span><span class="p">)</span><span class="o">:</span>
<span class="n">Computes</span><span class="w"> </span><span class="n">distances</span><span class="w"> </span><span class="n">between</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">pairs</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">minimum</span><span class="w"> </span><span class="n">distance</span>

<span class="n">Advantages</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">Simple</span><span class="w"> </span><span class="n">implementation</span>
<span class="o">-</span><span class="w"> </span><span class="n">Always</span><span class="w"> </span><span class="n">guarantees</span><span class="w"> </span><span class="n">optimal</span><span class="w"> </span><span class="n">match</span>

<span class="n">Disadvantages</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="nf">O</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M</span><span class="p">)</span><span class="w"> </span><span class="nf">complexity </span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="o">:</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">descriptors</span><span class="p">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">Slow</span><span class="w"> </span><span class="kr">for</span><span class="w"> </span><span class="n">large</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="n">sets</span>

<span class="w">                </span><span class="n">Query</span><span class="w"> </span><span class="n">Descriptors</span>
<span class="w">                </span><span class="n">d1</span><span class="w">   </span><span class="n">d2</span><span class="w">   </span><span class="n">d3</span><span class="w">   </span><span class="n">d4</span>
<span class="w">            </span><span class="o">+----+----+----+----+</span>
<span class="n">Train</span><span class="w">   </span><span class="n">d1</span><span class="s">&#39; | 10 | 25 | 15 | 30 |</span>
<span class="s">Desc    d2&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="m">5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="m">35</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Each</span><span class="w"> </span><span class="n">cell</span><span class="o">:</span><span class="w"> </span><span class="n">distance</span>
<span class="w">        </span><span class="n">d3</span><span class="s">&#39; | 30 | 18 |  8 | 22 |</span>
<span class="s">            +----+----+----+----+</span>

<span class="s">Match: d1&lt;-&gt;d1&#39;</span><span class="p">(</span><span class="m">10</span><span class="p">),</span><span class="w"> </span><span class="n">d2</span><span class="o">&lt;-&gt;</span><span class="n">d2</span><span class="s">&#39;(5), d3&lt;-&gt;d3&#39;</span><span class="p">(</span><span class="m">8</span><span class="p">),</span><span class="w"> </span><span class="n">d4</span><span class="o">&lt;-&gt;</span><span class="n">d2</span><span class="s">&#39;</span><span class="err">(12)</span>
</code></pre></div>

<h3 id="cv2bfmatcher">cv2.BFMatcher<a class="header-link" href="#cv2bfmatcher" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">bf_matching_demo</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">img2_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Basic BFMatcher usage&quot;&quot;&quot;</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
    <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img2_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>

    <span class="c1"># ORB detector (binary descriptors)</span>
    <span class="n">orb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ORB_create</span><span class="p">()</span>
    <span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kp2</span><span class="p">,</span> <span class="n">des2</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Create BFMatcher (Hamming distance for binary)</span>
    <span class="n">bf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_HAMMING</span><span class="p">,</span> <span class="n">crossCheck</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Match</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">)</span>

    <span class="c1"># Sort by distance</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span>

    <span class="c1"># Draw top 30 matches</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">drawMatches</span><span class="p">(</span>
        <span class="n">img1</span><span class="p">,</span> <span class="n">kp1</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">kp2</span><span class="p">,</span>
        <span class="n">matches</span><span class="p">[:</span><span class="mi">30</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flags</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">DRAW_MATCHES_FLAGS_NOT_DRAW_SINGLE_POINTS</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total matches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Min distance: </span><span class="si">{</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">distance</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max distance: </span><span class="si">{</span><span class="n">matches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distance</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;BF Matches&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">matches</span>

<span class="n">matches</span> <span class="o">=</span> <span class="n">bf_matching_demo</span><span class="p">(</span><span class="s1">&#39;query.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;train.jpg&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="crosscheck-option">crossCheck Option<a class="header-link" href="#crosscheck-option" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">bf_crosscheck_comparison</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">img2_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compare crossCheck option&quot;&quot;&quot;</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
    <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img2_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>

    <span class="n">orb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ORB_create</span><span class="p">()</span>
    <span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kp2</span><span class="p">,</span> <span class="n">des2</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># crossCheck=False</span>
    <span class="n">bf_no_cross</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_HAMMING</span><span class="p">,</span> <span class="n">crossCheck</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">matches_no_cross</span> <span class="o">=</span> <span class="n">bf_no_cross</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">)</span>

    <span class="c1"># crossCheck=True</span>
    <span class="c1"># Both A-&gt;B and B-&gt;A must match</span>
    <span class="n">bf_cross</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_HAMMING</span><span class="p">,</span> <span class="n">crossCheck</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">matches_cross</span> <span class="o">=</span> <span class="n">bf_cross</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;crossCheck=False: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matches_no_cross</span><span class="p">)</span><span class="si">}</span><span class="s2"> matches&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;crossCheck=True:  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matches_cross</span><span class="p">)</span><span class="si">}</span><span class="s2"> matches&quot;</span><span class="p">)</span>

    <span class="c1"># crossCheck=True provides more reliable matches</span>

<span class="n">bf_crosscheck_comparison</span><span class="p">(</span><span class="s1">&#39;query.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;train.jpg&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="knnmatch">knnMatch<a class="header-link" href="#knnmatch" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">bf_knn_matching</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">img2_path</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;k-nearest neighbors matching&quot;&quot;&quot;</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
    <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img2_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>

    <span class="c1"># SIFT detector (float descriptors)</span>
    <span class="n">sift</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>
    <span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kp2</span><span class="p">,</span> <span class="n">des2</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># BFMatcher (L2 distance for float)</span>
    <span class="n">bf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_L2</span><span class="p">)</span>

    <span class="c1"># Return k nearest neighbors</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>

    <span class="c1"># k matches per query descriptor</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query descriptor count: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">des1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> matches per query&quot;</span><span class="p">)</span>

    <span class="c1"># Check first query&#39;s matches</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First query&#39;s matches:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Match </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: trainIdx=</span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">trainIdx</span><span class="si">}</span><span class="s2">, distance=</span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">distance</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">matches</span>

<span class="n">matches</span> <span class="o">=</span> <span class="n">bf_knn_matching</span><span class="p">(</span><span class="s1">&#39;query.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;train.jpg&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="3-flann-based-matcher">3. FLANN-based Matcher<a class="header-link" href="#3-flann-based-matcher" title="Permanent link">&para;</a></h2>
<h3 id="concept_1">Concept<a class="header-link" href="#concept_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>FLANN (Fast Library for Approximate Nearest Neighbors):
Library for approximate nearest neighbor search

Characteristics:
<span class="k">-</span> Faster than BFMatcher (for large datasets)
<span class="k">-</span> Approximate algorithm (not 100% accurate)
<span class="k">-</span> Uses KD-Tree, K-Means Tree, etc.

Index Types:
1. FLANN_INDEX_KDTREE (0): For float descriptors
2. FLANN_INDEX_LSH (6): For binary descriptors
</code></pre></div>

<h3 id="flann-usage">FLANN Usage<a class="header-link" href="#flann-usage" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">flann_matching_sift</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">img2_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FLANN matching (SIFT - float descriptors)&quot;&quot;&quot;</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
    <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img2_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>

    <span class="n">sift</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>
    <span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kp2</span><span class="p">,</span> <span class="n">des2</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># FLANN parameters (KD-Tree)</span>
    <span class="n">FLANN_INDEX_KDTREE</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">index_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">algorithm</span><span class="o">=</span><span class="n">FLANN_INDEX_KDTREE</span><span class="p">,</span>
        <span class="n">trees</span><span class="o">=</span><span class="mi">5</span>
    <span class="p">)</span>
    <span class="n">search_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">checks</span><span class="o">=</span><span class="mi">50</span>  <span class="c1"># Search iterations (higher = more accurate, slower)</span>
    <span class="p">)</span>

    <span class="c1"># Create FLANN matcher</span>
    <span class="n">flann</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FlannBasedMatcher</span><span class="p">(</span><span class="n">index_params</span><span class="p">,</span> <span class="n">search_params</span><span class="p">)</span>

    <span class="c1"># k-nearest neighbors matching</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">flann</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Lowe&#39;s ratio test</span>
    <span class="n">good_matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
            <span class="n">good_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total matches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Good matches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Draw results</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">drawMatches</span><span class="p">(</span>
        <span class="n">img1</span><span class="p">,</span> <span class="n">kp1</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">kp2</span><span class="p">,</span>
        <span class="n">good_matches</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flags</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">DRAW_MATCHES_FLAGS_NOT_DRAW_SINGLE_POINTS</span>
    <span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;FLANN Matches&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">good_matches</span><span class="p">,</span> <span class="n">kp1</span><span class="p">,</span> <span class="n">kp2</span>

<span class="n">matches</span><span class="p">,</span> <span class="n">kp1</span><span class="p">,</span> <span class="n">kp2</span> <span class="o">=</span> <span class="n">flann_matching_sift</span><span class="p">(</span><span class="s1">&#39;query.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;train.jpg&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="flann-for-orb-binary">FLANN for ORB (Binary)<a class="header-link" href="#flann-for-orb-binary" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">flann_matching_orb</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">img2_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FLANN matching (ORB - binary descriptors)&quot;&quot;&quot;</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
    <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img2_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>

    <span class="n">orb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ORB_create</span><span class="p">()</span>
    <span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kp2</span><span class="p">,</span> <span class="n">des2</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># FLANN parameters (LSH for binary)</span>
    <span class="n">FLANN_INDEX_LSH</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">index_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">algorithm</span><span class="o">=</span><span class="n">FLANN_INDEX_LSH</span><span class="p">,</span>
        <span class="n">table_number</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>        <span class="c1"># Number of hash tables</span>
        <span class="n">key_size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>           <span class="c1"># Key size</span>
        <span class="n">multi_probe_level</span><span class="o">=</span><span class="mi">1</span>    <span class="c1"># Multi-probe level</span>
    <span class="p">)</span>
    <span class="n">search_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">checks</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="n">flann</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FlannBasedMatcher</span><span class="p">(</span><span class="n">index_params</span><span class="p">,</span> <span class="n">search_params</span><span class="p">)</span>

    <span class="c1"># Convert descriptors to float32 (FLANN requirement)</span>
    <span class="n">des1</span> <span class="o">=</span> <span class="n">des1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">des2</span> <span class="o">=</span> <span class="n">des2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">matches</span> <span class="o">=</span> <span class="n">flann</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Ratio test</span>
    <span class="n">good_matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">pair</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
                <span class="n">good_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">drawMatches</span><span class="p">(</span>
        <span class="n">img1</span><span class="p">,</span> <span class="n">kp1</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">kp2</span><span class="p">,</span>
        <span class="n">good_matches</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flags</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">DRAW_MATCHES_FLAGS_NOT_DRAW_SINGLE_POINTS</span>
    <span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;FLANN ORB Matches&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">good_matches</span>

<span class="n">flann_matching_orb</span><span class="p">(</span><span class="s1">&#39;query.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;train.jpg&#39;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="4-distance-metrics">4. Distance Metrics<a class="header-link" href="#4-distance-metrics" title="Permanent link">&para;</a></h2>
<h3 id="distance-types">Distance Types<a class="header-link" href="#distance-types" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="o">+--------------------------------------------------------------------+</span>
<span class="o">|</span><span class="w">                        </span><span class="n">Distance</span><span class="w"> </span><span class="n">Metric</span><span class="w"> </span><span class="n">Comparison</span><span class="w">                   </span><span class="o">|</span>
<span class="o">+--------------------------------------------------------------------+</span>
<span class="o">|</span><span class="w">                                                                     </span><span class="o">|</span>
<span class="o">|</span><span class="w">  </span><span class="n">cv2</span><span class="p">.</span><span class="n">NORM_L1</span><span class="w"> </span><span class="p">(</span><span class="n">Manhattan</span><span class="w"> </span><span class="n">Distance</span><span class="p">)</span><span class="w">                                  </span><span class="o">|</span>
<span class="o">|</span><span class="w">  </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="o">|</span><span class="n">a_i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b_i</span><span class="o">|</span><span class="w">                                                 </span><span class="o">|</span>
<span class="o">|</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Rarely</span><span class="w"> </span><span class="n">used</span><span class="w">                                                     </span><span class="o">|</span>
<span class="o">|</span><span class="w">                                                                     </span><span class="o">|</span>
<span class="o">|</span><span class="w">  </span><span class="n">cv2</span><span class="p">.</span><span class="n">NORM_L2</span><span class="w"> </span><span class="p">(</span><span class="n">Euclidean</span><span class="w"> </span><span class="n">Distance</span><span class="p">)</span><span class="w">                                  </span><span class="o">|</span>
<span class="o">|</span><span class="w">  </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">a_i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b_i</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="w">                                        </span><span class="o">|</span>
<span class="o">|</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">SIFT</span><span class="p">,</span><span class="w"> </span><span class="n">SURF</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="p">.</span><span class="w"> </span><span class="n">float</span><span class="w"> </span><span class="n">descriptors</span><span class="w">                         </span><span class="o">|</span>
<span class="o">|</span><span class="w">                                                                     </span><span class="o">|</span>
<span class="o">|</span><span class="w">  </span><span class="n">cv2</span><span class="p">.</span><span class="n">NORM_HAMMING</span><span class="w">                                                   </span><span class="o">|</span>
<span class="o">|</span><span class="w">  </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">a_i</span><span class="w"> </span><span class="n">XOR</span><span class="w"> </span><span class="n">b_i</span><span class="p">)</span><span class="w">                                              </span><span class="o">|</span>
<span class="o">|</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">ORB</span><span class="p">,</span><span class="w"> </span><span class="n">BRIEF</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="p">.</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="n">descriptors</span><span class="w"> </span><span class="p">(</span><span class="mi">256</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">             </span><span class="o">|</span>
<span class="o">|</span><span class="w">                                                                     </span><span class="o">|</span>
<span class="o">|</span><span class="w">  </span><span class="n">cv2</span><span class="p">.</span><span class="n">NORM_HAMMING2</span><span class="w">                                                  </span><span class="o">|</span>
<span class="o">|</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">ORB</span><span class="w"> </span><span class="p">(</span><span class="n">WTA_K</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w">                                            </span><span class="o">|</span>
<span class="o">|</span><span class="w">                                                                     </span><span class="o">|</span>
<span class="o">+--------------------------------------------------------------------+</span>
</code></pre></div>

<h3 id="recommended-metrics-per-descriptor">Recommended Metrics per Descriptor<a class="header-link" href="#recommended-metrics-per-descriptor" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="c1"># Recommended distance metric per descriptor type</span>
<span class="n">descriptor_distance</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;SIFT&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_L2</span><span class="p">,</span>
    <span class="s1">&#39;SURF&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_L2</span><span class="p">,</span>
    <span class="s1">&#39;KAZE&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_L2</span><span class="p">,</span>
    <span class="s1">&#39;ORB&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_HAMMING</span><span class="p">,</span>
    <span class="s1">&#39;BRISK&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_HAMMING</span><span class="p">,</span>
    <span class="s1">&#39;AKAZE&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_HAMMING</span><span class="p">,</span>  <span class="c1"># Binary mode</span>
    <span class="s1">&#39;BRIEF&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_HAMMING</span><span class="p">,</span>
    <span class="s1">&#39;FREAK&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_HAMMING</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_matcher</span><span class="p">(</span><span class="n">descriptor_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return matcher for descriptor type&quot;&quot;&quot;</span>
    <span class="n">norm_type</span> <span class="o">=</span> <span class="n">descriptor_distance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">descriptor_type</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_L2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">(</span><span class="n">norm_type</span><span class="p">,</span> <span class="n">crossCheck</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="5-match-filtering">5. Match Filtering<a class="header-link" href="#5-match-filtering" title="Permanent link">&para;</a></h2>
<h3 id="lowes-ratio-test">Lowe's Ratio Test<a class="header-link" href="#lowes-ratio-test" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Lowe</span><span class="s">&#39;s Ratio Test:</span>
<span class="s">Filter by ratio of distances between nearest and second-nearest neighbor</span>

<span class="s">Principle:</span>
<span class="s">Good match -&gt; Nearest neighbor is clearly closer (small ratio)</span>
<span class="s">Bad match -&gt; Multiple candidates at similar distances (large ratio)</span>

<span class="s">distance(best) / distance(second_best) &lt; threshold</span>

<span class="s">Recommended threshold: 0.7 ~ 0.8</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">lowe_ratio_test</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">img2_path</span><span class="p">,</span> <span class="n">ratio_thresh</span><span class="o">=</span><span class="mf">0.75</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply Lowe&#39;s ratio test&quot;&quot;&quot;</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
    <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img2_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>

    <span class="n">sift</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>
    <span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kp2</span><span class="p">,</span> <span class="n">des2</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">bf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">()</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Ratio test</span>
    <span class="n">good_matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">/</span> <span class="n">n</span><span class="o">.</span><span class="n">distance</span>
        <span class="k">if</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="n">ratio_thresh</span><span class="p">:</span>
            <span class="n">good_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total matches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ratio test passed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filter ratio: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

    <span class="c1"># Match quality analysis</span>
    <span class="k">if</span> <span class="n">good_matches</span><span class="p">:</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good_matches</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average distance: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distance std dev: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">good_matches</span><span class="p">,</span> <span class="n">kp1</span><span class="p">,</span> <span class="n">kp2</span>

<span class="n">matches</span><span class="p">,</span> <span class="n">kp1</span><span class="p">,</span> <span class="n">kp2</span> <span class="o">=</span> <span class="n">lowe_ratio_test</span><span class="p">(</span><span class="s1">&#39;query.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;train.jpg&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="distance-based-filtering">Distance-based Filtering<a class="header-link" href="#distance-based-filtering" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">distance_based_filtering</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">threshold_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Distance-based match filtering&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">distances</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]</span>
    <span class="n">mean_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
    <span class="n">std_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>

    <span class="c1"># Keep only those below mean + k*std</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">mean_dist</span> <span class="o">+</span> <span class="n">threshold_factor</span> <span class="o">*</span> <span class="n">std_dist</span>

    <span class="n">good_matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distance mean: </span><span class="si">{</span><span class="n">mean_dist</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distance std dev: </span><span class="si">{</span><span class="n">std_dist</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Threshold: </span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtering result: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">good_matches</span>
</code></pre></div>

<h3 id="symmetric-matching">Symmetric Matching<a class="header-link" href="#symmetric-matching" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">symmetric_matching</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_L2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Symmetric matching (verify both A-&gt;B and B-&gt;A)&quot;&quot;&quot;</span>
    <span class="n">bf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">(</span><span class="n">norm_type</span><span class="p">)</span>

    <span class="c1"># A -&gt; B matching</span>
    <span class="n">matches_ab</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># B -&gt; A matching</span>
    <span class="n">matches_ba</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des2</span><span class="p">,</span> <span class="n">des1</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Select only bidirectionally consistent matches</span>
    <span class="n">symmetric</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m_ab</span> <span class="ow">in</span> <span class="n">matches_ab</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_ab</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">query_idx</span> <span class="o">=</span> <span class="n">m_ab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">queryIdx</span>
        <span class="n">train_idx</span> <span class="o">=</span> <span class="n">m_ab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trainIdx</span>

        <span class="c1"># Check reverse direction in B-&gt;A</span>
        <span class="k">for</span> <span class="n">m_ba</span> <span class="ow">in</span> <span class="n">matches_ba</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_ba</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">m_ba</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">queryIdx</span> <span class="o">==</span> <span class="n">train_idx</span> <span class="ow">and</span> <span class="n">m_ba</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trainIdx</span> <span class="o">==</span> <span class="n">query_idx</span><span class="p">:</span>
                <span class="n">symmetric</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_ab</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="n">symmetric</span>
</code></pre></div>

<hr />
<h2 id="6-homography-and-ransac">6. Homography and RANSAC<a class="header-link" href="#6-homography-and-ransac" title="Permanent link">&para;</a></h2>
<h3 id="homography-concept">Homography Concept<a class="header-link" href="#homography-concept" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Homography</span><span class="o">:</span>
<span class="mi">3</span><span class="n">x3</span><span class="w"> </span><span class="n">matrix</span><span class="w"> </span><span class="n">representing</span><span class="w"> </span><span class="n">perspective</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="n">between</span><span class="w"> </span><span class="n">planes</span>

<span class="o">+</span><span class="w">     </span><span class="o">+</span><span class="w">   </span><span class="o">+</span><span class="w">           </span><span class="o">+</span><span class="w"> </span><span class="o">+</span><span class="w">   </span><span class="o">+</span>
<span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="s1">&#39;  |   | h11 h12 h13 | | x |</span>
<span class="s1">| y&#39;</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">h21</span><span class="w"> </span><span class="n">h22</span><span class="w"> </span><span class="n">h23</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w">  </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">h31</span><span class="w"> </span><span class="n">h32</span><span class="w"> </span><span class="n">h33</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span>
<span class="o">+</span><span class="w">     </span><span class="o">+</span><span class="w">   </span><span class="o">+</span><span class="w">           </span><span class="o">+</span><span class="w"> </span><span class="o">+</span><span class="w">   </span><span class="o">+</span>

<span class="n">x</span><span class="s1">&#39; = (h11*x + h12*y + h13) / (h31*x + h32*y + h33)</span>
<span class="s1">y&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">h21</span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h22</span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h23</span><span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">(</span><span class="n">h31</span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h32</span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h33</span><span class="o">)</span>

<span class="n">Applications</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="n">estimation</span>
<span class="o">-</span><span class="w"> </span><span class="n">Image</span><span class="w"> </span><span class="n">registration</span>
<span class="o">-</span><span class="w"> </span><span class="n">Panorama</span><span class="w"> </span><span class="n">stitching</span>
<span class="o">-</span><span class="w"> </span><span class="n">AR</span><span class="w"> </span><span class="n">marker</span><span class="w"> </span><span class="n">detection</span>
</code></pre></div>

<h3 id="cv2findhomography">cv2.findHomography()<a class="header-link" href="#cv2findhomography" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">find_object_homography</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">img2_path</span><span class="p">,</span> <span class="n">min_matches</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find object using homography&quot;&quot;&quot;</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img1_path</span><span class="p">)</span>  <span class="c1"># Query (object to find)</span>
    <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img2_path</span><span class="p">)</span>  <span class="c1"># Target (scene)</span>

    <span class="n">gray1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">gray2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

    <span class="c1"># SIFT features and matching</span>
    <span class="n">sift</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>
    <span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">gray1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kp2</span><span class="p">,</span> <span class="n">des2</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">gray2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">bf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">()</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Ratio test</span>
    <span class="n">good_matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
            <span class="n">good_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Good matches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_matches</span><span class="p">:</span>
        <span class="c1"># Extract matched point coordinates</span>
        <span class="n">src_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp1</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">queryIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good_matches</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">dst_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp2</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">trainIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good_matches</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Compute homography (RANSAC)</span>
        <span class="n">H</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findHomography</span><span class="p">(</span><span class="n">src_pts</span><span class="p">,</span> <span class="n">dst_pts</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RANSAC</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">H</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Transform query image corners</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">gray1</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span>
            <span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">transformed_corners</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">corners</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>

            <span class="c1"># Draw object location on target image</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">img2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">polylines</span><span class="p">(</span>
                <span class="n">result</span><span class="p">,</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">transformed_corners</span><span class="p">)],</span>
                <span class="kc">True</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="mi">3</span><span class="p">,</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span>
            <span class="p">)</span>

            <span class="c1"># Match visualization</span>
            <span class="n">matches_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">draw_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">matchColor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">singlePointColor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">matchesMask</span><span class="o">=</span><span class="n">matches_mask</span><span class="p">,</span>
                <span class="n">flags</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>

            <span class="n">match_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">drawMatches</span><span class="p">(</span>
                <span class="n">img1</span><span class="p">,</span> <span class="n">kp1</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">kp2</span><span class="p">,</span>
                <span class="n">good_matches</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">draw_params</span>
            <span class="p">)</span>

            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Object Detection&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Matches&#39;</span><span class="p">,</span> <span class="n">match_img</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Inlier ratio</span>
            <span class="n">inliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inliers: </span><span class="si">{</span><span class="n">inliers</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inlier ratio: </span><span class="si">{</span><span class="n">inliers</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">H</span><span class="p">,</span> <span class="n">transformed_corners</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Insufficient matches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">min_matches</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

<span class="n">H</span><span class="p">,</span> <span class="n">corners</span> <span class="o">=</span> <span class="n">find_object_homography</span><span class="p">(</span><span class="s1">&#39;book_cover.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;scene.jpg&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="understanding-ransac">Understanding RANSAC<a class="header-link" href="#understanding-ransac" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nf">RANSAC </span><span class="p">(</span><span class="n">RANdom</span><span class="w"> </span><span class="n">SAmple</span><span class="w"> </span><span class="n">Consensus</span><span class="p">)</span><span class="o">:</span>
<span class="n">Model</span><span class="w"> </span><span class="n">estimation</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">outliers</span>

<span class="n">Algorithm</span><span class="o">:</span>
<span class="m">1</span><span class="n">.</span><span class="w"> </span><span class="n">Randomly</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">minimum</span><span class="w"> </span><span class="nf">samples </span><span class="p">(</span><span class="n">homography</span><span class="o">:</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="n">points</span><span class="p">)</span>
<span class="m">2</span><span class="n">.</span><span class="w"> </span><span class="n">Compute</span><span class="w"> </span><span class="n">model</span>
<span class="m">3</span><span class="n">.</span><span class="w"> </span><span class="n">Compute</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="kr">for</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">points</span>
<span class="m">4</span><span class="n">.</span><span class="w"> </span><span class="n">Count</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="nf">threshold </span><span class="p">(</span><span class="n">inliers</span><span class="p">)</span>
<span class="m">5</span><span class="n">.</span><span class="w"> </span><span class="n">Repeat</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">most</span><span class="w"> </span><span class="n">inliers</span>
<span class="m">6</span><span class="n">.</span><span class="w"> </span><span class="n">Recompute</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="nf">inliers </span><span class="p">(</span><span class="n">optional</span><span class="p">)</span>

<span class="o">+----------------------------------------+</span>
<span class="o">|</span><span class="w">  </span><span class="o">*</span><span class="w">  </span><span class="o">*</span><span class="w">  </span><span class="o">*</span><span class="w">  </span><span class="o">*</span><span class="w">  </span><span class="o">*</span><span class="w">                         </span><span class="o">|</span>
<span class="o">|</span><span class="w">     </span><span class="o">*</span><span class="w">  </span><span class="o">*</span><span class="w">  </span><span class="o">*</span><span class="w">        </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">Inliers </span><span class="p">(</span><span class="n">near</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w">        </span><span class="o">*</span><span class="w">  </span><span class="o">*</span><span class="w">  </span><span class="o">*</span><span class="w">                         </span><span class="o">|</span>
<span class="o">|</span><span class="w">  </span><span class="n">x</span><span class="w">                                     </span><span class="o">|</span>
<span class="o">|</span><span class="w">           </span><span class="n">x</span><span class="w">        </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Outliers</span><span class="w">         </span><span class="o">|</span>
<span class="o">|</span><span class="w">     </span><span class="n">x</span><span class="w">          </span><span class="n">x</span><span class="w">                       </span><span class="o">|</span>
<span class="o">+----------------------------------------+</span>

<span class="n">findHomography</span><span class="w"> </span><span class="n">parameters</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">cv2.RANSAC</span><span class="o">:</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">RANSAC</span>
<span class="o">-</span><span class="w"> </span><span class="n">ransacReprojThreshold</span><span class="o">:</span><span class="w"> </span><span class="n">Inlier</span><span class="w"> </span><span class="nf">threshold </span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">homography_methods_comparison</span><span class="p">(</span><span class="n">src_pts</span><span class="p">,</span> <span class="n">dst_pts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compare various homography computation methods&quot;&quot;&quot;</span>

    <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Regular (LS)&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">RANSAC</span><span class="p">,</span> <span class="s1">&#39;RANSAC&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">LMEDS</span><span class="p">,</span> <span class="s1">&#39;Least-Median&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">RHO</span><span class="p">,</span> <span class="s1">&#39;PROSAC&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">H</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findHomography</span><span class="p">(</span>
                <span class="n">src_pts</span><span class="p">,</span> <span class="n">dst_pts</span><span class="p">,</span>
                <span class="n">method</span><span class="p">,</span>
                <span class="n">ransacReprojThreshold</span><span class="o">=</span><span class="mf">5.0</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">H</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">inliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">inliers</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">src_pts</span><span class="p">)</span><span class="si">}</span><span class="s2"> inliers&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: Failed&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: Error - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="7-image-stitching-basics">7. Image Stitching Basics<a class="header-link" href="#7-image-stitching-basics" title="Permanent link">&para;</a></h2>
<h3 id="simple-panorama">Simple Panorama<a class="header-link" href="#simple-panorama" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">simple_panorama</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">img2_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple panorama stitching&quot;&quot;&quot;</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img1_path</span><span class="p">)</span>  <span class="c1"># Left image</span>
    <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img2_path</span><span class="p">)</span>  <span class="c1"># Right image</span>

    <span class="n">gray1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">gray2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

    <span class="c1"># Feature detection and matching</span>
    <span class="n">sift</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>
    <span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">gray1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kp2</span><span class="p">,</span> <span class="n">des2</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">gray2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">bf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">()</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Ratio test</span>
    <span class="n">good</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
            <span class="n">good</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not enough matches.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Compute homography</span>
    <span class="n">src_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp1</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">queryIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">dst_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp2</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">trainIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">H</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findHomography</span><span class="p">(</span><span class="n">src_pts</span><span class="p">,</span> <span class="n">dst_pts</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RANSAC</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">H</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Homography computation failed&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Image warping</span>
    <span class="n">h1</span><span class="p">,</span> <span class="n">w1</span> <span class="o">=</span> <span class="n">img1</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">h2</span><span class="p">,</span> <span class="n">w2</span> <span class="o">=</span> <span class="n">img2</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Compute result image size</span>
    <span class="n">corners1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="n">h1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">h1</span><span class="p">]])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">corners1_transformed</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">corners1</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>

    <span class="n">corners2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">w2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">w2</span><span class="p">,</span> <span class="n">h2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">h2</span><span class="p">]])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">all_corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">corners1_transformed</span><span class="p">,</span> <span class="n">corners2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">all_corners</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">all_corners</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>

    <span class="c1"># Translation transform</span>
    <span class="n">translation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">x_min</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">y_min</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Warp image 1</span>
    <span class="n">result_width</span> <span class="o">=</span> <span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span>
    <span class="n">result_height</span> <span class="o">=</span> <span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span>

    <span class="n">warped1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpPerspective</span><span class="p">(</span>
        <span class="n">img1</span><span class="p">,</span>
        <span class="n">translation</span> <span class="o">@</span> <span class="n">H</span><span class="p">,</span>
        <span class="p">(</span><span class="n">result_width</span><span class="p">,</span> <span class="n">result_height</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Copy image 2</span>
    <span class="n">warped1</span><span class="p">[</span><span class="o">-</span><span class="n">y_min</span><span class="p">:</span><span class="o">-</span><span class="n">y_min</span><span class="o">+</span><span class="n">h2</span><span class="p">,</span> <span class="o">-</span><span class="n">x_min</span><span class="p">:</span><span class="o">-</span><span class="n">x_min</span><span class="o">+</span><span class="n">w2</span><span class="p">]</span> <span class="o">=</span> <span class="n">img2</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Panorama&#39;</span><span class="p">,</span> <span class="n">warped1</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">warped1</span>

<span class="n">panorama</span> <span class="o">=</span> <span class="n">simple_panorama</span><span class="p">(</span><span class="s1">&#39;left.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;right.jpg&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="using-opencv-stitcher">Using OpenCV Stitcher<a class="header-link" href="#using-opencv-stitcher" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">opencv_stitcher</span><span class="p">(</span><span class="n">image_paths</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use OpenCV Stitcher class&quot;&quot;&quot;</span>
    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">image_paths</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;At least 2 images required.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Create Stitcher</span>
    <span class="n">stitcher</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Stitcher_create</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">Stitcher_PANORAMA</span><span class="p">)</span>
    <span class="c1"># Or: cv2.Stitcher_SCANS (for document scans)</span>

    <span class="c1"># Perform stitching</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">stitcher</span><span class="o">.</span><span class="n">stitch</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Stitcher_OK</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stitching successful!&quot;</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Stitched&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Stitcher_ERR_NEED_MORE_IMGS</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Need more images.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Stitcher_ERR_HOMOGRAPHY_EST_FAIL</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Homography estimation failed&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Stitcher_ERR_CAMERA_PARAMS_ADJUST_FAIL</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Camera parameters adjustment failed&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># Usage example</span>
<span class="n">image_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pano1.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;pano2.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;pano3.jpg&#39;</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">opencv_stitcher</span><span class="p">(</span><span class="n">image_files</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="8-practice-problems">8. Practice Problems<a class="header-link" href="#8-practice-problems" title="Permanent link">&para;</a></h2>
<h3 id="problem-1-find-optimal-matching-parameters">Problem 1: Find Optimal Matching Parameters<a class="header-link" href="#problem-1-find-optimal-matching-parameters" title="Permanent link">&para;</a></h3>
<p>Test various ratio threshold values to find the optimal value.</p>
<details>
<summary>Solution Code</summary>


<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">find_optimal_ratio</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">img2_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find optimal ratio threshold&quot;&quot;&quot;</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img1_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
    <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img2_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>

    <span class="n">sift</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>
    <span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kp2</span><span class="p">,</span> <span class="n">des2</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">bf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">()</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">ratios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">ratios</span><span class="p">:</span>
        <span class="n">good</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">matches</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">ratio</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">]</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="p">))</span>

    <span class="c1"># Graph</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ratios</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="s1">&#39;b-o&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ratio Threshold&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of Matches&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Ratio Threshold vs Match Count&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Gradient change analysis</span>
    <span class="n">gradients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="n">optimal_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gradients</span><span class="p">))</span>
    <span class="n">optimal_ratio</span> <span class="o">=</span> <span class="n">ratios</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recommended ratio threshold: </span><span class="si">{</span><span class="n">optimal_ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">optimal_ratio</span>

<span class="n">optimal</span> <span class="o">=</span> <span class="n">find_optimal_ratio</span><span class="p">(</span><span class="s1">&#39;query.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;train.jpg&#39;</span><span class="p">)</span>
</code></pre></div>



</details>

<h3 id="problem-2-multiple-object-detection">Problem 2: Multiple Object Detection<a class="header-link" href="#problem-2-multiple-object-detection" title="Permanent link">&para;</a></h3>
<p>Detect multiple instances of the same object in a scene.</p>
<details>
<summary>Solution Code</summary>


<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">detect_multiple_objects</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="n">scene_path</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detect multiple identical objects&quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">template_path</span><span class="p">)</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">scene_path</span><span class="p">)</span>

    <span class="n">gray_t</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">gray_s</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

    <span class="n">sift</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>
    <span class="n">kp_t</span><span class="p">,</span> <span class="n">des_t</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">gray_t</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kp_s</span><span class="p">,</span> <span class="n">des_s</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">gray_s</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">bf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">()</span>
    <span class="n">all_matches</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des_t</span><span class="p">,</span> <span class="n">des_s</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Ratio test</span>
    <span class="n">good_matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">all_matches</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
            <span class="n">good_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Insufficient matches&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Clustering to find multiple instances</span>
    <span class="n">scene_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">kp_s</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">trainIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good_matches</span><span class="p">])</span>

    <span class="c1"># K-means clustering</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span> <span class="o">+</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_MAX_ITER</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span> <span class="o">//</span> <span class="n">threshold</span><span class="p">)</span>  <span class="c1"># Max 5 objects</span>

    <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">centers</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">kmeans</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">scene_pts</span><span class="p">),</span>
        <span class="n">k</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">criteria</span><span class="p">,</span>
        <span class="mi">10</span><span class="p">,</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">KMEANS_RANDOM_CENTERS</span>
    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">detected</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="n">cluster_mask</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">==</span> <span class="n">cluster_id</span>
        <span class="n">cluster_matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">is_in</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">good_matches</span><span class="p">,</span> <span class="n">cluster_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_in</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_matches</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">threshold</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Compute homography per cluster</span>
            <span class="n">src_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp_t</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">queryIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cluster_matches</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">dst_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp_s</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">trainIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cluster_matches</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">H</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findHomography</span><span class="p">(</span><span class="n">src_pts</span><span class="p">,</span> <span class="n">dst_pts</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RANSAC</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">H</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">gray_t</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">]])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">transformed</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">corners</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>

                <span class="n">cv2</span><span class="o">.</span><span class="n">polylines</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">transformed</span><span class="p">)],</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">detected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transformed</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Objects detected: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">detected</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Multiple Objects&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">detected</span>

<span class="n">detect_multiple_objects</span><span class="p">(</span><span class="s1">&#39;coin.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;coins.jpg&#39;</span><span class="p">)</span>
</code></pre></div>



</details>

<h3 id="problem-3-real-time-object-tracking">Problem 3: Real-time Object Tracking<a class="header-link" href="#problem-3-real-time-object-tracking" title="Permanent link">&para;</a></h3>
<p>Track a template object in real-time from webcam.</p>
<details>
<summary>Solution Code</summary>


<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">realtime_object_tracking</span><span class="p">(</span><span class="n">template_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Real-time object tracking&quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Use ORB (fast)</span>
    <span class="n">orb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ORB_create</span><span class="p">(</span><span class="n">nfeatures</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">kp_t</span><span class="p">,</span> <span class="n">des_t</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">bf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_HAMMING</span><span class="p">,</span> <span class="n">crossCheck</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">kp_f</span><span class="p">,</span> <span class="n">des_f</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">des_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">des_f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des_t</span><span class="p">,</span> <span class="n">des_f</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Ratio test</span>
            <span class="n">good</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">pair</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
                        <span class="n">good</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">src_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp_t</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">queryIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">dst_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp_f</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">trainIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                <span class="n">H</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findHomography</span><span class="p">(</span><span class="n">src_pts</span><span class="p">,</span> <span class="n">dst_pts</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RANSAC</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">H</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">]])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">transformed</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">corners</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">polylines</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">transformed</span><span class="p">)],</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

                    <span class="c1"># Display match count</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Matches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                                <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Tracking&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>

<span class="c1"># realtime_object_tracking(&#39;logo.jpg&#39;)</span>
</code></pre></div>



</details>

<h3 id="recommended-problems">Recommended Problems<a class="header-link" href="#recommended-problems" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Difficulty</th>
<th>Topic</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>*</td>
<td>Basic Matching</td>
<td>Feature matching between two images</td>
</tr>
<tr>
<td>**</td>
<td>Filtering</td>
<td>Ratio test, distance filtering</td>
</tr>
<tr>
<td>**</td>
<td>Object Detection</td>
<td>Find object using homography</td>
</tr>
<tr>
<td>***</td>
<td>Panorama</td>
<td>Stitch 2+ images</td>
</tr>
<tr>
<td>***</td>
<td>Real-time Tracking</td>
<td>Track object from webcam</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="next-steps">Next Steps<a class="header-link" href="#next-steps" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="./15_Object_Detection_Basics.md">15_Object_Detection_Basics.md</a> - Template Matching, Haar Cascade, HOG+SVM</li>
</ul>
<hr />
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://docs.opencv.org/4.x/dc/dc3/tutorial_py_matcher.html">OpenCV Feature Matching</a></li>
<li><a href="https://docs.opencv.org/4.x/d1/de0/tutorial_py_feature_homography.html">Homography Tutorial</a></li>
<li><a href="https://docs.opencv.org/4.x/d8/d19/tutorial_stitcher.html">Image Stitching</a></li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Computer_Vision/13_Feature_Detection.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Feature Detection</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Computer_Vision/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Computer_Vision/15_Object_Detection_Basics.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Object Detection Basics</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">‚Üë</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}