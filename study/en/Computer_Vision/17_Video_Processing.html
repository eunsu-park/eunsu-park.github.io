{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Processing - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">üíª</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        ÌïúÍµ≠Ïñ¥
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">‚òÄÔ∏è</span>
                    <span class="theme-icon dark">üåô</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Computer_Vision/">Computer Vision</a>
    <span class="separator">/</span>
    <span class="current">Video Processing</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Video Processing</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Computer_Vision/16_Face_Detection.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Face Detection and Recognition</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Computer_Vision/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Computer_Vision/18_Camera_Calibration.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Camera Calibration</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-videocapture-files-and-cameras">1. VideoCapture: Files and Cameras</a><ul>
<li><a href="#understanding-video-structure">Understanding Video Structure</a></li>
<li><a href="#reading-video-files">Reading Video Files</a></li>
<li><a href="#camera-input">Camera Input</a></li>
<li><a href="#key-videocapture-properties">Key VideoCapture Properties</a></li>
</ul>
</li>
<li><a href="#2-videowriter-saving-video">2. VideoWriter: Saving Video</a><ul>
<li><a href="#basic-video-saving">Basic Video Saving</a></li>
<li><a href="#major-codecs">Major Codecs</a></li>
<li><a href="#processing-and-saving-video">Processing and Saving Video</a></li>
</ul>
</li>
<li><a href="#3-frame-by-frame-processing">3. Frame-by-frame Processing</a><ul>
<li><a href="#frame-processing-pipeline">Frame Processing Pipeline</a></li>
<li><a href="#multi-processing-example">Multi-processing Example</a></li>
<li><a href="#frame-skipping-and-buffering">Frame Skipping and Buffering</a></li>
</ul>
</li>
<li><a href="#4-fps-calculation">4. FPS Calculation</a><ul>
<li><a href="#fps-measurement-method">FPS Measurement Method</a></li>
<li><a href="#processing-time-analysis">Processing Time Analysis</a></li>
</ul>
</li>
<li><a href="#5-background-subtraction-mog2-knn">5. Background Subtraction (MOG2, KNN)</a><ul>
<li><a href="#background-subtraction-principle">Background Subtraction Principle</a></li>
<li><a href="#mog2-mixture-of-gaussians">MOG2 (Mixture of Gaussians)</a></li>
<li><a href="#knn-background-subtraction">KNN Background Subtraction</a></li>
<li><a href="#mog2-vs-knn-comparison">MOG2 vs KNN Comparison</a></li>
</ul>
</li>
<li><a href="#6-optical-flow">6. Optical Flow</a><ul>
<li><a href="#optical-flow-concept">Optical Flow Concept</a></li>
<li><a href="#lucas-kanade-optical-flow">Lucas-Kanade Optical Flow</a></li>
<li><a href="#farneback-dense-optical-flow">Farneback Dense Optical Flow</a></li>
</ul>
</li>
<li><a href="#7-object-tracking">7. Object Tracking</a><ul>
<li><a href="#opencv-built-in-trackers">OpenCV Built-in Trackers</a></li>
<li><a href="#multi-object-tracking">Multi-object Tracking</a></li>
<li><a href="#background-subtraction-tracking-combined">Background Subtraction + Tracking Combined</a></li>
</ul>
</li>
<li><a href="#8-practice-problems">8. Practice Problems</a><ul>
<li><a href="#problem-1-video-player">Problem 1: Video Player</a></li>
<li><a href="#problem-2-motion-heatmap">Problem 2: Motion Heatmap</a></li>
<li><a href="#problem-3-speed-measurement">Problem 3: Speed Measurement</a></li>
<li><a href="#problem-4-vehicle-counter">Problem 4: Vehicle Counter</a></li>
<li><a href="#problem-5-gesture-recognition">Problem 5: Gesture Recognition</a></li>
</ul>
</li>
<li><a href="#next-steps">Next Steps</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="video-processing">Video Processing<a class="header-link" href="#video-processing" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="header-link" href="#overview" title="Permanent link">&para;</a></h2>
<p>Video is a sequence of continuous image frames. We will learn to process video files and camera streams using OpenCV, and explore motion analysis methods using background subtraction and optical flow.</p>
<p><strong>Difficulty</strong>: ***</p>
<p><strong>Prerequisites</strong>: Basic image operations, filtering, object detection</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-videocapture-files-and-cameras">VideoCapture: Files and Cameras</a></li>
<li><a href="#2-videowriter-saving-video">VideoWriter: Saving Video</a></li>
<li><a href="#3-frame-by-frame-processing">Frame-by-frame Processing</a></li>
<li><a href="#4-fps-calculation">FPS Calculation</a></li>
<li><a href="#5-background-subtraction-mog2-knn">Background Subtraction (MOG2, KNN)</a></li>
<li><a href="#6-optical-flow">Optical Flow</a></li>
<li><a href="#7-object-tracking">Object Tracking</a></li>
<li><a href="#8-practice-problems">Practice Problems</a></li>
</ol>
<hr />
<h2 id="1-videocapture-files-and-cameras">1. VideoCapture: Files and Cameras<a class="header-link" href="#1-videocapture-files-and-cameras" title="Permanent link">&para;</a></h2>
<h3 id="understanding-video-structure">Understanding Video Structure<a class="header-link" href="#understanding-video-structure" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Video</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sequence</span><span class="w"> </span><span class="kr">of</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="n">frames</span>

<span class="n">Time</span><span class="w"> </span><span class="o">------------------------------------------&gt;</span>
<span class="w">    </span><span class="o">+-----++-----++-----++-----++-----+</span>
<span class="w">    </span><span class="o">|</span><span class="n">Frame</span><span class="o">||</span><span class="n">Frame</span><span class="o">||</span><span class="n">Frame</span><span class="o">||</span><span class="n">Frame</span><span class="o">||</span><span class="n">Frame</span><span class="o">|</span><span class="w"> </span><span class="p">...</span>
<span class="w">    </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w">  </span><span class="o">||</span><span class="w">  </span><span class="mi">2</span><span class="w">  </span><span class="o">||</span><span class="w">  </span><span class="mi">3</span><span class="w">  </span><span class="o">||</span><span class="w">  </span><span class="mi">4</span><span class="w">  </span><span class="o">||</span><span class="w">  </span><span class="mi">5</span><span class="w">  </span><span class="o">|</span>
<span class="w">    </span><span class="o">+-----++-----++-----++-----++-----+</span>

<span class="n">FPS</span><span class="w"> </span><span class="p">(</span><span class="n">Frames</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Second</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="kr">of</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">second</span>
<span class="o">-</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="n">FPS</span><span class="o">:</span><span class="w"> </span><span class="n">Movie</span><span class="w"> </span><span class="n">standard</span>
<span class="o">-</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="n">FPS</span><span class="o">:</span><span class="w"> </span><span class="n">General</span><span class="w"> </span><span class="n">video</span>
<span class="o">-</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">FPS</span><span class="o">:</span><span class="w"> </span><span class="n">Gaming</span><span class="p">,</span><span class="w"> </span><span class="n">sports</span>
<span class="o">-</span><span class="w"> </span><span class="mi">120</span><span class="o">+</span><span class="w"> </span><span class="n">FPS</span><span class="o">:</span><span class="w"> </span><span class="n">Slow</span><span class="w"> </span><span class="n">motion</span>

<span class="n">Resolution</span><span class="o">:</span><span class="w"> </span><span class="n">Size</span><span class="w"> </span><span class="kr">of</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">frame</span>
<span class="o">-</span><span class="w"> </span><span class="mi">640</span><span class="n">x480</span><span class="o">:</span><span class="w"> </span><span class="n">VGA</span>
<span class="o">-</span><span class="w"> </span><span class="mi">1280</span><span class="n">x720</span><span class="o">:</span><span class="w"> </span><span class="n">HD</span><span class="w"> </span><span class="p">(</span><span class="mi">720</span><span class="n">p</span><span class="p">)</span>
<span class="o">-</span><span class="w"> </span><span class="mi">1920</span><span class="n">x1080</span><span class="o">:</span><span class="w"> </span><span class="kr">Full</span><span class="w"> </span><span class="n">HD</span><span class="w"> </span><span class="p">(</span><span class="mi">1080</span><span class="n">p</span><span class="p">)</span>
<span class="o">-</span><span class="w"> </span><span class="mi">3840</span><span class="n">x2160</span><span class="o">:</span><span class="w"> </span><span class="mi">4</span><span class="n">K</span>
</code></pre></div>

<h3 id="reading-video-files">Reading Video Files<a class="header-link" href="#reading-video-files" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="c1"># Open video file</span>
<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="s1">&#39;video.mp4&#39;</span><span class="p">)</span>

<span class="c1"># Check if opened successfully</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cannot open video&quot;</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">()</span>

<span class="c1"># Get video properties</span>
<span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">))</span>
<span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">))</span>
<span class="n">fps</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)</span>
<span class="n">frame_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_COUNT</span><span class="p">))</span>
<span class="n">duration</span> <span class="o">=</span> <span class="n">frame_count</span> <span class="o">/</span> <span class="n">fps</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolution: </span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FPS: </span><span class="si">{</span><span class="n">fps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total frames: </span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Duration: </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

<span class="c1"># Frame reading loop</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;End of video or error&quot;</span><span class="p">)</span>
        <span class="k">break</span>

    <span class="c1"># Frame processing</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Video&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

    <span class="c1"># Exit with &#39;q&#39; key, wait 1ms</span>
    <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
        <span class="k">break</span>

<span class="c1"># Release resources</span>
<span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
</code></pre></div>

<h3 id="camera-input">Camera Input<a class="header-link" href="#camera-input" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="c1"># Open camera (device ID: 0=default camera)</span>
<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># If camera fails to open</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cannot open camera&quot;</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">()</span>

<span class="c1"># Set camera properties</span>
<span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">,</span> <span class="mi">640</span><span class="p">)</span>
<span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span> <span class="mi">480</span><span class="p">)</span>
<span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

<span class="c1"># Set buffer size (reduce latency)</span>
<span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_BUFFERSIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Camera resolution: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">))</span><span class="si">}</span><span class="s2">x&quot;</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="c1"># Horizontal flip (mirror effect)</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Camera&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
        <span class="k">break</span>

<span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
</code></pre></div>

<h3 id="key-videocapture-properties">Key VideoCapture Properties<a class="header-link" href="#key-videocapture-properties" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="s1">&#39;video.mp4&#39;</span><span class="p">)</span>

<span class="c1"># Read properties</span>
<span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;CAP_PROP_FRAME_WIDTH&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">,</span>    <span class="c1"># Frame width</span>
    <span class="s1">&#39;CAP_PROP_FRAME_HEIGHT&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span>  <span class="c1"># Frame height</span>
    <span class="s1">&#39;CAP_PROP_FPS&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">,</span>                    <span class="c1"># FPS</span>
    <span class="s1">&#39;CAP_PROP_FRAME_COUNT&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_COUNT</span><span class="p">,</span>    <span class="c1"># Total frame count</span>
    <span class="s1">&#39;CAP_PROP_POS_FRAMES&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_POS_FRAMES</span><span class="p">,</span>      <span class="c1"># Current frame position</span>
    <span class="s1">&#39;CAP_PROP_POS_MSEC&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_POS_MSEC</span><span class="p">,</span>          <span class="c1"># Current position (ms)</span>
    <span class="s1">&#39;CAP_PROP_FOURCC&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FOURCC</span><span class="p">,</span>              <span class="c1"># Codec 4-char code</span>
    <span class="s1">&#39;CAP_PROP_BRIGHTNESS&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_BRIGHTNESS</span><span class="p">,</span>      <span class="c1"># Brightness (camera)</span>
    <span class="s1">&#39;CAP_PROP_CONTRAST&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_CONTRAST</span><span class="p">,</span>          <span class="c1"># Contrast (camera)</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Seek to specific frame</span>
<span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_POS_FRAMES</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># Go to frame 100</span>

<span class="c1"># Seek to specific time (milliseconds)</span>
<span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_POS_MSEC</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>  <span class="c1"># Go to 5 seconds</span>

<span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="2-videowriter-saving-video">2. VideoWriter: Saving Video<a class="header-link" href="#2-videowriter-saving-video" title="Permanent link">&para;</a></h2>
<h3 id="basic-video-saving">Basic Video Saving<a class="header-link" href="#basic-video-saving" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="c1"># Video capture setup</span>
<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Video properties</span>
<span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">))</span>
<span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">))</span>
<span class="n">fps</span> <span class="o">=</span> <span class="mf">30.0</span>

<span class="c1"># Codec setup (4-character code)</span>
<span class="c1"># &#39;XVID&#39;: for AVI container</span>
<span class="c1"># &#39;mp4v&#39;: for MP4 container</span>
<span class="c1"># &#39;MJPG&#39;: Motion JPEG</span>
<span class="n">fourcc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="o">*</span><span class="s1">&#39;mp4v&#39;</span><span class="p">)</span>

<span class="c1"># Create VideoWriter</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="s1">&#39;output.mp4&#39;</span><span class="p">,</span> <span class="n">fourcc</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recording started... Press &#39;q&#39; to stop&quot;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="c1"># Save frame</span>
    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="c1"># Recording indicator</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Red circle</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s1">&#39;REC&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Recording&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
        <span class="k">break</span>

<span class="c1"># Release resources</span>
<span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<span class="n">out</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recording complete: output.mp4&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="major-codecs">Major Codecs<a class="header-link" href="#major-codecs" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>+-----------+-------------+------------------------+
|   Codec   |  Container  |      Characteristics   |
+-----------+-------------+------------------------+
| &#39;XVID&#39;    | .avi        | Widely supported,      |
|           |             | decent compression     |
| &#39;MJPG&#39;    | .avi        | Motion JPEG, fast      |
| &#39;mp4v&#39;    | .mp4        | MPEG-4, good compat    |
| &#39;avc1&#39;    | .mp4        | H.264, high compression|
| &#39;X264&#39;    | .mp4        | H.264 (requirements)   |
| &#39;VP80&#39;    | .webm       | VP8, for web           |
| &#39;VP90&#39;    | .webm       | VP9, high efficiency   |
+-----------+-------------+------------------------+

<span class="gh">#</span> Codec test
def test_codec(codec_str, extension):
    fourcc = cv2.VideoWriter_fourcc(*codec_str)
    out = cv2.VideoWriter(f&#39;test.{extension}&#39;, fourcc, 30, (640, 480))
    if out.isOpened():
        print(f&quot;{codec_str}: Supported&quot;)
        out.release()
        return True
    else:
        print(f&quot;{codec_str}: Not supported&quot;)
        return False
</code></pre></div>

<h3 id="processing-and-saving-video">Processing and Saving Video<a class="header-link" href="#processing-and-saving-video" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_and_save_video</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">process_func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process video and save&quot;&quot;&quot;</span>

    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>

    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">))</span>
    <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">))</span>
    <span class="n">fps</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)</span>
    <span class="n">total_frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_COUNT</span><span class="p">))</span>

    <span class="n">fourcc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="o">*</span><span class="s1">&#39;mp4v&#39;</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">fourcc</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>

    <span class="n">frame_num</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># Process frame</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="n">process_func</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># Save</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>

        <span class="c1"># Progress display</span>
        <span class="n">frame_num</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_num</span> <span class="o">/</span> <span class="n">total_frames</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Processing: </span><span class="si">{</span><span class="n">progress</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Complete!&quot;</span><span class="p">)</span>

    <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="n">out</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="c1"># Usage example: Grayscale conversion and edge detection</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edge_detection</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Canny</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
    <span class="c1"># Convert to 3 channels (VideoWriter is set for color video)</span>
    <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_GRAY2BGR</span><span class="p">)</span>

<span class="n">process_and_save_video</span><span class="p">(</span><span class="s1">&#39;input.mp4&#39;</span><span class="p">,</span> <span class="s1">&#39;edges.mp4&#39;</span><span class="p">,</span> <span class="n">edge_detection</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="3-frame-by-frame-processing">3. Frame-by-frame Processing<a class="header-link" href="#3-frame-by-frame-processing" title="Permanent link">&para;</a></h2>
<h3 id="frame-processing-pipeline">Frame Processing Pipeline<a class="header-link" href="#frame-processing-pipeline" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Frame</span><span class="w"> </span><span class="n">Processing</span><span class="w"> </span><span class="n">Pipeline</span><span class="o">:</span>

<span class="n">Input</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">Preprocessing</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">Analysis</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">Postprocessing</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="kr">Output</span>
<span class="w">              </span><span class="o">|</span><span class="w">              </span><span class="o">|</span><span class="w">              </span><span class="o">|</span>
<span class="w">              </span><span class="n">v</span><span class="w">              </span><span class="n">v</span><span class="w">              </span><span class="n">v</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">Resize</span><span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">Detection</span><span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">Visualization</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="n">conv</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Tracking</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">Filtering</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">Noise</span><span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">Recognition</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Compositing</span>
<span class="w">            </span><span class="n">removal</span>
</code></pre></div>

<h3 id="multi-processing-example">Multi-processing Example<a class="header-link" href="#multi-processing-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">VideoProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Video frame processor&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add processing function&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply all processing functions&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processors</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_source</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process video&quot;&quot;&quot;</span>
        <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">input_source</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">))</span>
            <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">))</span>
            <span class="n">fps</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)</span>
            <span class="n">fourcc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="o">*</span><span class="s1">&#39;mp4v&#39;</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">fourcc</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># Process</span>
            <span class="n">processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

            <span class="c1"># Save</span>
            <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>

            <span class="c1"># Display</span>
            <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Processed&#39;</span><span class="p">,</span> <span class="n">processed</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
                    <span class="k">break</span>

        <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>

<span class="c1"># Usage example</span>
<span class="n">processor</span> <span class="o">=</span> <span class="n">VideoProcessor</span><span class="p">()</span>

<span class="c1"># Add processing functions</span>
<span class="n">processor</span><span class="o">.</span><span class="n">add_processor</span><span class="p">(</span><span class="s1">&#39;blur&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">processor</span><span class="o">.</span><span class="n">add_processor</span><span class="p">(</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Canny</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">150</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">add_timestamp</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frame</span>

<span class="n">processor</span><span class="o">.</span><span class="n">add_processor</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">add_timestamp</span><span class="p">)</span>

<span class="c1"># Process webcam</span>
<span class="n">processor</span><span class="o">.</span><span class="n">process_video</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="s1">&#39;recorded.mp4&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="frame-skipping-and-buffering">Frame Skipping and Buffering<a class="header-link" href="#frame-skipping-and-buffering" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">def</span><span class="w"> </span><span class="nf">skip_frames_processing</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Frame skipping (speed improvement)&quot;&quot;&quot;</span>

    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>

    <span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Process every skip frames</span>
        <span class="k">if</span> <span class="n">frame_count</span> <span class="o">%</span> <span class="n">skip</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Perform heavy processing</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="n">heavy_processing</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Skipped Processing&#39;</span><span class="p">,</span> <span class="n">processed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">buffered_reading</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Frame buffering (smooth playback)&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Thread</span>

    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>
    <span class="n">stop_flag</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_frames</span><span class="p">():</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">stop_flag</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">buffer_size</span><span class="p">:</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="c1"># Start reading thread</span>
    <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">read_frames</span><span class="p">)</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Wait for initial buffer fill</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Buffered&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="n">stop_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="4-fps-calculation">4. FPS Calculation<a class="header-link" href="#4-fps-calculation" title="Permanent link">&para;</a></h2>
<h3 id="fps-measurement-method">FPS Measurement Method<a class="header-link" href="#fps-measurement-method" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FPSCounter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FPS measurement class&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avg_frames</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg_frames</span> <span class="o">=</span> <span class="n">avg_frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call after processing each frame&quot;&quot;&quot;</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_time</span> <span class="o">=</span> <span class="n">current_time</span>

        <span class="c1"># Keep only last N frames</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_times</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_frames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame_times</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_fps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return current FPS&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_times</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">avg_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_times</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_times</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">avg_time</span> <span class="k">if</span> <span class="n">avg_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="c1"># Usage example</span>
<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fps_counter</span> <span class="o">=</span> <span class="n">FPSCounter</span><span class="p">()</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="c1"># Frame processing</span>
    <span class="c1"># ...</span>

    <span class="n">fps_counter</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">fps</span> <span class="o">=</span> <span class="n">fps_counter</span><span class="o">.</span><span class="n">get_fps</span><span class="p">()</span>

    <span class="c1"># Display FPS</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;FPS: </span><span class="si">{</span><span class="n">fps</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;FPS&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
        <span class="k">break</span>

<span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></div>

<h3 id="processing-time-analysis">Processing Time Analysis<a class="header-link" href="#processing-time-analysis" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PerformanceMonitor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performance monitoring&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timings</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start timing&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timings</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop timing&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timings</span><span class="p">:</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">timings</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timings</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;elapsed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elapsed</span>
            <span class="k">return</span> <span class="n">elapsed</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performance report&quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;elapsed&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">ms&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>

<span class="c1"># Usage example</span>
<span class="n">monitor</span> <span class="o">=</span> <span class="n">PerformanceMonitor</span><span class="p">()</span>

<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1"># Measure total frame time</span>
    <span class="n">monitor</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">)</span>

    <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="c1"># Measure preprocessing time</span>
    <span class="n">monitor</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;preprocess&#39;</span><span class="p">)</span>
    <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">blur</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">monitor</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s1">&#39;preprocess&#39;</span><span class="p">)</span>

    <span class="c1"># Measure detection time</span>
    <span class="n">monitor</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;detection&#39;</span><span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Canny</span><span class="p">(</span><span class="n">blur</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
    <span class="n">monitor</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s1">&#39;detection&#39;</span><span class="p">)</span>

    <span class="n">monitor</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">)</span>

    <span class="c1"># Display performance</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">monitor</span><span class="o">.</span><span class="n">get_report</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="mi">20</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Performance&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
        <span class="k">break</span>

<span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="5-background-subtraction-mog2-knn">5. Background Subtraction (MOG2, KNN)<a class="header-link" href="#5-background-subtraction-mog2-knn" title="Permanent link">&para;</a></h2>
<h3 id="background-subtraction-principle">Background Subtraction Principle<a class="header-link" href="#background-subtraction-principle" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Background</span><span class="w"> </span><span class="nl">Subtraction:</span>
<span class="n">Separate</span><span class="w"> </span><span class="n">moving</span><span class="w"> </span><span class="n">foreground</span><span class="w"> </span><span class="n">objects</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">stationary</span><span class="w"> </span><span class="n">background</span>

<span class="o">+-----------------+</span><span class="w">     </span><span class="o">+-----------------+</span><span class="w">     </span><span class="o">+-----------------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">Current</span><span class="w"> </span><span class="n">frame</span><span class="w">   </span><span class="o">|</span><span class="w">  </span><span class="o">-</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Background</span><span class="w"> </span><span class="n">model</span><span class="o">|</span><span class="w">  </span><span class="o">=</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Foreground</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w">                 </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span>
<span class="o">|</span><span class="w">    </span><span class="o">+---+</span><span class="w">        </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">    </span><span class="o">+---+</span><span class="w">        </span><span class="o">|</span>
<span class="o">|</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">person</span><span class="p">)</span><span class="o">|</span><span class="w">    </span><span class="o">|</span><span class="w">   </span><span class="p">(</span><span class="n">empty</span><span class="w"> </span><span class="n">room</span><span class="p">)</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">    </span><span class="o">|</span><span class="p">###</span><span class="o">|</span><span class="w">        </span><span class="o">|</span>
<span class="o">|</span><span class="w">    </span><span class="o">+---+</span><span class="w">        </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">    </span><span class="o">+---+</span><span class="w">        </span><span class="o">|</span>
<span class="o">|</span><span class="w">                 </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span>
<span class="o">+-----------------+</span><span class="w">     </span><span class="o">+-----------------+</span><span class="w">     </span><span class="o">+-----------------+</span>

<span class="n">Background</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="nl">learning:</span>
<span class="o">-</span><span class="w"> </span><span class="n">Analyze</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">learn</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">statistics</span>
<span class="o">-</span><span class="w"> </span><span class="n">Handle</span><span class="w"> </span><span class="n">lighting</span><span class="w"> </span><span class="n">changes</span><span class="p">,</span><span class="w"> </span><span class="n">shadows</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="p">.</span>
<span class="o">-</span><span class="w"> </span><span class="n">Adapt</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dynamic</span><span class="w"> </span><span class="n">backgrounds</span><span class="w"> </span><span class="p">(</span><span class="n">tree</span><span class="w"> </span><span class="n">leaves</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="p">.)</span>
</code></pre></div>

<h3 id="mog2-mixture-of-gaussians">MOG2 (Mixture of Gaussians)<a class="header-link" href="#mog2-mixture-of-gaussians" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Create MOG2 background subtractor</span>
<span class="n">backSub</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">createBackgroundSubtractorMOG2</span><span class="p">(</span>
    <span class="n">history</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>          <span class="c1"># Number of frames for background learning</span>
    <span class="n">varThreshold</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>      <span class="c1"># Variance threshold for background classification</span>
    <span class="n">detectShadows</span><span class="o">=</span><span class="kc">True</span>    <span class="c1"># Shadow detection</span>
<span class="p">)</span>

<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="c1"># Apply background subtraction</span>
    <span class="c1"># fgMask: foreground=255, background=0, shadow=127</span>
    <span class="n">fgMask</span> <span class="o">=</span> <span class="n">backSub</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="c1"># Remove shadows (127 -&gt; 0)</span>
    <span class="n">fgMask_no_shadow</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">fgMask</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Remove noise</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getStructuringElement</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_ELLIPSE</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">fgMask_clean</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="n">fgMask_no_shadow</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_OPEN</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
    <span class="n">fgMask_clean</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="n">fgMask_clean</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_CLOSE</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>

    <span class="c1"># Extract foreground</span>
    <span class="n">foreground</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">fgMask_clean</span><span class="p">)</span>

    <span class="c1"># Display results</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;FG Mask&#39;</span><span class="p">,</span> <span class="n">fgMask</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Cleaned Mask&#39;</span><span class="p">,</span> <span class="n">fgMask_clean</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Foreground&#39;</span><span class="p">,</span> <span class="n">foreground</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
        <span class="k">break</span>

<span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
</code></pre></div>

<h3 id="knn-background-subtraction">KNN Background Subtraction<a class="header-link" href="#knn-background-subtraction" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="c1"># Create KNN background subtractor</span>
<span class="n">backSub</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">createBackgroundSubtractorKNN</span><span class="p">(</span>
    <span class="n">history</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>          <span class="c1"># Background learning frame count</span>
    <span class="n">dist2Threshold</span><span class="o">=</span><span class="mf">400.0</span><span class="p">,</span> <span class="c1"># Distance threshold</span>
    <span class="n">detectShadows</span><span class="o">=</span><span class="kc">True</span>    <span class="c1"># Shadow detection</span>
<span class="p">)</span>

<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="s1">&#39;traffic.mp4&#39;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="c1"># Background subtraction</span>
    <span class="n">fgMask</span> <span class="o">=</span> <span class="n">backSub</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="c1"># Remove noise</span>
    <span class="n">fgMask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">medianBlur</span><span class="p">(</span><span class="n">fgMask</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="c1"># Contour detection</span>
    <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">fgMask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span>
                                    <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>

    <span class="c1"># Mark moving objects</span>
    <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">area</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>  <span class="c1"># Minimum area filter</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Motion Detection&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Mask&#39;</span><span class="p">,</span> <span class="n">fgMask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
        <span class="k">break</span>

<span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></div>

<h3 id="mog2-vs-knn-comparison">MOG2 vs KNN Comparison<a class="header-link" href="#mog2-vs-knn-comparison" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>+----------------+----------------------+----------------------+
|     Item       |        MOG2          |        KNN           |
+----------------+----------------------+----------------------+
| Algorithm      | Gaussian Mixture Model| K-Nearest Neighbors |
| Speed          | Fast                 | Medium               |
| Memory         | Low                  | High                 |
| Dynamic BG     | Medium               | Good                 |
| Lighting Change| Medium               | Good                 |
| Noise          | Sensitive            | Robust               |
| Recommended    | Static scenes,       | Complex scenes       |
|                | real-time            |                      |
+----------------+----------------------+----------------------+
</code></pre></div>

<hr />
<h2 id="6-optical-flow">6. Optical Flow<a class="header-link" href="#6-optical-flow" title="Permanent link">&para;</a></h2>
<h3 id="optical-flow-concept">Optical Flow Concept<a class="header-link" href="#optical-flow-concept" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Optical</span><span class="w"> </span><span class="n">Flow</span><span class="p">:</span>
<span class="n">Estimate</span><span class="w"> </span><span class="n">pixel</span><span class="w"> </span><span class="n">movement</span><span class="w"> </span><span class="n">between</span><span class="w"> </span><span class="n">consecutive</span><span class="w"> </span><span class="n">frames</span>

<span class="n">Frame</span><span class="w"> </span><span class="n">t</span><span class="w">                    </span><span class="n">Frame</span><span class="w"> </span><span class="n">t</span><span class="o">+</span><span class="mi">1</span>
<span class="o">+-----------------+</span><span class="w">        </span><span class="o">+-----------------+</span>
<span class="o">|</span><span class="w">                 </span><span class="o">|</span><span class="w">        </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span>
<span class="o">|</span><span class="w">    </span><span class="o">*</span><span class="w">            </span><span class="o">|</span><span class="w">   </span><span class="o">-&gt;</span><span class="w">   </span><span class="o">|</span><span class="w">        </span><span class="o">*</span><span class="w">        </span><span class="o">|</span>
<span class="o">|</span><span class="w">                 </span><span class="o">|</span><span class="w">        </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span>
<span class="o">+-----------------+</span><span class="w">        </span><span class="o">+-----------------+</span>

<span class="n">Velocity</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">):</span>
<span class="o">-</span><span class="w"> </span><span class="n">Pixel</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">moves</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">+</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="n">frame</span>
<span class="o">-</span><span class="w"> </span><span class="n">I</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">+</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">brightness</span><span class="w"> </span><span class="n">constancy</span><span class="w"> </span><span class="n">assumption</span><span class="p">)</span>

<span class="n">Types</span><span class="p">:</span>
<span class="mf">1.</span><span class="w"> </span><span class="n">Sparse</span><span class="p">:</span><span class="w"> </span><span class="n">Only</span><span class="w"> </span><span class="n">compute</span><span class="w"> </span><span class="n">movement</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">specific</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="p">(</span><span class="n">Lucas</span><span class="o">-</span><span class="n">Kanade</span><span class="p">)</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Dense</span><span class="p">:</span><span class="w"> </span><span class="n">Compute</span><span class="w"> </span><span class="n">movement</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">pixels</span><span class="w"> </span><span class="p">(</span><span class="n">Farneback</span><span class="p">)</span>
</code></pre></div>

<h3 id="lucas-kanade-optical-flow">Lucas-Kanade Optical Flow<a class="header-link" href="#lucas-kanade-optical-flow" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Lucas-Kanade parameters</span>
<span class="n">lk_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">winSize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>      <span class="c1"># Search window size</span>
    <span class="n">maxLevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>            <span class="c1"># Pyramid levels</span>
    <span class="n">criteria</span><span class="o">=</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span> <span class="o">|</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_COUNT</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Feature detection parameters</span>
<span class="n">feature_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">maxCorners</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>        <span class="c1"># Maximum feature count</span>
    <span class="n">qualityLevel</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>      <span class="c1"># Quality level</span>
    <span class="n">minDistance</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>         <span class="c1"># Minimum distance</span>
    <span class="n">blockSize</span><span class="o">=</span><span class="mi">7</span>
<span class="p">)</span>

<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Read first frame</span>
<span class="n">ret</span><span class="p">,</span> <span class="n">old_frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">old_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">old_frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

<span class="c1"># Detect features</span>
<span class="n">p0</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">goodFeaturesToTrack</span><span class="p">(</span><span class="n">old_gray</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">feature_params</span><span class="p">)</span>

<span class="c1"># For trajectory visualization</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">old_frame</span><span class="p">)</span>

<span class="c1"># Colors</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="n">frame_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Compute optical flow</span>
        <span class="n">p1</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calcOpticalFlowPyrLK</span><span class="p">(</span>
            <span class="n">old_gray</span><span class="p">,</span> <span class="n">frame_gray</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">lk_params</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">p1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Select good points only</span>
            <span class="n">good_new</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="n">st</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">good_old</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">st</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Visualize movement</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">good_new</span><span class="p">,</span> <span class="n">good_old</span><span class="p">)):</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

                <span class="c1"># Trajectory line</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span>
                               <span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="c1"># Current position point</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span>
                                   <span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Update for next frame</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">good_new</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Combine trajectory</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Lucas-Kanade&#39;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
        <span class="k">break</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">):</span>
        <span class="c1"># Re-detect features with &#39;r&#39; key</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">goodFeaturesToTrack</span><span class="p">(</span><span class="n">frame_gray</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">feature_params</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="n">old_gray</span> <span class="o">=</span> <span class="n">frame_gray</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
</code></pre></div>

<h3 id="farneback-dense-optical-flow">Farneback Dense Optical Flow<a class="header-link" href="#farneback-dense-optical-flow" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">draw_flow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize flow vectors&quot;&quot;&quot;</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">step</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="n">h</span><span class="p">:</span><span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="n">w</span><span class="p">:</span><span class="n">step</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Draw lines</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="n">fx</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">fy</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">lines</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="n">vis</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">polylines</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vis</span>

<span class="k">def</span><span class="w"> </span><span class="nf">flow_to_hsv</span><span class="p">(</span><span class="n">flow</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert flow to HSV color&quot;&quot;&quot;</span>
    <span class="n">mag</span><span class="p">,</span> <span class="n">ang</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cartToPolar</span><span class="p">(</span><span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">hsv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="o">*</span><span class="n">flow</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ang</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># Direction -&gt; Hue</span>
    <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># Saturation</span>
    <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">mag</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">)</span>  <span class="c1"># Magnitude -&gt; Value</span>

    <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_HSV2BGR</span><span class="p">)</span>

<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">ret</span><span class="p">,</span> <span class="n">frame1</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">prvs</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">frame2</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="n">next_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

    <span class="c1"># Farneback optical flow</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calcOpticalFlowFarneback</span><span class="p">(</span>
        <span class="n">prvs</span><span class="p">,</span> <span class="n">next_gray</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>           <span class="c1"># Initial flow</span>
        <span class="n">pyr_scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># Pyramid scale</span>
        <span class="n">levels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>       <span class="c1"># Pyramid levels</span>
        <span class="n">winsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>     <span class="c1"># Window size</span>
        <span class="n">iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>   <span class="c1"># Iterations</span>
        <span class="n">poly_n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>       <span class="c1"># Polynomial size</span>
        <span class="n">poly_sigma</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="c1"># Gaussian sigma</span>
        <span class="n">flags</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>

    <span class="c1"># Visualization</span>
    <span class="n">flow_vis</span> <span class="o">=</span> <span class="n">draw_flow</span><span class="p">(</span><span class="n">frame2</span><span class="p">,</span> <span class="n">flow</span><span class="p">)</span>
    <span class="n">hsv_vis</span> <span class="o">=</span> <span class="n">flow_to_hsv</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Flow Vectors&#39;</span><span class="p">,</span> <span class="n">flow_vis</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Flow HSV&#39;</span><span class="p">,</span> <span class="n">hsv_vis</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
        <span class="k">break</span>

    <span class="n">prvs</span> <span class="o">=</span> <span class="n">next_gray</span>

<span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="7-object-tracking">7. Object Tracking<a class="header-link" href="#7-object-tracking" title="Permanent link">&para;</a></h2>
<h3 id="opencv-built-in-trackers">OpenCV Built-in Trackers<a class="header-link" href="#opencv-built-in-trackers" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="c1"># Tracker types</span>
<span class="n">TRACKERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;BOOSTING&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">TrackerBoosting_create</span><span class="p">,</span>
    <span class="s1">&#39;MIL&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TrackerMIL_create</span><span class="p">,</span>
    <span class="s1">&#39;KCF&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TrackerKCF_create</span><span class="p">,</span>
    <span class="s1">&#39;CSRT&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TrackerCSRT_create</span><span class="p">,</span>
    <span class="s1">&#39;MOSSE&#39;</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">TrackerMOSSE_create</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">track_object</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">tracker_type</span><span class="o">=</span><span class="s1">&#39;CSRT&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Single object tracking&quot;&quot;&quot;</span>

    <span class="c1"># Create tracker</span>
    <span class="n">tracker</span> <span class="o">=</span> <span class="n">TRACKERS</span><span class="p">[</span><span class="n">tracker_type</span><span class="p">]()</span>

    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># Select object to track (mouse drag)</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">selectROI</span><span class="p">(</span><span class="s1">&#39;Select Object&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyWindow</span><span class="p">(</span><span class="s1">&#39;Select Object&#39;</span><span class="p">)</span>

    <span class="c1"># Initialize tracker</span>
    <span class="n">tracker</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">bbox</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># Update tracking</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">bbox</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bbox</span><span class="p">]</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">tracker_type</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span>
                       <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s1">&#39;Tracking Failed&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span>
                       <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Tracking&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>

<span class="c1"># Usage example</span>
<span class="n">track_object</span><span class="p">(</span><span class="s1">&#39;video.mp4&#39;</span><span class="p">,</span> <span class="s1">&#39;CSRT&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="multi-object-tracking">Multi-object Tracking<a class="header-link" href="#multi-object-tracking" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MultiObjectTracker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Multi-object tracker&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracker_type</span><span class="o">=</span><span class="s1">&#39;CSRT&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracker_type</span> <span class="o">=</span> <span class="n">tracker_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">bbox</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add new tracker&quot;&quot;&quot;</span>
        <span class="n">tracker</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TrackerCSRT_create</span><span class="p">()</span>
        <span class="n">tracker</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">bbox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tracker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update all trackers&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tracker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="p">):</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">bbox</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                    <span class="s1">&#39;bbox&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">,</span>
                    <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualize results&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]]</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">),</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ID: </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span>
                       <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

<span class="c1"># Usage example</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">multi_tracker</span> <span class="o">=</span> <span class="n">MultiObjectTracker</span><span class="p">()</span>

<span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c1"># Select multiple objects (ESC to finish)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">selectROI</span><span class="p">(</span><span class="s1">&#39;Select Objects (Press ESC when done)&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bbox</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># ESC pressed</span>
        <span class="k">break</span>
    <span class="n">multi_tracker</span><span class="o">.</span><span class="n">add_tracker</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">bbox</span><span class="p">)</span>

<span class="n">cv2</span><span class="o">.</span><span class="n">destroyWindow</span><span class="p">(</span><span class="s1">&#39;Select Objects (Press ESC when done)&#39;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">multi_tracker</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">multi_tracker</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Multi Tracking&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
        <span class="k">break</span>

<span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></div>

<h3 id="background-subtraction-tracking-combined">Background Subtraction + Tracking Combined<a class="header-link" href="#background-subtraction-tracking-combined" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MotionTracker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Background subtraction-based motion tracking&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bg_subtractor</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">createBackgroundSubtractorMOG2</span><span class="p">(</span>
            <span class="n">history</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">varThreshold</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">detectShadows</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getStructuringElement</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_ELLIPSE</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {id: {&#39;centroid&#39;: (x,y), &#39;frames&#39;: count}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Distance for same object judgment</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process frame&quot;&quot;&quot;</span>
        <span class="c1"># Background subtraction</span>
        <span class="n">fg_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bg_subtractor</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">fg_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">fg_mask</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Remove noise</span>
        <span class="n">fg_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="n">fg_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_OPEN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span>
        <span class="n">fg_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="n">fg_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_CLOSE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span>

        <span class="c1"># Contour detection</span>
        <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">fg_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span>
                                        <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>

        <span class="c1"># Current frame&#39;s objects</span>
        <span class="n">current_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
            <span class="n">area</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">area</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
                <span class="n">centroid</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">current_objects</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;centroid&#39;</span><span class="p">:</span> <span class="n">centroid</span><span class="p">,</span>
                    <span class="s1">&#39;bbox&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
                <span class="p">})</span>

        <span class="c1"># Match with existing tracks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_match_tracks</span><span class="p">(</span><span class="n">current_objects</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fg_mask</span><span class="p">,</span> <span class="n">current_objects</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_match_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_objects</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Match current objects with existing tracks&quot;&quot;&quot;</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">current_objects</span><span class="p">:</span>
            <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">]</span>
            <span class="n">best_match</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">best_dist</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

            <span class="c1"># Find closest existing track</span>
            <span class="k">for</span> <span class="n">track_id</span><span class="p">,</span> <span class="n">track</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">tx</span><span class="p">,</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">track</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">]</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">cx</span><span class="o">-</span><span class="n">tx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">cy</span><span class="o">-</span><span class="n">ty</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_distance</span> <span class="ow">and</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">best_dist</span><span class="p">:</span>
                    <span class="n">best_dist</span> <span class="o">=</span> <span class="n">dist</span>
                    <span class="n">best_match</span> <span class="o">=</span> <span class="n">track_id</span>

            <span class="k">if</span> <span class="n">best_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Update existing track</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">best_match</span><span class="p">][</span><span class="s1">&#39;centroid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">best_match</span><span class="p">][</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">best_match</span><span class="p">][</span><span class="s1">&#39;frames&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_match</span>
                <span class="n">matched</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">best_match</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Create new track</span>
                <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">next_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;centroid&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;bbox&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;frames&#39;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_id</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Remove old tracks</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">tid</span> <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span> <span class="k">if</span> <span class="n">tid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">tid</span><span class="p">][</span><span class="s1">&#39;frames&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Remove short tracks immediately</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">objects</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualize&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ID: </span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span>
                           <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">frame</span>

<span class="c1"># Usage example</span>
<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">tracker</span> <span class="o">=</span> <span class="n">MotionTracker</span><span class="p">()</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="n">mask</span><span class="p">,</span> <span class="n">objects</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">objects</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Motion Tracking&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Mask&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
        <span class="k">break</span>

<span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="8-practice-problems">8. Practice Problems<a class="header-link" href="#8-practice-problems" title="Permanent link">&para;</a></h2>
<h3 id="problem-1-video-player">Problem 1: Video Player<a class="header-link" href="#problem-1-video-player" title="Permanent link">&para;</a></h3>
<p>Implement a basic video player.</p>
<p><strong>Requirements</strong>:
- Play/pause toggle (spacebar)
- Forward/backward skip (arrow keys)
- Frame-by-frame navigation (./,)
- Display current time/total time
- Progress bar</p>
<details>
<summary>Hint</summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Frame navigation</span>
<span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_POS_FRAMES</span><span class="p">,</span> <span class="n">target_frame</span><span class="p">)</span>

<span class="c1"># Key handling</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
<span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">):</span>  <span class="c1"># Spacebar</span>
    <span class="n">paused</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">paused</span>
<span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">83</span><span class="p">:</span>  <span class="c1"># Right arrow</span>
    <span class="n">skip_forward</span><span class="p">()</span>
</code></pre></div>



</details>

<h3 id="problem-2-motion-heatmap">Problem 2: Motion Heatmap<a class="header-link" href="#problem-2-motion-heatmap" title="Permanent link">&para;</a></h3>
<p>Visualize areas with lots of motion as a heatmap.</p>
<p><strong>Requirements</strong>:
- Detect motion with background subtraction
- Generate accumulated motion map
- Apply colormap (COLORMAP_JET)
- Blend original with heatmap</p>
<details>
<summary>Hint</summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Initialize accumulation map</span>
<span class="n">accumulator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># Accumulate per frame</span>
<span class="n">accumulator</span> <span class="o">+=</span> <span class="n">fg_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>

<span class="c1"># Normalize and apply colormap</span>
<span class="n">normalized</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">accumulator</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">)</span>
<span class="n">heatmap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">applyColorMap</span><span class="p">(</span><span class="n">normalized</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLORMAP_JET</span><span class="p">)</span>
</code></pre></div>



</details>

<h3 id="problem-3-speed-measurement">Problem 3: Speed Measurement<a class="header-link" href="#problem-3-speed-measurement" title="Permanent link">&para;</a></h3>
<p>Measure object movement speed using optical flow.</p>
<p><strong>Requirements</strong>:
- Compute average flow within specific ROI
- Convert pixel speed to actual speed (calibration needed)
- Display real-time speed graph</p>
<details>
<summary>Hint</summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Average flow in ROI</span>
<span class="n">roi_flow</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
<span class="n">avg_flow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">roi_flow</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="c1"># Speed calculation (pixels/frame)</span>
<span class="n">speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">avg_flow</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">avg_flow</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Convert to actual speed (e.g., 1 pixel = 1cm, 30fps)</span>
<span class="n">real_speed</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">*</span> <span class="n">pixels_to_cm</span> <span class="o">*</span> <span class="n">fps</span>  <span class="c1"># cm/s</span>
</code></pre></div>



</details>

<h3 id="problem-4-vehicle-counter">Problem 4: Vehicle Counter<a class="header-link" href="#problem-4-vehicle-counter" title="Permanent link">&para;</a></h3>
<p>Count vehicles passing through in road video.</p>
<p><strong>Requirements</strong>:
- Detect vehicles with background subtraction
- Set virtual line (counting line)
- Count objects crossing the line
- Distinguish entry/exit direction</p>
<details>
<summary>Hint</summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Define virtual line</span>
<span class="n">line_y</span> <span class="o">=</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>

<span class="c1"># Check if object crossed line</span>
<span class="k">def</span><span class="w"> </span><span class="nf">crossed_line</span><span class="p">(</span><span class="n">prev_y</span><span class="p">,</span> <span class="n">curr_y</span><span class="p">,</span> <span class="n">line_y</span><span class="p">):</span>
    <span class="c1"># Top to bottom</span>
    <span class="k">if</span> <span class="n">prev_y</span> <span class="o">&lt;</span> <span class="n">line_y</span> <span class="ow">and</span> <span class="n">curr_y</span> <span class="o">&gt;=</span> <span class="n">line_y</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;down&#39;</span>
    <span class="c1"># Bottom to top</span>
    <span class="k">if</span> <span class="n">prev_y</span> <span class="o">&gt;</span> <span class="n">line_y</span> <span class="ow">and</span> <span class="n">curr_y</span> <span class="o">&lt;=</span> <span class="n">line_y</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;up&#39;</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>



</details>

<h3 id="problem-5-gesture-recognition">Problem 5: Gesture Recognition<a class="header-link" href="#problem-5-gesture-recognition" title="Permanent link">&para;</a></h3>
<p>Analyze optical flow patterns to recognize simple gestures (hand waving, drawing circles).</p>
<p><strong>Requirements</strong>:
- Detect hand region (skin color-based)
- Track movement patterns
- Classify patterns (rule-based or template matching)
- Display recognized gesture</p>
<details>
<summary>Hint</summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Skin color detection (HSV)</span>
<span class="n">hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">)</span>
<span class="n">lower_skin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">70</span><span class="p">])</span>
<span class="n">upper_skin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">20</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">])</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">lower_skin</span><span class="p">,</span> <span class="n">upper_skin</span><span class="p">)</span>

<span class="c1"># Store movement trajectory</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">centroid</span><span class="p">)</span>

<span class="c1"># Trajectory analysis</span>
<span class="c1"># Hand waving: oscillation in x direction</span>
<span class="c1"># Circle drawing: start and end points close + certain area</span>
</code></pre></div>



</details>

<hr />
<h2 id="next-steps">Next Steps<a class="header-link" href="#next-steps" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="./18_Camera_Calibration.md">18_Camera_Calibration.md</a> - Camera matrix, distortion correction</li>
</ul>
<hr />
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://docs.opencv.org/4.x/dd/d43/tutorial_py_video_display.html">OpenCV Video I/O</a></li>
<li><a href="https://docs.opencv.org/4.x/d1/dc5/tutorial_background_subtraction.html">Background Subtraction</a></li>
<li><a href="https://docs.opencv.org/4.x/d4/dee/tutorial_optical_flow.html">Optical Flow</a></li>
<li><a href="https://docs.opencv.org/4.x/d9/df8/group__tracking.html">Object Tracking</a></li>
<li>Horn, B. K., &amp; Schunck, B. G. (1981). "Determining Optical Flow"</li>
<li>Lucas, B. D., &amp; Kanade, T. (1981). "An Iterative Image Registration Technique"</li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Computer_Vision/16_Face_Detection.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Face Detection and Recognition</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Computer_Vision/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Computer_Vision/18_Camera_Calibration.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Camera Calibration</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">‚Üë</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}