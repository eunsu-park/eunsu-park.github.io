{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practical Projects - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Computer_Vision/">Computer Vision</a>
    <span class="separator">/</span>
    <span class="current">Practical Projects</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Practical Projects</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Computer_Vision/19_DNN_Module.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Deep Neural Network Module (DNN Module)</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Computer_Vision/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Computer_Vision/21_3D_Vision_Basics.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">3D Vision Basics</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#project-1-document-scanner">Project 1: Document Scanner</a><ul>
<li><a href="#project-overview">Project Overview</a></li>
<li><a href="#step-by-step-implementation">Step-by-step Implementation</a></li>
<li><a href="#real-time-document-scanner">Real-time Document Scanner</a></li>
</ul>
</li>
<li><a href="#project-2-lane-detection">Project 2: Lane Detection</a><ul>
<li><a href="#project-overview_1">Project Overview</a></li>
<li><a href="#step-by-step-implementation_1">Step-by-step Implementation</a></li>
<li><a href="#video-lane-detection">Video Lane Detection</a></li>
</ul>
</li>
<li><a href="#project-3-ar-marker-detection">Project 3: AR Marker Detection</a><ul>
<li><a href="#project-overview_2">Project Overview</a></li>
<li><a href="#step-by-step-implementation_2">Step-by-step Implementation</a></li>
<li><a href="#using-aruco-markers-opencv-built-in">Using ArUco Markers (OpenCV Built-in)</a></li>
</ul>
</li>
<li><a href="#project-4-real-time-face-filter">Project 4: Real-time Face Filter</a><ul>
<li><a href="#project-overview_3">Project Overview</a></li>
<li><a href="#step-by-step-implementation_3">Step-by-step Implementation</a></li>
</ul>
</li>
<li><a href="#project-5-object-tracking-system">Project 5: Object Tracking System</a><ul>
<li><a href="#project-overview_4">Project Overview</a></li>
<li><a href="#step-by-step-implementation_4">Step-by-step Implementation</a></li>
</ul>
</li>
<li><a href="#exercises-and-extension-ideas">Exercises and Extension Ideas</a><ul>
<li><a href="#project-1-document-scanner-extensions">Project 1: Document Scanner Extensions</a></li>
<li><a href="#project-2-lane-detection-extensions">Project 2: Lane Detection Extensions</a></li>
<li><a href="#project-3-ar-marker-extensions">Project 3: AR Marker Extensions</a></li>
<li><a href="#project-4-face-filter-extensions">Project 4: Face Filter Extensions</a></li>
<li><a href="#project-5-object-tracking-extensions">Project 5: Object Tracking Extensions</a></li>
</ul>
</li>
<li><a href="#next-steps">Next Steps</a><ul>
<li><a href="#deep-learning-frameworks">Deep Learning Frameworks</a></li>
<li><a href="#advanced-computer-vision">Advanced Computer Vision</a></li>
<li><a href="#application-domains">Application Domains</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="practical-projects">Practical Projects<a class="header-link" href="#practical-projects" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="header-link" href="#overview" title="Permanent link">&para;</a></h2>
<p>We will implement practical application projects by combining all the OpenCV techniques learned so far. Each project provides step-by-step guidance on creating complete applications by combining multiple technologies.</p>
<p><strong>Difficulty</strong>: â­â­â­â­</p>
<p><strong>Prerequisites</strong>: All previous chapter content</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#project-1-document-scanner">Project 1: Document Scanner</a></li>
<li><a href="#project-2-lane-detection">Project 2: Lane Detection</a></li>
<li><a href="#project-3-ar-marker-detection">Project 3: AR Marker Detection</a></li>
<li><a href="#project-4-real-time-face-filter">Project 4: Real-time Face Filter</a></li>
<li><a href="#project-5-object-tracking-system">Project 5: Object Tracking System</a></li>
<li><a href="#exercises-and-extension-ideas">Exercises and Extension Ideas</a></li>
</ol>
<hr />
<h2 id="project-1-document-scanner">Project 1: Document Scanner<a class="header-link" href="#project-1-document-scanner" title="Permanent link">&para;</a></h2>
<h3 id="project-overview">Project Overview<a class="header-link" href="#project-overview" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Document</span> <span class="n">Scanner:</span>
<span class="n">Transform</span> <span class="n">photographed</span> <span class="n">documents</span> <span class="n">into</span> <span class="n">aligned</span> <span class="n">scan</span> <span class="n">images</span>

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   <span class="n">Captured</span> <span class="n">Doc</span>   â”‚        â”‚  <span class="n">Scanned</span> <span class="n">Result</span>  â”‚
â”‚  /â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾\   â”‚        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ /             \  â”‚  â”€â”€â–¶   â”‚ â”‚              â”‚ â”‚
â”‚ \             /  â”‚        â”‚ â”‚   <span class="n">Document</span>   â”‚ â”‚
â”‚  \<span class="n">___________</span>/   â”‚        â”‚ â”‚   <span class="n">Content</span>    â”‚ â”‚
â”‚                  â”‚        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    <span class="n">Tilted</span> <span class="n">Original</span>              <span class="n">Aligned</span> <span class="n">Result</span>

<span class="n">Technologies</span> <span class="n">used:</span>
- <span class="n">Edge</span> <span class="n">detection</span> (<span class="n">Canny</span>)
- <span class="n">Contour</span> <span class="n">detection</span> (<span class="n">findContours</span>)
- <span class="n">Polygon</span> <span class="n">approximation</span> (<span class="n">approxPolyDP</span>)
- <span class="n">Perspective</span> <span class="n">transform</span> (<span class="n">warpPerspective</span>)
- <span class="n">Binarization</span> (<span class="n">adaptiveThreshold</span>)
</code></pre></div>

<h3 id="step-by-step-implementation">Step-by-step Implementation<a class="header-link" href="#step-by-step-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DocumentScanner</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Document Scanner&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">order_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Order 4 points in order (top-left, top-right, bottom-right, bottom-left)&quot;&quot;&quot;</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Top-left: smallest x+y sum</span>
        <span class="c1"># Bottom-right: largest x+y sum</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>
        <span class="n">rect</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>

        <span class="c1"># Top-right: smallest y-x difference</span>
        <span class="c1"># Bottom-left: largest y-x difference</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">diff</span><span class="p">)]</span>
        <span class="n">rect</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">diff</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">rect</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">four_point_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">pts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Align document using perspective transform&quot;&quot;&quot;</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_points</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>
        <span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">br</span><span class="p">,</span> <span class="n">bl</span><span class="p">)</span> <span class="o">=</span> <span class="n">rect</span>

        <span class="c1"># Calculate new image size</span>
        <span class="n">width_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">br</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">bl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">br</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">width_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">tl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">tr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">max_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width_a</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">width_b</span><span class="p">))</span>

        <span class="n">height_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">br</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">tr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">br</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">height_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">tl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">bl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">tl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">max_height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">height_a</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height_b</span><span class="p">))</span>

        <span class="c1"># Target coordinates</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="n">max_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="n">max_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Perspective transform matrix</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getPerspectiveTransform</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
        <span class="n">warped</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpPerspective</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="p">(</span><span class="n">max_width</span><span class="p">,</span> <span class="n">max_height</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">warped</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_document_contour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find document contour&quot;&quot;&quot;</span>
        <span class="c1"># Preprocessing</span>
        <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">blur</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Edge detection</span>
        <span class="n">edged</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Canny</span><span class="p">(</span><span class="n">blur</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

        <span class="c1"># Morphological operations to connect edges</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">edged</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">edged</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">edged</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">erode</span><span class="p">(</span><span class="n">edged</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Contour detection</span>
        <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">edged</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span>
                                        <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>

        <span class="c1"># Find the largest quadrilateral contour</span>
        <span class="n">contours</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">contours</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">document_contour</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># Check top 5 only</span>
            <span class="n">peri</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">arcLength</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">approx</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">approxPolyDP</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="n">peri</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">approx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">document_contour</span> <span class="o">=</span> <span class="n">approx</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">document_contour</span><span class="p">,</span> <span class="n">edged</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">enhance_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enhance document image&quot;&quot;&quot;</span>
        <span class="c1"># Convert to grayscale</span>
        <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

        <span class="c1"># Adaptive thresholding</span>
        <span class="n">binary</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">adaptiveThreshold</span><span class="p">(</span>
            <span class="n">gray</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">ADAPTIVE_THRESH_GAUSSIAN_C</span><span class="p">,</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">,</span>
            <span class="mi">11</span><span class="p">,</span> <span class="mi">2</span>
        <span class="p">)</span>

        <span class="c1"># Or OTSU thresholding</span>
        <span class="c1"># _, binary = cv2.threshold(gray, 0, 255,</span>
        <span class="c1">#                           cv2.THRESH_BINARY + cv2.THRESH_OTSU)</span>

        <span class="k">return</span> <span class="n">binary</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">enhance</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Complete document scanning process&quot;&quot;&quot;</span>
        <span class="n">original</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Resize for processing (maintain ratio)</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="mf">500.0</span> <span class="o">/</span> <span class="n">height</span>
        <span class="n">resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fx</span><span class="o">=</span><span class="n">ratio</span><span class="p">,</span> <span class="n">fy</span><span class="o">=</span><span class="n">ratio</span><span class="p">)</span>

        <span class="c1"># Find document contour</span>
        <span class="n">contour</span><span class="p">,</span> <span class="n">edged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_document_contour</span><span class="p">(</span><span class="n">resized</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">contour</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Document contour not found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Convert coordinates to original size</span>
        <span class="n">contour</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">ratio</span>

        <span class="c1"># Perspective transform</span>
        <span class="n">scanned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">four_point_transform</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">contour</span><span class="p">)</span>

        <span class="c1"># Document enhancement (optional)</span>
        <span class="k">if</span> <span class="n">enhance</span><span class="p">:</span>
            <span class="n">scanned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enhance_document</span><span class="p">(</span><span class="n">scanned</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scanned</span><span class="p">,</span> <span class="n">contour</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">contour</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualize results&quot;&quot;&quot;</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">contour</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="p">[</span><span class="n">contour</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Mark corner points</span>
            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">contour</span><span class="p">:</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)),</span> <span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vis</span>

<span class="c1"># Usage example</span>
<span class="n">scanner</span> <span class="o">=</span> <span class="n">DocumentScanner</span><span class="p">()</span>

<span class="c1"># Load image</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;document_photo.jpg&#39;</span><span class="p">)</span>

<span class="c1"># Scan</span>
<span class="n">scanned</span><span class="p">,</span> <span class="n">contour</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">enhance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">if</span> <span class="n">scanned</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Visualize results</span>
    <span class="n">vis</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">contour</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Original with Contour&#39;</span><span class="p">,</span> <span class="n">vis</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Scanned&#39;</span><span class="p">,</span> <span class="n">scanned</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Save</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;scanned_document.jpg&#39;</span><span class="p">,</span> <span class="n">scanned</span><span class="p">)</span>
</code></pre></div>

<h3 id="real-time-document-scanner">Real-time Document Scanner<a class="header-link" href="#real-time-document-scanner" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">realtime_document_scanner</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Real-time document scanner&quot;&quot;&quot;</span>

    <span class="n">scanner</span> <span class="o">=</span> <span class="n">DocumentScanner</span><span class="p">()</span>
    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># Document contour detection</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="mf">500.0</span> <span class="o">/</span> <span class="n">height</span>
        <span class="n">resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fx</span><span class="o">=</span><span class="n">ratio</span><span class="p">,</span> <span class="n">fy</span><span class="o">=</span><span class="n">ratio</span><span class="p">)</span>

        <span class="n">contour</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="n">find_document_contour</span><span class="p">(</span><span class="n">resized</span><span class="p">)</span>

        <span class="n">display</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">contour</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Convert to original size</span>
            <span class="n">contour</span> <span class="o">=</span> <span class="p">(</span><span class="n">contour</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">ratio</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="c1"># Draw contour</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="p">[</span><span class="n">contour</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Guide text</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="s2">&quot;Press &#39;s&#39; to scan&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                       <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="s2">&quot;Document not detected&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                       <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Document Scanner&#39;</span><span class="p">,</span> <span class="n">display</span><span class="p">)</span>

        <span class="n">key</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">contour</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Perform scan</span>
            <span class="n">scanned</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scanned</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Scanned&#39;</span><span class="p">,</span> <span class="n">scanned</span><span class="p">)</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;scanned.jpg&#39;</span><span class="p">,</span> <span class="n">scanned</span><span class="p">)</span>

    <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>

<span class="c1"># Run</span>
<span class="c1"># realtime_document_scanner()</span>
</code></pre></div>

<hr />
<h2 id="project-2-lane-detection">Project 2: Lane Detection<a class="header-link" href="#project-2-lane-detection" title="Permanent link">&para;</a></h2>
<h3 id="project-overview_1">Project Overview<a class="header-link" href="#project-overview_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nv">Lane</span><span class="w"> </span><span class="nv">Detection</span>:
<span class="nv">Detect</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">visualize</span><span class="w"> </span><span class="nv">lanes</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">road</span><span class="w"> </span><span class="nv">images</span>

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">            </span><span class="nv">Road</span><span class="w"> </span><span class="nv">Image</span><span class="w">              </span>â”‚
â”‚<span class="w">                                    </span>â”‚
â”‚<span class="w">     </span>â•²<span class="w">                    </span>â•±<span class="w">         </span>â”‚
â”‚<span class="w">      </span>â•²<span class="w">      </span><span class="nv">Lane</span><span class="w">       </span>â•±<span class="w">          </span>â”‚
â”‚<span class="w">       </span>â•²<span class="w">              </span>â•±<span class="w">            </span>â”‚
â”‚<span class="w">        </span>â•²<span class="w">  </span><span class="nv">Detection</span><span class="w"> </span>â•±<span class="w">              </span>â”‚
â”‚<span class="w">         </span>â•²<span class="w">        </span>â•±<span class="w">                </span>â”‚
â”‚<span class="w">          </span>â•²<span class="w">      </span>â•±<span class="w">                 </span>â”‚
â”‚<span class="w">           </span>â•²<span class="w">    </span>â•±<span class="w">                  </span>â”‚
â”‚<span class="w">            </span>â•²<span class="w">  </span>â•±<span class="w">                   </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

<span class="nv">Processing</span><span class="w"> </span><span class="nv">Pipeline</span>:
<span class="mi">1</span>.<span class="w"> </span><span class="nv">Region</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">Interest</span><span class="w"> </span><span class="ss">(</span><span class="nv">ROI</span><span class="ss">)</span><span class="w"> </span><span class="nv">setup</span>
<span class="mi">2</span>.<span class="w"> </span><span class="nv">Color</span><span class="w"> </span><span class="nv">space</span><span class="w"> </span><span class="nv">conversion</span><span class="w"> </span><span class="ss">(</span><span class="nv">HSV</span><span class="ss">)</span>
<span class="mi">3</span>.<span class="w"> </span><span class="nv">White</span><span class="o">/</span><span class="nv">yellow</span><span class="w"> </span><span class="nv">mask</span><span class="w"> </span><span class="nv">generation</span>
<span class="mi">4</span>.<span class="w"> </span><span class="nv">Canny</span><span class="w"> </span><span class="nv">edge</span><span class="w"> </span><span class="nv">detection</span>
<span class="mi">5</span>.<span class="w"> </span><span class="nv">Hough</span><span class="w"> </span><span class="nv">transform</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">line</span><span class="w"> </span><span class="nv">detection</span>
<span class="mi">6</span>.<span class="w"> </span><span class="nv">Lane</span><span class="w"> </span><span class="nv">synthesis</span>
</code></pre></div>

<h3 id="step-by-step-implementation_1">Step-by-step Implementation<a class="header-link" href="#step-by-step-implementation_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LaneDetector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Lane Detector&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">region_of_interest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Region of interest masking (road area only)&quot;&quot;&quot;</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Trapezoidal ROI</span>
        <span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span>
            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">height</span><span class="p">),</span>           <span class="c1"># Bottom-left</span>
            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">)),</span> <span class="c1"># Top-left</span>
            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">)),</span> <span class="c1"># Top-right</span>
            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">),</span> <span class="n">height</span><span class="p">)</span>            <span class="c1"># Bottom-right</span>
        <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">fillPoly</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">fillPoly</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

        <span class="n">masked</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">masked</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">color_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Color filter (white/yellow lanes)&quot;&quot;&quot;</span>
        <span class="c1"># HSV conversion</span>
        <span class="n">hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">)</span>

        <span class="c1"># White mask</span>
        <span class="n">lower_white</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
        <span class="n">upper_white</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">255</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">255</span><span class="p">])</span>
        <span class="n">white_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">lower_white</span><span class="p">,</span> <span class="n">upper_white</span><span class="p">)</span>

        <span class="c1"># Yellow mask</span>
        <span class="n">lower_yellow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">15</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
        <span class="n">upper_yellow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">35</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">])</span>
        <span class="n">yellow_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">lower_yellow</span><span class="p">,</span> <span class="n">upper_yellow</span><span class="p">)</span>

        <span class="c1"># Combine masks</span>
        <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">(</span><span class="n">white_mask</span><span class="p">,</span> <span class="n">yellow_mask</span><span class="p">)</span>

        <span class="c1"># Apply mask</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">combined_mask</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filtered</span><span class="p">,</span> <span class="n">combined_mask</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Edge detection&quot;&quot;&quot;</span>
        <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">blur</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Canny</span><span class="p">(</span><span class="n">blur</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">edges</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edges</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Line detection using Hough transform&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">HoughLinesP</span><span class="p">(</span>
            <span class="n">edges</span><span class="p">,</span>
            <span class="n">rho</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>              <span class="c1"># Distance resolution (pixels)</span>
            <span class="n">theta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">,</span>    <span class="c1"># Angle resolution (radians)</span>
            <span class="n">threshold</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>       <span class="c1"># Minimum votes</span>
            <span class="n">minLineLength</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>   <span class="c1"># Minimum line length</span>
            <span class="n">maxLineGap</span><span class="o">=</span><span class="mi">150</span>      <span class="c1"># Maximum gap</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">separate_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">img_width</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Separate left/right lanes&quot;&quot;&quot;</span>
        <span class="n">left_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">right_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">lines</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">left_lines</span><span class="p">,</span> <span class="n">right_lines</span>

        <span class="n">center</span> <span class="o">=</span> <span class="n">img_width</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Calculate slope</span>
            <span class="k">if</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>

            <span class="c1"># Ignore if slope is too small (horizontal line)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Left/right classification</span>
            <span class="k">if</span> <span class="n">slope</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x1</span> <span class="o">&lt;</span> <span class="n">center</span> <span class="ow">and</span> <span class="n">x2</span> <span class="o">&lt;</span> <span class="n">center</span><span class="p">:</span>
                <span class="n">left_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">slope</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x1</span> <span class="o">&gt;</span> <span class="n">center</span> <span class="ow">and</span> <span class="n">x2</span> <span class="o">&gt;</span> <span class="n">center</span><span class="p">:</span>
                <span class="n">right_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">left_lines</span><span class="p">,</span> <span class="n">right_lines</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">average_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">img_height</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Average multiple line segments into one line&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">x_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y_coords</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">line</span>
            <span class="n">x_coords</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">])</span>
            <span class="n">y_coords</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>

        <span class="c1"># Linear regression (1st degree polynomial fitting)</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">y_coords</span><span class="p">,</span> <span class="n">x_coords</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Set y range</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">img_height</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_height</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">)</span>

        <span class="c1"># Calculate x coordinates</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">y1</span><span class="p">))</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw_lanes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">left_line</span><span class="p">,</span> <span class="n">right_line</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Draw lanes&quot;&quot;&quot;</span>
        <span class="n">overlay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="c1"># Draw lanes</span>
        <span class="k">if</span> <span class="n">left_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="p">(</span><span class="n">left_line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">left_line</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="n">left_line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">left_line</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">right_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="p">(</span><span class="n">right_line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">right_line</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="n">right_line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">right_line</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Fill lane area</span>
        <span class="k">if</span> <span class="n">left_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">right_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="p">[</span><span class="n">left_line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">left_line</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                <span class="p">[</span><span class="n">left_line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">left_line</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
                <span class="p">[</span><span class="n">right_line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">right_line</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
                <span class="p">[</span><span class="n">right_line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">right_line</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

            <span class="n">cv2</span><span class="o">.</span><span class="n">fillPoly</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="p">[</span><span class="n">pts</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Blend with original</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">overlay</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Complete lane detection pipeline&quot;&quot;&quot;</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># 1. Color filtering</span>
        <span class="n">filtered</span><span class="p">,</span> <span class="n">color_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_filter</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="c1"># 2. Edge detection</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_edges</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span>

        <span class="c1"># 3. Apply ROI</span>
        <span class="n">roi_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_of_interest</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>

        <span class="c1"># 4. Line detection</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_lines</span><span class="p">(</span><span class="n">roi_edges</span><span class="p">)</span>

        <span class="c1"># 5. Separate left/right lanes</span>
        <span class="n">left_lines</span><span class="p">,</span> <span class="n">right_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separate_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

        <span class="c1"># 6. Calculate average lanes</span>
        <span class="n">left_lane</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_line</span><span class="p">(</span><span class="n">left_lines</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">right_lane</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_line</span><span class="p">(</span><span class="n">right_lines</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

        <span class="c1"># 7. Visualize results</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_lanes</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">left_lane</span><span class="p">,</span> <span class="n">right_lane</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;edges&#39;</span><span class="p">:</span> <span class="n">roi_edges</span><span class="p">,</span>
            <span class="s1">&#39;color_mask&#39;</span><span class="p">:</span> <span class="n">color_mask</span><span class="p">,</span>
            <span class="s1">&#39;left_lane&#39;</span><span class="p">:</span> <span class="n">left_lane</span><span class="p">,</span>
            <span class="s1">&#39;right_lane&#39;</span><span class="p">:</span> <span class="n">right_lane</span>
        <span class="p">}</span>

<span class="c1"># Usage example</span>
<span class="n">detector</span> <span class="o">=</span> <span class="n">LaneDetector</span><span class="p">()</span>

<span class="c1"># Lane detection from image</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;road.jpg&#39;</span><span class="p">)</span>
<span class="n">result</span><span class="p">,</span> <span class="n">debug</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

<span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Lane Detection&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Edges&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">])</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>

<h3 id="video-lane-detection">Video Lane Detection<a class="header-link" href="#video-lane-detection" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">video_lane_detection</span><span class="p">(</span><span class="n">video_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Lane detection from video&quot;&quot;&quot;</span>

    <span class="n">detector</span> <span class="o">=</span> <span class="n">LaneDetector</span><span class="p">()</span>
    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>

    <span class="c1"># Output video setup</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">))</span>
    <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">))</span>
    <span class="n">fps</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)</span>

    <span class="n">fourcc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="o">*</span><span class="s1">&#39;mp4v&#39;</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="s1">&#39;lane_output.mp4&#39;</span><span class="p">,</span> <span class="n">fourcc</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>

    <span class="c1"># Previous frame lanes (for smoothing)</span>
    <span class="n">prev_left</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">prev_right</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span>  <span class="c1"># Smoothing coefficient</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">result</span><span class="p">,</span> <span class="n">debug</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># Lane smoothing (prevent abrupt changes)</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">debug</span><span class="p">[</span><span class="s1">&#39;left_lane&#39;</span><span class="p">]</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">debug</span><span class="p">[</span><span class="s1">&#39;right_lane&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">prev_left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">prev_left</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">left</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">prev_right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">prev_right</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">right</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>

        <span class="n">prev_left</span> <span class="o">=</span> <span class="n">left</span>
        <span class="n">prev_right</span> <span class="o">=</span> <span class="n">right</span>

        <span class="c1"># Redraw with smoothed lanes</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">draw_lanes</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>

        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Lane Detection&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="n">out</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>

<span class="c1"># Run</span>
<span class="c1"># video_lane_detection(&#39;driving.mp4&#39;)</span>
</code></pre></div>

<hr />
<h2 id="project-3-ar-marker-detection">Project 3: AR Marker Detection<a class="header-link" href="#project-3-ar-marker-detection" title="Permanent link">&para;</a></h2>
<h3 id="project-overview_2">Project Overview<a class="header-link" href="#project-overview_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>AR Marker Detection:
Detect square markers in images and composite 3D objects

Marker structure:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚
â”‚ â–ˆ                â–ˆ â”‚
â”‚ â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ â”‚
â”‚ â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ â”‚
â”‚ â–ˆ                â–ˆ â”‚
â”‚ â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ â”‚
â”‚ â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ â”‚
â”‚ â–ˆ                â–ˆ â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Processing steps:
1. Square contour detection
2. Normalize marker with perspective transform
3. Marker ID recognition
4. Project 3D object using homography
</code></pre></div>

<h3 id="step-by-step-implementation_2">Step-by-step Implementation<a class="header-link" href="#step-by-step-implementation_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ARMarkerDetector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;AR Marker Detector&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">marker_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marker_size</span> <span class="o">=</span> <span class="n">marker_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">order_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Order 4 points in sequence&quot;&quot;&quot;</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>  <span class="c1"># Top-left</span>
        <span class="n">rect</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>  <span class="c1"># Bottom-right</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">diff</span><span class="p">)]</span>  <span class="c1"># Top-right</span>
        <span class="n">rect</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">diff</span><span class="p">)]</span>  <span class="c1"># Bottom-left</span>

        <span class="k">return</span> <span class="n">rect</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_markers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find marker candidates&quot;&quot;&quot;</span>
        <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">blur</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Adaptive thresholding</span>
        <span class="n">binary</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">adaptiveThreshold</span><span class="p">(</span>
            <span class="n">blur</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">ADAPTIVE_THRESH_GAUSSIAN_C</span><span class="p">,</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY_INV</span><span class="p">,</span>
            <span class="mi">11</span><span class="p">,</span> <span class="mi">2</span>
        <span class="p">)</span>

        <span class="c1"># Contour detection</span>
        <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_LIST</span><span class="p">,</span>
                                        <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>

        <span class="n">markers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
            <span class="c1"># Area filter</span>
            <span class="n">area</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">area</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="ow">or</span> <span class="n">area</span> <span class="o">&gt;</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Polygon approximation</span>
            <span class="n">peri</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">arcLength</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">approx</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">approxPolyDP</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="mf">0.04</span> <span class="o">*</span> <span class="n">peri</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Only quadrilaterals</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">approx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="c1"># Check convex polygon</span>
                <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">isContourConvex</span><span class="p">(</span><span class="n">approx</span><span class="p">):</span>
                    <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">approx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">markers</span><span class="p">,</span> <span class="n">binary</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_marker_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corners</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform matrix for marker normalization&quot;&quot;&quot;</span>
        <span class="n">ordered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_points</span><span class="p">(</span><span class="n">corners</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

        <span class="n">dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">marker_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">marker_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">M</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getPerspectiveTransform</span><span class="p">(</span><span class="n">ordered</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">M</span><span class="p">,</span> <span class="n">ordered</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decode_marker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warped</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decode marker ID (simple example)&quot;&quot;&quot;</span>
        <span class="c1"># Convert to grayscale</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">warped</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">warped</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">warped</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

        <span class="c1"># Binarization</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">warped</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>

        <span class="c1"># Divide into 5x5 grid (edges are black border)</span>
        <span class="n">grid_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marker_size</span> <span class="o">//</span> <span class="mi">5</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">binary</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">grid_size</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">grid_size</span><span class="p">,</span>
                             <span class="n">j</span><span class="o">*</span><span class="n">grid_size</span><span class="p">:(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">grid_size</span><span class="p">]</span>
                <span class="c1"># Determine 0/1 based on cell average brightness</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">127</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Simple ID calculation (inner 3x3 region)</span>
        <span class="n">inner</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">marker_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">marker_id</span> <span class="o">=</span> <span class="n">marker_id</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">inner</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">marker_id</span><span class="p">,</span> <span class="n">grid</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Draw 3D cube on marker&quot;&quot;&quot;</span>
        <span class="c1"># 4 points of marker plane</span>
        <span class="n">corners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_points</span><span class="p">(</span><span class="n">corners</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

        <span class="c1"># Bottom face coordinates</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="n">corners</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Calculate top face coordinates (simple approximation using homography)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corners</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Top face shrinks toward marker center + moves up</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.7</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">size</span><span class="p">])</span>  <span class="c1"># Move up</span>

        <span class="n">top</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">corners</span><span class="p">:</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">pt</span> <span class="o">-</span> <span class="n">center</span>
            <span class="n">new_pt</span> <span class="o">=</span> <span class="n">center</span> <span class="o">+</span> <span class="n">vec</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">offset</span>
            <span class="n">top</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_pt</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>

        <span class="c1"># Draw faces (semi-transparent)</span>
        <span class="n">overlay</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Top face (red)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">fillPoly</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="p">[</span><span class="n">top</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>

        <span class="c1"># Side faces (green)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bottom</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bottom</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">4</span><span class="p">],</span>
                           <span class="n">top</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">4</span><span class="p">],</span> <span class="n">top</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">fillPoly</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="p">[</span><span class="n">pts</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Blend</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">overlay</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Draw edges</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bottom</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bottom</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">4</span><span class="p">]),</span>
                    <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">top</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">top</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">4</span><span class="p">]),</span>
                    <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bottom</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">top</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                    <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Marker detection and AR rendering&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">markers</span><span class="p">,</span> <span class="n">binary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_markers</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="n">detected_markers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">corners</span> <span class="ow">in</span> <span class="n">markers</span><span class="p">:</span>
            <span class="c1"># Normalize marker</span>
            <span class="n">M</span><span class="p">,</span> <span class="n">ordered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_marker_transform</span><span class="p">(</span><span class="n">corners</span><span class="p">)</span>
            <span class="n">warped</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpPerspective</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span>
                                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">marker_size</span><span class="p">))</span>

            <span class="c1"># Decode marker ID</span>
            <span class="n">marker_id</span><span class="p">,</span> <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_marker</span><span class="p">(</span><span class="n">warped</span><span class="p">)</span>

            <span class="c1"># Border check (edges should be black)</span>
            <span class="n">border_check</span> <span class="o">=</span> <span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">grid</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span>
                           <span class="n">grid</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">grid</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">border_check</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># Mostly black</span>
                <span class="n">detected_markers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">marker_id</span><span class="p">,</span>
                    <span class="s1">&#39;corners&#39;</span><span class="p">:</span> <span class="n">ordered</span>
                <span class="p">})</span>

                <span class="c1"># Draw 3D cube</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_cube</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ordered</span><span class="p">)</span>

                <span class="c1"># Display ID</span>
                <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ordered</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ID: </span><span class="si">{</span><span class="n">marker_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">center</span><span class="p">),</span>
                           <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">detected_markers</span><span class="p">,</span> <span class="n">binary</span>

<span class="c1"># Usage example</span>
<span class="n">detector</span> <span class="o">=</span> <span class="n">ARMarkerDetector</span><span class="p">()</span>

<span class="c1"># Detect markers from image</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;ar_marker.jpg&#39;</span><span class="p">)</span>
<span class="n">result</span><span class="p">,</span> <span class="n">markers</span><span class="p">,</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected markers: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">markers</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">markers</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ID: </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;AR Detection&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Binary&#39;</span><span class="p">,</span> <span class="n">binary</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>

<h3 id="using-aruco-markers-opencv-built-in">Using ArUco Markers (OpenCV Built-in)<a class="header-link" href="#using-aruco-markers-opencv-built-in" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">aruco_marker_detection</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OpenCV ArUco marker detection&quot;&quot;&quot;</span>

    <span class="c1"># Select ArUco dictionary</span>
    <span class="n">aruco_dict</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">aruco</span><span class="o">.</span><span class="n">getPredefinedDictionary</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">aruco</span><span class="o">.</span><span class="n">DICT_4X4_50</span><span class="p">)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">aruco</span><span class="o">.</span><span class="n">DetectorParameters</span><span class="p">()</span>

    <span class="n">detector</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">aruco</span><span class="o">.</span><span class="n">ArucoDetector</span><span class="p">(</span><span class="n">aruco_dict</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># Detect markers</span>
        <span class="n">corners</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">rejected</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">detectMarkers</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># Visualize results</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">aruco</span><span class="o">.</span><span class="n">drawDetectedMarkers</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">corner</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corners</span><span class="p">):</span>
                <span class="c1"># Draw cube or axis on each marker</span>
                <span class="c1"># (if camera calibration is available)</span>
                <span class="k">pass</span>

        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;ArUco Detection&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_aruco_marker</span><span class="p">(</span><span class="n">marker_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate ArUco marker&quot;&quot;&quot;</span>
    <span class="n">aruco_dict</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">aruco</span><span class="o">.</span><span class="n">getPredefinedDictionary</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">aruco</span><span class="o">.</span><span class="n">DICT_4X4_50</span><span class="p">)</span>
    <span class="n">marker_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">aruco</span><span class="o">.</span><span class="n">generateImageMarker</span><span class="p">(</span><span class="n">aruco_dict</span><span class="p">,</span> <span class="n">marker_id</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;aruco_marker_</span><span class="si">{</span><span class="n">marker_id</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">,</span> <span class="n">marker_img</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">marker_img</span>

<span class="c1"># Generate marker</span>
<span class="c1"># marker = generate_aruco_marker(0)</span>
<span class="c1"># cv2.imshow(&#39;Marker&#39;, marker)</span>
</code></pre></div>

<hr />
<h2 id="project-4-real-time-face-filter">Project 4: Real-time Face Filter<a class="header-link" href="#project-4-real-time-face-filter" title="Permanent link">&para;</a></h2>
<h3 id="project-overview_3">Project Overview<a class="header-link" href="#project-overview_3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Real-time Face Filter:
Apply filter effects based on facial landmarks

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    â”‚
â”‚        Sunglasses Filter           â”‚
â”‚       /â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾\           â”‚
â”‚      â”‚  â—â”€â”€â”€â”€â”€â”€â”€â”€â—   â”‚           â”‚
â”‚      â”‚   \      /    â”‚           â”‚
â”‚       \    â–½       /            â”‚
â”‚        \   âˆª     /              â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Technologies used:
- dlib facial landmarks (68 points)
- Transparent image compositing
- Affine/perspective transform
- Real-time processing optimization
</code></pre></div>

<h3 id="step-by-step-implementation_3">Step-by-step Implementation<a class="header-link" href="#step-by-step-implementation_3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dlib</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FaceFilter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Real-time Face Filter&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictor_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">get_frontal_face_detector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">shape_predictor</span><span class="p">(</span><span class="n">predictor_path</span><span class="p">)</span>

        <span class="c1"># Filter images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">image_path</span><span class="p">,</span> <span class="n">alpha_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load filter image (PNG with alpha recommended)&quot;&quot;&quot;</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_UNCHANGED</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># Already has alpha channel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add alpha channel (make white background transparent)</span>
            <span class="k">if</span> <span class="n">alpha_path</span><span class="p">:</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">alpha_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span>
                                         <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY_INV</span><span class="p">)</span>

            <span class="n">b</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">b</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">alpha</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_landmarks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">face</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract facial landmarks&quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">face</span><span class="p">)</span>
        <span class="n">landmarks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">shape</span><span class="o">.</span><span class="n">part</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="o">.</span><span class="n">part</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">y</span><span class="p">]</span>
                              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">68</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">landmarks</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">overlay_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">overlay</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Composite transparent image&quot;&quot;&quot;</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Boundary check</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">overlay</span> <span class="o">=</span> <span class="n">overlay</span><span class="p">[:,</span> <span class="o">-</span><span class="n">x</span><span class="p">:]</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">overlay</span> <span class="o">=</span> <span class="n">overlay</span><span class="p">[</span><span class="o">-</span><span class="n">y</span><span class="p">:,</span> <span class="p">:]</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">bh</span><span class="p">,</span> <span class="n">bw</span> <span class="o">=</span> <span class="n">background</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="n">bw</span><span class="p">:</span>
            <span class="n">overlay</span> <span class="o">=</span> <span class="n">overlay</span><span class="p">[:,</span> <span class="p">:</span><span class="n">bw</span> <span class="o">-</span> <span class="n">x</span><span class="p">]</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="n">bh</span><span class="p">:</span>
            <span class="n">overlay</span> <span class="o">=</span> <span class="n">overlay</span><span class="p">[:</span><span class="n">bh</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">h</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">background</span>

        <span class="c1"># Alpha blending</span>
        <span class="n">overlay_rgb</span> <span class="o">=</span> <span class="n">overlay</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">overlay</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">255.0</span>

        <span class="n">roi</span> <span class="o">=</span> <span class="n">background</span><span class="p">[</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">roi</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">overlay_rgb</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">]</span> <span class="o">+</span>
                           <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">roi</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">])</span>

        <span class="n">background</span><span class="p">[</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">roi</span>

        <span class="k">return</span> <span class="n">background</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_sunglasses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">landmarks</span><span class="p">,</span> <span class="n">filter_img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply sunglasses filter&quot;&quot;&quot;</span>
        <span class="c1"># Eye coordinates</span>
        <span class="n">left_eye</span> <span class="o">=</span> <span class="n">landmarks</span><span class="p">[</span><span class="mi">36</span><span class="p">:</span><span class="mi">42</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">right_eye</span> <span class="o">=</span> <span class="n">landmarks</span><span class="p">[</span><span class="mi">42</span><span class="p">:</span><span class="mi">48</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Eye distance and angle</span>
        <span class="n">eye_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">right_eye</span> <span class="o">-</span> <span class="n">left_eye</span><span class="p">)</span>
        <span class="n">eye_center</span> <span class="o">=</span> <span class="p">((</span><span class="n">left_eye</span> <span class="o">+</span> <span class="n">right_eye</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">right_eye</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">left_eye</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="n">right_eye</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">left_eye</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Resize sunglasses</span>
        <span class="n">filter_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">eye_width</span> <span class="o">*</span> <span class="mf">2.5</span><span class="p">)</span>
        <span class="n">filter_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">filter_width</span> <span class="o">*</span> <span class="n">filter_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span>
                           <span class="n">filter_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">resized_filter</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">filter_img</span><span class="p">,</span> <span class="p">(</span><span class="n">filter_width</span><span class="p">,</span> <span class="n">filter_height</span><span class="p">))</span>

        <span class="c1"># Rotate</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getRotationMatrix2D</span><span class="p">((</span><span class="n">filter_width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">filter_height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
                                    <span class="o">-</span><span class="n">angle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">rotated_filter</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpAffine</span><span class="p">(</span><span class="n">resized_filter</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span>
                                        <span class="p">(</span><span class="n">filter_width</span><span class="p">,</span> <span class="n">filter_height</span><span class="p">),</span>
                                        <span class="n">flags</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">,</span>
                                        <span class="n">borderMode</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span>
                                        <span class="n">borderValue</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Calculate position</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">eye_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">filter_width</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">eye_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">filter_height</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="c1"># Composite</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">rotated_filter</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_hat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">landmarks</span><span class="p">,</span> <span class="n">filter_img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply hat filter&quot;&quot;&quot;</span>
        <span class="c1"># Forehead position (above eyebrows)</span>
        <span class="n">left_brow</span> <span class="o">=</span> <span class="n">landmarks</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">22</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">right_brow</span> <span class="o">=</span> <span class="n">landmarks</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">27</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">brow_center</span> <span class="o">=</span> <span class="p">((</span><span class="n">left_brow</span> <span class="o">+</span> <span class="n">right_brow</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">brow_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">right_brow</span> <span class="o">-</span> <span class="n">left_brow</span><span class="p">)</span>

        <span class="c1"># Hat size</span>
        <span class="n">hat_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">brow_width</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">hat_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hat_width</span> <span class="o">*</span> <span class="n">filter_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span>
                        <span class="n">filter_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">resized_hat</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">filter_img</span><span class="p">,</span> <span class="p">(</span><span class="n">hat_width</span><span class="p">,</span> <span class="n">hat_height</span><span class="p">))</span>

        <span class="c1"># Position (place above eyebrows)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">brow_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">hat_width</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">brow_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">hat_height</span>

        <span class="c1"># Composite</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">resized_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_mustache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">landmarks</span><span class="p">,</span> <span class="n">filter_img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply mustache filter&quot;&quot;&quot;</span>
        <span class="c1"># Below nose, above mouth</span>
        <span class="n">nose_tip</span> <span class="o">=</span> <span class="n">landmarks</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span>
        <span class="n">upper_lip</span> <span class="o">=</span> <span class="n">landmarks</span><span class="p">[</span><span class="mi">51</span><span class="p">]</span>

        <span class="n">center</span> <span class="o">=</span> <span class="p">((</span><span class="n">nose_tip</span> <span class="o">+</span> <span class="n">upper_lip</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Mustache size (based on mouth width)</span>
        <span class="n">mouth_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">landmarks</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">-</span> <span class="n">landmarks</span><span class="p">[</span><span class="mi">54</span><span class="p">])</span>
        <span class="n">mustache_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mouth_width</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span>
        <span class="n">mustache_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mustache_width</span> <span class="o">*</span> <span class="n">filter_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span>
                             <span class="n">filter_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">filter_img</span><span class="p">,</span> <span class="p">(</span><span class="n">mustache_width</span><span class="p">,</span> <span class="n">mustache_height</span><span class="p">))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mustache_width</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mustache_height</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">resized</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">filter_name</span><span class="o">=</span><span class="s1">&#39;sunglasses&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply filter&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filter_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">img</span>

        <span class="n">rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
        <span class="n">faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">:</span>
            <span class="n">landmarks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_landmarks</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">face</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">filter_name</span> <span class="o">==</span> <span class="s1">&#39;sunglasses&#39;</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_sunglasses</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">landmarks</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">filter_name</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">filter_name</span> <span class="o">==</span> <span class="s1">&#39;hat&#39;</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_hat</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">landmarks</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">filter_name</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">filter_name</span> <span class="o">==</span> <span class="s1">&#39;mustache&#39;</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_mustache</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">landmarks</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">filter_name</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Usage example</span>
<span class="k">def</span><span class="w"> </span><span class="nf">realtime_face_filter</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Real-time face filter&quot;&quot;&quot;</span>

    <span class="n">filter_app</span> <span class="o">=</span> <span class="n">FaceFilter</span><span class="p">(</span><span class="s1">&#39;shape_predictor_68_face_landmarks.dat&#39;</span><span class="p">)</span>

    <span class="c1"># Load filters (transparent PNG recommended)</span>
    <span class="n">filter_app</span><span class="o">.</span><span class="n">load_filter</span><span class="p">(</span><span class="s1">&#39;sunglasses&#39;</span><span class="p">,</span> <span class="s1">&#39;sunglasses.png&#39;</span><span class="p">)</span>
    <span class="c1"># filter_app.load_filter(&#39;hat&#39;, &#39;hat.png&#39;)</span>
    <span class="c1"># filter_app.load_filter(&#39;mustache&#39;, &#39;mustache.png&#39;)</span>

    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">current_filter</span> <span class="o">=</span> <span class="s1">&#39;sunglasses&#39;</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">filter_app</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">filter_idx</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Press &#39;n&#39; to change filter, &#39;q&#39; to quit&quot;</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Apply filter</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">filter_app</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">current_filter</span><span class="p">)</span>

        <span class="c1"># Display current filter</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Filter: </span><span class="si">{</span><span class="n">current_filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                   <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Face Filter&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

        <span class="n">key</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">):</span>
            <span class="n">filter_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">filter_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
            <span class="n">current_filter</span> <span class="o">=</span> <span class="n">filters</span><span class="p">[</span><span class="n">filter_idx</span><span class="p">]</span>

    <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>

<span class="c1"># Run</span>
<span class="c1"># realtime_face_filter()</span>
</code></pre></div>

<hr />
<h2 id="project-5-object-tracking-system">Project 5: Object Tracking System<a class="header-link" href="#project-5-object-tracking-system" title="Permanent link">&para;</a></h2>
<h3 id="project-overview_4">Project Overview<a class="header-link" href="#project-overview_4" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Object Tracking System:
Multi-object tracking combining background subtraction and Kalman filter

Processing flow:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frame   â”‚ â†’ â”‚ Backgroundâ”‚ â†’ â”‚ Contour â”‚ â†’ â”‚ Kalman  â”‚
â”‚ Input   â”‚    â”‚ Subtract â”‚    â”‚ Detect  â”‚    â”‚ Filter  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Result  â”‚ â† â”‚ ID      â”‚ â† â”‚Hungarianâ”‚ â† â”‚ Predict â”‚
â”‚ Output  â”‚    â”‚ Assign  â”‚    â”‚ Match   â”‚    â”‚ Positionâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="step-by-step-implementation_4">Step-by-step Implementation<a class="header-link" href="#step-by-step-implementation_4" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">linear_sum_assignment</span>

<span class="k">class</span><span class="w"> </span><span class="nc">KalmanTracker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Kalman filter-based single object tracker&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_pos</span><span class="p">):</span>
        <span class="c1"># Initialize Kalman filter</span>
        <span class="c1"># State vector: [x, y, vx, vy]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">KalmanFilter</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Transition matrix (constant velocity model)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span><span class="o">.</span><span class="n">transitionMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Measurement matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span><span class="o">.</span><span class="n">measurementMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Process noise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span><span class="o">.</span><span class="n">processNoiseCov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.03</span>

        <span class="c1"># Measurement noise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span><span class="o">.</span><span class="n">measurementNoiseCov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>

        <span class="c1"># Initial state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span><span class="o">.</span><span class="n">statePre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="n">initial_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">initial_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span><span class="o">.</span><span class="n">statePost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span><span class="o">.</span><span class="n">statePre</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of tracked frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hits</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Successful matches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_since_update</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Frames since last update</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict next position&quot;&quot;&quot;</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span><span class="o">.</span><span class="n">predict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_since_update</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">prediction</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measurement</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update state with measurement&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">measurement</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hits</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_since_update</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return current state&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span><span class="o">.</span><span class="n">statePost</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MultiObjectTracker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Multi-object tracking system&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">min_hits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_age</span> <span class="o">=</span> <span class="n">max_age</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_hits</span> <span class="o">=</span> <span class="n">min_hits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iou_threshold</span> <span class="o">=</span> <span class="n">iou_threshold</span>

        <span class="c1"># Background subtractor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bg_subtractor</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">createBackgroundSubtractorMOG2</span><span class="p">(</span>
            <span class="n">history</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">varThreshold</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">detectShadows</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Object detection using background subtraction&quot;&quot;&quot;</span>
        <span class="c1"># Background subtraction</span>
        <span class="n">fg_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bg_subtractor</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># Shadow removal</span>
        <span class="n">fg_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">fg_mask</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Noise removal</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getStructuringElement</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_ELLIPSE</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">fg_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="n">fg_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_OPEN</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
        <span class="n">fg_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="n">fg_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_CLOSE</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>

        <span class="c1"># Contour detection</span>
        <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">fg_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span>
                                        <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>

        <span class="n">detections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
            <span class="n">area</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">area</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>  <span class="c1"># Minimum area</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
                <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">detections</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;bbox&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span>
                    <span class="s1">&#39;center&#39;</span><span class="p">:</span> <span class="n">center</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">detections</span><span class="p">,</span> <span class="n">fg_mask</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iou</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox1</span><span class="p">,</span> <span class="n">bbox2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate IoU (Intersection over Union)&quot;&quot;&quot;</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">h1</span> <span class="o">=</span> <span class="n">bbox1</span>
        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">bbox2</span>

        <span class="n">xi1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
        <span class="n">yi1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
        <span class="n">xi2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">w1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">w2</span><span class="p">)</span>
        <span class="n">yi2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y1</span> <span class="o">+</span> <span class="n">h1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">+</span> <span class="n">h2</span><span class="p">)</span>

        <span class="n">inter_area</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xi2</span> <span class="o">-</span> <span class="n">xi1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">yi2</span> <span class="o">-</span> <span class="n">yi1</span><span class="p">)</span>

        <span class="n">box1_area</span> <span class="o">=</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">h1</span>
        <span class="n">box2_area</span> <span class="o">=</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">h2</span>

        <span class="n">union_area</span> <span class="o">=</span> <span class="n">box1_area</span> <span class="o">+</span> <span class="n">box2_area</span> <span class="o">-</span> <span class="n">inter_area</span>

        <span class="k">return</span> <span class="n">inter_area</span> <span class="o">/</span> <span class="n">union_area</span> <span class="k">if</span> <span class="n">union_area</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">associate_detections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detections</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Match detections with trackers (Hungarian algorithm)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">detections</span><span class="p">))),</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">detections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="p">)))</span>

        <span class="c1"># Calculate cost matrix (distance-based)</span>
        <span class="n">cost_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">detections</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">det</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">detections</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">tracker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="p">):</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;kalman&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">()</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">pred</span><span class="p">)</span>
                <span class="n">cost_matrix</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span>

        <span class="c1"># Optimal matching with Hungarian algorithm</span>
        <span class="n">row_indices</span><span class="p">,</span> <span class="n">col_indices</span> <span class="o">=</span> <span class="n">linear_sum_assignment</span><span class="p">(</span><span class="n">cost_matrix</span><span class="p">)</span>

        <span class="n">matched</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unmatched_detections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">detections</span><span class="p">)))</span>
        <span class="n">unmatched_trackers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">row_indices</span><span class="p">,</span> <span class="n">col_indices</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cost_matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># Distance threshold</span>
                <span class="n">matched</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>
                <span class="n">unmatched_detections</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">unmatched_trackers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">matched</span><span class="p">,</span> <span class="n">unmatched_detections</span><span class="p">,</span> <span class="n">unmatched_trackers</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update tracking&quot;&quot;&quot;</span>
        <span class="c1"># Object detection</span>
        <span class="n">detections</span><span class="p">,</span> <span class="n">fg_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_objects</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># Prediction</span>
        <span class="k">for</span> <span class="n">tracker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="p">:</span>
            <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;kalman&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">()</span>

        <span class="c1"># Matching</span>
        <span class="n">matched</span><span class="p">,</span> <span class="n">unmatched_dets</span><span class="p">,</span> <span class="n">unmatched_trks</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">associate_detections</span><span class="p">(</span><span class="n">detections</span><span class="p">)</span>

        <span class="c1"># Update matched trackers</span>
        <span class="k">for</span> <span class="n">det_idx</span><span class="p">,</span> <span class="n">trk_idx</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="p">[</span><span class="n">trk_idx</span><span class="p">][</span><span class="s1">&#39;kalman&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">detections</span><span class="p">[</span><span class="n">det_idx</span><span class="p">][</span><span class="s1">&#39;center&#39;</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="p">[</span><span class="n">trk_idx</span><span class="p">][</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">detections</span><span class="p">[</span><span class="n">det_idx</span><span class="p">][</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span>

        <span class="c1"># Create new trackers</span>
        <span class="k">for</span> <span class="n">det_idx</span> <span class="ow">in</span> <span class="n">unmatched_dets</span><span class="p">:</span>
            <span class="n">tracker</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_id</span><span class="p">,</span>
                <span class="s1">&#39;kalman&#39;</span><span class="p">:</span> <span class="n">KalmanTracker</span><span class="p">(</span><span class="n">detections</span><span class="p">[</span><span class="n">det_idx</span><span class="p">][</span><span class="s1">&#39;center&#39;</span><span class="p">]),</span>
                <span class="s1">&#39;bbox&#39;</span><span class="p">:</span> <span class="n">detections</span><span class="p">[</span><span class="n">det_idx</span><span class="p">][</span><span class="s1">&#39;bbox&#39;</span><span class="p">],</span>
                <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tracker</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_id</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Remove old trackers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span>
                        <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;kalman&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">time_since_update</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_age</span><span class="p">]</span>

        <span class="c1"># Return results</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tracker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;kalman&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hits</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_hits</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;bbox&#39;</span><span class="p">:</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;center&#39;</span><span class="p">:</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;kalman&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">fg_mask</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualize results&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>

            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ID: </span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span>
                       <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Display trajectory (center point)</span>
            <span class="n">center</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">frame</span>

<span class="c1"># Usage example</span>
<span class="k">def</span><span class="w"> </span><span class="nf">multi_object_tracking</span><span class="p">(</span><span class="n">video_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run multi-object tracking&quot;&quot;&quot;</span>

    <span class="n">tracker</span> <span class="o">=</span> <span class="n">MultiObjectTracker</span><span class="p">()</span>
    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># Update tracking</span>
        <span class="n">results</span><span class="p">,</span> <span class="n">fg_mask</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># Visualization</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

        <span class="c1"># Display info</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Objects: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                   <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Multi-Object Tracking&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Foreground Mask&#39;</span><span class="p">,</span> <span class="n">fg_mask</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>

<span class="c1"># Run</span>
<span class="c1"># multi_object_tracking(&#39;traffic.mp4&#39;)</span>
</code></pre></div>

<hr />
<h2 id="exercises-and-extension-ideas">Exercises and Extension Ideas<a class="header-link" href="#exercises-and-extension-ideas" title="Permanent link">&para;</a></h2>
<h3 id="project-1-document-scanner-extensions">Project 1: Document Scanner Extensions<a class="header-link" href="#project-1-document-scanner-extensions" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>OCR Integration</strong>: Integrate Tesseract OCR for text extraction</li>
<li><strong>Auto Color Correction</strong>: Improve document readability with histogram equalization</li>
<li><strong>Multi-page Support</strong>: Create PDF from continuous captures</li>
<li><strong>Handwriting Recognition</strong>: Digitize handwritten documents</li>
<li><strong>Receipt Parsing</strong>: Automatically extract amounts, dates, etc.</li>
</ol>
<h3 id="project-2-lane-detection-extensions">Project 2: Lane Detection Extensions<a class="header-link" href="#project-2-lane-detection-extensions" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Curved Lane Detection</strong>: 2nd/3rd degree polynomial fitting</li>
<li><strong>Lane Departure Warning</strong>: Compare vehicle center with lane center</li>
<li><strong>Night Mode</strong>: Adjust parameters based on lighting conditions</li>
<li><strong>Multi-lane Detection</strong>: Detect adjacent lanes</li>
<li><strong>Vehicle Detection Integration</strong>: Combine with YOLO for front car detection</li>
</ol>
<h3 id="project-3-ar-marker-extensions">Project 3: AR Marker Extensions<a class="header-link" href="#project-3-ar-marker-extensions" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>3D Model Rendering</strong>: Display 3D objects with OpenGL integration</li>
<li><strong>Multi-marker Interaction</strong>: Recognize relationships between markers</li>
<li><strong>Markerless AR</strong>: Plane detection-based AR</li>
<li><strong>Game Development</strong>: Simple AR game based on markers</li>
<li><strong>Furniture Placement Simulation</strong>: Place virtual furniture in real space</li>
</ol>
<h3 id="project-4-face-filter-extensions">Project 4: Face Filter Extensions<a class="header-link" href="#project-4-face-filter-extensions" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Expression Recognition</strong>: Detect smiles, eye blinks to change filters</li>
<li><strong>3D Filters</strong>: 3D transformation matching face pose</li>
<li><strong>Background Replacement</strong>: Replace only background with segmentation</li>
<li><strong>Face Swap</strong>: Exchange faces between two people</li>
<li><strong>Aging Filter</strong>: Face aging/de-aging effects</li>
</ol>
<h3 id="project-5-object-tracking-extensions">Project 5: Object Tracking Extensions<a class="header-link" href="#project-5-object-tracking-extensions" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Re-ID Feature</strong>: Re-identify objects that left and re-entered the frame</li>
<li><strong>Speed Measurement</strong>: Calculate actual speed after calibration</li>
<li><strong>Zone Intrusion Detection</strong>: Alert when entering specific areas</li>
<li><strong>Trajectory Analysis</strong>: Analyze movement patterns and detect anomalies</li>
<li><strong>Deep Learning Integration</strong>: Improve accuracy with YOLO + DeepSORT</li>
</ol>
<hr />
<h2 id="next-steps">Next Steps<a class="header-link" href="#next-steps" title="Permanent link">&para;</a></h2>
<p>You have mastered the basics of OpenCV and computer vision. For deeper learning, we recommend the following topics:</p>
<h3 id="deep-learning-frameworks">Deep Learning Frameworks<a class="header-link" href="#deep-learning-frameworks" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>PyTorch</strong>: Powerful for research and prototyping</li>
<li><strong>TensorFlow/Keras</strong>: Suitable for production deployment</li>
<li><strong>ONNX</strong>: Standard for model compatibility</li>
</ul>
<h3 id="advanced-computer-vision">Advanced Computer Vision<a class="header-link" href="#advanced-computer-vision" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Image Segmentation</strong>: U-Net, Mask R-CNN</li>
<li><strong>Pose Estimation</strong>: OpenPose, MediaPipe</li>
<li><strong>GAN-based Image Generation</strong>: StyleGAN, Pix2Pix</li>
<li><strong>3D Vision</strong>: Stereo vision, depth estimation</li>
</ul>
<h3 id="application-domains">Application Domains<a class="header-link" href="#application-domains" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Autonomous Driving</strong>: SLAM, sensor fusion</li>
<li><strong>Medical Imaging</strong>: CT/MRI analysis, disease detection</li>
<li><strong>Industrial Inspection</strong>: Defect detection, quality control</li>
<li><strong>Security/Surveillance</strong>: Anomaly detection, face recognition</li>
</ul>
<hr />
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://docs.opencv.org/4.x/d9/df8/tutorial_root.html">OpenCV Tutorials</a></li>
<li><a href="https://pyimagesearch.com/">PyImageSearch</a> - Practical project tutorials</li>
<li><a href="https://learnopencv.com/">Learn OpenCV</a> - Advanced examples</li>
<li><a href="https://google.github.io/mediapipe/">Mediapipe</a> - Google's ML solutions</li>
<li><a href="https://paperswithcode.com/">Papers With Code</a> - Latest research and code</li>
<li>Bradski, G., &amp; Kaehler, A. (2008). "Learning OpenCV"</li>
<li>Szeliski, R. (2010). "Computer Vision: Algorithms and Applications"</li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Computer_Vision/19_DNN_Module.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Deep Neural Network Module (DNN Module)</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Computer_Vision/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Computer_Vision/21_3D_Vision_Basics.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">3D Vision Basics</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}