{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Vision Basics - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Computer_Vision/">Computer Vision</a>
    <span class="separator">/</span>
    <span class="current">3D Vision Basics</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>3D Vision Basics</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Computer_Vision/20_Practical_Projects.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Practical Projects</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Computer_Vision/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Computer_Vision/22_Depth_Estimation.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Monocular Depth Estimation</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-3d-vision-overview">1. 3D Vision Overview</a><ul>
<li><a href="#goals-of-3d-vision">Goals of 3D Vision</a></li>
<li><a href="#understanding-coordinate-systems">Understanding Coordinate Systems</a></li>
</ul>
</li>
<li><a href="#2-stereo-vision-principles">2. Stereo Vision Principles</a><ul>
<li><a href="#epipolar-geometry">Epipolar Geometry</a></li>
<li><a href="#disparity-and-depth">Disparity and Depth</a></li>
<li><a href="#stereo-rectification">Stereo Rectification</a></li>
</ul>
</li>
<li><a href="#3-depth-map-generation">3. Depth Map Generation</a><ul>
<li><a href="#stereobm-block-matching">StereoBM (Block Matching)</a></li>
<li><a href="#stereosgbm-semi-global-block-matching">StereoSGBM (Semi-Global Block Matching)</a></li>
<li><a href="#improved-disparity-with-wls-filter">Improved Disparity with WLS Filter</a></li>
</ul>
</li>
<li><a href="#4-point-clouds">4. Point Clouds</a><ul>
<li><a href="#point-cloud-generation">Point Cloud Generation</a></li>
<li><a href="#point-cloud-processing">Point Cloud Processing</a></li>
</ul>
</li>
<li><a href="#5-open3d-basics">5. Open3D Basics</a><ul>
<li><a href="#open3d-installation-and-basic-usage">Open3D Installation and Basic Usage</a></li>
<li><a href="#mesh-reconstruction">Mesh Reconstruction</a></li>
<li><a href="#rgbd-image-processing">RGBD Image Processing</a></li>
</ul>
</li>
<li><a href="#6-3d-reconstruction">6. 3D Reconstruction</a><ul>
<li><a href="#multi-view-stereo-mvs-concept">Multi-View Stereo (MVS) Concept</a></li>
<li><a href="#essential-matrix-based-pose-estimation">Essential Matrix-based Pose Estimation</a></li>
<li><a href="#bundle-adjustment">Bundle Adjustment</a></li>
</ul>
</li>
<li><a href="#7-exercises">7. Exercises</a><ul>
<li><a href="#exercise-1-stereo-depth-estimation">Exercise 1: Stereo Depth Estimation</a></li>
<li><a href="#exercise-2-point-cloud-filtering">Exercise 2: Point Cloud Filtering</a></li>
<li><a href="#exercise-3-3d-reconstruction-from-two-views">Exercise 3: 3D Reconstruction from Two Views</a></li>
<li><a href="#exercise-4-mesh-reconstruction">Exercise 4: Mesh Reconstruction</a></li>
<li><a href="#exercise-5-real-time-stereo-vision">Exercise 5: Real-time Stereo Vision</a></li>
</ul>
</li>
<li><a href="#next-steps">Next Steps</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="3d-vision-basics">3D Vision Basics<a class="header-link" href="#3d-vision-basics" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="header-link" href="#overview" title="Permanent link">&para;</a></h2>
<p>3D vision is the technology for extracting and reconstructing three-dimensional information from 2D images. This covers the fundamentals of stereo vision, depth maps, point cloud processing, and 3D reconstruction.</p>
<p><strong>Difficulty</strong>: â­â­â­â­</p>
<p><strong>Prerequisites</strong>: Camera calibration, feature detection/matching, linear algebra</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-3d-vision-overview">3D Vision Overview</a></li>
<li><a href="#2-stereo-vision-principles">Stereo Vision Principles</a></li>
<li><a href="#3-depth-map-generation">Depth Map Generation</a></li>
<li><a href="#4-point-clouds">Point Clouds</a></li>
<li><a href="#5-open3d-basics">Open3D Basics</a></li>
<li><a href="#6-3d-reconstruction">3D Reconstruction</a></li>
<li><a href="#7-exercises">Exercises</a></li>
</ol>
<hr />
<h2 id="1-3d-vision-overview">1. 3D Vision Overview<a class="header-link" href="#1-3d-vision-overview" title="Permanent link">&para;</a></h2>
<h3 id="goals-of-3d-vision">Goals of 3D Vision<a class="header-link" href="#goals-of-3d-vision" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="mf">3</span><span class="n">D</span><span class="w"> </span><span class="n">Vision</span><span class="w"> </span><span class="n">Pipeline</span><span class="p">:</span>

<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2</span><span class="n">D</span><span class="w"> </span><span class="n">Image</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="n">Depth</span><span class="w"> </span><span class="n">Estimation</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="mf">3</span><span class="n">D</span><span class="w"> </span><span class="n">Reconstruction</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span><span class="w">                                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚</span><span class="w"> </span><span class="n">Depth</span><span class="w"> </span><span class="n">Info</span><span class="w">  </span><span class="err">â”‚â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="n">Cloud</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">            </span><span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                             </span><span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                             </span><span class="err">â–¼</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                      </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                      </span><span class="err">â”‚</span><span class="w">  </span><span class="mf">3</span><span class="n">D</span><span class="w"> </span><span class="n">Mesh</span><span class="w">    </span><span class="err">â”‚</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                      </span><span class="err">â”‚</span><span class="w">  </span><span class="mf">3</span><span class="n">D</span><span class="w"> </span><span class="n">Model</span><span class="w">   </span><span class="err">â”‚</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                      </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="n">Depth</span><span class="w"> </span><span class="n">Extraction</span><span class="w"> </span><span class="n">Methods</span><span class="p">:</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Method</span><span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Description</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Stereo</span><span class="w"> </span><span class="n">Vision</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Calculate</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">disparity</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="n">cams</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Structured</span><span class="w"> </span><span class="n">Light</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Measure</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">projecting</span><span class="w"> </span><span class="n">known</span><span class="w"> </span><span class="n">pattern</span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="kr">To</span><span class="n">F</span><span class="w"> </span><span class="p">(</span><span class="n">Time</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">Flight</span><span class="p">)</span><span class="err">â”‚</span><span class="w"> </span><span class="n">Measure</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">light</span><span class="w"> </span><span class="n">travel</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Monocular</span><span class="w"> </span><span class="n">Depth</span><span class="w"> </span><span class="n">Est</span><span class="mf">.</span><span class="err">â”‚</span><span class="w"> </span><span class="n">Predict</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="nb">sin</span><span class="n">gle</span><span class="w"> </span><span class="n">cam</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DL</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">LiDAR</span><span class="w">               </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Precise</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="n">measurement</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">laser</span><span class="w"> </span><span class="n">scan</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="understanding-coordinate-systems">Understanding Coordinate Systems<a class="header-link" href="#understanding-coordinate-systems" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Camera</span><span class="w"> </span><span class="n">Coordinate</span><span class="w"> </span><span class="n">System</span><span class="err">:</span>

<span class="w">        </span><span class="n">Y</span><span class="w"> </span><span class="p">(</span><span class="k">up</span><span class="p">)</span>
<span class="w">        </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”‚</span><span class="n">_________</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="p">(</span><span class="k">right</span><span class="p">)</span>
<span class="w">       </span><span class="o">/</span>
<span class="w">      </span><span class="o">/</span>
<span class="w">     </span><span class="n">Z</span><span class="w"> </span><span class="p">(</span><span class="nb">camera</span><span class="w"> </span><span class="n">forward</span><span class="w"> </span><span class="k">direction</span><span class="p">)</span>

<span class="n">World</span><span class="w"> </span><span class="n">Coordinate</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Camera</span><span class="w"> </span><span class="n">Coordinate</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="n">Transform</span><span class="err">:</span>
<span class="n">P_cam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">P_world</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">t</span>

<span class="n">Image</span><span class="w"> </span><span class="n">Coordinate</span><span class="w"> </span><span class="n">System</span><span class="err">:</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="bp">u</span><span class="w"> </span><span class="p">(</span><span class="n">horizontal</span><span class="p">,</span><span class="w"> </span><span class="n">pixels</span><span class="p">)</span>
<span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â—</span><span class="w"> </span><span class="p">(</span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">cy</span><span class="p">)</span><span class="w"> </span><span class="n">principal</span><span class="w"> </span><span class="n">point</span>
<span class="err">â”‚</span>
<span class="err">â–¼</span>
<span class="bp">v</span><span class="w"> </span><span class="p">(</span><span class="n">vertical</span><span class="p">,</span><span class="w"> </span><span class="n">pixels</span><span class="p">)</span>

<span class="mi">3</span><span class="n">D</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="mi">2</span><span class="n">D</span><span class="w"> </span><span class="n">Projection</span><span class="err">:</span>
<span class="bp">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="o">/</span><span class="n">Z</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cx</span>
<span class="bp">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Y</span><span class="o">/</span><span class="n">Z</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cy</span>
</code></pre></div>

<hr />
<h2 id="2-stereo-vision-principles">2. Stereo Vision Principles<a class="header-link" href="#2-stereo-vision-principles" title="Permanent link">&para;</a></h2>
<h3 id="epipolar-geometry">Epipolar Geometry<a class="header-link" href="#epipolar-geometry" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Epipolar</span><span class="w"> </span><span class="nl">Geometry</span><span class="p">:</span>

<span class="w">             </span><span class="n">Epipole</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="w">              </span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â—â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â—</span><span class="w"> </span><span class="n">Epipolar</span><span class="w"> </span><span class="n">line</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="n">P</span><span class="w">      </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w">   </span><span class="n">P</span><span class="s1">&#39;</span>
<span class="s1">   â”‚          â”‚          â”‚</span>
<span class="s1">   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="s1">       Left          Right</span>
<span class="s1">       Image         Image</span>

<span class="s1">If 3D point P projects to point p in the left image,</span>
<span class="s1">it projects to p&#39;</span><span class="w"> </span><span class="n">somewhere</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">epipolar</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nf">right</span><span class="w"> </span><span class="nc">image</span><span class="p">.</span>

<span class="k">Key</span><span class="w"> </span><span class="nl">Matrices</span><span class="p">:</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Matrix</span><span class="w">            </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Description</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Essential</span><span class="w"> </span><span class="n">Matrix</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Geometric</span><span class="w"> </span><span class="n">relationship</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">normalized</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="w">               </span><span class="err">â”‚</span><span class="w"> </span><span class="n">coordinates</span><span class="p">.</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">t</span><span class="o">]</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Fundamental</span><span class="w"> </span><span class="n">Matrix</span><span class="err">â”‚</span><span class="w"> </span><span class="n">Geometric</span><span class="w"> </span><span class="n">relationship</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">pixel</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">F</span><span class="p">)</span><span class="w">               </span><span class="err">â”‚</span><span class="w"> </span><span class="n">coordinates</span><span class="p">.</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K</span><span class="s1">&#39;^(-T) * E * K^(-1)   â”‚</span>
<span class="s1">â”‚                   â”‚ p&#39;</span><span class="o">^</span><span class="n">T</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="disparity-and-depth">Disparity and Depth<a class="header-link" href="#disparity-and-depth" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Stereo</span><span class="w"> </span><span class="n">Disparity</span><span class="err">:</span>

<span class="n">Left</span><span class="w"> </span><span class="n">Camera</span><span class="w">          </span><span class="n">Right</span><span class="w"> </span><span class="n">Camera</span>
<span class="w">    </span><span class="n">C_L</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="n">C_R</span>
<span class="w">     </span><span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="w">     </span><span class="err">â”‚</span><span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">baseline</span><span class="p">)</span><span class="w">    </span><span class="err">â”‚</span>
<span class="w">     </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º</span><span class="w"> </span><span class="err">â”‚</span>
<span class="w">     </span><span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="w">     </span><span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="w">     </span><span class="err">â–¼</span><span class="w">                    </span><span class="err">â–¼</span>
<span class="w">    </span><span class="n">p_L</span><span class="w">        </span><span class="n">d</span><span class="w">        </span><span class="n">p_R</span>
<span class="w">    </span><span class="err">â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">     </span><span class="n">Disparity</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">     </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x_L</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x_R</span><span class="w">   </span><span class="err">â”‚</span>

<span class="n">Depth</span><span class="w"> </span><span class="n">Calculation</span><span class="err">:</span>
<span class="n">Z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">d</span>

<span class="n">Where</span><span class="err">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">Z</span><span class="err">:</span><span class="w"> </span><span class="n">Depth</span><span class="w"> </span><span class="p">(</span><span class="k">distance</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="nb">camera</span><span class="p">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="err">:</span><span class="w"> </span><span class="n">Focal</span><span class="w"> </span><span class="n">length</span>
<span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="err">:</span><span class="w"> </span><span class="n">Baseline</span><span class="w"> </span><span class="p">(</span><span class="k">distance</span><span class="w"> </span><span class="n">between</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">cameras</span><span class="p">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">d</span><span class="err">:</span><span class="w"> </span><span class="n">Disparity</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="w"> </span><span class="n">pixels</span><span class="p">)</span>

<span class="n">Disparity</span><span class="w"> </span><span class="n">Range</span><span class="w"> </span><span class="n">Example</span><span class="err">:</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Distance</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Disparity</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">=</span><span class="mf">0.1</span><span class="n">m</span><span class="p">)</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">1</span><span class="n">m</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="n">pixels</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">5</span><span class="n">m</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">pixels</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">10</span><span class="n">m</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">pixels</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Infinity</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">pixels</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="stereo-rectification">Stereo Rectification<a class="header-link" href="#stereo-rectification" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">stereo_calibrate</span><span class="p">(</span><span class="n">obj_points</span><span class="p">,</span> <span class="n">img_points_left</span><span class="p">,</span> <span class="n">img_points_right</span><span class="p">,</span>
                     <span class="n">K1</span><span class="p">,</span> <span class="n">D1</span><span class="p">,</span> <span class="n">K2</span><span class="p">,</span> <span class="n">D2</span><span class="p">,</span> <span class="n">img_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stereo camera calibration&quot;&quot;&quot;</span>

    <span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CALIB_FIX_INTRINSIC</span> <span class="o">+</span>
             <span class="n">cv2</span><span class="o">.</span><span class="n">CALIB_RATIONAL_MODEL</span><span class="p">)</span>

    <span class="n">ret</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">D1</span><span class="p">,</span> <span class="n">K2</span><span class="p">,</span> <span class="n">D2</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">stereoCalibrate</span><span class="p">(</span>
        <span class="n">obj_points</span><span class="p">,</span>
        <span class="n">img_points_left</span><span class="p">,</span>
        <span class="n">img_points_right</span><span class="p">,</span>
        <span class="n">K1</span><span class="p">,</span> <span class="n">D1</span><span class="p">,</span>
        <span class="n">K2</span><span class="p">,</span> <span class="n">D2</span><span class="p">,</span>
        <span class="n">img_size</span><span class="p">,</span>
        <span class="n">flags</span><span class="o">=</span><span class="n">flags</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stereo calibration RMS error: </span><span class="si">{</span><span class="n">ret</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Rotation matrix R:</span><span class="se">\n</span><span class="si">{</span><span class="n">R</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Translation vector T:</span><span class="se">\n</span><span class="si">{</span><span class="n">T</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Baseline: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> units&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">F</span>

<span class="k">def</span><span class="w"> </span><span class="nf">stereo_rectify</span><span class="p">(</span><span class="n">K1</span><span class="p">,</span> <span class="n">D1</span><span class="p">,</span> <span class="n">K2</span><span class="p">,</span> <span class="n">D2</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stereo Rectification&quot;&quot;&quot;</span>

    <span class="c1"># Calculate rectification transform</span>
    <span class="n">R1</span><span class="p">,</span> <span class="n">R2</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">roi1</span><span class="p">,</span> <span class="n">roi2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">stereoRectify</span><span class="p">(</span>
        <span class="n">K1</span><span class="p">,</span> <span class="n">D1</span><span class="p">,</span>
        <span class="n">K2</span><span class="p">,</span> <span class="n">D2</span><span class="p">,</span>
        <span class="n">img_size</span><span class="p">,</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># 0: valid pixels only, 1: all pixels</span>
        <span class="n">newImageSize</span><span class="o">=</span><span class="n">img_size</span>
    <span class="p">)</span>

    <span class="c1"># Q matrix: used for disparity â†’ 3D conversion</span>
    <span class="c1"># [X Y Z W]^T = Q * [x y disparity 1]^T</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Q matrix (disparity â†’ 3D transform):&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">R1</span><span class="p">,</span> <span class="n">R2</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">roi1</span><span class="p">,</span> <span class="n">roi2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_rectification_maps</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">img_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate rectification maps&quot;&quot;&quot;</span>

    <span class="n">map1</span><span class="p">,</span> <span class="n">map2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">initUndistortRectifyMap</span><span class="p">(</span>
        <span class="n">K</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_32FC1</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">map1</span><span class="p">,</span> <span class="n">map2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rectify_stereo_pair</span><span class="p">(</span><span class="n">img_left</span><span class="p">,</span> <span class="n">img_right</span><span class="p">,</span> <span class="n">maps_left</span><span class="p">,</span> <span class="n">maps_right</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rectify stereo image pair&quot;&quot;&quot;</span>

    <span class="n">rect_left</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="n">img_left</span><span class="p">,</span> <span class="n">maps_left</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">maps_left</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                          <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>
    <span class="n">rect_right</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="n">img_right</span><span class="p">,</span> <span class="n">maps_right</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">maps_right</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rect_left</span><span class="p">,</span> <span class="n">rect_right</span>
</code></pre></div>

<hr />
<h2 id="3-depth-map-generation">3. Depth Map Generation<a class="header-link" href="#3-depth-map-generation" title="Permanent link">&para;</a></h2>
<h3 id="stereobm-block-matching">StereoBM (Block Matching)<a class="header-link" href="#stereobm-block-matching" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compute_disparity_bm</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">num_disparities</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">block_size</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute disparity map using StereoBM&quot;&quot;&quot;</span>

    <span class="c1"># Convert to grayscale</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

    <span class="c1"># Create StereoBM</span>
    <span class="n">stereo</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">StereoBM_create</span><span class="p">(</span>
        <span class="n">numDisparities</span><span class="o">=</span><span class="n">num_disparities</span><span class="p">,</span>  <span class="c1"># Multiple of 16</span>
        <span class="n">blockSize</span><span class="o">=</span><span class="n">block_size</span>              <span class="c1"># Odd number, 5~21</span>
    <span class="p">)</span>

    <span class="c1"># Parameter tuning (optional)</span>
    <span class="n">stereo</span><span class="o">.</span><span class="n">setMinDisparity</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">stereo</span><span class="o">.</span><span class="n">setSpeckleWindowSize</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">stereo</span><span class="o">.</span><span class="n">setSpeckleRange</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">stereo</span><span class="o">.</span><span class="n">setPreFilterType</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">STEREO_BM_PREFILTER_NORMALIZED_RESPONSE</span><span class="p">)</span>
    <span class="n">stereo</span><span class="o">.</span><span class="n">setPreFilterSize</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">stereo</span><span class="o">.</span><span class="n">setPreFilterCap</span><span class="p">(</span><span class="mi">31</span><span class="p">)</span>
    <span class="n">stereo</span><span class="o">.</span><span class="n">setTextureThreshold</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">stereo</span><span class="o">.</span><span class="n">setUniquenessRatio</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>

    <span class="c1"># Compute disparity</span>
    <span class="n">disparity</span> <span class="o">=</span> <span class="n">stereo</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>

    <span class="c1"># Normalize disparity values (scaled by 16)</span>
    <span class="n">disparity</span> <span class="o">=</span> <span class="n">disparity</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">16.0</span>

    <span class="k">return</span> <span class="n">disparity</span>

<span class="k">def</span><span class="w"> </span><span class="nf">visualize_disparity</span><span class="p">(</span><span class="n">disparity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize disparity map&quot;&quot;&quot;</span>

    <span class="c1"># Use only valid disparity</span>
    <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">disparity</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="c1"># Normalize</span>
    <span class="n">disp_vis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">disparity</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">):</span>
        <span class="n">disp_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">disparity</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span>
        <span class="n">disp_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">disparity</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span>
        <span class="n">disp_vis</span> <span class="o">=</span> <span class="p">(</span><span class="n">disparity</span> <span class="o">-</span> <span class="n">disp_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">disp_max</span> <span class="o">-</span> <span class="n">disp_min</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>

    <span class="n">disp_vis</span> <span class="o">=</span> <span class="n">disp_vis</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="c1"># Apply colormap</span>
    <span class="n">disp_color</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">applyColorMap</span><span class="p">(</span><span class="n">disp_vis</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLORMAP_JET</span><span class="p">)</span>

    <span class="c1"># Black out invalid regions</span>
    <span class="n">disp_color</span><span class="p">[</span><span class="o">~</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">disp_color</span>
</code></pre></div>

<h3 id="stereosgbm-semi-global-block-matching">StereoSGBM (Semi-Global Block Matching)<a class="header-link" href="#stereosgbm-semi-global-block-matching" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_disparity_sgbm</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">num_disparities</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">block_size</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute disparity map using StereoSGBM&quot;&quot;&quot;</span>

    <span class="c1"># Convert to grayscale</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">gray_left</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">gray_right</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gray_left</span><span class="p">,</span> <span class="n">gray_right</span> <span class="o">=</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span>

    <span class="c1"># SGBM parameters</span>
    <span class="c1"># P1, P2: Penalty for disparity difference between adjacent pixels</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">block_size</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">P2</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">block_size</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">stereo</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">StereoSGBM_create</span><span class="p">(</span>
        <span class="n">minDisparity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">numDisparities</span><span class="o">=</span><span class="n">num_disparities</span><span class="p">,</span>
        <span class="n">blockSize</span><span class="o">=</span><span class="n">block_size</span><span class="p">,</span>
        <span class="n">P1</span><span class="o">=</span><span class="n">P1</span><span class="p">,</span>
        <span class="n">P2</span><span class="o">=</span><span class="n">P2</span><span class="p">,</span>
        <span class="n">disp12MaxDiff</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">uniquenessRatio</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">speckleWindowSize</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">speckleRange</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">preFilterCap</span><span class="o">=</span><span class="mi">63</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">STEREO_SGBM_MODE_SGBM_3WAY</span>
    <span class="p">)</span>

    <span class="c1"># Compute disparity</span>
    <span class="n">disparity</span> <span class="o">=</span> <span class="n">stereo</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">gray_left</span><span class="p">,</span> <span class="n">gray_right</span><span class="p">)</span>
    <span class="n">disparity</span> <span class="o">=</span> <span class="n">disparity</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">16.0</span>

    <span class="k">return</span> <span class="n">disparity</span>

<span class="k">def</span><span class="w"> </span><span class="nf">disparity_to_depth</span><span class="p">(</span><span class="n">disparity</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert disparity map to depth map&quot;&quot;&quot;</span>

    <span class="c1"># 3D reprojection using Q matrix</span>
    <span class="c1"># points_3d[y, x] = [X, Y, Z, W]</span>
    <span class="n">points_3d</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">reprojectImageTo3D</span><span class="p">(</span><span class="n">disparity</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>

    <span class="c1"># Extract Z value (depth)</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">points_3d</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Filter invalid depth</span>
    <span class="n">valid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">disparity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="n">depth</span><span class="p">[</span><span class="o">~</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">depth</span><span class="p">,</span> <span class="n">points_3d</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_depth_colormap</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize depth map&quot;&quot;&quot;</span>

    <span class="c1"># Clip depth</span>
    <span class="n">depth_clipped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">)</span>

    <span class="c1"># Normalize (0-255)</span>
    <span class="n">depth_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth_clipped</span> <span class="o">/</span> <span class="n">max_depth</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="c1"># Apply colormap (close = red, far = blue)</span>
    <span class="n">depth_color</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">applyColorMap</span><span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="n">depth_norm</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLORMAP_JET</span><span class="p">)</span>

    <span class="c1"># Mask invalid regions</span>
    <span class="n">depth_color</span><span class="p">[</span><span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">depth_color</span>
</code></pre></div>

<h3 id="improved-disparity-with-wls-filter">Improved Disparity with WLS Filter<a class="header-link" href="#improved-disparity-with-wls-filter" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_disparity_with_wls</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">num_disparities</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute improved disparity map with WLS filter&quot;&quot;&quot;</span>

    <span class="c1"># Grayscale</span>
    <span class="n">gray_left</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">gray_right</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

    <span class="c1"># Left matcher</span>
    <span class="n">left_matcher</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">StereoSGBM_create</span><span class="p">(</span>
        <span class="n">minDisparity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">numDisparities</span><span class="o">=</span><span class="n">num_disparities</span><span class="p">,</span>
        <span class="n">blockSize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">P1</span><span class="o">=</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">P2</span><span class="o">=</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">disp12MaxDiff</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">uniquenessRatio</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
        <span class="n">speckleWindowSize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">speckleRange</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">preFilterCap</span><span class="o">=</span><span class="mi">63</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">STEREO_SGBM_MODE_SGBM_3WAY</span>
    <span class="p">)</span>

    <span class="c1"># Right matcher (for left-right consistency check)</span>
    <span class="n">right_matcher</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ximgproc</span><span class="o">.</span><span class="n">createRightMatcher</span><span class="p">(</span><span class="n">left_matcher</span><span class="p">)</span>

    <span class="c1"># Compute disparity</span>
    <span class="n">left_disp</span> <span class="o">=</span> <span class="n">left_matcher</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">gray_left</span><span class="p">,</span> <span class="n">gray_right</span><span class="p">)</span>
    <span class="n">right_disp</span> <span class="o">=</span> <span class="n">right_matcher</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">gray_right</span><span class="p">,</span> <span class="n">gray_left</span><span class="p">)</span>

    <span class="c1"># WLS filter</span>
    <span class="n">wls_filter</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ximgproc</span><span class="o">.</span><span class="n">createDisparityWLSFilter</span><span class="p">(</span><span class="n">left_matcher</span><span class="p">)</span>
    <span class="n">wls_filter</span><span class="o">.</span><span class="n">setLambda</span><span class="p">(</span><span class="mi">80000</span><span class="p">)</span>
    <span class="n">wls_filter</span><span class="o">.</span><span class="n">setSigmaColor</span><span class="p">(</span><span class="mf">1.2</span><span class="p">)</span>

    <span class="c1"># Apply filter</span>
    <span class="n">filtered_disp</span> <span class="o">=</span> <span class="n">wls_filter</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">left_disp</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">right_disp</span><span class="p">)</span>
    <span class="n">filtered_disp</span> <span class="o">=</span> <span class="n">filtered_disp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">16.0</span>

    <span class="k">return</span> <span class="n">filtered_disp</span>
</code></pre></div>

<hr />
<h2 id="4-point-clouds">4. Point Clouds<a class="header-link" href="#4-point-clouds" title="Permanent link">&para;</a></h2>
<h3 id="point-cloud-generation">Point Cloud Generation<a class="header-link" href="#point-cloud-generation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_point_cloud</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create point cloud from depth map and RGB image&quot;&quot;&quot;</span>

    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">K</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">K</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Pixel coordinate grid</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="c1"># Valid depth mask</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="c1"># Calculate 3D coordinates</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">-</span> <span class="n">cx</span><span class="p">)</span> <span class="o">*</span> <span class="n">Z</span> <span class="o">/</span> <span class="n">fx</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">-</span> <span class="n">cy</span><span class="p">)</span> <span class="o">*</span> <span class="n">Z</span> <span class="o">/</span> <span class="n">fy</span>

    <span class="c1"># Point cloud (N x 3)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Color information (N x 3)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rgb</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">rgb</span><span class="p">[</span><span class="n">valid</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">colors</span>

<span class="k">def</span><span class="w"> </span><span class="nf">subsample_point_cloud</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">voxel_size</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Downsample point cloud using voxel grid&quot;&quot;&quot;</span>

    <span class="c1"># Calculate voxel indices</span>
    <span class="n">voxel_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">points</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Select only unique voxels</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">unique_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
        <span class="n">voxel_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">points</span><span class="p">[</span><span class="n">unique_indices</span><span class="p">],</span> <span class="n">colors</span><span class="p">[</span><span class="n">unique_indices</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">save_point_cloud_ply</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save point cloud in PLY format&quot;&quot;&quot;</span>

    <span class="n">n_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

    <span class="c1"># PLY header</span>
    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;ply</span>
<span class="s2">format ascii 1.0</span>
<span class="s2">element vertex </span><span class="si">{</span><span class="n">n_points</span><span class="si">}</span>
<span class="s2">property float x</span>
<span class="s2">property float y</span>
<span class="s2">property float z</span>
<span class="s2">property uchar red</span>
<span class="s2">property uchar green</span>
<span class="s2">property uchar blue</span>
<span class="s2">end_header</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_points</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">z</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_points</span><span class="si">}</span><span class="s2"> points)&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="point-cloud-processing">Point Cloud Processing<a class="header-link" href="#point-cloud-processing" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_outliers_statistical</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">nb_neighbors</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">std_ratio</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Statistical outlier removal&quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">KDTree</span>

    <span class="c1"># Build KD-Tree</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

    <span class="c1"># Calculate k-NN distance for each point</span>
    <span class="n">distances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">nb_neighbors</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mean_distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distances</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Exclude self</span>

    <span class="c1"># Global mean and standard deviation</span>
    <span class="n">global_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mean_distances</span><span class="p">)</span>
    <span class="n">global_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">mean_distances</span><span class="p">)</span>

    <span class="c1"># Outlier mask</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">global_mean</span> <span class="o">+</span> <span class="n">std_ratio</span> <span class="o">*</span> <span class="n">global_std</span>
    <span class="n">inlier_mask</span> <span class="o">=</span> <span class="n">mean_distances</span> <span class="o">&lt;</span> <span class="n">threshold</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Outlier removal: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="si">}</span><span class="s2"> â†’ </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inlier_mask</span><span class="p">)</span><span class="si">}</span><span class="s2"> points&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">points</span><span class="p">[</span><span class="n">inlier_mask</span><span class="p">],</span> <span class="n">colors</span><span class="p">[</span><span class="n">inlier_mask</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">estimate_normals</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimate point cloud normal vectors&quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">KDTree</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">numpy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">eig</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">normals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
        <span class="c1"># k-NN search</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

        <span class="c1"># Covariance matrix</span>
        <span class="n">centered</span> <span class="o">=</span> <span class="n">neighbors</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">neighbors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">centered</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">centered</span><span class="p">)</span> <span class="o">/</span> <span class="n">k</span>

        <span class="c1"># Eigenvector of smallest eigenvalue is the normal</span>
        <span class="n">eigenvalues</span><span class="p">,</span> <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
        <span class="n">min_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">)</span>
        <span class="n">normals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">eigenvectors</span><span class="p">[:,</span> <span class="n">min_idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">normals</span>
</code></pre></div>

<hr />
<h2 id="5-open3d-basics">5. Open3D Basics<a class="header-link" href="#5-open3d-basics" title="Permanent link">&para;</a></h2>
<h3 id="open3d-installation-and-basic-usage">Open3D Installation and Basic Usage<a class="header-link" href="#open3d-installation-and-basic-usage" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># pip install open3d</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">open3d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">o3d</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_open3d_point_cloud</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create Open3D point cloud&quot;&quot;&quot;</span>

    <span class="n">pcd</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">PointCloud</span><span class="p">()</span>
    <span class="n">pcd</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">Vector3dVector</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Normalize colors to 0-1 range</span>
        <span class="k">if</span> <span class="n">colors</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span> <span class="o">/</span> <span class="mf">255.0</span>
        <span class="n">pcd</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">Vector3dVector</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pcd</span>

<span class="k">def</span><span class="w"> </span><span class="nf">visualize_point_cloud</span><span class="p">(</span><span class="n">pcd</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize point cloud&quot;&quot;&quot;</span>

    <span class="c1"># Add coordinate frame</span>
    <span class="n">coordinate_frame</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">TriangleMesh</span><span class="o">.</span><span class="n">create_coordinate_frame</span><span class="p">(</span>
        <span class="n">size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">o3d</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">draw_geometries</span><span class="p">(</span>
        <span class="p">[</span><span class="n">pcd</span><span class="p">,</span> <span class="n">coordinate_frame</span><span class="p">],</span>
        <span class="n">window_name</span><span class="o">=</span><span class="s2">&quot;Point Cloud&quot;</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">1280</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">720</span><span class="p">,</span>
        <span class="n">point_show_normal</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_point_cloud_open3d</span><span class="p">(</span><span class="n">pcd</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process point cloud with Open3D&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original point count: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pcd</span><span class="o">.</span><span class="n">points</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 1. Downsampling</span>
    <span class="n">pcd_down</span> <span class="o">=</span> <span class="n">pcd</span><span class="o">.</span><span class="n">voxel_down_sample</span><span class="p">(</span><span class="n">voxel_size</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After downsampling: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pcd_down</span><span class="o">.</span><span class="n">points</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 2. Outlier removal</span>
    <span class="n">pcd_clean</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pcd_down</span><span class="o">.</span><span class="n">remove_statistical_outlier</span><span class="p">(</span>
        <span class="n">nb_neighbors</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">std_ratio</span><span class="o">=</span><span class="mf">2.0</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After outlier removal: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pcd_clean</span><span class="o">.</span><span class="n">points</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 3. Normal estimation</span>
    <span class="n">pcd_clean</span><span class="o">.</span><span class="n">estimate_normals</span><span class="p">(</span>
        <span class="n">search_param</span><span class="o">=</span><span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">KDTreeSearchParamHybrid</span><span class="p">(</span>
            <span class="n">radius</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_nn</span><span class="o">=</span><span class="mi">30</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># 4. Orient normals consistently</span>
    <span class="n">pcd_clean</span><span class="o">.</span><span class="n">orient_normals_consistent_tangent_plane</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pcd_clean</span>
</code></pre></div>

<h3 id="mesh-reconstruction">Mesh Reconstruction<a class="header-link" href="#mesh-reconstruction" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reconstruct_mesh_poisson</span><span class="p">(</span><span class="n">pcd</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Poisson surface reconstruction&quot;&quot;&quot;</span>

    <span class="c1"># Normals required</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pcd</span><span class="o">.</span><span class="n">has_normals</span><span class="p">():</span>
        <span class="n">pcd</span><span class="o">.</span><span class="n">estimate_normals</span><span class="p">()</span>
        <span class="n">pcd</span><span class="o">.</span><span class="n">orient_normals_consistent_tangent_plane</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="c1"># Poisson reconstruction</span>
    <span class="n">mesh</span><span class="p">,</span> <span class="n">densities</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">TriangleMesh</span><span class="o">.</span><span class="n">create_from_point_cloud_poisson</span><span class="p">(</span>
        <span class="n">pcd</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span>
    <span class="p">)</span>

    <span class="c1"># Remove low-density regions</span>
    <span class="n">densities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">densities</span><span class="p">)</span>
    <span class="n">density_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">densities</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="n">vertices_to_remove</span> <span class="o">=</span> <span class="n">densities</span> <span class="o">&lt;</span> <span class="n">density_threshold</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">remove_vertices_by_mask</span><span class="p">(</span><span class="n">vertices_to_remove</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mesh vertices: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mesh triangles: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">triangles</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mesh</span>

<span class="k">def</span><span class="w"> </span><span class="nf">reconstruct_mesh_ball_pivoting</span><span class="p">(</span><span class="n">pcd</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ball pivoting surface reconstruction&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pcd</span><span class="o">.</span><span class="n">has_normals</span><span class="p">():</span>
        <span class="n">pcd</span><span class="o">.</span><span class="n">estimate_normals</span><span class="p">()</span>

    <span class="c1"># Estimate radii</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">pcd</span><span class="o">.</span><span class="n">compute_nearest_neighbor_distance</span><span class="p">()</span>
    <span class="n">avg_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">avg_dist</span><span class="p">,</span> <span class="n">avg_dist</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">avg_dist</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span>

    <span class="n">mesh</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">TriangleMesh</span><span class="o">.</span><span class="n">create_from_point_cloud_ball_pivoting</span><span class="p">(</span>
        <span class="n">pcd</span><span class="p">,</span> <span class="n">o3d</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">DoubleVector</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">mesh</span>

<span class="k">def</span><span class="w"> </span><span class="nf">save_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save mesh&quot;&quot;&quot;</span>
    <span class="n">o3d</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_triangle_mesh</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mesh saved: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="rgbd-image-processing">RGBD Image Processing<a class="header-link" href="#rgbd-image-processing" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_rgbd_from_opencv</span><span class="p">(</span><span class="n">color_img</span><span class="p">,</span> <span class="n">depth_img</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert OpenCV images to Open3D RGBD&quot;&quot;&quot;</span>

    <span class="c1"># BGR â†’ RGB</span>
    <span class="n">color_rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">color_img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

    <span class="c1"># Convert to Open3D images</span>
    <span class="n">color_o3d</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">color_rgb</span><span class="p">)</span>
    <span class="n">depth_o3d</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">depth_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

    <span class="c1"># Create RGBD image</span>
    <span class="n">rgbd</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">RGBDImage</span><span class="o">.</span><span class="n">create_from_color_and_depth</span><span class="p">(</span>
        <span class="n">color_o3d</span><span class="p">,</span> <span class="n">depth_o3d</span><span class="p">,</span>
        <span class="n">depth_scale</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span>  <span class="c1"># mm â†’ m</span>
        <span class="n">depth_trunc</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>     <span class="c1"># Maximum depth</span>
        <span class="n">convert_rgb_to_intensity</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">rgbd</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rgbd_to_point_cloud</span><span class="p">(</span><span class="n">rgbd</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create point cloud from RGBD image&quot;&quot;&quot;</span>

    <span class="c1"># Open3D camera parameters</span>
    <span class="n">intrinsic</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">PinholeCameraIntrinsic</span><span class="p">(</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span>
        <span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">K</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># fx, fy</span>
        <span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">K</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>   <span class="c1"># cx, cy</span>
    <span class="p">)</span>

    <span class="c1"># Create point cloud</span>
    <span class="n">pcd</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">PointCloud</span><span class="o">.</span><span class="n">create_from_rgbd_image</span><span class="p">(</span>
        <span class="n">rgbd</span><span class="p">,</span> <span class="n">intrinsic</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">pcd</span>
</code></pre></div>

<hr />
<h2 id="6-3d-reconstruction">6. 3D Reconstruction<a class="header-link" href="#6-3d-reconstruction" title="Permanent link">&para;</a></h2>
<h3 id="multi-view-stereo-mvs-concept">Multi-View Stereo (MVS) Concept<a class="header-link" href="#multi-view-stereo-mvs-concept" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Multi</span><span class="o">-</span><span class="n">View</span><span class="w"> </span><span class="n">Stereo</span><span class="w"> </span><span class="n">Pipeline</span><span class="p">:</span>

<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">Image</span><span class="w"> </span><span class="n">Acquisition</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Capture</span><span class="w"> </span><span class="n">subject</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="n">angles</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">ğŸ“·</span><span class="w"> </span><span class="err">ğŸ“·</span><span class="w"> </span><span class="err">ğŸ“·</span><span class="w"> </span><span class="err">ğŸ“·</span><span class="w"> </span><span class="err">ğŸ“·</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">Feature</span><span class="w"> </span><span class="n">Detection</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">Matching</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Find</span><span class="w"> </span><span class="n">correspondences</span><span class="w"> </span><span class="n">between</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">SIFT</span><span class="p">,</span><span class="w"> </span><span class="n">ORB</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="o">.</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">â—</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="err">â—</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="n">Structure</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">Motion</span><span class="w"> </span><span class="p">(</span><span class="n">SfM</span><span class="p">)</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Camera</span><span class="w"> </span><span class="n">pose</span><span class="w"> </span><span class="n">estimation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sparse</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="n">cloud</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">ğŸ“·â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â—</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">ğŸ“·â”€â”€â”€â”€â”¼â”€â”€â”€â”€â—</span><span class="w"> </span><span class="err">â—</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">ğŸ“·â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â—</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">4.</span><span class="w"> </span><span class="n">Dense</span><span class="w"> </span><span class="n">Reconstruction</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Estimate</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">pixels</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="p">[:::::::::::]</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">5.</span><span class="w"> </span><span class="n">Mesh</span><span class="w"> </span><span class="n">Generation</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Point</span><span class="w"> </span><span class="n">cloud</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Triangle</span><span class="w"> </span><span class="n">mesh</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">â–²â–²â–²â–²â–²â–²â–²â–²</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">6.</span><span class="w"> </span><span class="n">Texture</span><span class="w"> </span><span class="n">Mapping</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Apply</span><span class="w"> </span><span class="n">texture</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">mesh</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">images</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="essential-matrix-based-pose-estimation">Essential Matrix-based Pose Estimation<a class="header-link" href="#essential-matrix-based-pose-estimation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">estimate_pose_from_essential</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimate relative pose from Essential Matrix&quot;&quot;&quot;</span>

    <span class="c1"># Calculate Essential Matrix</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findEssentialMat</span><span class="p">(</span>
        <span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">RANSAC</span><span class="p">,</span>
        <span class="n">prob</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inlier ratio: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

    <span class="c1"># Recover R, t from Essential Matrix</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">recoverPose</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Rotation matrix R:</span><span class="se">\n</span><span class="si">{</span><span class="n">R</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Translation vector t (unit vector):</span><span class="se">\n</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span>

<span class="k">def</span><span class="w"> </span><span class="nf">triangulate_points</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Triangulate 3D points from two views&quot;&quot;&quot;</span>

    <span class="c1"># Construct projection matrices</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">K</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))])</span>
    <span class="n">P2</span> <span class="o">=</span> <span class="n">K</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span>

    <span class="c1"># Triangulation</span>
    <span class="n">pts1_h</span> <span class="o">=</span> <span class="n">pts1</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># (2, N)</span>
    <span class="n">pts2_h</span> <span class="o">=</span> <span class="n">pts2</span><span class="o">.</span><span class="n">T</span>

    <span class="n">points_4d</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">triangulatePoints</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">pts1_h</span><span class="p">,</span> <span class="n">pts2_h</span><span class="p">)</span>

    <span class="c1"># Homogeneous coordinates â†’ 3D coordinates</span>
    <span class="n">points_3d</span> <span class="o">=</span> <span class="n">points_4d</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">points_4d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">points_3d</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># (N, 3)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">incremental_sfm</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Incremental SfM (simple version)&quot;&quot;&quot;</span>

    <span class="c1"># SIFT detector</span>
    <span class="n">sift</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>

    <span class="c1"># Initialize with first two images</span>
    <span class="n">kp1</span><span class="p">,</span> <span class="n">desc1</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kp2</span><span class="p">,</span> <span class="n">desc2</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Matching</span>
    <span class="n">bf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">()</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">desc1</span><span class="p">,</span> <span class="n">desc2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Ratio test</span>
    <span class="n">good_matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
            <span class="n">good_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="n">pts1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp1</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">queryIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good_matches</span><span class="p">])</span>
    <span class="n">pts2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp2</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">trainIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good_matches</span><span class="p">])</span>

    <span class="c1"># Initial pose and 3D points</span>
    <span class="n">R</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">estimate_pose_from_essential</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="n">points_3d</span> <span class="o">=</span> <span class="n">triangulate_points</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

    <span class="c1"># Store camera poses</span>
    <span class="n">camera_poses</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))},</span>  <span class="c1"># First camera</span>
        <span class="p">{</span><span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">}</span>                           <span class="c1"># Second camera</span>
    <span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial 3D points: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">points_3d</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Add subsequent images (estimate pose using PnP)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)):</span>
        <span class="n">kp_new</span><span class="p">,</span> <span class="n">desc_new</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Match with previous image</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">desc2</span><span class="p">,</span> <span class="n">desc_new</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">good_matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
                <span class="n">good_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="c1"># 3D-2D correspondences</span>
        <span class="n">obj_points</span> <span class="o">=</span> <span class="n">points_3d</span><span class="p">[[</span><span class="n">m</span><span class="o">.</span><span class="n">queryIdx</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good_matches</span><span class="p">]]</span>
        <span class="n">img_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp_new</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">trainIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good_matches</span><span class="p">])</span>

        <span class="c1"># Estimate pose using PnP</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">rvec</span><span class="p">,</span> <span class="n">tvec</span><span class="p">,</span> <span class="n">inliers</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">solvePnPRansac</span><span class="p">(</span>
            <span class="n">obj_points</span><span class="p">,</span> <span class="n">img_points</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">R_new</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Rodrigues</span><span class="p">(</span><span class="n">rvec</span><span class="p">)</span>
            <span class="n">camera_poses</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">R_new</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">tvec</span><span class="p">})</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> registered (inliers: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">inliers</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># Update for next iteration</span>
        <span class="n">desc2</span> <span class="o">=</span> <span class="n">desc_new</span>

    <span class="k">return</span> <span class="n">points_3d</span><span class="p">,</span> <span class="n">camera_poses</span>
</code></pre></div>

<h3 id="bundle-adjustment">Bundle Adjustment<a class="header-link" href="#bundle-adjustment" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nx">Bundle</span><span class="w"> </span><span class="nx">Adjustment</span><span class="p">:</span>
<span class="nx">Simultaneously</span><span class="w"> </span><span class="nx">optimize</span><span class="w"> </span><span class="nx">camera</span><span class="w"> </span><span class="nx">parameters</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">3</span><span class="nx">D</span><span class="w"> </span><span class="nx">point</span><span class="w"> </span><span class="nx">positions</span>

<span class="nx">Minimization</span><span class="w"> </span><span class="nx">Objective</span><span class="p">:</span>
<span class="nx">E</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Î£_i</span><span class="w"> </span><span class="nx">Î£_j</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">x_ij</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Ï€</span><span class="p">(</span><span class="nx">K</span><span class="p">,</span><span class="w"> </span><span class="nx">R_i</span><span class="p">,</span><span class="w"> </span><span class="nx">t_i</span><span class="p">,</span><span class="w"> </span><span class="nx">X_j</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="nx">Â²</span>

<span class="nx">Where</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="nx">x_ij</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="nx">D</span><span class="w"> </span><span class="nx">coordinates</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">point</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="nx">observed</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">image</span><span class="w"> </span><span class="nx">i</span>
<span class="o">-</span><span class="w"> </span><span class="nx">Ï€</span><span class="p">():</span><span class="w"> </span><span class="mi">3</span><span class="nx">D</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="mi">2</span><span class="nx">D</span><span class="w"> </span><span class="nx">projection</span><span class="w"> </span><span class="nx">function</span>
<span class="o">-</span><span class="w"> </span><span class="nx">K</span><span class="p">:</span><span class="w"> </span><span class="nx">Camera</span><span class="w"> </span><span class="nx">intrinsic</span><span class="w"> </span><span class="nx">parameters</span>
<span class="o">-</span><span class="w"> </span><span class="nx">R_i</span><span class="p">,</span><span class="w"> </span><span class="nx">t_i</span><span class="p">:</span><span class="w"> </span><span class="nx">Camera</span><span class="w"> </span><span class="nx">i</span><span class="err">&#39;</span><span class="nx">s</span><span class="w"> </span><span class="nx">pose</span>
<span class="o">-</span><span class="w"> </span><span class="nx">X_j</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="nx">D</span><span class="w"> </span><span class="nx">coordinates</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">point</span><span class="w"> </span><span class="nx">j</span>

<span class="nx">Optimization</span><span class="w"> </span><span class="nx">Tools</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="nx">Ceres</span><span class="w"> </span><span class="nx">Solver</span>
<span class="o">-</span><span class="w"> </span><span class="nx">g2o</span>
<span class="o">-</span><span class="w"> </span><span class="nx">SciPy</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="nx">small</span><span class="w"> </span><span class="nx">problems</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="7-exercises">7. Exercises<a class="header-link" href="#7-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-stereo-depth-estimation">Exercise 1: Stereo Depth Estimation<a class="header-link" href="#exercise-1-stereo-depth-estimation" title="Permanent link">&para;</a></h3>
<p>Generate a depth map from a stereo image pair.</p>
<p><strong>Requirements</strong>:
- Compare StereoBM and StereoSGBM
- Visualize disparity map
- Convert to depth map
- Quality improvement (filtering)</p>
<details>
<summary>Hint</summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Parameter tuning needed</span>
<span class="n">stereo</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">StereoSGBM_create</span><span class="p">(</span>
    <span class="n">numDisparities</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
    <span class="n">blockSize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">P1</span><span class="o">=</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">P2</span><span class="o">=</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">**</span> <span class="mi">2</span>
<span class="p">)</span>

<span class="c1"># Improve with WLS filter</span>
<span class="n">wls_filter</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ximgproc</span><span class="o">.</span><span class="n">createDisparityWLSFilter</span><span class="p">(</span><span class="n">stereo</span><span class="p">)</span>
</code></pre></div>



</details>

<h3 id="exercise-2-point-cloud-filtering">Exercise 2: Point Cloud Filtering<a class="header-link" href="#exercise-2-point-cloud-filtering" title="Permanent link">&para;</a></h3>
<p>Refine a noisy point cloud.</p>
<p><strong>Requirements</strong>:
- Statistical outlier removal
- Voxel downsampling
- Extract planar regions
- Visualize results</p>
<details>
<summary>Hint</summary>


<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">open3d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">o3d</span>

<span class="c1"># Outlier removal</span>
<span class="n">pcd_clean</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pcd</span><span class="o">.</span><span class="n">remove_statistical_outlier</span><span class="p">(</span>
    <span class="n">nb_neighbors</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">std_ratio</span><span class="o">=</span><span class="mf">2.0</span>
<span class="p">)</span>

<span class="c1"># Downsampling</span>
<span class="n">pcd_down</span> <span class="o">=</span> <span class="n">pcd_clean</span><span class="o">.</span><span class="n">voxel_down_sample</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>

<span class="c1"># Plane extraction (RANSAC)</span>
<span class="n">plane_model</span><span class="p">,</span> <span class="n">inliers</span> <span class="o">=</span> <span class="n">pcd_down</span><span class="o">.</span><span class="n">segment_plane</span><span class="p">(</span>
    <span class="n">distance_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">ransac_n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">num_iterations</span><span class="o">=</span><span class="mi">1000</span>
<span class="p">)</span>
</code></pre></div>



</details>

<h3 id="exercise-3-3d-reconstruction-from-two-views">Exercise 3: 3D Reconstruction from Two Views<a class="header-link" href="#exercise-3-3d-reconstruction-from-two-views" title="Permanent link">&para;</a></h3>
<p>Reconstruct 3D points from two images.</p>
<p><strong>Requirements</strong>:
- Feature detection and matching
- Essential Matrix calculation
- Camera pose recovery
- Generate 3D points via triangulation</p>
<details>
<summary>Hint</summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Essential Matrix</span>
<span class="n">E</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findEssentialMat</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

<span class="c1"># Pose recovery</span>
<span class="n">_</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">recoverPose</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

<span class="c1"># Triangulation</span>
<span class="n">points_4d</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">triangulatePoints</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">pts1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">pts2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">points_3d</span> <span class="o">=</span> <span class="n">points_4d</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">points_4d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</code></pre></div>



</details>

<h3 id="exercise-4-mesh-reconstruction">Exercise 4: Mesh Reconstruction<a class="header-link" href="#exercise-4-mesh-reconstruction" title="Permanent link">&para;</a></h3>
<p>Generate a 3D mesh from a point cloud.</p>
<p><strong>Requirements</strong>:
- Point cloud preprocessing
- Normal vector estimation
- Poisson or ball pivoting reconstruction
- Save and visualize results</p>
<details>
<summary>Hint</summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Normal estimation</span>
<span class="n">pcd</span><span class="o">.</span><span class="n">estimate_normals</span><span class="p">()</span>
<span class="n">pcd</span><span class="o">.</span><span class="n">orient_normals_consistent_tangent_plane</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="c1"># Poisson reconstruction</span>
<span class="n">mesh</span><span class="p">,</span> <span class="n">densities</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">TriangleMesh</span><span class="o">.</span><span class="n">create_from_point_cloud_poisson</span><span class="p">(</span>
    <span class="n">pcd</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">9</span>
<span class="p">)</span>

<span class="c1"># Remove low-density regions</span>
<span class="n">densities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">densities</span><span class="p">)</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">remove_vertices_by_mask</span><span class="p">(</span><span class="n">densities</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">densities</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">))</span>
</code></pre></div>



</details>

<h3 id="exercise-5-real-time-stereo-vision">Exercise 5: Real-time Stereo Vision<a class="header-link" href="#exercise-5-real-time-stereo-vision" title="Permanent link">&para;</a></h3>
<p>Implement real-time depth estimation using webcam or stereo camera.</p>
<p><strong>Requirements</strong>:
- Apply camera calibration
- Real-time disparity calculation
- Depth visualization
- FPS measurement</p>
<details>
<summary>Hint</summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Pre-compute remapping maps</span>
<span class="n">map1_left</span><span class="p">,</span> <span class="n">map2_left</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">initUndistortRectifyMap</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">map1_right</span><span class="p">,</span> <span class="n">map2_right</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">initUndistortRectifyMap</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1"># Rectification</span>
    <span class="n">rect_left</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">map1_left</span><span class="p">,</span> <span class="n">map2_left</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>
    <span class="n">rect_right</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">map1_right</span><span class="p">,</span> <span class="n">map2_right</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>

    <span class="c1"># Disparity calculation (SGBM)</span>
    <span class="n">disparity</span> <span class="o">=</span> <span class="n">stereo</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">rect_left</span><span class="p">,</span> <span class="n">rect_right</span><span class="p">)</span>
</code></pre></div>



</details>

<hr />
<h2 id="next-steps">Next Steps<a class="header-link" href="#next-steps" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="./22_Depth_Estimation.md">22_Depth_Estimation.md</a> - Monocular depth estimation, MiDaS, DPT, Structure from Motion</li>
</ul>
<hr />
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://docs.opencv.org/4.x/dd/d53/tutorial_py_depthmap.html">OpenCV Stereo Vision Tutorial</a></li>
<li><a href="http://www.open3d.org/docs/">Open3D Documentation</a></li>
<li><a href="https://www.robots.ox.ac.uk/~vgg/hzbook/">Multiple View Geometry in Computer Vision</a></li>
<li><a href="https://github.com/colmap/colmap">Structure from Motion Tutorial</a></li>
<li><a href="https://people.cs.rutgers.edu/~elgammal/classes/cs534/lectures/Stereo_2.pdf">Stereo Vision: A Tutorial</a></li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Computer_Vision/20_Practical_Projects.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Practical Projects</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Computer_Vision/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Computer_Vision/22_Depth_Estimation.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Monocular Depth Estimation</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}