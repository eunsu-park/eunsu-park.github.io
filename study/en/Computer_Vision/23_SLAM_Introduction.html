{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLAM Introduction (Visual SLAM Introduction) - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Computer_Vision/">Computer Vision</a>
    <span class="separator">/</span>
    <span class="current">SLAM Introduction (Visual SLAM Introduction)</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>SLAM Introduction (Visual SLAM Introduction)</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Computer_Vision/22_Depth_Estimation.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Monocular Depth Estimation</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Computer_Vision/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-slam-overview">1. SLAM Overview</a><ul>
<li><a href="#what-is-slam">What is SLAM?</a></li>
<li><a href="#slam-classification">SLAM Classification</a></li>
</ul>
</li>
<li><a href="#2-visual-odometry">2. Visual Odometry</a><ul>
<li><a href="#visual-odometry-concept">Visual Odometry Concept</a></li>
<li><a href="#monocular-visual-odometry-implementation">Monocular Visual Odometry Implementation</a></li>
<li><a href="#stereo-visual-odometry">Stereo Visual Odometry</a></li>
</ul>
</li>
<li><a href="#3-orb-slam">3. ORB-SLAM</a><ul>
<li><a href="#orb-slam-overview">ORB-SLAM Overview</a></li>
<li><a href="#orb-features-and-bag-of-words">ORB Features and Bag of Words</a></li>
</ul>
</li>
<li><a href="#4-lidar-slam">4. LiDAR SLAM</a><ul>
<li><a href="#lidar-slam-overview">LiDAR SLAM Overview</a></li>
<li><a href="#icp-iterative-closest-point">ICP (Iterative Closest Point)</a></li>
</ul>
</li>
<li><a href="#5-loop-closure">5. Loop Closure</a><ul>
<li><a href="#loop-closure-concept">Loop Closure Concept</a></li>
<li><a href="#loop-closure-implementation">Loop Closure Implementation</a></li>
</ul>
</li>
<li><a href="#6-slam-implementation-practice">6. SLAM Implementation Practice</a><ul>
<li><a href="#simple-slam-system">Simple SLAM System</a></li>
<li><a href="#visualization">Visualization</a></li>
</ul>
</li>
<li><a href="#7-practice-problems">7. Practice Problems</a><ul>
<li><a href="#problem-1-visual-odometry-implementation">Problem 1: Visual Odometry Implementation</a></li>
<li><a href="#problem-2-loop-closure-detection">Problem 2: Loop Closure Detection</a></li>
<li><a href="#problem-3-icp-implementation">Problem 3: ICP Implementation</a></li>
<li><a href="#problem-4-occupancy-grid-map">Problem 4: Occupancy Grid Map</a></li>
<li><a href="#problem-5-complete-slam-system">Problem 5: Complete SLAM System</a></li>
</ul>
</li>
<li><a href="#next-steps">Next Steps</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="slam-introduction-visual-slam-introduction">SLAM Introduction (Visual SLAM Introduction)<a class="header-link" href="#slam-introduction-visual-slam-introduction" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="header-link" href="#overview" title="Permanent link">&para;</a></h2>
<p>SLAM (Simultaneous Localization and Mapping) is a technology that enables robots and autonomous systems to build maps while simultaneously estimating their own position in unknown environments. This lesson covers the fundamentals of Visual SLAM, LiDAR SLAM, and Loop Closure.</p>
<p><strong>Difficulty</strong>: â­â­â­â­</p>
<p><strong>Prerequisites</strong>: 3D vision, feature detection/matching, camera calibration, basic probability theory</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-slam-overview">SLAM Overview</a></li>
<li><a href="#2-visual-odometry">Visual Odometry</a></li>
<li><a href="#3-orb-slam">ORB-SLAM</a></li>
<li><a href="#4-lidar-slam">LiDAR SLAM</a></li>
<li><a href="#5-loop-closure">Loop Closure</a></li>
<li><a href="#6-slam-implementation-practice">SLAM Implementation Practice</a></li>
<li><a href="#7-practice-problems">Practice Problems</a></li>
</ol>
<hr />
<h2 id="1-slam-overview">1. SLAM Overview<a class="header-link" href="#1-slam-overview" title="Permanent link">&para;</a></h2>
<h3 id="what-is-slam">What is SLAM?<a class="header-link" href="#what-is-slam" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>SLAM (Simultaneous Localization and Mapping):
Simultaneous localization and mapping

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  Key Questions:                                                 â”‚
â”‚  &quot;How can you know your position without a map?&quot;                â”‚
â”‚  &quot;How can you build a map without knowing your position?&quot;       â”‚
â”‚                                                                 â”‚
â”‚  â†’ Solve both simultaneously! (Chicken and egg problem)         â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                                                        â”‚     â”‚
â”‚  â”‚     Sensor Data                                        â”‚     â”‚
â”‚  â”‚     (Camera, LiDAR, IMU)                               â”‚     â”‚
â”‚  â”‚            â”‚                                           â”‚     â”‚
â”‚  â”‚            â–¼                                           â”‚     â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚     â”‚
â”‚  â”‚     â”‚    SLAM      â”‚                                   â”‚     â”‚
â”‚  â”‚     â”‚  Algorithm   â”‚                                   â”‚     â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚     â”‚
â”‚  â”‚            â”‚                                           â”‚     â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚     â”‚
â”‚  â”‚     â”‚              â”‚                                   â”‚     â”‚
â”‚  â”‚     â–¼              â–¼                                   â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚     â”‚
â”‚  â”‚  â”‚   Map   â”‚  â”‚  Pose   â”‚                             â”‚     â”‚
â”‚  â”‚  â”‚  (Map)  â”‚  â”‚ (Pose)  â”‚                             â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚     â”‚
â”‚  â”‚                                                        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Applications:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Field           â”‚ Examples                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Autonomous      â”‚ Cars, drones, delivery robots           â”‚
â”‚ Driving         â”‚                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Augmented       â”‚ ARKit, ARCore, HoloLens                 â”‚
â”‚ Reality         â”‚                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Robot Vacuum    â”‚ Roomba, Roborock                        â”‚
â”‚ Cleaners        â”‚                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3D Scanning     â”‚ Architecture, cultural heritage         â”‚
â”‚                 â”‚ restoration                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Navigation      â”‚ Indoor localization                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="slam-classification">SLAM Classification<a class="header-link" href="#slam-classification" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nv">SLAM</span><span class="w"> </span><span class="nv">Method</span><span class="w"> </span><span class="nv">Classification</span>:

<span class="mi">1</span>.<span class="w"> </span><span class="nv">Sensor</span><span class="o">-</span><span class="nv">based</span><span class="w"> </span><span class="nv">Classification</span>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                                                                 </span>â”‚
â”‚<span class="w">  </span><span class="nv">Visual</span><span class="w"> </span><span class="nv">SLAM</span><span class="w"> </span><span class="ss">(</span><span class="nv">V</span><span class="o">-</span><span class="nv">SLAM</span><span class="ss">)</span><span class="w">                                           </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Camera</span><span class="w"> </span><span class="ss">(</span><span class="nv">monocular</span>,<span class="w"> </span><span class="nv">stereo</span>,<span class="w"> </span><span class="nv">RGB</span><span class="o">-</span><span class="nv">D</span><span class="ss">)</span><span class="w">                            </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Feature</span><span class="o">-</span><span class="nv">based</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">direct</span><span class="w"> </span><span class="nv">methods</span><span class="w">                              </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Examples</span>:<span class="w"> </span><span class="nv">ORB</span><span class="o">-</span><span class="nv">SLAM</span>,<span class="w"> </span><span class="nv">LSD</span><span class="o">-</span><span class="nv">SLAM</span>,<span class="w"> </span><span class="nv">DSO</span><span class="w">                            </span>â”‚
â”‚<span class="w">                                                                 </span>â”‚
â”‚<span class="w">  </span><span class="nv">LiDAR</span><span class="w"> </span><span class="nv">SLAM</span><span class="w">                                                     </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Laser</span><span class="w"> </span><span class="nv">scanner</span><span class="w">                                                </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Point</span><span class="w"> </span><span class="nv">cloud</span><span class="w"> </span><span class="nv">matching</span><span class="w">                                         </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Examples</span>:<span class="w"> </span><span class="nv">Cartographer</span>,<span class="w"> </span><span class="nv">LOAM</span>,<span class="w"> </span><span class="nv">LeGO</span><span class="o">-</span><span class="nv">LOAM</span><span class="w">                      </span>â”‚
â”‚<span class="w">                                                                 </span>â”‚
â”‚<span class="w">  </span><span class="nv">Visual</span><span class="o">-</span><span class="nv">Inertial</span><span class="w"> </span><span class="nv">SLAM</span><span class="w">                                           </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Camera</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">IMU</span><span class="w"> </span><span class="nv">fusion</span><span class="w">                                          </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Examples</span>:<span class="w"> </span><span class="nv">VINS</span><span class="o">-</span><span class="nv">Mono</span>,<span class="w"> </span><span class="nv">OKVIS</span>,<span class="w"> </span><span class="nv">MSCKF</span><span class="w">                            </span>â”‚
â”‚<span class="w">                                                                 </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

<span class="mi">2</span>.<span class="w"> </span><span class="nv">Methodology</span><span class="o">-</span><span class="nv">based</span><span class="w"> </span><span class="nv">Classification</span>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                                                                 </span>â”‚
â”‚<span class="w">  </span><span class="nv">Filter</span><span class="o">-</span><span class="nv">based</span><span class="w">                                                   </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">EKF</span><span class="o">-</span><span class="nv">SLAM</span>,<span class="w"> </span><span class="nv">UKF</span><span class="o">-</span><span class="nv">SLAM</span><span class="w">                                           </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Real</span><span class="o">-</span><span class="nv">time</span><span class="w"> </span><span class="nv">updates</span><span class="w">                                            </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Linearization</span><span class="w"> </span><span class="nv">error</span><span class="w"> </span><span class="nv">accumulation</span><span class="w"> </span><span class="nv">issues</span><span class="w">                      </span>â”‚
â”‚<span class="w">                                                                 </span>â”‚
â”‚<span class="w">  </span><span class="nv">Graph</span><span class="o">-</span><span class="nv">based</span><span class="w">                                                    </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Pose</span><span class="w"> </span><span class="nv">graph</span><span class="w"> </span><span class="nv">optimization</span><span class="w">                                      </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Bundle</span><span class="w"> </span><span class="nv">adjustment</span><span class="w">                                            </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">More</span><span class="w"> </span><span class="nv">accurate</span><span class="w"> </span><span class="nv">but</span><span class="w"> </span><span class="nv">computationally</span><span class="w"> </span><span class="nv">expensive</span><span class="w">                  </span>â”‚
â”‚<span class="w">                                                                 </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

<span class="mi">3</span>.<span class="w"> </span><span class="nv">Front</span><span class="o">-</span><span class="k">end</span><span class="o">/</span><span class="nv">Back</span><span class="o">-</span><span class="k">end</span>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                                                                 </span>â”‚
â”‚<span class="w">  </span><span class="nv">Front</span><span class="o">-</span><span class="k">end</span><span class="w">                                                      </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Sensor</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="nv">processing</span><span class="w">                                       </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Feature</span><span class="w"> </span><span class="nv">extraction</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">matching</span><span class="w">                              </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Initial</span><span class="w"> </span><span class="nv">pose</span><span class="w"> </span><span class="nv">estimation</span><span class="w">                                      </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="k">Loop</span><span class="w"> </span><span class="nv">closure</span><span class="w"> </span><span class="nv">detection</span><span class="w">                                       </span>â”‚
â”‚<span class="w">                                                                 </span>â”‚
â”‚<span class="w">  </span><span class="nv">Back</span><span class="o">-</span><span class="k">end</span><span class="w">                                                       </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Global</span><span class="w"> </span><span class="nv">optimization</span><span class="w">                                          </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Graph</span><span class="w"> </span><span class="nv">optimization</span><span class="w">                                           </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Uncertainty</span><span class="w"> </span><span class="nv">estimation</span><span class="w">                                       </span>â”‚
â”‚<span class="w">                                                                 </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="2-visual-odometry">2. Visual Odometry<a class="header-link" href="#2-visual-odometry" title="Permanent link">&para;</a></h2>
<h3 id="visual-odometry-concept">Visual Odometry Concept<a class="header-link" href="#visual-odometry-concept" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Visual</span><span class="w"> </span><span class="n">Odometry</span><span class="w"> </span><span class="p">(</span><span class="n">VO</span><span class="p">)</span><span class="err">:</span>
<span class="n">Estimating</span><span class="w"> </span><span class="nb">camera</span><span class="w"> </span><span class="n">motion</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">consecutive</span><span class="w"> </span><span class="n">images</span>

<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Frame</span><span class="w"> </span><span class="k">t</span><span class="o">-</span><span class="mi">1</span><span class="w">        </span><span class="n">Frame</span><span class="w"> </span><span class="k">t</span><span class="w">          </span><span class="n">Frame</span><span class="w"> </span><span class="k">t</span><span class="o">+</span><span class="mi">1</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">        </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">        </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">ğŸ“·</span><span class="w">  </span><span class="err">â”‚â”€â”€</span><span class="n">Tâ‚</span><span class="err">â”€â”€â”€â–¶â”‚</span><span class="w">   </span><span class="err">ğŸ“·</span><span class="w">  </span><span class="err">â”‚â”€â”€</span><span class="n">Tâ‚‚</span><span class="err">â”€â”€â”€â–¶â”‚</span><span class="w">   </span><span class="err">ğŸ“·</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">        </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">        </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Accumulated</span><span class="w"> </span><span class="n">Pose</span><span class="err">:</span><span class="w"> </span><span class="n">P_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tâ‚</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Tâ‚‚</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">T_t</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Problems</span><span class="err">:</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Accumulated</span><span class="w"> </span><span class="n">drift</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Scale</span><span class="w"> </span><span class="n">ambiguity</span><span class="w"> </span><span class="p">(</span><span class="n">monocular</span><span class="w"> </span><span class="nb">camera</span><span class="p">)</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Vulnerable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="n">motion</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="n">VO</span><span class="w"> </span><span class="n">Pipeline</span><span class="err">:</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="n">Image</span><span class="w"> </span><span class="n">Acquisition</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â–¼</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="n">Feature</span><span class="w"> </span><span class="n">Extraction</span><span class="w"> </span><span class="p">(</span><span class="n">ORB</span><span class="p">,</span><span class="w"> </span><span class="n">SIFT</span><span class="p">,</span><span class="w"> </span><span class="n">Harris</span><span class="w"> </span><span class="n">corners</span><span class="p">)</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â–¼</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="n">Feature</span><span class="w"> </span><span class="n">Matching</span><span class="o">/</span><span class="n">Tracking</span><span class="w"> </span><span class="p">(</span><span class="n">BF</span><span class="w"> </span><span class="n">Matcher</span><span class="p">,</span><span class="w"> </span><span class="n">Optical</span><span class="w"> </span><span class="n">Flow</span><span class="p">)</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â–¼</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">4</span><span class="o">.</span><span class="w"> </span><span class="n">Motion</span><span class="w"> </span><span class="n">Estimation</span><span class="w"> </span><span class="p">(</span><span class="n">Essential</span><span class="w"> </span><span class="n">Matrix</span><span class="p">,</span><span class="w"> </span><span class="n">PnP</span><span class="p">)</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â–¼</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">5</span><span class="o">.</span><span class="w"> </span><span class="n">Local</span><span class="w"> </span><span class="n">Optimization</span><span class="w"> </span><span class="p">(</span><span class="n">Local</span><span class="w"> </span><span class="n">BA</span><span class="p">)</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â–¼</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">6</span><span class="o">.</span><span class="w"> </span><span class="n">Pose</span><span class="w"> </span><span class="n">Update</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="monocular-visual-odometry-implementation">Monocular Visual Odometry Implementation<a class="header-link" href="#monocular-visual-odometry-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MonocularVO</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Monocular Visual Odometry&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">detector</span><span class="o">=</span><span class="s1">&#39;ORB&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        K: Camera intrinsic parameter matrix</span>
<span class="sd">        detector: Feature detector (&#39;ORB&#39;, &#39;SIFT&#39;, &#39;FAST&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focal</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">K</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>  <span class="c1"># principal point</span>

        <span class="c1"># Feature detector</span>
        <span class="k">if</span> <span class="n">detector</span> <span class="o">==</span> <span class="s1">&#39;ORB&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ORB_create</span><span class="p">(</span><span class="mi">3000</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">detector</span> <span class="o">==</span> <span class="s1">&#39;SIFT&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">(</span><span class="mi">3000</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FastFeatureDetector_create</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

        <span class="c1"># Optical flow parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lk_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">winSize</span><span class="o">=</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>
            <span class="n">maxLevel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">criteria</span><span class="o">=</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span> <span class="o">|</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_COUNT</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># State</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_frame</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_pts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect features&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="p">,</span> <span class="s1">&#39;detectAndCompute&#39;</span><span class="p">):</span>
            <span class="n">kp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">kp</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">track_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prev_img</span><span class="p">,</span> <span class="n">cur_img</span><span class="p">,</span> <span class="n">prev_pts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track features using optical flow&quot;&quot;&quot;</span>

        <span class="n">cur_pts</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calcOpticalFlowPyrLK</span><span class="p">(</span>
            <span class="n">prev_img</span><span class="p">,</span> <span class="n">cur_img</span><span class="p">,</span> <span class="n">prev_pts</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">lk_params</span>
        <span class="p">)</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">prev_pts</span> <span class="o">=</span> <span class="n">prev_pts</span><span class="p">[</span><span class="n">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">cur_pts</span> <span class="o">=</span> <span class="n">cur_pts</span><span class="p">[</span><span class="n">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">prev_pts</span><span class="p">,</span> <span class="n">cur_pts</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Estimate pose using Essential Matrix&quot;&quot;&quot;</span>

        <span class="n">E</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findEssentialMat</span><span class="p">(</span>
            <span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">RANSAC</span><span class="p">,</span>
            <span class="n">prob</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">recoverPose</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process frame&quot;&quot;&quot;</span>

        <span class="c1"># Convert to grayscale</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gray</span> <span class="o">=</span> <span class="n">frame</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># First frame</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_frame</span> <span class="o">=</span> <span class="n">gray</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_features</span><span class="p">(</span><span class="n">gray</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span>

        <span class="c1"># Track features</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_pts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_pts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">prev_pts</span><span class="p">,</span> <span class="n">cur_pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_features</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prev_frame</span><span class="p">,</span> <span class="n">gray</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_pts</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prev_pts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="c1"># Estimate pose</span>
                <span class="n">R</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_pose</span><span class="p">(</span>
                    <span class="n">prev_pts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">cur_pts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Accumulate pose</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span> <span class="o">@</span> <span class="n">t</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span> <span class="o">=</span> <span class="n">R</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span>

                <span class="c1"># Detect new features if needed</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_pts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
                    <span class="n">new_pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_features</span><span class="p">(</span><span class="n">gray</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_pts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prev_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span>
                            <span class="n">cur_pts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                            <span class="n">new_pts</span>
                        <span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prev_pts</span> <span class="o">=</span> <span class="n">new_pts</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prev_pts</span> <span class="o">=</span> <span class="n">cur_pts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prev_pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_features</span><span class="p">(</span><span class="n">gray</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_features</span><span class="p">(</span><span class="n">gray</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prev_frame</span> <span class="o">=</span> <span class="n">gray</span>

        <span class="c1"># Save trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return trajectory&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">])</span>

<span class="c1"># Usage example</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">718.856</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">607.1928</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">718.856</span><span class="p">,</span> <span class="mf">185.2157</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">vo</span> <span class="o">=</span> <span class="n">MonocularVO</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>

<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="s1">&#39;driving.mp4&#39;</span><span class="p">)</span>

<span class="k">while</span> <span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="n">R</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">vo</span><span class="o">.</span><span class="n">process_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="c1"># Print current position</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Position: x=</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, y=</span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, z=</span><span class="si">{</span><span class="n">z</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="c1"># Visualize trajectory</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">vo</span><span class="o">.</span><span class="n">get_trajectory</span><span class="p">()</span>
</code></pre></div>

<h3 id="stereo-visual-odometry">Stereo Visual Odometry<a class="header-link" href="#stereo-visual-odometry" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StereoVO</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stereo Visual Odometry&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">baseline</span><span class="p">,</span> <span class="n">detector</span><span class="o">=</span><span class="s1">&#39;ORB&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focal</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ORB_create</span><span class="p">(</span><span class="mi">3000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_HAMMING</span><span class="p">)</span>

        <span class="c1"># Stereo matcher</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">StereoSGBM_create</span><span class="p">(</span>
            <span class="n">minDisparity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">numDisparities</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
            <span class="n">blockSize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">P1</span><span class="o">=</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">P2</span><span class="o">=</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prev_pts_3d</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_kp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_desc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute depth using stereo matching&quot;&quot;&quot;</span>

        <span class="n">disparity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereo</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">16.0</span>

        <span class="c1"># Disparity â†’ depth</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">disparity</span><span class="p">)</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">disparity</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">depth</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">focal</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">/</span> <span class="n">disparity</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">depth</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_3d_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert 2D keypoints to 3D&quot;&quot;&quot;</span>

        <span class="n">fx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">fy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="n">pts_3d</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kp</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># Valid depth</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cx</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span> <span class="o">/</span> <span class="n">fx</span>
                    <span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cy</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span> <span class="o">/</span> <span class="n">fy</span>
                    <span class="n">pts_3d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
                    <span class="n">valid_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pts_3d</span><span class="p">),</span> <span class="n">valid_indices</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process stereo frame&quot;&quot;&quot;</span>

        <span class="c1"># Convert to grayscale</span>
        <span class="n">gray_left</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">gray_right</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

        <span class="c1"># Compute depth</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_depth</span><span class="p">(</span><span class="n">gray_left</span><span class="p">,</span> <span class="n">gray_right</span><span class="p">)</span>

        <span class="c1"># Detect features</span>
        <span class="n">kp</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">gray_left</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Compute 3D points</span>
        <span class="n">pts_3d</span><span class="p">,</span> <span class="n">valid_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_3d_points</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_pts_3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_pts_3d</span> <span class="o">=</span> <span class="n">pts_3d</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_kp</span> <span class="o">=</span> <span class="p">[</span><span class="n">kp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">valid_idx</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span>

        <span class="c1"># Match with previous frame</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bf</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_desc</span><span class="p">,</span> <span class="n">desc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">good_matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
                <span class="n">good_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="c1"># 3D-2D correspondences</span>
            <span class="n">obj_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prev_pts_3d</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">queryIdx</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good_matches</span>
            <span class="p">])</span>
            <span class="n">img_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">kp</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">trainIdx</span><span class="p">]]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good_matches</span>
            <span class="p">])</span>

            <span class="c1"># Estimate pose using PnP</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">rvec</span><span class="p">,</span> <span class="n">tvec</span><span class="p">,</span> <span class="n">inliers</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">solvePnPRansac</span><span class="p">(</span>
                <span class="n">obj_points</span><span class="p">,</span> <span class="n">img_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">success</span> <span class="ow">and</span> <span class="n">inliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">inliers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">R</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Rodrigues</span><span class="p">(</span><span class="n">rvec</span><span class="p">)</span>

                <span class="c1"># Accumulate pose</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span> <span class="o">@</span> <span class="n">tvec</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span> <span class="o">=</span> <span class="n">R</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span>

        <span class="c1"># Update state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_pts_3d</span> <span class="o">=</span> <span class="n">pts_3d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_kp</span> <span class="o">=</span> <span class="p">[</span><span class="n">kp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">valid_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span>
</code></pre></div>

<hr />
<h2 id="3-orb-slam">3. ORB-SLAM<a class="header-link" href="#3-orb-slam" title="Permanent link">&para;</a></h2>
<h3 id="orb-slam-overview">ORB-SLAM Overview<a class="header-link" href="#orb-slam-overview" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nv">ORB</span><span class="o">-</span><span class="nv">SLAM</span><span class="w"> </span><span class="nv">Architecture</span>:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                                                                 </span>â”‚
â”‚<span class="w">  </span><span class="nv">ORB</span><span class="o">-</span><span class="nv">SLAM</span>:<span class="w"> </span><span class="nv">Most</span><span class="w"> </span><span class="nv">widely</span><span class="w"> </span><span class="nv">used</span><span class="w"> </span><span class="nv">Visual</span><span class="w"> </span><span class="nv">SLAM</span><span class="w"> </span><span class="nv">system</span><span class="w">                  </span>â”‚
â”‚<span class="w">                                                                 </span>â”‚
â”‚<span class="w">  </span><span class="nv">Versions</span>:<span class="w">                                                      </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">ORB</span><span class="o">-</span><span class="nv">SLAM</span><span class="w"> </span><span class="ss">(</span><span class="mi">2015</span><span class="ss">)</span>:<span class="w"> </span><span class="nv">Monocular</span><span class="w">                                   </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">ORB</span><span class="o">-</span><span class="nv">SLAM2</span><span class="w"> </span><span class="ss">(</span><span class="mi">2017</span><span class="ss">)</span>:<span class="w"> </span><span class="nv">Monocular</span><span class="o">/</span><span class="nv">Stereo</span><span class="o">/</span><span class="nv">RGB</span><span class="o">-</span><span class="nv">D</span><span class="w">                     </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">ORB</span><span class="o">-</span><span class="nv">SLAM3</span><span class="w"> </span><span class="ss">(</span><span class="mi">2021</span><span class="ss">)</span>:<span class="w"> </span><span class="nv">Visual</span><span class="o">-</span><span class="nv">Inertial</span>,<span class="w"> </span><span class="nv">multi</span><span class="o">-</span><span class="nv">map</span><span class="w">                 </span>â”‚
â”‚<span class="w">                                                                 </span>â”‚
â”‚<span class="w">  </span><span class="nv">Three</span><span class="w"> </span><span class="nv">parallel</span><span class="w"> </span><span class="nv">threads</span>:<span class="w">                                        </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">                                                         </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">     </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="nv">Tracking</span><span class="w">   </span>â”‚<span class="w">  </span>â”‚<span class="nv">Local</span><span class="w"> </span><span class="nv">Mapping</span>â”‚<span class="w">  </span>â”‚<span class="k">Loop</span><span class="w"> </span><span class="nv">Closing</span><span class="w"> </span>â”‚<span class="w">     </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>â”‚<span class="w">   </span><span class="nv">Thread</span><span class="w">    </span>â”‚<span class="w">  </span>â”‚<span class="w">   </span><span class="nv">Thread</span><span class="w">    </span>â”‚<span class="w">  </span>â”‚<span class="w">   </span><span class="nv">Thread</span><span class="w">    </span>â”‚<span class="w">     </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜<span class="w">     </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">         </span>â”‚<span class="w">                </span>â”‚<span class="w">                </span>â”‚<span class="w">            </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">         </span>â”‚<span class="w">    </span><span class="nv">Keyframes</span><span class="w">   </span>â”‚<span class="w">                </span>â”‚<span class="w">            </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">         </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚<span class="w">                </span>â”‚<span class="w">            </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">                          </span>â”‚<span class="w">    </span><span class="nv">Keyframes</span><span class="w">   </span>â”‚<span class="w">            </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">                          </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚<span class="w">            </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">                                           </span>â”‚<span class="w">            </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚<span class="w">            </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>â”‚<span class="w">           </span><span class="nv">Map</span><span class="w"> </span><span class="ss">(</span><span class="nv">MapPoints</span><span class="ss">)</span><span class="w">             </span>â”‚â”‚<span class="w">            </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>â”‚<span class="w">         </span><span class="o">&amp;</span><span class="w"> </span><span class="nv">Covisibility</span><span class="w"> </span><span class="nv">Graph</span><span class="w">          </span>â”‚â”‚<span class="w">            </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚<span class="w">            </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">                                           </span>â”‚<span class="w">            </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">    </span>â”‚
â”‚<span class="w">                                                                 </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

<span class="nv">Tracking</span><span class="w"> </span><span class="nv">Thread</span>:
<span class="o">-</span><span class="w"> </span><span class="nv">Process</span><span class="w"> </span><span class="nv">every</span><span class="w"> </span><span class="nv">frame</span>
<span class="o">-</span><span class="w"> </span><span class="nv">ORB</span><span class="w"> </span><span class="nv">feature</span><span class="w"> </span><span class="nv">extraction</span>
<span class="o">-</span><span class="w"> </span><span class="nv">Match</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">previous</span><span class="w"> </span><span class="nv">frame</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">map</span>
<span class="o">-</span><span class="w"> </span><span class="nv">Initial</span><span class="w"> </span><span class="nv">pose</span><span class="w"> </span><span class="nv">estimation</span>
<span class="o">-</span><span class="w"> </span><span class="nv">Keyframe</span><span class="w"> </span><span class="nv">decision</span>

<span class="nv">Local</span><span class="w"> </span><span class="nv">Mapping</span><span class="w"> </span><span class="nv">Thread</span>:
<span class="o">-</span><span class="w"> </span><span class="nv">Insert</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">keyframes</span>
<span class="o">-</span><span class="w"> </span><span class="nv">Cull</span><span class="w"> </span><span class="nv">recent</span><span class="w"> </span><span class="nv">MapPoints</span>
<span class="o">-</span><span class="w"> </span><span class="nv">Create</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">MapPoints</span>
<span class="o">-</span><span class="w"> </span><span class="nv">Local</span><span class="w"> </span><span class="nv">Bundle</span><span class="w"> </span><span class="nv">Adjustment</span>
<span class="o">-</span><span class="w"> </span><span class="nv">Remove</span><span class="w"> </span><span class="nv">redundant</span><span class="w"> </span><span class="nv">keyframes</span>

<span class="k">Loop</span><span class="w"> </span><span class="nv">Closing</span><span class="w"> </span><span class="nv">Thread</span>:
<span class="o">-</span><span class="w"> </span><span class="nv">Detect</span><span class="w"> </span><span class="k">loop</span><span class="w"> </span><span class="nv">candidates</span><span class="w"> </span><span class="ss">(</span><span class="nv">DBoW2</span><span class="ss">)</span>
<span class="o">-</span><span class="w"> </span><span class="nv">Verify</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">correct</span><span class="w"> </span><span class="nv">loops</span>
<span class="o">-</span><span class="w"> </span><span class="nv">Essential</span><span class="w"> </span><span class="nv">Graph</span><span class="w"> </span><span class="nv">optimization</span>
<span class="o">-</span><span class="w"> </span><span class="nv">Global</span><span class="w"> </span><span class="nv">Bundle</span><span class="w"> </span><span class="nv">Adjustment</span>
</code></pre></div>

<h3 id="orb-features-and-bag-of-words">ORB Features and Bag of Words<a class="header-link" href="#orb-features-and-bag-of-words" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ORBVocabulary</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ORB-based Bag of Words&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_words</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ORB_create</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_words</span> <span class="o">=</span> <span class="n">num_words</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_HAMMING</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train vocabulary from images&quot;&quot;&quot;</span>

        <span class="n">all_descriptors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_descriptors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>

        <span class="n">all_desc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">all_descriptors</span><span class="p">)</span>

        <span class="c1"># K-means clustering</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span> <span class="o">+</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_MAX_ITER</span><span class="p">,</span>
                   <span class="mi">100</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">centers</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">kmeans</span><span class="p">(</span>
            <span class="n">all_desc</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_words</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">criteria</span><span class="p">,</span>
            <span class="mi">10</span><span class="p">,</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">KMEANS_RANDOM_CENTERS</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span> <span class="o">=</span> <span class="n">centers</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vocabulary created: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_words</span><span class="si">}</span><span class="s2"> words&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_bow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute BoW vector for image&quot;&quot;&quot;</span>

        <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_words</span><span class="p">)</span>

        <span class="c1"># Assign each descriptor to nearest vocabulary word</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bf</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>

        <span class="n">bow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_words</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">bow</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">trainIdx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Normalize</span>
        <span class="n">bow</span> <span class="o">=</span> <span class="n">bow</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bow</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bow</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bow1</span><span class="p">,</span> <span class="n">bow2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Similarity between two BoW vectors&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bow1</span><span class="p">,</span> <span class="n">bow2</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SimpleSLAM</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple SLAM system (ORB-SLAM concept)&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ORB_create</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_HAMMING</span><span class="p">,</span> <span class="n">crossCheck</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1"># Keyframe list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_points</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c1"># 3D points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poses</span> <span class="o">=</span> <span class="p">[]</span>          <span class="c1"># Keyframe poses</span>

        <span class="c1"># Current state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_frame</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_kp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_desc</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Keyframe criteria</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kf_threshold</span> <span class="o">=</span> <span class="mi">30</span>   <span class="c1"># Minimum matches</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_matches</span><span class="p">,</span> <span class="n">motion</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decide if keyframe&quot;&quot;&quot;</span>

        <span class="c1"># Simple criteria: keyframe if few matches or large motion</span>
        <span class="n">translation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">motion</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_matches</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">kf_threshold</span> <span class="ow">or</span> <span class="n">translation</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">pose</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add keyframe&quot;&quot;&quot;</span>

        <span class="n">keyframe</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;frame&#39;</span><span class="p">:</span> <span class="n">frame</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="s1">&#39;keypoints&#39;</span><span class="p">:</span> <span class="n">kp</span><span class="p">,</span>
            <span class="s1">&#39;descriptors&#39;</span><span class="p">:</span> <span class="n">desc</span><span class="p">,</span>
            <span class="s1">&#39;pose&#39;</span><span class="p">:</span> <span class="n">pose</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyframe</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keyframe added: total </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process frame (Tracking)&quot;&quot;&quot;</span>

        <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">kp</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># First frame â†’ keyframe</span>
            <span class="n">pose</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_keyframe</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_frame</span> <span class="o">=</span> <span class="n">gray</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_kp</span> <span class="o">=</span> <span class="n">kp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_desc</span> <span class="o">=</span> <span class="n">desc</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span>

        <span class="c1"># Match with previous frame</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bf</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_desc</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">distance</span><span class="p">)[:</span><span class="mi">500</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
            <span class="c1"># Extract matched points</span>
            <span class="n">pts1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_kp</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">queryIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">])</span>
            <span class="n">pts2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">trainIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">])</span>

            <span class="c1"># Estimate pose using Essential Matrix</span>
            <span class="n">E</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findEssentialMat</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">recoverPose</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>

            <span class="c1"># Accumulate pose</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span> <span class="o">@</span> <span class="n">t</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span> <span class="o">=</span> <span class="n">R</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span>

            <span class="c1"># Check keyframe</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_keyframe</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">),</span> <span class="n">t</span><span class="p">):</span>
                <span class="n">pose</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span><span class="o">.</span><span class="n">copy</span><span class="p">()}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_keyframe</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>

        <span class="c1"># Update state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_frame</span> <span class="o">=</span> <span class="n">gray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_kp</span> <span class="o">=</span> <span class="n">kp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_desc</span> <span class="o">=</span> <span class="n">desc</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_camera_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return camera trajectory&quot;&quot;&quot;</span>
        <span class="n">trajectory</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">poses</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">pose</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">pose</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
            <span class="c1"># Camera position = -R^T * t</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="o">-</span><span class="n">R</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">t</span>
            <span class="n">trajectory</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="4-lidar-slam">4. LiDAR SLAM<a class="header-link" href="#4-lidar-slam" title="Permanent link">&para;</a></h2>
<h3 id="lidar-slam-overview">LiDAR SLAM Overview<a class="header-link" href="#lidar-slam-overview" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>LiDAR SLAM:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  LiDAR Sensor Characteristics:                                  â”‚
â”‚  - 360-degree scanning                                          â”‚
â”‚  - Accurate distance measurement                                â”‚
â”‚  - Robust to lighting conditions                                â”‚
â”‚  - Rich 3D point clouds                                         â”‚
â”‚                                                                 â”‚
â”‚  LiDAR Types:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 2D LiDAR         â”‚ Planar scan, affordable, robot      â”‚     â”‚
â”‚  â”‚ (e.g., RPLiDAR)  â”‚ vacuum cleaners                     â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ 3D LiDAR         â”‚ 3D point clouds, autonomous         â”‚     â”‚
â”‚  â”‚ (e.g., Velodyne) â”‚ driving                             â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ Solid-State      â”‚ Non-rotating, compact, latest       â”‚     â”‚
â”‚  â”‚ (e.g., Livox)    â”‚ trend                               â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                 â”‚
â”‚  Key Algorithms:                                                â”‚
â”‚  - ICP (Iterative Closest Point)                                â”‚
â”‚  - NDT (Normal Distributions Transform)                         â”‚
â”‚  - LOAM (LiDAR Odometry and Mapping)                            â”‚
â”‚  - LeGO-LOAM (Lightweight Ground-Optimized)                     â”‚
â”‚  - Cartographer (Google)                                        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="icp-iterative-closest-point">ICP (Iterative Closest Point)<a class="header-link" href="#icp-iterative-closest-point" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">KDTree</span>

<span class="k">def</span><span class="w"> </span><span class="nf">icp</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ICP algorithm for aligning two point clouds</span>

<span class="sd">    Parameters:</span>
<span class="sd">        source: Source point cloud (N x 3)</span>
<span class="sd">        target: Target point cloud (M x 3)</span>

<span class="sd">    Returns:</span>
<span class="sd">        R: Rotation matrix (3 x 3)</span>
<span class="sd">        t: Translation vector (3,)</span>
<span class="sd">        transformed: Transformed source points</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">src</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">prev_error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

    <span class="n">R_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">t_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># KD-Tree for efficient nearest neighbor search</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
        <span class="c1"># 1. Find nearest correspondences</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">correspondences</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

        <span class="c1"># 2. Estimate transformation (SVD)</span>
        <span class="n">src_centroid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tgt_centroid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">correspondences</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">src_centered</span> <span class="o">=</span> <span class="n">src</span> <span class="o">-</span> <span class="n">src_centroid</span>
        <span class="n">tgt_centered</span> <span class="o">=</span> <span class="n">correspondences</span> <span class="o">-</span> <span class="n">tgt_centroid</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">src_centered</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">tgt_centered</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">Vt</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Correct reflection</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Vt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">Vt</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">tgt_centroid</span> <span class="o">-</span> <span class="n">R</span> <span class="o">@</span> <span class="n">src_centroid</span>

        <span class="c1"># 3. Apply transformation</span>
        <span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span> <span class="o">@</span> <span class="n">src</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">t</span>

        <span class="c1"># Accumulate transformation</span>
        <span class="n">R_total</span> <span class="o">=</span> <span class="n">R</span> <span class="o">@</span> <span class="n">R_total</span>
        <span class="n">t_total</span> <span class="o">=</span> <span class="n">R</span> <span class="o">@</span> <span class="n">t_total</span> <span class="o">+</span> <span class="n">t</span>

        <span class="c1"># 4. Check convergence</span>
        <span class="n">mean_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">prev_error</span> <span class="o">-</span> <span class="n">mean_error</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ICP converged: </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> iterations, error: </span><span class="si">{</span><span class="n">mean_error</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="n">prev_error</span> <span class="o">=</span> <span class="n">mean_error</span>

    <span class="k">return</span> <span class="n">R_total</span><span class="p">,</span> <span class="n">t_total</span><span class="p">,</span> <span class="n">src</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LiDARSLAM</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple 2D LiDAR SLAM&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">map_resolution</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">map_resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>  <span class="c1"># x, y, theta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>

        <span class="c1"># Occupancy grid map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_size</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">map_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_size</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">map_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">scan_to_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_ranges</span><span class="p">,</span> <span class="n">scan_angles</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert scan data to 2D points&quot;&quot;&quot;</span>

        <span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan_ranges</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">scan_ranges</span> <span class="o">&lt;</span> <span class="mf">30.0</span><span class="p">)</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="n">scan_ranges</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">scan_angles</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">ranges</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">ranges</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">transform_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">pose</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform points to world coordinates&quot;&quot;&quot;</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">pose</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]</span>
        <span class="p">])</span>

        <span class="n">transformed</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span> <span class="o">@</span> <span class="n">points</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">transformed</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">point_to_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert points to grid coordinates&quot;&quot;&quot;</span>

        <span class="n">grid_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_origin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">grid_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_origin</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Limit to map bounds</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">grid_x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">grid_x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_size</span><span class="p">)</span> <span class="o">&amp;</span> \
                <span class="p">(</span><span class="n">grid_y</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">grid_y</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_size</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grid_x</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">valid</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_points</span><span class="p">,</span> <span class="n">pose</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update occupancy grid map&quot;&quot;&quot;</span>

        <span class="n">world_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_points</span><span class="p">(</span><span class="n">scan_points</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
        <span class="n">gx</span><span class="p">,</span> <span class="n">gy</span><span class="p">,</span> <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_to_grid</span><span class="p">(</span><span class="n">world_points</span><span class="p">)</span>

        <span class="c1"># Update occupancy probability (log odds)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_map</span><span class="p">[</span><span class="n">gy</span><span class="p">,</span> <span class="n">gx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_map</span><span class="p">[</span><span class="n">gy</span><span class="p">,</span> <span class="n">gx</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">match_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_points</span><span class="p">,</span> <span class="n">previous_points</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Estimate relative motion using scan matching&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_points</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_points</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Apply ICP</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">icp</span><span class="p">(</span><span class="n">current_points</span><span class="p">,</span> <span class="n">previous_points</span><span class="p">)</span>

        <span class="c1"># Extract theta in 2D</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">theta</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_ranges</span><span class="p">,</span> <span class="n">scan_angles</span><span class="p">,</span> <span class="n">prev_scan</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process scan&quot;&quot;&quot;</span>

        <span class="n">current_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_to_points</span><span class="p">(</span><span class="n">scan_ranges</span><span class="p">,</span> <span class="n">scan_angles</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prev_scan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prev_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_to_points</span><span class="p">(</span><span class="n">prev_scan</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prev_scan</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Scan matching</span>
            <span class="n">delta_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_scan</span><span class="p">(</span><span class="n">current_points</span><span class="p">,</span> <span class="n">prev_points</span><span class="p">)</span>

            <span class="c1"># Update pose</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta_pose</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="p">[</span><span class="mi">2</span><span class="p">])],</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
            <span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">R</span> <span class="o">@</span> <span class="n">delta_pose</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Update map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_map</span><span class="p">(</span><span class="n">current_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="p">)</span>

        <span class="c1"># Save trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_occupancy_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return occupancy map&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_map</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return trajectory&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="5-loop-closure">5. Loop Closure<a class="header-link" href="#5-loop-closure" title="Permanent link">&para;</a></h2>
<h3 id="loop-closure-concept">Loop Closure Concept<a class="header-link" href="#loop-closure-concept" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Loop</span><span class="w"> </span><span class="n">Closure</span><span class="p">:</span>
<span class="n">Recognizing</span><span class="w"> </span><span class="n">previously</span><span class="w"> </span><span class="n">visited</span><span class="w"> </span><span class="n">places</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">correct</span><span class="w"> </span><span class="n">accumulated</span><span class="w"> </span><span class="n">drift</span>

<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Problem</span><span class="p">:</span><span class="w"> </span><span class="n">Drift</span><span class="w"> </span><span class="p">(</span><span class="n">accumulated</span><span class="w"> </span><span class="n">error</span><span class="p">)</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="n">Actual</span><span class="w"> </span><span class="n">Path</span><span class="w">      </span><span class="n">Estimated</span><span class="w"> </span><span class="n">Path</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="n">drift</span><span class="p">)</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">      </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">         </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span><span class="w">         </span><span class="err">â•²</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">         </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â•²</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">         </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â•²</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">      </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="p">(</span><span class="n">closed</span><span class="w"> </span><span class="n">loop</span><span class="p">)</span><span class="w">     </span><span class="p">(</span><span class="n">open</span><span class="w"> </span><span class="n">curve</span><span class="p">)</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Solution</span><span class="p">:</span><span class="w"> </span><span class="n">Loop</span><span class="w"> </span><span class="n">Closure</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="mf">1.</span><span class="w"> </span><span class="n">Detect</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">visited</span><span class="w"> </span><span class="n">before</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="mf">2.</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="n">constraint</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="mf">3.</span><span class="w"> </span><span class="n">Pose</span><span class="w"> </span><span class="n">graph</span><span class="w"> </span><span class="n">optimization</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â—â”€â”€â”€â”€â—</span><span class="w">  </span><span class="err">â†</span><span class="w"> </span><span class="n">Loop</span><span class="w"> </span><span class="n">detection</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â†</span><span class="w"> </span><span class="n">Graph</span><span class="w"> </span><span class="n">optimization</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â—â”€â”€â”€â”€â—</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="p">(</span><span class="n">corrected</span><span class="w"> </span><span class="n">path</span><span class="p">)</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="loop-closure-implementation">Loop Closure Implementation<a class="header-link" href="#loop-closure-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LoopClosureDetector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bag of Words-based loop closure detection&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocabulary_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">min_score</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ORB_create</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_HAMMING</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary_size</span> <span class="o">=</span> <span class="n">vocabulary_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_score</span> <span class="o">=</span> <span class="n">min_score</span>

        <span class="c1"># Keyframe database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_bows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_descs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_kps</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Exclude recent N keyframes from loop candidates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_window</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_vocabulary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">training_images</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build vocabulary&quot;&quot;&quot;</span>

        <span class="n">all_descriptors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">training_images</span><span class="p">:</span>
            <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_descriptors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>

        <span class="n">all_desc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">all_descriptors</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># K-means</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span> <span class="o">+</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_MAX_ITER</span><span class="p">,</span>
                   <span class="mi">100</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">kmeans</span><span class="p">(</span>
            <span class="n">all_desc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary_size</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">criteria</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">KMEANS_RANDOM_CENTERS</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_bow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptors</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute BoW vector&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">descriptors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bf</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">descriptors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>

        <span class="n">bow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary_size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">bow</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">trainIdx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># L2 normalization</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bow</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">norm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bow</span> <span class="o">=</span> <span class="n">bow</span> <span class="o">/</span> <span class="n">norm</span>

        <span class="k">return</span> <span class="n">bow</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add keyframe&quot;&quot;&quot;</span>

        <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">kp</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">bow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_bow</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_bows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bow</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_descs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_kps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframe_bows</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect loop candidates&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">query_idx</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>

        <span class="n">query_bow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_bows</span><span class="p">[</span><span class="n">query_idx</span><span class="p">]</span>

        <span class="n">best_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Search only temporally distant keyframes</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">query_idx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_window</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">query_bow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_bows</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_score</span><span class="p">:</span>
                <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">best_match</span> <span class="o">=</span> <span class="n">i</span>

        <span class="k">if</span> <span class="n">best_match</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">best_match</span><span class="p">,</span> <span class="n">best_score</span>

        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">verify_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_idx</span><span class="p">,</span> <span class="n">candidate_idx</span><span class="p">,</span> <span class="n">min_inliers</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify loop using geometric verification&quot;&quot;&quot;</span>

        <span class="n">desc1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_descs</span><span class="p">[</span><span class="n">query_idx</span><span class="p">]</span>
        <span class="n">desc2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_descs</span><span class="p">[</span><span class="n">candidate_idx</span><span class="p">]</span>
        <span class="n">kp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_kps</span><span class="p">[</span><span class="n">query_idx</span><span class="p">]</span>
        <span class="n">kp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_kps</span><span class="p">[</span><span class="n">candidate_idx</span><span class="p">]</span>

        <span class="c1"># Feature matching</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bf</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">desc1</span><span class="p">,</span> <span class="n">desc2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">good_matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
                <span class="n">good_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Geometric verification using Fundamental Matrix</span>
        <span class="n">pts1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp1</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">queryIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good_matches</span><span class="p">])</span>
        <span class="n">pts2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp2</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">trainIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good_matches</span><span class="p">])</span>

        <span class="n">F</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findFundamentalMat</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FM_RANSAC</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">num_inliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_inliers</span> <span class="o">&gt;=</span> <span class="n">min_inliers</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;query_idx&#39;</span><span class="p">:</span> <span class="n">query_idx</span><span class="p">,</span>
                <span class="s1">&#39;match_idx&#39;</span><span class="p">:</span> <span class="n">candidate_idx</span><span class="p">,</span>
                <span class="s1">&#39;inliers&#39;</span><span class="p">:</span> <span class="n">num_inliers</span><span class="p">,</span>
                <span class="s1">&#39;pts1&#39;</span><span class="p">:</span> <span class="n">pts1</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;pts2&#39;</span><span class="p">:</span> <span class="n">pts2</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">class</span><span class="w"> </span><span class="nc">PoseGraphOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple pose graph optimization&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poses</span> <span class="o">=</span> <span class="p">[]</span>         <span class="c1"># Nodes (poses)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>         <span class="c1"># Edges (relative transforms)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop_constraints</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Loop constraints</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pose</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add pose node&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pose</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poses</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_odometry_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">relative_pose</span><span class="p">,</span> <span class="n">info_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add odometry edge&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">info_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">info_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
            <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span>
            <span class="s1">&#39;measurement&#39;</span><span class="p">:</span> <span class="n">relative_pose</span><span class="p">,</span>
            <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="n">info_matrix</span>
        <span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_loop_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">relative_pose</span><span class="p">,</span> <span class="n">info_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add loop constraint&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">info_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Loop constraints have high weight</span>
            <span class="n">info_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loop_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
            <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span>
            <span class="s1">&#39;measurement&#39;</span><span class="p">:</span> <span class="n">relative_pose</span><span class="p">,</span>
            <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="n">info_matrix</span>
        <span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Graph optimization (Gauss-Newton)&quot;&quot;&quot;</span>

        <span class="c1"># Simple implementation (in practice, use g2o, Ceres, etc.)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pose graph optimization recommended to use specialized libraries like g2o&quot;</span><span class="p">)</span>

        <span class="c1"># Simple correction using loop constraints</span>
        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_constraints</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">constraint</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">constraint</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span>

            <span class="c1"># Calculate accumulated drift</span>
            <span class="n">drift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poses</span><span class="p">[</span><span class="n">j</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">poses</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">drift</span> <span class="o">-=</span> <span class="n">constraint</span><span class="p">[</span><span class="s1">&#39;measurement&#39;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>

            <span class="c1"># Distribute drift using linear interpolation</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">poses</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">drift</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">poses</span>
</code></pre></div>

<hr />
<h2 id="6-slam-implementation-practice">6. SLAM Implementation Practice<a class="header-link" href="#6-slam-implementation-practice" title="Permanent link">&para;</a></h2>
<h3 id="simple-slam-system">Simple SLAM System<a class="header-link" href="#simple-slam-system" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SimpleVSLAM</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple Visual SLAM system&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">K</span>

        <span class="c1"># Modules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vo</span> <span class="o">=</span> <span class="n">MonocularVO</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop_detector</span> <span class="o">=</span> <span class="n">LoopClosureDetector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pose_graph</span> <span class="o">=</span> <span class="n">PoseGraphOptimizer</span><span class="p">()</span>

        <span class="c1"># State</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_interval</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process frame&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Visual Odometry</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vo</span><span class="o">.</span><span class="n">process_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># Add keyframe</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">kf_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_detector</span><span class="o">.</span><span class="n">add_keyframe</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

            <span class="c1"># Add node to pose graph</span>
            <span class="n">pose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># 2D approximation</span>
            <span class="n">node_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_graph</span><span class="o">.</span><span class="n">add_pose</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span>

            <span class="c1"># Connect edge with previous keyframe</span>
            <span class="k">if</span> <span class="n">node_idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">prev_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_graph</span><span class="o">.</span><span class="n">poses</span><span class="p">[</span><span class="n">node_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">relative</span> <span class="o">=</span> <span class="n">pose</span> <span class="o">-</span> <span class="n">prev_pose</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pose_graph</span><span class="o">.</span><span class="n">add_odometry_edge</span><span class="p">(</span>
                    <span class="n">node_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node_idx</span><span class="p">,</span> <span class="n">relative</span>
                <span class="p">)</span>

            <span class="c1"># Loop detection</span>
            <span class="k">if</span> <span class="n">kf_idx</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>  <span class="c1"># After sufficient keyframes</span>
                <span class="n">candidate</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_detector</span><span class="o">.</span><span class="n">detect_loop</span><span class="p">(</span><span class="n">kf_idx</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">candidate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">verified</span><span class="p">,</span> <span class="n">loop_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_detector</span><span class="o">.</span><span class="n">verify_loop</span><span class="p">(</span>
                        <span class="n">kf_idx</span><span class="p">,</span> <span class="n">candidate</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">verified</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loop detected: </span><span class="si">{</span><span class="n">kf_idx</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="c1"># Add loop constraint</span>
                        <span class="n">relative</span> <span class="o">=</span> <span class="n">pose</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_graph</span><span class="o">.</span><span class="n">poses</span><span class="p">[</span><span class="n">candidate</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pose_graph</span><span class="o">.</span><span class="n">add_loop_constraint</span><span class="p">(</span>
                            <span class="n">candidate</span><span class="p">,</span> <span class="n">node_idx</span><span class="p">,</span> <span class="n">relative</span>
                        <span class="p">)</span>

                        <span class="c1"># Optimize</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pose_graph</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return map&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vo</span><span class="o">.</span><span class="n">get_trajectory</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_optimized_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return optimized trajectory&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_graph</span><span class="o">.</span><span class="n">poses</span><span class="p">)</span>
</code></pre></div>

<h3 id="visualization">Visualization<a class="header-link" href="#visualization" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.mplot3d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Axes3D</span>

<span class="k">def</span><span class="w"> </span><span class="nf">visualize_slam_result</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">loop_closures</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize SLAM results&quot;&quot;&quot;</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="c1"># 2D trajectory</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
               <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Start&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">trajectory</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
               <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;End&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">loop_closures</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="n">loop_closures</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">lc</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">trajectory</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                    <span class="p">[</span><span class="n">trajectory</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
                    <span class="s1">&#39;g--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;2D Trajectory&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 3D trajectory</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;3D Trajectory&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">visualize_occupancy_map</span><span class="p">(</span><span class="n">occupancy_map</span><span class="p">,</span> <span class="n">trajectory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize occupancy map&quot;&quot;&quot;</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Display map</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">occupancy_map</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>

    <span class="c1"># Overlay trajectory</span>
    <span class="k">if</span> <span class="n">trajectory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Convert to map coordinates</span>
        <span class="n">map_center</span> <span class="o">=</span> <span class="n">occupancy_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">traj_map</span> <span class="o">=</span> <span class="n">trajectory</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">+</span> <span class="n">map_center</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">traj_map</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">traj_map</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">traj_map</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">traj_map</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">traj_map</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">traj_map</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Occupancy Grid Map&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Occupancy Probability&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="7-practice-problems">7. Practice Problems<a class="header-link" href="#7-practice-problems" title="Permanent link">&para;</a></h2>
<h3 id="problem-1-visual-odometry-implementation">Problem 1: Visual Odometry Implementation<a class="header-link" href="#problem-1-visual-odometry-implementation" title="Permanent link">&para;</a></h3>
<p>Implement monocular Visual Odometry.</p>
<p><strong>Requirements</strong>:
- ORB feature detection
- Optical flow or descriptor matching
- Pose estimation using Essential Matrix
- Trajectory visualization</p>
<details>
<summary>Hint</summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Essential Matrix</span>
<span class="n">E</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findEssentialMat</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">recoverPose</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

<span class="c1"># Accumulate pose</span>
<span class="n">cur_t</span> <span class="o">=</span> <span class="n">cur_t</span> <span class="o">+</span> <span class="n">cur_R</span> <span class="o">@</span> <span class="n">t</span>
<span class="n">cur_R</span> <span class="o">=</span> <span class="n">R</span> <span class="o">@</span> <span class="n">cur_R</span>
</code></pre></div>



</details>

<h3 id="problem-2-loop-closure-detection">Problem 2: Loop Closure Detection<a class="header-link" href="#problem-2-loop-closure-detection" title="Permanent link">&para;</a></h3>
<p>Implement BoW-based loop closure.</p>
<p><strong>Requirements</strong>:
- Build ORB vocabulary
- Compute BoW vectors
- Detect candidates based on similarity
- Geometric verification</p>
<details>
<summary>Hint</summary>


<div class="highlight"><pre><span></span><code><span class="c1"># BoW similarity</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bow1</span><span class="p">,</span> <span class="n">bow2</span><span class="p">)</span>

<span class="c1"># Geometric verification</span>
<span class="n">F</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findFundamentalMat</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FM_RANSAC</span><span class="p">)</span>
<span class="n">inliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</code></pre></div>



</details>

<h3 id="problem-3-icp-implementation">Problem 3: ICP Implementation<a class="header-link" href="#problem-3-icp-implementation" title="Permanent link">&para;</a></h3>
<p>Implement the ICP algorithm.</p>
<p><strong>Requirements</strong>:
- Nearest correspondence search
- Estimate transformation using SVD
- Iterative optimization
- Convergence criteria</p>
<details>
<summary>Hint</summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Calculate R, t using SVD</span>
<span class="n">H</span> <span class="o">=</span> <span class="n">src_centered</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">tgt_centered</span>
<span class="n">U</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">Vt</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">tgt_centroid</span> <span class="o">-</span> <span class="n">R</span> <span class="o">@</span> <span class="n">src_centroid</span>
</code></pre></div>



</details>

<h3 id="problem-4-occupancy-grid-map">Problem 4: Occupancy Grid Map<a class="header-link" href="#problem-4-occupancy-grid-map" title="Permanent link">&para;</a></h3>
<p>Create an occupancy grid map from LiDAR data.</p>
<p><strong>Requirements</strong>:
- Convert scan data to points
- Grid coordinate transformation
- Update occupancy probabilities
- Visualize map</p>
<details>
<summary>Hint</summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Log odds update</span>
<span class="n">log_odds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">))</span>
<span class="n">log_odds</span><span class="p">[</span><span class="n">occupied</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span>
<span class="n">log_odds</span><span class="p">[</span><span class="n">free</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
<span class="n">p</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">log_odds</span><span class="p">))</span>
</code></pre></div>



</details>

<h3 id="problem-5-complete-slam-system">Problem 5: Complete SLAM System<a class="header-link" href="#problem-5-complete-slam-system" title="Permanent link">&para;</a></h3>
<p>Implement a SLAM system integrating VO, loop closure, and mapping.</p>
<p><strong>Requirements</strong>:
- Keyframe management
- Loop detection and verification
- Pose graph optimization
- 3D map generation</p>
<details>
<summary>Hint</summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Integrated system</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SLAM</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="c1"># 1. Tracking</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># 2. Update map if keyframe</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_keyframe</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_mapping</span><span class="p">()</span>

            <span class="c1"># 3. Loop detection</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_loop</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimize_graph</span><span class="p">()</span>
</code></pre></div>



</details>

<hr />
<h2 id="next-steps">Next Steps<a class="header-link" href="#next-steps" title="Permanent link">&para;</a></h2>
<ul>
<li>Use real SLAM libraries (ORB-SLAM3, RTAB-Map)</li>
<li>ROS integration</li>
<li>Visual-Inertial SLAM</li>
<li>Deep learning-based SLAM</li>
</ul>
<hr />
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://github.com/UZ-SLAMLab/ORB_SLAM3">ORB-SLAM3 GitHub</a></li>
<li><a href="https://www.youtube.com/playlist?list=PLgnQpQtFTOGQrZ4O5QzbIHgl3b1JHimN_">SLAM Tutorial - Cyrill Stachniss</a></li>
<li><a href="https://www.robots.ox.ac.uk/~vgg/hzbook/">Multiple View Geometry in Computer Vision</a></li>
<li><a href="http://www.probabilistic-robotics.org/">Probabilistic Robotics (Thrun et al.)</a></li>
<li><a href="https://www.ri.cmu.edu/pub_files/2014/7/Ji_LidarMapping_RSS2014_v8.pdf">LOAM Paper</a></li>
<li><a href="https://google-cartographer.readthedocs.io/">Cartographer</a></li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Computer_Vision/22_Depth_Estimation.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Monocular Depth Estimation</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Computer_Vision/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}