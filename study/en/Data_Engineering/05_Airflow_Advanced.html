{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airflow Advanced - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">üíª</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        ÌïúÍµ≠Ïñ¥
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">‚òÄÔ∏è</span>
                    <span class="theme-icon dark">üåô</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Data_Engineering/">Data Engineering</a>
    <span class="separator">/</span>
    <span class="current">Airflow Advanced</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Airflow Advanced</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Data_Engineering/04_Apache_Airflow_Basics.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Apache Airflow Basics</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Data_Engineering/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Data_Engineering/06_Prefect_Modern_Orchestration.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Prefect Modern Orchestration</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#1-xcom-cross-communication">1. XCom (Cross-Communication)</a><ul>
<li><a href="#11-basic-xcom-usage">1.1 Basic XCom Usage</a></li>
<li><a href="#12-using-xcom-in-jinja-templates">1.2 Using XCom in Jinja Templates</a></li>
<li><a href="#13-xcom-limitations-and-alternatives">1.3 XCom Limitations and Alternatives</a></li>
</ul>
</li>
<li><a href="#2-dynamic-dag-generation">2. Dynamic DAG Generation</a><ul>
<li><a href="#21-configuration-based-dynamic-dags">2.1 Configuration-Based Dynamic DAGs</a></li>
<li><a href="#22-yamljson-based-dynamic-dags">2.2 YAML/JSON-Based Dynamic DAGs</a></li>
<li><a href="#23-dynamic-task-generation">2.3 Dynamic Task Generation</a></li>
</ul>
</li>
<li><a href="#3-sensors">3. Sensors</a><ul>
<li><a href="#31-built-in-sensors">3.1 Built-in Sensors</a></li>
<li><a href="#32-custom-sensor">3.2 Custom Sensor</a></li>
<li><a href="#33-sensor-modes">3.3 Sensor Modes</a></li>
</ul>
</li>
<li><a href="#4-hooks-and-connections">4. Hooks and Connections</a><ul>
<li><a href="#41-connection-configuration">4.1 Connection Configuration</a></li>
<li><a href="#42-using-hooks">4.2 Using Hooks</a></li>
<li><a href="#43-custom-hook">4.3 Custom Hook</a></li>
</ul>
</li>
<li><a href="#5-taskgroup">5. TaskGroup</a><ul>
<li><a href="#51-basic-taskgroup-usage">5.1 Basic TaskGroup Usage</a></li>
<li><a href="#52-nested-taskgroups">5.2 Nested TaskGroups</a></li>
<li><a href="#53-dynamic-taskgroups">5.3 Dynamic TaskGroups</a></li>
</ul>
</li>
<li><a href="#6-branching-and-conditional-execution">6. Branching and Conditional Execution</a><ul>
<li><a href="#61-branchpythonoperator">6.1 BranchPythonOperator</a></li>
<li><a href="#62-shortcircuitoperator">6.2 ShortCircuitOperator</a></li>
</ul>
</li>
<li><a href="#practice-problems">Practice Problems</a><ul>
<li><a href="#problem-1-using-xcom">Problem 1: Using XCom</a></li>
<li><a href="#problem-2-dynamic-dag">Problem 2: Dynamic DAG</a></li>
<li><a href="#problem-3-using-sensors">Problem 3: Using Sensors</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="airflow-advanced">Airflow Advanced<a class="header-link" href="#airflow-advanced" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="header-link" href="#overview" title="Permanent link">&para;</a></h2>
<p>This document covers advanced Airflow features including XCom for data sharing between tasks, dynamic DAG generation, Sensors, Hooks, TaskGroups, and more. Leveraging these features allows you to build more flexible and powerful pipelines.</p>
<hr />
<h2 id="1-xcom-cross-communication">1. XCom (Cross-Communication)<a class="header-link" href="#1-xcom-cross-communication" title="Permanent link">&para;</a></h2>
<h3 id="11-basic-xcom-usage">1.1 Basic XCom Usage<a class="header-link" href="#11-basic-xcom-usage" title="Permanent link">&para;</a></h3>
<p>XCom is a mechanism for sharing small amounts of data between tasks.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">airflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.operators.python</span><span class="w"> </span><span class="kn">import</span> <span class="n">PythonOperator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span><span class="w"> </span><span class="nf">push_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Push data to XCom&quot;&quot;&quot;</span>
    <span class="n">ti</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ti&#39;</span><span class="p">]</span>

    <span class="c1"># Method 1: Using xcom_push</span>
    <span class="n">ti</span><span class="o">.</span><span class="n">xcom_push</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;my_key&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">})</span>

    <span class="c1"># Method 2: Return value (automatically saved with key=&#39;return_value&#39;)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">pull_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pull data from XCom&quot;&quot;&quot;</span>
    <span class="n">ti</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ti&#39;</span><span class="p">]</span>

    <span class="c1"># Method 1: Pull by specific key</span>
    <span class="n">custom_data</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">xcom_pull</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;my_key&#39;</span><span class="p">,</span> <span class="n">task_ids</span><span class="o">=</span><span class="s1">&#39;push_task&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Custom data: </span><span class="si">{</span><span class="n">custom_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Method 2: Pull return value</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">xcom_pull</span><span class="p">(</span><span class="n">task_ids</span><span class="o">=</span><span class="s1">&#39;push_task&#39;</span><span class="p">)</span>  <span class="c1"># key=&#39;return_value&#39; by default</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return value: </span><span class="si">{</span><span class="n">return_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Method 3: Pull from multiple tasks</span>
    <span class="n">multiple_results</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">xcom_pull</span><span class="p">(</span><span class="n">task_ids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;task1&#39;</span><span class="p">,</span> <span class="s1">&#39;task2&#39;</span><span class="p">])</span>


<span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">&#39;xcom_example&#39;</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">schedule_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>

    <span class="n">push_task</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;push_task&#39;</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">push_data</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">pull_task</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;pull_task&#39;</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">pull_data</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">push_task</span> <span class="o">&gt;&gt;</span> <span class="n">pull_task</span>
</code></pre></div>

<h3 id="12-using-xcom-in-jinja-templates">1.2 Using XCom in Jinja Templates<a class="header-link" href="#12-using-xcom-in-jinja-templates" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">airflow.operators.bash</span><span class="w"> </span><span class="kn">import</span> <span class="n">BashOperator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.providers.postgres.operators.postgres</span><span class="w"> </span><span class="kn">import</span> <span class="n">PostgresOperator</span>

<span class="c1"># Using XCom in Bash</span>
<span class="n">bash_task</span> <span class="o">=</span> <span class="n">BashOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;bash_with_xcom&#39;</span><span class="p">,</span>
    <span class="n">bash_command</span><span class="o">=</span><span class="s1">&#39;echo &quot;Result: {{ ti.xcom_pull(task_ids=&quot;push_task&quot;) }}&quot;&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Using XCom in SQL</span>
<span class="n">sql_task</span> <span class="o">=</span> <span class="n">PostgresOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;sql_with_xcom&#39;</span><span class="p">,</span>
    <span class="n">postgres_conn_id</span><span class="o">=</span><span class="s1">&#39;my_postgres&#39;</span><span class="p">,</span>
    <span class="n">sql</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO process_log (task_id, result_count, processed_at)</span>
<span class="s2">        VALUES (</span>
<span class="s2">            &#39;data_load&#39;,</span>
<span class="s2">            {{ ti.xcom_pull(task_ids=&#39;count_task&#39;, key=&#39;row_count&#39;) }},</span>
<span class="s2">            NOW()</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="13-xcom-limitations-and-alternatives">1.3 XCom Limitations and Alternatives<a class="header-link" href="#13-xcom-limitations-and-alternatives" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># XCom limitation: default 1GB (stored in DB, recommended for small data only)</span>

<span class="c1"># Handling large data</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LargeDataHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pattern for handling large data&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_to_storage</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save data to external storage and pass only the path via XCom&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

        <span class="c1"># Save to S3, GCS, etc.</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>  <span class="c1"># Return only the path</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_from_storage</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load data from path&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>


<span class="c1"># Usage example</span>
<span class="k">def</span><span class="w"> </span><span class="nf">produce_large_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

    <span class="c1"># Generate large dataset</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)})</span>

    <span class="c1"># Save to S3 and return only the path</span>
    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;s3://bucket/data/</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/output.parquet&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path</span>  <span class="c1"># Store only path in XCom</span>


<span class="k">def</span><span class="w"> </span><span class="nf">consume_large_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

    <span class="n">ti</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ti&#39;</span><span class="p">]</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">xcom_pull</span><span class="p">(</span><span class="n">task_ids</span><span class="o">=</span><span class="s1">&#39;produce_task&#39;</span><span class="p">)</span>

    <span class="c1"># Load data from path</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="2-dynamic-dag-generation">2. Dynamic DAG Generation<a class="header-link" href="#2-dynamic-dag-generation" title="Permanent link">&para;</a></h2>
<h3 id="21-configuration-based-dynamic-dags">2.1 Configuration-Based Dynamic DAGs<a class="header-link" href="#21-configuration-based-dynamic-dags" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># dags/dynamic_dag_factory.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.operators.python</span><span class="w"> </span><span class="kn">import</span> <span class="n">PythonOperator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># Define configuration</span>
<span class="n">DAG_CONFIGS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;dag_id&#39;</span><span class="p">:</span> <span class="s1">&#39;etl_customers&#39;</span><span class="p">,</span>
        <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="s1">&#39;customers&#39;</span><span class="p">,</span>
        <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;0 1 * * *&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;dag_id&#39;</span><span class="p">:</span> <span class="s1">&#39;etl_orders&#39;</span><span class="p">,</span>
        <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="s1">&#39;orders&#39;</span><span class="p">,</span>
        <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;0 2 * * *&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;dag_id&#39;</span><span class="p">:</span> <span class="s1">&#39;etl_products&#39;</span><span class="p">,</span>
        <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="s1">&#39;products&#39;</span><span class="p">,</span>
        <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;0 3 * * *&#39;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_dag</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DAG</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create DAG based on configuration&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">dag</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">(</span>
        <span class="n">dag_id</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dag_id&#39;</span><span class="p">],</span>
        <span class="n">schedule_interval</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;schedule&#39;</span><span class="p">],</span>
        <span class="n">start_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">catchup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dynamic&#39;</span><span class="p">,</span> <span class="s1">&#39;etl&#39;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">dag</span><span class="p">:</span>
        <span class="n">extract</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
            <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;extract&#39;</span><span class="p">,</span>
            <span class="n">python_callable</span><span class="o">=</span><span class="n">extract_table</span><span class="p">,</span>
            <span class="n">op_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;table_name&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]},</span>
        <span class="p">)</span>

        <span class="n">load</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
            <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;load&#39;</span><span class="p">,</span>
            <span class="n">python_callable</span><span class="o">=</span><span class="n">load_table</span><span class="p">,</span>
            <span class="n">op_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;table_name&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]},</span>
        <span class="p">)</span>

        <span class="n">extract</span> <span class="o">&gt;&gt;</span> <span class="n">load</span>

    <span class="k">return</span> <span class="n">dag</span>


<span class="c1"># Register DAGs in globals() (so Airflow can discover them)</span>
<span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">DAG_CONFIGS</span><span class="p">:</span>
    <span class="n">dag_id</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dag_id&#39;</span><span class="p">]</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="n">dag_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_dag</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>

<h3 id="22-yamljson-based-dynamic-dags">2.2 YAML/JSON-Based Dynamic DAGs<a class="header-link" href="#22-yamljson-based-dynamic-dags" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># dags/yaml_driven_dag.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.operators.python</span><span class="w"> </span><span class="kn">import</span> <span class="n">PythonOperator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># Load YAML configuration</span>
<span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;configs&#39;</span> <span class="o">/</span> <span class="s1">&#39;dag_configs.yaml&#39;</span>

<span class="c1"># Example configs/dag_configs.yaml:</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">dags:</span>
<span class="sd">  - id: sales_etl</span>
<span class="sd">    schedule: &quot;0 6 * * *&quot;</span>
<span class="sd">    tasks:</span>
<span class="sd">      - name: extract</span>
<span class="sd">        type: python</span>
<span class="sd">        function: extract_sales</span>
<span class="sd">      - name: transform</span>
<span class="sd">        type: python</span>
<span class="sd">        function: transform_sales</span>
<span class="sd">      - name: load</span>
<span class="sd">        type: python</span>
<span class="sd">        function: load_sales</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_config</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_task_callable</span><span class="p">(</span><span class="n">func_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create callable from function name&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">task_func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing </span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">task_func</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_dag_from_yaml</span><span class="p">(</span><span class="n">dag_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DAG</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create DAG from YAML configuration&quot;&quot;&quot;</span>

    <span class="n">dag</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">(</span>
        <span class="n">dag_id</span><span class="o">=</span><span class="n">dag_config</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
        <span class="n">schedule_interval</span><span class="o">=</span><span class="n">dag_config</span><span class="p">[</span><span class="s1">&#39;schedule&#39;</span><span class="p">],</span>
        <span class="n">start_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">catchup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">dag</span><span class="p">:</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">task_config</span> <span class="ow">in</span> <span class="n">dag_config</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">]:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
                <span class="n">task_id</span><span class="o">=</span><span class="n">task_config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="n">python_callable</span><span class="o">=</span><span class="n">create_task_callable</span><span class="p">(</span><span class="n">task_config</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="n">tasks</span><span class="p">[</span><span class="n">task_config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">task</span>

        <span class="c1"># Set sequential dependencies</span>
        <span class="n">task_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">task_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">task_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">task_list</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">dag</span>


<span class="c1"># Create and register DAGs</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">dag_config</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dags&#39;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">dag_id</span> <span class="o">=</span> <span class="n">dag_config</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="nb">globals</span><span class="p">()[</span><span class="n">dag_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_dag_from_yaml</span><span class="p">(</span><span class="n">dag_config</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading DAG config: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="23-dynamic-task-generation">2.3 Dynamic Task Generation<a class="header-link" href="#23-dynamic-task-generation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">airflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.operators.python</span><span class="w"> </span><span class="kn">import</span> <span class="n">PythonOperator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.operators.empty</span><span class="w"> </span><span class="kn">import</span> <span class="n">EmptyOperator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># List of tables to process</span>
<span class="n">TABLES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;orders&#39;</span><span class="p">,</span> <span class="s1">&#39;products&#39;</span><span class="p">,</span> <span class="s1">&#39;reviews&#39;</span><span class="p">,</span> <span class="s1">&#39;inventory&#39;</span><span class="p">]</span>

<span class="k">with</span> <span class="n">DAG</span><span class="p">(</span>
    <span class="n">dag_id</span><span class="o">=</span><span class="s1">&#39;dynamic_tasks_example&#39;</span><span class="p">,</span>
    <span class="n">start_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">schedule_interval</span><span class="o">=</span><span class="s1">&#39;@daily&#39;</span><span class="p">,</span>
    <span class="n">catchup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">EmptyOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">EmptyOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>

    <span class="c1"># Dynamically create tasks</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">TABLES</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">process_table</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing table: </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
            <span class="n">task_id</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;process_</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">python_callable</span><span class="o">=</span><span class="n">process_table</span><span class="p">,</span>
            <span class="n">op_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;table_name&#39;</span><span class="p">:</span> <span class="n">table</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="n">task</span> <span class="o">&gt;&gt;</span> <span class="n">end</span>
</code></pre></div>

<hr />
<h2 id="3-sensors">3. Sensors<a class="header-link" href="#3-sensors" title="Permanent link">&para;</a></h2>
<h3 id="31-built-in-sensors">3.1 Built-in Sensors<a class="header-link" href="#31-built-in-sensors" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">airflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.sensors.filesystem</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileSensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.sensors.external_task</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExternalTaskSensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.sensors.time_delta</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeDeltaSensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.providers.http.sensors.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpSensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.providers.postgres.sensors.postgres</span><span class="w"> </span><span class="kn">import</span> <span class="n">SqlSensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">&#39;sensor_examples&#39;</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">schedule_interval</span><span class="o">=</span><span class="s1">&#39;@daily&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>

    <span class="c1"># 1. FileSensor - wait for file existence</span>
    <span class="n">wait_for_file</span> <span class="o">=</span> <span class="n">FileSensor</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;wait_for_file&#39;</span><span class="p">,</span>
        <span class="n">filepath</span><span class="o">=</span><span class="s1">&#39;/data/input/{{ ds }}/data.csv&#39;</span><span class="p">,</span>
        <span class="n">poke_interval</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>           <span class="c1"># Check interval (seconds)</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>               <span class="c1"># Timeout (seconds)</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;poke&#39;</span><span class="p">,</span>                <span class="c1"># poke or reschedule</span>
    <span class="p">)</span>

    <span class="c1"># 2. ExternalTaskSensor - wait for another DAG&#39;s task completion</span>
    <span class="n">wait_for_upstream</span> <span class="o">=</span> <span class="n">ExternalTaskSensor</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;wait_for_upstream&#39;</span><span class="p">,</span>
        <span class="n">external_dag_id</span><span class="o">=</span><span class="s1">&#39;upstream_dag&#39;</span><span class="p">,</span>
        <span class="n">external_task_id</span><span class="o">=</span><span class="s1">&#39;final_task&#39;</span><span class="p">,</span>
        <span class="n">execution_delta</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># Same execution_date</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">7200</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reschedule&#39;</span><span class="p">,</span>          <span class="c1"># Return worker and reschedule</span>
    <span class="p">)</span>

    <span class="c1"># 3. HttpSensor - check HTTP endpoint</span>
    <span class="n">wait_for_api</span> <span class="o">=</span> <span class="n">HttpSensor</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;wait_for_api&#39;</span><span class="p">,</span>
        <span class="n">http_conn_id</span><span class="o">=</span><span class="s1">&#39;my_api&#39;</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;/health&#39;</span><span class="p">,</span>
        <span class="n">request_params</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">response_check</span><span class="o">=</span><span class="k">lambda</span> <span class="n">response</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">poke_interval</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 4. SqlSensor - check SQL condition</span>
    <span class="n">wait_for_data</span> <span class="o">=</span> <span class="n">SqlSensor</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;wait_for_data&#39;</span><span class="p">,</span>
        <span class="n">conn_id</span><span class="o">=</span><span class="s1">&#39;my_postgres&#39;</span><span class="p">,</span>
        <span class="n">sql</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT COUNT(*) &gt; 0</span>
<span class="s2">            FROM staging_table</span>
<span class="s2">            WHERE date = &#39;{{ ds }}&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="n">poke_interval</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 5. TimeDeltaSensor - wait for time duration</span>
    <span class="n">wait_30_minutes</span> <span class="o">=</span> <span class="n">TimeDeltaSensor</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;wait_30_minutes&#39;</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>

<h3 id="32-custom-sensor">3.2 Custom Sensor<a class="header-link" href="#32-custom-sensor" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">airflow.sensors.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseSensorOperator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.utils.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">apply_defaults</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>

<span class="k">class</span><span class="w"> </span><span class="nc">S3KeySensorCustom</span><span class="p">(</span><span class="n">BaseSensorOperator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom Sensor to check S3 key existence&quot;&quot;&quot;</span>

    <span class="n">template_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bucket_key&#39;</span><span class="p">]</span>

    <span class="nd">@apply_defaults</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bucket_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">bucket_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">aws_conn_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;aws_default&#39;</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span> <span class="o">=</span> <span class="n">bucket_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket_key</span> <span class="o">=</span> <span class="n">bucket_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aws_conn_id</span> <span class="o">=</span> <span class="n">aws_conn_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">poke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check condition (returns True on success)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking for s3://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create S3 client</span>
        <span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">s3</span><span class="o">.</span><span class="n">head_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;File found!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">s3</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;404&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;File not found, waiting...&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">raise</span>


<span class="c1"># Usage</span>
<span class="n">wait_for_s3</span> <span class="o">=</span> <span class="n">S3KeySensorCustom</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;wait_for_s3_file&#39;</span><span class="p">,</span>
    <span class="n">bucket_name</span><span class="o">=</span><span class="s1">&#39;my-bucket&#39;</span><span class="p">,</span>
    <span class="n">bucket_key</span><span class="o">=</span><span class="s1">&#39;data/{{ ds }}/input.parquet&#39;</span><span class="p">,</span>
    <span class="n">poke_interval</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reschedule&#39;</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="33-sensor-modes">3.3 Sensor Modes<a class="header-link" href="#33-sensor-modes" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># poke vs reschedule mode comparison</span>
<span class="n">sensor_modes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;poke&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Occupies worker slot while waiting&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pros&#39;</span><span class="p">:</span> <span class="s1">&#39;Fast response time&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cons&#39;</span><span class="p">:</span> <span class="s1">&#39;Wastes worker resources&#39;</span><span class="p">,</span>
        <span class="s1">&#39;use_case&#39;</span><span class="p">:</span> <span class="s1">&#39;Short wait time expected&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;reschedule&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Returns worker and reschedules&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pros&#39;</span><span class="p">:</span> <span class="s1">&#39;Efficient worker resource usage&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cons&#39;</span><span class="p">:</span> <span class="s1">&#39;Slightly slower response time&#39;</span><span class="p">,</span>
        <span class="s1">&#39;use_case&#39;</span><span class="p">:</span> <span class="s1">&#39;Long wait time expected&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Recommended configuration</span>
<span class="n">wait_for_file</span> <span class="o">=</span> <span class="n">FileSensor</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;wait_for_file&#39;</span><span class="p">,</span>
    <span class="n">filepath</span><span class="o">=</span><span class="s1">&#39;/data/input.csv&#39;</span><span class="p">,</span>
    <span class="n">poke_interval</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>      <span class="c1"># Check every 5 minutes</span>
    <span class="n">timeout</span><span class="o">=</span><span class="mi">86400</span><span class="p">,</span>          <span class="c1"># 24 hour timeout</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reschedule&#39;</span><span class="p">,</span>      <span class="c1"># Use reschedule for long waits</span>
    <span class="n">soft_fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>         <span class="c1"># Skip on timeout (instead of failing)</span>
<span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="4-hooks-and-connections">4. Hooks and Connections<a class="header-link" href="#4-hooks-and-connections" title="Permanent link">&para;</a></h2>
<h3 id="41-connection-configuration">4.1 Connection Configuration<a class="header-link" href="#41-connection-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Configure Connection via Airflow UI or CLI</span>
<span class="c1"># Admin &gt; Connections &gt; Add</span>

<span class="c1"># Add Connection via CLI</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">airflow connections add &#39;my_postgres&#39; \</span>
<span class="sd">    --conn-type &#39;postgres&#39; \</span>
<span class="sd">    --conn-host &#39;localhost&#39; \</span>
<span class="sd">    --conn-port &#39;5432&#39; \</span>
<span class="sd">    --conn-login &#39;user&#39; \</span>
<span class="sd">    --conn-password &#39;password&#39; \</span>
<span class="sd">    --conn-schema &#39;mydb&#39;</span>

<span class="sd">airflow connections add &#39;my_s3&#39; \</span>
<span class="sd">    --conn-type &#39;aws&#39; \</span>
<span class="sd">    --conn-extra &#39;{&quot;aws_access_key_id&quot;: &quot;xxx&quot;, &quot;aws_secret_access_key&quot;: &quot;yyy&quot;, &quot;region_name&quot;: &quot;us-east-1&quot;}&#39;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Configure Connection via environment variable</span>
<span class="c1"># AIRFLOW_CONN_MY_POSTGRES=&#39;postgresql://user:password@localhost:5432/mydb&#39;</span>
</code></pre></div>

<h3 id="42-using-hooks">4.2 Using Hooks<a class="header-link" href="#42-using-hooks" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">airflow.providers.postgres.hooks.postgres</span><span class="w"> </span><span class="kn">import</span> <span class="n">PostgresHook</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.providers.amazon.aws.hooks.s3</span><span class="w"> </span><span class="kn">import</span> <span class="n">S3Hook</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.providers.http.hooks.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpHook</span>

<span class="k">def</span><span class="w"> </span><span class="nf">use_postgres_hook</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Using PostgreSQL Hook&quot;&quot;&quot;</span>
    <span class="n">hook</span> <span class="o">=</span> <span class="n">PostgresHook</span><span class="p">(</span><span class="n">postgres_conn_id</span><span class="o">=</span><span class="s1">&#39;my_postgres&#39;</span><span class="p">)</span>

    <span class="c1"># Execute SQL</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">get_records</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users LIMIT 10&quot;</span><span class="p">)</span>

    <span class="c1"># Return as DataFrame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">get_pandas_df</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users&quot;</span><span class="p">)</span>

    <span class="c1"># Insert rows</span>
    <span class="n">hook</span><span class="o">.</span><span class="n">insert_rows</span><span class="p">(</span>
        <span class="n">table</span><span class="o">=</span><span class="s1">&#39;users&#39;</span><span class="p">,</span>
        <span class="n">rows</span><span class="o">=</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;John&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Jane&#39;</span><span class="p">)],</span>
        <span class="n">target_fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Use connection directly</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE users SET active = true&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">use_s3_hook</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Using S3 Hook&quot;&quot;&quot;</span>
    <span class="n">hook</span> <span class="o">=</span> <span class="n">S3Hook</span><span class="p">(</span><span class="n">aws_conn_id</span><span class="o">=</span><span class="s1">&#39;my_s3&#39;</span><span class="p">)</span>

    <span class="c1"># Upload file</span>
    <span class="n">hook</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;/tmp/data.csv&#39;</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="s1">&#39;data/output.csv&#39;</span><span class="p">,</span>
        <span class="n">bucket_name</span><span class="o">=</span><span class="s1">&#39;my-bucket&#39;</span><span class="p">,</span>
        <span class="n">replace</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Download file</span>
    <span class="n">hook</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="s1">&#39;data/input.csv&#39;</span><span class="p">,</span>
        <span class="n">bucket_name</span><span class="o">=</span><span class="s1">&#39;my-bucket&#39;</span><span class="p">,</span>
        <span class="n">local_path</span><span class="o">=</span><span class="s1">&#39;/tmp/input.csv&#39;</span>
    <span class="p">)</span>

    <span class="c1"># List files</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">list_keys</span><span class="p">(</span>
        <span class="n">bucket_name</span><span class="o">=</span><span class="s1">&#39;my-bucket&#39;</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;data/&#39;</span><span class="p">,</span>
        <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;/&#39;</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">use_http_hook</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Using HTTP Hook&quot;&quot;&quot;</span>
    <span class="n">hook</span> <span class="o">=</span> <span class="n">HttpHook</span><span class="p">(</span><span class="n">http_conn_id</span><span class="o">=</span><span class="s1">&#39;my_api&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;/api/data&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s1">&#39;Bearer token&#39;</span><span class="p">},</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;param&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>

<h3 id="43-custom-hook">4.3 Custom Hook<a class="header-link" href="#43-custom-hook" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">airflow.hooks.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseHook</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyCustomHook</span><span class="p">(</span><span class="n">BaseHook</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom API Hook&quot;&quot;&quot;</span>

    <span class="n">conn_name_attr</span> <span class="o">=</span> <span class="s1">&#39;my_custom_conn_id&#39;</span>
    <span class="n">default_conn_name</span> <span class="o">=</span> <span class="s1">&#39;my_custom_default&#39;</span>
    <span class="n">conn_type</span> <span class="o">=</span> <span class="s1">&#39;http&#39;</span>
    <span class="n">hook_name</span> <span class="o">=</span> <span class="s1">&#39;My Custom Hook&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_custom_conn_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">default_conn_name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_custom_conn_id</span> <span class="o">=</span> <span class="n">my_custom_conn_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_conn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load connection configuration&quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_custom_conn_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">conn</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">password</span>
        <span class="k">return</span> <span class="n">conn</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make API request&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span>
        <span class="p">}</span>

        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="n">data</span>
        <span class="p">)</span>

        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>


<span class="c1"># Usage</span>
<span class="k">def</span><span class="w"> </span><span class="nf">call_custom_api</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">hook</span> <span class="o">=</span> <span class="n">MyCustomHook</span><span class="p">(</span><span class="n">my_custom_conn_id</span><span class="o">=</span><span class="s1">&#39;my_api&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">make_request</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<hr />
<h2 id="5-taskgroup">5. TaskGroup<a class="header-link" href="#5-taskgroup" title="Permanent link">&para;</a></h2>
<h3 id="51-basic-taskgroup-usage">5.1 Basic TaskGroup Usage<a class="header-link" href="#51-basic-taskgroup-usage" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">airflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.operators.python</span><span class="w"> </span><span class="kn">import</span> <span class="n">PythonOperator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.operators.empty</span><span class="w"> </span><span class="kn">import</span> <span class="n">EmptyOperator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.utils.task_group</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaskGroup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">&#39;taskgroup_example&#39;</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">schedule_interval</span><span class="o">=</span><span class="s1">&#39;@daily&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">EmptyOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>

    <span class="c1"># Group related tasks with TaskGroup</span>
    <span class="k">with</span> <span class="n">TaskGroup</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="s1">&#39;extract_group&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">extract_group</span><span class="p">:</span>
        <span class="n">extract_users</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
            <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;extract_users&#39;</span><span class="p">,</span>
            <span class="n">python_callable</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting users&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">extract_orders</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
            <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;extract_orders&#39;</span><span class="p">,</span>
            <span class="n">python_callable</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting orders&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">extract_products</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
            <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;extract_products&#39;</span><span class="p">,</span>
            <span class="n">python_callable</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting products&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="n">TaskGroup</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="s1">&#39;transform_group&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">transform_group</span><span class="p">:</span>
        <span class="n">transform_users</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
            <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;transform_users&#39;</span><span class="p">,</span>
            <span class="n">python_callable</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transforming users&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">transform_orders</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
            <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;transform_orders&#39;</span><span class="p">,</span>
            <span class="n">python_callable</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transforming orders&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="n">TaskGroup</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="s1">&#39;load_group&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">load_group</span><span class="p">:</span>
        <span class="n">load_warehouse</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
            <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;load_warehouse&#39;</span><span class="p">,</span>
            <span class="n">python_callable</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading to warehouse&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">EmptyOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>

    <span class="c1"># Dependencies between TaskGroups</span>
    <span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="n">extract_group</span> <span class="o">&gt;&gt;</span> <span class="n">transform_group</span> <span class="o">&gt;&gt;</span> <span class="n">load_group</span> <span class="o">&gt;&gt;</span> <span class="n">end</span>
</code></pre></div>

<h3 id="52-nested-taskgroups">5.2 Nested TaskGroups<a class="header-link" href="#52-nested-taskgroups" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">airflow.utils.task_group</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaskGroup</span>

<span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">&#39;nested_taskgroup&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>

    <span class="k">with</span> <span class="n">TaskGroup</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="s1">&#39;data_processing&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data_processing</span><span class="p">:</span>

        <span class="k">with</span> <span class="n">TaskGroup</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="s1">&#39;source_a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_a</span><span class="p">:</span>
            <span class="n">extract_a</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;extract&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
            <span class="n">transform_a</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;transform&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
            <span class="n">extract_a</span> <span class="o">&gt;&gt;</span> <span class="n">transform_a</span>

        <span class="k">with</span> <span class="n">TaskGroup</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="s1">&#39;source_b&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_b</span><span class="p">:</span>
            <span class="n">extract_b</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;extract&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
            <span class="n">transform_b</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;transform&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
            <span class="n">extract_b</span> <span class="o">&gt;&gt;</span> <span class="n">transform_b</span>

        <span class="c1"># Parallel execution then join</span>
        <span class="n">join</span> <span class="o">=</span> <span class="n">EmptyOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;join&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">source_a</span><span class="p">,</span> <span class="n">source_b</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">join</span>
</code></pre></div>

<h3 id="53-dynamic-taskgroups">5.3 Dynamic TaskGroups<a class="header-link" href="#53-dynamic-taskgroups" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">airflow.utils.task_group</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaskGroup</span>

<span class="n">SOURCES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mysql&#39;</span><span class="p">,</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span> <span class="s1">&#39;mongodb&#39;</span><span class="p">]</span>

<span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">&#39;dynamic_taskgroup&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">EmptyOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>

    <span class="n">task_groups</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">SOURCES</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">TaskGroup</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;process_</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
            <span class="n">extract</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
                <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;extract&#39;</span><span class="p">,</span>
                <span class="n">python_callable</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="o">=</span><span class="n">source</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extract from </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">load</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
                <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;load&#39;</span><span class="p">,</span>
                <span class="n">python_callable</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="o">=</span><span class="n">source</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Load </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">extract</span> <span class="o">&gt;&gt;</span> <span class="n">load</span>

        <span class="n">task_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tg</span><span class="p">)</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">EmptyOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="n">task_groups</span> <span class="o">&gt;&gt;</span> <span class="n">end</span>
</code></pre></div>

<hr />
<h2 id="6-branching-and-conditional-execution">6. Branching and Conditional Execution<a class="header-link" href="#6-branching-and-conditional-execution" title="Permanent link">&para;</a></h2>
<h3 id="61-branchpythonoperator">6.1 BranchPythonOperator<a class="header-link" href="#61-branchpythonoperator" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">airflow.operators.python</span><span class="w"> </span><span class="kn">import</span> <span class="n">BranchPythonOperator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">airflow.operators.empty</span><span class="w"> </span><span class="kn">import</span> <span class="n">EmptyOperator</span>

<span class="k">def</span><span class="w"> </span><span class="nf">choose_branch</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Choose next task based on condition&quot;&quot;&quot;</span>
    <span class="n">ti</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ti&#39;</span><span class="p">]</span>
    <span class="n">data_count</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">xcom_pull</span><span class="p">(</span><span class="n">task_ids</span><span class="o">=</span><span class="s1">&#39;count_data&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data_count</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;process_large&#39;</span>
    <span class="k">elif</span> <span class="n">data_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;process_small&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;skip_processing&#39;</span>


<span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">&#39;branch_example&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>

    <span class="n">count_data</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;count_data&#39;</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>  <span class="c1"># Example return value</span>
    <span class="p">)</span>

    <span class="n">branch</span> <span class="o">=</span> <span class="n">BranchPythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;branch&#39;</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">choose_branch</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">process_large</span> <span class="o">=</span> <span class="n">EmptyOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;process_large&#39;</span><span class="p">)</span>
    <span class="n">process_small</span> <span class="o">=</span> <span class="n">EmptyOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;process_small&#39;</span><span class="p">)</span>
    <span class="n">skip_processing</span> <span class="o">=</span> <span class="n">EmptyOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;skip_processing&#39;</span><span class="p">)</span>

    <span class="c1"># Join after branching</span>
    <span class="n">join</span> <span class="o">=</span> <span class="n">EmptyOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;join&#39;</span><span class="p">,</span>
        <span class="n">trigger_rule</span><span class="o">=</span><span class="s1">&#39;none_failed_min_one_success&#39;</span>  <span class="c1"># Execute if at least one succeeds</span>
    <span class="p">)</span>

    <span class="n">count_data</span> <span class="o">&gt;&gt;</span> <span class="n">branch</span> <span class="o">&gt;&gt;</span> <span class="p">[</span><span class="n">process_large</span><span class="p">,</span> <span class="n">process_small</span><span class="p">,</span> <span class="n">skip_processing</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">join</span>
</code></pre></div>

<h3 id="62-shortcircuitoperator">6.2 ShortCircuitOperator<a class="header-link" href="#62-shortcircuitoperator" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">airflow.operators.python</span><span class="w"> </span><span class="kn">import</span> <span class="n">ShortCircuitOperator</span>

<span class="k">def</span><span class="w"> </span><span class="nf">check_condition</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check condition - skip downstream tasks if returns False&quot;&quot;&quot;</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span>
    <span class="c1"># Skip on weekends</span>
    <span class="n">day_of_week</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">day_of_week</span> <span class="o">&lt;</span> <span class="mi">5</span>  <span class="c1"># True only on weekdays</span>


<span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">&#39;shortcircuit_example&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>

    <span class="n">check</span> <span class="o">=</span> <span class="n">ShortCircuitOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;check_weekday&#39;</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">check_condition</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Tasks below are skipped if check returns False</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;process&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="n">load</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

    <span class="n">check</span> <span class="o">&gt;&gt;</span> <span class="n">process</span> <span class="o">&gt;&gt;</span> <span class="n">load</span>
</code></pre></div>

<hr />
<h2 id="practice-problems">Practice Problems<a class="header-link" href="#practice-problems" title="Permanent link">&para;</a></h2>
<h3 id="problem-1-using-xcom">Problem 1: Using XCom<a class="header-link" href="#problem-1-using-xcom" title="Permanent link">&para;</a></h3>
<p>Write a DAG with two tasks that each return a number, and a third task that calculates the sum of the two numbers.</p>
<h3 id="problem-2-dynamic-dag">Problem 2: Dynamic DAG<a class="header-link" href="#problem-2-dynamic-dag" title="Permanent link">&para;</a></h3>
<p>Write a DAG that dynamically generates ETL tasks for each table in a list (users, orders, products).</p>
<h3 id="problem-3-using-sensors">Problem 3: Using Sensors<a class="header-link" href="#problem-3-using-sensors" title="Permanent link">&para;</a></h3>
<p>Write a DAG that waits for a file to be created before processing it.</p>
<hr />
<h2 id="summary">Summary<a class="header-link" href="#summary" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>XCom</strong></td>
<td>Mechanism for sharing data between tasks</td>
</tr>
<tr>
<td><strong>Dynamic DAG</strong></td>
<td>Dynamically generate DAGs/tasks based on configuration</td>
</tr>
<tr>
<td><strong>Sensor</strong></td>
<td>Operator that waits until a condition is met</td>
</tr>
<tr>
<td><strong>Hook</strong></td>
<td>Interface for connecting to external systems</td>
</tr>
<tr>
<td><strong>TaskGroup</strong></td>
<td>Group related tasks for better visualization</td>
</tr>
<tr>
<td><strong>Branch</strong></td>
<td>Conditional branching based on criteria</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://airflow.apache.org/docs/apache-airflow/stable/concepts/xcoms.html">Airflow XCom Guide</a></li>
<li><a href="https://airflow.apache.org/docs/apache-airflow/stable/howto/dynamic-dag-generation.html">Dynamic DAGs</a></li>
<li><a href="https://airflow.apache.org/docs/apache-airflow/stable/concepts/sensors.html">Airflow Sensors</a></li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Data_Engineering/04_Apache_Airflow_Basics.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Apache Airflow Basics</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Data_Engineering/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Data_Engineering/06_Prefect_Modern_Orchestration.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Prefect Modern Orchestration</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">‚Üë</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}