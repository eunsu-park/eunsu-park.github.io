{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>11. Concurrency Control - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Database_Theory/">Database Theory</a>
    <span class="separator">/</span>
    <span class="current">11. Concurrency Control</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>11. Concurrency Control</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Database_Theory/10_Transaction_Theory.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">10. Transaction Theory</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Database_Theory/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Database_Theory/12_Recovery_Systems.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">12. Recovery Systems</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#1-need-for-concurrency-control">1. Need for Concurrency Control</a><ul>
<li><a href="#why-allow-concurrency">Why Allow Concurrency?</a></li>
<li><a href="#what-can-go-wrong-without-control">What Can Go Wrong Without Control?</a></li>
<li><a href="#the-role-of-concurrency-control">The Role of Concurrency Control</a></li>
</ul>
</li>
<li><a href="#2-lock-based-protocols">2. Lock-Based Protocols</a><ul>
<li><a href="#21-lock-types">2.1 Lock Types</a></li>
<li><a href="#22-lock-protocol-example">2.2 Lock Protocol Example</a></li>
<li><a href="#23-problems-with-basic-locking">2.3 Problems with Basic Locking</a></li>
</ul>
</li>
<li><a href="#3-two-phase-locking-2pl">3. Two-Phase Locking (2PL)</a><ul>
<li><a href="#31-basic-two-phase-locking">3.1 Basic Two-Phase Locking</a></li>
<li><a href="#32-example-2pl-execution">3.2 Example: 2PL Execution</a></li>
<li><a href="#33-problem-cascading-rollbacks-under-basic-2pl">3.3 Problem: Cascading Rollbacks under Basic 2PL</a></li>
<li><a href="#34-strict-two-phase-locking-strict-2pl">3.4 Strict Two-Phase Locking (Strict 2PL)</a></li>
<li><a href="#35-rigorous-two-phase-locking-rigorous-2pl">3.5 Rigorous Two-Phase Locking (Rigorous 2PL)</a></li>
<li><a href="#36-comparison-of-2pl-variants">3.6 Comparison of 2PL Variants</a></li>
</ul>
</li>
<li><a href="#4-deadlocks">4. Deadlocks</a><ul>
<li><a href="#41-what-is-a-deadlock">4.1 What is a Deadlock?</a></li>
<li><a href="#42-deadlock-detection">4.2 Deadlock Detection</a></li>
<li><a href="#43-deadlock-prevention">4.3 Deadlock Prevention</a></li>
<li><a href="#44-timeout-based-approach">4.4 Timeout-Based Approach</a></li>
<li><a href="#45-deadlock-in-practice">4.5 Deadlock in Practice</a></li>
</ul>
</li>
<li><a href="#5-lock-granularity">5. Lock Granularity</a><ul>
<li><a href="#51-the-granularity-spectrum">5.1 The Granularity Spectrum</a></li>
<li><a href="#52-intention-locks">5.2 Intention Locks</a></li>
<li><a href="#53-compatibility-matrix-with-intention-locks">5.3 Compatibility Matrix with Intention Locks</a></li>
<li><a href="#54-multi-granularity-locking-protocol">5.4 Multi-Granularity Locking Protocol</a></li>
<li><a href="#55-six-lock">5.5 SIX Lock</a></li>
<li><a href="#56-lock-escalation">5.6 Lock Escalation</a></li>
</ul>
</li>
<li><a href="#6-timestamp-based-protocols">6. Timestamp-Based Protocols</a><ul>
<li><a href="#61-basic-timestamp-ordering-to">6.1 Basic Timestamp Ordering (TO)</a></li>
<li><a href="#62-example-timestamp-ordering">6.2 Example: Timestamp Ordering</a></li>
<li><a href="#63-thomass-write-rule">6.3 Thomas's Write Rule</a></li>
</ul>
</li>
<li><a href="#7-multiversion-concurrency-control-mvcc">7. Multiversion Concurrency Control (MVCC)</a><ul>
<li><a href="#71-concept">7.1 Concept</a></li>
<li><a href="#72-mvcc-read-and-write-rules">7.2 MVCC Read and Write Rules</a></li>
<li><a href="#73-mvcc-benefits-and-costs">7.3 MVCC Benefits and Costs</a></li>
<li><a href="#74-mvcc-in-postgresql">7.4 MVCC in PostgreSQL</a></li>
<li><a href="#75-mvcc-in-mysql-innodb">7.5 MVCC in MySQL InnoDB</a></li>
</ul>
</li>
<li><a href="#8-optimistic-concurrency-control-occ">8. Optimistic Concurrency Control (OCC)</a><ul>
<li><a href="#81-concept">8.1 Concept</a></li>
<li><a href="#82-three-phases">8.2 Three Phases</a></li>
<li><a href="#83-validation-rules">8.3 Validation Rules</a></li>
<li><a href="#84-example-occ-validation">8.4 Example: OCC Validation</a></li>
<li><a href="#85-when-to-use-occ">8.5 When to Use OCC</a></li>
</ul>
</li>
<li><a href="#9-comparison-of-concurrency-control-methods">9. Comparison of Concurrency Control Methods</a><ul>
<li><a href="#91-summary-table">9.1 Summary Table</a></li>
<li><a href="#92-decision-guide">9.2 Decision Guide</a></li>
<li><a href="#93-what-real-systems-use">9.3 What Real Systems Use</a></li>
</ul>
</li>
<li><a href="#10-exercises">10. Exercises</a><ul>
<li><a href="#conceptual-questions">Conceptual Questions</a></li>
<li><a href="#lock-based-protocol-problems">Lock-Based Protocol Problems</a></li>
<li><a href="#timestamp-and-mvcc-problems">Timestamp and MVCC Problems</a></li>
<li><a href="#occ-problem">OCC Problem</a></li>
<li><a href="#analysis-and-design">Analysis and Design</a></li>
</ul>
</li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="11-concurrency-control">11. Concurrency Control<a class="header-link" href="#11-concurrency-control" title="Permanent link">&para;</a></h1>
<p><strong>Previous</strong>: <a href="./10_Transaction_Theory.md">Transaction Theory</a> | <strong>Next</strong>: <a href="./12_Recovery_Systems.md">Recovery Systems</a></p>
<hr />
<h2 id="learning-objectives">Learning Objectives<a class="header-link" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<ul>
<li>Understand why concurrency control is essential for database correctness</li>
<li>Master lock-based protocols: shared/exclusive locks, two-phase locking, and its variants</li>
<li>Analyze and handle deadlocks: detection, prevention, and timeout strategies</li>
<li>Understand lock granularity and intention locks for multi-granularity locking</li>
<li>Learn timestamp-based protocols and Thomas's write rule</li>
<li>Understand Multiversion Concurrency Control (MVCC) and its implementation</li>
<li>Compare Optimistic Concurrency Control (OCC) with pessimistic methods</li>
</ul>
<hr />
<h2 id="1-need-for-concurrency-control">1. Need for Concurrency Control<a class="header-link" href="#1-need-for-concurrency-control" title="Permanent link">&para;</a></h2>
<h3 id="why-allow-concurrency">Why Allow Concurrency?<a class="header-link" href="#why-allow-concurrency" title="Permanent link">&para;</a></h3>
<p>Modern database systems handle thousands of concurrent transactions. Without concurrency:</p>
<div class="highlight"><pre><span></span><code>Serial execution of 1000 transactions, each taking 10ms:
  Total time = 1000 Ã— 10ms = 10 seconds

With 100 concurrent transactions:
  Overlap I/O waits with computation
  Total time â‰ˆ 100ms (+ overhead)
</code></pre></div>

<p><strong>Benefits of concurrency:</strong>
- <strong>Improved throughput</strong>: More transactions per second
- <strong>Reduced response time</strong>: Short transactions don't wait behind long ones
- <strong>Better resource utilization</strong>: CPU works while another transaction waits for I/O</p>
<h3 id="what-can-go-wrong-without-control">What Can Go Wrong Without Control?<a class="header-link" href="#what-can-go-wrong-without-control" title="Permanent link">&para;</a></h3>
<p>Without concurrency control, interleaved execution can produce incorrect results even if each transaction is individually correct.</p>
<p><strong>Lost Update Problem:</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">Tâ‚</span><span class="o">:</span><span class="w"> </span><span class="n">read</span><span class="o">(</span><span class="n">A</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="w">    </span><span class="n">write</span><span class="o">(</span><span class="n">A</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span>
<span class="n">Tâ‚‚</span><span class="o">:</span><span class="w">       </span><span class="n">read</span><span class="o">(</span><span class="n">A</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">120</span><span class="w">    </span><span class="n">write</span><span class="o">(</span><span class="n">A</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">120</span>

<span class="n">Timeline</span><span class="o">:</span>
<span class="n">Tâ‚</span><span class="o">:</span><span class="w"> </span><span class="n">read</span><span class="o">(</span><span class="n">A</span><span class="o">)=</span><span class="mi">100</span><span class="w">  </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="n">write</span><span class="o">(</span><span class="n">A</span><span class="o">)=</span><span class="mi">90</span>
<span class="n">Tâ‚‚</span><span class="o">:</span><span class="w">      </span><span class="n">read</span><span class="o">(</span><span class="n">A</span><span class="o">)=</span><span class="mi">100</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="n">write</span><span class="o">(</span><span class="n">A</span><span class="o">)=</span><span class="mi">120</span>

<span class="n">Result</span><span class="o">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">120</span>
<span class="n">Expected</span><span class="o">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">110</span><span class="w"> </span><span class="o">(</span><span class="n">both</span><span class="w"> </span><span class="n">updates</span><span class="w"> </span><span class="n">applied</span><span class="o">)</span>
<span class="n">Tâ‚</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">LOST</span><span class="o">!</span>
</code></pre></div>

<p><strong>Inconsistent Read Problem:</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">Invariant</span><span class="o">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="o">(</span><span class="n">initially</span><span class="w"> </span><span class="n">A</span><span class="o">=</span><span class="mi">100</span><span class="o">,</span><span class="w"> </span><span class="n">B</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>

<span class="n">Tâ‚</span><span class="o">:</span><span class="w"> </span><span class="n">read</span><span class="o">(</span><span class="n">A</span><span class="o">)=</span><span class="mi">100</span><span class="w">   </span><span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="o">-</span><span class="mi">50</span><span class="o">=</span><span class="mi">50</span><span class="w">   </span><span class="n">write</span><span class="o">(</span><span class="n">A</span><span class="o">)=</span><span class="mi">50</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="w"> </span><span class="n">read</span><span class="o">(</span><span class="n">B</span><span class="o">)=</span><span class="mi">100</span><span class="w">   </span><span class="n">B</span><span class="o">=</span><span class="n">B</span><span class="o">+</span><span class="mi">50</span><span class="o">=</span><span class="mi">150</span><span class="w">   </span><span class="n">write</span><span class="o">(</span><span class="n">B</span><span class="o">)=</span><span class="mi">150</span>
<span class="n">Tâ‚‚</span><span class="o">:</span><span class="w">                                    </span><span class="n">read</span><span class="o">(</span><span class="n">A</span><span class="o">)=</span><span class="mi">50</span><span class="w"> </span><span class="n">read</span><span class="o">(</span><span class="n">B</span><span class="o">)=</span><span class="mi">100</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">A</span><span class="o">+</span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">150</span><span class="w"> </span><span class="err">â‰ </span><span class="w"> </span><span class="mi">200</span><span class="o">!</span>

<span class="n">Tâ‚‚</span><span class="w"> </span><span class="n">reads</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">Tâ‚</span><span class="s1">&#39;s update but B before Tâ‚&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">inconsistent</span><span class="w"> </span><span class="n">view</span>
</code></pre></div>

<h3 id="the-role-of-concurrency-control">The Role of Concurrency Control<a class="header-link" href="#the-role-of-concurrency-control" title="Permanent link">&para;</a></h3>
<p>The concurrency control subsystem ensures that the concurrent execution of transactions is <strong>equivalent to some serial execution</strong> (serializability), while maximizing the degree of concurrency.</p>
<div class="highlight"><pre><span></span><code>                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Transactions â”€â”€â”€â”€â†’  â”‚ Concurrency Control  â”‚ â”€â”€â”€â”€â†’  Serializable Schedule
  Tâ‚, Tâ‚‚, Tâ‚ƒ      â”‚    Subsystem         â”‚        (correct results)
                    â”‚  - Locks             â”‚
                    â”‚  - Timestamps        â”‚
                    â”‚  - MVCC              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="2-lock-based-protocols">2. Lock-Based Protocols<a class="header-link" href="#2-lock-based-protocols" title="Permanent link">&para;</a></h2>
<h3 id="21-lock-types">2.1 Lock Types<a class="header-link" href="#21-lock-types" title="Permanent link">&para;</a></h3>
<p>The most fundamental concurrency control mechanism uses <strong>locks</strong> on data items.</p>
<p><strong>Shared Lock (S-lock):</strong>
- Acquired for <strong>reading</strong> a data item
- Multiple transactions can hold S-locks on the same item simultaneously
- Also called a <strong>read lock</strong></p>
<p><strong>Exclusive Lock (X-lock):</strong>
- Acquired for <strong>writing</strong> (modifying) a data item
- Only one transaction can hold an X-lock on an item at a time
- No other transaction can hold any lock (S or X) on the item simultaneously
- Also called a <strong>write lock</strong></p>
<p><strong>Lock Compatibility Matrix:</strong></p>
<div class="highlight"><pre><span></span><code><span class="w">              </span><span class="nv">Requested</span><span class="w"> </span><span class="nv">Lock</span>
<span class="w">              </span>â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
<span class="w">              </span>â”‚<span class="w">  </span><span class="nv">S</span><span class="w">  </span>â”‚<span class="w">  </span><span class="nv">X</span><span class="w">  </span>â”‚
<span class="w">         </span>â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
<span class="nv">Held</span><span class="w">     </span>â”‚<span class="w"> </span><span class="nv">S</span><span class="w">  </span>â”‚<span class="w"> </span><span class="nv">Yes</span><span class="w"> </span>â”‚<span class="w"> </span><span class="nv">No</span><span class="w">  </span>â”‚
<span class="nv">Lock</span><span class="w">     </span>â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
<span class="w">         </span>â”‚<span class="w"> </span><span class="nv">X</span><span class="w">  </span>â”‚<span class="w"> </span><span class="nv">No</span><span class="w">  </span>â”‚<span class="w"> </span><span class="nv">No</span><span class="w">  </span>â”‚
<span class="w">         </span>â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜

<span class="nv">S</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Compatible</span><span class="w"> </span><span class="ss">(</span><span class="nv">both</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="nv">proceed</span><span class="ss">)</span>
<span class="nv">S</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Incompatible</span><span class="w"> </span><span class="ss">(</span><span class="nv">must</span><span class="w"> </span><span class="k">wait</span><span class="ss">)</span>
<span class="nv">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Incompatible</span><span class="w"> </span><span class="ss">(</span><span class="nv">must</span><span class="w"> </span><span class="k">wait</span><span class="ss">)</span>
<span class="nv">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Incompatible</span><span class="w"> </span><span class="ss">(</span><span class="nv">must</span><span class="w"> </span><span class="k">wait</span><span class="ss">)</span>
</code></pre></div>

<p><strong>Lock operations:</strong>
- <code>lock-S(X)</code> or <code>S(X)</code>: Request shared lock on item X
- <code>lock-X(X)</code> or <code>X(X)</code>: Request exclusive lock on item X
- <code>unlock(X)</code> or <code>U(X)</code>: Release lock on item X</p>
<h3 id="22-lock-protocol-example">2.2 Lock Protocol Example<a class="header-link" href="#22-lock-protocol-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Tâ‚ (transfer $50 from A to B):     Tâ‚‚ (read A + B):
  lock-X(A)                           lock-S(A)     â† BLOCKED (Tâ‚ holds X on A)
  read(A) = 100
  A = A - 50
  write(A) = 50
  lock-X(B)
  read(B) = 200
  B = B + 50
  write(B) = 250
  unlock(A)                           lock-S(A)     â† NOW GRANTED
  unlock(B)                           read(A) = 50
                                      lock-S(B)
                                      read(B) = 250
                                      print(A+B) = 300  â† CORRECT!
                                      unlock(A)
                                      unlock(B)
</code></pre></div>

<h3 id="23-problems-with-basic-locking">2.3 Problems with Basic Locking<a class="header-link" href="#23-problems-with-basic-locking" title="Permanent link">&para;</a></h3>
<p>Simply acquiring locks before access and releasing after use is <strong>not sufficient</strong> for serializability:</p>
<div class="highlight"><pre><span></span><code>Incorrect Protocol (lock, use, unlock immediately):

Tâ‚:  lock-X(A) read(A) write(A) unlock(A) lock-X(B) read(B) write(B) unlock(B)
Tâ‚‚:                                lock-S(A) read(A) lock-S(B)
                                                          â†‘ BLOCKED (Tâ‚ holds X(B))

Timeline:
Tâ‚: X(A) r(A) w(A) U(A) â”€â”€â”€â”€ X(B) r(B) w(B) U(B)
Tâ‚‚:                   S(A) r(A) â”€â”€â”€â”€â”€â”€ S(B) r(B)

Tâ‚‚ reads A AFTER Tâ‚&#39;s update but reads B BEFORE Tâ‚&#39;s update.
Tâ‚‚ sees an inconsistent state. NOT serializable.

The problem: Tâ‚ released the lock on A too early.
</code></pre></div>

<p>This motivates <strong>Two-Phase Locking</strong>.</p>
<hr />
<h2 id="3-two-phase-locking-2pl">3. Two-Phase Locking (2PL)<a class="header-link" href="#3-two-phase-locking-2pl" title="Permanent link">&para;</a></h2>
<h3 id="31-basic-two-phase-locking">3.1 Basic Two-Phase Locking<a class="header-link" href="#31-basic-two-phase-locking" title="Permanent link">&para;</a></h3>
<p>A transaction follows the <strong>Two-Phase Locking (2PL) protocol</strong> if all locking operations precede the first unlock operation.</p>
<div class="highlight"><pre><span></span><code>Phase 1: GROWING phase          Phase 2: SHRINKING phase
(acquire locks, no releases)    (release locks, no acquisitions)

Number of
Locks Held
    ^
    â”‚        â•±â•²
    â”‚       â•±  â•²
    â”‚      â•±    â•²
    â”‚     â•±      â•²
    â”‚    â•±        â•²
    â”‚   â•±          â•²
    â”‚  â•±            â•²
    â”‚ â•±              â•²
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â†’ Time
     Growing  Lock   Shrinking
     phase    point  phase
</code></pre></div>

<p><strong>Rules:</strong>
1. A transaction can acquire locks in the growing phase
2. Once a transaction releases any lock, it enters the shrinking phase
3. No new locks can be acquired in the shrinking phase</p>
<p><strong>Theorem</strong>: If all transactions in a schedule follow the 2PL protocol, then the schedule is <strong>conflict serializable</strong>.</p>
<p><strong>Proof sketch</strong>: The "lock point" (the moment a transaction has acquired all its locks) defines the serialization order. If T_i's lock point precedes T_j's lock point, then T_i appears before T_j in the equivalent serial schedule. This ordering is consistent because conflicting operations respect the lock compatibility rules.</p>
<h3 id="32-example-2pl-execution">3.2 Example: 2PL Execution<a class="header-link" href="#32-example-2pl-execution" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Tâ‚ (2PL):                           Tâ‚‚ (2PL):
  lock-X(A)
  read(A)                             lock-S(B)
  A = A - 50                          read(B)
  write(A)                            lock-S(A) â† BLOCKED (Tâ‚ holds X(A))
  lock-X(B)
  read(B)          â† Lock point Tâ‚
  B = B + 50
  write(B)
  unlock(A)                           lock-S(A) â† NOW GRANTED (shrinking phase)
  unlock(B)                           read(A)
                                      â† Lock point Tâ‚‚
                                      unlock(A)
                                      unlock(B)

Serialization order: Tâ‚ before Tâ‚‚ (Tâ‚&#39;s lock point is earlier)
Tâ‚‚ sees the database AFTER Tâ‚&#39;s complete transfer. Correct!
</code></pre></div>

<h3 id="33-problem-cascading-rollbacks-under-basic-2pl">3.3 Problem: Cascading Rollbacks under Basic 2PL<a class="header-link" href="#33-problem-cascading-rollbacks-under-basic-2pl" title="Permanent link">&para;</a></h3>
<p>Basic 2PL ensures serializability but <strong>not recoverability</strong>:</p>
<div class="highlight"><pre><span></span><code>Tâ‚ (2PL):                           Tâ‚‚:
  lock-X(A)
  read(A)
  write(A)
  unlock(A)          â† Shrinking phase: released A
                                       lock-S(A)
                                       read(A)   â† reads Tâ‚&#39;s uncommitted data!
  ...
  ABORT              â† Tâ‚ fails!

Tâ‚‚ read a value written by Tâ‚, which has now aborted.
Tâ‚‚ must also be rolled back â†’ cascading rollback
</code></pre></div>

<h3 id="34-strict-two-phase-locking-strict-2pl">3.4 Strict Two-Phase Locking (Strict 2PL)<a class="header-link" href="#34-strict-two-phase-locking-strict-2pl" title="Permanent link">&para;</a></h3>
<p><strong>Strict 2PL</strong> adds a rule: all <strong>exclusive (X) locks</strong> are held until the transaction commits or aborts.</p>
<div class="highlight"><pre><span></span><code>Strict 2PL:
Number of
Locks Held
    ^
    â”‚    S-locks may       X-locks released
    â”‚    be released       at commit/abort
    â”‚      â”‚                    â”‚
    â”‚      â•±â•²                   â”‚
    â”‚     â•±  â•²â”€â”€â”€ â”€â”€â”€ â”€â”€â”€ â”€â”€â”€ â”€â”¤
    â”‚    â•±         S-locks      â”‚
    â”‚   â•±          released     â”‚
    â”‚  â•±              â•²         â”‚
    â”‚ â•±                â•²        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â†’ Time
                     commit/abort
</code></pre></div>

<p><strong>Properties:</strong>
- Conflict serializable (inherits from 2PL)
- <strong>Strict</strong> schedules (no cascading rollbacks for X-locked items)
- Most commonly used in practice</p>
<h3 id="35-rigorous-two-phase-locking-rigorous-2pl">3.5 Rigorous Two-Phase Locking (Rigorous 2PL)<a class="header-link" href="#35-rigorous-two-phase-locking-rigorous-2pl" title="Permanent link">&para;</a></h3>
<p><strong>Rigorous 2PL</strong> holds <strong>all locks</strong> (both S and X) until commit or abort.</p>
<div class="highlight"><pre><span></span><code><span class="nv">Rigorous</span><span class="w"> </span><span class="mi">2</span><span class="nv">PL</span>:
<span class="nv">Number</span><span class="w"> </span><span class="nv">of</span>
<span class="nv">Locks</span><span class="w"> </span><span class="nv">Held</span>
<span class="w">    </span><span class="o">^</span>
<span class="w">    </span>â”‚
<span class="w">    </span>â”‚<span class="w">    </span>â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
<span class="w">    </span>â”‚<span class="w">   </span>â•±<span class="w">                       </span>â”‚
<span class="w">    </span>â”‚<span class="w">  </span>â•±<span class="w">   </span><span class="nv">All</span><span class="w"> </span><span class="nv">locks</span><span class="w"> </span><span class="nv">held</span><span class="w">       </span>â”‚
<span class="w">    </span>â”‚<span class="w"> </span>â•±<span class="w">    </span><span class="k">until</span><span class="w"> </span><span class="nv">commit</span><span class="o">/</span><span class="nv">abort</span><span class="w">   </span>â”‚
<span class="w">    </span>â”‚â•±<span class="w">                          </span>â”‚
<span class="w">    </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â†’<span class="w"> </span><span class="nv">Time</span>
<span class="w">                     </span><span class="nv">commit</span><span class="o">/</span><span class="nv">abort</span>
</code></pre></div>

<p><strong>Properties:</strong>
- Conflict serializable
- Strict AND cascadeless
- Serialization order = commit order (easy to reason about)
- Simplest protocol to implement correctly
- The locking protocol used by most database systems</p>
<h3 id="36-comparison-of-2pl-variants">3.6 Comparison of 2PL Variants<a class="header-link" href="#36-comparison-of-2pl-variants" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Variant</th>
<th>S-Lock Release</th>
<th>X-Lock Release</th>
<th>Guarantees</th>
</tr>
</thead>
<tbody>
<tr>
<td>Basic 2PL</td>
<td>After lock point</td>
<td>After lock point</td>
<td>Conflict serializable</td>
</tr>
<tr>
<td>Strict 2PL</td>
<td>After lock point</td>
<td>At commit/abort</td>
<td>+ Strict (no cascading from writes)</td>
</tr>
<tr>
<td>Rigorous 2PL</td>
<td>At commit/abort</td>
<td>At commit/abort</td>
<td>+ Strict + Cascadeless</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="4-deadlocks">4. Deadlocks<a class="header-link" href="#4-deadlocks" title="Permanent link">&para;</a></h2>
<h3 id="41-what-is-a-deadlock">4.1 What is a Deadlock?<a class="header-link" href="#41-what-is-a-deadlock" title="Permanent link">&para;</a></h3>
<p>A <strong>deadlock</strong> occurs when two or more transactions are waiting for each other to release locks, creating a circular wait.</p>
<div class="highlight"><pre><span></span><code><span class="nv">Deadlock</span><span class="w"> </span><span class="nv">Scenario</span>:

<span class="nv">T</span>â‚:<span class="w"> </span><span class="nv">lock</span><span class="o">-</span><span class="nv">X</span><span class="ss">(</span><span class="nv">A</span><span class="ss">)</span><span class="w">   </span>â”€â”€â”€â”€â”€<span class="w"> </span><span class="nv">lock</span><span class="o">-</span><span class="nv">X</span><span class="ss">(</span><span class="nv">B</span><span class="ss">)</span><span class="w"> </span>â†<span class="w"> </span><span class="nv">BLOCKED</span><span class="w"> </span><span class="ss">(</span><span class="nv">T</span>â‚‚<span class="w"> </span><span class="nv">holds</span><span class="w"> </span><span class="nv">X</span><span class="ss">(</span><span class="nv">B</span><span class="ss">))</span>
<span class="nv">T</span>â‚‚:<span class="w"> </span><span class="nv">lock</span><span class="o">-</span><span class="nv">X</span><span class="ss">(</span><span class="nv">B</span><span class="ss">)</span><span class="w">   </span>â”€â”€â”€â”€â”€<span class="w"> </span><span class="nv">lock</span><span class="o">-</span><span class="nv">X</span><span class="ss">(</span><span class="nv">A</span><span class="ss">)</span><span class="w"> </span>â†<span class="w"> </span><span class="nv">BLOCKED</span><span class="w"> </span><span class="ss">(</span><span class="nv">T</span>â‚<span class="w"> </span><span class="nv">holds</span><span class="w"> </span><span class="nv">X</span><span class="ss">(</span><span class="nv">A</span><span class="ss">))</span>

<span class="nv">T</span>â‚<span class="w"> </span><span class="nv">waits</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">T</span>â‚‚<span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">release</span><span class="w"> </span><span class="nv">B</span>
<span class="nv">T</span>â‚‚<span class="w"> </span><span class="nv">waits</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">T</span>â‚<span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">release</span><span class="w"> </span><span class="nv">A</span>
<span class="nv">Neither</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="nv">proceed</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">DEADLOCK</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="k">Wait</span><span class="o">-</span><span class="k">For</span><span class="w"> </span><span class="nv">Graph</span>:

<span class="nv">T</span>â‚<span class="w"> </span>â”€â”€<span class="nv">waits</span><span class="w"> </span><span class="k">for</span>â”€â”€â†’<span class="w"> </span><span class="nv">T</span>â‚‚
<span class="w"> </span>â†‘<span class="w">                  </span>â”‚
<span class="w"> </span>â””â”€â”€<span class="nv">waits</span><span class="w"> </span><span class="k">for</span>â”€â”€â”€â”€â”€â”€â”˜

<span class="nv">Cycle</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">Deadlock</span><span class="o">!</span>
</code></pre></div>

<h3 id="42-deadlock-detection">4.2 Deadlock Detection<a class="header-link" href="#42-deadlock-detection" title="Permanent link">&para;</a></h3>
<p><strong>Wait-For Graph (WFG):</strong>
- Nodes represent transactions
- Edge <code>T_i â†’ T_j</code> means <code>T_i</code> is waiting for <code>T_j</code> to release a lock
- A <strong>cycle</strong> in the WFG indicates a deadlock</p>
<div class="highlight"><pre><span></span><code><span class="nv">Detection</span><span class="w"> </span><span class="nv">Algorithm</span>:
<span class="nv">DETECT</span><span class="o">-</span><span class="nv">DEADLOCK</span><span class="ss">()</span>:
<span class="w">    </span><span class="nv">Maintain</span><span class="w"> </span><span class="k">wait</span><span class="o">-</span><span class="k">for</span><span class="w"> </span><span class="nv">graph</span><span class="w"> </span><span class="nv">G</span>
<span class="w">    </span><span class="nv">Periodically</span><span class="w"> </span><span class="ss">(</span><span class="nv">or</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">each</span><span class="w"> </span><span class="nv">lock</span><span class="w"> </span><span class="k">wait</span><span class="ss">)</span>:
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nv">G</span><span class="w"> </span><span class="nv">contains</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">cycle</span>:
<span class="w">            </span><span class="nv">Select</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">victim</span><span class="w"> </span><span class="nv">transaction</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">cycle</span>
<span class="w">            </span><span class="nv">Abort</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">victim</span>
<span class="w">            </span><span class="nv">Release</span><span class="w"> </span><span class="nv">its</span><span class="w"> </span><span class="nv">locks</span><span class="w"> </span><span class="ss">(</span><span class="nv">breaks</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">cycle</span><span class="ss">)</span>
</code></pre></div>

<p><strong>Victim selection criteria:</strong>
1. <strong>Youngest transaction</strong> (least work to redo)
2. <strong>Transaction with fewest locks</strong> (least disruption)
3. <strong>Transaction closest to completion</strong> (most work already done -- sometimes preferred to avoid wasting it)
4. <strong>Transaction with lowest priority</strong> (application-defined)</p>
<p><strong>Starvation prevention</strong>: Ensure the same transaction is not repeatedly chosen as a victim. Common approach: increase priority after each abort.</p>
<p><strong>Example:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">Wait</span><span class="o">-</span><span class="k">For</span><span class="w"> </span><span class="nv">Graph</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nv">transactions</span>:

<span class="nv">T</span>â‚<span class="w"> </span>â†’<span class="w"> </span><span class="nv">T</span>â‚‚<span class="w"> </span>â†’<span class="w"> </span><span class="nv">T</span>â‚ƒ<span class="w"> </span>â†’<span class="w"> </span><span class="nv">T</span>â‚<span class="w">   </span><span class="ss">(</span><span class="nv">cycle</span><span class="w"> </span><span class="nv">involving</span><span class="w"> </span><span class="nv">T</span>â‚,<span class="w"> </span><span class="nv">T</span>â‚‚,<span class="w"> </span><span class="nv">T</span>â‚ƒ<span class="ss">)</span>
<span class="w">          </span>â†—
<span class="w">     </span><span class="nv">T</span>â‚„<span class="w"> </span>â”€â”˜<span class="w">             </span><span class="ss">(</span><span class="nv">T</span>â‚„<span class="w"> </span><span class="nv">waits</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">T</span>â‚ƒ<span class="w"> </span><span class="nv">but</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">cycle</span><span class="ss">)</span>

<span class="nv">Deadlock</span><span class="w"> </span><span class="nv">detected</span><span class="w"> </span><span class="nv">among</span><span class="w"> </span><span class="nv">T</span>â‚,<span class="w"> </span><span class="nv">T</span>â‚‚,<span class="w"> </span><span class="nv">T</span>â‚ƒ.
<span class="nv">Choose</span><span class="w"> </span><span class="nv">victim</span><span class="w"> </span><span class="ss">(</span><span class="nv">e</span>.<span class="nv">g</span>.,<span class="w"> </span><span class="nv">T</span>â‚<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">it</span><span class="err">&#39;s the youngest).</span>
<span class="err">Abort Tâ‚ â†’ releases locks â†’ Tâ‚ƒ can proceed â†’ Tâ‚‚ can proceed â†’ Tâ‚„ can proceed.</span>
</code></pre></div>

<h3 id="43-deadlock-prevention">4.3 Deadlock Prevention<a class="header-link" href="#43-deadlock-prevention" title="Permanent link">&para;</a></h3>
<p>Instead of detecting deadlocks after they occur, we can <strong>prevent</strong> them from ever happening.</p>
<p><strong>Wait-Die Scheme (non-preemptive):</strong></p>
<div class="highlight"><pre><span></span><code>When T_i requests a lock held by T_j:

  If T_i is OLDER than T_j (T_i has earlier timestamp):
      T_i WAITS (older waits for younger)
  Else:
      T_i DIES (younger is rolled back and restarted)
      (T_i is restarted with its ORIGINAL timestamp to avoid starvation)

Mnemonic: &quot;Old waits, Young dies&quot;
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">Example</span><span class="o">:</span>
<span class="n">Tâ‚</span><span class="w"> </span><span class="o">(</span><span class="n">ts</span><span class="o">=</span><span class="mi">100</span><span class="o">,</span><span class="w"> </span><span class="n">older</span><span class="o">)</span><span class="w">  </span><span class="n">requests</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="n">held</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">Tâ‚‚</span><span class="w"> </span><span class="o">(</span><span class="n">ts</span><span class="o">=</span><span class="mi">200</span><span class="o">,</span><span class="w"> </span><span class="n">younger</span><span class="o">)</span>
<span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">Tâ‚</span><span class="w"> </span><span class="n">WAITS</span><span class="w"> </span><span class="o">(</span><span class="n">older</span><span class="w"> </span><span class="n">waits</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">younger</span><span class="o">)</span>

<span class="n">Tâ‚‚</span><span class="w"> </span><span class="o">(</span><span class="n">ts</span><span class="o">=</span><span class="mi">200</span><span class="o">,</span><span class="w"> </span><span class="n">younger</span><span class="o">)</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="n">held</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">Tâ‚</span><span class="w"> </span><span class="o">(</span><span class="n">ts</span><span class="o">=</span><span class="mi">100</span><span class="o">,</span><span class="w"> </span><span class="n">older</span><span class="o">)</span>
<span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">Tâ‚‚</span><span class="w"> </span><span class="n">DIES</span><span class="w"> </span><span class="o">(</span><span class="n">younger</span><span class="w"> </span><span class="n">dies</span><span class="o">,</span><span class="w"> </span><span class="n">gets</span><span class="w"> </span><span class="n">rolled</span><span class="w"> </span><span class="n">back</span><span class="o">)</span>
</code></pre></div>

<p><strong>Wound-Wait Scheme (preemptive):</strong></p>
<div class="highlight"><pre><span></span><code>When T_i requests a lock held by T_j:

  If T_i is OLDER than T_j:
      T_i WOUNDS T_j (forces T_j to roll back, T_i takes the lock)
  Else:
      T_i WAITS (younger waits for older)

Mnemonic: &quot;Old wounds, Young waits&quot;
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">Example</span><span class="o">:</span>
<span class="n">Tâ‚</span><span class="w"> </span><span class="o">(</span><span class="n">ts</span><span class="o">=</span><span class="mi">100</span><span class="o">,</span><span class="w"> </span><span class="n">older</span><span class="o">)</span><span class="w">  </span><span class="n">requests</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="n">held</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">Tâ‚‚</span><span class="w"> </span><span class="o">(</span><span class="n">ts</span><span class="o">=</span><span class="mi">200</span><span class="o">,</span><span class="w"> </span><span class="n">younger</span><span class="o">)</span>
<span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">Tâ‚</span><span class="w"> </span><span class="n">WOUNDS</span><span class="w"> </span><span class="n">Tâ‚‚</span><span class="w"> </span><span class="o">(</span><span class="n">Tâ‚‚</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">rolled</span><span class="w"> </span><span class="n">back</span><span class="o">,</span><span class="w"> </span><span class="n">Tâ‚</span><span class="w"> </span><span class="n">gets</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">lock</span><span class="o">)</span>

<span class="n">Tâ‚‚</span><span class="w"> </span><span class="o">(</span><span class="n">ts</span><span class="o">=</span><span class="mi">200</span><span class="o">,</span><span class="w"> </span><span class="n">younger</span><span class="o">)</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="n">held</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">Tâ‚</span><span class="w"> </span><span class="o">(</span><span class="n">ts</span><span class="o">=</span><span class="mi">100</span><span class="o">,</span><span class="w"> </span><span class="n">older</span><span class="o">)</span>
<span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">Tâ‚‚</span><span class="w"> </span><span class="n">WAITS</span><span class="w"> </span><span class="o">(</span><span class="n">younger</span><span class="w"> </span><span class="n">waits</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">older</span><span class="o">)</span>
</code></pre></div>

<p><strong>Comparison:</strong></p>
<table>
<thead>
<tr>
<th>Scheme</th>
<th>Older requesting from Younger</th>
<th>Younger requesting from Older</th>
</tr>
</thead>
<tbody>
<tr>
<td>Wait-Die</td>
<td>Older WAITS</td>
<td>Younger DIES (rolled back)</td>
</tr>
<tr>
<td>Wound-Wait</td>
<td>Older WOUNDS younger (preempts)</td>
<td>Younger WAITS</td>
</tr>
</tbody>
</table>
<p>Both schemes are <strong>deadlock-free</strong> because they impose a total ordering: in Wait-Die, transactions only wait for younger ones; in Wound-Wait, transactions only wait for older ones. Neither allows circular waits.</p>
<p><strong>Starvation</strong>: Both schemes restart aborted transactions with their <strong>original timestamp</strong>, so they become increasingly "old" and eventually succeed.</p>
<h3 id="44-timeout-based-approach">4.4 Timeout-Based Approach<a class="header-link" href="#44-timeout-based-approach" title="Permanent link">&para;</a></h3>
<p>A simple, practical approach: if a transaction waits for a lock longer than a <strong>timeout</strong> threshold, assume deadlock and abort it.</p>
<div class="highlight"><pre><span></span><code><span class="nx">LOCK</span><span class="o">-</span><span class="nx">WITH</span><span class="o">-</span><span class="nx">TIMEOUT</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span><span class="w"> </span><span class="nx">lock_type</span><span class="p">,</span><span class="w"> </span><span class="nx">timeout</span><span class="p">):</span>
<span class="w">    </span><span class="nx">start_time</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">current_time</span><span class="p">()</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="nx">lock</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">grantable</span><span class="p">:</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">current_time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">start_time</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">timeout</span><span class="p">:</span>
<span class="w">            </span><span class="nx">ABORT</span><span class="w"> </span><span class="nx">transaction</span><span class="w">  </span><span class="c1">// assumed deadlock</span>
<span class="w">        </span><span class="nx">wait</span><span class="p">(</span><span class="nx">short_interval</span><span class="p">)</span>
<span class="w">    </span><span class="nx">grant</span><span class="w"> </span><span class="nx">lock</span>
</code></pre></div>

<p><strong>Advantages:</strong>
- Simple to implement
- No overhead of maintaining wait-for graphs
- Works well in practice (most deadlocks resolve quickly)</p>
<p><strong>Disadvantages:</strong>
- May abort transactions that are not actually deadlocked (just slow)
- Timeout too short: unnecessary aborts
- Timeout too long: real deadlocks persist for too long</p>
<p><strong>In practice</strong>: Most database systems use a combination of timeout (as a first line) and wait-for graph detection (for accuracy).</p>
<h3 id="45-deadlock-in-practice">4.5 Deadlock in Practice<a class="header-link" href="#45-deadlock-in-practice" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- PostgreSQL: deadlock detection with wait-for graph</span>
<span class="c1">-- Default deadlock_timeout = 1s</span>
<span class="k">SET</span><span class="w"> </span><span class="n">deadlock_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;1s&#39;</span><span class="p">;</span>

<span class="c1">-- Session 1:</span>
<span class="k">BEGIN</span><span class="p">;</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">accounts</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="c1">-- Then tries:</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">accounts</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="c1">-- BLOCKED if session 2 holds lock on id=2</span>

<span class="c1">-- Session 2:</span>
<span class="k">BEGIN</span><span class="p">;</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">accounts</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="c1">-- Then tries:</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">accounts</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="c1">-- BLOCKED if session 1 holds lock on id=1</span>

<span class="c1">-- After deadlock_timeout: PostgreSQL detects the deadlock</span>
<span class="c1">-- ERROR: deadlock detected</span>
<span class="c1">-- One session is aborted, the other proceeds</span>
</code></pre></div>

<hr />
<h2 id="5-lock-granularity">5. Lock Granularity<a class="header-link" href="#5-lock-granularity" title="Permanent link">&para;</a></h2>
<h3 id="51-the-granularity-spectrum">5.1 The Granularity Spectrum<a class="header-link" href="#51-the-granularity-spectrum" title="Permanent link">&para;</a></h3>
<p>Locks can be applied at different levels of the data hierarchy:</p>
<div class="highlight"><pre><span></span><code>Granularity Hierarchy:

Database â”€â”€â†’ Coarsest (least concurrency, least overhead)
  â”‚
  Schema
  â”‚
  Table
  â”‚
  Page (block)
  â”‚
  Row (tuple) â”€â”€â†’ Finest (most concurrency, most overhead)
  â”‚
  Field (attribute) â”€â”€â†’ Rarely used in practice
</code></pre></div>

<p><strong>Trade-off:</strong></p>
<table>
<thead>
<tr>
<th>Fine Granularity (Row)</th>
<th>Coarse Granularity (Table)</th>
</tr>
</thead>
<tbody>
<tr>
<td>High concurrency</td>
<td>Low concurrency</td>
</tr>
<tr>
<td>High overhead (many locks)</td>
<td>Low overhead (few locks)</td>
</tr>
<tr>
<td>Best for OLTP</td>
<td>Best for batch/analytical</td>
</tr>
</tbody>
</table>
<h3 id="52-intention-locks">5.2 Intention Locks<a class="header-link" href="#52-intention-locks" title="Permanent link">&para;</a></h3>
<p>To support <strong>multi-granularity locking</strong> (MGR), we need <strong>intention locks</strong>. An intention lock on a coarse-grained item indicates that a finer-grained lock exists (or will be requested) on a descendant.</p>
<p><strong>Lock types with intention locks:</strong></p>
<table>
<thead>
<tr>
<th>Lock</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>IS</strong> (Intention Shared)</td>
<td>Some descendant has or will have an S-lock</td>
</tr>
<tr>
<td><strong>IX</strong> (Intention Exclusive)</td>
<td>Some descendant has or will have an X-lock</td>
</tr>
<tr>
<td><strong>S</strong> (Shared)</td>
<td>Shared lock on this node and all descendants</td>
</tr>
<tr>
<td><strong>X</strong> (Exclusive)</td>
<td>Exclusive lock on this node and all descendants</td>
</tr>
<tr>
<td><strong>SIX</strong> (Shared + Intention Exclusive)</td>
<td>S-lock on this node, IX on some descendant</td>
</tr>
</tbody>
</table>
<h3 id="53-compatibility-matrix-with-intention-locks">5.3 Compatibility Matrix with Intention Locks<a class="header-link" href="#53-compatibility-matrix-with-intention-locks" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>              Requested Lock
         â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
         â”‚ IS  â”‚ IX  â”‚  S  â”‚ SIX â”‚  X  â”‚
    â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
    â”‚ IS â”‚ Yes â”‚ Yes â”‚ Yes â”‚ Yes â”‚ No  â”‚
    â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
H   â”‚ IX â”‚ Yes â”‚ Yes â”‚ No  â”‚ No  â”‚ No  â”‚
e   â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
l   â”‚ S  â”‚ Yes â”‚ No  â”‚ Yes â”‚ No  â”‚ No  â”‚
d   â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
    â”‚SIX â”‚ Yes â”‚ No  â”‚ No  â”‚ No  â”‚ No  â”‚
    â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
    â”‚ X  â”‚ No  â”‚ No  â”‚ No  â”‚ No  â”‚ No  â”‚
    â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="54-multi-granularity-locking-protocol">5.4 Multi-Granularity Locking Protocol<a class="header-link" href="#54-multi-granularity-locking-protocol" title="Permanent link">&para;</a></h3>
<p>To lock a node at any level:</p>
<div class="highlight"><pre><span></span><code><span class="nx">LOCK</span><span class="o">-</span><span class="nx">NODE</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">lock_type</span><span class="p">):</span>
<span class="w">    </span><span class="c1">// Step 1: Acquire intention locks on all ancestors</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">each</span><span class="w"> </span><span class="nx">ancestor</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">root</span><span class="w"> </span><span class="nx">down</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">parent</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">node</span><span class="p">:</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">lock_type</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">S</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">IS</span><span class="p">:</span>
<span class="w">            </span><span class="nx">acquire</span><span class="w"> </span><span class="nx">IS</span><span class="w"> </span><span class="nx">lock</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">ancestor</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">lock_type</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">X</span><span class="p">,</span><span class="w"> </span><span class="nx">IX</span><span class="p">,</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">SIX</span><span class="p">:</span>
<span class="w">            </span><span class="nx">acquire</span><span class="w"> </span><span class="nx">IX</span><span class="w"> </span><span class="nx">lock</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">ancestor</span>

<span class="w">    </span><span class="c1">// Step 2: Acquire the actual lock on the node</span>
<span class="w">    </span><span class="nx">acquire</span><span class="w"> </span><span class="nx">lock_type</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">node</span>
</code></pre></div>

<p><strong>Example: Transaction Tâ‚ reads row Râ‚ in table T, Transaction Tâ‚‚ writes row Râ‚‚ in table T:</strong></p>
<div class="highlight"><pre><span></span><code>              Database
             â”Œâ”€â”€â”€â”´â”€â”€â”€â”
           IS(Tâ‚)  IX(Tâ‚‚)
             â”‚       â”‚
             Table T
           â”Œâ”€â”€â”€â”´â”€â”€â”€â”
         IS(Tâ‚)  IX(Tâ‚‚)
           â”‚       â”‚
         Page P1  Page P2
         IS(Tâ‚)  IX(Tâ‚‚)
           â”‚       â”‚
         Row R1   Row R2
         S(Tâ‚)   X(Tâ‚‚)

Tâ‚ and Tâ‚‚ operate on different rows â†’ no conflict at any level â†’ concurrent execution!
</code></pre></div>

<p><strong>Example: Transaction Tâ‚ƒ wants to lock the entire table T for exclusive access:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nv">T</span>â‚ƒ<span class="w"> </span><span class="nv">requests</span><span class="w"> </span><span class="nv">X</span><span class="o">-</span><span class="nv">lock</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">Table</span><span class="w"> </span><span class="nv">T</span>.
<span class="nv">Check</span><span class="w"> </span><span class="nv">compatibility</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">existing</span><span class="w"> </span><span class="nv">locks</span>:
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">IS</span><span class="ss">(</span><span class="nv">T</span>â‚<span class="ss">)</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">Table</span><span class="w"> </span><span class="nv">T</span>:<span class="w"> </span><span class="nv">IS</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">compatible</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">X</span>?<span class="w"> </span>â†’<span class="w"> </span><span class="nv">NO</span><span class="o">!</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">IX</span><span class="ss">(</span><span class="nv">T</span>â‚‚<span class="ss">)</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">Table</span><span class="w"> </span><span class="nv">T</span>:<span class="w"> </span><span class="nv">IX</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">compatible</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">X</span>?<span class="w"> </span>â†’<span class="w"> </span><span class="nv">NO</span><span class="o">!</span>

<span class="nv">T</span>â‚ƒ<span class="w"> </span><span class="nv">must</span><span class="w"> </span><span class="k">WAIT</span><span class="w"> </span><span class="k">until</span><span class="w"> </span><span class="nv">T</span>â‚<span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">T</span>â‚‚<span class="w"> </span><span class="nv">release</span><span class="w"> </span><span class="nv">their</span><span class="w"> </span><span class="nv">intention</span><span class="w"> </span><span class="nv">locks</span>.
<span class="nv">The</span><span class="w"> </span><span class="nv">intention</span><span class="w"> </span><span class="nv">locks</span><span class="w"> </span><span class="nv">prevented</span><span class="w"> </span><span class="nv">T</span>â‚ƒ<span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">getting</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">table</span><span class="o">-</span><span class="nv">level</span><span class="w"> </span><span class="nv">X</span><span class="o">-</span><span class="nv">lock</span>
<span class="k">while</span><span class="w"> </span><span class="nv">row</span><span class="o">-</span><span class="nv">level</span><span class="w"> </span><span class="nv">operations</span><span class="w"> </span><span class="nv">are</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">progress</span>.
</code></pre></div>

<h3 id="55-six-lock">5.5 SIX Lock<a class="header-link" href="#55-six-lock" title="Permanent link">&para;</a></h3>
<p>The <strong>SIX</strong> (Shared + Intention Exclusive) lock is useful when a transaction needs to <strong>read an entire table</strong> but <strong>write only a few rows</strong>.</p>
<div class="highlight"><pre><span></span><code><span class="nv">Without</span><span class="w"> </span><span class="nv">SIX</span>:
<span class="w">  </span><span class="nv">Option</span><span class="w"> </span><span class="mi">1</span>:<span class="w"> </span><span class="nv">S</span><span class="o">-</span><span class="nv">lock</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">table</span><span class="w"> </span><span class="ss">(</span><span class="nv">blocks</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">writers</span><span class="ss">)</span>
<span class="w">  </span><span class="nv">Option</span><span class="w"> </span><span class="mi">2</span>:<span class="w"> </span><span class="nv">IX</span><span class="o">-</span><span class="nv">lock</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">table</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">S</span><span class="o">-</span><span class="nv">lock</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">each</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="ss">(</span><span class="nv">expensive</span>,<span class="w"> </span><span class="nv">many</span><span class="w"> </span><span class="nv">locks</span><span class="ss">)</span>

<span class="nv">With</span><span class="w"> </span><span class="nv">SIX</span>:
<span class="w">  </span><span class="nv">SIX</span><span class="o">-</span><span class="nv">lock</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">table</span>:
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">S</span><span class="w"> </span><span class="nv">component</span>:<span class="w"> </span><span class="nv">reads</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">entire</span><span class="w"> </span><span class="nv">table</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">IX</span><span class="w"> </span><span class="nv">component</span>:<span class="w"> </span><span class="nv">allows</span><span class="w"> </span><span class="nv">X</span><span class="o">-</span><span class="nv">locks</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">specific</span><span class="w"> </span><span class="nv">rows</span>

<span class="nv">Example</span>:
<span class="w">  </span><span class="nv">Transaction</span>:<span class="w"> </span><span class="s2">&quot;Update salary for employees earning &lt; 30000&quot;</span>
<span class="w">  </span><span class="nv">SIX</span><span class="o">-</span><span class="nv">lock</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">employees</span><span class="w"> </span><span class="nv">table</span>:
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="nv">S</span>:<span class="w"> </span><span class="nv">reads</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">rows</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">find</span><span class="w"> </span><span class="nv">those</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">salary</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">30000</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="nv">IX</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">X</span>:<span class="w"> </span><span class="nv">writes</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">specific</span><span class="w"> </span><span class="nv">rows</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">match</span>
</code></pre></div>

<h3 id="56-lock-escalation">5.6 Lock Escalation<a class="header-link" href="#56-lock-escalation" title="Permanent link">&para;</a></h3>
<p>When a transaction acquires too many fine-grained locks, the system may <strong>escalate</strong> to a coarser granularity:</p>
<div class="highlight"><pre><span></span><code><span class="n">Lock</span><span class="w"> </span><span class="n">Escalation</span><span class="p">:</span>
<span class="w">  </span><span class="n">Tâ‚</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="n">row</span><span class="o">-</span><span class="n">level</span><span class="w"> </span><span class="n">S</span><span class="o">-</span><span class="n">locks</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">T</span>
<span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="n">escalates</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">single</span><span class="w"> </span><span class="n">table</span><span class="o">-</span><span class="n">level</span><span class="w"> </span><span class="n">S</span><span class="o">-</span><span class="n">lock</span>
<span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">Releases</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="n">locks</span>
<span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">Reduces</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">usage</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="n">manager</span>

<span class="n">Threshold</span><span class="w"> </span><span class="n">varies</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">system</span><span class="p">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w"> </span><span class="o">~</span><span class="mi">5000</span><span class="w"> </span><span class="n">locks</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">table</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Oracle</span><span class="p">:</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="n">escalation</span><span class="w"> </span><span class="p">(</span><span class="n">uses</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">approach</span><span class="p">)</span>
</code></pre></div>

<p><strong>Trade-off</strong>: Escalation reduces lock overhead but decreases concurrency (other transactions may be blocked by the table-level lock).</p>
<hr />
<h2 id="6-timestamp-based-protocols">6. Timestamp-Based Protocols<a class="header-link" href="#6-timestamp-based-protocols" title="Permanent link">&para;</a></h2>
<h3 id="61-basic-timestamp-ordering-to">6.1 Basic Timestamp Ordering (TO)<a class="header-link" href="#61-basic-timestamp-ordering-to" title="Permanent link">&para;</a></h3>
<p>Instead of locks, each transaction <code>T_i</code> is assigned a <strong>unique timestamp</strong> <code>TS(T_i)</code> when it begins. The protocol ensures that conflicting operations execute in timestamp order.</p>
<p><strong>Data item metadata:</strong>
- <code>W-timestamp(Q)</code>: Largest timestamp of any transaction that successfully wrote Q
- <code>R-timestamp(Q)</code>: Largest timestamp of any transaction that successfully read Q</p>
<p><strong>Protocol:</strong></p>
<div class="highlight"><pre><span></span><code>Transaction T_i wants to READ data item Q:

  if TS(T_i) &lt; W-timestamp(Q):
      // T_i is trying to read a value that was already overwritten
      // by a younger transaction â†’ T_i is &quot;too late&quot;
      REJECT: Roll back T_i and restart with a new timestamp

  else:
      Allow the read
      R-timestamp(Q) = max(R-timestamp(Q), TS(T_i))


Transaction T_i wants to WRITE data item Q:

  if TS(T_i) &lt; R-timestamp(Q):
      // A younger transaction already read the old value
      // T_i&#39;s write would invalidate that read â†’ reject
      REJECT: Roll back T_i and restart with a new timestamp

  if TS(T_i) &lt; W-timestamp(Q):
      // A younger transaction already wrote a newer value
      // T_i&#39;s write is &quot;obsolete&quot;
      REJECT: Roll back T_i and restart with a new timestamp

  else:
      Allow the write
      W-timestamp(Q) = TS(T_i)
</code></pre></div>

<p><strong>Properties:</strong>
- Ensures conflict serializability (serialization order = timestamp order)
- <strong>No deadlocks</strong> (transactions never wait; they are rolled back instead)
- May cause <strong>cascading rollbacks</strong> (basic version)
- Higher abort rate than locking (pessimistic vs. optimistic trade-off)</p>
<h3 id="62-example-timestamp-ordering">6.2 Example: Timestamp Ordering<a class="header-link" href="#62-example-timestamp-ordering" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>TS(Tâ‚) = 100, TS(Tâ‚‚) = 200

Initially: W-ts(A) = 0, R-ts(A) = 0, W-ts(B) = 0, R-ts(B) = 0

Tâ‚: read(A)
    TS(Tâ‚)=100 â‰¥ W-ts(A)=0 â†’ allowed
    R-ts(A) = max(0, 100) = 100

Tâ‚‚: read(A)
    TS(Tâ‚‚)=200 â‰¥ W-ts(A)=0 â†’ allowed
    R-ts(A) = max(100, 200) = 200

Tâ‚: write(A)
    TS(Tâ‚)=100 &lt; R-ts(A)=200 â†’ REJECTED!
    (Tâ‚‚, which is younger, already read A. Tâ‚&#39;s write would
     invalidate Tâ‚‚&#39;s read.)
    Tâ‚ is rolled back and restarted with a new timestamp.
</code></pre></div>

<h3 id="63-thomass-write-rule">6.3 Thomas's Write Rule<a class="header-link" href="#63-thomass-write-rule" title="Permanent link">&para;</a></h3>
<p>An optimization of basic timestamp ordering for writes:</p>
<div class="highlight"><pre><span></span><code>Transaction T_i wants to WRITE data item Q:

  if TS(T_i) &lt; R-timestamp(Q):
      REJECT (same as basic TO)

  if TS(T_i) &lt; W-timestamp(Q):
      // In basic TO: REJECT
      // Thomas&#39;s Write Rule: IGNORE the write (skip it!)
      // Why? A younger transaction already wrote a newer value.
      // T_i&#39;s write would be overwritten anyway.
      // This is safe because no future transaction will see T_i&#39;s value.

  else:
      Allow the write
      W-timestamp(Q) = TS(T_i)
</code></pre></div>

<p><strong>Example:</strong></p>
<div class="highlight"><pre><span></span><code>TS(Tâ‚) = 100, TS(Tâ‚‚) = 200

Tâ‚‚: write(A) â†’ W-ts(A) = 200
Tâ‚: write(A) â†’ TS(Tâ‚)=100 &lt; W-ts(A)=200

Basic TO: Roll back Tâ‚
Thomas&#39;s Write Rule: Skip Tâ‚&#39;s write (it would be overwritten by Tâ‚‚ anyway)
                     Tâ‚ continues normally
</code></pre></div>

<p><strong>Caveat</strong>: Thomas's write rule allows schedules that are <strong>view serializable</strong> but NOT necessarily <strong>conflict serializable</strong> (because it effectively reorders writes).</p>
<hr />
<h2 id="7-multiversion-concurrency-control-mvcc">7. Multiversion Concurrency Control (MVCC)<a class="header-link" href="#7-multiversion-concurrency-control-mvcc" title="Permanent link">&para;</a></h2>
<h3 id="71-concept">7.1 Concept<a class="header-link" href="#71-concept" title="Permanent link">&para;</a></h3>
<p><strong>MVCC</strong> maintains multiple versions of each data item. Each write creates a new version rather than overwriting the old value. Reads can access older versions, so readers never block writers and vice versa.</p>
<div class="highlight"><pre><span></span><code>MVCC Versions:

Data item A:
  Version 1: value=100, written by Tâ‚ at timestamp 100
  Version 2: value=150, written by Tâ‚ƒ at timestamp 150
  Version 3: value=200, written by Tâ‚… at timestamp 200

Tâ‚‚ (timestamp 120): reads version 1 (value=100)
  â†’ The latest version with timestamp â‰¤ 120

Tâ‚„ (timestamp 180): reads version 2 (value=150)
  â†’ The latest version with timestamp â‰¤ 180
</code></pre></div>

<h3 id="72-mvcc-read-and-write-rules">7.2 MVCC Read and Write Rules<a class="header-link" href="#72-mvcc-read-and-write-rules" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Transaction T_i reads data item Q:

    Find the version Q_k where:
    <span class="k">-</span> W-timestamp(Q_k) â‰¤ TS(T_i)
    <span class="k">-</span> W-timestamp(Q_k) is the largest such timestamp
    Return Q_k&#39;s value


Transaction T_i writes data item Q:

    Find the version Q_k such that:
    <span class="k">-</span> W-timestamp(Q_k) â‰¤ TS(T_i) (closest older version)

    Let Q_j be the version with W-timestamp immediately after Q_k

    if TS(T_i) &lt; R-timestamp(Q_k):
        REJECT (a younger transaction read Q_k and expects it unchanged)
    else:
        Create new version Q_i with W-timestamp = TS(T_i)
</code></pre></div>

<h3 id="73-mvcc-benefits-and-costs">7.3 MVCC Benefits and Costs<a class="header-link" href="#73-mvcc-benefits-and-costs" title="Permanent link">&para;</a></h3>
<p><strong>Benefits:</strong>
- <strong>Readers never block writers</strong>: Reads always find an appropriate version
- <strong>Writers never block readers</strong>: Old versions remain available for concurrent readers
- <strong>Consistent snapshots</strong>: Each transaction sees a consistent point-in-time view
- <strong>Reduced contention</strong>: Major performance improvement for read-heavy workloads</p>
<p><strong>Costs:</strong>
- <strong>Storage overhead</strong>: Multiple versions of each data item
- <strong>Garbage collection</strong>: Old versions must be cleaned up (vacuum in PostgreSQL)
- <strong>Version traversal</strong>: Finding the right version takes time (especially with many versions)</p>
<h3 id="74-mvcc-in-postgresql">7.4 MVCC in PostgreSQL<a class="header-link" href="#74-mvcc-in-postgresql" title="Permanent link">&para;</a></h3>
<p>PostgreSQL implements MVCC using <strong>xmin</strong> and <strong>xmax</strong> fields in each tuple (row version):</p>
<div class="highlight"><pre><span></span><code><span class="nv">Tuple</span><span class="w"> </span><span class="nv">Header</span><span class="w"> </span><span class="nv">Fields</span>:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">  </span><span class="nv">xmin</span><span class="w">  </span>â”‚<span class="w">  </span><span class="nv">xmax</span><span class="w">  </span>â”‚<span class="w">  </span><span class="nv">ctid</span><span class="w">     </span>â”‚<span class="w">  </span><span class="nv">data</span><span class="w">    </span>â”‚
â”‚<span class="w"> </span><span class="ss">(</span><span class="nv">creator</span>â”‚<span class="ss">(</span><span class="nv">deleter</span>â”‚<span class="ss">(</span><span class="nv">physical</span><span class="w">  </span>â”‚<span class="w">          </span>â”‚
â”‚<span class="w">  </span><span class="nv">txn</span><span class="w"> </span><span class="nv">ID</span><span class="ss">)</span>â”‚<span class="w"> </span><span class="nv">txn</span><span class="w"> </span><span class="nv">ID</span><span class="ss">)</span>â”‚<span class="w"> </span><span class="nv">location</span><span class="ss">)</span><span class="w"> </span>â”‚<span class="w">          </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

<span class="nv">xmin</span>:<span class="w"> </span><span class="nv">Transaction</span><span class="w"> </span><span class="nv">ID</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">created</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">version</span>
<span class="nv">xmax</span>:<span class="w"> </span><span class="nv">Transaction</span><span class="w"> </span><span class="nv">ID</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">deleted</span><span class="o">/</span><span class="nv">updated</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">version</span><span class="w"> </span><span class="ss">(</span><span class="mi">0</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">live</span><span class="ss">)</span>
<span class="nv">ctid</span>:<span class="w"> </span><span class="nv">Physical</span><span class="w"> </span><span class="nv">location</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="k">next</span><span class="w"> </span><span class="nv">version</span><span class="w"> </span><span class="ss">(</span><span class="k">for</span><span class="w"> </span><span class="nv">updates</span><span class="ss">)</span>
</code></pre></div>

<p><strong>How an UPDATE works in PostgreSQL:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">Before</span><span class="w"> </span><span class="nt">UPDATE</span><span class="o">:</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nt">xmin</span><span class="o">=</span><span class="nt">100</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">xmax</span><span class="o">=</span><span class="nt">0</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">name</span><span class="o">=</span><span class="s1">&#39;Alice&#39;</span><span class="w">      </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â†</span><span class="w"> </span><span class="nt">current</span><span class="w"> </span><span class="nt">version</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="nt">Transaction</span><span class="w"> </span><span class="nt">200</span><span class="w"> </span><span class="nt">executes</span><span class="o">:</span><span class="w"> </span><span class="nt">UPDATE</span><span class="w"> </span><span class="nt">emp</span><span class="w"> </span><span class="nt">SET</span><span class="w"> </span><span class="nt">name</span><span class="o">=</span><span class="s1">&#39;ALICE&#39;</span><span class="w"> </span><span class="nt">WHERE</span><span class="w"> </span><span class="nt">id</span><span class="o">=</span><span class="nt">1</span><span class="o">;</span>

<span class="nt">After</span><span class="w"> </span><span class="nt">UPDATE</span><span class="o">:</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nt">xmin</span><span class="o">=</span><span class="nt">100</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">xmax</span><span class="o">=</span><span class="nt">200</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">name</span><span class="o">=</span><span class="s1">&#39;Alice&#39;</span><span class="w">      </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â†</span><span class="w"> </span><span class="nt">old</span><span class="w"> </span><span class="nt">version</span><span class="w"> </span><span class="o">(</span><span class="nt">dead</span><span class="w"> </span><span class="nt">tuple</span><span class="o">)</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nt">xmin</span><span class="o">=</span><span class="nt">200</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">xmax</span><span class="o">=</span><span class="nt">0</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">name</span><span class="o">=</span><span class="s1">&#39;ALICE&#39;</span><span class="w">      </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â†</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">version</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="nt">Transaction</span><span class="w"> </span><span class="nt">150</span><span class="w"> </span><span class="o">(</span><span class="nt">started</span><span class="w"> </span><span class="nt">before</span><span class="w"> </span><span class="nt">200</span><span class="o">):</span><span class="w"> </span><span class="nt">sees</span><span class="w"> </span><span class="nt">name</span><span class="o">=</span><span class="s1">&#39;Alice&#39;</span><span class="w"> </span><span class="o">(</span><span class="nt">xmin</span><span class="o">=</span><span class="nt">100</span><span class="o">,</span><span class="w"> </span><span class="nt">xmax</span><span class="o">=</span><span class="nt">200</span><span class="o">&gt;</span><span class="nt">150</span><span class="o">)</span>
<span class="nt">Transaction</span><span class="w"> </span><span class="nt">250</span><span class="w"> </span><span class="o">(</span><span class="nt">started</span><span class="w"> </span><span class="nt">after</span><span class="w"> </span><span class="nt">200</span><span class="o">):</span><span class="w">  </span><span class="nt">sees</span><span class="w"> </span><span class="nt">name</span><span class="o">=</span><span class="s1">&#39;ALICE&#39;</span><span class="w"> </span><span class="o">(</span><span class="nt">xmin</span><span class="o">=</span><span class="nt">200</span><span class="err">â‰¤</span><span class="nt">250</span><span class="o">,</span><span class="w"> </span><span class="nt">xmax</span><span class="o">=</span><span class="nt">0</span><span class="o">)</span>
</code></pre></div>

<p><strong>Visibility rules (simplified):</strong>
A tuple is visible to transaction T if:
1. <code>xmin</code> is committed AND <code>xmin â‰¤ snapshot_of(T)</code>
2. Either <code>xmax = 0</code> (not deleted) OR <code>xmax &gt; snapshot_of(T)</code> (deleted after T's snapshot)</p>
<p><strong>VACUUM</strong>: PostgreSQL's garbage collector removes dead tuples that are no longer visible to any active transaction.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Manual vacuum</span>
<span class="k">VACUUM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span>

<span class="c1">-- Vacuum with analysis (updates statistics too)</span>
<span class="k">VACUUM</span><span class="w"> </span><span class="k">ANALYZE</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span>

<span class="c1">-- See dead tuples</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">relname</span><span class="p">,</span><span class="w"> </span><span class="n">n_dead_tup</span><span class="p">,</span><span class="w"> </span><span class="n">n_live_tup</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_user_tables</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">relname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;employees&#39;</span><span class="p">;</span>
</code></pre></div>

<h3 id="75-mvcc-in-mysql-innodb">7.5 MVCC in MySQL InnoDB<a class="header-link" href="#75-mvcc-in-mysql-innodb" title="Permanent link">&para;</a></h3>
<p>InnoDB stores MVCC data differently:</p>
<div class="highlight"><pre><span></span><code>InnoDB MVCC:
<span class="k">-</span> Clustered index stores the latest version
<span class="k">-</span> Old versions are stored in the UNDO LOG (rollback segment)
<span class="k">-</span> Each row has hidden columns: DB_TRX_ID, DB_ROLL_PTR

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Clustered Index (latest version)        â”‚
â”‚ DB_TRX_ID=200 â”‚ DB_ROLL_PTR=ptr1       â”‚
â”‚ name=&#39;ALICE&#39;                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ (follow rollback pointer)
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Undo Log (previous version)             â”‚
â”‚ DB_TRX_ID=100 â”‚ DB_ROLL_PTR=null       â”‚
â”‚ name=&#39;Alice&#39;                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>Key difference from PostgreSQL:</strong>
- PostgreSQL: new version in the heap, old version becomes dead tuple
- InnoDB: latest version in the clustered index, old versions in undo log
- InnoDB approach: less heap bloat, but undo log can grow large</p>
<hr />
<h2 id="8-optimistic-concurrency-control-occ">8. Optimistic Concurrency Control (OCC)<a class="header-link" href="#8-optimistic-concurrency-control-occ" title="Permanent link">&para;</a></h2>
<h3 id="81-concept">8.1 Concept<a class="header-link" href="#81-concept" title="Permanent link">&para;</a></h3>
<p><strong>Optimistic Concurrency Control</strong> (also called <strong>validation-based</strong> protocol) assumes conflicts are rare and lets transactions execute freely, validating correctness only at commit time.</p>
<div class="highlight"><pre><span></span><code><span class="nv">Pessimistic</span><span class="w"> </span><span class="ss">(</span><span class="nv">Locking</span><span class="ss">)</span>:
<span class="w">  </span><span class="s2">&quot;Prevent conflicts from happening&quot;</span>
<span class="w">  </span><span class="nv">Lock</span><span class="w"> </span><span class="nv">before</span><span class="w"> </span><span class="nv">access</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">guaranteed</span><span class="w"> </span><span class="nv">safe</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">may</span><span class="w"> </span><span class="k">wait</span><span class="o">/</span><span class="nv">block</span>

<span class="nv">Optimistic</span><span class="w"> </span><span class="ss">(</span><span class="nv">OCC</span><span class="ss">)</span>:
<span class="w">  </span><span class="s2">&quot;Assume no conflicts, check at the end&quot;</span>
<span class="w">  </span><span class="nv">Execute</span><span class="w"> </span><span class="nv">freely</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">validate</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">commit</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">abort</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">conflict</span><span class="w"> </span><span class="nv">detected</span>
</code></pre></div>

<h3 id="82-three-phases">8.2 Three Phases<a class="header-link" href="#82-three-phases" title="Permanent link">&para;</a></h3>
<p>Each transaction goes through three phases:</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">    </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">    </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">   </span><span class="nv">Phase</span><span class="w"> </span><span class="mi">1</span>:<span class="w">   </span>â”‚<span class="w">    </span>â”‚<span class="w">   </span><span class="nv">Phase</span><span class="w"> </span><span class="mi">2</span>:<span class="w">   </span>â”‚<span class="w">    </span>â”‚<span class="w">   </span><span class="nv">Phase</span><span class="w"> </span><span class="mi">3</span>:<span class="w">   </span>â”‚
â”‚<span class="w">    </span><span class="nv">READ</span><span class="w">      </span>â”‚<span class="w"> </span>â†’<span class="w">  </span>â”‚<span class="w">  </span><span class="nv">VALIDATION</span><span class="w">  </span>â”‚<span class="w"> </span>â†’<span class="w">  </span>â”‚<span class="w">    </span><span class="nv">WRITE</span><span class="w">     </span>â”‚
â”‚<span class="w">              </span>â”‚<span class="w">    </span>â”‚<span class="w">              </span>â”‚<span class="w">    </span>â”‚<span class="w">              </span>â”‚
â”‚<span class="w"> </span><span class="nv">Read</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">DB</span><span class="w"> </span>â”‚<span class="w">    </span>â”‚<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="k">for</span><span class="w">    </span>â”‚<span class="w">    </span>â”‚<span class="w"> </span><span class="nv">Apply</span><span class="w"> </span><span class="nv">writes</span><span class="w"> </span>â”‚
â”‚<span class="w"> </span><span class="nv">Write</span><span class="w"> </span><span class="nv">to</span><span class="w">     </span>â”‚<span class="w">    </span>â”‚<span class="w"> </span><span class="nv">conflicts</span><span class="w">    </span>â”‚<span class="w">    </span>â”‚<span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">database</span><span class="w">  </span>â”‚
â”‚<span class="w"> </span><span class="nv">private</span><span class="w">      </span>â”‚<span class="w">    </span>â”‚<span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">other</span><span class="w">   </span>â”‚<span class="w">    </span>â”‚<span class="w">              </span>â”‚
â”‚<span class="w"> </span><span class="nv">workspace</span><span class="w">    </span>â”‚<span class="w">    </span>â”‚<span class="w"> </span><span class="nv">transactions</span><span class="w"> </span>â”‚<span class="w">    </span>â”‚<span class="w">              </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">    </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">    </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>Phase 1 -- Read Phase:</strong>
- All reads come from the database
- All writes go to a <strong>private workspace</strong> (not the database)
- No locks are acquired</p>
<p><strong>Phase 2 -- Validation Phase:</strong>
- Check whether the transaction's reads and writes conflict with other concurrent transactions
- If validation succeeds, proceed to write phase
- If validation fails, abort and restart</p>
<p><strong>Phase 3 -- Write Phase:</strong>
- Apply the changes from the private workspace to the database
- This phase is performed atomically (with brief locks)</p>
<h3 id="83-validation-rules">8.3 Validation Rules<a class="header-link" href="#83-validation-rules" title="Permanent link">&para;</a></h3>
<p>Each transaction <code>T_i</code> is assigned a timestamp at the <strong>start of its validation phase</strong>. Let <code>TS(T_i)</code> be this timestamp.</p>
<p>For validation of <code>T_i</code>, check against every transaction <code>T_j</code> where <code>TS(T_j) &lt; TS(T_i)</code> (T_j validated earlier):</p>
<div class="highlight"><pre><span></span><code>VALIDATE(T_i):
    for each T_j where TS(T_j) &lt; TS(T_i):

        // Condition 1: T_j completed all three phases before T_i started read phase
        if T_j completed write phase before T_i started read phase:
            OK (no overlap at all)

        // Condition 2: T_j completed write phase before T_i started write phase,
        // AND T_j&#39;s write set does not intersect T_i&#39;s read set
        else if T_j completed write phase before T_i started validation:
            if WriteSet(T_j) âˆ© ReadSet(T_i) == âˆ…:
                OK
            else:
                FAIL â†’ abort T_i

        // Condition 3: T_j has not yet completed write phase
        // AND T_j&#39;s write set does not intersect T_i&#39;s read or write sets
        else:
            if WriteSet(T_j) âˆ© ReadSet(T_i) == âˆ…
               AND WriteSet(T_j) âˆ© WriteSet(T_i) == âˆ…:
                OK
            else:
                FAIL â†’ abort T_i

    return VALID
</code></pre></div>

<h3 id="84-example-occ-validation">8.4 Example: OCC Validation<a class="header-link" href="#84-example-occ-validation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Tâ‚</span><span class="o">:</span><span class="w"> </span><span class="n">ReadSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="n">A</span><span class="o">,</span><span class="w"> </span><span class="n">B</span><span class="o">},</span><span class="w"> </span><span class="n">WriteSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="n">A</span><span class="o">}</span>
<span class="n">Tâ‚‚</span><span class="o">:</span><span class="w"> </span><span class="n">ReadSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="n">B</span><span class="o">,</span><span class="w"> </span><span class="n">C</span><span class="o">},</span><span class="w"> </span><span class="n">WriteSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="n">C</span><span class="o">}</span>

<span class="n">Timeline</span><span class="o">:</span>
<span class="n">Tâ‚</span><span class="o">:</span><span class="w"> </span><span class="err">â”€â”€</span><span class="n">Read</span><span class="err">â”€â”€â”¤â”€â”€</span><span class="n">Validate</span><span class="o">(</span><span class="n">ts</span><span class="o">=</span><span class="mi">1</span><span class="o">)</span><span class="err">â”€â”€â”¤â”€â”€</span><span class="n">Write</span><span class="err">â”€â”€â”¤</span>
<span class="n">Tâ‚‚</span><span class="o">:</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="n">Read</span><span class="err">â”€â”€â”€â”€â”¤â”€â”€</span><span class="n">Validate</span><span class="o">(</span><span class="n">ts</span><span class="o">=</span><span class="mi">2</span><span class="o">)</span><span class="err">â”€â”€â”¤â”€â”€</span><span class="n">Write</span><span class="err">â”€â”€â”¤</span>

<span class="n">Validating</span><span class="w"> </span><span class="n">Tâ‚‚</span><span class="w"> </span><span class="n">against</span><span class="w"> </span><span class="n">Tâ‚</span><span class="w"> </span><span class="o">(</span><span class="n">TS</span><span class="o">(</span><span class="n">Tâ‚</span><span class="o">)=</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TS</span><span class="o">(</span><span class="n">Tâ‚‚</span><span class="o">)=</span><span class="mi">2</span><span class="o">):</span>
<span class="w">  </span><span class="n">Tâ‚</span><span class="w"> </span><span class="n">completed</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">Tâ‚‚</span><span class="w"> </span><span class="n">started</span><span class="w"> </span><span class="n">validation</span><span class="o">?</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Yes</span><span class="w"> </span><span class="o">(</span><span class="n">Condition</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span>
<span class="w">  </span><span class="n">WriteSet</span><span class="o">(</span><span class="n">Tâ‚</span><span class="o">)</span><span class="w"> </span><span class="err">âˆ©</span><span class="w"> </span><span class="n">ReadSet</span><span class="o">(</span><span class="n">Tâ‚‚</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="n">A</span><span class="o">}</span><span class="w"> </span><span class="err">âˆ©</span><span class="w"> </span><span class="o">{</span><span class="n">B</span><span class="o">,</span><span class="w"> </span><span class="n">C</span><span class="o">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">âˆ…</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">conflict</span><span class="o">!</span>
<span class="w">  </span><span class="n">Tâ‚‚</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">VALID</span><span class="w"> </span><span class="err">âœ“</span>

<span class="n">If</span><span class="w"> </span><span class="n">instead</span><span class="w"> </span><span class="n">WriteSet</span><span class="o">(</span><span class="n">Tâ‚</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="n">B</span><span class="o">}:</span>
<span class="w">  </span><span class="n">WriteSet</span><span class="o">(</span><span class="n">Tâ‚</span><span class="o">)</span><span class="w"> </span><span class="err">âˆ©</span><span class="w"> </span><span class="n">ReadSet</span><span class="o">(</span><span class="n">Tâ‚‚</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="n">B</span><span class="o">}</span><span class="w"> </span><span class="err">âˆ©</span><span class="w"> </span><span class="o">{</span><span class="n">B</span><span class="o">,</span><span class="w"> </span><span class="n">C</span><span class="o">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="n">B</span><span class="o">}</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Conflict</span><span class="o">!</span>
<span class="w">  </span><span class="n">Tâ‚‚</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">INVALID</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">abort</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">restart</span>
</code></pre></div>

<h3 id="85-when-to-use-occ">8.5 When to Use OCC<a class="header-link" href="#85-when-to-use-occ" title="Permanent link">&para;</a></h3>
<p><strong>OCC is ideal when:</strong>
- Conflicts are <strong>rare</strong> (mostly read-only workloads)
- Transactions are <strong>short</strong> (validation overhead is small relative to work)
- High contention would cause excessive blocking with locks</p>
<p><strong>OCC is poor when:</strong>
- Conflicts are <strong>frequent</strong> (high abort rate wastes work)
- Transactions are <strong>long</strong> (redo cost is high after abort)
- Write-heavy workloads (many conflicts)</p>
<p><strong>Real-world use:</strong>
- Google's Spanner uses a variant of OCC for read-write transactions
- Many web applications use "optimistic locking" patterns (version numbers)</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Application-level optimistic locking pattern:</span>
<span class="c1"># Step 1: Read the record with its version</span>
<span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT *, version FROM products WHERE id = ?&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">product_id</span><span class="p">])</span>
<span class="n">old_version</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">version</span>

<span class="c1"># Step 2: Compute new values (in application code)</span>
<span class="n">new_price</span> <span class="o">=</span> <span class="n">compute_new_price</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

<span class="c1"># Step 3: Write with version check</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;UPDATE products SET price = ?, version = version + 1 &quot;</span>
    <span class="s2">&quot;WHERE id = ? AND version = ?&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="n">new_price</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">old_version</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Step 4: Check if update succeeded</span>
<span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">rows_affected</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Version changed â†’ someone else modified it â†’ retry</span>
    <span class="k">raise</span> <span class="n">ConflictError</span><span class="p">(</span><span class="s2">&quot;Concurrent modification detected&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="9-comparison-of-concurrency-control-methods">9. Comparison of Concurrency Control Methods<a class="header-link" href="#9-comparison-of-concurrency-control-methods" title="Permanent link">&para;</a></h2>
<h3 id="91-summary-table">9.1 Summary Table<a class="header-link" href="#91-summary-table" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Approach</th>
<th>Deadlock</th>
<th>Cascade</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td>Basic 2PL</td>
<td>Pessimistic (locks)</td>
<td>Possible</td>
<td>Possible</td>
<td>General purpose</td>
</tr>
<tr>
<td>Strict 2PL</td>
<td>Pessimistic (locks)</td>
<td>Possible</td>
<td>No (writes)</td>
<td>Most OLTP systems</td>
</tr>
<tr>
<td>Rigorous 2PL</td>
<td>Pessimistic (locks)</td>
<td>Possible</td>
<td>No</td>
<td>When simplicity matters</td>
</tr>
<tr>
<td>Timestamp Ordering</td>
<td>Optimistic (timestamps)</td>
<td>Impossible</td>
<td>Possible</td>
<td>Low-conflict workloads</td>
</tr>
<tr>
<td>Thomas's Write Rule</td>
<td>Optimistic (timestamps)</td>
<td>Impossible</td>
<td>Possible</td>
<td>Write-heavy, low conflict</td>
</tr>
<tr>
<td>MVCC</td>
<td>Multi-version</td>
<td>Depends on impl.</td>
<td>No (via snapshots)</td>
<td>Read-heavy, mixed</td>
</tr>
<tr>
<td>OCC (Validation)</td>
<td>Optimistic (validate)</td>
<td>Impossible</td>
<td>No</td>
<td>Read-mostly, short txns</td>
</tr>
</tbody>
</table>
<h3 id="92-decision-guide">9.2 Decision Guide<a class="header-link" href="#92-decision-guide" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Start</span>
<span class="w">  </span><span class="err">â”‚</span>
<span class="w">  </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Workload</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">read</span><span class="o">-</span><span class="n">heavy</span><span class="err">?</span>
<span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Yes</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">MVCC</span><span class="w"> </span><span class="p">(</span><span class="n">PostgreSQL</span><span class="p">,</span><span class="w"> </span><span class="n">Oracle</span><span class="w"> </span><span class="n">style</span><span class="p">)</span>
<span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="k">continue</span>
<span class="w">  </span><span class="err">â”‚</span>
<span class="w">  </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Conflicts</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">rare</span><span class="err">?</span>
<span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Yes</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">OCC</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">Timestamp</span><span class="w"> </span><span class="n">Ordering</span>
<span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="k">continue</span>
<span class="w">  </span><span class="err">â”‚</span>
<span class="w">  </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Need</span><span class="w"> </span><span class="nb">range</span><span class="w"> </span><span class="n">queries</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">predicate</span><span class="w"> </span><span class="n">locking</span><span class="err">?</span>
<span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Yes</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="mi">2</span><span class="n">PL</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">index</span><span class="o">-</span><span class="nb">range</span><span class="w"> </span><span class="n">locks</span>
<span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="k">continue</span>
<span class="w">  </span><span class="err">â”‚</span>
<span class="w">  </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Need</span><span class="w"> </span><span class="n">strict</span><span class="w"> </span><span class="n">recoverability</span><span class="err">?</span>
<span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Yes</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Strict</span><span class="w"> </span><span class="mi">2</span><span class="n">PL</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">Rigorous</span><span class="w"> </span><span class="mi">2</span><span class="n">PL</span>
<span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Basic</span><span class="w"> </span><span class="mi">2</span><span class="n">PL</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">suffice</span>
<span class="w">  </span><span class="err">â”‚</span>
<span class="w">  </span><span class="err">â””â”€</span><span class="w"> </span><span class="n">Distributed</span><span class="w"> </span><span class="n">system</span><span class="err">?</span>
<span class="w">      </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Yes</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">MVCC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">distributed</span><span class="w"> </span><span class="n">timestamps</span><span class="w"> </span><span class="p">(</span><span class="n">Spanner</span><span class="p">)</span>
<span class="w">      </span><span class="err">â””â”€</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Strict</span><span class="w"> </span><span class="mi">2</span><span class="n">PL</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">safe</span><span class="w"> </span><span class="n">default</span>
</code></pre></div>

<h3 id="93-what-real-systems-use">9.3 What Real Systems Use<a class="header-link" href="#93-what-real-systems-use" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Database</th>
<th>Primary Method</th>
</tr>
</thead>
<tbody>
<tr>
<td>PostgreSQL</td>
<td>MVCC (heap-based) + SSI for Serializable</td>
</tr>
<tr>
<td>MySQL InnoDB</td>
<td>MVCC (undo log) + next-key locking for Serializable</td>
</tr>
<tr>
<td>Oracle</td>
<td>MVCC (undo tablespace) + row-level locking</td>
</tr>
<tr>
<td>SQL Server</td>
<td>Lock-based (default) + MVCC (SNAPSHOT isolation opt-in)</td>
</tr>
<tr>
<td>CockroachDB</td>
<td>MVCC + SSI (serializable by default)</td>
</tr>
<tr>
<td>Google Spanner</td>
<td>MVCC + TrueTime + 2PL (externally consistent)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="10-exercises">10. Exercises<a class="header-link" href="#10-exercises" title="Permanent link">&para;</a></h2>
<h3 id="conceptual-questions">Conceptual Questions<a class="header-link" href="#conceptual-questions" title="Permanent link">&para;</a></h3>
<p><strong>Exercise 1</strong>: Explain the difference between shared (S) and exclusive (X) locks. Why can multiple S-locks coexist on the same data item, but not multiple X-locks?</p>
<p><strong>Exercise 2</strong>: A transaction T follows 2PL but acquires all its locks at the very beginning (before any reads or writes) and releases them all at the very end (after the last operation). Is T following strict 2PL? Rigorous 2PL? Both? Explain.</p>
<p><strong>Exercise 3</strong>: Compare the Wait-Die and Wound-Wait deadlock prevention schemes. For each, explain which transaction gets priority and why starvation is avoided.</p>
<h3 id="lock-based-protocol-problems">Lock-Based Protocol Problems<a class="header-link" href="#lock-based-protocol-problems" title="Permanent link">&para;</a></h3>
<p><strong>Exercise 4</strong>: Consider three transactions:</p>
<div class="highlight"><pre><span></span><code><span class="n">Tâ‚</span><span class="o">:</span><span class="w"> </span><span class="n">read</span><span class="o">(</span><span class="n">A</span><span class="o">),</span><span class="w"> </span><span class="n">write</span><span class="o">(</span><span class="n">A</span><span class="o">),</span><span class="w"> </span><span class="n">read</span><span class="o">(</span><span class="n">B</span><span class="o">),</span><span class="w"> </span><span class="n">write</span><span class="o">(</span><span class="n">B</span><span class="o">)</span>
<span class="n">Tâ‚‚</span><span class="o">:</span><span class="w"> </span><span class="n">read</span><span class="o">(</span><span class="n">B</span><span class="o">),</span><span class="w"> </span><span class="n">write</span><span class="o">(</span><span class="n">B</span><span class="o">)</span>
<span class="n">Tâ‚ƒ</span><span class="o">:</span><span class="w"> </span><span class="n">read</span><span class="o">(</span><span class="n">A</span><span class="o">),</span><span class="w"> </span><span class="n">read</span><span class="o">(</span><span class="n">B</span><span class="o">)</span>
</code></pre></div>

<p>(a) Show a possible execution under strict 2PL where Tâ‚ and Tâ‚ƒ can proceed concurrently but Tâ‚‚ must wait.
(b) Can deadlock occur between Tâ‚ and Tâ‚‚ under 2PL? If so, show the scenario.</p>
<p><strong>Exercise 5</strong>: Consider the following lock requests arriving in order:</p>
<div class="highlight"><pre><span></span><code><span class="n">Tâ‚</span><span class="o">:</span><span class="w"> </span><span class="n">lock</span><span class="o">-</span><span class="n">S</span><span class="o">(</span><span class="n">A</span><span class="o">)</span>
<span class="n">Tâ‚‚</span><span class="o">:</span><span class="w"> </span><span class="n">lock</span><span class="o">-</span><span class="n">X</span><span class="o">(</span><span class="n">B</span><span class="o">)</span>
<span class="n">Tâ‚ƒ</span><span class="o">:</span><span class="w"> </span><span class="n">lock</span><span class="o">-</span><span class="n">S</span><span class="o">(</span><span class="n">A</span><span class="o">)</span>
<span class="n">Tâ‚</span><span class="o">:</span><span class="w"> </span><span class="n">lock</span><span class="o">-</span><span class="n">X</span><span class="o">(</span><span class="n">B</span><span class="o">)</span><span class="w">     </span><span class="err">â†’</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="o">(</span><span class="n">Tâ‚‚</span><span class="w"> </span><span class="n">holds</span><span class="w"> </span><span class="n">X</span><span class="o">(</span><span class="n">B</span><span class="o">))</span>
<span class="n">Tâ‚‚</span><span class="o">:</span><span class="w"> </span><span class="n">lock</span><span class="o">-</span><span class="n">S</span><span class="o">(</span><span class="n">A</span><span class="o">)</span><span class="w">     </span><span class="err">â†’</span><span class="w"> </span><span class="o">?</span>
<span class="n">Tâ‚ƒ</span><span class="o">:</span><span class="w"> </span><span class="n">lock</span><span class="o">-</span><span class="n">X</span><span class="o">(</span><span class="n">A</span><span class="o">)</span><span class="w">     </span><span class="err">â†’</span><span class="w"> </span><span class="o">?</span>
</code></pre></div>

<p>(a) What happens at each step?
(b) Is there a deadlock? If so, identify the cycle in the wait-for graph.
(c) How would Wait-Die resolve this (assume TS(Tâ‚) &lt; TS(Tâ‚‚) &lt; TS(Tâ‚ƒ))?</p>
<p><strong>Exercise 6</strong>: In a multi-granularity locking system, transaction Tâ‚ wants to read rows from table A and exclusively update specific rows in table B. Transaction Tâ‚‚ wants to read the entire table B. Show the intention locks each transaction must acquire and determine whether they can execute concurrently.</p>
<h3 id="timestamp-and-mvcc-problems">Timestamp and MVCC Problems<a class="header-link" href="#timestamp-and-mvcc-problems" title="Permanent link">&para;</a></h3>
<p><strong>Exercise 7</strong>: Given TS(Tâ‚)=100, TS(Tâ‚‚)=150, TS(Tâ‚ƒ)=200. Initial timestamps: W-ts(A)=0, R-ts(A)=0, W-ts(B)=0, R-ts(B)=0.</p>
<p>Execute the following operations using basic timestamp ordering. For each operation, state whether it is allowed or rejected, and update the timestamps.</p>
<div class="highlight"><pre><span></span><code><span class="n">Tâ‚‚</span><span class="o">:</span><span class="w"> </span><span class="n">read</span><span class="o">(</span><span class="n">A</span><span class="o">)</span>
<span class="n">Tâ‚ƒ</span><span class="o">:</span><span class="w"> </span><span class="n">read</span><span class="o">(</span><span class="n">A</span><span class="o">)</span>
<span class="n">Tâ‚</span><span class="o">:</span><span class="w"> </span><span class="n">write</span><span class="o">(</span><span class="n">A</span><span class="o">)</span><span class="w">    </span><span class="err">â†</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">happens</span><span class="o">?</span>
<span class="n">Tâ‚‚</span><span class="o">:</span><span class="w"> </span><span class="n">write</span><span class="o">(</span><span class="n">A</span><span class="o">)</span>
<span class="n">Tâ‚ƒ</span><span class="o">:</span><span class="w"> </span><span class="n">read</span><span class="o">(</span><span class="n">B</span><span class="o">)</span>
<span class="n">Tâ‚‚</span><span class="o">:</span><span class="w"> </span><span class="n">write</span><span class="o">(</span><span class="n">B</span><span class="o">)</span><span class="w">    </span><span class="err">â†</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">happens</span><span class="o">?</span>
<span class="n">Tâ‚</span><span class="o">:</span><span class="w"> </span><span class="n">read</span><span class="o">(</span><span class="n">B</span><span class="o">)</span><span class="w">     </span><span class="err">â†</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">happens</span><span class="o">?</span>
</code></pre></div>

<p>Now repeat the exercise using Thomas's Write Rule. Which operations have different outcomes?</p>
<p><strong>Exercise 8</strong>: In PostgreSQL's MVCC implementation, explain what happens step by step when:
1. Transaction Tâ‚ (txid=100) inserts a row
2. Transaction Tâ‚‚ (txid=150) reads the table
3. Transaction Tâ‚ commits
4. Transaction Tâ‚ƒ (txid=200) reads the table
5. Transaction Tâ‚‚ reads the table again</p>
<p>What does each transaction see at each step? Consider both READ COMMITTED and REPEATABLE READ isolation levels.</p>
<h3 id="occ-problem">OCC Problem<a class="header-link" href="#occ-problem" title="Permanent link">&para;</a></h3>
<p><strong>Exercise 9</strong>: Three transactions execute under OCC:</p>
<div class="highlight"><pre><span></span><code><span class="n">Tâ‚</span><span class="o">:</span><span class="w"> </span><span class="n">ReadSet</span><span class="o">={</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">},</span><span class="w"> </span><span class="n">WriteSet</span><span class="o">={</span><span class="n">A</span><span class="o">}</span><span class="w">     </span><span class="n">Start</span><span class="o">:</span><span class="w"> </span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="n">Validate</span><span class="o">:</span><span class="w"> </span><span class="n">t</span><span class="o">=</span><span class="mi">5</span>
<span class="n">Tâ‚‚</span><span class="o">:</span><span class="w"> </span><span class="n">ReadSet</span><span class="o">={</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">},</span><span class="w"> </span><span class="n">WriteSet</span><span class="o">={</span><span class="n">B</span><span class="o">}</span><span class="w">     </span><span class="n">Start</span><span class="o">:</span><span class="w"> </span><span class="n">t</span><span class="o">=</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="n">Validate</span><span class="o">:</span><span class="w"> </span><span class="n">t</span><span class="o">=</span><span class="mi">6</span>
<span class="n">Tâ‚ƒ</span><span class="o">:</span><span class="w"> </span><span class="n">ReadSet</span><span class="o">={</span><span class="n">A</span><span class="o">,</span><span class="n">C</span><span class="o">},</span><span class="w"> </span><span class="n">WriteSet</span><span class="o">={</span><span class="n">C</span><span class="o">}</span><span class="w">     </span><span class="n">Start</span><span class="o">:</span><span class="w"> </span><span class="n">t</span><span class="o">=</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="n">Validate</span><span class="o">:</span><span class="w"> </span><span class="n">t</span><span class="o">=</span><span class="mi">7</span>
</code></pre></div>

<p>(a) Validate Tâ‚‚ against Tâ‚. Does it pass?
(b) Validate Tâ‚ƒ against Tâ‚ and Tâ‚‚. Does it pass?
(c) If Tâ‚'s WriteSet were {B} instead of {A}, which validations would change?</p>
<h3 id="analysis-and-design">Analysis and Design<a class="header-link" href="#analysis-and-design" title="Permanent link">&para;</a></h3>
<p><strong>Exercise 10</strong>: A banking application has these transaction types:
- Balance inquiry (read one account): 60% of transactions
- Transfer (write two accounts): 30% of transactions
- Month-end report (read all accounts): 10% of transactions</p>
<p>Which concurrency control scheme (strict 2PL, MVCC, or OCC) would you recommend? Justify your answer considering throughput, response time, and the characteristics of each transaction type.</p>
<p><strong>Exercise 11</strong>: Explain why MVCC in PostgreSQL requires VACUUM. What happens if VACUUM is never run? What are the symptoms of a missing or slow VACUUM process (table bloat, transaction ID wraparound)?</p>
<p><strong>Exercise 12</strong>: Google Spanner uses TrueTime (GPS + atomic clocks) to assign globally consistent timestamps to transactions. Explain why regular clock synchronization (NTP) is insufficient for a globally distributed MVCC system. What property does TrueTime provide that NTP cannot guarantee?</p>
<hr />
<p><strong>Previous</strong>: <a href="./10_Transaction_Theory.md">Transaction Theory</a> | <strong>Next</strong>: <a href="./12_Recovery_Systems.md">Recovery Systems</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Database_Theory/10_Transaction_Theory.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">10. Transaction Theory</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Database_Theory/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Database_Theory/12_Recovery_Systems.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">12. Recovery Systems</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}