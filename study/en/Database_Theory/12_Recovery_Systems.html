{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>12. Recovery Systems - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Database_Theory/">Database Theory</a>
    <span class="separator">/</span>
    <span class="current">12. Recovery Systems</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>12. Recovery Systems</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Database_Theory/11_Concurrency_Control.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">11. Concurrency Control</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Database_Theory/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Database_Theory/13_NoSQL_Data_Models.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">NoSQL Data Models</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#1-failure-classification">1. Failure Classification</a><ul>
<li><a href="#11-transaction-failure">1.1 Transaction Failure</a></li>
<li><a href="#12-system-failure-crash">1.2 System Failure (Crash)</a></li>
<li><a href="#13-disk-failure-media-failure">1.3 Disk Failure (Media Failure)</a></li>
<li><a href="#14-failure-summary">1.4 Failure Summary</a></li>
</ul>
</li>
<li><a href="#2-storage-types">2. Storage Types</a><ul>
<li><a href="#21-storage-hierarchy">2.1 Storage Hierarchy</a></li>
<li><a href="#22-stable-storage">2.2 Stable Storage</a></li>
</ul>
</li>
<li><a href="#3-log-based-recovery">3. Log-Based Recovery</a><ul>
<li><a href="#31-the-log">3.1 The Log</a></li>
<li><a href="#32-log-properties">3.2 Log Properties</a></li>
<li><a href="#33-deferred-database-modification">3.3 Deferred Database Modification</a></li>
<li><a href="#34-immediate-database-modification">3.4 Immediate Database Modification</a></li>
</ul>
</li>
<li><a href="#4-write-ahead-logging-wal-protocol">4. Write-Ahead Logging (WAL) Protocol</a><ul>
<li><a href="#41-the-wal-rule">4.1 The WAL Rule</a></li>
<li><a href="#42-commit-rule-force-at-commit">4.2 Commit Rule (Force-at-Commit)</a></li>
<li><a href="#43-group-commit">4.3 Group Commit</a></li>
<li><a href="#44-wal-in-postgresql">4.4 WAL in PostgreSQL</a></li>
</ul>
</li>
<li><a href="#5-checkpoints">5. Checkpoints</a><ul>
<li><a href="#51-why-checkpoints">5.1 Why Checkpoints?</a></li>
<li><a href="#52-simple-quiescent-checkpoint">5.2 Simple (Quiescent) Checkpoint</a></li>
<li><a href="#53-non-quiescent-active-checkpoint">5.3 Non-Quiescent (Active) Checkpoint</a></li>
<li><a href="#54-fuzzy-checkpoints">5.4 Fuzzy Checkpoints</a></li>
</ul>
</li>
<li><a href="#6-aries-recovery-algorithm">6. ARIES Recovery Algorithm</a><ul>
<li><a href="#61-overview">6.1 Overview</a></li>
<li><a href="#62-key-data-structures">6.2 Key Data Structures</a></li>
<li><a href="#63-compensation-log-records-clr">6.3 Compensation Log Records (CLR)</a></li>
<li><a href="#64-the-three-phases">6.4 The Three Phases</a></li>
<li><a href="#65-phase-1-analysis">6.5 Phase 1: Analysis</a></li>
<li><a href="#66-phase-2-redo-repeating-history">6.6 Phase 2: Redo (Repeating History)</a></li>
<li><a href="#67-phase-3-undo">6.7 Phase 3: Undo</a></li>
<li><a href="#68-complete-aries-example">6.8 Complete ARIES Example</a></li>
<li><a href="#69-crash-during-recovery">6.9 Crash During Recovery</a></li>
</ul>
</li>
<li><a href="#7-shadow-paging">7. Shadow Paging</a><ul>
<li><a href="#71-concept">7.1 Concept</a></li>
<li><a href="#72-shadow-paging-vs-wal">7.2 Shadow Paging vs. WAL</a></li>
</ul>
</li>
<li><a href="#8-buffer-management-policies">8. Buffer Management Policies</a><ul>
<li><a href="#81-the-four-combinations">8.1 The Four Combinations</a></li>
<li><a href="#82-why-stealno-force-is-best">8.2 Why Steal/No-Force is Best</a></li>
<li><a href="#83-interaction-with-recovery">8.3 Interaction with Recovery</a></li>
</ul>
</li>
<li><a href="#9-media-recovery-and-backup-strategies">9. Media Recovery and Backup Strategies</a><ul>
<li><a href="#91-the-need-for-backups">9.1 The Need for Backups</a></li>
<li><a href="#92-backup-types">9.2 Backup Types</a></li>
<li><a href="#93-postgresql-backup-commands">9.3 PostgreSQL Backup Commands</a></li>
<li><a href="#94-logical-vs-physical-backup">9.4 Logical vs. Physical Backup</a></li>
<li><a href="#95-backup-best-practices">9.5 Backup Best Practices</a></li>
</ul>
</li>
<li><a href="#10-recovery-in-modern-systems">10. Recovery in Modern Systems</a><ul>
<li><a href="#101-recovery-and-replication">10.1 Recovery and Replication</a></li>
<li><a href="#102-performance-considerations">10.2 Performance Considerations</a></li>
<li><a href="#103-parallel-recovery">10.3 Parallel Recovery</a></li>
</ul>
</li>
<li><a href="#11-exercises">11. Exercises</a><ul>
<li><a href="#conceptual-questions">Conceptual Questions</a></li>
<li><a href="#log-based-recovery">Log-Based Recovery</a></li>
<li><a href="#aries-algorithm">ARIES Algorithm</a></li>
<li><a href="#buffer-management">Buffer Management</a></li>
<li><a href="#backup-and-media-recovery">Backup and Media Recovery</a></li>
</ul>
</li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="12-recovery-systems">12. Recovery Systems<a class="header-link" href="#12-recovery-systems" title="Permanent link">&para;</a></h1>
<p><strong>Previous</strong>: <a href="./11_Concurrency_Control.md">Concurrency Control</a> | <strong>Next</strong>: <a href="./13_NoSQL_and_NewSQL.md">NoSQL and NewSQL</a></p>
<hr />
<h2 id="learning-objectives">Learning Objectives<a class="header-link" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<ul>
<li>Classify types of failures and understand storage hierarchy</li>
<li>Master log-based recovery techniques: deferred and immediate modification</li>
<li>Understand the Write-Ahead Logging (WAL) protocol and why it is essential</li>
<li>Learn checkpoint mechanisms including fuzzy checkpoints</li>
<li>Study the ARIES recovery algorithm in detail: Analysis, Redo, Undo phases</li>
<li>Compare recovery approaches: shadow paging vs. WAL-based recovery</li>
<li>Understand buffer management policies: force/no-force, steal/no-steal</li>
<li>Learn media recovery and backup strategies</li>
</ul>
<hr />
<h2 id="1-failure-classification">1. Failure Classification<a class="header-link" href="#1-failure-classification" title="Permanent link">&para;</a></h2>
<p>Database systems must handle various types of failures gracefully. Understanding failure types is essential for designing appropriate recovery mechanisms.</p>
<h3 id="11-transaction-failure">1.1 Transaction Failure<a class="header-link" href="#11-transaction-failure" title="Permanent link">&para;</a></h3>
<p>Failures within a single transaction. The rest of the system is unaffected.</p>
<p><strong>Logical errors:</strong>
- Division by zero
- Constraint violation (e.g., unique key, foreign key)
- Application-level assertion failure
- User-initiated abort (ROLLBACK)</p>
<p><strong>System errors affecting a transaction:</strong>
- Deadlock victim selection (transaction is aborted to break deadlock)
- Timeout expiration
- Out-of-memory for the transaction's workspace</p>
<div class="highlight"><pre><span></span><code><span class="n">Transaction</span><span class="w"> </span><span class="n">Failure</span><span class="w"> </span><span class="n">Recovery</span><span class="p">:</span>
<span class="w">  </span><span class="n">Tâ‚</span><span class="p">:</span><span class="w"> </span><span class="n">read</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="n">write</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="n">read</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="err">â†</span><span class="w"> </span><span class="n">constraint</span><span class="w"> </span><span class="n">violation</span><span class="o">!</span>
<span class="w">      </span><span class="err">â†“</span>
<span class="w">  </span><span class="n">UNDO</span><span class="w"> </span><span class="n">Tâ‚</span><span class="s1">&#39;s write to A</span>
<span class="w">  </span><span class="n">Release</span><span class="w"> </span><span class="n">Tâ‚</span><span class="s1">&#39;s locks</span>
<span class="w">  </span><span class="n">Tâ‚</span><span class="w"> </span><span class="n">enters</span><span class="w"> </span><span class="n">ABORTED</span><span class="w"> </span><span class="n">state</span>
</code></pre></div>

<h3 id="12-system-failure-crash">1.2 System Failure (Crash)<a class="header-link" href="#12-system-failure-crash" title="Permanent link">&para;</a></h3>
<p>The entire system halts unexpectedly. Volatile storage (main memory, buffer pool) is lost, but disk contents survive.</p>
<p><strong>Causes:</strong>
- Operating system crash
- Power failure (without UPS)
- Hardware failure (CPU, memory)
- Software bug in the DBMS</p>
<div class="highlight"><pre><span></span><code>System Failure:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Main Memory (LOST)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Buffer Pool â”‚ â”‚ Lock Table â”‚  â”‚
â”‚  â”‚ (dirty     â”‚ â”‚ (all locks â”‚  â”‚
â”‚  â”‚  pages)    â”‚ â”‚  lost)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†•  CRASH  â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Disk (SURVIVES)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Database   â”‚ â”‚ Log File   â”‚  â”‚
â”‚  â”‚ Files      â”‚ â”‚ (WAL)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

After recovery:
- Committed transactions: REDO (effects must persist)
- Uncommitted transactions: UNDO (effects must be reversed)
</code></pre></div>

<h3 id="13-disk-failure-media-failure">1.3 Disk Failure (Media Failure)<a class="header-link" href="#13-disk-failure-media-failure" title="Permanent link">&para;</a></h3>
<p>Physical destruction of disk storage. Data on the affected disk is lost.</p>
<p><strong>Causes:</strong>
- Disk head crash
- Controller failure
- Fire, flood, or other physical damage</p>
<div class="highlight"><pre><span></span><code>Disk Failure Recovery:
  Primary disk destroyed
      â†“
  Restore from backup (tape, remote replica)
      â†“
  Replay log from backup point to failure point
      â†“
  Database restored to consistent state
</code></pre></div>

<h3 id="14-failure-summary">1.4 Failure Summary<a class="header-link" href="#14-failure-summary" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Failure Type</th>
<th>What is Lost</th>
<th>Recovery Method</th>
</tr>
</thead>
<tbody>
<tr>
<td>Transaction</td>
<td>Transaction's partial work</td>
<td>Undo (rollback) using log</td>
</tr>
<tr>
<td>System (crash)</td>
<td>Volatile storage (buffer pool)</td>
<td>Redo committed + Undo uncommitted</td>
</tr>
<tr>
<td>Disk (media)</td>
<td>Disk contents</td>
<td>Restore from backup + replay log</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2-storage-types">2. Storage Types<a class="header-link" href="#2-storage-types" title="Permanent link">&para;</a></h2>
<h3 id="21-storage-hierarchy">2.1 Storage Hierarchy<a class="header-link" href="#21-storage-hierarchy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Storage</span><span class="w"> </span><span class="nl">Hierarchy:</span>

<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">   </span><span class="n">Volatile</span><span class="w"> </span><span class="n">Storage</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="n">CPU</span><span class="w"> </span><span class="n">registers</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">memory</span>
<span class="err">â”‚</span><span class="w">   </span><span class="p">(</span><span class="n">fast</span><span class="p">,</span><span class="w"> </span><span class="n">lost</span><span class="w"> </span><span class="n">on</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="nl">Access:</span><span class="w"> </span><span class="n">nanoseconds</span>
<span class="err">â”‚</span><span class="w">    </span><span class="n">power</span><span class="w"> </span><span class="n">failure</span><span class="p">)</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Nonvolatile</span><span class="w"> </span><span class="n">Storage</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="n">SSD</span><span class="p">,</span><span class="w"> </span><span class="n">HDD</span><span class="p">,</span><span class="w"> </span><span class="n">flash</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="n">survives</span><span class="w"> </span><span class="n">power</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="nl">Access:</span><span class="w"> </span><span class="n">microseconds</span><span class="w"> </span><span class="p">(</span><span class="n">SSD</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">milliseconds</span><span class="w"> </span><span class="p">(</span><span class="n">HDD</span><span class="p">)</span>
<span class="err">â”‚</span><span class="w">   </span><span class="n">failure</span><span class="p">,</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">disk</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="n">failure</span><span class="p">)</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">   </span><span class="n">Stable</span><span class="w"> </span><span class="n">Storage</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Mirrored</span><span class="w"> </span><span class="n">disks</span><span class="p">,</span><span class="w"> </span><span class="n">RAID</span><span class="p">,</span><span class="w"> </span><span class="n">remote</span><span class="w"> </span><span class="n">replicas</span><span class="p">,</span><span class="w"> </span><span class="n">tape</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="n">ideally</span><span class="w"> </span><span class="n">survives</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="nl">Access:</span><span class="w"> </span><span class="n">milliseconds</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">hours</span>
<span class="err">â”‚</span><span class="w">   </span><span class="n">ALL</span><span class="w"> </span><span class="n">failures</span><span class="p">)</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="22-stable-storage">2.2 Stable Storage<a class="header-link" href="#22-stable-storage" title="Permanent link">&para;</a></h3>
<p>True stable storage is an idealization -- no real storage survives all possible failures. In practice, we approximate stable storage using:</p>
<ol>
<li><strong>RAID</strong> (Redundant Array of Independent Disks):</li>
<li>RAID 1: Mirroring (two copies of every block)</li>
<li>
<p>RAID 5/6: Parity-based redundancy</p>
</li>
<li>
<p><strong>Remote replication</strong>: Write to geographically separate locations</p>
</li>
<li>
<p><strong>Multiple copies</strong>: Maintain copies on different media (disk + tape + cloud)</p>
</li>
</ol>
<p><strong>For the log file</strong>, we need the strongest durability guarantee, so the log is typically stored on the most reliable storage available.</p>
<hr />
<h2 id="3-log-based-recovery">3. Log-Based Recovery<a class="header-link" href="#3-log-based-recovery" title="Permanent link">&para;</a></h2>
<h3 id="31-the-log">3.1 The Log<a class="header-link" href="#31-the-log" title="Permanent link">&para;</a></h3>
<p>The <strong>log</strong> (also called <strong>journal</strong> or <strong>write-ahead log</strong>) is a sequential record of all database modifications. It is the foundation of recovery.</p>
<div class="highlight"><pre><span></span><code>Log Record Types:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ &lt;T_i, start&gt;           Transaction T_i has started       â”‚
â”‚ &lt;T_i, X, V_old, V_new&gt; T_i changed X from V_old to V_newâ”‚
â”‚ &lt;T_i, commit&gt;          Transaction T_i has committed     â”‚
â”‚ &lt;T_i, abort&gt;           Transaction T_i has aborted       â”‚
â”‚ &lt;checkpoint L&gt;          Checkpoint with active txn list L â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>Example log:</strong></p>
<div class="highlight"><pre><span></span><code>LSN  Log Record
â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1    &lt;Tâ‚, start&gt;
2    &lt;Tâ‚, A, 100, 50&gt;           Tâ‚ changed A from 100 to 50
3    &lt;Tâ‚, B, 200, 250&gt;          Tâ‚ changed B from 200 to 250
4    &lt;Tâ‚‚, start&gt;
5    &lt;Tâ‚‚, C, 300, 400&gt;          Tâ‚‚ changed C from 300 to 400
6    &lt;Tâ‚, commit&gt;
7    &lt;Tâ‚‚, D, 500, 600&gt;          Tâ‚‚ changed D from 500 to 600
                                  â† CRASH (Tâ‚‚ not committed)
</code></pre></div>

<h3 id="32-log-properties">3.2 Log Properties<a class="header-link" href="#32-log-properties" title="Permanent link">&para;</a></h3>
<p><strong>Key properties:</strong>
1. <strong>Append-only</strong>: New records are always added at the end
2. <strong>Sequential writes</strong>: Efficient for disk I/O
3. <strong>Write-ahead</strong>: Log records written BEFORE corresponding data modifications (WAL rule)
4. <strong>Force at commit</strong>: Log records for a transaction must be on stable storage before the commit completes</p>
<h3 id="33-deferred-database-modification">3.3 Deferred Database Modification<a class="header-link" href="#33-deferred-database-modification" title="Permanent link">&para;</a></h3>
<p>In the <strong>deferred modification</strong> scheme, all writes are deferred until the transaction commits. During execution, modifications are recorded only in the log.</p>
<div class="highlight"><pre><span></span><code>Deferred Modification:

Tâ‚ executes:
  Log: &lt;Tâ‚, start&gt;
  Log: &lt;Tâ‚, A, <span class="ge">_, 50&gt;           Record intent to write (old value not needed)</span>
<span class="ge">  Log: &lt;Tâ‚, B, _</span>, 250&gt;          Record intent to write
  Log: &lt;Tâ‚, commit&gt;
  â”€â”€ NOW apply writes to database â”€â”€
  Database: A = 50, B = 250

Recovery needs only REDO (no UNDO needed because uncommitted
transactions never wrote to the database).
</code></pre></div>

<p><strong>Recovery after crash:</strong>
- <strong>Committed transactions</strong>: Redo all their writes (from the log)
- <strong>Uncommitted transactions</strong>: Ignore (they never modified the database)</p>
<p><strong>Advantages:</strong>
- No UNDO needed (simpler recovery)
- No dirty data in the database</p>
<p><strong>Disadvantages:</strong>
- All writes must fit in memory until commit
- Long transactions require large buffers
- Cannot release locks early (must hold all locks until commit + write)</p>
<h3 id="34-immediate-database-modification">3.4 Immediate Database Modification<a class="header-link" href="#34-immediate-database-modification" title="Permanent link">&para;</a></h3>
<p>In the <strong>immediate modification</strong> scheme, writes are applied to the database as they occur (possibly before commit). This is the approach used by all major database systems.</p>
<div class="highlight"><pre><span></span><code>Immediate Modification:

Tâ‚ executes:
  Log: &lt;Tâ‚, start&gt;
  Log: &lt;Tâ‚, A, 100, 50&gt;         Record both old and new values
  Database: A = 50               â† written to database immediately
  Log: &lt;Tâ‚, B, 200, 250&gt;
  Database: B = 250              â† written to database immediately
  Log: &lt;Tâ‚, commit&gt;

Recovery may need both REDO and UNDO.
</code></pre></div>

<p><strong>Recovery after crash:</strong>
- <strong>Committed transactions</strong>: REDO their writes (to ensure changes persist)
- <strong>Uncommitted transactions</strong>: UNDO their writes (to reverse partial changes)</p>
<div class="highlight"><pre><span></span><code><span class="nv">Recovery</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">example</span><span class="w"> </span><span class="nv">log</span>:

<span class="nv">LSN</span><span class="w">  </span><span class="nv">Log</span><span class="w"> </span><span class="nv">Record</span>
â”€â”€â”€<span class="w">  </span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
<span class="mi">1</span><span class="w">    </span><span class="o">&lt;</span><span class="nv">T</span>â‚,<span class="w"> </span><span class="nv">start</span><span class="o">&gt;</span>
<span class="mi">2</span><span class="w">    </span><span class="o">&lt;</span><span class="nv">T</span>â‚,<span class="w"> </span><span class="nv">A</span>,<span class="w"> </span><span class="mi">100</span>,<span class="w"> </span><span class="mi">50</span><span class="o">&gt;</span>
<span class="mi">3</span><span class="w">    </span><span class="o">&lt;</span><span class="nv">T</span>â‚,<span class="w"> </span><span class="nv">B</span>,<span class="w"> </span><span class="mi">200</span>,<span class="w"> </span><span class="mi">250</span><span class="o">&gt;</span>
<span class="mi">4</span><span class="w">    </span><span class="o">&lt;</span><span class="nv">T</span>â‚‚,<span class="w"> </span><span class="nv">start</span><span class="o">&gt;</span>
<span class="mi">5</span><span class="w">    </span><span class="o">&lt;</span><span class="nv">T</span>â‚‚,<span class="w"> </span><span class="nv">C</span>,<span class="w"> </span><span class="mi">300</span>,<span class="w"> </span><span class="mi">400</span><span class="o">&gt;</span>
<span class="mi">6</span><span class="w">    </span><span class="o">&lt;</span><span class="nv">T</span>â‚,<span class="w"> </span><span class="nv">commit</span><span class="o">&gt;</span>
<span class="mi">7</span><span class="w">    </span><span class="o">&lt;</span><span class="nv">T</span>â‚‚,<span class="w"> </span><span class="nv">D</span>,<span class="w"> </span><span class="mi">500</span>,<span class="w"> </span><span class="mi">600</span><span class="o">&gt;</span>
<span class="w">     </span>â†<span class="w"> </span><span class="nv">CRASH</span>

<span class="nv">Recovery</span>:
<span class="w">  </span><span class="nv">T</span>â‚<span class="w"> </span><span class="nv">committed</span><span class="w"> </span><span class="ss">(</span><span class="nv">found</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">T</span>â‚,<span class="w"> </span><span class="nv">commit</span><span class="o">&gt;</span><span class="ss">)</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">REDO</span>:
<span class="w">    </span><span class="nv">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="w">   </span><span class="ss">(</span><span class="nv">from</span><span class="w"> </span><span class="nv">log</span><span class="w"> </span><span class="nv">record</span><span class="w"> </span><span class="mi">2</span><span class="ss">)</span>
<span class="w">    </span><span class="nv">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">250</span><span class="w">  </span><span class="ss">(</span><span class="nv">from</span><span class="w"> </span><span class="nv">log</span><span class="w"> </span><span class="nv">record</span><span class="w"> </span><span class="mi">3</span><span class="ss">)</span>

<span class="w">  </span><span class="nv">T</span>â‚‚<span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">committed</span><span class="w"> </span><span class="ss">(</span><span class="nv">no</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">T</span>â‚‚,<span class="w"> </span><span class="nv">commit</span><span class="o">&gt;</span><span class="ss">)</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">UNDO</span>:
<span class="w">    </span><span class="nv">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="w">  </span><span class="ss">(</span><span class="nv">reverse</span><span class="w"> </span><span class="nv">log</span><span class="w"> </span><span class="nv">record</span><span class="w"> </span><span class="mi">7</span>:<span class="w"> </span><span class="nv">restore</span><span class="w"> </span><span class="nv">old</span><span class="w"> </span><span class="nv">value</span><span class="ss">)</span>
<span class="w">    </span><span class="nv">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span><span class="w">  </span><span class="ss">(</span><span class="nv">reverse</span><span class="w"> </span><span class="nv">log</span><span class="w"> </span><span class="nv">record</span><span class="w"> </span><span class="mi">5</span>:<span class="w"> </span><span class="nv">restore</span><span class="w"> </span><span class="nv">old</span><span class="w"> </span><span class="nv">value</span><span class="ss">)</span>

<span class="w">  </span><span class="nv">REDO</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">forward</span><span class="w"> </span><span class="ss">(</span><span class="nv">oldest</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">newest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">committed</span><span class="w"> </span><span class="nv">txns</span><span class="ss">)</span>
<span class="w">  </span><span class="nv">UNDO</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">backward</span><span class="w"> </span><span class="ss">(</span><span class="nv">newest</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">oldest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">uncommitted</span><span class="w"> </span><span class="nv">txns</span><span class="ss">)</span>
</code></pre></div>

<p><strong>Why REDO is needed even for committed transactions:</strong>
Because a committed transaction's writes might still be in the buffer pool (volatile memory) and not yet flushed to disk when the crash occurred.</p>
<p><strong>Why UNDO is needed for uncommitted transactions:</strong>
Because an uncommitted transaction's writes might have been flushed to disk (by the buffer manager) before the crash.</p>
<hr />
<h2 id="4-write-ahead-logging-wal-protocol">4. Write-Ahead Logging (WAL) Protocol<a class="header-link" href="#4-write-ahead-logging-wal-protocol" title="Permanent link">&para;</a></h2>
<h3 id="41-the-wal-rule">4.1 The WAL Rule<a class="header-link" href="#41-the-wal-rule" title="Permanent link">&para;</a></h3>
<p>The <strong>Write-Ahead Logging (WAL)</strong> protocol is the fundamental rule that makes log-based recovery work:</p>
<p><strong>WAL Rule</strong>: Before a modified data page is written from the buffer pool to disk, <strong>all log records pertaining to that page must be flushed to stable storage</strong>.</p>
<div class="highlight"><pre><span></span><code><span class="nv">WAL</span><span class="w"> </span><span class="nv">Protocol</span>:

<span class="nv">Step</span><span class="w"> </span><span class="mi">1</span>:<span class="w"> </span><span class="nv">Write</span><span class="w"> </span><span class="nv">log</span><span class="w"> </span><span class="nv">record</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">log</span><span class="w"> </span><span class="nv">buffer</span><span class="w"> </span><span class="ss">(</span><span class="nv">in</span><span class="w"> </span><span class="nv">memory</span><span class="ss">)</span>
<span class="nv">Step</span><span class="w"> </span><span class="mi">2</span>:<span class="w"> </span><span class="nv">Flush</span><span class="w"> </span><span class="nv">log</span><span class="w"> </span><span class="nv">record</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">disk</span><span class="w"> </span><span class="ss">(</span><span class="nv">stable</span><span class="w"> </span><span class="nv">storage</span><span class="ss">)</span>
<span class="nv">Step</span><span class="w"> </span><span class="mi">3</span>:<span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="ss">(</span><span class="nv">and</span><span class="w"> </span><span class="nv">only</span><span class="w"> </span><span class="k">then</span><span class="ss">)</span><span class="w"> </span><span class="nv">write</span><span class="w"> </span><span class="nv">modified</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">disk</span>

<span class="nv">Correct</span><span class="w"> </span><span class="nv">order</span>:
<span class="w">  </span><span class="nv">Log</span><span class="w"> </span><span class="nv">buffer</span>:<span class="w"> </span><span class="o">&lt;</span><span class="nv">T</span>â‚,<span class="w"> </span><span class="nv">A</span>,<span class="w"> </span><span class="mi">100</span>,<span class="w"> </span><span class="mi">50</span><span class="o">&gt;</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">Log</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">disk</span>:<span class="w"> </span><span class="o">&lt;</span><span class="nv">T</span>â‚,<span class="w"> </span><span class="nv">A</span>,<span class="w"> </span><span class="mi">100</span>,<span class="w"> </span><span class="mi">50</span><span class="o">&gt;</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">Data</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">disk</span>:<span class="w"> </span><span class="nv">A</span><span class="o">=</span><span class="mi">50</span>
<span class="w">                                                    </span>â†‘
<span class="w">                                          </span><span class="nv">Must</span><span class="w"> </span><span class="nv">happen</span><span class="w"> </span><span class="nv">BEFORE</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="nv">write</span>

<span class="nv">Why</span>?<span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">written</span><span class="w"> </span><span class="nv">first</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">system</span><span class="w"> </span><span class="nv">crashes</span><span class="w"> </span><span class="nv">before</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">log</span><span class="w"> </span><span class="nv">record</span>
<span class="nv">is</span><span class="w"> </span><span class="nv">written</span>,<span class="w"> </span><span class="nv">we</span><span class="w"> </span><span class="nv">cannot</span><span class="w"> </span><span class="nv">undo</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">change</span><span class="w"> </span><span class="ss">(</span><span class="nv">we</span><span class="w"> </span><span class="nv">don</span><span class="err">&#39;t know the old value).</span>
</code></pre></div>

<h3 id="42-commit-rule-force-at-commit">4.2 Commit Rule (Force-at-Commit)<a class="header-link" href="#42-commit-rule-force-at-commit" title="Permanent link">&para;</a></h3>
<p>When a transaction commits, all its log records must be flushed to stable storage <strong>before</strong> the commit is acknowledged to the user:</p>
<div class="highlight"><pre><span></span><code><span class="nv">Commit</span><span class="w"> </span><span class="nv">Protocol</span>:

<span class="nv">T</span>â‚:<span class="w"> </span>...<span class="w"> </span><span class="nv">operations</span><span class="w"> </span>...
<span class="nv">Log</span>:<span class="w"> </span><span class="o">&lt;</span><span class="nv">T</span>â‚,<span class="w"> </span><span class="nv">commit</span><span class="o">&gt;</span>

<span class="nv">Step</span><span class="w"> </span><span class="mi">1</span>:<span class="w"> </span><span class="nv">Flush</span><span class="w"> </span><span class="nv">ALL</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">T</span>â‚<span class="err">&#39;s log records to disk (including &lt;Tâ‚, commit&gt;)</span>
<span class="err">Step 2: Acknowledge commit to user (&quot;Transaction committed&quot;)</span>
<span class="err">Step 3: Modified data pages may be flushed later (lazy)</span>

<span class="err">If crash occurs after Step 1 but before Step 3:</span>
<span class="w">  </span><span class="nv">The</span><span class="w"> </span><span class="nv">log</span><span class="w"> </span><span class="nv">has</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">T</span>â‚,<span class="w"> </span><span class="nv">commit</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">disk</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">REDO</span><span class="w"> </span><span class="nv">T</span>â‚<span class="err">&#39;s changes during recovery âœ“</span>

<span class="err">If crash occurs before Step 1:</span>
<span class="w">  </span><span class="nv">No</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">T</span>â‚,<span class="w"> </span><span class="nv">commit</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">disk</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">UNDO</span><span class="w"> </span><span class="nv">T</span>â‚<span class="err">&#39;s changes during recovery âœ“</span>
</code></pre></div>

<h3 id="43-group-commit">4.3 Group Commit<a class="header-link" href="#43-group-commit" title="Permanent link">&para;</a></h3>
<p>Flushing the log to disk for every single commit is expensive. <strong>Group commit</strong> batches multiple commits into a single disk write:</p>
<div class="highlight"><pre><span></span><code><span class="nv">Without</span><span class="w"> </span><span class="nv">Group</span><span class="w"> </span><span class="nv">Commit</span>:
<span class="w">  </span><span class="nv">T</span>â‚<span class="w"> </span><span class="nv">commit</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">flush</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">ack</span>
<span class="w">  </span><span class="nv">T</span>â‚‚<span class="w"> </span><span class="nv">commit</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">flush</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">ack</span>
<span class="w">  </span><span class="nv">T</span>â‚ƒ<span class="w"> </span><span class="nv">commit</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">flush</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">ack</span>
<span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nv">disk</span><span class="w"> </span><span class="nv">flushes</span><span class="w"> </span><span class="ss">(</span><span class="nv">each</span><span class="w"> </span><span class="o">~</span><span class="mi">5</span><span class="o">-</span><span class="mi">10</span><span class="nv">ms</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">HDD</span><span class="ss">)</span>

<span class="nv">With</span><span class="w"> </span><span class="nv">Group</span><span class="w"> </span><span class="nv">Commit</span>:
<span class="w">  </span><span class="nv">T</span>â‚<span class="w"> </span><span class="nv">commit</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">buffer</span>
<span class="w">  </span><span class="nv">T</span>â‚‚<span class="w"> </span><span class="nv">commit</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">buffer</span><span class="w">     </span>â†’<span class="w"> </span><span class="nv">single</span><span class="w"> </span><span class="nv">flush</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">ack</span><span class="w"> </span><span class="nv">T</span>â‚,<span class="w"> </span><span class="nv">T</span>â‚‚,<span class="w"> </span><span class="nv">T</span>â‚ƒ
<span class="w">  </span><span class="nv">T</span>â‚ƒ<span class="w"> </span><span class="nv">commit</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">buffer</span>
<span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">disk</span><span class="w"> </span><span class="nv">flush</span>

<span class="nv">Trade</span><span class="o">-</span><span class="nv">off</span>:<span class="w"> </span><span class="nv">slightly</span><span class="w"> </span><span class="nv">higher</span><span class="w"> </span><span class="nv">latency</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">individual</span><span class="w"> </span><span class="nv">commits</span>,
<span class="nv">but</span><span class="w"> </span><span class="nv">much</span><span class="w"> </span><span class="nv">higher</span><span class="w"> </span><span class="nv">throughput</span><span class="w"> </span><span class="ss">(</span><span class="nv">more</span><span class="w"> </span><span class="nv">commits</span><span class="w"> </span><span class="nv">per</span><span class="w"> </span><span class="nv">second</span><span class="ss">)</span>.
</code></pre></div>

<p>PostgreSQL uses group commit by default (<code>commit_delay</code> and <code>commit_siblings</code> settings).</p>
<h3 id="44-wal-in-postgresql">4.4 WAL in PostgreSQL<a class="header-link" href="#44-wal-in-postgresql" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>PostgreSQL WAL Architecture:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Shared Buffers (Buffer Pool)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚Page1â”‚ â”‚Page2â”‚ â”‚Page3â”‚ â”‚Page4â”‚  ...   â”‚
â”‚  â”‚dirtyâ”‚ â”‚cleanâ”‚ â”‚dirtyâ”‚ â”‚cleanâ”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚  WAL must be flushed BEFORE
                 â”‚  dirty page can be written
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WAL Buffers â†’ WAL Segment Files         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ WAL buffer  â”‚ â†’ â”‚ 000000010000000042 â”‚â”‚
â”‚  â”‚ (in memory) â”‚   â”‚ 000000010000000043 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ ... (16MB each)    â”‚â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">-- PostgreSQL WAL configuration</span>
<span class="k">SHOW</span><span class="w"> </span><span class="n">wal_level</span><span class="p">;</span><span class="w">           </span><span class="c1">-- minimal, replica, logical</span>
<span class="k">SHOW</span><span class="w"> </span><span class="n">max_wal_size</span><span class="p">;</span><span class="w">        </span><span class="c1">-- max WAL size before checkpoint (default: 1GB)</span>
<span class="k">SHOW</span><span class="w"> </span><span class="n">wal_buffers</span><span class="p">;</span><span class="w">         </span><span class="c1">-- WAL buffer size (default: ~16MB)</span>
<span class="k">SHOW</span><span class="w"> </span><span class="n">synchronous_commit</span><span class="p">;</span><span class="w">  </span><span class="c1">-- on (default), off (async), remote_write, etc.</span>

<span class="c1">-- View WAL statistics</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_wal</span><span class="p">;</span>
</code></pre></div>

<hr />
<h2 id="5-checkpoints">5. Checkpoints<a class="header-link" href="#5-checkpoints" title="Permanent link">&para;</a></h2>
<h3 id="51-why-checkpoints">5.1 Why Checkpoints?<a class="header-link" href="#51-why-checkpoints" title="Permanent link">&para;</a></h3>
<p>Without checkpoints, recovery must scan the <strong>entire log</strong> from the beginning to determine which transactions to redo and undo. For a database that has been running for months, this could take hours.</p>
<p>A <strong>checkpoint</strong> establishes a known good state, limiting how far back recovery must scan.</p>
<h3 id="52-simple-quiescent-checkpoint">5.2 Simple (Quiescent) Checkpoint<a class="header-link" href="#52-simple-quiescent-checkpoint" title="Permanent link">&para;</a></h3>
<p>The simplest checkpoint protocol:</p>
<div class="highlight"><pre><span></span><code><span class="nv">SIMPLE</span><span class="o">-</span><span class="nv">CHECKPOINT</span><span class="ss">()</span>:
<span class="w">    </span><span class="mi">1</span>.<span class="w"> </span><span class="nv">Temporarily</span><span class="w"> </span><span class="nv">stop</span><span class="w"> </span><span class="nv">accepting</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">transactions</span>
<span class="w">    </span><span class="mi">2</span>.<span class="w"> </span><span class="k">Wait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">active</span><span class="w"> </span><span class="nv">transactions</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">complete</span><span class="w"> </span><span class="ss">(</span><span class="nv">commit</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">abort</span><span class="ss">)</span>
<span class="w">    </span><span class="mi">3</span>.<span class="w"> </span><span class="nv">Flush</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">dirty</span><span class="w"> </span><span class="nv">pages</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">buffer</span><span class="w"> </span><span class="nv">pool</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">disk</span>
<span class="w">    </span><span class="mi">4</span>.<span class="w"> </span><span class="nv">Write</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">checkpoint</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">record</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">log</span>
<span class="w">    </span><span class="mi">5</span>.<span class="w"> </span><span class="nv">Flush</span><span class="w"> </span><span class="nv">log</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">disk</span>
<span class="w">    </span><span class="mi">6</span>.<span class="w"> </span><span class="nv">Resume</span><span class="w"> </span><span class="nv">accepting</span><span class="w"> </span><span class="nv">transactions</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nx">Log</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">simple</span><span class="w"> </span><span class="nx">checkpoint</span><span class="p">:</span>

<span class="o">...</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">Tâ‚</span><span class="p">,</span><span class="nx">start</span><span class="p">&gt;</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">Tâ‚</span><span class="p">,</span><span class="nx">A</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">50</span><span class="p">&gt;</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">Tâ‚</span><span class="p">,</span><span class="nx">commit</span><span class="p">&gt;</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">checkpoint</span><span class="p">&gt;</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">Tâ‚‚</span><span class="p">,</span><span class="nx">start</span><span class="p">&gt;</span><span class="w"> </span><span class="o">...</span>
<span class="w">                                     </span><span class="err">â†‘</span>
<span class="w">                            </span><span class="nx">All</span><span class="w"> </span><span class="nx">prior</span><span class="w"> </span><span class="nx">transactions</span><span class="w"> </span><span class="nx">are</span>
<span class="w">                            </span><span class="nx">fully</span><span class="w"> </span><span class="nx">reflected</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">disk</span><span class="p">.</span>
<span class="w">                            </span><span class="nx">Recovery</span><span class="w"> </span><span class="nx">starts</span><span class="w"> </span><span class="nx">here</span><span class="p">.</span>
</code></pre></div>

<p><strong>Problem</strong>: Requires stopping all transactions -- unacceptable for production systems.</p>
<h3 id="53-non-quiescent-active-checkpoint">5.3 Non-Quiescent (Active) Checkpoint<a class="header-link" href="#53-non-quiescent-active-checkpoint" title="Permanent link">&para;</a></h3>
<p>A more practical checkpoint that does not require stopping all transactions:</p>
<div class="highlight"><pre><span></span><code>ACTIVE-CHECKPOINT():
    1. Write &lt;checkpoint L&gt; to log, where L = list of active transactions
    2. Flush all dirty pages from buffer pool to disk
       (new transactions and writes can continue during this flush)
    3. Write &lt;end_checkpoint&gt; to log when flush is complete
</code></pre></div>

<div class="highlight"><pre><span></span><code>Log with active checkpoint:

&lt;Tâ‚,start&gt; &lt;Tâ‚,A,100,50&gt; &lt;checkpoint {Tâ‚,Tâ‚‚}&gt; &lt;Tâ‚‚,B,200,300&gt;
                                â†‘
                       Tâ‚ and Tâ‚‚ were active when
                       checkpoint started

Recovery:
  Must scan back to earliest start of transactions in L
  (i.e., &lt;Tâ‚,start&gt; since Tâ‚ is in the active list)
</code></pre></div>

<h3 id="54-fuzzy-checkpoints">5.4 Fuzzy Checkpoints<a class="header-link" href="#54-fuzzy-checkpoints" title="Permanent link">&para;</a></h3>
<p>A <strong>fuzzy checkpoint</strong> is the most practical approach, used by ARIES and most modern systems:</p>
<div class="highlight"><pre><span></span><code>FUZZY-CHECKPOINT():
    1. Write &lt;begin_checkpoint&gt; to log
    2. Record:
       <span class="k">-</span> Active transaction table (ATT): all active transactions and their status
       <span class="k">-</span> Dirty page table (DPT): all dirty pages in the buffer pool
    3. Write &lt;end_checkpoint ATT, DPT&gt; to log
    4. Flush log to stable storage
    5. Update master record (on disk) to point to &lt;begin_checkpoint&gt;

    Note: Dirty pages are NOT flushed during checkpoint!
    They are flushed asynchronously by the background writer.
</code></pre></div>

<div class="highlight"><pre><span></span><code>Fuzzy Checkpoint Contents:

&lt;begin_checkpoint&gt;
&lt;end_checkpoint&gt;
  Active Transaction Table:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ TxnID   â”‚ Status   â”‚ LastLSN        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Tâ‚      â”‚ Active   â”‚ LSN 150        â”‚
    â”‚ Tâ‚‚      â”‚ Active   â”‚ LSN 180        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Dirty Page Table:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ PageID  â”‚ RecoveryLSN    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Page 5  â”‚ LSN 120        â”‚
    â”‚ Page 12 â”‚ LSN 145        â”‚
    â”‚ Page 8  â”‚ LSN 170        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>Advantages of fuzzy checkpoints:</strong>
- No transaction stalling
- No forced page flushing during checkpoint
- Very fast checkpoint operation
- Recovery uses the checkpoint tables to determine the starting point</p>
<hr />
<h2 id="6-aries-recovery-algorithm">6. ARIES Recovery Algorithm<a class="header-link" href="#6-aries-recovery-algorithm" title="Permanent link">&para;</a></h2>
<h3 id="61-overview">6.1 Overview<a class="header-link" href="#61-overview" title="Permanent link">&para;</a></h3>
<p><strong>ARIES</strong> (Algorithm for Recovery and Isolation Exploiting Semantics) is the most widely used recovery algorithm. Developed at IBM Research by C. Mohan et al. in the early 1990s, it is the basis for recovery in DB2, SQL Server, PostgreSQL (adapted), and many other systems.</p>
<p><strong>Core principles:</strong>
1. <strong>Write-Ahead Logging (WAL)</strong>: Log before data
2. <strong>Repeating history during redo</strong>: Redo all actions (including those of uncommitted transactions) to restore the exact pre-crash state
3. <strong>Logging changes during undo</strong>: Write Compensation Log Records (CLRs) during undo to ensure undo operations are idempotent</p>
<h3 id="62-key-data-structures">6.2 Key Data Structures<a class="header-link" href="#62-key-data-structures" title="Permanent link">&para;</a></h3>
<p><strong>Log Sequence Number (LSN):</strong>
Every log record has a unique, monotonically increasing LSN. Each data page stores the LSN of the most recent log record that modified it (<strong>pageLSN</strong>).</p>
<div class="highlight"><pre><span></span><code><span class="nv">Log</span><span class="w"> </span><span class="nv">Record</span>:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">  </span><span class="nv">LSN</span><span class="w">  </span>â”‚<span class="w"> </span><span class="nv">TxnID</span>â”‚<span class="w"> </span><span class="nv">Type</span><span class="w">   </span>â”‚<span class="w"> </span><span class="nv">PageID</span><span class="w">     </span>â”‚<span class="w"> </span><span class="nv">PrevLSN</span><span class="w">  </span>â”‚
â”‚<span class="w">       </span>â”‚<span class="w">      </span>â”‚<span class="ss">(</span><span class="nv">update</span>,â”‚<span class="w">            </span>â”‚<span class="ss">(</span><span class="nv">previous</span><span class="w"> </span>â”‚
â”‚<span class="w">       </span>â”‚<span class="w">      </span>â”‚<span class="w"> </span><span class="nv">commit</span>,â”‚<span class="w">            </span>â”‚<span class="w"> </span><span class="nv">log</span><span class="w"> </span><span class="nv">record</span>â”‚
â”‚<span class="w">       </span>â”‚<span class="w">      </span>â”‚<span class="w"> </span><span class="nv">CLR</span>,...â”‚<span class="w">            </span>â”‚<span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">same</span><span class="w">  </span>â”‚
â”‚<span class="w">       </span>â”‚<span class="w">      </span>â”‚<span class="ss">)</span><span class="w">       </span>â”‚<span class="w">            </span>â”‚<span class="w"> </span><span class="nv">txn</span><span class="ss">)</span><span class="w">     </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">  </span><span class="nv">Before</span><span class="w"> </span><span class="nv">Image</span><span class="w"> </span><span class="ss">(</span><span class="nv">old</span><span class="w"> </span><span class="nv">value</span><span class="ss">)</span><span class="w">                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">After</span><span class="w"> </span><span class="nv">Image</span><span class="w"> </span><span class="ss">(</span><span class="nv">new</span><span class="w"> </span><span class="nv">value</span><span class="ss">)</span><span class="w">                       </span>â”‚
â”‚<span class="w">  </span><span class="nv">UndoNextLSN</span><span class="w"> </span><span class="ss">(</span><span class="k">for</span><span class="w"> </span><span class="nv">CLR</span><span class="w"> </span><span class="nv">only</span><span class="ss">)</span><span class="w">                   </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>Transaction Table (ATT - Active Transaction Table):</strong>
Maintained in memory. For each active transaction:
- TransID
- Status (active, committing, aborting)
- LastLSN: LSN of the most recent log record for this transaction</p>
<p><strong>Dirty Page Table (DPT):</strong>
Maintained in memory. For each dirty page in the buffer pool:
- PageID
- RecoveryLSN (recLSN): LSN of the <strong>first</strong> log record that dirtied this page since it was last flushed</p>
<div class="highlight"><pre><span></span><code>Transaction Table:           Dirty Page Table:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TransID â”‚ Status â”‚LastLSNâ”‚ â”‚ PageID â”‚ recLSN   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tâ‚      â”‚ active â”‚  45   â”‚ â”‚ P5     â”‚  20      â”‚
â”‚ Tâ‚‚      â”‚ active â”‚  60   â”‚ â”‚ P3     â”‚  35      â”‚
â”‚ Tâ‚ƒ      â”‚commit  â”‚  55   â”‚ â”‚ P8     â”‚  42      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="63-compensation-log-records-clr">6.3 Compensation Log Records (CLR)<a class="header-link" href="#63-compensation-log-records-clr" title="Permanent link">&para;</a></h3>
<p>A <strong>CLR</strong> is a special log record written during the undo phase. It records the undo of a previous update and includes a pointer (<strong>UndoNextLSN</strong>) to the next log record to undo.</p>
<div class="highlight"><pre><span></span><code><span class="nv">CLR</span><span class="w"> </span><span class="nv">Structure</span>:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w"> </span><span class="nv">LSN</span>:<span class="w"> </span><span class="mi">100</span><span class="w">                                     </span>â”‚
â”‚<span class="w"> </span><span class="nv">TransID</span>:<span class="w"> </span><span class="nv">T</span>â‚<span class="w">                                  </span>â”‚
â”‚<span class="w"> </span><span class="nv">Type</span>:<span class="w"> </span><span class="nv">CLR</span><span class="w">                                    </span>â”‚
â”‚<span class="w"> </span><span class="nv">UndoNextLSN</span>:<span class="w"> </span><span class="mi">30</span><span class="w">  </span><span class="ss">(</span>â†<span class="w"> </span><span class="k">next</span><span class="w"> </span><span class="nv">record</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">undo</span><span class="ss">)</span><span class="w">    </span>â”‚
â”‚<span class="w"> </span><span class="nv">Redo</span><span class="w"> </span><span class="nv">info</span>:<span class="w"> </span><span class="s2">&quot;restore A to old value 50&quot;</span><span class="w">       </span>â”‚
â”‚<span class="w"> </span><span class="nv">PrevLSN</span>:<span class="w"> </span><span class="mi">80</span><span class="w">                                  </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

<span class="nv">Purpose</span>:
<span class="o">-</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">system</span><span class="w"> </span><span class="nv">crashes</span><span class="w"> </span><span class="nv">DURING</span><span class="w"> </span><span class="nv">recovery</span><span class="w"> </span><span class="ss">(</span><span class="nv">during</span><span class="w"> </span><span class="nv">undo</span><span class="ss">)</span>,
<span class="w">  </span><span class="nv">the</span><span class="w"> </span><span class="nv">CLR</span><span class="w"> </span><span class="nv">ensures</span><span class="w"> </span><span class="nv">we</span><span class="w"> </span><span class="nv">don</span><span class="err">&#39;t undo the same operation twice.</span>
<span class="err">- CLRs are REDO-only (they are never undone themselves).</span>
</code></pre></div>

<h3 id="64-the-three-phases">6.4 The Three Phases<a class="header-link" href="#64-the-three-phases" title="Permanent link">&para;</a></h3>
<p>ARIES recovery proceeds in three phases:</p>
<div class="highlight"><pre><span></span><code><span class="nv">Log</span><span class="w"> </span><span class="nv">Timeline</span>:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
â”‚<span class="w">                </span>â”‚<span class="w">              </span>â”‚<span class="w">                    </span>â”‚
â”‚<span class="w">                </span>â”‚<span class="w">              </span>â”‚<span class="w">                    </span>â”‚
â”‚<span class="w">           </span><span class="nv">Begin</span><span class="w"> </span><span class="nv">Checkpoint</span><span class="w">    </span>â”‚<span class="w">              </span><span class="nv">CRASH</span><span class="w"> </span>â”‚
â”‚<span class="w">                </span>â”‚<span class="w">              </span>â”‚<span class="w">                    </span>â”‚
â”‚<span class="w">                </span>â”‚<span class="w">         </span><span class="k">End</span><span class="w"> </span><span class="nv">Checkpoint</span><span class="w">            </span>â”‚
â”‚<span class="w">                </span>â”‚<span class="w">              </span>â”‚<span class="w">                    </span>â”‚
â”‚<span class="w">    </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">    </span>â”‚<span class="w">                                               </span>â”‚
â”‚<span class="w">    </span>â”‚<span class="w">         </span>â†<span class="w"> </span><span class="nv">Phase</span><span class="w"> </span><span class="mi">1</span>:<span class="w"> </span><span class="nv">ANALYSIS</span><span class="w"> </span>â†’<span class="w">                 </span>â”‚
â”‚<span class="w">    </span>â”‚<span class="w">           </span><span class="ss">(</span><span class="nv">scan</span><span class="w"> </span><span class="nv">forward</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">checkpoint</span><span class="ss">)</span><span class="w">      </span>â”‚
â”‚<span class="w">    </span>â”‚<span class="w">                                               </span>â”‚
â”‚<span class="w">    </span>â”‚<span class="w">    </span>â†<span class="w"> </span><span class="nv">Phase</span><span class="w"> </span><span class="mi">2</span>:<span class="w"> </span><span class="nv">REDO</span><span class="w"> </span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’<span class="w">        </span>â”‚
â”‚<span class="w">    </span>â”‚<span class="w">      </span><span class="ss">(</span><span class="nv">from</span><span class="w"> </span><span class="nv">min</span><span class="w"> </span><span class="nv">recLSN</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">DPT</span>,<span class="w"> </span><span class="nv">forward</span><span class="ss">)</span><span class="w">        </span>â”‚
â”‚<span class="w">    </span>â”‚<span class="w">                                               </span>â”‚
â”‚<span class="w">    </span>â”‚<span class="w">    </span>â†<span class="w"> </span><span class="nv">Phase</span><span class="w"> </span><span class="mi">3</span>:<span class="w"> </span><span class="nv">UNDO</span><span class="w"> </span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’<span class="w">        </span>â”‚
â”‚<span class="w">    </span>â”‚<span class="w">      </span><span class="ss">(</span><span class="nv">from</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">log</span>,<span class="w"> </span><span class="nv">backward</span><span class="ss">)</span><span class="w">              </span>â”‚
â”‚<span class="w">    </span>â”‚<span class="w">                                               </span>â”‚
</code></pre></div>

<h3 id="65-phase-1-analysis">6.5 Phase 1: Analysis<a class="header-link" href="#65-phase-1-analysis" title="Permanent link">&para;</a></h3>
<p><strong>Goal</strong>: Determine exactly which transactions were active at crash time and which pages were dirty.</p>
<div class="highlight"><pre><span></span><code><span class="n">ANALYSIS</span><span class="o">-</span><span class="n">PHASE</span><span class="p">()</span><span class="err">:</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">Start</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">most</span><span class="w"> </span><span class="n">recent</span><span class="w"> </span><span class="k">checkpoint</span>
<span class="w">    </span><span class="k">Read</span><span class="w"> </span><span class="o">&lt;</span><span class="n">end_checkpoint</span><span class="w"> </span><span class="n">ATT</span><span class="p">,</span><span class="w"> </span><span class="n">DPT</span><span class="o">&gt;</span>
<span class="w">    </span><span class="k">Initialize</span><span class="w"> </span><span class="n">ATT</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">DPT</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">checkpoint</span><span class="w"> </span><span class="k">data</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="n">forward</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">checkpoint</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nf">log</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="nf">log</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">forward</span><span class="w"> </span><span class="k">order</span><span class="err">:</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T_i</span><span class="p">,</span><span class="w"> </span><span class="k">start</span><span class="o">&gt;</span><span class="err">:</span>
<span class="w">            </span><span class="k">Add</span><span class="w"> </span><span class="n">T_i</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">ATT</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">active</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nl">CLR</span><span class="p">:</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">T_i</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">ATT</span><span class="p">:</span>
<span class="w">                </span><span class="k">Add</span><span class="w"> </span><span class="n">T_i</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">ATT</span>
<span class="w">            </span><span class="n">ATT</span><span class="o">[</span><span class="n">T_i</span><span class="o">]</span><span class="p">.</span><span class="n">LastLSN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">LSN</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">PageID</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">DPT</span><span class="p">:</span>
<span class="w">                </span><span class="k">Add</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">DPT</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">recLSN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">LSN</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T_i</span><span class="p">,</span><span class="w"> </span><span class="k">commit</span><span class="o">&gt;</span><span class="err">:</span>
<span class="w">            </span><span class="n">ATT</span><span class="o">[</span><span class="n">T_i</span><span class="o">]</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">committed</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T_i</span><span class="p">,</span><span class="w"> </span><span class="n">abort</span><span class="o">&gt;</span><span class="err">:</span>
<span class="w">            </span><span class="n">ATT</span><span class="o">[</span><span class="n">T_i</span><span class="o">]</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aborting</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T_i</span><span class="p">,</span><span class="w"> </span><span class="k">end</span><span class="o">&gt;</span><span class="err">:</span>
<span class="w">            </span><span class="n">Remove</span><span class="w"> </span><span class="n">T_i</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">ATT</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">After</span><span class="w"> </span><span class="nl">analysis</span><span class="p">:</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">ATT</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">transactions</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">were</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">crash</span><span class="w"> </span><span class="nc">time</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">DPT</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">pages</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">might</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">dirty</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">crash</span><span class="w"> </span><span class="nc">time</span>
</code></pre></div>

<h3 id="66-phase-2-redo-repeating-history">6.6 Phase 2: Redo (Repeating History)<a class="header-link" href="#66-phase-2-redo-repeating-history" title="Permanent link">&para;</a></h3>
<p><strong>Goal</strong>: Restore the database to the exact state it was in at the moment of the crash. This includes redoing ALL modifications, even those of uncommitted transactions.</p>
<div class="highlight"><pre><span></span><code>REDO-PHASE():
    // Start from the smallest recLSN in the DPT
    start_LSN = min(recLSN for all pages in DPT)

    // Scan forward from start_LSN to end of log
    for each UPDATE or CLR log record with LSN â‰¥ start_LSN:

        // Three conditions to SKIP redo:
        if record.PageID not in DPT:
            skip (page is clean)

        if DPT[record.PageID].recLSN &gt; record.LSN:
            skip (page was already flushed after this update)

        // Read the page from disk
        page = read_page(record.PageID)
        if page.pageLSN â‰¥ record.LSN:
            skip (this update is already reflected on the page)

        // Apply the redo
        Apply the REDO information from the log record to the page
        page.pageLSN = record.LSN

    // After redo:
    // Database is in the exact pre-crash state
    // (including effects of uncommitted transactions)
</code></pre></div>

<p><strong>Why redo uncommitted transactions?</strong>
ARIES "repeats history" to ensure that the undo phase works correctly. The undo phase assumes the database is in the exact pre-crash state, including all effects of all transactions (committed and uncommitted).</p>
<h3 id="67-phase-3-undo">6.7 Phase 3: Undo<a class="header-link" href="#67-phase-3-undo" title="Permanent link">&para;</a></h3>
<p><strong>Goal</strong>: Roll back all transactions that were active at crash time (not committed).</p>
<div class="highlight"><pre><span></span><code><span class="n">UNDO</span><span class="o">-</span><span class="n">PHASE</span><span class="p">()</span><span class="err">:</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">undo</span><span class="w"> </span><span class="nl">list</span><span class="p">:</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">uncommitted</span><span class="w"> </span><span class="n">transactions</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">ATT</span>
<span class="w">    </span><span class="n">undo_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="n">T_i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">ATT</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">committed</span><span class="err">}</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">Collect</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">LastLSN</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="k">transaction</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">undo</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Process</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nf">log</span><span class="w"> </span><span class="n">backward</span>
<span class="w">    </span><span class="n">ToUndo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="n">ATT</span><span class="o">[</span><span class="n">T_i</span><span class="o">]</span><span class="p">.</span><span class="n">LastLSN</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T_i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">undo_list</span><span class="err">}</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="n">ToUndo</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nl">empty</span><span class="p">:</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Pick</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">largest</span><span class="w"> </span><span class="n">LSN</span><span class="w"> </span><span class="p">(</span><span class="n">most</span><span class="w"> </span><span class="n">recent</span><span class="w"> </span><span class="k">operation</span><span class="p">)</span>
<span class="w">        </span><span class="n">lsn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">ToUndo</span><span class="p">)</span>
<span class="w">        </span><span class="n">record</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log_record</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">lsn</span>
<span class="w">        </span><span class="n">T_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">TransID</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="nl">CLR</span><span class="p">:</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">CLRs</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">undone</span><span class="p">;</span><span class="w"> </span><span class="n">follow</span><span class="w"> </span><span class="n">UndoNextLSN</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">UndoNextLSN</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">null</span><span class="err">:</span>
<span class="w">                </span><span class="nf">replace</span><span class="w"> </span><span class="n">lsn</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">ToUndo</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">UndoNextLSN</span>
<span class="w">            </span><span class="k">else</span><span class="err">:</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="ow">All</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">T_i</span><span class="s1">&#39;s updates have been undone</span>
<span class="s1">                Write &lt;T_i, end&gt; to log</span>
<span class="s1">                Remove T_i&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">ToUndo</span>

<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="k">UPDATE</span><span class="err">:</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">Undo</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">update</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="k">Write</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">CLR</span>
<span class="w">            </span><span class="n">CLR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_CLR</span><span class="p">(</span>
<span class="w">                </span><span class="n">TransID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T_i</span><span class="p">,</span>
<span class="w">                </span><span class="n">UndoNextLSN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">PrevLSN</span><span class="p">,</span>
<span class="w">                </span><span class="n">Redo_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;restore to before-image&quot;</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">            </span><span class="k">Write</span><span class="w"> </span><span class="n">CLR</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nf">log</span>

<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="mi">2</span><span class="err">:</span><span class="w"> </span><span class="n">Apply</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">undo</span><span class="w"> </span><span class="p">(</span><span class="k">restore</span><span class="w"> </span><span class="k">before</span><span class="o">-</span><span class="nc">image</span><span class="p">)</span>
<span class="w">            </span><span class="k">Restore</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="k">before</span><span class="o">-</span><span class="nc">image</span><span class="w"> </span><span class="k">value</span>

<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="mi">3</span><span class="err">:</span><span class="w"> </span><span class="n">Follow</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">chain</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">PrevLSN</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">null</span><span class="err">:</span>
<span class="w">                </span><span class="nf">replace</span><span class="w"> </span><span class="n">lsn</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">ToUndo</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">PrevLSN</span>
<span class="w">            </span><span class="k">else</span><span class="err">:</span>
<span class="w">                </span><span class="k">Write</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T_i</span><span class="p">,</span><span class="w"> </span><span class="k">end</span><span class="o">&gt;</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nf">log</span>
<span class="w">                </span><span class="n">Remove</span><span class="w"> </span><span class="n">T_i</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">ToUndo</span>
</code></pre></div>

<h3 id="68-complete-aries-example">6.8 Complete ARIES Example<a class="header-link" href="#68-complete-aries-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Log at time of crash:

LSN  Record                              PrevLSN  UndoNextLSN
â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
10   &lt;Tâ‚, start&gt;                           -
20   &lt;Tâ‚, P5, A: 10â†’20&gt;                   10
30   &lt;Tâ‚‚, start&gt;                           -
40   &lt;Tâ‚‚, P3, B: 30â†’40&gt;                   30
50   &lt;begin_checkpoint&gt;
55   &lt;end_checkpoint ATT={Tâ‚,Tâ‚‚}, DPT={P5:20, P3:40}&gt;
60   &lt;Tâ‚‚, P3, B: 40â†’50&gt;                   40
70   &lt;Tâ‚ƒ, start&gt;                           -
80   &lt;Tâ‚, P5, C: 60â†’70&gt;                   20
90   &lt;Tâ‚ƒ, P8, D: 80â†’90&gt;                   70
100  &lt;Tâ‚, commit&gt;
110  &lt;Tâ‚ƒ, P8, E: 15â†’25&gt;                   90
     â† CRASH

Phase 1: Analysis (scan from LSN 55 to 110)
  LSN 60: Tâ‚‚ update â†’ ATT: Tâ‚‚.LastLSN=60
  LSN 70: Tâ‚ƒ start â†’ ATT adds Tâ‚ƒ
  LSN 80: Tâ‚ update â†’ ATT: Tâ‚.LastLSN=80, DPT: P5.recLSN stays 20
  LSN 90: Tâ‚ƒ update â†’ ATT: Tâ‚ƒ.LastLSN=90, DPT adds P8.recLSN=90
  LSN 100: Tâ‚ commit â†’ ATT: Tâ‚.status=committed
  LSN 110: Tâ‚ƒ update â†’ ATT: Tâ‚ƒ.LastLSN=110

  Result:
    ATT = {Tâ‚(committed, LSN=80), Tâ‚‚(active, LSN=60), Tâ‚ƒ(active, LSN=110)}
    DPT = {P5(recLSN=20), P3(recLSN=40), P8(recLSN=90)}

Phase 2: Redo (from min recLSN = 20)
  LSN 20: P5 in DPT, recLSN=20 â‰¤ 20, check pageLSN â†’ redo if needed
  LSN 40: P3 in DPT, recLSN=40 â‰¤ 40, check pageLSN â†’ redo if needed
  LSN 60: P3 in DPT, recLSN=40 â‰¤ 60, check pageLSN â†’ redo if needed
  LSN 80: P5 in DPT, recLSN=20 â‰¤ 80, check pageLSN â†’ redo if needed
  LSN 90: P8 in DPT, recLSN=90 â‰¤ 90, check pageLSN â†’ redo if needed
  LSN 110: P8 in DPT, recLSN=90 â‰¤ 110, check pageLSN â†’ redo if needed

Phase 3: Undo (uncommitted: Tâ‚‚, Tâ‚ƒ)
  ToUndo = {60 (Tâ‚‚), 110 (Tâ‚ƒ)}

  Step 1: Undo LSN 110 (Tâ‚ƒ, P8, E: 15â†’25)
    Write CLR: &lt;LSN=120, Tâ‚ƒ, CLR, UndoNext=90&gt;
    Restore E to 15
    ToUndo = {60, 90}

  Step 2: Undo LSN 90 (Tâ‚ƒ, P8, D: 80â†’90)
    Write CLR: &lt;LSN=130, Tâ‚ƒ, CLR, UndoNext=70&gt;
    Restore D to 80
    ToUndo = {60, 70}

  Step 3: Undo LSN 70 â†’ it&#39;s &lt;Tâ‚ƒ, start&gt;
    Actually LSN 70 is a start record, so Tâ‚ƒ has no PrevLSN from 70.
    We trace via PrevLSN of LSN 90 â†’ 70 is start.
    Write &lt;Tâ‚ƒ, end&gt;
    ToUndo = {60}

  Step 4: Undo LSN 60 (Tâ‚‚, P3, B: 40â†’50)
    Write CLR: &lt;LSN=140, Tâ‚‚, CLR, UndoNext=40&gt;
    Restore B to 40
    ToUndo = {40}

  Step 5: Undo LSN 40 (Tâ‚‚, P3, B: 30â†’40)
    Write CLR: &lt;LSN=150, Tâ‚‚, CLR, UndoNext=30&gt;
    Restore B to 30
    ToUndo = {30}

  Step 6: LSN 30 is &lt;Tâ‚‚, start&gt;
    Write &lt;Tâ‚‚, end&gt;
    ToUndo = {} â†’ DONE

Final state:
  Tâ‚&#39;s changes persist (committed)
  Tâ‚‚&#39;s changes undone (B restored to 30)
  Tâ‚ƒ&#39;s changes undone (D restored to 80, E restored to 15)
</code></pre></div>

<h3 id="69-crash-during-recovery">6.9 Crash During Recovery<a class="header-link" href="#69-crash-during-recovery" title="Permanent link">&para;</a></h3>
<p>One of ARIES's key strengths is handling <strong>crashes during recovery</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">Scenario</span><span class="o">:</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="n">crashes</span><span class="w"> </span><span class="n">during</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">UNDO</span><span class="w"> </span><span class="n">phase</span>

<span class="n">Original</span><span class="w"> </span><span class="n">crash</span><span class="w"> </span><span class="n">recovery</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">Phase</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">(</span><span class="n">Undo</span><span class="o">):</span>
<span class="w">  </span><span class="n">Undo</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">LSN</span><span class="w"> </span><span class="mi">110</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">wrote</span><span class="w"> </span><span class="n">CLR</span><span class="w"> </span><span class="o">(</span><span class="n">LSN</span><span class="w"> </span><span class="mi">120</span><span class="o">)</span>
<span class="w">  </span><span class="n">Undo</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">LSN</span><span class="w"> </span><span class="mi">90</span><span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">wrote</span><span class="w"> </span><span class="n">CLR</span><span class="w"> </span><span class="o">(</span><span class="n">LSN</span><span class="w"> </span><span class="mi">130</span><span class="o">)</span>
<span class="w">  </span><span class="err">â†</span><span class="w"> </span><span class="n">CRASH</span><span class="w"> </span><span class="n">AGAIN</span>

<span class="n">Second</span><span class="w"> </span><span class="n">recovery</span><span class="o">:</span>
<span class="w">  </span><span class="n">Phase</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">Analysis</span><span class="o">):</span><span class="w"> </span><span class="n">Finds</span><span class="w"> </span><span class="n">Tâ‚‚</span><span class="o">,</span><span class="w"> </span><span class="n">Tâ‚ƒ</span><span class="w"> </span><span class="n">still</span><span class="w"> </span><span class="n">active</span>
<span class="w">  </span><span class="n">Phase</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">Redo</span><span class="o">):</span><span class="w"> </span><span class="n">Redoes</span><span class="w"> </span><span class="n">ALL</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="n">records</span><span class="w"> </span><span class="n">including</span><span class="w"> </span><span class="n">CLRs</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">LSN</span><span class="w"> </span><span class="mi">120</span><span class="o">,</span><span class="w"> </span><span class="mi">130</span>
<span class="w">                  </span><span class="o">(</span><span class="n">This</span><span class="w"> </span><span class="n">re</span><span class="o">-</span><span class="n">applies</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">undo</span><span class="w"> </span><span class="n">operations</span><span class="o">)</span>
<span class="w">  </span><span class="n">Phase</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">(</span><span class="n">Undo</span><span class="o">):</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">Tâ‚ƒ</span><span class="o">,</span><span class="w"> </span><span class="n">follows</span><span class="w"> </span><span class="n">CLR</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">LSN</span><span class="w"> </span><span class="mi">130</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">UndoNextLSN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">70</span>
<span class="w">                   </span><span class="n">Tâ‚ƒ</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">LSNs</span><span class="w"> </span><span class="mi">110</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="mi">90</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">NOT</span><span class="w"> </span><span class="n">undone</span><span class="w"> </span><span class="n">again</span><span class="w"> </span><span class="o">(</span><span class="n">CLRs</span><span class="w"> </span><span class="n">skip</span><span class="w"> </span><span class="n">them</span><span class="o">)</span>

<span class="n">The</span><span class="w"> </span><span class="n">CLR</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="n">ensures</span><span class="w"> </span><span class="n">undo</span><span class="w"> </span><span class="n">operations</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">IDEMPOTENT</span><span class="o">.</span>
<span class="n">No</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">repeated</span><span class="o">,</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">matter</span><span class="w"> </span><span class="n">how</span><span class="w"> </span><span class="n">many</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="n">recovery</span><span class="w"> </span><span class="n">crashes</span><span class="o">.</span>
</code></pre></div>

<hr />
<h2 id="7-shadow-paging">7. Shadow Paging<a class="header-link" href="#7-shadow-paging" title="Permanent link">&para;</a></h2>
<h3 id="71-concept">7.1 Concept<a class="header-link" href="#71-concept" title="Permanent link">&para;</a></h3>
<p><strong>Shadow paging</strong> is an alternative to WAL-based recovery. Instead of logging changes, it maintains two page tables:</p>
<div class="highlight"><pre><span></span><code>Shadow Paging:

Current Page Table:          Shadow Page Table (on disk):
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ 1 â”‚ â†’ P1&#39;â”‚ (modified)      â”‚ 1 â”‚ â†’ P1 â”‚ (original)
â”‚ 2 â”‚ â†’ P2 â”‚ (unchanged)     â”‚ 2 â”‚ â†’ P2 â”‚
â”‚ 3 â”‚ â†’ P3&#39;â”‚ (modified)      â”‚ 3 â”‚ â†’ P3 â”‚ (original)
â”‚ 4 â”‚ â†’ P4 â”‚ (unchanged)     â”‚ 4 â”‚ â†’ P4 â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜

On commit: Replace shadow page table with current page table
On abort:  Discard current page table, revert to shadow
</code></pre></div>

<h3 id="72-shadow-paging-vs-wal">7.2 Shadow Paging vs. WAL<a class="header-link" href="#72-shadow-paging-vs-wal" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Shadow Paging</th>
<th>WAL (ARIES)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Recovery speed</td>
<td>Fast (just use shadow)</td>
<td>Slower (three phases)</td>
</tr>
<tr>
<td>Normal operation</td>
<td>Slower (copy-on-write)</td>
<td>Faster (in-place update)</td>
</tr>
<tr>
<td>Concurrent txns</td>
<td>Difficult to support</td>
<td>Naturally supports</td>
</tr>
<tr>
<td>Fragmentation</td>
<td>High (scattered pages)</td>
<td>Low</td>
</tr>
<tr>
<td>Commit overhead</td>
<td>Atomic page table swap</td>
<td>Log flush</td>
</tr>
<tr>
<td>Used in</td>
<td>SQLite (journal mode), CouchDB</td>
<td>PostgreSQL, MySQL, Oracle, SQL Server</td>
</tr>
</tbody>
</table>
<p>Shadow paging is rarely used in modern multi-user database systems due to poor support for concurrent transactions and page fragmentation.</p>
<hr />
<h2 id="8-buffer-management-policies">8. Buffer Management Policies<a class="header-link" href="#8-buffer-management-policies" title="Permanent link">&para;</a></h2>
<h3 id="81-the-four-combinations">8.1 The Four Combinations<a class="header-link" href="#81-the-four-combinations" title="Permanent link">&para;</a></h3>
<p>Buffer management policies determine when dirty pages are written to disk:</p>
<p><strong>Steal Policy</strong>: Can the buffer manager flush a dirty page belonging to an uncommitted transaction?
- <strong>Steal</strong>: Yes, dirty pages can be flushed at any time (requires UNDO capability)
- <strong>No-Steal</strong>: No, dirty pages of uncommitted transactions stay in the buffer</p>
<p><strong>Force Policy</strong>: Must all dirty pages of a transaction be flushed to disk at commit time?
- <strong>Force</strong>: Yes, flush all dirty pages on commit (no REDO needed after crash)
- <strong>No-Force</strong>: No, dirty pages may be flushed later (requires REDO capability)</p>
<div class="highlight"><pre><span></span><code><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">No</span><span class="o">-</span><span class="nx">Steal</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Steal</span>
<span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nx">Force</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">No</span><span class="w"> </span><span class="nx">undo</span><span class="p">,</span><span class="w"> </span><span class="nx">no</span><span class="w"> </span><span class="nx">redo</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Undo</span><span class="p">,</span><span class="w"> </span><span class="nx">no</span><span class="w"> </span><span class="nx">redo</span>
<span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="nx">simplest</span><span class="w"> </span><span class="nx">recovery</span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="nx">rare</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">practice</span><span class="p">)</span>
<span class="w">           </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">but</span><span class="w"> </span><span class="nx">worst</span><span class="w"> </span><span class="nx">perf</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nx">No</span><span class="o">-</span><span class="nx">Force</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">No</span><span class="w"> </span><span class="nx">undo</span><span class="p">,</span><span class="w"> </span><span class="nx">redo</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Undo</span><span class="w"> </span><span class="nx">AND</span><span class="w"> </span><span class="nx">redo</span>
<span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="nx">deferred</span><span class="w"> </span><span class="nx">mod</span><span class="p">.)</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="nx">ARIES</span><span class="p">,</span><span class="w"> </span><span class="nx">most</span><span class="w"> </span><span class="nx">systems</span><span class="p">)</span>
<span class="w">           </span><span class="err">â”‚</span><span class="w">                   </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â†</span><span class="w"> </span><span class="nx">Best</span><span class="w"> </span><span class="nx">performance</span>
</code></pre></div>

<h3 id="82-why-stealno-force-is-best">8.2 Why Steal/No-Force is Best<a class="header-link" href="#82-why-stealno-force-is-best" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nv">Steal</span><span class="w"> </span><span class="nv">advantage</span>:
<span class="w">  </span><span class="nv">Without</span><span class="w"> </span><span class="nv">steal</span>:<span class="w"> </span><span class="nv">uncommitted</span><span class="w"> </span><span class="nv">transaction</span><span class="err">&#39;s dirty pages MUST stay in buffer</span>
<span class="err">  â†’ Large transactions can exhaust the buffer pool</span>
<span class="err">  â†’ Limits the number of concurrent transactions</span>

<span class="err">  With steal: buffer manager can evict any page as needed</span>
<span class="err">  â†’ Better buffer utilization</span>
<span class="err">  â†’ Supports larger transactions</span>

<span class="err">No-Force advantage:</span>
<span class="err">  Without no-force: ALL dirty pages flushed at commit</span>
<span class="err">  â†’ Very slow commits (especially if many pages modified)</span>
<span class="err">  â†’ Random I/O pattern (scattered dirty pages)</span>

<span class="err">  With no-force: pages flushed lazily by background writer</span>
<span class="err">  â†’ Fast commits (just flush the log)</span>
<span class="err">  â†’ Sequential I/O for the log</span>
<span class="err">  â†’ Pages flushed in batches (more efficient)</span>
</code></pre></div>

<h3 id="83-interaction-with-recovery">8.3 Interaction with Recovery<a class="header-link" href="#83-interaction-with-recovery" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Policy</th>
<th>UNDO needed?</th>
<th>REDO needed?</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Steal</td>
<td>Yes</td>
<td>-</td>
<td>Stolen page may have uncommitted data on disk</td>
</tr>
<tr>
<td>No-Steal</td>
<td>No</td>
<td>-</td>
<td>Uncommitted data never reaches disk</td>
</tr>
<tr>
<td>Force</td>
<td>-</td>
<td>No</td>
<td>All committed data is on disk at commit</td>
</tr>
<tr>
<td>No-Force</td>
<td>-</td>
<td>Yes</td>
<td>Committed data may still be only in buffer</td>
</tr>
</tbody>
</table>
<p>ARIES uses <strong>Steal + No-Force</strong>, which requires both UNDO and REDO capabilities -- but provides the best runtime performance.</p>
<hr />
<h2 id="9-media-recovery-and-backup-strategies">9. Media Recovery and Backup Strategies<a class="header-link" href="#9-media-recovery-and-backup-strategies" title="Permanent link">&para;</a></h2>
<h3 id="91-the-need-for-backups">9.1 The Need for Backups<a class="header-link" href="#91-the-need-for-backups" title="Permanent link">&para;</a></h3>
<p>WAL-based recovery handles transaction failures and system crashes, but NOT media failures (disk destruction). For media recovery, we need <strong>backups</strong>.</p>
<div class="highlight"><pre><span></span><code>Media Recovery:

Time: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
      â”‚         â”‚              â”‚              â”‚
   Full Backup  â”‚          Incremental     Disk Failure
      Bâ‚        â”‚          Backup Bâ‚‚          â†“
                 â”‚              â”‚           Restore Bâ‚
              Log continues     â”‚           Apply Bâ‚‚
                 â”‚              â”‚           Replay log from Bâ‚‚ to failure
                 â”‚              â”‚              â†“
                 â”‚              â”‚           Database recovered!
</code></pre></div>

<h3 id="92-backup-types">9.2 Backup Types<a class="header-link" href="#92-backup-types" title="Permanent link">&para;</a></h3>
<p><strong>Full Backup (Base Backup):</strong>
- Complete copy of the entire database
- Self-contained: can restore from this alone
- Large size, time-consuming
- Typically done weekly or monthly</p>
<p><strong>Incremental Backup:</strong>
- Only pages/blocks changed since the last backup
- Smaller and faster than full backup
- Requires the base backup + all incrementals to restore
- Typically done daily</p>
<p><strong>Continuous Archiving (WAL Archiving):</strong>
- Archive WAL segments as they are completed
- Combined with a base backup, allows <strong>Point-in-Time Recovery (PITR)</strong></p>
<div class="highlight"><pre><span></span><code>PostgreSQL Backup Strategy:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sunday: Full base backup (pg_basebackup)           â”‚
â”‚  Mon-Sat: Continuous WAL archiving                  â”‚
â”‚                                                     â”‚
â”‚  To restore to Wednesday 3:00 PM:                   â”‚
â”‚  1. Restore Sunday&#39;s base backup                    â”‚
â”‚  2. Replay WAL from Sunday to Wed 3:00 PM           â”‚
â”‚  3. Database is at the exact state of Wed 3:00 PM   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="93-postgresql-backup-commands">9.3 PostgreSQL Backup Commands<a class="header-link" href="#93-postgresql-backup-commands" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Full base backup</span>
pg_basebackup<span class="w"> </span>-D<span class="w"> </span>/backup/base<span class="w"> </span>-Ft<span class="w"> </span>-z<span class="w"> </span>-P

<span class="c1"># Configure WAL archiving (in postgresql.conf)</span>
<span class="c1"># archive_mode = on</span>
<span class="c1"># archive_command = &#39;cp %p /backup/wal/%f&#39;</span>

<span class="c1"># Point-in-Time Recovery</span>
<span class="c1"># 1. Stop PostgreSQL</span>
<span class="c1"># 2. Restore base backup to data directory</span>
<span class="c1"># 3. Create recovery.signal file</span>
<span class="c1"># 4. Set restore_command and recovery_target_time in postgresql.conf</span>
<span class="c1"># restore_command = &#39;cp /backup/wal/%f %p&#39;</span>
<span class="c1"># recovery_target_time = &#39;2025-03-15 15:00:00&#39;</span>
<span class="c1"># 5. Start PostgreSQL â†’ automatic recovery to target time</span>
</code></pre></div>

<h3 id="94-logical-vs-physical-backup">9.4 Logical vs. Physical Backup<a class="header-link" href="#94-logical-vs-physical-backup" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Physical Backup (pg_basebackup):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Copies raw data files (binary)             â”‚
â”‚ + Fast backup and restore                  â”‚
â”‚ + Supports PITR with WAL archiving         â”‚
â”‚ - Same PostgreSQL major version required   â”‚
â”‚ - Same architecture (OS, endianness)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Logical Backup (pg_dump):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Exports SQL statements or custom format    â”‚
â”‚ + Version-independent                      â”‚
â”‚ + Can restore to different architecture    â”‚
â”‚ + Can selectively restore tables           â”‚
â”‚ - Slower backup and restore               â”‚
â”‚ - No PITR (point-in-time snapshot only)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="95-backup-best-practices">9.5 Backup Best Practices<a class="header-link" href="#95-backup-best-practices" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">The</span><span class="w"> </span><span class="mh">3</span><span class="o">-</span><span class="mh">2</span><span class="o">-</span><span class="mh">1</span><span class="w"> </span><span class="nl">Rule:</span>
<span class="w">  </span><span class="mh">3</span><span class="w"> </span><span class="n">copies</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">2</span><span class="w"> </span><span class="n">backups</span><span class="p">)</span>
<span class="w">  </span><span class="mh">2</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="n">media</span><span class="w"> </span><span class="p">(</span><span class="n">disk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tape</span><span class="o">/</span><span class="n">cloud</span><span class="p">)</span>
<span class="w">  </span><span class="mh">1</span><span class="w"> </span><span class="n">offsite</span><span class="w"> </span><span class="n">copy</span><span class="w"> </span><span class="p">(</span><span class="n">different</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">location</span><span class="p">)</span>

<span class="n">Additional</span><span class="w"> </span><span class="nl">guidelines:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="n">restores</span><span class="w"> </span><span class="n">regularly</span><span class="w"> </span><span class="p">(</span><span class="n">untested</span><span class="w"> </span><span class="n">backup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">backup</span><span class="p">)</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Monitor</span><span class="w"> </span><span class="n">WAL</span><span class="w"> </span><span class="n">archiving</span><span class="w"> </span><span class="p">(</span><span class="n">gaps</span><span class="w"> </span><span class="n">mean</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">loss</span><span class="w"> </span><span class="n">risk</span><span class="p">)</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Retention</span><span class="w"> </span><span class="nl">policy:</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="n">backups</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">regulatory</span><span class="w"> </span><span class="n">period</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Encrypt</span><span class="w"> </span><span class="n">backups</span><span class="w"> </span><span class="p">(</span><span class="n">especially</span><span class="w"> </span><span class="n">offsite</span><span class="w"> </span><span class="n">ones</span><span class="p">)</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Document</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">recovery</span><span class="w"> </span><span class="n">procedure</span>
</code></pre></div>

<hr />
<h2 id="10-recovery-in-modern-systems">10. Recovery in Modern Systems<a class="header-link" href="#10-recovery-in-modern-systems" title="Permanent link">&para;</a></h2>
<h3 id="101-recovery-and-replication">10.1 Recovery and Replication<a class="header-link" href="#101-recovery-and-replication" title="Permanent link">&para;</a></h3>
<p>Modern systems often combine recovery with <strong>replication</strong> for both durability and high availability:</p>
<div class="highlight"><pre><span></span><code><span class="nv">Synchronous</span><span class="w"> </span><span class="nv">Replication</span>:

<span class="nv">Primary</span><span class="w"> </span>â”€â”€<span class="nv">WAL</span>â”€â”€â†’<span class="w"> </span><span class="nv">Standby</span>
<span class="w">   </span>â”‚<span class="w">                </span>â”‚
<span class="w">   </span>â”‚<span class="w">   </span><span class="nv">Commit</span><span class="w"> </span><span class="nv">only</span><span class="w"> </span><span class="nv">after</span><span class="w"> </span><span class="nv">standby</span>
<span class="w">   </span>â”‚<span class="w">   </span><span class="nv">confirms</span><span class="w"> </span><span class="nv">WAL</span><span class="w"> </span><span class="nv">receipt</span>
<span class="w">   </span>â”‚<span class="w">                </span>â”‚
<span class="w">   </span>â–¼<span class="w">                </span>â–¼
<span class="w"> </span><span class="nv">Data</span><span class="w"> </span><span class="nv">File</span><span class="w">       </span><span class="nv">Data</span><span class="w"> </span><span class="nv">File</span>

<span class="k">If</span><span class="w"> </span><span class="nv">primary</span><span class="w"> </span><span class="nv">fails</span>:
<span class="w">  </span><span class="nv">Standby</span><span class="w"> </span><span class="nv">already</span><span class="w"> </span><span class="nv">has</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">committed</span><span class="w"> </span><span class="nv">WAL</span>
<span class="w">  </span><span class="nv">Promote</span><span class="w"> </span><span class="nv">standby</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">primary</span><span class="w"> </span><span class="ss">(</span><span class="nv">seconds</span><span class="ss">)</span>
<span class="w">  </span><span class="nv">No</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="nv">loss</span><span class="w"> </span><span class="ss">(</span><span class="nv">RPO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="ss">)</span>
</code></pre></div>

<h3 id="102-performance-considerations">10.2 Performance Considerations<a class="header-link" href="#102-performance-considerations" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Recovery Time Components:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Analysis Phase: Fast (scan log once)   â”‚
â”‚ Time: proportional to log since        â”‚
â”‚       last checkpoint                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Redo Phase: Can be slow                â”‚
â”‚ Time: proportional to # of log records â”‚
â”‚       since min(recLSN in DPT)         â”‚
â”‚ Optimization: parallel redo by page    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Undo Phase: Usually fast               â”‚
â”‚ Time: proportional to # of updates     â”‚
â”‚       by uncommitted transactions      â”‚
â”‚ Note: Can be deferred (lazy undo)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

To minimize recovery time:
  - Frequent checkpoints (less to redo)
  - Short transactions (less to undo)
  - Sufficient WAL buffer (fewer forced flushes)
</code></pre></div>

<h3 id="103-parallel-recovery">10.3 Parallel Recovery<a class="header-link" href="#103-parallel-recovery" title="Permanent link">&para;</a></h3>
<p>Modern systems perform redo in parallel:</p>
<div class="highlight"><pre><span></span><code><span class="nv">Parallel</span><span class="w"> </span><span class="nv">Redo</span>:

<span class="nv">Log</span><span class="w"> </span><span class="nv">records</span>:<span class="w"> </span>[<span class="nv">P1</span>,<span class="w"> </span><span class="nv">P3</span>,<span class="w"> </span><span class="nv">P1</span>,<span class="w"> </span><span class="nv">P2</span>,<span class="w"> </span><span class="nv">P3</span>,<span class="w"> </span><span class="nv">P1</span>,<span class="w"> </span><span class="nv">P2</span>,<span class="w"> </span>...]

<span class="nv">Thread</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">(</span><span class="nv">Page</span><span class="w"> </span><span class="nv">P1</span><span class="ss">)</span>:<span class="w"> </span><span class="nv">redo</span><span class="w"> </span>[<span class="nv">LSN1</span>,<span class="w"> </span><span class="nv">LSN3</span>,<span class="w"> </span><span class="nv">LSN6</span>,<span class="w"> </span>...]
<span class="nv">Thread</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="ss">(</span><span class="nv">Page</span><span class="w"> </span><span class="nv">P2</span><span class="ss">)</span>:<span class="w"> </span><span class="nv">redo</span><span class="w"> </span>[<span class="nv">LSN4</span>,<span class="w"> </span><span class="nv">LSN7</span>,<span class="w"> </span>...]
<span class="nv">Thread</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="ss">(</span><span class="nv">Page</span><span class="w"> </span><span class="nv">P3</span><span class="ss">)</span>:<span class="w"> </span><span class="nv">redo</span><span class="w"> </span>[<span class="nv">LSN2</span>,<span class="w"> </span><span class="nv">LSN5</span>,<span class="w"> </span>...]

<span class="nv">Records</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">SAME</span><span class="w"> </span><span class="nv">page</span><span class="w"> </span><span class="nv">must</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">applied</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">order</span>.
<span class="nv">Records</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">DIFFERENT</span><span class="w"> </span><span class="nv">pages</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">applied</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">parallel</span>.
</code></pre></div>

<hr />
<h2 id="11-exercises">11. Exercises<a class="header-link" href="#11-exercises" title="Permanent link">&para;</a></h2>
<h3 id="conceptual-questions">Conceptual Questions<a class="header-link" href="#conceptual-questions" title="Permanent link">&para;</a></h3>
<p><strong>Exercise 1</strong>: Classify each of the following failures and describe the appropriate recovery action:
(a) A transaction divides by zero
(b) A power outage occurs
(c) A disk head crashes, destroying the data disk
(d) A deadlock is detected
(e) The operating system kernel panics</p>
<p><strong>Exercise 2</strong>: Explain the difference between volatile, nonvolatile, and stable storage. Why is "true" stable storage impossible to achieve in practice? How do real systems approximate it?</p>
<p><strong>Exercise 3</strong>: Explain why the WAL (Write-Ahead Logging) protocol requires log records to be flushed to stable storage BEFORE the corresponding data pages. What could go wrong if data pages were flushed first?</p>
<h3 id="log-based-recovery">Log-Based Recovery<a class="header-link" href="#log-based-recovery" title="Permanent link">&para;</a></h3>
<p><strong>Exercise 4</strong>: Given the following log (no checkpoints):</p>
<div class="highlight"><pre><span></span><code>LSN  Record
1    &lt;Tâ‚, start&gt;
2    &lt;Tâ‚, A, 10, 20&gt;
3    &lt;Tâ‚‚, start&gt;
4    &lt;Tâ‚‚, B, 30, 40&gt;
5    &lt;Tâ‚, C, 50, 60&gt;
6    &lt;Tâ‚, commit&gt;
7    &lt;Tâ‚‚, D, 70, 80&gt;
8    &lt;Tâ‚ƒ, start&gt;
9    &lt;Tâ‚ƒ, A, 20, 30&gt;
10   &lt;Tâ‚ƒ, commit&gt;
     â† CRASH
</code></pre></div>

<p>(a) Which transactions must be redone? Which must be undone?
(b) What are the final values of A, B, C, D after recovery?
(c) Show the complete recovery process step by step.</p>
<p><strong>Exercise 5</strong>: Repeat Exercise 4, but with a checkpoint <code>&lt;checkpoint {Tâ‚‚}&gt;</code> inserted between LSN 6 and LSN 7. How does the checkpoint change the recovery process?</p>
<h3 id="aries-algorithm">ARIES Algorithm<a class="header-link" href="#aries-algorithm" title="Permanent link">&para;</a></h3>
<p><strong>Exercise 6</strong>: Given the following log with a fuzzy checkpoint:</p>
<div class="highlight"><pre><span></span><code>LSN  Record                              PrevLSN
10   &lt;Tâ‚, start&gt;                           -
20   &lt;Tâ‚, P1, X: 5â†’10&gt;                    10
30   &lt;Tâ‚‚, start&gt;                           -
40   &lt;Tâ‚‚, P2, Y: 15â†’25&gt;                   30
50   &lt;begin_checkpoint&gt;
55   &lt;end_checkpoint ATT={Tâ‚(20),Tâ‚‚(40)}, DPT={P1:20, P2:40}&gt;
60   &lt;Tâ‚, P3, Z: 35â†’45&gt;                   20
70   &lt;Tâ‚‚, commit&gt;
80   &lt;Tâ‚ƒ, start&gt;                           -
90   &lt;Tâ‚ƒ, P1, X: 10â†’20&gt;                   80
100  &lt;Tâ‚, P2, W: 50â†’60&gt;                   60
     â† CRASH
</code></pre></div>

<p>(a) Perform the Analysis phase. Show the final ATT and DPT.
(b) Determine the starting LSN for the Redo phase.
(c) Perform the Redo phase. List which log records are redone (assume all pages need redo).
(d) Perform the Undo phase. Show all CLRs written and the final ToUndo set at each step.
(e) What are the final values of X, Y, Z, W after recovery?</p>
<p><strong>Exercise 7</strong>: Explain why ARIES "repeats history" during the redo phase (i.e., redoes even uncommitted transactions' updates). Why not skip uncommitted transactions' updates and only redo committed ones?</p>
<p><strong>Exercise 8</strong>: A system crashes during the UNDO phase of ARIES recovery. At the time of the second crash, CLRs have been written for some (but not all) undo operations. Explain step by step what happens during the second recovery attempt. Why is no work repeated?</p>
<h3 id="buffer-management">Buffer Management<a class="header-link" href="#buffer-management" title="Permanent link">&para;</a></h3>
<p><strong>Exercise 9</strong>: For each combination of steal/no-steal and force/no-force policies, explain:
(a) Whether UNDO capability is needed and why
(b) Whether REDO capability is needed and why
(c) The impact on runtime performance (commit latency, buffer utilization)
(d) Name a system or context where this combination is appropriate</p>
<p><strong>Exercise 10</strong>: A transaction T modifies 1000 pages. Under a force policy, all 1000 pages must be flushed to disk at commit time. Under a no-force policy, only the log records (~10 KB) need to be flushed. If each page flush takes 5ms (random I/O) and the log flush takes 2ms (sequential I/O):</p>
<p>(a) Calculate the commit latency under force vs. no-force policies
(b) If the system processes 100 such transactions per second, what is the I/O bandwidth requirement under each policy?
(c) Why do virtually all modern database systems use no-force?</p>
<h3 id="backup-and-media-recovery">Backup and Media Recovery<a class="header-link" href="#backup-and-media-recovery" title="Permanent link">&para;</a></h3>
<p><strong>Exercise 11</strong>: A PostgreSQL database has the following backup schedule:
- Full base backup every Sunday at 2:00 AM
- Continuous WAL archiving</p>
<p>On Wednesday at 4:00 PM, a junior DBA accidentally runs <code>DROP TABLE orders;</code> and commits. The error is discovered at 5:00 PM. Describe the step-by-step Point-in-Time Recovery process to restore the database to Wednesday 3:59 PM (one minute before the DROP TABLE).</p>
<p><strong>Exercise 12</strong>: Compare the recovery time objectives for three failure scenarios in a system with:
- Checkpoints every 5 minutes
- Base backup every week
- WAL archived continuously
- Synchronous standby replica</p>
<p>(a) Transaction failure (single transaction aborted): Estimated recovery time?
(b) System failure (server crashes): Estimated recovery time?
(c) Disk failure (primary data disk destroyed): Estimated recovery time? What is the difference between promoting the standby vs. restoring from backup?</p>
<hr />
<p><strong>Previous</strong>: <a href="./11_Concurrency_Control.md">Concurrency Control</a> | <strong>Next</strong>: <a href="./13_NoSQL_and_NewSQL.md">NoSQL and NewSQL</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Database_Theory/11_Concurrency_Control.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">11. Concurrency Control</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Database_Theory/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Database_Theory/13_NoSQL_Data_Models.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">NoSQL Data Models</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}