{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributed Databases - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Database_Theory/">Database Theory</a>
    <span class="separator">/</span>
    <span class="current">Distributed Databases</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Distributed Databases</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Database_Theory/13_NoSQL_Data_Models.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">NoSQL Data Models</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Database_Theory/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Database_Theory/15_NewSQL_and_Modern_Trends.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">NewSQL and Modern Trends</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-distributed-database-architecture">1. Distributed Database Architecture</a><ul>
<li><a href="#11-shared-nothing-architecture">1.1 Shared-Nothing Architecture</a></li>
<li><a href="#12-shared-disk-architecture">1.2 Shared-Disk Architecture</a></li>
<li><a href="#13-shared-memory-architecture-smp">1.3 Shared-Memory Architecture (SMP)</a></li>
<li><a href="#14-architecture-comparison">1.4 Architecture Comparison</a></li>
</ul>
</li>
<li><a href="#2-data-fragmentation">2. Data Fragmentation</a><ul>
<li><a href="#21-horizontal-fragmentation">2.1 Horizontal Fragmentation</a></li>
<li><a href="#22-vertical-fragmentation">2.2 Vertical Fragmentation</a></li>
<li><a href="#23-hybrid-fragmentation">2.3 Hybrid Fragmentation</a></li>
<li><a href="#24-fragmentation-transparency">2.4 Fragmentation Transparency</a></li>
</ul>
</li>
<li><a href="#3-data-replication">3. Data Replication</a><ul>
<li><a href="#31-replication-topologies">3.1 Replication Topologies</a></li>
<li><a href="#32-synchronous-vs-asynchronous-replication">3.2 Synchronous vs Asynchronous Replication</a></li>
<li><a href="#33-quorum-based-replication">3.3 Quorum-Based Replication</a></li>
<li><a href="#34-conflict-resolution">3.4 Conflict Resolution</a></li>
</ul>
</li>
<li><a href="#4-distributed-query-processing">4. Distributed Query Processing</a><ul>
<li><a href="#41-overview">4.1 Overview</a></li>
<li><a href="#42-query-decomposition">4.2 Query Decomposition</a></li>
<li><a href="#43-cost-factors">4.3 Cost Factors</a></li>
<li><a href="#44-distributed-join-strategies">4.4 Distributed Join Strategies</a></li>
</ul>
</li>
<li><a href="#5-distributed-transactions-two-phase-commit-2pc">5. Distributed Transactions: Two-Phase Commit (2PC)</a><ul>
<li><a href="#51-the-problem">5.1 The Problem</a></li>
<li><a href="#52-two-phase-commit-protocol">5.2 Two-Phase Commit Protocol</a></li>
<li><a href="#53-state-machine">5.3 State Machine</a></li>
<li><a href="#54-failure-analysis">5.4 Failure Analysis</a></li>
<li><a href="#55-optimizations">5.5 Optimizations</a></li>
</ul>
</li>
<li><a href="#6-three-phase-commit-3pc">6. Three-Phase Commit (3PC)</a><ul>
<li><a href="#61-motivation">6.1 Motivation</a></li>
<li><a href="#62-protocol">6.2 Protocol</a></li>
<li><a href="#63-how-3pc-avoids-blocking">6.3 How 3PC Avoids Blocking</a></li>
<li><a href="#64-limitations-of-3pc">6.4 Limitations of 3PC</a></li>
<li><a href="#65-comparison-2pc-vs-3pc">6.5 Comparison: 2PC vs 3PC</a></li>
</ul>
</li>
<li><a href="#7-consensus-algorithms-paxos-and-raft">7. Consensus Algorithms: Paxos and Raft</a><ul>
<li><a href="#71-the-consensus-problem">7.1 The Consensus Problem</a></li>
<li><a href="#72-paxos">7.2 Paxos</a></li>
<li><a href="#73-raft">7.3 Raft</a></li>
<li><a href="#74-paxos-vs-raft">7.4 Paxos vs Raft</a></li>
<li><a href="#75-consensus-in-databases">7.5 Consensus in Databases</a></li>
</ul>
</li>
<li><a href="#8-distributed-concurrency-control">8. Distributed Concurrency Control</a><ul>
<li><a href="#81-challenges">8.1 Challenges</a></li>
<li><a href="#82-distributed-two-phase-locking-d2pl">8.2 Distributed Two-Phase Locking (D2PL)</a></li>
<li><a href="#83-distributed-deadlock-detection">8.3 Distributed Deadlock Detection</a></li>
<li><a href="#84-distributed-timestamp-ordering">8.4 Distributed Timestamp Ordering</a></li>
<li><a href="#85-distributed-mvcc">8.5 Distributed MVCC</a></li>
</ul>
</li>
<li><a href="#9-cap-theorem-implications-for-distributed-design">9. CAP Theorem Implications for Distributed Design</a><ul>
<li><a href="#91-revisiting-cap-in-design-context">9.1 Revisiting CAP in Design Context</a></li>
<li><a href="#92-cp-design-patterns">9.2 CP Design Patterns</a></li>
<li><a href="#93-ap-design-patterns">9.3 AP Design Patterns</a></li>
<li><a href="#94-consistency-level-tuning">9.4 Consistency Level Tuning</a></li>
</ul>
</li>
<li><a href="#10-partitioning-strategies">10. Partitioning Strategies</a><ul>
<li><a href="#101-range-partitioning">10.1 Range Partitioning</a></li>
<li><a href="#102-hash-partitioning">10.2 Hash Partitioning</a></li>
<li><a href="#103-consistent-hashing">10.3 Consistent Hashing</a></li>
<li><a href="#104-partitioning-comparison">10.4 Partitioning Comparison</a></li>
<li><a href="#105-compound-partitioning">10.5 Compound Partitioning</a></li>
</ul>
</li>
<li><a href="#11-exercises">11. Exercises</a><ul>
<li><a href="#exercise-1-architecture-selection">Exercise 1: Architecture Selection</a></li>
<li><a href="#exercise-2-fragmentation-design">Exercise 2: Fragmentation Design</a></li>
<li><a href="#exercise-3-quorum-calculations">Exercise 3: Quorum Calculations</a></li>
<li><a href="#exercise-4-2pc-trace">Exercise 4: 2PC Trace</a></li>
<li><a href="#exercise-5-consensus-scenario">Exercise 5: Consensus Scenario</a></li>
<li><a href="#exercise-6-distributed-deadlock">Exercise 6: Distributed Deadlock</a></li>
<li><a href="#exercise-7-partitioning-strategy">Exercise 7: Partitioning Strategy</a></li>
<li><a href="#exercise-8-consistent-hashing">Exercise 8: Consistent Hashing</a></li>
<li><a href="#exercise-9-replication-conflict-resolution">Exercise 9: Replication Conflict Resolution</a></li>
<li><a href="#exercise-10-distributed-query-optimization">Exercise 10: Distributed Query Optimization</a></li>
</ul>
</li>
<li><a href="#12-references">12. References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="distributed-databases">Distributed Databases<a class="header-link" href="#distributed-databases" title="Permanent link">&para;</a></h1>
<p><strong>Previous</strong>: <a href="./13_NoSQL_Data_Models.md">13. NoSQL Data Models</a> | <strong>Next</strong>: <a href="./15_NewSQL_and_Modern_Trends.md">15. NewSQL and Modern Trends</a></p>
<hr />
<p>Modern applications serve users across the globe, generate massive volumes of data, and must remain available even when hardware fails. A single database server, no matter how powerful, cannot meet all three demands simultaneously. Distributed databases solve this by spreading data and computation across multiple machines. This lesson examines the architectures, algorithms, and tradeoffs that underpin every distributed database system, from data fragmentation and replication to consensus protocols and distributed transactions.</p>
<p><strong>Difficulty</strong>: â­â­â­â­</p>
<p><strong>Learning Objectives</strong>:
- Compare shared-nothing, shared-disk, and shared-memory architectures
- Design horizontal, vertical, and hybrid fragmentation strategies
- Analyze synchronous vs asynchronous replication and quorum-based protocols
- Explain distributed query processing and optimization
- Trace through the Two-Phase Commit (2PC) and Three-Phase Commit (3PC) protocols
- Describe the Paxos and Raft consensus algorithms at a conceptual level
- Apply distributed concurrency control techniques
- Select appropriate partitioning strategies (range, hash, consistent hashing)
- Reason about CAP theorem implications in distributed system design</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-distributed-database-architecture">Distributed Database Architecture</a></li>
<li><a href="#2-data-fragmentation">Data Fragmentation</a></li>
<li><a href="#3-data-replication">Data Replication</a></li>
<li><a href="#4-distributed-query-processing">Distributed Query Processing</a></li>
<li><a href="#5-distributed-transactions-two-phase-commit-2pc">Distributed Transactions: Two-Phase Commit (2PC)</a></li>
<li><a href="#6-three-phase-commit-3pc">Three-Phase Commit (3PC)</a></li>
<li><a href="#7-consensus-algorithms-paxos-and-raft">Consensus Algorithms: Paxos and Raft</a></li>
<li><a href="#8-distributed-concurrency-control">Distributed Concurrency Control</a></li>
<li><a href="#9-cap-theorem-implications-for-distributed-design">CAP Theorem Implications for Distributed Design</a></li>
<li><a href="#10-partitioning-strategies">Partitioning Strategies</a></li>
<li><a href="#11-exercises">Exercises</a></li>
<li><a href="#12-references">References</a></li>
</ol>
<hr />
<h2 id="1-distributed-database-architecture">1. Distributed Database Architecture<a class="header-link" href="#1-distributed-database-architecture" title="Permanent link">&para;</a></h2>
<p>A distributed database is a collection of logically interrelated databases distributed over a computer network. There are three fundamental architectures, distinguished by how they share resources.</p>
<h3 id="11-shared-nothing-architecture">1.1 Shared-Nothing Architecture<a class="header-link" href="#11-shared-nothing-architecture" title="Permanent link">&para;</a></h3>
<p>In a shared-nothing architecture, each node has its own CPU, memory, and storage. Nodes communicate only through the network.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Shared-Nothing Architecture                                â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  Node 1 â”‚    â”‚  Node 2 â”‚    â”‚  Node 3 â”‚                â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚                â”‚
â”‚  â”‚ â”‚ CPU â”‚ â”‚    â”‚ â”‚ CPU â”‚ â”‚    â”‚ â”‚ CPU â”‚ â”‚                â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”¤ â”‚    â”‚ â”œâ”€â”€â”€â”€â”€â”¤ â”‚    â”‚ â”œâ”€â”€â”€â”€â”€â”¤ â”‚                â”‚
â”‚  â”‚ â”‚ RAM â”‚ â”‚    â”‚ â”‚ RAM â”‚ â”‚    â”‚ â”‚ RAM â”‚ â”‚                â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”¤ â”‚    â”‚ â”œâ”€â”€â”€â”€â”€â”¤ â”‚    â”‚ â”œâ”€â”€â”€â”€â”€â”¤ â”‚                â”‚
â”‚  â”‚ â”‚Disk â”‚ â”‚    â”‚ â”‚Disk â”‚ â”‚    â”‚ â”‚Disk â”‚ â”‚                â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â”‚
â”‚       â”‚              â”‚              â”‚                      â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                      â”‚                                      â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚              â”‚   Network     â”‚                              â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>Characteristics</strong>:
- Each node operates independently
- Data is partitioned across nodes
- Scales linearly by adding nodes
- No single point of failure (if designed correctly)
- Network is the bottleneck</p>
<p><strong>Examples</strong>: Cassandra, CockroachDB, Citus (PostgreSQL extension), Google Spanner, TiDB</p>
<p><strong>Advantages</strong>:
- Near-linear horizontal scalability
- No resource contention between nodes
- Cost-effective (commodity hardware)</p>
<p><strong>Disadvantages</strong>:
- Cross-node queries require network communication
- Distributed transactions are expensive
- Rebalancing data when adding/removing nodes is complex</p>
<h3 id="12-shared-disk-architecture">1.2 Shared-Disk Architecture<a class="header-link" href="#12-shared-disk-architecture" title="Permanent link">&para;</a></h3>
<p>In a shared-disk architecture, each node has its own CPU and memory, but all nodes access a shared storage layer (typically a SAN or distributed filesystem).</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Shared-Disk Architecture                                   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  Node 1 â”‚    â”‚  Node 2 â”‚    â”‚  Node 3 â”‚                â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚                â”‚
â”‚  â”‚ â”‚ CPU â”‚ â”‚    â”‚ â”‚ CPU â”‚ â”‚    â”‚ â”‚ CPU â”‚ â”‚                â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”¤ â”‚    â”‚ â”œâ”€â”€â”€â”€â”€â”¤ â”‚    â”‚ â”œâ”€â”€â”€â”€â”€â”¤ â”‚                â”‚
â”‚  â”‚ â”‚ RAM â”‚ â”‚    â”‚ â”‚ RAM â”‚ â”‚    â”‚ â”‚ RAM â”‚ â”‚                â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â”‚
â”‚       â”‚              â”‚              â”‚                      â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                      â”‚                                      â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚              â”‚  Shared Disk  â”‚                              â”‚
â”‚              â”‚   (SAN/NAS)   â”‚                              â”‚
â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                              â”‚
â”‚              â”‚  â”‚  Disk   â”‚  â”‚                              â”‚
â”‚              â”‚  â”‚  Array  â”‚  â”‚                              â”‚
â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                              â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>Characteristics</strong>:
- All nodes see the same data (no partitioning needed for storage)
- Requires distributed lock management (DLM) to coordinate writes
- Storage layer must be highly available and performant
- Adding compute nodes is easy; storage is the scaling bottleneck</p>
<p><strong>Examples</strong>: Oracle RAC, Amazon Aurora, Neon</p>
<p><strong>Advantages</strong>:
- Simpler data management (no partitioning logic)
- Easy to add compute nodes
- Storage layer handles durability and replication</p>
<p><strong>Disadvantages</strong>:
- Shared storage can become a bottleneck
- Distributed lock management adds complexity
- Storage layer is a potential single point of failure (mitigated by redundant SANs)</p>
<h3 id="13-shared-memory-architecture-smp">1.3 Shared-Memory Architecture (SMP)<a class="header-link" href="#13-shared-memory-architecture-smp" title="Permanent link">&para;</a></h3>
<p>In a shared-memory (symmetric multiprocessing) architecture, all processors share the same memory and disk.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Shared-Memory Architecture (SMP)                           â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ CPU1 â”‚  â”‚ CPU2 â”‚  â”‚ CPU3 â”‚  â”‚ CPU4 â”‚                   â”‚
â”‚  â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”˜                   â”‚
â”‚     â”‚         â”‚         â”‚         â”‚                        â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                    â”‚                                        â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚            â”‚  Shared RAM   â”‚                                â”‚
â”‚            â”‚  (Shared Bus) â”‚                                â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                    â”‚                                        â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚            â”‚  Shared Disk  â”‚                                â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>Characteristics</strong>:
- Simplest programming model (all data accessible to all CPUs)
- Limited by memory bus bandwidth
- Cannot scale beyond a single machine's limits
- Not truly "distributed" -- a single large server</p>
<p><strong>Examples</strong>: Traditional enterprise database servers (single-node PostgreSQL, Oracle, SQL Server)</p>
<p><strong>Advantages</strong>:
- Fastest inter-processor communication (shared memory)
- No network overhead for data access
- Simple transaction management</p>
<p><strong>Disadvantages</strong>:
- Vertical scaling only
- Memory bus becomes a bottleneck
- Single point of failure</p>
<h3 id="14-architecture-comparison">1.4 Architecture Comparison<a class="header-link" href="#14-architecture-comparison" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Shared-Nothing</th>
<th>Shared-Disk</th>
<th>Shared-Memory</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Scalability</strong></td>
<td>Excellent (horizontal)</td>
<td>Good (compute) / Limited (storage)</td>
<td>Limited (vertical)</td>
</tr>
<tr>
<td><strong>Complexity</strong></td>
<td>High (partitioning, distributed txns)</td>
<td>Medium (DLM)</td>
<td>Low</td>
</tr>
<tr>
<td><strong>Fault tolerance</strong></td>
<td>High</td>
<td>Medium (depends on storage)</td>
<td>Low</td>
</tr>
<tr>
<td><strong>Cost</strong></td>
<td>Low (commodity HW)</td>
<td>Medium-High (SAN)</td>
<td>High (big servers)</td>
</tr>
<tr>
<td><strong>Network dependency</strong></td>
<td>High</td>
<td>High (for storage)</td>
<td>None</td>
</tr>
<tr>
<td><strong>Data locality</strong></td>
<td>Yes (co-located)</td>
<td>No (network to storage)</td>
<td>Yes (shared memory)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2-data-fragmentation">2. Data Fragmentation<a class="header-link" href="#2-data-fragmentation" title="Permanent link">&para;</a></h2>
<p>Data fragmentation (also called partitioning or sharding) is the process of dividing a relation (table) into smaller pieces and distributing them across nodes.</p>
<h3 id="21-horizontal-fragmentation">2.1 Horizontal Fragmentation<a class="header-link" href="#21-horizontal-fragmentation" title="Permanent link">&para;</a></h3>
<p>Horizontal fragmentation divides a table by rows. Each fragment contains a subset of tuples that satisfy some predicate.</p>
<div class="highlight"><pre><span></span><code>Original Table: employees
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id  â”‚ name   â”‚ department â”‚ salary â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1   â”‚ Alice  â”‚ Engineeringâ”‚ 95000  â”‚
â”‚ 2   â”‚ Bob    â”‚ Marketing  â”‚ 72000  â”‚
â”‚ 3   â”‚ Charlieâ”‚ Engineeringâ”‚ 88000  â”‚
â”‚ 4   â”‚ Diana  â”‚ Marketing  â”‚ 68000  â”‚
â”‚ 5   â”‚ Eve    â”‚ Engineeringâ”‚ 92000  â”‚
â”‚ 6   â”‚ Frank  â”‚ Marketing  â”‚ 75000  â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Horizontal Fragmentation by department:

Fragment 1 (Node A):                Fragment 2 (Node B):
Ïƒ(department=&#39;Engineering&#39;)         Ïƒ(department=&#39;Marketing&#39;)
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ 1   â”‚ Alice  â”‚ Engineeringâ”‚95000 â”‚ â”‚ 2   â”‚ Bob   â”‚ Marketing  â”‚72000 â”‚
â”‚ 3   â”‚ Charlieâ”‚ Engineeringâ”‚88000 â”‚ â”‚ 4   â”‚ Diana â”‚ Marketing  â”‚68000 â”‚
â”‚ 5   â”‚ Eve    â”‚ Engineeringâ”‚92000 â”‚ â”‚ 6   â”‚ Frank â”‚ Marketing  â”‚75000 â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>Correctness conditions</strong>:</p>
<ol>
<li><strong>Completeness</strong>: Every tuple in the original relation must appear in at least one fragment.</li>
<li>
<p><code>R = F1 âˆª F2 âˆª ... âˆª Fn</code></p>
</li>
<li>
<p><strong>Reconstruction</strong>: The original relation must be recoverable from the fragments.</p>
</li>
<li>
<p><code>R = F1 âˆª F2 âˆª ... âˆª Fn</code> (union for horizontal fragmentation)</p>
</li>
<li>
<p><strong>Disjointness</strong> (optional but desirable): Each tuple appears in exactly one fragment. This avoids redundancy.</p>
</li>
<li><code>Fi âˆ© Fj = âˆ…</code> for all <code>i â‰  j</code></li>
</ol>
<p><strong>Types of horizontal fragmentation</strong>:</p>
<ul>
<li><strong>Primary horizontal fragmentation</strong>: Based on predicates on the relation's own attributes.</li>
<li>
<p>Example: <code>Ïƒ(salary &gt; 80000)(employees)</code> and <code>Ïƒ(salary â‰¤ 80000)(employees)</code></p>
</li>
<li>
<p><strong>Derived horizontal fragmentation</strong>: Based on predicates on a related relation.</p>
</li>
<li>Example: Fragment <code>projects</code> based on which department owns them, aligning with the <code>employees</code> fragmentation.</li>
</ul>
<h3 id="22-vertical-fragmentation">2.2 Vertical Fragmentation<a class="header-link" href="#22-vertical-fragmentation" title="Permanent link">&para;</a></h3>
<p>Vertical fragmentation divides a table by columns. Each fragment contains a subset of attributes, plus the primary key (to enable reconstruction).</p>
<div class="highlight"><pre><span></span><code><span class="n">Original</span><span class="w"> </span><span class="n">Table</span><span class="p">:</span><span class="w"> </span><span class="n">employees</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">id</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">name</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">ssn</span><span class="w">         </span><span class="err">â”‚</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="n">Vertical</span><span class="w"> </span><span class="n">Fragmentation</span><span class="p">:</span>

<span class="n">Fragment</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="n">A</span><span class="p">):</span><span class="w">              </span><span class="n">Fragment</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="n">B</span><span class="p">):</span>
<span class="n">Public</span><span class="w"> </span><span class="n">info</span><span class="w">                       </span><span class="n">Sensitive</span><span class="w"> </span><span class="n">info</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">     </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">id</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">name</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">id</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">ssn</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><span class="w">     </span><span class="err">â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">1</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Alice</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Engineering</span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">1</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">95000</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">123</span><span class="o">-</span><span class="mi">45</span><span class="o">-</span><span class="mi">6789</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">2</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Bob</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Marketing</span><span class="w">  </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">2</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">72000</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">234</span><span class="o">-</span><span class="mi">56</span><span class="o">-</span><span class="mi">7890</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="o">...</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="o">...</span><span class="w">        </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="o">...</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="o">...</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">     </span><span class="err">â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="n">Reconstruction</span><span class="p">:</span><span class="w"> </span><span class="err">Ï€</span><span class="n">_</span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">department</span><span class="p">}(</span><span class="n">F1</span><span class="p">)</span><span class="w"> </span><span class="err">â‹ˆ</span><span class="w"> </span><span class="err">Ï€</span><span class="n">_</span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="n">salary</span><span class="p">,</span><span class="n">ssn</span><span class="p">}(</span><span class="n">F2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span>
</code></pre></div>

<p><strong>Correctness conditions</strong>:
1. <strong>Completeness</strong>: Every attribute appears in at least one fragment.
2. <strong>Reconstruction</strong>: <code>R = F1 â‹ˆ F2 â‹ˆ ... â‹ˆ Fn</code> (natural join on primary key).
3. <strong>Disjointness</strong>: Attributes (other than the primary key) do not overlap.</p>
<p><strong>Use cases</strong>:
- <strong>Security</strong>: Sensitive columns (salary, SSN) on a separate, more secure node
- <strong>Performance</strong>: Frequently accessed columns together; rarely accessed columns separate
- <strong>Mixed workloads</strong>: OLTP queries access a few columns; OLAP queries access many columns</p>
<h3 id="23-hybrid-fragmentation">2.3 Hybrid Fragmentation<a class="header-link" href="#23-hybrid-fragmentation" title="Permanent link">&para;</a></h3>
<p>Hybrid fragmentation combines horizontal and vertical fragmentation. First fragment vertically, then horizontally (or vice versa).</p>
<div class="highlight"><pre><span></span><code>Step 1: Vertical fragmentation
   R â†’ V1(id, name, dept) + V2(id, salary, ssn)

Step 2: Horizontal fragmentation of V1
   V1 â†’ H1(dept=&#39;Eng&#39;) + H2(dept=&#39;Mktg&#39;)

Result: 3 fragments
   F1 = H1 (id, name, dept) where dept=&#39;Eng&#39;     â†’ Node A
   F2 = H2 (id, name, dept) where dept=&#39;Mktg&#39;    â†’ Node B
   F3 = V2 (id, salary, ssn)                      â†’ Node C (secure)
</code></pre></div>

<h3 id="24-fragmentation-transparency">2.4 Fragmentation Transparency<a class="header-link" href="#24-fragmentation-transparency" title="Permanent link">&para;</a></h3>
<p>Ideally, the distributed database provides <strong>fragmentation transparency</strong>: users write queries against the global schema, and the system automatically routes subqueries to the appropriate fragments.</p>
<div class="highlight"><pre><span></span><code>Transparency Levels:

Level 1: Fragmentation Transparency
  User sees: &quot;SELECT <span class="gs">* FROM employees WHERE dept = &#39;Engineering&#39;&quot;</span>
<span class="gs">  System handles: routing to the correct fragment(s)</span>

<span class="gs">Level 2: Location Transparency</span>
<span class="gs">  User knows fragments exist but not where they are stored</span>
<span class="gs">  User writes: &quot;SELECT *</span> FROM employees_eng&quot;
  System handles: finding the node that stores employees_eng

Level 3: No Transparency
  User must specify both fragment and location
  &quot;SELECT * FROM node_a.employees_eng&quot;
</code></pre></div>

<hr />
<h2 id="3-data-replication">3. Data Replication<a class="header-link" href="#3-data-replication" title="Permanent link">&para;</a></h2>
<p>Replication maintains copies of data at multiple nodes to improve availability, fault tolerance, and read performance.</p>
<h3 id="31-replication-topologies">3.1 Replication Topologies<a class="header-link" href="#31-replication-topologies" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Single</span><span class="o">-</span><span class="n">Leader</span><span class="w"> </span><span class="p">(</span><span class="n">Master</span><span class="o">-</span><span class="n">Slave</span><span class="p">)</span><span class="err">:</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">     </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Leader</span><span class="w">   </span><span class="err">â”‚â”€â”€â”€â”€â–¶â”‚</span><span class="w"> </span><span class="n">Follower</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="n">writes</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">leader</span><span class="p">,</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="n">R</span><span class="o">/</span><span class="n">W</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="k">Read</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="k">reads</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">followers</span><span class="p">)</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">     </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">     </span><span class="err">â”‚</span>
<span class="w">     </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">                 </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Follower</span><span class="w"> </span><span class="err">â”‚</span>
<span class="w">                 </span><span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="k">Read</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span>
<span class="w">                 </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="n">Multi</span><span class="o">-</span><span class="nl">Leader</span><span class="p">:</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â—€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="p">(</span><span class="n">writes</span><span class="w"> </span><span class="n">accepted</span><span class="w"> </span><span class="k">at</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Leader</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Leader</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">â”‚</span><span class="w">   </span><span class="ow">any</span><span class="w"> </span><span class="n">leader</span><span class="p">,</span><span class="w"> </span><span class="n">replicated</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="n">R</span><span class="o">/</span><span class="n">W</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="n">R</span><span class="o">/</span><span class="n">W</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="n">bidirectionally</span><span class="p">)</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">     </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="nl">Leaderless</span><span class="p">:</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">     </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="p">(</span><span class="n">writes</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="ow">all</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="err">â”‚â—€â”€â”€â”€â–¶â”‚</span><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="n">replicas</span><span class="p">;</span><span class="w"> </span><span class="k">reads</span><span class="w"> </span><span class="k">from</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="n">R</span><span class="o">/</span><span class="n">W</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="n">R</span><span class="o">/</span><span class="n">W</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="n">multiple</span><span class="w"> </span><span class="n">replicas</span><span class="p">)</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">     </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">     </span><span class="err">â–²</span><span class="w">                </span><span class="err">â–²</span>
<span class="w">     </span><span class="err">â”‚</span><span class="w">                </span><span class="err">â”‚</span>
<span class="w">     </span><span class="err">â””â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚</span>
<span class="w">          </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="mi">3</span><span class="w">  </span><span class="err">â”‚â”˜</span>
<span class="w">          </span><span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="n">R</span><span class="o">/</span><span class="n">W</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="w">          </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="32-synchronous-vs-asynchronous-replication">3.2 Synchronous vs Asynchronous Replication<a class="header-link" href="#32-synchronous-vs-asynchronous-replication" title="Permanent link">&para;</a></h3>
<p><strong>Synchronous replication</strong>: The leader waits for all (or a defined subset of) followers to acknowledge the write before confirming it to the client.</p>
<div class="highlight"><pre><span></span><code><span class="nv">Client</span><span class="w">        </span><span class="nv">Leader</span><span class="w">        </span><span class="nv">Follower</span><span class="w"> </span><span class="mi">1</span><span class="w">     </span><span class="nv">Follower</span><span class="w"> </span><span class="mi">2</span>
<span class="w">  </span>â”‚<span class="w">             </span>â”‚<span class="w">               </span>â”‚<span class="w">              </span>â”‚
<span class="w">  </span>â”‚â”€â”€<span class="nv">WRITE</span>â”€â”€â–¶<span class="w">  </span>â”‚<span class="w">               </span>â”‚<span class="w">              </span>â”‚
<span class="w">  </span>â”‚<span class="w">             </span>â”‚â”€â”€<span class="nv">replicate</span>â”€â”€â–¶â”‚<span class="w">              </span>â”‚
<span class="w">  </span>â”‚<span class="w">             </span>â”‚â”€â”€<span class="nv">replicate</span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
<span class="w">  </span>â”‚<span class="w">             </span>â”‚<span class="w">               </span>â”‚<span class="w">              </span>â”‚
<span class="w">  </span>â”‚<span class="w">             </span>â”‚â—€â”€â”€<span class="nv">ACK</span>â”€â”€â”€â”€â”€â”€â”€â”€â”‚<span class="w">              </span>â”‚
<span class="w">  </span>â”‚<span class="w">             </span>â”‚â—€â”€â”€<span class="nv">ACK</span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
<span class="w">  </span>â”‚â—€â”€â”€<span class="nv">OK</span>â”€â”€â”€â”€â”€â”€â”€â”‚<span class="w">               </span>â”‚<span class="w">              </span>â”‚
<span class="w">  </span>â”‚<span class="w">             </span>â”‚<span class="w">               </span>â”‚<span class="w">              </span>â”‚

<span class="nv">Timeline</span>:<span class="w"> </span><span class="nv">Client</span><span class="w"> </span><span class="nv">waits</span><span class="w"> </span><span class="k">until</span><span class="w"> </span><span class="nv">ALL</span><span class="w"> </span><span class="nv">followers</span><span class="w"> </span><span class="nv">acknowledge</span>
<span class="nv">Guarantee</span>:<span class="w"> </span><span class="nv">After</span><span class="w"> </span><span class="nv">OK</span>,<span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">durable</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">replicas</span>
<span class="nv">Risk</span>:<span class="w"> </span><span class="nv">One</span><span class="w"> </span><span class="nv">slow</span><span class="w"> </span><span class="nv">follower</span><span class="w"> </span><span class="nv">blocks</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">entire</span><span class="w"> </span><span class="nv">write</span>
</code></pre></div>

<p><strong>Asynchronous replication</strong>: The leader confirms the write to the client immediately, then replicates in the background.</p>
<div class="highlight"><pre><span></span><code>Client        Leader        Follower 1     Follower 2
  â”‚             â”‚               â”‚              â”‚
  â”‚â”€â”€WRITEâ”€â”€â–¶  â”‚               â”‚              â”‚
  â”‚â—€â”€â”€OKâ”€â”€â”€â”€â”€â”€â”€â”‚               â”‚              â”‚
  â”‚             â”‚               â”‚              â”‚
  â”‚             â”‚â”€â”€replicateâ”€â”€â–¶â”‚              â”‚  (background)
  â”‚             â”‚â”€â”€replicateâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  (background)
  â”‚             â”‚               â”‚              â”‚
  â”‚             â”‚â—€â”€â”€ACKâ”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
  â”‚             â”‚â—€â”€â”€ACKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚

Timeline: Client gets OK immediately
Guarantee: Data is durable on leader only at OK time
Risk: Leader crash before replication â†’ DATA LOSS
</code></pre></div>

<p><strong>Semi-synchronous replication</strong>: The leader waits for at least one follower to acknowledge (used by MySQL semi-sync, PostgreSQL synchronous_standby_names).</p>
<div class="highlight"><pre><span></span><code><span class="nv">Client</span><span class="w">        </span><span class="nv">Leader</span><span class="w">        </span><span class="nv">Follower</span><span class="w"> </span><span class="mi">1</span><span class="w">     </span><span class="nv">Follower</span><span class="w"> </span><span class="mi">2</span>
<span class="w">  </span>â”‚<span class="w">             </span>â”‚<span class="w">               </span>â”‚<span class="w">              </span>â”‚
<span class="w">  </span>â”‚â”€â”€<span class="nv">WRITE</span>â”€â”€â–¶<span class="w">  </span>â”‚<span class="w">               </span>â”‚<span class="w">              </span>â”‚
<span class="w">  </span>â”‚<span class="w">             </span>â”‚â”€â”€<span class="nv">replicate</span>â”€â”€â–¶â”‚<span class="w">              </span>â”‚
<span class="w">  </span>â”‚<span class="w">             </span>â”‚â”€â”€<span class="nv">replicate</span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
<span class="w">  </span>â”‚<span class="w">             </span>â”‚â—€â”€â”€<span class="nv">ACK</span>â”€â”€â”€â”€â”€â”€â”€â”€â”‚<span class="w">              </span>â”‚
<span class="w">  </span>â”‚â—€â”€â”€<span class="nv">OK</span>â”€â”€â”€â”€â”€â”€â”€â”‚<span class="w">               </span>â”‚<span class="w">              </span>â”‚<span class="w">  </span><span class="ss">(</span><span class="nv">F2</span><span class="w"> </span><span class="nv">ACK</span><span class="w"> </span><span class="nv">arrives</span><span class="w"> </span><span class="nv">later</span><span class="ss">)</span>
<span class="w">  </span>â”‚<span class="w">             </span>â”‚â—€â”€â”€<span class="nv">ACK</span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚

<span class="nv">Timeline</span>:<span class="w"> </span><span class="nv">Client</span><span class="w"> </span><span class="nv">waits</span><span class="w"> </span><span class="k">until</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">least</span><span class="w"> </span><span class="nv">ONE</span><span class="w"> </span><span class="nv">follower</span><span class="w"> </span><span class="nv">acknowledges</span>
<span class="nv">Guarantee</span>:<span class="w"> </span><span class="nv">Data</span><span class="w"> </span><span class="nv">survives</span><span class="w"> </span><span class="nv">leader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">one</span><span class="w"> </span><span class="nv">follower</span><span class="w"> </span><span class="nv">failure</span>
<span class="nv">Balance</span>:<span class="w"> </span><span class="nv">Faster</span><span class="w"> </span><span class="nv">than</span><span class="w"> </span><span class="nv">full</span><span class="o">-</span><span class="nv">sync</span>,<span class="w"> </span><span class="nv">safer</span><span class="w"> </span><span class="nv">than</span><span class="w"> </span><span class="nv">async</span>
</code></pre></div>

<h3 id="33-quorum-based-replication">3.3 Quorum-Based Replication<a class="header-link" href="#33-quorum-based-replication" title="Permanent link">&para;</a></h3>
<p>Quorum protocols generalize the synchronous/asynchronous tradeoff.</p>
<p>Given N replicas, define:
- <strong>W</strong> = number of replicas that must acknowledge a write (write quorum)
- <strong>R</strong> = number of replicas that must respond to a read (read quorum)</p>
<p><strong>Strong consistency condition</strong>: <code>W + R &gt; N</code></p>
<p>This ensures that every read quorum overlaps with every write quorum, so at least one replica in the read set has the latest value.</p>
<div class="highlight"><pre><span></span><code><span class="n">Example</span><span class="o">:</span><span class="w"> </span><span class="n">N</span><span class="o">=</span><span class="mi">3</span><span class="o">,</span><span class="w"> </span><span class="n">W</span><span class="o">=</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="n">R</span><span class="o">=</span><span class="mi">2</span>

<span class="n">Write</span><span class="w"> </span><span class="n">quorum</span><span class="w"> </span><span class="o">(</span><span class="n">W</span><span class="o">=</span><span class="mi">2</span><span class="o">):</span><span class="w">     </span><span class="n">Read</span><span class="w"> </span><span class="n">quorum</span><span class="w"> </span><span class="o">(</span><span class="n">R</span><span class="o">=</span><span class="mi">2</span><span class="o">):</span>
<span class="n">Must</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">3</span><span class="w">    </span><span class="n">Must</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">3</span>

<span class="w">   </span><span class="n">N1</span><span class="w"> </span><span class="err">âœ“</span><span class="w">                    </span><span class="n">N1</span><span class="w"> </span><span class="err">âœ“</span>
<span class="w">   </span><span class="n">N2</span><span class="w"> </span><span class="err">âœ“</span><span class="w">                    </span><span class="n">N2</span><span class="w"> </span><span class="err">âœ“</span>
<span class="w">   </span><span class="n">N3</span><span class="w"> </span><span class="o">(</span><span class="n">optional</span><span class="o">)</span><span class="w">           </span><span class="n">N3</span><span class="w"> </span><span class="o">(</span><span class="n">optional</span><span class="o">)</span>

<span class="n">Overlap</span><span class="o">:</span><span class="w"> </span><span class="n">At</span><span class="w"> </span><span class="n">least</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">(</span><span class="n">N1</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">N2</span><span class="o">)</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">latest</span><span class="w"> </span><span class="n">write</span><span class="o">.</span>
<span class="n">The</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">picks</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">highest</span><span class="w"> </span><span class="n">timestamp</span><span class="o">/</span><span class="n">version</span><span class="o">.</span>
</code></pre></div>

<p><strong>Common configurations</strong>:</p>
<table>
<thead>
<tr>
<th>N</th>
<th>W</th>
<th>R</th>
<th>W+R &gt; N?</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
<td>3</td>
<td>1</td>
<td>4 &gt; 3 âœ“</td>
<td>Strong reads, slow writes</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>3</td>
<td>4 &gt; 3 âœ“</td>
<td>Fast writes, slow reads</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>2</td>
<td>4 &gt; 3 âœ“</td>
<td>Balanced (most common)</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>1</td>
<td>2 &gt; 3 âœ—</td>
<td>Eventual consistency (fast but potentially stale)</td>
</tr>
<tr>
<td>5</td>
<td>3</td>
<td>3</td>
<td>6 &gt; 5 âœ“</td>
<td>Higher availability (tolerates 2 failures)</td>
</tr>
</tbody>
</table>
<p><strong>Sloppy quorums and hinted handoff</strong>:</p>
<p>When some replicas are unreachable, a sloppy quorum allows writes to be accepted by other nodes (not the designated replicas) and stored as "hints." When the original replicas recover, the hints are forwarded to them. This improves availability at the cost of potential consistency violations.</p>
<h3 id="34-conflict-resolution">3.4 Conflict Resolution<a class="header-link" href="#34-conflict-resolution" title="Permanent link">&para;</a></h3>
<p>In multi-leader and leaderless systems, concurrent writes to the same key can create conflicts.</p>
<p><strong>Conflict resolution strategies</strong>:</p>
<table>
<thead>
<tr>
<th>Strategy</th>
<th>Description</th>
<th>Used By</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Last-Writer-Wins (LWW)</strong></td>
<td>The write with the highest timestamp wins; others are discarded</td>
<td>Cassandra, DynamoDB</td>
</tr>
<tr>
<td><strong>Version Vectors</strong></td>
<td>Track causal history; detect true conflicts (concurrent writes)</td>
<td>Riak, Dynamo</td>
</tr>
<tr>
<td><strong>CRDTs</strong></td>
<td>Data structures that merge automatically without conflicts (Conflict-free Replicated Data Types)</td>
<td>Riak, Redis (CRDT module)</td>
</tr>
<tr>
<td><strong>Application-level</strong></td>
<td>Return all conflicting versions to the application; let it decide</td>
<td>CouchDB, DynamoDB (optional)</td>
</tr>
<tr>
<td><strong>Operational Transform</strong></td>
<td>Transform concurrent operations to maintain consistency (used in collaborative editing)</td>
<td>Google Docs</td>
</tr>
</tbody>
</table>
<p><strong>Example: Version Vectors</strong></p>
<div class="highlight"><pre><span></span><code><span class="nv">Node</span><span class="w"> </span><span class="nv">A</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">Node</span><span class="w"> </span><span class="nv">B</span><span class="w"> </span><span class="nv">both</span><span class="w"> </span><span class="nv">hold</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="s2">&quot;cart&quot;</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span>[<span class="s2">&quot;item1&quot;</span>]

<span class="mi">1</span>.<span class="w"> </span><span class="nv">User</span><span class="w"> </span><span class="nv">writes</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">Node</span><span class="w"> </span><span class="nv">A</span>:<span class="w"> </span><span class="nv">cart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>[<span class="s2">&quot;item1&quot;</span>,<span class="w"> </span><span class="s2">&quot;item2&quot;</span>]
<span class="w">   </span><span class="nv">Version</span>:<span class="w"> </span>{<span class="nv">A</span>:<span class="mi">1</span>}

<span class="mi">2</span>.<span class="w"> </span><span class="nv">User</span><span class="w"> </span><span class="nv">writes</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">Node</span><span class="w"> </span><span class="nv">B</span>:<span class="w"> </span><span class="nv">cart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>[<span class="s2">&quot;item1&quot;</span>,<span class="w"> </span><span class="s2">&quot;item3&quot;</span>]
<span class="w">   </span><span class="nv">Version</span>:<span class="w"> </span>{<span class="nv">B</span>:<span class="mi">1</span>}

<span class="mi">3</span>.<span class="w"> </span><span class="nv">Node</span><span class="w"> </span><span class="nv">A</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">B</span><span class="w"> </span><span class="nv">sync</span>:
<span class="w">   </span><span class="nv">A</span><span class="w"> </span><span class="nv">has</span><span class="w"> </span>{<span class="nv">A</span>:<span class="mi">1</span>},<span class="w"> </span><span class="nv">B</span><span class="w"> </span><span class="nv">has</span><span class="w"> </span>{<span class="nv">B</span>:<span class="mi">1</span>}
<span class="w">   </span><span class="nv">Neither</span><span class="w"> </span><span class="nv">dominates</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">CONFLICT</span><span class="w"> </span><span class="nv">detected</span>

<span class="w">   </span><span class="nv">Resolution</span><span class="w"> </span><span class="nv">options</span>:
<span class="w">   </span><span class="nv">a</span>.<span class="w"> </span><span class="nv">Merge</span>:<span class="w"> </span><span class="nv">cart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>[<span class="s2">&quot;item1&quot;</span>,<span class="w"> </span><span class="s2">&quot;item2&quot;</span>,<span class="w"> </span><span class="s2">&quot;item3&quot;</span>]<span class="w">  </span><span class="ss">(</span><span class="nv">union</span><span class="ss">)</span>
<span class="w">   </span><span class="nv">b</span>.<span class="w"> </span><span class="nv">Present</span><span class="w"> </span><span class="nv">both</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">user</span>:<span class="w"> </span><span class="s2">&quot;Which cart do you want?&quot;</span>
<span class="w">   </span><span class="nv">c</span>.<span class="w"> </span><span class="nv">LWW</span>:<span class="w"> </span><span class="nv">pick</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">one</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">higher</span><span class="w"> </span><span class="nv">timestamp</span><span class="w"> </span><span class="ss">(</span><span class="nv">loses</span><span class="w"> </span><span class="nv">one</span><span class="w"> </span><span class="nv">write</span><span class="ss">)</span>
</code></pre></div>

<hr />
<h2 id="4-distributed-query-processing">4. Distributed Query Processing<a class="header-link" href="#4-distributed-query-processing" title="Permanent link">&para;</a></h2>
<h3 id="41-overview">4.1 Overview<a class="header-link" href="#41-overview" title="Permanent link">&para;</a></h3>
<p>When data is fragmented across nodes, a query may need to access data from multiple nodes. The distributed query processor must:</p>
<ol>
<li><strong>Decompose</strong> the global query into subqueries for each fragment</li>
<li><strong>Optimize</strong> the execution plan to minimize data transfer</li>
<li><strong>Execute</strong> subqueries in parallel where possible</li>
<li><strong>Assemble</strong> the final result</li>
</ol>
<h3 id="42-query-decomposition">4.2 Query Decomposition<a class="header-link" href="#42-query-decomposition" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nt">Global</span><span class="w"> </span><span class="nt">query</span><span class="o">:</span>
<span class="w">  </span><span class="nt">SELECT</span><span class="w"> </span><span class="nt">e</span><span class="p">.</span><span class="nc">name</span><span class="o">,</span><span class="w"> </span><span class="nt">d</span><span class="p">.</span><span class="nc">dept_name</span>
<span class="w">  </span><span class="nt">FROM</span><span class="w"> </span><span class="nt">employees</span><span class="w"> </span><span class="nt">e</span><span class="w"> </span><span class="nt">JOIN</span><span class="w"> </span><span class="nt">departments</span><span class="w"> </span><span class="nt">d</span><span class="w"> </span><span class="nt">ON</span><span class="w"> </span><span class="nt">e</span><span class="p">.</span><span class="nc">dept_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">d</span><span class="p">.</span><span class="nc">id</span>
<span class="w">  </span><span class="nt">WHERE</span><span class="w"> </span><span class="nt">e</span><span class="p">.</span><span class="nc">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nt">80000</span><span class="o">;</span>

<span class="nt">Assume</span><span class="o">:</span>
<span class="w">  </span><span class="nt">-</span><span class="w"> </span><span class="nt">employees</span><span class="w"> </span><span class="nt">is</span><span class="w"> </span><span class="nt">horizontally</span><span class="w"> </span><span class="nt">fragmented</span><span class="w"> </span><span class="nt">by</span><span class="w"> </span><span class="nt">dept_id</span><span class="w"> </span><span class="nt">across</span><span class="w"> </span><span class="nt">Node</span><span class="w"> </span><span class="nt">A</span><span class="w"> </span><span class="nt">and</span><span class="w"> </span><span class="nt">Node</span><span class="w"> </span><span class="nt">B</span>
<span class="w">  </span><span class="nt">-</span><span class="w"> </span><span class="nt">departments</span><span class="w"> </span><span class="nt">is</span><span class="w"> </span><span class="nt">replicated</span><span class="w"> </span><span class="nt">on</span><span class="w"> </span><span class="nt">all</span><span class="w"> </span><span class="nt">nodes</span>

<span class="nt">Decomposition</span><span class="o">:</span>

<span class="nt">Node</span><span class="w"> </span><span class="nt">A</span><span class="w"> </span><span class="o">(</span><span class="nt">dept_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">1</span><span class="o">.</span><span class="p">.</span><span class="nc">50</span><span class="o">):</span>
<span class="w">  </span><span class="nt">SELECT</span><span class="w"> </span><span class="nt">e</span><span class="p">.</span><span class="nc">name</span><span class="o">,</span><span class="w"> </span><span class="nt">d</span><span class="p">.</span><span class="nc">dept_name</span>
<span class="w">  </span><span class="nt">FROM</span><span class="w"> </span><span class="nt">employees_frag_A</span><span class="w"> </span><span class="nt">e</span><span class="w"> </span><span class="nt">JOIN</span><span class="w"> </span><span class="nt">departments</span><span class="w"> </span><span class="nt">d</span><span class="w"> </span><span class="nt">ON</span><span class="w"> </span><span class="nt">e</span><span class="p">.</span><span class="nc">dept_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">d</span><span class="p">.</span><span class="nc">id</span>
<span class="w">  </span><span class="nt">WHERE</span><span class="w"> </span><span class="nt">e</span><span class="p">.</span><span class="nc">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nt">80000</span><span class="o">;</span>

<span class="nt">Node</span><span class="w"> </span><span class="nt">B</span><span class="w"> </span><span class="o">(</span><span class="nt">dept_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">51</span><span class="o">.</span><span class="p">.</span><span class="nc">100</span><span class="o">):</span>
<span class="w">  </span><span class="nt">SELECT</span><span class="w"> </span><span class="nt">e</span><span class="p">.</span><span class="nc">name</span><span class="o">,</span><span class="w"> </span><span class="nt">d</span><span class="p">.</span><span class="nc">dept_name</span>
<span class="w">  </span><span class="nt">FROM</span><span class="w"> </span><span class="nt">employees_frag_B</span><span class="w"> </span><span class="nt">e</span><span class="w"> </span><span class="nt">JOIN</span><span class="w"> </span><span class="nt">departments</span><span class="w"> </span><span class="nt">d</span><span class="w"> </span><span class="nt">ON</span><span class="w"> </span><span class="nt">e</span><span class="p">.</span><span class="nc">dept_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">d</span><span class="p">.</span><span class="nc">id</span>
<span class="w">  </span><span class="nt">WHERE</span><span class="w"> </span><span class="nt">e</span><span class="p">.</span><span class="nc">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nt">80000</span><span class="o">;</span>

<span class="nt">Coordinator</span><span class="o">:</span>
<span class="w">  </span><span class="nt">UNION</span><span class="w"> </span><span class="nt">ALL</span><span class="w"> </span><span class="nt">results</span><span class="w"> </span><span class="nt">from</span><span class="w"> </span><span class="nt">Node</span><span class="w"> </span><span class="nt">A</span><span class="w"> </span><span class="nt">and</span><span class="w"> </span><span class="nt">Node</span><span class="w"> </span><span class="nt">B</span>
</code></pre></div>

<h3 id="43-cost-factors">4.3 Cost Factors<a class="header-link" href="#43-cost-factors" title="Permanent link">&para;</a></h3>
<p>The dominant cost in distributed query processing is <strong>data transfer</strong> over the network. Local I/O and CPU costs are secondary.</p>
<div class="highlight"><pre><span></span><code>Cost model:
  Total Cost = Î£(Local I/O cost at each node)
             + Î£(CPU cost at each node)
             + Î£(Network transfer cost)
               â†‘
               This dominates!
</code></pre></div>

<p><strong>Optimization strategies</strong> to minimize data transfer:</p>
<ol>
<li>
<p><strong>Push selections and projections down</strong>: Filter and project at each node before sending results, reducing the volume of data transferred.</p>
</li>
<li>
<p><strong>Semi-join reduction</strong>: Instead of shipping an entire relation for a join, ship only the join column values, then request matching tuples.</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>Without semi-join:
  Node A sends entire employees table to Node B for join
  Transfer: |employees| rows Ã— row_size bytes

With semi-join:
  Step 1: Node B sends Ï€_{dept_id}(departments) to Node A    (small!)
  Step 2: Node A computes employees â‹‰ dept_ids               (local filter)
  Step 3: Node A sends only matching employees to Node B      (much smaller)
</code></pre></div>

<ol>
<li>
<p><strong>Bloom filter optimization</strong>: Instead of sending the actual join keys, send a compact Bloom filter. False positives send a few extra rows, but the filter size is dramatically smaller.</p>
</li>
<li>
<p><strong>Parallel execution</strong>: Execute subqueries at different nodes simultaneously.</p>
</li>
</ol>
<h3 id="44-distributed-join-strategies">4.4 Distributed Join Strategies<a class="header-link" href="#44-distributed-join-strategies" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Strategy</th>
<th>Description</th>
<th>When to Use</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Ship-whole</strong></td>
<td>Send one entire relation to the other's node</td>
<td>One relation is very small</td>
</tr>
<tr>
<td><strong>Semi-join</strong></td>
<td>Exchange join keys, then ship matching tuples</td>
<td>Selective join (few matches)</td>
</tr>
<tr>
<td><strong>Hash partitioned join</strong></td>
<td>Both relations hash-partitioned on join key, join locally</td>
<td>Large-large equi-join</td>
</tr>
<tr>
<td><strong>Broadcast join</strong></td>
<td>Replicate small table to all nodes</td>
<td>Small-large join</td>
</tr>
<tr>
<td><strong>Collocated join</strong></td>
<td>Both tables partitioned on join key â†’ join locally with no transfer</td>
<td>Tables co-partitioned</td>
</tr>
</tbody>
</table>
<p><strong>Collocated join example</strong>:</p>
<div class="highlight"><pre><span></span><code>If orders and order_items are both partitioned by order_id:

Node 1: orders (order_id 1-1000)     + order_items (order_id 1-1000)
Node 2: orders (order_id 1001-2000)  + order_items (order_id 1001-2000)
Node 3: orders (order_id 2001-3000)  + order_items (order_id 2001-3000)

JOIN orders o ON o.order_id = order_items.order_id
â†’ Each node can execute the join LOCALLY (no network transfer!)
</code></pre></div>

<p>This is why choosing the right partition key is critical: it determines which joins can be collocated.</p>
<hr />
<h2 id="5-distributed-transactions-two-phase-commit-2pc">5. Distributed Transactions: Two-Phase Commit (2PC)<a class="header-link" href="#5-distributed-transactions-two-phase-commit-2pc" title="Permanent link">&para;</a></h2>
<h3 id="51-the-problem">5.1 The Problem<a class="header-link" href="#51-the-problem" title="Permanent link">&para;</a></h3>
<p>When a transaction spans multiple nodes, we need all nodes to agree on whether to commit or abort. Partial commits (some nodes commit, others abort) violate atomicity.</p>
<div class="highlight"><pre><span></span><code><span class="nt">Transaction</span><span class="w"> </span><span class="nt">T</span><span class="o">:</span><span class="w"> </span><span class="nt">Transfer</span><span class="w"> </span><span class="o">$</span><span class="nt">100</span><span class="w"> </span><span class="nt">from</span><span class="w"> </span><span class="nt">Account</span><span class="w"> </span><span class="nt">A</span><span class="w"> </span><span class="o">(</span><span class="nt">Node</span><span class="w"> </span><span class="nt">1</span><span class="o">)</span><span class="w"> </span><span class="nt">to</span><span class="w"> </span><span class="nt">Account</span><span class="w"> </span><span class="nt">B</span><span class="w"> </span><span class="o">(</span><span class="nt">Node</span><span class="w"> </span><span class="nt">2</span><span class="o">)</span>

<span class="nt">Node</span><span class="w"> </span><span class="nt">1</span><span class="o">:</span><span class="w"> </span><span class="nt">UPDATE</span><span class="w"> </span><span class="nt">accounts</span><span class="w"> </span><span class="nt">SET</span><span class="w"> </span><span class="nt">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">balance</span><span class="w"> </span><span class="nt">-</span><span class="w"> </span><span class="nt">100</span><span class="w"> </span><span class="nt">WHERE</span><span class="w"> </span><span class="nt">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;A&#39;</span><span class="o">;</span>
<span class="nt">Node</span><span class="w"> </span><span class="nt">2</span><span class="o">:</span><span class="w"> </span><span class="nt">UPDATE</span><span class="w"> </span><span class="nt">accounts</span><span class="w"> </span><span class="nt">SET</span><span class="w"> </span><span class="nt">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">balance</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nt">100</span><span class="w"> </span><span class="nt">WHERE</span><span class="w"> </span><span class="nt">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;B&#39;</span><span class="o">;</span>

<span class="nt">What</span><span class="w"> </span><span class="nt">if</span><span class="w"> </span><span class="nt">Node</span><span class="w"> </span><span class="nt">1</span><span class="w"> </span><span class="nt">commits</span><span class="w"> </span><span class="nt">but</span><span class="w"> </span><span class="nt">Node</span><span class="w"> </span><span class="nt">2</span><span class="w"> </span><span class="nt">crashes</span><span class="o">?</span>
<span class="err">â†’</span><span class="w"> </span><span class="o">$</span><span class="nt">100</span><span class="w"> </span><span class="nt">disappears</span><span class="o">!</span><span class="w"> </span><span class="nt">Atomicity</span><span class="w"> </span><span class="nt">violated</span><span class="o">.</span>
</code></pre></div>

<h3 id="52-two-phase-commit-protocol">5.2 Two-Phase Commit Protocol<a class="header-link" href="#52-two-phase-commit-protocol" title="Permanent link">&para;</a></h3>
<p>2PC uses a designated <strong>coordinator</strong> and the participating <strong>nodes</strong> (participants).</p>
<p><strong>Phase 1: Prepare (Voting)</strong></p>
<div class="highlight"><pre><span></span><code>Coordinator                  Node 1                  Node 2
    â”‚                          â”‚                       â”‚
    â”‚â”€â”€â”€â”€â”€ PREPARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                       â”‚
    â”‚â”€â”€â”€â”€â”€ PREPARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
    â”‚                          â”‚                       â”‚
    â”‚                    (execute txn                   â”‚
    â”‚                     locally,                      â”‚
    â”‚                     acquire locks,                â”‚
    â”‚                     write to WAL)                 â”‚
    â”‚                          â”‚                       â”‚
    â”‚â—€â”€â”€â”€â”€ VOTE YES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
    â”‚â—€â”€â”€â”€â”€ VOTE YES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚                          â”‚                       â”‚
</code></pre></div>

<p>Each participant:
1. Executes the transaction locally (but does NOT commit)
2. Writes a prepare record to its WAL (Write-Ahead Log)
3. Responds with VOTE YES (if it can commit) or VOTE NO (if it cannot)</p>
<p><strong>Phase 2: Commit/Abort (Decision)</strong></p>
<p>If all participants voted YES:</p>
<div class="highlight"><pre><span></span><code>Coordinator                  Node 1                  Node 2
    â”‚                          â”‚                       â”‚
    â”‚  (write COMMIT to        â”‚                       â”‚
    â”‚   coordinator WAL)       â”‚                       â”‚
    â”‚                          â”‚                       â”‚
    â”‚â”€â”€â”€â”€â”€ COMMIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                       â”‚
    â”‚â”€â”€â”€â”€â”€ COMMIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
    â”‚                          â”‚                       â”‚
    â”‚                    (commit locally,               â”‚
    â”‚                     release locks,                â”‚
    â”‚                     write commit to WAL)          â”‚
    â”‚                          â”‚                       â”‚
    â”‚â—€â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
    â”‚â—€â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚                          â”‚                       â”‚
</code></pre></div>

<p>If any participant voted NO:</p>
<div class="highlight"><pre><span></span><code>Coordinator                  Node 1                  Node 2
    â”‚                          â”‚                       â”‚
    â”‚  (write ABORT to         â”‚                       â”‚
    â”‚   coordinator WAL)       â”‚                       â”‚
    â”‚                          â”‚                       â”‚
    â”‚â”€â”€â”€â”€â”€ ABORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                       â”‚
    â”‚â”€â”€â”€â”€â”€ ABORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
    â”‚                          â”‚                       â”‚
    â”‚                    (rollback locally,             â”‚
    â”‚                     release locks)                â”‚
    â”‚                          â”‚                       â”‚
    â”‚â—€â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
    â”‚â—€â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
</code></pre></div>

<h3 id="53-state-machine">5.3 State Machine<a class="header-link" href="#53-state-machine" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="w">                    </span><span class="nv">Coordinator</span><span class="w">                          </span><span class="nv">Participant</span>
<span class="w">              </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">                 </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<span class="w">              </span>â”‚<span class="w">     </span><span class="nv">INITIAL</span><span class="w">     </span>â”‚<span class="w">                 </span>â”‚<span class="w">     </span><span class="nv">INITIAL</span><span class="w">     </span>â”‚
<span class="w">              </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">                 </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<span class="w">                       </span>â”‚<span class="w"> </span><span class="k">send</span><span class="w"> </span><span class="nv">PREPARE</span><span class="w">                      </span>â”‚<span class="w"> </span><span class="nv">receive</span><span class="w"> </span><span class="nv">PREPARE</span>
<span class="w">                       </span>â–¼<span class="w">                                   </span>â–¼
<span class="w">              </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">                 </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<span class="w">              </span>â”‚<span class="w">     </span><span class="nv">WAITING</span><span class="w">     </span>â”‚<span class="w">                 </span>â”‚<span class="w">     </span><span class="nv">READY</span><span class="w">       </span>â”‚
<span class="w">              </span>â”‚<span class="w">  </span><span class="ss">(</span><span class="k">for</span><span class="w"> </span><span class="nv">votes</span><span class="ss">)</span><span class="w">    </span>â”‚<span class="w">                 </span>â”‚<span class="w">  </span><span class="ss">(</span><span class="nv">voted</span><span class="w"> </span><span class="nv">YES</span><span class="ss">)</span><span class="w">    </span>â”‚
<span class="w">              </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">                 </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<span class="w">                       </span>â”‚<span class="w">                                   </span>â”‚
<span class="w">              </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">                 </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
<span class="w">              </span>â”‚<span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">YES</span><span class="w">  </span>â”‚<span class="w"> </span><span class="nv">any</span><span class="w"> </span><span class="nv">NO</span><span class="w">                 </span>â”‚<span class="w"> </span><span class="nv">COMMIT</span><span class="w">   </span>â”‚<span class="w"> </span><span class="nv">ABORT</span>
<span class="w">              </span>â–¼<span class="w">          </span>â–¼<span class="w">                        </span>â–¼<span class="w">          </span>â–¼
<span class="w">        </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w"> </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">         </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w"> </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<span class="w">        </span>â”‚<span class="w"> </span><span class="nv">COMMITTED</span>â”‚<span class="w"> </span>â”‚<span class="w"> </span><span class="nv">ABORTED</span><span class="w">  </span>â”‚<span class="w">         </span>â”‚<span class="w"> </span><span class="nv">COMMITTED</span>â”‚<span class="w"> </span>â”‚<span class="w"> </span><span class="nv">ABORTED</span><span class="w">  </span>â”‚
<span class="w">        </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w"> </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">         </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w"> </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="54-failure-analysis">5.4 Failure Analysis<a class="header-link" href="#54-failure-analysis" title="Permanent link">&para;</a></h3>
<p>2PC must handle various failure scenarios:</p>
<p><strong>Case 1: Participant crashes before voting</strong></p>
<div class="highlight"><pre><span></span><code><span class="nv">Coordinator</span><span class="w"> </span><span class="nv">times</span><span class="w"> </span><span class="nv">out</span><span class="w"> </span><span class="nv">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">vote</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">ABORT</span><span class="w"> </span><span class="nv">transaction</span>
<span class="nv">Participant</span><span class="w"> </span><span class="nv">recovers</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">consults</span><span class="w"> </span><span class="nv">WAL</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">no</span><span class="w"> </span><span class="nv">prepare</span><span class="w"> </span><span class="nv">record</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">knows</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">abort</span>
</code></pre></div>

<p><strong>Case 2: Participant crashes after voting YES</strong></p>
<div class="highlight"><pre><span></span><code><span class="nv">Coordinator</span><span class="w"> </span><span class="nv">received</span><span class="w"> </span><span class="nv">YES</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">proceeds</span><span class="w"> </span><span class="nv">normally</span>
<span class="nv">Participant</span><span class="w"> </span><span class="nv">recovers</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">consults</span><span class="w"> </span><span class="nv">WAL</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">sees</span><span class="w"> </span><span class="nv">prepare</span><span class="w"> </span><span class="nv">record</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">contacts</span><span class="w"> </span><span class="nv">coordinator</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">decision</span>
<span class="nv">This</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="s2">&quot;in-doubt&quot;</span><span class="w"> </span><span class="nv">state</span>:<span class="w"> </span><span class="nv">participant</span><span class="w"> </span><span class="nv">has</span><span class="w"> </span><span class="nv">voted</span><span class="w"> </span><span class="nv">YES</span><span class="w"> </span><span class="nv">but</span><span class="w"> </span><span class="nv">does</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">know</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">outcome</span>
</code></pre></div>

<p><strong>Case 3: Coordinator crashes after collecting votes</strong></p>
<div class="highlight"><pre><span></span><code><span class="nv">THIS</span><span class="w"> </span><span class="nv">IS</span><span class="w"> </span><span class="nv">THE</span><span class="w"> </span><span class="nv">CRITICAL</span><span class="w"> </span><span class="nv">PROBLEM</span><span class="w"> </span><span class="nv">WITH</span><span class="w"> </span><span class="mi">2</span><span class="nv">PC</span><span class="o">!</span>

<span class="nv">Participants</span><span class="w"> </span><span class="nv">are</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">READY</span><span class="w"> </span><span class="nv">state</span><span class="w"> </span><span class="ss">(</span><span class="nv">voted</span><span class="w"> </span><span class="nv">YES</span><span class="ss">)</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">cannot</span><span class="w"> </span><span class="nv">proceed</span>:
<span class="o">-</span><span class="w"> </span><span class="nv">Cannot</span><span class="w"> </span><span class="nv">COMMIT</span>:<span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">coordinator</span><span class="w"> </span><span class="nv">might</span><span class="w"> </span><span class="nv">have</span><span class="w"> </span><span class="nv">decided</span><span class="w"> </span><span class="nv">ABORT</span>
<span class="o">-</span><span class="w"> </span><span class="nv">Cannot</span><span class="w"> </span><span class="nv">ABORT</span>:<span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">coordinator</span><span class="w"> </span><span class="nv">might</span><span class="w"> </span><span class="nv">have</span><span class="w"> </span><span class="nv">decided</span><span class="w"> </span><span class="nv">COMMIT</span>
<span class="o">-</span><span class="w"> </span><span class="nv">Cannot</span><span class="w"> </span><span class="nv">ask</span><span class="w"> </span><span class="nv">other</span><span class="w"> </span><span class="nv">participants</span>:<span class="w"> </span><span class="nv">they</span><span class="w"> </span><span class="nv">might</span><span class="w"> </span><span class="nv">also</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">READY</span><span class="w"> </span><span class="nv">state</span>

<span class="nb">RESULT</span>:<span class="w"> </span><span class="nv">Participants</span><span class="w"> </span><span class="nv">must</span><span class="w"> </span><span class="nv">BLOCK</span><span class="w"> </span><span class="k">until</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">coordinator</span><span class="w"> </span><span class="nv">recovers</span>.
</code></pre></div>

<p>This <strong>blocking problem</strong> is the fundamental weakness of 2PC. In the worst case, participants hold locks indefinitely, blocking other transactions.</p>
<h3 id="55-optimizations">5.5 Optimizations<a class="header-link" href="#55-optimizations" title="Permanent link">&para;</a></h3>
<p><strong>Presumed Abort</strong>: If the coordinator crashes without writing a decision to its log, it presumes ABORT upon recovery. This eliminates the need to write ABORT decisions to the log.</p>
<p><strong>Read-Only Optimization</strong>: If a participant determines that the transaction did not modify any data at its site, it votes READ-ONLY and can immediately release its resources without waiting for the decision.</p>
<p><strong>Transfer of Coordination</strong>: A participant can take over the coordinator role if the original coordinator fails (requires agreement among remaining participants).</p>
<hr />
<h2 id="6-three-phase-commit-3pc">6. Three-Phase Commit (3PC)<a class="header-link" href="#6-three-phase-commit-3pc" title="Permanent link">&para;</a></h2>
<h3 id="61-motivation">6.1 Motivation<a class="header-link" href="#61-motivation" title="Permanent link">&para;</a></h3>
<p>3PC was proposed by Dale Skeen in 1981 to solve the blocking problem of 2PC by adding an extra phase.</p>
<h3 id="62-protocol">6.2 Protocol<a class="header-link" href="#62-protocol" title="Permanent link">&para;</a></h3>
<p><strong>Phase 1: CanCommit (Voting)</strong> -- Same as 2PC Phase 1.</p>
<p><strong>Phase 2: PreCommit</strong> -- A new intermediate phase.</p>
<p><strong>Phase 3: DoCommit</strong> -- Same as 2PC Phase 2.</p>
<div class="highlight"><pre><span></span><code>Coordinator              Node 1                 Node 2
    â”‚                      â”‚                      â”‚
    â”‚â”€â”€ CAN_COMMIT? â”€â”€â”€â”€â”€â”€â–¶â”‚                      â”‚
    â”‚â”€â”€ CAN_COMMIT? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                      â”‚                      â”‚
    â”‚â—€â”€â”€ YES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
    â”‚â—€â”€â”€ YES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚                      â”‚                      â”‚
    â”‚â”€â”€ PRE_COMMIT â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                      â”‚   â† NEW PHASE
    â”‚â”€â”€ PRE_COMMIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                      â”‚                      â”‚
    â”‚â—€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
    â”‚â—€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚                      â”‚                      â”‚
    â”‚â”€â”€ DO_COMMIT â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                      â”‚
    â”‚â”€â”€ DO_COMMIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
    â”‚                      â”‚                      â”‚
    â”‚â—€â”€â”€ DONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
    â”‚â—€â”€â”€ DONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
</code></pre></div>

<h3 id="63-how-3pc-avoids-blocking">6.3 How 3PC Avoids Blocking<a class="header-link" href="#63-how-3pc-avoids-blocking" title="Permanent link">&para;</a></h3>
<p>The key insight: in 3PC, if a participant is in the PreCommit state, it knows that ALL participants voted YES. Therefore:</p>
<ul>
<li>If the coordinator crashes during PreCommit, any surviving participant that received PRE_COMMIT knows the coordinator intended to commit. They can elect a new coordinator and proceed with COMMIT.</li>
<li>If a participant has NOT received PRE_COMMIT, it can safely ABORT (because the coordinator might not have reached the commit decision).</li>
</ul>
<p><strong>The non-blocking property</strong>: No single node failure can cause the remaining nodes to block indefinitely.</p>
<h3 id="64-limitations-of-3pc">6.4 Limitations of 3PC<a class="header-link" href="#64-limitations-of-3pc" title="Permanent link">&para;</a></h3>
<p>Despite solving the blocking problem in theory, 3PC has significant practical limitations:</p>
<ol>
<li><strong>Network partitions</strong>: 3PC assumes a fail-stop model (nodes crash but do not partition). In a real network partition, 3PC can still violate consistency:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="n">Scenario</span><span class="o">:</span>
<span class="w">  </span><span class="n">Partition</span><span class="w"> </span><span class="n">splits</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="o">{</span><span class="n">Coordinator</span><span class="o">,</span><span class="w"> </span><span class="n">Node1</span><span class="o">}</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="o">{</span><span class="n">Node2</span><span class="o">}</span>

<span class="w">  </span><span class="n">Coordinator</span><span class="w"> </span><span class="n">sends</span><span class="w"> </span><span class="n">PRE_COMMIT</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Node1</span><span class="w"> </span><span class="o">(</span><span class="n">received</span><span class="o">)</span>
<span class="w">  </span><span class="n">Coordinator</span><span class="w"> </span><span class="n">sends</span><span class="w"> </span><span class="n">PRE_COMMIT</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Node2</span><span class="w"> </span><span class="o">(</span><span class="n">LOST</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">partition</span><span class="o">)</span>

<span class="w">  </span><span class="n">Coordinator</span><span class="w"> </span><span class="n">crashes</span><span class="o">.</span>

<span class="w">  </span><span class="n">Node1</span><span class="w"> </span><span class="o">(</span><span class="n">received</span><span class="w"> </span><span class="n">PRE_COMMIT</span><span class="o">):</span><span class="w"> </span><span class="s2">&quot;Coordinator wanted to commit&quot;</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">COMMIT</span>
<span class="w">  </span><span class="n">Node2</span><span class="w"> </span><span class="o">(</span><span class="n">did</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">receive</span><span class="w"> </span><span class="n">PRE_COMMIT</span><span class="o">):</span><span class="w"> </span><span class="s2">&quot;Timeout, no PRE_COMMIT&quot;</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">ABORT</span>

<span class="w">  </span><span class="n">INCONSISTENCY</span><span class="o">!</span><span class="w"> </span><span class="n">Node1</span><span class="w"> </span><span class="n">committed</span><span class="o">,</span><span class="w"> </span><span class="n">Node2</span><span class="w"> </span><span class="n">aborted</span><span class="o">.</span>
</code></pre></div>

<ol>
<li>
<p><strong>Extra round-trip</strong>: 3PC requires one more round-trip than 2PC, increasing latency.</p>
</li>
<li>
<p><strong>Rarely used in practice</strong>: Due to the network partition vulnerability, most modern systems use 2PC with timeouts or Paxos/Raft-based consensus instead.</p>
</li>
</ol>
<h3 id="65-comparison-2pc-vs-3pc">6.5 Comparison: 2PC vs 3PC<a class="header-link" href="#65-comparison-2pc-vs-3pc" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Property</th>
<th>2PC</th>
<th>3PC</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Phases</strong></td>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td><strong>Blocking</strong></td>
<td>Yes (coordinator crash)</td>
<td>No (in fail-stop model)</td>
</tr>
<tr>
<td><strong>Network partitions</strong></td>
<td>Blocks</td>
<td>Can be inconsistent</td>
</tr>
<tr>
<td><strong>Latency</strong></td>
<td>2 round-trips</td>
<td>3 round-trips</td>
</tr>
<tr>
<td><strong>Complexity</strong></td>
<td>Moderate</td>
<td>High</td>
</tr>
<tr>
<td><strong>Practical use</strong></td>
<td>Widespread</td>
<td>Rare</td>
</tr>
<tr>
<td><strong>Message count</strong></td>
<td>4N (prepare + vote + decision + ack)</td>
<td>6N (more messages)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7-consensus-algorithms-paxos-and-raft">7. Consensus Algorithms: Paxos and Raft<a class="header-link" href="#7-consensus-algorithms-paxos-and-raft" title="Permanent link">&para;</a></h2>
<h3 id="71-the-consensus-problem">7.1 The Consensus Problem<a class="header-link" href="#71-the-consensus-problem" title="Permanent link">&para;</a></h3>
<p>In a distributed system, consensus is the problem of getting multiple nodes to agree on a single value. This is fundamental to:</p>
<ul>
<li><strong>Leader election</strong>: Which node is the current leader?</li>
<li><strong>Distributed transactions</strong>: Should we commit or abort?</li>
<li><strong>Replicated state machines</strong>: What is the next operation to apply?</li>
<li><strong>Configuration management</strong>: What is the current cluster membership?</li>
</ul>
<p><strong>Formal requirements</strong>:
1. <strong>Agreement</strong>: All correct nodes decide the same value.
2. <strong>Validity</strong>: The decided value was proposed by some node.
3. <strong>Termination</strong>: Every correct node eventually decides.</p>
<p>The <strong>FLP impossibility theorem</strong> (Fischer, Lynch, Paterson, 1985) proves that in an asynchronous system with even one faulty node, it is impossible to guarantee consensus. Practical algorithms like Paxos and Raft overcome this by using timeouts and randomization (technically, they may not terminate in adversarial scenarios, but they work well in practice).</p>
<h3 id="72-paxos">7.2 Paxos<a class="header-link" href="#72-paxos" title="Permanent link">&para;</a></h3>
<p>Paxos, invented by Leslie Lamport in 1989, is the foundational consensus algorithm. It is notoriously difficult to understand (Lamport originally described it as a parliamentary protocol on the fictional Greek island of Paxos).</p>
<p><strong>Roles</strong>:
- <strong>Proposer</strong>: Proposes a value
- <strong>Acceptor</strong>: Votes on proposals
- <strong>Learner</strong>: Learns the decided value</p>
<p>(A single node can play multiple roles.)</p>
<p><strong>Single-decree Paxos</strong> (agreeing on one value):</p>
<p><strong>Phase 1: Prepare</strong></p>
<div class="highlight"><pre><span></span><code><span class="nv">Proposer</span><span class="w">                       </span><span class="nv">Acceptors</span><span class="w"> </span><span class="ss">(</span><span class="nv">majority</span><span class="w"> </span><span class="nv">needed</span><span class="ss">)</span>
<span class="w">   </span>â”‚<span class="w">                             </span><span class="nv">A1</span><span class="w">        </span><span class="nv">A2</span><span class="w">        </span><span class="nv">A3</span>
<span class="w">   </span>â”‚<span class="w">                              </span>â”‚<span class="w">         </span>â”‚<span class="w">         </span>â”‚
<span class="w">   </span>â”‚â”€â”€<span class="nv">PREPARE</span><span class="ss">(</span><span class="nv">n</span><span class="o">=</span><span class="mi">1</span><span class="ss">)</span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚<span class="w">         </span>â”‚<span class="w">         </span>â”‚
<span class="w">   </span>â”‚â”€â”€<span class="nv">PREPARE</span><span class="ss">(</span><span class="nv">n</span><span class="o">=</span><span class="mi">1</span><span class="ss">)</span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶<span class="w"> </span>â”‚<span class="w">         </span>â”‚
<span class="w">   </span>â”‚â”€â”€<span class="nv">PREPARE</span><span class="ss">(</span><span class="nv">n</span><span class="o">=</span><span class="mi">1</span><span class="ss">)</span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶<span class="w"> </span>â”‚
<span class="w">   </span>â”‚<span class="w">                              </span>â”‚<span class="w">         </span>â”‚<span class="w">         </span>â”‚
<span class="w">   </span>â”‚â—€â”€<span class="nv">PROMISE</span><span class="ss">(</span><span class="nv">n</span><span class="o">=</span><span class="mi">1</span>,<span class="w"> </span><span class="nv">null</span><span class="ss">)</span>â”€â”€â”€â”€â”€â”€â”€â”€â”‚<span class="w">         </span>â”‚<span class="w">         </span>â”‚
<span class="w">   </span>â”‚â—€â”€<span class="nv">PROMISE</span><span class="ss">(</span><span class="nv">n</span><span class="o">=</span><span class="mi">1</span>,<span class="w"> </span><span class="nv">null</span><span class="ss">)</span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<span class="w"> </span>â”‚<span class="w">         </span>â”‚
<span class="w">   </span>â”‚â—€â”€<span class="nv">PROMISE</span><span class="ss">(</span><span class="nv">n</span><span class="o">=</span><span class="mi">1</span>,<span class="w"> </span><span class="nv">null</span><span class="ss">)</span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<span class="w"> </span>â”‚
<span class="w">   </span>â”‚<span class="w">                              </span>â”‚<span class="w">         </span>â”‚<span class="w">         </span>â”‚

<span class="nv">Each</span><span class="w"> </span><span class="nv">acceptor</span><span class="w"> </span><span class="nv">promises</span>:
<span class="o">-</span><span class="w"> </span><span class="s2">&quot;I will not accept any proposal with number &lt; 1&quot;</span>
<span class="o">-</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="nv">acceptor</span><span class="w"> </span><span class="nv">has</span><span class="w"> </span><span class="nv">previously</span><span class="w"> </span><span class="nv">accepted</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">value</span>,<span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">includes</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">value</span>
</code></pre></div>

<p><strong>Phase 2: Accept</strong></p>
<div class="highlight"><pre><span></span><code>Proposer                       Acceptors
   â”‚                             A1        A2        A3
   â”‚                              â”‚         â”‚         â”‚
   â”‚â”€â”€ACCEPT(n=1, v=&quot;X&quot;)â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚         â”‚         â”‚
   â”‚â”€â”€ACCEPT(n=1, v=&quot;X&quot;)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚         â”‚
   â”‚â”€â”€ACCEPT(n=1, v=&quot;X&quot;)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
   â”‚                              â”‚         â”‚         â”‚
   â”‚â—€â”€ACCEPTED(n=1)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚         â”‚
   â”‚â—€â”€ACCEPTED(n=1)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚         â”‚
   â”‚â—€â”€ACCEPTED(n=1)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
   â”‚                              â”‚         â”‚         â”‚

Majority accepted â†’ value &quot;X&quot; is CHOSEN
</code></pre></div>

<p><strong>Key insight</strong>: If a proposer receives a promise with a previously accepted value, it MUST propose that value (not its own). This ensures that once a value is chosen, it cannot be changed.</p>
<p><strong>Multi-Paxos</strong>: Extends single-decree Paxos by electing a stable leader that skips Phase 1 for subsequent proposals. This reduces the protocol to a single phase (Phase 2 only) in the common case, making it practical for replicated logs.</p>
<h3 id="73-raft">7.3 Raft<a class="header-link" href="#73-raft" title="Permanent link">&para;</a></h3>
<p>Raft was designed by Diego Ongaro and John Ousterhout in 2014 as an understandable alternative to Paxos. It provides the same guarantees but with a clearer structure.</p>
<p><strong>Key idea</strong>: Raft decomposes consensus into three sub-problems:
1. <strong>Leader election</strong>: Choose one node to be the leader.
2. <strong>Log replication</strong>: The leader accepts entries and replicates them to followers.
3. <strong>Safety</strong>: Ensure that committed entries are not lost.</p>
<p><strong>Raft state machine</strong>:</p>
<div class="highlight"><pre><span></span><code>                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               timeout, â”‚          â”‚ receives vote
               start    â”‚ Follower â”‚ from candidate
               election â”‚          â”‚ with higher term
                   â”Œâ”€â”€â”€â”€â”‚          â”‚â—€â”€â”€â”€â”€â”
                   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                   â”‚         â–²           â”‚
                   â”‚         â”‚           â”‚
                   â–¼         â”‚           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚Candidate â”‚   â”‚      â”‚  Leader   â”‚
              â”‚          â”‚â”€â”€â”€â”˜      â”‚          â”‚
              â”‚          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  wins    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             election
</code></pre></div>

<p><strong>Leader Election</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="nv">Time</span><span class="w"> </span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶

<span class="nv">Term</span><span class="w"> </span><span class="mi">1</span><span class="w">                    </span><span class="nv">Term</span><span class="w"> </span><span class="mi">2</span><span class="w">                    </span><span class="nv">Term</span><span class="w"> </span><span class="mi">3</span>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€
â”‚<span class="w"> </span><span class="nv">Leader</span>:<span class="w"> </span><span class="nv">Node</span><span class="w"> </span><span class="nv">A</span><span class="w">      </span>â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">Leader</span>:<span class="w"> </span><span class="nv">Node</span><span class="w"> </span><span class="nv">B</span><span class="w">      </span>â”‚<span class="w">  </span>â”‚<span class="w"> </span>...
â”‚<span class="w"> </span><span class="nv">Normal</span><span class="w"> </span><span class="nv">operation</span><span class="w">    </span>â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">Normal</span><span class="w"> </span><span class="nv">operation</span><span class="w">    </span>â”‚<span class="w">  </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€
<span class="w">                      </span>â†‘
<span class="w">                </span><span class="nv">Node</span><span class="w"> </span><span class="nv">A</span><span class="w"> </span><span class="nv">crashes</span>,
<span class="w">                </span><span class="nv">Node</span><span class="w"> </span><span class="nv">B</span><span class="w"> </span><span class="nv">wins</span><span class="w"> </span><span class="nv">election</span>

<span class="nv">Election</span><span class="w"> </span><span class="nv">process</span>:
<span class="mi">1</span>.<span class="w"> </span><span class="nv">Follower</span><span class="w"> </span><span class="nv">times</span><span class="w"> </span><span class="nv">out</span><span class="w"> </span><span class="ss">(</span><span class="nv">no</span><span class="w"> </span><span class="nv">heartbeat</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">leader</span><span class="ss">)</span>
<span class="mi">2</span>.<span class="w"> </span><span class="nv">Becomes</span><span class="w"> </span><span class="nv">candidate</span>,<span class="w"> </span><span class="nv">increments</span><span class="w"> </span><span class="nv">term</span>,<span class="w"> </span><span class="nv">votes</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">itself</span>
<span class="mi">3</span>.<span class="w"> </span><span class="nv">Sends</span><span class="w"> </span><span class="nv">RequestVote</span><span class="w"> </span><span class="nv">RPCs</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">other</span><span class="w"> </span><span class="nv">nodes</span>
<span class="mi">4</span>.<span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="nv">majority</span><span class="w"> </span><span class="nv">votes</span><span class="w"> </span><span class="nv">YES</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">becomes</span><span class="w"> </span><span class="nv">leader</span>
<span class="mi">5</span>.<span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="nv">another</span><span class="w"> </span><span class="nv">leader</span><span class="w"> </span><span class="nv">discovered</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">reverts</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">follower</span>
<span class="mi">6</span>.<span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="nb">timeout</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">increment</span><span class="w"> </span><span class="nv">term</span>,<span class="w"> </span><span class="nv">restart</span><span class="w"> </span><span class="nv">election</span>
</code></pre></div>

<p><strong>Log Replication</strong>:</p>
<div class="highlight"><pre><span></span><code>Leader                          Followers
  â”‚                         F1         F2         F3
  â”‚                          â”‚          â”‚          â”‚
  â”‚  Client: SET x = 5       â”‚          â”‚          â”‚
  â”‚  Append to local log     â”‚          â”‚          â”‚
  â”‚                          â”‚          â”‚          â”‚
  â”‚â”€â”€AppendEntries(x=5)â”€â”€â”€â”€â”€â–¶â”‚          â”‚          â”‚
  â”‚â”€â”€AppendEntries(x=5)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚          â”‚
  â”‚â”€â”€AppendEntries(x=5)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â–¶â”‚
  â”‚                          â”‚          â”‚          â”‚
  â”‚â—€â”€â”€ACKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚          â”‚          â”‚
  â”‚â—€â”€â”€ACKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚          â”‚
  â”‚                          â”‚          â”‚          â”‚
  â”‚  Majority (2 of 3) ACKed           â”‚          â”‚
  â”‚  â†’ COMMIT entry                    â”‚          â”‚
  â”‚  â†’ Respond to client               â”‚          â”‚
  â”‚                          â”‚          â”‚          â”‚
  â”‚â”€â”€AppendEntries(commit)â”€â”€â–¶â”‚          â”‚          â”‚
  â”‚â”€â”€AppendEntries(commit)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚          â”‚
  â”‚â”€â”€AppendEntries(commit)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â–¶â”‚
</code></pre></div>

<p><strong>Safety property</strong>: Only a node with all committed entries can become leader. Raft ensures this through the election mechanism: a candidate must have a log that is at least as up-to-date as the voter's log to receive a vote.</p>
<h3 id="74-paxos-vs-raft">7.4 Paxos vs Raft<a class="header-link" href="#74-paxos-vs-raft" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Paxos</th>
<th>Raft</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Understandability</strong></td>
<td>Notoriously difficult</td>
<td>Designed for clarity</td>
</tr>
<tr>
<td><strong>Leader</strong></td>
<td>Optional (Multi-Paxos has leader)</td>
<td>Required</td>
</tr>
<tr>
<td><strong>Log structure</strong></td>
<td>Can have gaps</td>
<td>No gaps (sequential)</td>
</tr>
<tr>
<td><strong>Safety proof</strong></td>
<td>Complex</td>
<td>Straightforward</td>
</tr>
<tr>
<td><strong>Reconfiguration</strong></td>
<td>Requires separate protocol</td>
<td>Joint consensus built-in</td>
</tr>
<tr>
<td><strong>Real-world use</strong></td>
<td>Google Chubby, Spanner</td>
<td>etcd, CockroachDB, Consul, TiKV</td>
</tr>
<tr>
<td><strong>Theoretical foundations</strong></td>
<td>Stronger (more general)</td>
<td>Equivalent in practice</td>
</tr>
</tbody>
</table>
<h3 id="75-consensus-in-databases">7.5 Consensus in Databases<a class="header-link" href="#75-consensus-in-databases" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Database</th>
<th>Consensus Algorithm</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Google Spanner</td>
<td>Multi-Paxos</td>
<td>Log replication within each Paxos group</td>
</tr>
<tr>
<td>CockroachDB</td>
<td>Raft</td>
<td>Range replication across nodes</td>
</tr>
<tr>
<td>TiDB (TiKV)</td>
<td>Raft</td>
<td>Region replication</td>
</tr>
<tr>
<td>etcd</td>
<td>Raft</td>
<td>Key-value store for Kubernetes</td>
</tr>
<tr>
<td>ZooKeeper</td>
<td>Zab (Paxos variant)</td>
<td>Coordination service</td>
</tr>
<tr>
<td>Cassandra</td>
<td>Paxos (lightweight txns)</td>
<td>Compare-and-set operations</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8-distributed-concurrency-control">8. Distributed Concurrency Control<a class="header-link" href="#8-distributed-concurrency-control" title="Permanent link">&para;</a></h2>
<h3 id="81-challenges">8.1 Challenges<a class="header-link" href="#81-challenges" title="Permanent link">&para;</a></h3>
<p>Concurrency control in a distributed setting faces additional challenges compared to single-node systems:</p>
<ul>
<li><strong>No global clock</strong>: Nodes cannot agree on the exact time, making timestamp ordering difficult.</li>
<li><strong>Network latency</strong>: Lock requests and releases incur network round-trips.</li>
<li><strong>Distributed deadlocks</strong>: Deadlock cycles may span multiple nodes.</li>
<li><strong>Partial failures</strong>: A node holding locks may crash, leaving locks held indefinitely.</li>
</ul>
<h3 id="82-distributed-two-phase-locking-d2pl">8.2 Distributed Two-Phase Locking (D2PL)<a class="header-link" href="#82-distributed-two-phase-locking-d2pl" title="Permanent link">&para;</a></h3>
<p>Extend 2PL to distributed settings: each node has a local lock manager, and a transaction acquires locks at each node it accesses.</p>
<div class="highlight"><pre><span></span><code>Transaction T accesses Node 1 and Node 2:

Node 1 Lock Manager               Node 2 Lock Manager
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lock table:      â”‚               â”‚ Lock table:      â”‚
â”‚ row_A â†’ T (X)   â”‚               â”‚ row_B â†’ T (X)   â”‚
â”‚ row_C â†’ T (S)   â”‚               â”‚ row_D â†’ T (S)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Growing phase: T acquires locks at both nodes
Commit: 2PC ensures atomic commit
Shrinking phase: After 2PC decision, all nodes release T&#39;s locks
</code></pre></div>

<h3 id="83-distributed-deadlock-detection">8.3 Distributed Deadlock Detection<a class="header-link" href="#83-distributed-deadlock-detection" title="Permanent link">&para;</a></h3>
<p><strong>Wait-for graph</strong>: Each node maintains a local wait-for graph. A global deadlock occurs when the union of all local graphs has a cycle.</p>
<div class="highlight"><pre><span></span><code>Node 1 local WFG:       Node 2 local WFG:
  T1 â†’ T2                 T2 â†’ T3

Node 3 local WFG:
  T3 â†’ T1

Global WFG: T1 â†’ T2 â†’ T3 â†’ T1   â† CYCLE = DEADLOCK
</code></pre></div>

<p><strong>Detection approaches</strong>:</p>
<table>
<thead>
<tr>
<th>Approach</th>
<th>Description</th>
<th>Tradeoffs</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Centralized</strong></td>
<td>One node collects all local WFGs and checks for global cycles</td>
<td>Simple but single point of failure</td>
</tr>
<tr>
<td><strong>Distributed</strong></td>
<td>Nodes send WFG edges to each other; each node detects cycles it can see</td>
<td>No single point of failure but may detect phantom deadlocks</td>
</tr>
<tr>
<td><strong>Timeout-based</strong></td>
<td>If a transaction waits longer than a threshold, assume deadlock and abort</td>
<td>Simple but may abort non-deadlocked transactions</td>
</tr>
</tbody>
</table>
<p><strong>Phantom deadlock</strong>: A false deadlock detected due to stale information.</p>
<div class="highlight"><pre><span></span><code><span class="nv">Time</span><span class="w"> </span><span class="mi">1</span>:<span class="w"> </span><span class="nv">T1</span><span class="w"> </span><span class="nv">waits</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">T2</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">Node</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">(</span><span class="nv">WFG</span><span class="w"> </span><span class="nv">edge</span>:<span class="w"> </span><span class="nv">T1</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">T2</span><span class="ss">)</span>
<span class="nv">Time</span><span class="w"> </span><span class="mi">2</span>:<span class="w"> </span><span class="nv">T2</span><span class="w"> </span><span class="nv">finishes</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">Node</span><span class="w"> </span><span class="mi">1</span>,<span class="w"> </span><span class="nv">but</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">WFG</span><span class="w"> </span><span class="nv">edge</span><span class="w"> </span><span class="nv">hasn</span><span class="err">&#39;t been removed yet</span>
<span class="err">Time 3: T2 starts waiting for T1 at Node 2 (WFG edge: T2 â†’ T1)</span>

<span class="err">If the deadlock detector sees both edges simultaneously:</span>
<span class="err">  T1 â†’ T2 â†’ T1 â†’ PHANTOM DEADLOCK (T2 already released the lock)</span>
</code></pre></div>

<h3 id="84-distributed-timestamp-ordering">8.4 Distributed Timestamp Ordering<a class="header-link" href="#84-distributed-timestamp-ordering" title="Permanent link">&para;</a></h3>
<p>Assign globally unique timestamps to transactions. The challenge is generating timestamps without a global clock.</p>
<p><strong>Lamport timestamps</strong>: A logical clock that ensures partial ordering.</p>
<div class="highlight"><pre><span></span><code>Each node maintains a counter C:
<span class="k">-</span> Before each event: C = C + 1
<span class="k">-</span> When sending a message: attach C to the message
<span class="k">-</span> When receiving a message with timestamp T: C = max(C, T) + 1

Timestamp = (C, node_id) for total ordering
</code></pre></div>

<p><strong>TrueTime (Google Spanner)</strong>: Uses GPS and atomic clocks to provide a bounded uncertainty interval [earliest, latest] for the real time. Spanner waits out the uncertainty before committing, achieving external consistency (real-time ordering).</p>
<div class="highlight"><pre><span></span><code><span class="nv">TrueTime</span><span class="w"> </span><span class="nv">API</span>:
<span class="w">  </span><span class="nv">TT</span>.<span class="nv">now</span><span class="ss">()</span><span class="w"> </span>â†’<span class="w"> </span>[<span class="nv">earliest</span>,<span class="w"> </span><span class="nv">latest</span>]
<span class="w">  </span><span class="nv">TT</span>.<span class="nv">after</span><span class="ss">(</span><span class="nv">t</span><span class="ss">)</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">true</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">t</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">definitely</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">past</span>
<span class="w">  </span><span class="nv">TT</span>.<span class="nv">before</span><span class="ss">(</span><span class="nv">t</span><span class="ss">)</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">true</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">t</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">definitely</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">future</span>

<span class="nv">Commit</span><span class="w"> </span><span class="k">wait</span>:
<span class="w">  </span><span class="mi">1</span>.<span class="w"> </span><span class="nv">Transaction</span><span class="w"> </span><span class="nv">T</span><span class="w"> </span><span class="nv">gets</span><span class="w"> </span><span class="nv">commit</span><span class="w"> </span><span class="nv">timestamp</span><span class="w"> </span><span class="nv">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">TT</span>.<span class="nv">now</span><span class="ss">()</span>.<span class="nv">latest</span>
<span class="w">  </span><span class="mi">2</span>.<span class="w"> </span><span class="k">Wait</span><span class="w"> </span><span class="k">until</span><span class="w"> </span><span class="nv">TT</span>.<span class="nv">after</span><span class="ss">(</span><span class="nv">s</span><span class="ss">)</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">true</span>
<span class="w">  </span><span class="mi">3</span>.<span class="w"> </span><span class="nv">Commit</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">timestamp</span><span class="w"> </span><span class="nv">s</span>

<span class="w">  </span><span class="nv">This</span><span class="w"> </span><span class="nv">ensures</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">T1</span><span class="w"> </span><span class="nv">commits</span><span class="w"> </span><span class="nv">before</span><span class="w"> </span><span class="nv">T2</span><span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="ss">(</span><span class="nv">real</span><span class="w"> </span><span class="nv">time</span><span class="ss">)</span>,
<span class="w">  </span><span class="k">then</span><span class="w"> </span><span class="nv">s1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nv">s2</span><span class="w"> </span><span class="ss">(</span><span class="nv">timestamp</span><span class="w"> </span><span class="nv">order</span><span class="w"> </span><span class="nv">matches</span><span class="w"> </span><span class="nv">real</span><span class="o">-</span><span class="nv">time</span><span class="w"> </span><span class="nv">order</span><span class="ss">)</span>.
</code></pre></div>

<h3 id="85-distributed-mvcc">8.5 Distributed MVCC<a class="header-link" href="#85-distributed-mvcc" title="Permanent link">&para;</a></h3>
<p>Many distributed databases use Multi-Version Concurrency Control:</p>
<div class="highlight"><pre><span></span><code>Distributed MVCC for key &quot;account_balance&quot;:

Node 1 (primary):
  Version 1: value=1000, ts=100, committed
  Version 2: value=900,  ts=150, committed
  Version 3: value=850,  ts=200, committed

Node 2 (replica):
  Version 1: value=1000, ts=100, committed
  Version 2: value=900,  ts=150, committed
  (Version 3 not yet replicated)

Read at Node 2 with snapshot ts=175:
  â†’ Returns Version 2 (value=900) because ts=150 â‰¤ 175

Read at Node 1 with snapshot ts=175:
  â†’ Returns Version 2 (value=900) because ts=200 &gt; 175

Both reads are consistent! (snapshot isolation)
</code></pre></div>

<hr />
<h2 id="9-cap-theorem-implications-for-distributed-design">9. CAP Theorem Implications for Distributed Design<a class="header-link" href="#9-cap-theorem-implications-for-distributed-design" title="Permanent link">&para;</a></h2>
<h3 id="91-revisiting-cap-in-design-context">9.1 Revisiting CAP in Design Context<a class="header-link" href="#91-revisiting-cap-in-design-context" title="Permanent link">&para;</a></h3>
<p>We introduced the CAP theorem in <a href="./13_NoSQL_Data_Models.md">Lesson 13</a>. Now we apply it to specific design decisions in distributed databases.</p>
<h3 id="92-cp-design-patterns">9.2 CP Design Patterns<a class="header-link" href="#92-cp-design-patterns" title="Permanent link">&para;</a></h3>
<p><strong>Pattern: Linearizable reads via leader</strong></p>
<div class="highlight"><pre><span></span><code><span class="ow">All</span><span class="w"> </span><span class="k">reads</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">writes</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nl">leader</span><span class="p">:</span>

<span class="n">Client</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">Leader</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">Followers</span><span class="w"> </span><span class="p">(</span><span class="k">replication</span><span class="p">)</span>
<span class="w">                  </span><span class="err">â—€â”€â”€</span><span class="w"> </span><span class="p">(</span><span class="k">reads</span><span class="w"> </span><span class="n">served</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">leader</span><span class="w"> </span><span class="k">only</span><span class="p">)</span>

<span class="nl">Tradeoff</span><span class="p">:</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">leader</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">unreachable</span><span class="w"> </span><span class="p">(</span><span class="k">partition</span><span class="p">),</span><span class="w"> </span><span class="k">reads</span><span class="w"> </span><span class="n">fail</span><span class="w"> </span><span class="p">(</span><span class="n">reduced</span><span class="w"> </span><span class="n">availability</span><span class="p">)</span>
<span class="n">Used</span><span class="w"> </span><span class="k">by</span><span class="err">:</span><span class="w"> </span><span class="n">etcd</span><span class="p">,</span><span class="w"> </span><span class="n">ZooKeeper</span><span class="p">,</span><span class="w"> </span><span class="n">HBase</span>
</code></pre></div>

<p><strong>Pattern: Majority quorum</strong></p>
<div class="highlight"><pre><span></span><code><span class="nv">Read</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">majority</span>,<span class="w"> </span><span class="nv">write</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">majority</span>:

<span class="nv">Client</span><span class="w"> </span><span class="nv">writes</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nv">replicas</span><span class="w"> </span><span class="ss">(</span><span class="nv">W</span><span class="o">=</span><span class="mi">2</span><span class="ss">)</span>
<span class="nv">Client</span><span class="w"> </span><span class="nv">reads</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nv">replicas</span><span class="w"> </span><span class="ss">(</span><span class="nv">R</span><span class="o">=</span><span class="mi">2</span><span class="ss">)</span>
<span class="nv">W</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">N</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">guaranteed</span><span class="w"> </span><span class="nv">overlap</span>

<span class="nv">Tradeoff</span>:<span class="w"> </span><span class="nv">During</span><span class="w"> </span><span class="nv">partition</span>,<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">majority</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">unreachable</span>,<span class="w"> </span><span class="nv">operations</span><span class="w"> </span><span class="nv">fail</span>
<span class="nv">Used</span><span class="w"> </span><span class="nv">by</span>:<span class="w"> </span><span class="nv">MongoDB</span><span class="w"> </span><span class="ss">(</span><span class="nv">majority</span><span class="w"> </span><span class="nv">read</span><span class="o">/</span><span class="nv">write</span><span class="w"> </span><span class="nv">concern</span><span class="ss">)</span>
</code></pre></div>

<h3 id="93-ap-design-patterns">9.3 AP Design Patterns<a class="header-link" href="#93-ap-design-patterns" title="Permanent link">&para;</a></h3>
<p><strong>Pattern: Read from any replica</strong></p>
<div class="highlight"><pre><span></span><code><span class="nv">Client</span><span class="w"> </span><span class="nv">reads</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">any</span><span class="w"> </span><span class="nv">available</span><span class="w"> </span><span class="nv">replica</span>:

<span class="nv">Client</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="nv">Any</span><span class="w"> </span><span class="nv">Replica</span><span class="w"> </span><span class="ss">(</span><span class="nv">may</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nv">stale</span><span class="w"> </span><span class="nv">data</span><span class="ss">)</span>

<span class="nv">Tradeoff</span>:<span class="w"> </span><span class="nv">Always</span><span class="w"> </span><span class="nv">available</span>,<span class="w"> </span><span class="nv">but</span><span class="w"> </span><span class="nv">may</span><span class="w"> </span><span class="nv">read</span><span class="w"> </span><span class="nv">stale</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="nv">after</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">write</span>
<span class="nv">Used</span><span class="w"> </span><span class="nv">by</span>:<span class="w"> </span><span class="nv">Cassandra</span><span class="w"> </span><span class="ss">(</span><span class="nv">with</span><span class="w"> </span><span class="nv">consistency</span><span class="w"> </span><span class="nv">level</span><span class="w"> </span><span class="nv">ONE</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">DynamoDB</span><span class="w"> </span><span class="ss">(</span><span class="nv">eventually</span><span class="w"> </span><span class="nv">consistent</span><span class="w"> </span><span class="nv">reads</span><span class="ss">)</span>
</code></pre></div>

<p><strong>Pattern: Hinted handoff</strong></p>
<div class="highlight"><pre><span></span><code>During partition, write to available nodes:

Normal:    Client â”€â”€â–¶ Replica A, Replica B, Replica C
Partition: Client â”€â”€â–¶ Replica A, Replica D* (hint), Replica E* (hint)
Recovery:  Replica D â”€â”€â–¶ Replica B (forward hinted write)
           Replica E â”€â”€â–¶ Replica C (forward hinted write)

<span class="k">*</span> D and E are not the designated replicas but accept the write as a &quot;hint&quot;
Tradeoff: Write succeeds (available) but consistency is deferred
Used by: Dynamo, Cassandra, Riak
</code></pre></div>

<h3 id="94-consistency-level-tuning">9.4 Consistency Level Tuning<a class="header-link" href="#94-consistency-level-tuning" title="Permanent link">&para;</a></h3>
<p>Many distributed databases allow per-operation consistency tuning:</p>
<div class="highlight"><pre><span></span><code>Cassandra consistency levels:

ONE:    Write/Read to 1 replica      (fastest, least consistent)
QUORUM: Write/Read to majority       (balanced)
ALL:    Write/Read to all replicas   (slowest, most consistent)
LOCAL_QUORUM: Majority in local DC   (multi-datacenter)

DynamoDB consistency:
  Eventually Consistent Read: 0.5x cost, may return stale data
  Strongly Consistent Read:   1x cost, always returns latest

MongoDB read concern:
  &quot;local&quot;:    Return local data (fast, may be stale)
  &quot;majority&quot;: Return data acknowledged by majority (consistent)
  &quot;linearizable&quot;: Strongest, single-document reads only
</code></pre></div>

<hr />
<h2 id="10-partitioning-strategies">10. Partitioning Strategies<a class="header-link" href="#10-partitioning-strategies" title="Permanent link">&para;</a></h2>
<h3 id="101-range-partitioning">10.1 Range Partitioning<a class="header-link" href="#101-range-partitioning" title="Permanent link">&para;</a></h3>
<p>Assign contiguous ranges of the key space to each partition.</p>
<div class="highlight"><pre><span></span><code>Key space: [0, 1000]

Partition 1 (Node A): keys [0, 333]
Partition 2 (Node B): keys [334, 666]
Partition 3 (Node C): keys [667, 1000]

Example: User IDs
  Node A: users 1-333
  Node B: users 334-666
  Node C: users 667-1000
</code></pre></div>

<p><strong>Advantages</strong>:
- Range queries are efficient (scan a single partition or consecutive partitions)
- Easy to understand and implement</p>
<p><strong>Disadvantages</strong>:
- <strong>Hot spots</strong>: If the key distribution is skewed (e.g., recent timestamps concentrate on one partition), one node gets disproportionate load
- <strong>Rebalancing</strong>: When splitting a hot partition, data must be moved</p>
<p><strong>Used by</strong>: HBase, Spanner, CockroachDB, TiDB</p>
<h3 id="102-hash-partitioning">10.2 Hash Partitioning<a class="header-link" href="#102-hash-partitioning" title="Permanent link">&para;</a></h3>
<p>Apply a hash function to the key and assign hash ranges to partitions.</p>
<div class="highlight"><pre><span></span><code>Hash function: h(key) â†’ [0, 2^32)

Partition 1 (Node A): h(key) âˆˆ [0, 2^32/3)
Partition 2 (Node B): h(key) âˆˆ [2^32/3, 2*2^32/3)
Partition 3 (Node C): h(key) âˆˆ [2*2^32/3, 2^32)

Example: h(&quot;user_42&quot;) = 178294 â†’ Partition 1 (Node A)
         h(&quot;user_43&quot;) = 891023 â†’ Partition 2 (Node B)

Adjacent keys are scattered across different partitions.
</code></pre></div>

<p><strong>Advantages</strong>:
- Even distribution of keys across partitions (no hot spots for random keys)
- Works well with any key distribution</p>
<p><strong>Disadvantages</strong>:
- <strong>Range queries impossible</strong>: Keys that are close together in the original space are scattered across partitions. <code>SELECT * FROM users WHERE id BETWEEN 100 AND 200</code> must query ALL partitions.
- <strong>Rebalancing</strong>: Adding a node requires rehashing and moving ~1/N of all data.</p>
<p><strong>Used by</strong>: DynamoDB, Cassandra (default partitioner)</p>
<h3 id="103-consistent-hashing">10.3 Consistent Hashing<a class="header-link" href="#103-consistent-hashing" title="Permanent link">&para;</a></h3>
<p>Consistent hashing solves the rebalancing problem of hash partitioning. It was introduced by Karger et al. in 1997.</p>
<p><strong>Concept</strong>: Both keys and nodes are mapped onto a circular hash ring.</p>
<div class="highlight"><pre><span></span><code><span class="w">           </span><span class="mh">0</span><span class="w"> </span><span class="p">(</span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="o">^</span><span class="mh">32</span><span class="p">)</span>
<span class="w">            </span><span class="err">â”‚</span>
<span class="w">            </span><span class="err">â”‚</span>
<span class="w">   </span><span class="n">N3</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="w"> </span><span class="n">N1</span>
<span class="w">  </span><span class="p">(</span><span class="n">hash</span><span class="o">=</span><span class="w">    </span><span class="err">â”‚</span><span class="w">     </span><span class="p">(</span><span class="n">hash</span><span class="o">=</span>
<span class="w">   </span><span class="mh">300</span><span class="p">)</span><span class="w">     </span><span class="err">â”‚</span><span class="w">      </span><span class="mh">50</span><span class="p">)</span>
<span class="w">            </span><span class="err">â”‚</span>
<span class="w">            </span><span class="err">â”‚</span>
<span class="w">            </span><span class="err">â”‚</span>
<span class="w">            </span><span class="err">â”‚</span>
<span class="w">   </span><span class="n">N2</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="w"> </span><span class="err">â”‚</span>
<span class="w">  </span><span class="p">(</span><span class="n">hash</span><span class="o">=</span><span class="w">    </span><span class="err">â”‚</span>
<span class="w">   </span><span class="mh">180</span><span class="p">)</span><span class="w">     </span><span class="err">â”‚</span>

<span class="n">Keys</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">assigned</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="nl">clockwise:</span>
<span class="w">  </span><span class="n">h</span><span class="p">(</span><span class="s">&quot;k1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">30</span><span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">N1</span><span class="w"> </span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="n">clockwise</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mh">30</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">N1</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">50</span><span class="p">)</span>
<span class="w">  </span><span class="n">h</span><span class="p">(</span><span class="s">&quot;k2&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">70</span><span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">N2</span><span class="w"> </span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="n">clockwise</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mh">70</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">N2</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">180</span><span class="p">)</span>
<span class="w">  </span><span class="n">h</span><span class="p">(</span><span class="s">&quot;k3&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">200</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">N3</span><span class="w"> </span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="n">clockwise</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mh">200</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">N3</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">300</span><span class="p">)</span>
<span class="w">  </span><span class="n">h</span><span class="p">(</span><span class="s">&quot;k4&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">310</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">N1</span><span class="w"> </span><span class="p">(</span><span class="n">wraps</span><span class="w"> </span><span class="n">around</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">N1</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">50</span><span class="p">)</span>
</code></pre></div>

<p><strong>Adding a node</strong>: Only keys between the new node and its predecessor need to move.</p>
<div class="highlight"><pre><span></span><code><span class="n">Before</span><span class="o">:</span><span class="w"> </span><span class="n">N1</span><span class="o">(</span><span class="mi">50</span><span class="o">),</span><span class="w"> </span><span class="n">N2</span><span class="o">(</span><span class="mi">180</span><span class="o">),</span><span class="w"> </span><span class="n">N3</span><span class="o">(</span><span class="mi">300</span><span class="o">)</span>
<span class="n">Add</span><span class="w"> </span><span class="n">N4</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="mi">120</span><span class="o">:</span>

<span class="w">   </span><span class="n">Before</span><span class="o">:</span>
<span class="w">   </span><span class="n">h</span><span class="o">(</span><span class="s2">&quot;k5&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">N2</span><span class="w"> </span><span class="o">(</span><span class="n">next</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">N2</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">180</span><span class="o">)</span>

<span class="w">   </span><span class="n">After</span><span class="o">:</span>
<span class="w">   </span><span class="n">h</span><span class="o">(</span><span class="s2">&quot;k5&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">N4</span><span class="w"> </span><span class="o">(</span><span class="n">next</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">N4</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">120</span><span class="o">)</span>

<span class="w">   </span><span class="n">Only</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">range</span><span class="w"> </span><span class="o">(</span><span class="mi">50</span><span class="o">,</span><span class="w"> </span><span class="mi">120</span><span class="o">]</span><span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">N2</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">N4</span><span class="o">.</span>
<span class="w">   </span><span class="n">All</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="n">stay</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">their</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">nodes</span><span class="o">!</span>
</code></pre></div>

<p><strong>Virtual nodes</strong>: To ensure even distribution, each physical node is assigned multiple "virtual" positions on the ring.</p>
<div class="highlight"><pre><span></span><code><span class="n">Physical</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Virtual</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="mi">240</span>
<span class="n">Physical</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Virtual</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="mi">190</span><span class="p">,</span><span class="w"> </span><span class="mi">310</span>
<span class="n">Physical</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Virtual</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">160</span><span class="p">,</span><span class="w"> </span><span class="mi">280</span>

<span class="n">With</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">virtual</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">node</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">More</span><span class="w"> </span><span class="n">even</span><span class="w"> </span><span class="n">distribution</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">keys</span>
<span class="o">-</span><span class="w"> </span><span class="n">Smoother</span><span class="w"> </span><span class="n">rebalancing</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="n">join</span><span class="o">/</span><span class="n">leave</span>
<span class="o">-</span><span class="w"> </span><span class="n">Better</span><span class="w"> </span><span class="n">fault</span><span class="w"> </span><span class="n">tolerance</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="n">node</span><span class="s1">&#39;s load is spread across many nodes)</span>
</code></pre></div>

<p><strong>Used by</strong>: Dynamo, Cassandra, Riak, Memcached, CDN load balancing</p>
<h3 id="104-partitioning-comparison">10.4 Partitioning Comparison<a class="header-link" href="#104-partitioning-comparison" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Range</th>
<th>Hash</th>
<th>Consistent Hashing</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Range queries</strong></td>
<td>Efficient</td>
<td>Impossible</td>
<td>Impossible</td>
</tr>
<tr>
<td><strong>Load distribution</strong></td>
<td>May be skewed</td>
<td>Even</td>
<td>Even (with vnodes)</td>
</tr>
<tr>
<td><strong>Rebalancing cost</strong></td>
<td>Split/merge ranges</td>
<td>Rehash ~1/N</td>
<td>Move ~1/N</td>
</tr>
<tr>
<td><strong>Hot spots</strong></td>
<td>Possible</td>
<td>Unlikely</td>
<td>Unlikely</td>
</tr>
<tr>
<td><strong>Implementation</strong></td>
<td>Simple</td>
<td>Simple</td>
<td>Moderate</td>
</tr>
<tr>
<td><strong>Ordering</strong></td>
<td>Preserved</td>
<td>Lost</td>
<td>Lost</td>
</tr>
</tbody>
</table>
<h3 id="105-compound-partitioning">10.5 Compound Partitioning<a class="header-link" href="#105-compound-partitioning" title="Permanent link">&para;</a></h3>
<p>Some databases use a combination: hash the partition key for distribution, then range-order within each partition using a sort key.</p>
<div class="highlight"><pre><span></span><code><span class="n">Cassandra</span><span class="o">:</span><span class="w"> </span><span class="n">PRIMARY</span><span class="w"> </span><span class="n">KEY</span><span class="w"> </span><span class="o">((</span><span class="n">partition_key</span><span class="o">),</span><span class="w"> </span><span class="n">clustering_key</span><span class="o">)</span>
<span class="n">DynamoDB</span><span class="o">:</span><span class="w">  </span><span class="n">Partition</span><span class="w"> </span><span class="n">Key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Sort</span><span class="w"> </span><span class="n">Key</span>

<span class="n">Example</span><span class="o">:</span><span class="w"> </span><span class="n">Messages</span><span class="w"> </span><span class="n">table</span>
<span class="w">  </span><span class="n">Partition</span><span class="w"> </span><span class="n">Key</span><span class="o">:</span><span class="w"> </span><span class="n">conversation_id</span><span class="w"> </span><span class="o">(</span><span class="n">hashed</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">even</span><span class="w"> </span><span class="n">distribution</span><span class="o">)</span>
<span class="w">  </span><span class="n">Sort</span><span class="w"> </span><span class="n">Key</span><span class="o">:</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">(</span><span class="n">range</span><span class="o">-</span><span class="n">ordered</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="n">partition</span><span class="o">)</span>

<span class="n">Physical</span><span class="w"> </span><span class="n">layout</span><span class="o">:</span>
<span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="n">A</span><span class="o">:</span><span class="w"> </span><span class="n">conversation_123</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="o">[</span><span class="n">msg</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">t3</span><span class="o">,</span><span class="w"> </span><span class="o">...]</span><span class="w">  </span><span class="o">(</span><span class="n">sorted</span><span class="o">)</span>
<span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="n">B</span><span class="o">:</span><span class="w"> </span><span class="n">conversation_456</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="o">[</span><span class="n">msg</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="o">...]</span><span class="w">  </span><span class="o">(</span><span class="n">sorted</span><span class="o">)</span>

<span class="n">Query</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Get messages in conversation_123 from last hour&quot;</span>
<span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">Hash</span><span class="w"> </span><span class="n">conversation_123</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">A</span>
<span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">Range</span><span class="w"> </span><span class="n">scan</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="o">(</span><span class="n">efficient</span><span class="o">!)</span>
</code></pre></div>

<hr />
<h2 id="11-exercises">11. Exercises<a class="header-link" href="#11-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-architecture-selection">Exercise 1: Architecture Selection<a class="header-link" href="#exercise-1-architecture-selection" title="Permanent link">&para;</a></h3>
<p>For each of the following scenarios, recommend a distributed database architecture (shared-nothing, shared-disk, or shared-memory) and justify your choice.</p>
<ol>
<li>A global e-commerce company with datacenters on 4 continents, serving 500 million users.</li>
<li>A medium-sized company running analytics on 10 TB of data with 20 concurrent analysts.</li>
<li>A startup with a single database server reaching its limits and needing to scale compute independently of storage.</li>
</ol>
<h3 id="exercise-2-fragmentation-design">Exercise 2: Fragmentation Design<a class="header-link" href="#exercise-2-fragmentation-design" title="Permanent link">&para;</a></h3>
<p>Given the following schema:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">  </span><span class="n">dept_id</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">  </span><span class="n">salary</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">,</span>
<span class="w">  </span><span class="n">ssn</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span>
<span class="w">  </span><span class="n">hire_date</span><span class="w"> </span><span class="nb">DATE</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">  </span><span class="k">location</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>

<p>Design a fragmentation strategy for a distributed database with 3 nodes (one in New York, one in London, one in Tokyo). The company has departments in all three cities. Consider:
1. How would you horizontally fragment <code>employees</code>?
2. How would you vertically fragment <code>employees</code> to protect sensitive data?
3. Should <code>departments</code> be replicated or fragmented? Why?
4. Verify the completeness and reconstruction conditions for your fragments.</p>
<h3 id="exercise-3-quorum-calculations">Exercise 3: Quorum Calculations<a class="header-link" href="#exercise-3-quorum-calculations" title="Permanent link">&para;</a></h3>
<p>Given a cluster with N = 5 replicas:</p>
<ol>
<li>What values of W and R guarantee strong consistency?</li>
<li>If W = 3 and R = 3, how many node failures can the system tolerate for reads? For writes?</li>
<li>If you want writes to be fast (W = 1), what must R be for strong consistency? What is the read latency implication?</li>
<li>A system has N = 7, W = 4, R = 4. Is this strongly consistent? How many failures can it tolerate?</li>
</ol>
<h3 id="exercise-4-2pc-trace">Exercise 4: 2PC Trace<a class="header-link" href="#exercise-4-2pc-trace" title="Permanent link">&para;</a></h3>
<p>Trace through the 2PC protocol for the following scenario:</p>
<p>A transaction T transfers $500 from Account A (Node 1) to Account B (Node 2).</p>
<ol>
<li>Show the message sequence when both nodes vote YES.</li>
<li>Show the message sequence when Node 2 votes NO.</li>
<li>Show what happens if the coordinator crashes AFTER receiving all YES votes but BEFORE sending COMMIT messages. What state are the participants in? How long might they wait?</li>
</ol>
<h3 id="exercise-5-consensus-scenario">Exercise 5: Consensus Scenario<a class="header-link" href="#exercise-5-consensus-scenario" title="Permanent link">&para;</a></h3>
<p>Consider a 5-node Raft cluster (nodes A, B, C, D, E) where node A is the current leader in term 3.</p>
<ol>
<li>Node A crashes. Walk through the leader election process. Which node becomes the new leader and why?</li>
<li>Before crashing, node A had replicated log entry [term 3, SET x=5] to nodes A, B, and C (but not D and E). Is this entry committed? Why or why not?</li>
<li>If node B becomes the new leader in term 4, will it include entry [term 3, SET x=5] in its log? Explain.</li>
</ol>
<h3 id="exercise-6-distributed-deadlock">Exercise 6: Distributed Deadlock<a class="header-link" href="#exercise-6-distributed-deadlock" title="Permanent link">&para;</a></h3>
<p>Three transactions run across two nodes:</p>
<div class="highlight"><pre><span></span><code><span class="nv">Node</span><span class="w"> </span><span class="mi">1</span>:
<span class="w">  </span><span class="nv">T1</span><span class="w"> </span><span class="nv">holds</span><span class="w"> </span><span class="nv">lock</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">A</span>,<span class="w"> </span><span class="nv">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">lock</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">B</span><span class="w"> </span><span class="ss">(</span><span class="nv">held</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">T2</span><span class="ss">)</span>
<span class="w">  </span><span class="nv">T2</span><span class="w"> </span><span class="nv">holds</span><span class="w"> </span><span class="nv">lock</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">B</span>

<span class="nv">Node</span><span class="w"> </span><span class="mi">2</span>:
<span class="w">  </span><span class="nv">T2</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">lock</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">C</span><span class="w"> </span><span class="ss">(</span><span class="nv">held</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">T3</span><span class="ss">)</span>
<span class="w">  </span><span class="nv">T3</span><span class="w"> </span><span class="nv">holds</span><span class="w"> </span><span class="nv">lock</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">C</span>,<span class="w"> </span><span class="nv">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">lock</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">A</span><span class="w"> </span><span class="ss">(</span><span class="nv">held</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">T1</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">Node</span><span class="w"> </span><span class="mi">1</span><span class="ss">)</span>
</code></pre></div>

<ol>
<li>Draw the global wait-for graph.</li>
<li>Is there a deadlock? If so, which transaction should be aborted to break the cycle?</li>
<li>How would a centralized deadlock detector discover this deadlock?</li>
<li>How might a timeout-based approach handle this? What are the risks?</li>
</ol>
<h3 id="exercise-7-partitioning-strategy">Exercise 7: Partitioning Strategy<a class="header-link" href="#exercise-7-partitioning-strategy" title="Permanent link">&para;</a></h3>
<p>You are designing a distributed database for a social media platform. The <code>posts</code> table has the following schema:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">posts</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">post_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span>
<span class="w">  </span><span class="n">user_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span>
<span class="w">  </span><span class="n">content</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<span class="w">  </span><span class="n">like_count</span><span class="w"> </span><span class="nb">INT</span>
<span class="p">);</span>
</code></pre></div>

<p>Common queries:
1. Get all posts by a specific user, ordered by creation time (most recent first).
2. Get a specific post by ID.
3. Get the 100 most recent posts across all users (global timeline).</p>
<p>For each partitioning strategy (range on user_id, hash on post_id, consistent hashing on user_id):
1. Explain how each query would be executed.
2. Identify potential hot spots.
3. Recommend the best strategy and justify your choice.</p>
<h3 id="exercise-8-consistent-hashing">Exercise 8: Consistent Hashing<a class="header-link" href="#exercise-8-consistent-hashing" title="Permanent link">&para;</a></h3>
<p>Given a consistent hashing ring with positions [0, 360):</p>
<p>Nodes: A at 45, B at 120, C at 200, D at 310</p>
<p>Keys and their hash values:
- k1 = 30, k2 = 90, k3 = 150, k4 = 210, k5 = 330, k6 = 10</p>
<ol>
<li>Which node is responsible for each key?</li>
<li>Node E is added at position 170. Which keys are reassigned and to which node?</li>
<li>Node B fails. Which keys are reassigned and to which node?</li>
<li>If each physical node has 3 virtual nodes (e.g., A at 45, 165, 285), redo the key assignments.</li>
</ol>
<h3 id="exercise-9-replication-conflict-resolution">Exercise 9: Replication Conflict Resolution<a class="header-link" href="#exercise-9-replication-conflict-resolution" title="Permanent link">&para;</a></h3>
<p>Two users concurrently update a shared document in a leaderless replicated system (3 replicas):</p>
<div class="highlight"><pre><span></span><code>User X (connects to Replica 1): SET title = &quot;Draft v2&quot;    at time T=100
User Y (connects to Replica 2): SET title = &quot;Final Draft&quot;  at time T=101
</code></pre></div>

<p>Due to a network partition, Replica 3 is unreachable.</p>
<ol>
<li>Under Last-Writer-Wins (LWW), what is the final value? Is any data lost?</li>
<li>Under version vectors, how would the conflict be detected and represented?</li>
<li>Propose an application-level resolution strategy for this scenario.</li>
<li>How would a CRDT (specifically, a Last-Writer-Wins Register) handle this?</li>
</ol>
<h3 id="exercise-10-distributed-query-optimization">Exercise 10: Distributed Query Optimization<a class="header-link" href="#exercise-10-distributed-query-optimization" title="Permanent link">&para;</a></h3>
<p>Consider two tables distributed across two nodes:</p>
<div class="highlight"><pre><span></span><code>Node 1: orders (10 million rows, 500 bytes/row)
  Columns: order_id, customer_id, total, order_date

Node 2: customers (100,000 rows, 200 bytes/row)
  Columns: customer_id, name, city, email
</code></pre></div>

<p>Query: <code>SELECT c.name, o.total FROM orders o JOIN customers c ON o.customer_id = c.customer_id WHERE c.city = 'Tokyo';</code></p>
<p>Assume Tokyo customers are 5% of all customers (5,000 customers).
Assume each customer has ~100 orders on average.
Network transfer cost: 1 ms per MB.</p>
<p>Compare the cost of these strategies:
1. <strong>Ship-whole</strong>: Send entire <code>customers</code> table to Node 1, join there.
2. <strong>Ship-whole (reverse)</strong>: Send entire <code>orders</code> table to Node 2, join there.
3. <strong>Semi-join</strong>: Send Tokyo customer_ids to Node 1, fetch matching orders, join at Node 2.
4. <strong>Bloom filter</strong>: Send a Bloom filter of Tokyo customer_ids to Node 1.</p>
<p>Calculate the approximate data transfer for each strategy in MB.</p>
<hr />
<h2 id="12-references">12. References<a class="header-link" href="#12-references" title="Permanent link">&para;</a></h2>
<ol>
<li>Ozsu, M. T. &amp; Valduriez, P. (2020). <em>Principles of Distributed Database Systems</em>, 4th Edition. Springer.</li>
<li>Kleppmann, M. (2017). <em>Designing Data-Intensive Applications</em>. O'Reilly Media. Chapters 5-9.</li>
<li>Lamport, L. (1998). "The Part-Time Parliament" (Paxos). ACM TOCS.</li>
<li>Ongaro, D. &amp; Ousterhout, J. (2014). "In Search of an Understandable Consensus Algorithm" (Raft). USENIX ATC.</li>
<li>Fischer, M., Lynch, N., Paterson, M. (1985). "Impossibility of Distributed Consensus with One Faulty Process" (FLP). JACM.</li>
<li>Corbett, J. et al. (2013). "Spanner: Google's Globally-Distributed Database." ACM TODS.</li>
<li>DeCandia, G. et al. (2007). "Dynamo: Amazon's Highly Available Key-Value Store." SOSP.</li>
<li>Karger, D. et al. (1997). "Consistent Hashing and Random Trees." ACM STOC.</li>
<li>Skeen, D. (1981). "Nonblocking Commit Protocols." ACM SIGMOD.</li>
<li>Gray, J. &amp; Lamport, L. (2006). "Consensus on Transaction Commit." ACM TODS.</li>
</ol>
<hr />
<p><strong>Previous</strong>: <a href="./13_NoSQL_Data_Models.md">13. NoSQL Data Models</a> | <strong>Next</strong>: <a href="./15_NewSQL_and_Modern_Trends.md">15. NewSQL and Modern Trends</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Database_Theory/13_NoSQL_Data_Models.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">NoSQL Data Models</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Database_Theory/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Database_Theory/15_NewSQL_and_Modern_Trends.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">NewSQL and Modern Trends</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}