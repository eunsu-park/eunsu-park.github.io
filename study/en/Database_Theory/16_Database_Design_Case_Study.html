{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Design Case Study - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Database_Theory/">Database Theory</a>
    <span class="separator">/</span>
    <span class="current">Database Design Case Study</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Database Design Case Study</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Database_Theory/15_NewSQL_and_Modern_Trends.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">NewSQL and Modern Trends</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Database_Theory/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-overview-of-the-design-lifecycle">1. Overview of the Design Lifecycle</a></li>
<li><a href="#2-phase-1-requirements-analysis">2. Phase 1: Requirements Analysis</a><ul>
<li><a href="#21-the-business-context">2.1 The Business Context</a></li>
<li><a href="#22-functional-requirements">2.2 Functional Requirements</a></li>
<li><a href="#23-data-requirements">2.3 Data Requirements</a></li>
<li><a href="#24-volumetric-analysis">2.4 Volumetric Analysis</a></li>
<li><a href="#25-query-patterns">2.5 Query Patterns</a></li>
<li><a href="#26-non-functional-requirements">2.6 Non-Functional Requirements</a></li>
</ul>
</li>
<li><a href="#3-phase-2-conceptual-design-er-diagram">3. Phase 2: Conceptual Design (ER Diagram)</a><ul>
<li><a href="#31-entity-identification">3.1 Entity Identification</a></li>
<li><a href="#32-er-diagram">3.2 ER Diagram</a></li>
<li><a href="#33-cardinality-summary">3.3 Cardinality Summary</a></li>
</ul>
</li>
<li><a href="#4-phase-3-logical-design-relational-schema">4. Phase 3: Logical Design (Relational Schema)</a><ul>
<li><a href="#41-er-to-relational-mapping">4.1 ER-to-Relational Mapping</a></li>
<li><a href="#42-complete-ddl">4.2 Complete DDL</a></li>
<li><a href="#43-normalization-verification">4.3 Normalization Verification</a></li>
<li><a href="#44-referential-integrity-summary">4.4 Referential Integrity Summary</a></li>
</ul>
</li>
<li><a href="#5-phase-4-physical-design">5. Phase 4: Physical Design</a><ul>
<li><a href="#51-indexing-strategy">5.1 Indexing Strategy</a></li>
<li><a href="#52-partitioning-strategy">5.2 Partitioning Strategy</a></li>
<li><a href="#53-denormalization-decisions">5.3 Denormalization Decisions</a></li>
<li><a href="#54-storage-considerations">5.4 Storage Considerations</a></li>
</ul>
</li>
<li><a href="#6-phase-5-query-optimization">6. Phase 5: Query Optimization</a><ul>
<li><a href="#61-product-search-qp-01">6.1 Product Search (QP-01)</a></li>
<li><a href="#62-product-detail-page-qp-02">6.2 Product Detail Page (QP-02)</a></li>
<li><a href="#63-order-history-qp-05">6.3 Order History (QP-05)</a></li>
<li><a href="#64-seller-dashboard-qp-06">6.4 Seller Dashboard (QP-06)</a></li>
<li><a href="#65-query-performance-summary">6.5 Query Performance Summary</a></li>
</ul>
</li>
<li><a href="#7-phase-6-transaction-design">7. Phase 6: Transaction Design</a><ul>
<li><a href="#71-critical-transaction-place-order">7.1 Critical Transaction: Place Order</a></li>
<li><a href="#72-isolation-level-decisions">7.2 Isolation Level Decisions</a></li>
<li><a href="#73-locking-strategy">7.3 Locking Strategy</a></li>
<li><a href="#74-concurrency-scenarios">7.4 Concurrency Scenarios</a></li>
</ul>
</li>
<li><a href="#8-alternative-case-study-social-media-platform">8. Alternative Case Study: Social Media Platform</a><ul>
<li><a href="#81-requirements-summary">8.1 Requirements Summary</a></li>
<li><a href="#82-key-entities">8.2 Key Entities</a></li>
<li><a href="#83-the-feed-problem">8.3 The Feed Problem</a></li>
<li><a href="#84-design-tradeoffs">8.4 Design Tradeoffs</a></li>
</ul>
</li>
<li><a href="#9-design-review-checklist">9. Design Review Checklist</a><ul>
<li><a href="#91-schema-design">9.1 Schema Design</a></li>
<li><a href="#92-indexing">9.2 Indexing</a></li>
<li><a href="#93-data-integrity">9.3 Data Integrity</a></li>
<li><a href="#94-performance">9.4 Performance</a></li>
<li><a href="#95-transactions">9.5 Transactions</a></li>
<li><a href="#96-security">9.6 Security</a></li>
<li><a href="#97-operations">9.7 Operations</a></li>
</ul>
</li>
<li><a href="#10-common-design-mistakes-and-how-to-avoid-them">10. Common Design Mistakes and How to Avoid Them</a><ul>
<li><a href="#mistake-1-using-float-for-money">Mistake 1: Using FLOAT for Money</a></li>
<li><a href="#mistake-2-missing-foreign-key-indexes">Mistake 2: Missing Foreign Key Indexes</a></li>
<li><a href="#mistake-3-storing-derived-data-without-a-maintenance-strategy">Mistake 3: Storing Derived Data Without a Maintenance Strategy</a></li>
<li><a href="#mistake-4-offset-based-pagination">Mistake 4: OFFSET-Based Pagination</a></li>
<li><a href="#mistake-5-the-god-table-eav-anti-pattern">Mistake 5: The God Table (EAV Anti-Pattern)</a></li>
<li><a href="#mistake-6-not-capturing-historical-data">Mistake 6: Not Capturing Historical Data</a></li>
<li><a href="#mistake-7-premature-denormalization">Mistake 7: Premature Denormalization</a></li>
<li><a href="#mistake-8-ignoring-null-semantics">Mistake 8: Ignoring NULL Semantics</a></li>
<li><a href="#mistake-9-storing-comma-separated-values">Mistake 9: Storing Comma-Separated Values</a></li>
<li><a href="#mistake-10-not-planning-for-schema-evolution">Mistake 10: Not Planning for Schema Evolution</a></li>
</ul>
</li>
<li><a href="#11-exercises">11. Exercises</a><ul>
<li><a href="#exercise-1-complete-the-e-commerce-schema">Exercise 1: Complete the E-Commerce Schema</a></li>
<li><a href="#exercise-2-normalization-analysis">Exercise 2: Normalization Analysis</a></li>
<li><a href="#exercise-3-index-design-challenge">Exercise 3: Index Design Challenge</a></li>
<li><a href="#exercise-4-transaction-design">Exercise 4: Transaction Design</a></li>
<li><a href="#exercise-5-design-your-own-database">Exercise 5: Design Your Own Database</a></li>
<li><a href="#exercise-6-critique-this-design">Exercise 6: Critique This Design</a></li>
<li><a href="#exercise-7-scaling-the-e-commerce-design">Exercise 7: Scaling the E-Commerce Design</a></li>
<li><a href="#exercise-8-social-media-feed-design">Exercise 8: Social Media Feed Design</a></li>
<li><a href="#exercise-9-migration-planning">Exercise 9: Migration Planning</a></li>
<li><a href="#exercise-10-design-review">Exercise 10: Design Review</a></li>
</ul>
</li>
<li><a href="#12-references">12. References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="database-design-case-study">Database Design Case Study<a class="header-link" href="#database-design-case-study" title="Permanent link">&para;</a></h1>
<p><strong>Previous</strong>: <a href="./15_NewSQL_and_Modern_Trends.md">15. NewSQL and Modern Trends</a></p>
<hr />
<p>This capstone lesson brings together everything from the preceding fifteen lessons into a comprehensive, end-to-end database design exercise. We will walk through the complete design lifecycle of an e-commerce platform -- from gathering requirements to writing optimized queries -- applying the theory of ER modeling, normalization, indexing, transactions, and concurrency control to a realistic scenario. A second mini case study (social media platform) provides additional practice, and the lesson concludes with a design review checklist and a catalog of common mistakes.</p>
<p><strong>Difficulty</strong>: â­â­â­â­</p>
<p><strong>Learning Objectives</strong>:
- Conduct requirements analysis for a database system
- Produce a complete ER diagram from business requirements
- Map an ER model to a relational schema and normalize to BCNF
- Make informed decisions about physical design (indexing, partitioning, denormalization)
- Analyze query plans and apply optimization techniques
- Design transaction strategies with appropriate isolation levels
- Evaluate design tradeoffs and document decisions
- Recognize and avoid common database design mistakes</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-overview-of-the-design-lifecycle">Overview of the Design Lifecycle</a></li>
<li><a href="#2-phase-1-requirements-analysis">Phase 1: Requirements Analysis</a></li>
<li><a href="#3-phase-2-conceptual-design-er-diagram">Phase 2: Conceptual Design (ER Diagram)</a></li>
<li><a href="#4-phase-3-logical-design-relational-schema">Phase 3: Logical Design (Relational Schema)</a></li>
<li><a href="#5-phase-4-physical-design">Phase 4: Physical Design</a></li>
<li><a href="#6-phase-5-query-optimization">Phase 5: Query Optimization</a></li>
<li><a href="#7-phase-6-transaction-design">Phase 6: Transaction Design</a></li>
<li><a href="#8-alternative-case-study-social-media-platform">Alternative Case Study: Social Media Platform</a></li>
<li><a href="#9-design-review-checklist">Design Review Checklist</a></li>
<li><a href="#10-common-design-mistakes-and-how-to-avoid-them">Common Design Mistakes and How to Avoid Them</a></li>
<li><a href="#11-exercises">Exercises</a></li>
<li><a href="#12-references">References</a></li>
</ol>
<hr />
<h2 id="1-overview-of-the-design-lifecycle">1. Overview of the Design Lifecycle<a class="header-link" href="#1-overview-of-the-design-lifecycle" title="Permanent link">&para;</a></h2>
<p>Database design is not a one-shot process. It follows a structured lifecycle with feedback loops:</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Database Design Lifecycle                   â”‚
â”‚                                                              â”‚
â”‚  Phase 1            Phase 2            Phase 3               â”‚
â”‚  Requirements  â”€â”€â–¶  Conceptual    â”€â”€â–¶  Logical               â”‚
â”‚  Analysis           Design (ER)        Design (Relational)   â”‚
â”‚                                                              â”‚
â”‚       â”‚                                    â”‚                 â”‚
â”‚       â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚       â”‚              â”‚                                       â”‚
â”‚       â”‚              â–¼                                       â”‚
â”‚       â”‚         Phase 4            Phase 5                   â”‚
â”‚       â”‚         Physical      â”€â”€â–¶  Query                     â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â–¶Design             Optimization              â”‚
â”‚                                                              â”‚
â”‚                      â”‚                 â”‚                      â”‚
â”‚                      â–¼                 â–¼                      â”‚
â”‚                 Phase 6                                       â”‚
â”‚                 Transaction Design                            â”‚
â”‚                                                              â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â–¼                                       â”‚
â”‚              Deploy, Monitor, Iterate                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p>Each phase produces artifacts that feed into the next:</p>
<table>
<thead>
<tr>
<th>Phase</th>
<th>Input</th>
<th>Output</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>1. Requirements</strong></td>
<td>Business needs, interviews</td>
<td>Functional &amp; data requirements</td>
</tr>
<tr>
<td><strong>2. Conceptual</strong></td>
<td>Requirements</td>
<td>ER diagram</td>
</tr>
<tr>
<td><strong>3. Logical</strong></td>
<td>ER diagram</td>
<td>Normalized relational schema (DDL)</td>
</tr>
<tr>
<td><strong>4. Physical</strong></td>
<td>Relational schema + query patterns</td>
<td>Indexes, partitions, denormalization</td>
</tr>
<tr>
<td><strong>5. Query</strong></td>
<td>Physical schema + common queries</td>
<td>Optimized queries with explain plans</td>
</tr>
<tr>
<td><strong>6. Transaction</strong></td>
<td>Business rules + concurrency needs</td>
<td>Isolation levels, locking strategy</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2-phase-1-requirements-analysis">2. Phase 1: Requirements Analysis<a class="header-link" href="#2-phase-1-requirements-analysis" title="Permanent link">&para;</a></h2>
<h3 id="21-the-business-context">2.1 The Business Context<a class="header-link" href="#21-the-business-context" title="Permanent link">&para;</a></h3>
<p>We are designing the database for <strong>ShopWave</strong>, an online e-commerce platform that sells physical products. The platform supports multiple sellers, product reviews, promotions, and a standard checkout flow.</p>
<h3 id="22-functional-requirements">2.2 Functional Requirements<a class="header-link" href="#22-functional-requirements" title="Permanent link">&para;</a></h3>
<p>After interviewing stakeholders, we identify these key business functions:</p>
<div class="highlight"><pre><span></span><code><span class="nx">FR</span><span class="o">-</span><span class="mi">01</span><span class="p">:</span><span class="w"> </span><span class="nx">Customer</span><span class="w"> </span><span class="nx">registration</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">authentication</span>
<span class="nx">FR</span><span class="o">-</span><span class="mi">02</span><span class="p">:</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="nx">catalog</span><span class="w"> </span><span class="nx">browsing</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">search</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">filtering</span>
<span class="nx">FR</span><span class="o">-</span><span class="mi">03</span><span class="p">:</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="nx">detail</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">images</span><span class="p">,</span><span class="w"> </span><span class="nx">specifications</span><span class="p">,</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">reviews</span>
<span class="nx">FR</span><span class="o">-</span><span class="mi">04</span><span class="p">:</span><span class="w"> </span><span class="nx">Shopping</span><span class="w"> </span><span class="nx">cart</span><span class="w"> </span><span class="nx">management</span><span class="w"> </span><span class="p">(</span><span class="nx">add</span><span class="p">,</span><span class="w"> </span><span class="nx">remove</span><span class="p">,</span><span class="w"> </span><span class="nx">update</span><span class="w"> </span><span class="nx">quantities</span><span class="p">)</span>
<span class="nx">FR</span><span class="o">-</span><span class="mi">05</span><span class="p">:</span><span class="w"> </span><span class="nx">Checkout</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">multiple</span><span class="w"> </span><span class="nx">payment</span><span class="w"> </span><span class="nx">methods</span>
<span class="nx">FR</span><span class="o">-</span><span class="mi">06</span><span class="p">:</span><span class="w"> </span><span class="nx">Order</span><span class="w"> </span><span class="nx">tracking</span><span class="w"> </span><span class="p">(</span><span class="nx">status</span><span class="w"> </span><span class="nx">updates</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">placement</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">delivery</span><span class="p">)</span>
<span class="nx">FR</span><span class="o">-</span><span class="mi">07</span><span class="p">:</span><span class="w"> </span><span class="nx">Seller</span><span class="w"> </span><span class="nx">management</span><span class="w"> </span><span class="p">(</span><span class="nx">sellers</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">manage</span><span class="w"> </span><span class="nx">inventory</span><span class="p">)</span>
<span class="nx">FR</span><span class="o">-</span><span class="mi">08</span><span class="p">:</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="nx">reviews</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">ratings</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="w"> </span><span class="nx">stars</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="nx">review</span><span class="p">)</span>
<span class="nx">FR</span><span class="o">-</span><span class="mi">09</span><span class="p">:</span><span class="w"> </span><span class="nx">Promotions</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">discount</span><span class="w"> </span><span class="nx">codes</span>
<span class="nx">FR</span><span class="o">-</span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="nx">Wishlist</span><span class="w"> </span><span class="p">(</span><span class="nx">customers</span><span class="w"> </span><span class="nx">save</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">later</span><span class="p">)</span>
<span class="nx">FR</span><span class="o">-</span><span class="mi">11</span><span class="p">:</span><span class="w"> </span><span class="nx">Address</span><span class="w"> </span><span class="nx">management</span><span class="w"> </span><span class="p">(</span><span class="nx">multiple</span><span class="w"> </span><span class="nx">shipping</span><span class="w"> </span><span class="nx">addresses</span><span class="w"> </span><span class="nx">per</span><span class="w"> </span><span class="nx">customer</span><span class="p">)</span>
<span class="nx">FR</span><span class="o">-</span><span class="mi">12</span><span class="p">:</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="nx">categories</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">hierarchy</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">g</span><span class="p">.,</span><span class="w"> </span><span class="nx">Electronics</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">Phones</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">Smartphones</span><span class="p">)</span>
</code></pre></div>

<h3 id="23-data-requirements">2.3 Data Requirements<a class="header-link" href="#23-data-requirements" title="Permanent link">&para;</a></h3>
<p>From the functional requirements, we extract the data entities and their key attributes:</p>
<div class="highlight"><pre><span></span><code><span class="nx">DR</span><span class="o">-</span><span class="mi">01</span><span class="p">:</span><span class="w"> </span><span class="nx">Customers</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="nx">email</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nx">hash</span><span class="p">,</span><span class="w"> </span><span class="nx">phone</span><span class="p">,</span><span class="w"> </span><span class="nx">registration</span><span class="w"> </span><span class="nx">date</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Multiple</span><span class="w"> </span><span class="nx">shipping</span><span class="w"> </span><span class="nx">addresses</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">One</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">more</span><span class="w"> </span><span class="nx">payment</span><span class="w"> </span><span class="nx">methods</span>

<span class="nx">DR</span><span class="o">-</span><span class="mi">02</span><span class="p">:</span><span class="w"> </span><span class="nx">Products</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="nx">description</span><span class="p">,</span><span class="w"> </span><span class="nx">SKU</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="p">,</span><span class="w"> </span><span class="nx">weight</span><span class="p">,</span><span class="w"> </span><span class="nx">dimensions</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Multiple</span><span class="w"> </span><span class="nx">images</span><span class="w"> </span><span class="p">(</span><span class="nx">URLs</span><span class="p">)</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Belongs</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">one</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">more</span><span class="w"> </span><span class="nx">categories</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Listed</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">exactly</span><span class="w"> </span><span class="nx">one</span><span class="w"> </span><span class="nx">seller</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Has</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">stock</span><span class="w"> </span><span class="nx">quantity</span><span class="w"> </span><span class="p">(</span><span class="nx">inventory</span><span class="p">)</span>

<span class="nx">DR</span><span class="o">-</span><span class="mi">03</span><span class="p">:</span><span class="w"> </span><span class="nx">Categories</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="nx">description</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Hierarchical</span><span class="w"> </span><span class="p">(</span><span class="nx">parent</span><span class="o">-</span><span class="nx">child</span><span class="w"> </span><span class="nx">relationship</span><span class="p">)</span>

<span class="nx">DR</span><span class="o">-</span><span class="mi">04</span><span class="p">:</span><span class="w"> </span><span class="nx">Orders</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Customer</span><span class="p">,</span><span class="w"> </span><span class="nx">shipping</span><span class="w"> </span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="nx">date</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">One</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">more</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="p">(</span><span class="nx">product</span><span class="p">,</span><span class="w"> </span><span class="nx">quantity</span><span class="p">,</span><span class="w"> </span><span class="nx">unit</span><span class="w"> </span><span class="nx">price</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">time</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">order</span><span class="p">)</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Payment</span><span class="w"> </span><span class="nx">information</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Shipping</span><span class="w"> </span><span class="nx">method</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">tracking</span><span class="w"> </span><span class="nx">number</span>

<span class="nx">DR</span><span class="o">-</span><span class="mi">05</span><span class="p">:</span><span class="w"> </span><span class="nx">Reviews</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Customer</span><span class="p">,</span><span class="w"> </span><span class="nx">product</span><span class="p">,</span><span class="w"> </span><span class="nx">rating</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">date</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Each</span><span class="w"> </span><span class="nx">customer</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">review</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">most</span><span class="w"> </span><span class="nx">once</span>

<span class="nx">DR</span><span class="o">-</span><span class="mi">06</span><span class="p">:</span><span class="w"> </span><span class="nx">Sellers</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Company</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">contact</span><span class="w"> </span><span class="nx">email</span><span class="p">,</span><span class="w"> </span><span class="nx">commission</span><span class="w"> </span><span class="nx">rate</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Bank</span><span class="w"> </span><span class="nx">account</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">payouts</span>

<span class="nx">DR</span><span class="o">-</span><span class="mi">07</span><span class="p">:</span><span class="w"> </span><span class="nx">Promotions</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Code</span><span class="p">,</span><span class="w"> </span><span class="nx">discount</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="nx">percentage</span><span class="o">/</span><span class="nx">fixed</span><span class="p">),</span><span class="w"> </span><span class="nx">amount</span><span class="p">,</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">dates</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Applicable</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">specific</span><span class="w"> </span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">categories</span><span class="p">,</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">site</span><span class="o">-</span><span class="nx">wide</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Usage</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="p">(</span><span class="nx">total</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">per</span><span class="w"> </span><span class="nx">customer</span><span class="p">)</span>
</code></pre></div>

<h3 id="24-volumetric-analysis">2.4 Volumetric Analysis<a class="header-link" href="#24-volumetric-analysis" title="Permanent link">&para;</a></h3>
<p>Understanding data volumes helps with physical design decisions:</p>
<table>
<thead>
<tr>
<th>Entity</th>
<th>Expected Volume</th>
<th>Growth Rate</th>
</tr>
</thead>
<tbody>
<tr>
<td>Customers</td>
<td>1 million</td>
<td>50K/month</td>
</tr>
<tr>
<td>Products</td>
<td>500,000</td>
<td>10K/month</td>
</tr>
<tr>
<td>Orders</td>
<td>10 million</td>
<td>500K/month</td>
</tr>
<tr>
<td>Order Items</td>
<td>25 million</td>
<td>1.25M/month</td>
</tr>
<tr>
<td>Reviews</td>
<td>2 million</td>
<td>100K/month</td>
</tr>
<tr>
<td>Categories</td>
<td>1,000</td>
<td>Rarely changes</td>
</tr>
<tr>
<td>Sellers</td>
<td>5,000</td>
<td>200/month</td>
</tr>
<tr>
<td>Promotions</td>
<td>500 active at a time</td>
<td>Seasonal peaks</td>
</tr>
</tbody>
</table>
<h3 id="25-query-patterns">2.5 Query Patterns<a class="header-link" href="#25-query-patterns" title="Permanent link">&para;</a></h3>
<p>We identify the most frequent and critical queries:</p>
<div class="highlight"><pre><span></span><code><span class="n">QP</span><span class="mo">-01</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">High</span><span class="w"> </span><span class="n">freq</span><span class="p">]</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="n">search</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">keyword</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">category</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="n">range</span>
<span class="n">QP</span><span class="mo">-02</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">High</span><span class="w"> </span><span class="n">freq</span><span class="p">]</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="n">detail</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="p">(</span><span class="n">product</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">reviews</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">seller</span><span class="p">)</span>
<span class="n">QP</span><span class="mo">-03</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">High</span><span class="w"> </span><span class="n">freq</span><span class="p">]</span><span class="w"> </span><span class="n">Shopping</span><span class="w"> </span><span class="n">cart</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">customer</span>
<span class="n">QP</span><span class="mo">-04</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">Critical</span><span class="p">]</span><span class="w">  </span><span class="n">Place</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="p">(</span><span class="n">decrement</span><span class="w"> </span><span class="n">inventory</span><span class="p">,</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">items</span><span class="p">)</span>
<span class="n">QP</span><span class="mo">-05</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">High</span><span class="w"> </span><span class="n">freq</span><span class="p">]</span><span class="w"> </span><span class="n">Order</span><span class="w"> </span><span class="n">history</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">customer</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="n">status</span><span class="p">)</span>
<span class="n">QP</span><span class="mo">-06</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">Medium</span><span class="p">]</span><span class="w">    </span><span class="n">Seller</span><span class="w"> </span><span class="n">dashboard</span><span class="w"> </span><span class="p">(</span><span class="n">orders</span><span class="p">,</span><span class="w"> </span><span class="n">revenue</span><span class="p">,</span><span class="w"> </span><span class="n">inventory</span><span class="p">)</span>
<span class="n">QP</span><span class="mo">-07</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">Medium</span><span class="p">]</span><span class="w">    </span><span class="n">Top</span><span class="o">-</span><span class="n">rated</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">category</span>
<span class="n">QP</span><span class="mi">-08</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">Low</span><span class="w"> </span><span class="n">freq</span><span class="p">]</span><span class="w">  </span><span class="n">Admin</span><span class="o">:</span><span class="w"> </span><span class="n">sales</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">category</span><span class="p">,</span><span class="w"> </span><span class="n">date</span><span class="w"> </span><span class="n">range</span>
<span class="n">QP</span><span class="mi">-09</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">Critical</span><span class="p">]</span><span class="w">  </span><span class="n">Apply</span><span class="w"> </span><span class="n">promotion</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="p">(</span><span class="n">validate</span><span class="p">,</span><span class="w"> </span><span class="n">calculate</span><span class="w"> </span><span class="n">discount</span><span class="p">)</span>
<span class="n">QP</span><span class="mi">-10</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">High</span><span class="w"> </span><span class="n">freq</span><span class="p">]</span><span class="w"> </span><span class="n">Customer</span><span class="w"> </span><span class="n">wishlist</span><span class="w"> </span><span class="n">display</span>
</code></pre></div>

<h3 id="26-non-functional-requirements">2.6 Non-Functional Requirements<a class="header-link" href="#26-non-functional-requirements" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nv">NFR</span><span class="o">-</span><span class="mi">01</span>:<span class="w"> </span><span class="nv">Response</span><span class="w"> </span><span class="nv">time</span>:<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">200</span><span class="nv">ms</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">read</span><span class="w"> </span><span class="nv">queries</span>,<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">500</span><span class="nv">ms</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">writes</span>
<span class="nv">NFR</span><span class="o">-</span><span class="mi">02</span>:<span class="w"> </span><span class="nv">Availability</span>:<span class="w"> </span><span class="mi">99</span>.<span class="mi">9</span><span class="o">%</span><span class="w"> </span><span class="k">uptime</span>
<span class="nv">NFR</span><span class="o">-</span><span class="mi">03</span>:<span class="w"> </span><span class="nv">Data</span><span class="w"> </span><span class="nv">durability</span>:<span class="w"> </span><span class="nv">no</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="nv">loss</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">orders</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">payments</span>
<span class="nv">NFR</span><span class="o">-</span><span class="mi">04</span>:<span class="w"> </span><span class="nv">Concurrency</span>:<span class="w"> </span><span class="nv">support</span><span class="w"> </span><span class="mi">10</span>,<span class="mi">000</span><span class="w"> </span><span class="nv">concurrent</span><span class="w"> </span><span class="nv">users</span>
<span class="nv">NFR</span><span class="o">-</span><span class="mi">05</span>:<span class="w"> </span><span class="nv">Scalability</span>:<span class="w"> </span><span class="nv">handle</span><span class="w"> </span><span class="mi">10</span><span class="nv">x</span><span class="w"> </span><span class="nv">growth</span><span class="w"> </span><span class="nv">over</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nv">years</span>
<span class="nv">NFR</span><span class="o">-</span><span class="mi">06</span>:<span class="w"> </span><span class="nv">Security</span>:<span class="w"> </span><span class="nv">PCI</span><span class="o">-</span><span class="nv">DSS</span><span class="w"> </span><span class="nv">compliance</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">payment</span><span class="w"> </span><span class="nv">data</span>
</code></pre></div>

<hr />
<h2 id="3-phase-2-conceptual-design-er-diagram">3. Phase 2: Conceptual Design (ER Diagram)<a class="header-link" href="#3-phase-2-conceptual-design-er-diagram" title="Permanent link">&para;</a></h2>
<h3 id="31-entity-identification">3.1 Entity Identification<a class="header-link" href="#31-entity-identification" title="Permanent link">&para;</a></h3>
<p>From the data requirements, we identify these entities:</p>
<div class="highlight"><pre><span></span><code>Strong Entities:        Weak Entities:         Associative Entities:
â”œâ”€â”€ Customer            â”œâ”€â”€ OrderItem          â”œâ”€â”€ Review
â”œâ”€â”€ Product             â”œâ”€â”€ CartItem           â”œâ”€â”€ ProductCategory
â”œâ”€â”€ Category            â”œâ”€â”€ ProductImage       â”œâ”€â”€ WishlistItem
â”œâ”€â”€ Order               â””â”€â”€ Address            â””â”€â”€ PromotionUsage
â”œâ”€â”€ Seller
â”œâ”€â”€ Promotion
â”œâ”€â”€ Cart
â””â”€â”€ PaymentMethod
</code></pre></div>

<h3 id="32-er-diagram">3.2 ER Diagram<a class="header-link" href="#32-er-diagram" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="w">                                    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">                              </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”‚</span><span class="w">   </span><span class="nx">Category</span><span class="w">   </span><span class="err">â”‚â”€â”€â”€â”€â”€â”</span>
<span class="w">                              </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">id</span><span class="w">           </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="w">                              </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">name</span><span class="w">         </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">parent_id</span>
<span class="w">                              </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">description</span><span class="w">  </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="kp">self</span><span class="o">-</span><span class="nx">ref</span><span class="p">)</span>
<span class="w">                              </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                              </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="w">                              </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">                              </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Product</span><span class="w">     </span><span class="err">â”‚</span>
<span class="w">                              </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Category</span><span class="w">    </span><span class="err">â”‚</span>
<span class="w">                              </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="nx">M</span><span class="p">:</span><span class="nx">N</span><span class="p">)</span><span class="w">       </span><span class="err">â”‚</span>
<span class="w">                              </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                              </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">        </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”</span><span class="w">        </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">   </span><span class="nx">Seller</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">1</span><span class="w">   </span><span class="nx">M</span><span class="w">  </span><span class="err">â”‚</span><span class="w">     </span><span class="nx">Product</span><span class="w">       </span><span class="err">â”‚</span><span class="w">  </span><span class="mi">1</span><span class="w">   </span><span class="nx">M</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">ProductImage</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">id</span><span class="w">           </span><span class="err">â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”‚</span><span class="w"> </span><span class="nx">id</span><span class="w">                </span><span class="err">â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”‚</span><span class="w"> </span><span class="nx">id</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">company_name</span><span class="w"> </span><span class="err">â”‚</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">name</span><span class="w">              </span><span class="err">â”‚</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">product_id</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">email</span><span class="w">        </span><span class="err">â”‚</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">description</span><span class="w">       </span><span class="err">â”‚</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">url</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">commission</span><span class="w">   </span><span class="err">â”‚</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">sku</span><span class="w">               </span><span class="err">â”‚</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">alt_text</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">bank_account</span><span class="w"> </span><span class="err">â”‚</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">price</span><span class="w">             </span><span class="err">â”‚</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">position</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">weight</span><span class="w">            </span><span class="err">â”‚</span><span class="w">        </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">stock_quantity</span><span class="w">    </span><span class="err">â”‚</span>
<span class="w">                        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">seller_id</span><span class="w"> </span><span class="p">(</span><span class="nx">FK</span><span class="p">)</span><span class="w">    </span><span class="err">â”‚</span>
<span class="w">                        </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                                 </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”</span><span class="w">   </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”</span><span class="w">   </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Review</span><span class="w">    </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">WishlistItem</span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">CartItem</span><span class="w">   </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">id</span><span class="w">         </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">id</span><span class="w">           </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">id</span><span class="w">          </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">customer_id</span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">customer_id</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">cart_id</span><span class="w">     </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">product_id</span><span class="w"> </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">product_id</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">product_id</span><span class="w">  </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">rating</span><span class="w">     </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">added_at</span><span class="w">     </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">quantity</span><span class="w">    </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">text</span><span class="w">       </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">added_at</span><span class="w">    </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">created_at</span><span class="w"> </span><span class="err">â”‚</span><span class="w">                      </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">        </span><span class="err">â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w">                              </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w">                              </span><span class="err">â”‚</span><span class="w">    </span><span class="nx">Cart</span><span class="w">     </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w">                              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">id</span><span class="w">          </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w">                              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">customer_id</span><span class="w"> </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w">                              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">created_at</span><span class="w">  </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w">                              </span><span class="err">â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w">              </span><span class="nx">Customer</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">id</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">email</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">password_hash</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">first_name</span><span class="p">,</span><span class="w"> </span><span class="nx">last_name</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">phone</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">created_at</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                     </span><span class="err">â”‚</span><span class="w">             </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w">   </span><span class="nx">Address</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">PaymentMethod</span><span class="w">  </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">id</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">id</span><span class="w">             </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">customer_id</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">customer_id</span><span class="w">    </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">label</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="k">type</span><span class="w">           </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">street</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">last_four</span><span class="w">      </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">city</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">token</span><span class="w">          </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">state</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">is_default</span><span class="w">     </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">zip_code</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">country</span><span class="w">     </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">is_default</span><span class="w">  </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                     </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w">              </span><span class="nx">Order</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">id</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">customer_id</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">shipping_address_id</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">payment_method_id</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">status</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">subtotal</span><span class="p">,</span><span class="w"> </span><span class="nx">discount</span><span class="p">,</span><span class="w"> </span><span class="nx">tax</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="w">       </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">promotion_id</span><span class="w"> </span><span class="p">(</span><span class="nx">nullable</span><span class="p">)</span><span class="w">              </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">tracking_number</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">created_at</span><span class="p">,</span><span class="w"> </span><span class="nx">updated_at</span><span class="w">               </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                         </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w">     </span><span class="nx">OrderItem</span><span class="w">       </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">id</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">order_id</span><span class="w">            </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">product_id</span><span class="w">          </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">quantity</span><span class="w">            </span><span class="err">â”‚</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">unit_price</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â†</span><span class="w"> </span><span class="nx">price</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">time</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">order</span>
<span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">subtotal</span><span class="w">            </span><span class="err">â”‚</span><span class="w">   </span><span class="p">(</span><span class="k">not</span><span class="w"> </span><span class="nx">current</span><span class="w"> </span><span class="nx">price</span><span class="p">!)</span>
<span class="w">              </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Promotion</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">id</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">code</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">discount_type</span><span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="nx">percentage</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">fixed_amount</span><span class="p">)</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">amount</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">min_purchase</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">max_uses</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">uses_count</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">valid_from</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">valid_until</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">is_active</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="33-cardinality-summary">3.3 Cardinality Summary<a class="header-link" href="#33-cardinality-summary" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Relationship</th>
<th>Cardinality</th>
<th>Participation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Customer -- Address</td>
<td>1:M</td>
<td>Total (at least one address required for ordering)</td>
</tr>
<tr>
<td>Customer -- PaymentMethod</td>
<td>1:M</td>
<td>Partial (can register without payment method)</td>
</tr>
<tr>
<td>Customer -- Order</td>
<td>1:M</td>
<td>Partial</td>
</tr>
<tr>
<td>Customer -- Review</td>
<td>1:M</td>
<td>Partial</td>
</tr>
<tr>
<td>Customer -- Cart</td>
<td>1:1</td>
<td>Partial</td>
</tr>
<tr>
<td>Customer -- WishlistItem</td>
<td>1:M</td>
<td>Partial</td>
</tr>
<tr>
<td>Order -- OrderItem</td>
<td>1:M</td>
<td>Total (order must have at least one item)</td>
</tr>
<tr>
<td>Product -- ProductImage</td>
<td>1:M</td>
<td>Partial (images optional)</td>
</tr>
<tr>
<td>Product -- Review</td>
<td>1:M</td>
<td>Partial</td>
</tr>
<tr>
<td>Product -- Category</td>
<td>M:N</td>
<td>Total (product must be in at least one category)</td>
</tr>
<tr>
<td>Seller -- Product</td>
<td>1:M</td>
<td>Total</td>
</tr>
<tr>
<td>Category -- Category (self)</td>
<td>1:M</td>
<td>Partial (root categories have no parent)</td>
</tr>
<tr>
<td>Order -- Promotion</td>
<td>M:1</td>
<td>Partial (order may have no promotion)</td>
</tr>
<tr>
<td>Customer + Product -- Review</td>
<td>Unique (one review per customer per product)</td>
<td></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="4-phase-3-logical-design-relational-schema">4. Phase 3: Logical Design (Relational Schema)<a class="header-link" href="#4-phase-3-logical-design-relational-schema" title="Permanent link">&para;</a></h2>
<h3 id="41-er-to-relational-mapping">4.1 ER-to-Relational Mapping<a class="header-link" href="#41-er-to-relational-mapping" title="Permanent link">&para;</a></h3>
<p>We apply the standard mapping rules from <a href="./04_ER_Modeling.md">Lesson 4</a>:</p>
<p><strong>Rule 1: Strong entities become tables.</strong>
<strong>Rule 2: Weak entities become tables with the owner's PK as part of their PK or as a FK.</strong>
<strong>Rule 3: 1:M relationships become FKs in the "many" side.</strong>
<strong>Rule 4: M:N relationships become junction tables.</strong></p>
<h3 id="42-complete-ddl">4.2 Complete DDL<a class="header-link" href="#42-complete-ddl" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- ============================================================</span>
<span class="c1">-- CUSTOMERS AND AUTHENTICATION</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">email</span><span class="w">           </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">password_hash</span><span class="w">   </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">first_name</span><span class="w">      </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">last_name</span><span class="w">       </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">phone</span><span class="w">           </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">addresses</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">label</span><span class="w">           </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;Home&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">-- &#39;Home&#39;, &#39;Work&#39;, etc.</span>
<span class="w">    </span><span class="n">street_line1</span><span class="w">    </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">street_line2</span><span class="w">    </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<span class="w">    </span><span class="n">city</span><span class="w">            </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">state</span><span class="w">           </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">zip_code</span><span class="w">        </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">country</span><span class="w">         </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">    </span><span class="c1">-- ISO 3166-1 alpha-2</span>
<span class="w">    </span><span class="n">is_default</span><span class="w">      </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">FALSE</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">payment_methods</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="k">type</span><span class="w">            </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;credit_card&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;debit_card&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;paypal&#39;</span><span class="p">)),</span>
<span class="w">    </span><span class="n">last_four</span><span class="w">       </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">token</span><span class="w">           </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- tokenized by payment processor</span>
<span class="w">    </span><span class="n">expires_at</span><span class="w">      </span><span class="nb">DATE</span><span class="p">,</span>
<span class="w">    </span><span class="n">is_default</span><span class="w">      </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">FALSE</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">-- ============================================================</span>
<span class="c1">-- SELLERS</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">sellers</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">company_name</span><span class="w">    </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">contact_email</span><span class="w">   </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">commission_rate</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">1500</span><span class="p">,</span><span class="w">  </span><span class="c1">-- 15.00%</span>
<span class="w">    </span><span class="n">bank_account</span><span class="w">    </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span><span class="w">  </span><span class="c1">-- encrypted or tokenized</span>
<span class="w">    </span><span class="n">is_active</span><span class="w">       </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">TRUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">-- ============================================================</span>
<span class="c1">-- PRODUCT CATALOG</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">categories</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w">            </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">slug</span><span class="w">            </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">description</span><span class="w">     </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">parent_id</span><span class="w">       </span><span class="nb">INT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">categories</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">position</span><span class="w">        </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">seller_id</span><span class="w">       </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">sellers</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">name</span><span class="w">            </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">slug</span><span class="w">            </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">description</span><span class="w">     </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">sku</span><span class="w">             </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">price</span><span class="w">           </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">price</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">weight_grams</span><span class="w">    </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">stock_quantity</span><span class="w">  </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">stock_quantity</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">is_active</span><span class="w">       </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">TRUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">product_categories</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">product_id</span><span class="w">      </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">category_id</span><span class="w">     </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">categories</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="n">category_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">product_images</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">product_id</span><span class="w">      </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span><span class="w">             </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">alt_text</span><span class="w">        </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<span class="w">    </span><span class="k">position</span><span class="w">        </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">-- ============================================================</span>
<span class="c1">-- SHOPPING CART</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">carts</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">session_id</span><span class="w">      </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span><span class="w">  </span><span class="c1">-- for anonymous carts</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">cart_owner</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">session_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cart_items</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">cart_id</span><span class="w">         </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">carts</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">product_id</span><span class="w">      </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">quantity</span><span class="w">        </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">quantity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">added_at</span><span class="w">        </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">cart_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- ============================================================</span>
<span class="c1">-- PROMOTIONS</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">promotions</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">code</span><span class="w">            </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">discount_type</span><span class="w">   </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">discount_type</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;percentage&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fixed_amount&#39;</span><span class="p">)),</span>
<span class="w">    </span><span class="n">amount</span><span class="w">          </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">min_purchase</span><span class="w">    </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">max_uses</span><span class="w">        </span><span class="nb">INT</span><span class="p">,</span><span class="w">                     </span><span class="c1">-- NULL = unlimited</span>
<span class="w">    </span><span class="n">uses_count</span><span class="w">      </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">per_customer</span><span class="w">    </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="c1">-- max uses per customer</span>
<span class="w">    </span><span class="n">valid_from</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">valid_until</span><span class="w">     </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">is_active</span><span class="w">       </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">TRUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">valid_from</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">valid_until</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- ============================================================</span>
<span class="c1">-- ORDERS</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="n">order_status</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ENUM</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;confirmed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;processing&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;shipped&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;delivered&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;refunded&#39;</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">shipping_address_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">addresses</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">payment_method_id</span><span class="w">   </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">payment_methods</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">promotion_id</span><span class="w">    </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">promotions</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">status</span><span class="w">          </span><span class="n">order_status</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">subtotal</span><span class="w">        </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">discount_amount</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">tax_amount</span><span class="w">      </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">shipping_cost</span><span class="w">   </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">total</span><span class="w">           </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">tracking_number</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">notes</span><span class="w">           </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">order_items</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">order_id</span><span class="w">        </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">orders</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">product_id</span><span class="w">      </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">quantity</span><span class="w">        </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">quantity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">unit_price</span><span class="w">      </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- price at time of order</span>
<span class="w">    </span><span class="n">subtotal</span><span class="w">        </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- quantity * unit_price</span>
<span class="w">    </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- ============================================================</span>
<span class="c1">-- REVIEWS</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">reviews</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">product_id</span><span class="w">      </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">rating</span><span class="w">          </span><span class="nb">SMALLINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">rating</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span>
<span class="w">    </span><span class="n">title</span><span class="w">           </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<span class="w">    </span><span class="n">body</span><span class="w">            </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">is_verified</span><span class="w">     </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">FALSE</span><span class="p">,</span><span class="w">  </span><span class="c1">-- verified purchase</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p">)</span><span class="w">  </span><span class="c1">-- one review per customer per product</span>
<span class="p">);</span>

<span class="c1">-- ============================================================</span>
<span class="c1">-- WISHLISTS</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">wishlist_items</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">product_id</span><span class="w">      </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">added_at</span><span class="w">        </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>

<h3 id="43-normalization-verification">4.3 Normalization Verification<a class="header-link" href="#43-normalization-verification" title="Permanent link">&para;</a></h3>
<p>Let us verify that our schema is in BCNF by analyzing the functional dependencies of key tables.</p>
<p><strong>customers table</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">FDs</span><span class="o">:</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">email</span><span class="o">,</span><span class="w"> </span><span class="n">password_hash</span><span class="o">,</span><span class="w"> </span><span class="n">first_name</span><span class="o">,</span><span class="w"> </span><span class="n">last_name</span><span class="o">,</span><span class="w"> </span><span class="n">phone</span><span class="o">,</span><span class="w"> </span><span class="n">created_at</span><span class="o">,</span><span class="w"> </span><span class="n">updated_at</span>
<span class="w">     </span><span class="n">email</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">id</span><span class="w">  </span><span class="o">(</span><span class="n">candidate</span><span class="w"> </span><span class="n">key</span><span class="o">)</span>

<span class="n">Candidate</span><span class="w"> </span><span class="n">keys</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="n">id</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="n">email</span><span class="o">}</span>
<span class="n">Both</span><span class="w"> </span><span class="n">determinants</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">superkeys</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">BCNF</span><span class="w"> </span><span class="err">âœ“</span>
</code></pre></div>

<p><strong>products table</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">FDs</span><span class="o">:</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">seller_id</span><span class="o">,</span><span class="w"> </span><span class="n">name</span><span class="o">,</span><span class="w"> </span><span class="n">slug</span><span class="o">,</span><span class="w"> </span><span class="n">description</span><span class="o">,</span><span class="w"> </span><span class="n">sku</span><span class="o">,</span><span class="w"> </span><span class="n">price</span><span class="o">,</span><span class="w"> </span><span class="n">weight_grams</span><span class="o">,</span>
<span class="w">          </span><span class="n">stock_quantity</span><span class="o">,</span><span class="w"> </span><span class="n">is_active</span><span class="o">,</span><span class="w"> </span><span class="n">created_at</span><span class="o">,</span><span class="w"> </span><span class="n">updated_at</span>
<span class="w">     </span><span class="n">sku</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">(</span><span class="n">candidate</span><span class="w"> </span><span class="n">key</span><span class="o">)</span>
<span class="w">     </span><span class="n">slug</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">(</span><span class="n">candidate</span><span class="w"> </span><span class="n">key</span><span class="o">)</span>

<span class="n">Candidate</span><span class="w"> </span><span class="n">keys</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="n">id</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="n">sku</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="n">slug</span><span class="o">}</span>
<span class="n">All</span><span class="w"> </span><span class="n">determinants</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">superkeys</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">BCNF</span><span class="w"> </span><span class="err">âœ“</span>
</code></pre></div>

<p><strong>order_items table</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">FDs</span><span class="o">:</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">order_id</span><span class="o">,</span><span class="w"> </span><span class="n">product_id</span><span class="o">,</span><span class="w"> </span><span class="n">quantity</span><span class="o">,</span><span class="w"> </span><span class="n">unit_price</span><span class="o">,</span><span class="w"> </span><span class="n">subtotal</span>
<span class="w">     </span><span class="o">(</span><span class="n">order_id</span><span class="o">,</span><span class="w"> </span><span class="n">product_id</span><span class="o">)</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">id</span><span class="o">,</span><span class="w"> </span><span class="n">quantity</span><span class="o">,</span><span class="w"> </span><span class="n">unit_price</span><span class="o">,</span><span class="w"> </span><span class="n">subtotal</span>

<span class="n">Candidate</span><span class="w"> </span><span class="n">keys</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="n">id</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="n">order_id</span><span class="o">,</span><span class="w"> </span><span class="n">product_id</span><span class="o">}</span>
<span class="n">All</span><span class="w"> </span><span class="n">determinants</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">superkeys</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">BCNF</span><span class="w"> </span><span class="err">âœ“</span>
</code></pre></div>

<p><strong>reviews table</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">FDs</span><span class="o">:</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">customer_id</span><span class="o">,</span><span class="w"> </span><span class="n">product_id</span><span class="o">,</span><span class="w"> </span><span class="n">rating</span><span class="o">,</span><span class="w"> </span><span class="n">title</span><span class="o">,</span><span class="w"> </span><span class="n">body</span><span class="o">,</span><span class="w"> </span><span class="n">is_verified</span><span class="o">,</span><span class="w"> </span><span class="n">created_at</span>
<span class="w">     </span><span class="o">(</span><span class="n">customer_id</span><span class="o">,</span><span class="w"> </span><span class="n">product_id</span><span class="o">)</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">id</span><span class="o">,</span><span class="w"> </span><span class="n">rating</span><span class="o">,</span><span class="w"> </span><span class="n">title</span><span class="o">,</span><span class="w"> </span><span class="n">body</span><span class="o">,</span><span class="w"> </span><span class="n">is_verified</span><span class="o">,</span><span class="w"> </span><span class="n">created_at</span>

<span class="n">Candidate</span><span class="w"> </span><span class="n">keys</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="n">id</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="n">customer_id</span><span class="o">,</span><span class="w"> </span><span class="n">product_id</span><span class="o">}</span>
<span class="n">All</span><span class="w"> </span><span class="n">determinants</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">superkeys</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">BCNF</span><span class="w"> </span><span class="err">âœ“</span>
</code></pre></div>

<p><strong>categories table</strong> (self-referential hierarchy):</p>
<div class="highlight"><pre><span></span><code><span class="n">FDs</span><span class="o">:</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">name</span><span class="o">,</span><span class="w"> </span><span class="n">slug</span><span class="o">,</span><span class="w"> </span><span class="n">description</span><span class="o">,</span><span class="w"> </span><span class="n">parent_id</span><span class="o">,</span><span class="w"> </span><span class="n">position</span><span class="o">,</span><span class="w"> </span><span class="n">created_at</span>
<span class="w">     </span><span class="n">slug</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">id</span>

<span class="n">Candidate</span><span class="w"> </span><span class="n">keys</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="n">id</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="n">slug</span><span class="o">}</span>
<span class="n">All</span><span class="w"> </span><span class="n">determinants</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">superkeys</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">BCNF</span><span class="w"> </span><span class="err">âœ“</span>
</code></pre></div>

<p><strong>The schema is in BCNF</strong> -- no non-trivial FD has a determinant that is not a superkey.</p>
<h3 id="44-referential-integrity-summary">4.4 Referential Integrity Summary<a class="header-link" href="#44-referential-integrity-summary" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">     </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">    </span><span class="nx">customers</span><span class="w">     </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">     </span><span class="nx">sellers</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="p">(</span><span class="nx">PK</span><span class="p">:</span><span class="w"> </span><span class="nx">id</span><span class="p">)</span><span class="w">      </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">    </span><span class="p">(</span><span class="nx">PK</span><span class="p">:</span><span class="w"> </span><span class="nx">id</span><span class="p">)</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">     </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â””â”€â”€â”€â–¶â”‚</span><span class="w">     </span><span class="nx">products</span><span class="w">       </span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">         </span><span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="nx">FK</span><span class="p">:</span><span class="w"> </span><span class="nx">seller_id</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">         </span><span class="err">â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span><span class="w">        </span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”˜</span><span class="w">        </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â–¼</span><span class="w">                      </span><span class="err">â–¼</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="nx">product_cats</span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="nx">product_images</span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â””â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">reviews</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="nx">FK</span><span class="p">:</span><span class="w"> </span><span class="nx">customer_id</span><span class="p">,</span><span class="w"> </span><span class="nx">product_id</span><span class="p">)</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">     </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">               </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">orders</span><span class="w">   </span><span class="err">â”‚â”€â”€â”€â”€â–¶â”‚</span><span class="w"> </span><span class="nx">order_items</span><span class="w">  </span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">               </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">     </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">   </span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">               </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">addresses</span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">               </span><span class="err">â”‚</span><span class="nx">pay_methods</span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">               </span><span class="err">â”‚</span><span class="w">   </span><span class="nx">carts</span><span class="w">   </span><span class="err">â”‚â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">cart_items</span>
<span class="w">   </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">                   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">wishlist</span><span class="w">  </span><span class="err">â”‚</span>
<span class="w">                   </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="5-phase-4-physical-design">5. Phase 4: Physical Design<a class="header-link" href="#5-phase-4-physical-design" title="Permanent link">&para;</a></h2>
<h3 id="51-indexing-strategy">5.1 Indexing Strategy<a class="header-link" href="#51-indexing-strategy" title="Permanent link">&para;</a></h3>
<p>We design indexes based on the query patterns identified in Phase 1.</p>
<p><strong>Primary key indexes</strong> (automatically created):</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- All tables already have PK indexes from BIGSERIAL PRIMARY KEY</span>
<span class="c1">-- Unique constraints also create indexes automatically:</span>
<span class="c1">--   customers(email), products(sku), products(slug), promotions(code)</span>
</code></pre></div>

<p><strong>Secondary indexes for frequent queries</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- QP-01: Product search by category + price range</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_products_active_price</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>

<span class="c1">-- For category-based search (through junction table)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_product_categories_category</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">product_categories</span><span class="p">(</span><span class="n">category_id</span><span class="p">);</span>

<span class="c1">-- QP-02: Product detail page (reviews for a product)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_reviews_product_rating</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">reviews</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="n">rating</span><span class="p">);</span>

<span class="c1">-- QP-03: Shopping cart for a customer</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_carts_customer</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">carts</span><span class="p">(</span><span class="n">customer_id</span><span class="p">);</span>

<span class="c1">-- QP-04: Inventory check (stock_quantity for a product)</span>
<span class="c1">-- PK on products(id) is sufficient</span>

<span class="c1">-- QP-05: Order history for a customer</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_orders_customer_date</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">orders</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">);</span>

<span class="c1">-- QP-06: Seller dashboard</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_products_seller</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">seller_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_order_items_product</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">order_items</span><span class="p">(</span><span class="n">product_id</span><span class="p">);</span>

<span class="c1">-- QP-07: Top-rated products in a category</span>
<span class="c1">-- Requires joining product_categories + reviews</span>
<span class="c1">-- The idx_reviews_product_rating and idx_product_categories_category help</span>

<span class="c1">-- QP-09: Promotion validation</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_promotions_code_active</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">promotions</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>

<span class="c1">-- QP-10: Wishlist display</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_wishlist_customer</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">wishlist_items</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">added_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">);</span>

<span class="c1">-- Full-text search for product names and descriptions</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_products_search</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">products</span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="n">GIN</span><span class="w"> </span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)));</span>
</code></pre></div>

<h3 id="52-partitioning-strategy">5.2 Partitioning Strategy<a class="header-link" href="#52-partitioning-strategy" title="Permanent link">&para;</a></h3>
<p>For tables expected to grow into hundreds of millions of rows, we apply table partitioning.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Partition orders by month (range partitioning)</span>
<span class="c1">-- This helps with:</span>
<span class="c1">--   1. Order history queries (scan only relevant months)</span>
<span class="c1">--   2. Archiving old orders (drop entire partitions)</span>
<span class="c1">--   3. Maintenance operations (VACUUM on smaller partitions)</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="c1">-- ... other columns ...</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span><span class="p">)</span><span class="w">  </span><span class="c1">-- partition key must be in PK</span>
<span class="p">)</span><span class="w"> </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">RANGE</span><span class="w"> </span><span class="p">(</span><span class="n">created_at</span><span class="p">);</span>

<span class="c1">-- Create partitions</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders_2024_01</span><span class="w"> </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">orders</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;2024-02-01&#39;</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders_2024_02</span><span class="w"> </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">orders</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;2024-02-01&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;2024-03-01&#39;</span><span class="p">);</span>
<span class="c1">-- ... (automate with pg_partman extension)</span>

<span class="c1">-- Similarly partition order_items by order date</span>
<span class="c1">-- Or use foreign key to orders which is already partitioned</span>

<span class="c1">-- Partition reviews (if they grow very large)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">reviews</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="c1">-- ...</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">)</span><span class="w"> </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">RANGE</span><span class="w"> </span><span class="p">(</span><span class="n">created_at</span><span class="p">);</span>
</code></pre></div>

<h3 id="53-denormalization-decisions">5.3 Denormalization Decisions<a class="header-link" href="#53-denormalization-decisions" title="Permanent link">&para;</a></h3>
<p>Pure normalization optimizes for storage and update consistency but can hurt read performance. We strategically denormalize where the read performance benefit outweighs the update complexity.</p>
<p><strong>Decision 1: Store unit_price in order_items</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">-- ALREADY IN SCHEMA: order_items.unit_price captures price at order time</span>
<span class="c1">-- This is NOT denormalization for performance -- it&#39;s a business requirement!</span>
<span class="c1">-- Product price may change after the order is placed.</span>
<span class="c1">-- Without this, we cannot reconstruct historical order totals.</span>
</code></pre></div>

<p><strong>Decision 2: Materialized review statistics</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Instead of computing AVG(rating) and COUNT(*) for every product page load,</span>
<span class="c1">-- store pre-computed values on the products table.</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">avg_rating</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">review_count</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="c1">-- Update via trigger or application code when a review is added/modified:</span>
<span class="c1">-- UPDATE products SET</span>
<span class="c1">--   avg_rating = (SELECT AVG(rating) FROM reviews WHERE product_id = $1),</span>
<span class="c1">--   review_count = (SELECT COUNT(*) FROM reviews WHERE product_id = $1)</span>
<span class="c1">-- WHERE id = $1;</span>
</code></pre></div>

<p><strong>Decision 3: Store total in orders</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">-- ALREADY IN SCHEMA: orders.total is stored rather than computed</span>
<span class="c1">-- Computing SUM(subtotal) from order_items on every read is wasteful</span>
<span class="c1">-- The total is fixed once the order is placed</span>
</code></pre></div>

<p><strong>Decision 4: Category path materialization</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">-- For deep category hierarchies, recursive queries are slow</span>
<span class="c1">-- Materialize the full path for display:</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">categories</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">;</span><span class="w">  </span><span class="c1">-- e.g., &quot;Electronics/Phones/Smartphones&quot;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">categories</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="c1">-- Update on category creation/move:</span>
<span class="c1">-- path = parent.path || &#39;/&#39; || name</span>
<span class="c1">-- depth = parent.depth + 1</span>
</code></pre></div>

<p><strong>Denormalization decision matrix</strong>:</p>
<table>
<thead>
<tr>
<th>Denormalization</th>
<th>Benefit</th>
<th>Cost</th>
<th>Decision</th>
</tr>
</thead>
<tbody>
<tr>
<td>avg_rating on products</td>
<td>Avoid aggregate on every product page</td>
<td>Update on review change</td>
<td>YES (high read:write ratio)</td>
</tr>
<tr>
<td>total on orders</td>
<td>Avoid SUM on every order display</td>
<td>Must match order_items</td>
<td>YES (immutable after creation)</td>
</tr>
<tr>
<td>category path</td>
<td>Avoid recursive queries</td>
<td>Update on category move</td>
<td>YES (categories change rarely)</td>
</tr>
<tr>
<td>customer name on orders</td>
<td>Avoid JOIN for order list</td>
<td>Update on name change</td>
<td>NO (JOIN is fast with index)</td>
</tr>
</tbody>
</table>
<h3 id="54-storage-considerations">5.4 Storage Considerations<a class="header-link" href="#54-storage-considerations" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Use appropriate data types for storage efficiency</span>

<span class="c1">-- GOOD: DECIMAL(10,2) for money (exact arithmetic)</span>
<span class="c1">-- BAD:  FLOAT for money (rounding errors!)</span>

<span class="c1">-- GOOD: SMALLINT for rating (1-5, uses 2 bytes)</span>
<span class="c1">-- BAD:  INT for rating (uses 4 bytes, wastes space)</span>

<span class="c1">-- GOOD: VARCHAR(2) for country codes</span>
<span class="c1">-- BAD:  TEXT for country codes (no length constraint)</span>

<span class="c1">-- GOOD: TIMESTAMPTZ for dates (timezone-aware)</span>
<span class="c1">-- BAD:  TIMESTAMP for dates (ambiguous timezone)</span>

<span class="c1">-- GOOD: ENUM for fixed status values</span>
<span class="c1">-- BAD:  VARCHAR for status (allows typos)</span>

<span class="c1">-- Estimate table sizes:</span>
<span class="c1">-- customers: 1M rows x ~300 bytes â‰ˆ 300 MB</span>
<span class="c1">-- products:  500K rows x ~500 bytes â‰ˆ 250 MB</span>
<span class="c1">-- orders:    10M rows x ~200 bytes â‰ˆ 2 GB</span>
<span class="c1">-- order_items: 25M rows x ~100 bytes â‰ˆ 2.5 GB</span>
<span class="c1">-- reviews:   2M rows x ~500 bytes â‰ˆ 1 GB</span>
<span class="c1">-- TOTAL: ~6 GB (easily fits in RAM for caching)</span>
</code></pre></div>

<hr />
<h2 id="6-phase-5-query-optimization">6. Phase 5: Query Optimization<a class="header-link" href="#6-phase-5-query-optimization" title="Permanent link">&para;</a></h2>
<h3 id="61-product-search-qp-01">6.1 Product Search (QP-01)<a class="header-link" href="#61-product-search-qp-01" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Query: Search products by keyword in a category with price filter</span>
<span class="c1">-- This is the most frequent query on the platform</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">avg_rating</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">review_count</span><span class="p">,</span>
<span class="w">       </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">product_images</span><span class="w"> </span><span class="n">pi</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">pi</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">pi</span><span class="p">.</span><span class="k">position</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">thumbnail</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">product_categories</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc</span><span class="p">.</span><span class="n">product_id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">pc</span><span class="p">.</span><span class="n">category_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">price</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">10</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="w">      </span><span class="o">@@</span><span class="w"> </span><span class="n">plainto_tsquery</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;wireless bluetooth headphones&#39;</span><span class="p">)</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">avg_rating</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="n">NULLS</span><span class="w"> </span><span class="k">LAST</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>

<p><strong>Explain plan analysis</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">EXPLAIN</span><span class="w"> </span><span class="p">(</span><span class="n">ANALYZE</span><span class="p">,</span><span class="w"> </span><span class="n">BUFFERS</span><span class="p">)</span>
<span class="o">--</span><span class="w"> </span><span class="n">Expected</span><span class="w"> </span><span class="n">plan</span><span class="o">:</span>
<span class="o">--</span><span class="w"> </span><span class="kr">Limit</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="p">...</span><span class="w"> </span><span class="n">rows</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="o">--</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="nf">Sort</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="p">...</span><span class="w"> </span><span class="n">key</span><span class="o">:</span><span class="w"> </span><span class="n">avg_rating</span><span class="w"> </span><span class="n">DESC</span><span class="p">)</span>
<span class="o">--</span><span class="w">     </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Nested</span><span class="w"> </span><span class="nf">Loop</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="p">...)</span>
<span class="o">--</span><span class="w">       </span><span class="o">-&gt;</span><span class="w"> </span><span class="nf">Index</span><span class="w"> </span><span class="kr">Scan</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">product_categories</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="p">(</span><span class="n">category_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span>
<span class="o">--</span><span class="w">       </span><span class="o">-&gt;</span><span class="w"> </span><span class="nf">Index</span><span class="w"> </span><span class="kr">Scan</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc</span><span class="p">.</span><span class="n">product_id</span><span class="p">)</span>
<span class="o">--</span><span class="w">            </span><span class="n">Filter</span><span class="o">:</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="kr">AND</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="kr">BETWEEN</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="kr">AND</span><span class="w"> </span><span class="mi">100</span>
<span class="o">--</span><span class="w">            </span><span class="n">Filter</span><span class="o">:</span><span class="w"> </span><span class="n">tsvector</span><span class="w"> </span><span class="err">@@</span><span class="w"> </span><span class="n">tsquery</span>
</code></pre></div>

<p><strong>Optimization</strong>: Create a composite GIN index that covers both full-text search and category:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- If category-based full-text search is the dominant pattern:</span>
<span class="c1">-- Consider a materialized view that pre-joins products and categories</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">MATERIALIZED</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">product_search</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">avg_rating</span><span class="p">,</span>
<span class="w">       </span><span class="n">p</span><span class="p">.</span><span class="n">review_count</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">is_active</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="p">.</span><span class="n">category_id</span><span class="p">,</span>
<span class="w">       </span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">search_vector</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">product_categories</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc</span><span class="p">.</span><span class="n">product_id</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_product_search_category</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">product_search</span><span class="p">(</span><span class="n">category_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_product_search_fts</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">product_search</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">GIN</span><span class="p">(</span><span class="n">search_vector</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_product_search_price</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">product_search</span><span class="p">(</span><span class="n">category_id</span><span class="p">,</span><span class="w"> </span><span class="n">price</span><span class="p">)</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>

<span class="c1">-- Refresh periodically or on product changes</span>
<span class="n">REFRESH</span><span class="w"> </span><span class="n">MATERIALIZED</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">CONCURRENTLY</span><span class="w"> </span><span class="n">product_search</span><span class="p">;</span>
</code></pre></div>

<h3 id="62-product-detail-page-qp-02">6.2 Product Detail Page (QP-02)<a class="header-link" href="#62-product-detail-page-qp-02" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Fetch product with images, seller, and review summary in one query</span>
<span class="k">SELECT</span>
<span class="w">  </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">sku</span><span class="p">,</span>
<span class="w">  </span><span class="n">p</span><span class="p">.</span><span class="n">stock_quantity</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">avg_rating</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">review_count</span><span class="p">,</span>
<span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">company_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">seller_name</span><span class="p">,</span>
<span class="w">  </span><span class="n">json_agg</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">jsonb_build_object</span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;url&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">pi</span><span class="p">.</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;alt_text&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">pi</span><span class="p">.</span><span class="n">alt_text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;position&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">pi</span><span class="p">.</span><span class="k">position</span>
<span class="w">  </span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">images</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">sellers</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">seller_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">id</span>
<span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">product_images</span><span class="w"> </span><span class="n">pi</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pi</span><span class="p">.</span><span class="n">product_id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>

<span class="c1">-- Fetch reviews separately (paginated)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">rating</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">created_at</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">is_verified</span><span class="p">,</span>
<span class="w">       </span><span class="k">c</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">LEFT</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">reviewer</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">reviews</span><span class="w"> </span><span class="n">r</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span><span class="p">;</span>
</code></pre></div>

<h3 id="63-order-history-qp-05">6.3 Order History (QP-05)<a class="header-link" href="#63-order-history-qp-05" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Customer&#39;s recent orders with item summary</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">total</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">created_at</span><span class="p">,</span>
<span class="w">       </span><span class="k">COUNT</span><span class="p">(</span><span class="n">oi</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">item_count</span><span class="p">,</span>
<span class="w">       </span><span class="n">STRING_AGG</span><span class="p">(</span><span class="k">LEFT</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;, &#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">oi</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">item_preview</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">order_items</span><span class="w"> </span><span class="n">oi</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oi</span><span class="p">.</span><span class="n">order_id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">oi</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span><span class="p">;</span>

<span class="c1">-- Uses index: idx_orders_customer_date (customer_id, created_at DESC)</span>
<span class="c1">-- Partition pruning: if querying recent orders, only scans recent partitions</span>
</code></pre></div>

<h3 id="64-seller-dashboard-qp-06">6.4 Seller Dashboard (QP-06)<a class="header-link" href="#64-seller-dashboard-qp-06" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Seller&#39;s monthly revenue and order count</span>
<span class="k">SELECT</span>
<span class="w">  </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">created_at</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">month</span><span class="p">,</span>
<span class="w">  </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">order_count</span><span class="p">,</span>
<span class="w">  </span><span class="k">SUM</span><span class="p">(</span><span class="n">oi</span><span class="p">.</span><span class="n">subtotal</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">revenue</span><span class="p">,</span>
<span class="w">  </span><span class="k">SUM</span><span class="p">(</span><span class="n">oi</span><span class="p">.</span><span class="n">subtotal</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">commission_rate</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">commission</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">sellers</span><span class="w"> </span><span class="n">s</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">seller_id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">order_items</span><span class="w"> </span><span class="n">oi</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oi</span><span class="p">.</span><span class="n">product_id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">oi</span><span class="p">.</span><span class="n">order_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span><span class="w">  </span><span class="c1">-- start date</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="err">$</span><span class="mi">3</span><span class="w">   </span><span class="c1">-- end date</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;cancelled&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;refunded&#39;</span><span class="p">)</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">month</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">month</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</code></pre></div>

<h3 id="65-query-performance-summary">6.5 Query Performance Summary<a class="header-link" href="#65-query-performance-summary" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Query</th>
<th>Expected Latency</th>
<th>Key Index</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Product search</td>
<td>&lt; 50ms</td>
<td>GIN (FTS) + category</td>
<td>Materialized view helps</td>
</tr>
<tr>
<td>Product detail</td>
<td>&lt; 10ms</td>
<td>PK + seller FK</td>
<td>Single row + images</td>
</tr>
<tr>
<td>Cart contents</td>
<td>&lt; 5ms</td>
<td>carts(customer_id)</td>
<td>Small result set</td>
</tr>
<tr>
<td>Place order</td>
<td>&lt; 100ms</td>
<td>Inventory check + insert</td>
<td>Transaction (see Phase 6)</td>
</tr>
<tr>
<td>Order history</td>
<td>&lt; 20ms</td>
<td>orders(customer_id, date)</td>
<td>Partition pruning</td>
</tr>
<tr>
<td>Seller dashboard</td>
<td>&lt; 200ms</td>
<td>products(seller_id) + order_items(product_id)</td>
<td>Aggregate query</td>
</tr>
<tr>
<td>Top rated products</td>
<td>&lt; 30ms</td>
<td>product_categories + avg_rating</td>
<td>Uses denormalized rating</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7-phase-6-transaction-design">7. Phase 6: Transaction Design<a class="header-link" href="#7-phase-6-transaction-design" title="Permanent link">&para;</a></h2>
<h3 id="71-critical-transaction-place-order">7.1 Critical Transaction: Place Order<a class="header-link" href="#71-critical-transaction-place-order" title="Permanent link">&para;</a></h3>
<p>This is the most complex and important transaction in the system. It must:
1. Validate cart items are in stock
2. Calculate totals (with potential promotion)
3. Decrement inventory
4. Create the order and order items
5. Clear the cart
6. Process payment (external API call)</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Isolation level: SERIALIZABLE or READ COMMITTED with explicit locking</span>
<span class="c1">-- We use READ COMMITTED + explicit locking for better performance</span>

<span class="k">BEGIN</span><span class="p">;</span>

<span class="c1">-- Step 1: Lock cart items to prevent concurrent modifications</span>
<span class="c1">-- Also lock the product rows to prevent overselling</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">stock_quantity</span><span class="p">,</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">quantity</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">cart_items</span><span class="w"> </span><span class="n">ci</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">cart_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">cart_id</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w">  </span><span class="c1">-- locks product rows</span>

<span class="c1">-- Step 2: Validate stock (application checks: stock_quantity &gt;= ci.quantity)</span>
<span class="c1">-- If any item is out of stock, ROLLBACK and inform the customer</span>

<span class="c1">-- Step 3: Apply promotion (if any)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">discount_type</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">min_purchase</span><span class="p">,</span><span class="w"> </span><span class="n">max_uses</span><span class="p">,</span><span class="w"> </span><span class="n">uses_count</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">promotions</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">promo_code</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">valid_from</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">valid_until</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="p">;</span><span class="w">  </span><span class="c1">-- lock to prevent concurrent usage beyond max_uses</span>

<span class="c1">-- Step 4: Create order</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">shipping_address_id</span><span class="p">,</span><span class="w"> </span><span class="n">payment_method_id</span><span class="p">,</span>
<span class="w">                    </span><span class="n">promotion_id</span><span class="p">,</span><span class="w"> </span><span class="n">subtotal</span><span class="p">,</span><span class="w"> </span><span class="n">discount_amount</span><span class="p">,</span><span class="w"> </span><span class="n">tax_amount</span><span class="p">,</span>
<span class="w">                    </span><span class="n">shipping_cost</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">address_id</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">payment_id</span><span class="p">,</span>
<span class="w">        </span><span class="err">$</span><span class="n">promo_id</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">subtotal</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">discount</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">tax</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">shipping</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">total</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">)</span>
<span class="n">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">order_id</span><span class="p">;</span>

<span class="c1">-- Step 5: Create order items and decrement inventory</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">order_items</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="n">quantity</span><span class="p">,</span><span class="w"> </span><span class="n">unit_price</span><span class="p">,</span><span class="w"> </span><span class="n">subtotal</span><span class="p">)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="err">$</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">quantity</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">quantity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">price</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">cart_items</span><span class="w"> </span><span class="n">ci</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">cart_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">cart_id</span><span class="p">;</span>

<span class="k">UPDATE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span>
<span class="k">SET</span><span class="w"> </span><span class="n">stock_quantity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stock_quantity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">quantity</span><span class="p">,</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">cart_items</span><span class="w"> </span><span class="n">ci</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">product_id</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">cart_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">cart_id</span><span class="p">;</span>

<span class="c1">-- Step 6: Update promotion usage count</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">promotions</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">uses_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uses_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">promo_id</span><span class="p">;</span>

<span class="c1">-- Step 7: Clear cart</span>
<span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cart_items</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">cart_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">cart_id</span><span class="p">;</span>

<span class="c1">-- Step 8: Process payment (external API call)</span>
<span class="c1">-- NOTE: This should happen OUTSIDE the transaction or use the Saga pattern</span>
<span class="c1">-- If payment fails, the entire transaction rolls back</span>

<span class="k">COMMIT</span><span class="p">;</span>
</code></pre></div>

<p><strong>Important design decision</strong>: The payment API call should NOT be inside the database transaction because:
1. External API calls can be slow (seconds), holding locks too long
2. If the DB commits but the payment fails, we have an inconsistent state</p>
<p><strong>Better approach: Saga pattern</strong></p>
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">BEGIN</span><span class="p">;</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="ow">or</span><span class="n">der</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="err">&#39;</span><span class="n">pending_payment</span><span class="err">&#39;</span><span class="p">;</span><span class="w"> </span><span class="n">decrement</span><span class="w"> </span><span class="n">stock</span><span class="p">;</span><span class="w"> </span><span class="n">COMMIT</span><span class="p">;</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Call</span><span class="w"> </span><span class="n">payment</span><span class="w"> </span><span class="n">API</span>
<span class="mf">3.</span><span class="w"> </span><span class="kr">If</span><span class="w"> </span><span class="n">payment</span><span class="w"> </span><span class="n">succeeds</span><span class="p">:</span><span class="w"> </span><span class="n">UPDATE</span><span class="w"> </span><span class="ow">or</span><span class="n">ders</span><span class="w"> </span><span class="n">SET</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="err">&#39;</span><span class="n">confirmed</span><span class="err">&#39;</span><span class="w"> </span><span class="n">WHERE</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="n">id</span><span class="p">;</span>
<span class="mf">4.</span><span class="w"> </span><span class="kr">If</span><span class="w"> </span><span class="n">payment</span><span class="w"> </span><span class="n">fails</span><span class="p">:</span><span class="w"> </span><span class="n">UPDATE</span><span class="w"> </span><span class="ow">or</span><span class="n">ders</span><span class="w"> </span><span class="n">SET</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="err">&#39;</span><span class="n">payment_failed</span><span class="err">&#39;</span><span class="w"> </span><span class="n">WHERE</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="n">id</span><span class="p">;</span>
<span class="w">                     </span><span class="kd">Restore</span><span class="w"> </span><span class="n">inventory</span><span class="w"> </span><span class="p">(</span><span class="n">compensating</span><span class="w"> </span><span class="n">transaction</span><span class="p">)</span>
</code></pre></div>

<h3 id="72-isolation-level-decisions">7.2 Isolation Level Decisions<a class="header-link" href="#72-isolation-level-decisions" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Transaction</th>
<th>Isolation Level</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr>
<td>Place order</td>
<td>READ COMMITTED + FOR UPDATE</td>
<td>Explicit locking prevents overselling; RC is faster than Serializable</td>
</tr>
<tr>
<td>Browse products</td>
<td>READ COMMITTED</td>
<td>Slight staleness is acceptable for catalog</td>
</tr>
<tr>
<td>View order history</td>
<td>READ COMMITTED</td>
<td>Historical data, no write conflicts</td>
</tr>
<tr>
<td>Submit review</td>
<td>READ COMMITTED + UNIQUE constraint</td>
<td>UNIQUE(customer_id, product_id) prevents duplicates</td>
</tr>
<tr>
<td>Apply promotion</td>
<td>READ COMMITTED + FOR UPDATE</td>
<td>Lock promotion row to prevent exceeding max_uses</td>
</tr>
<tr>
<td>Admin reports</td>
<td>REPEATABLE READ</td>
<td>Consistent snapshot for long-running aggregation queries</td>
</tr>
</tbody>
</table>
<h3 id="73-locking-strategy">7.3 Locking Strategy<a class="header-link" href="#73-locking-strategy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Prevent overselling: use SELECT FOR UPDATE on product rows</span>
<span class="c1">-- This acquires row-level exclusive locks</span>

<span class="c1">-- Ordered locking to prevent deadlocks:</span>
<span class="c1">-- Always lock products in id order when updating multiple products</span>

<span class="c1">-- Example: if cart has products [42, 17, 88], lock in order [17, 42, 88]</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">stock_quantity</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">products</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="mi">88</span><span class="p">)</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">id</span><span class="w">    </span><span class="c1">-- consistent ordering prevents deadlocks</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="p">;</span>
</code></pre></div>

<h3 id="74-concurrency-scenarios">7.4 Concurrency Scenarios<a class="header-link" href="#74-concurrency-scenarios" title="Permanent link">&para;</a></h3>
<p><strong>Scenario 1: Two customers order the last item</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">Customer</span><span class="w"> </span><span class="n">A</span><span class="w">                              </span><span class="n">Customer</span><span class="w"> </span><span class="n">B</span>
<span class="k">BEGIN</span><span class="w">                                   </span><span class="k">BEGIN</span>
<span class="k">SELECT</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="p">(</span><span class="n">stock</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">âœ“</span><span class="w">       </span><span class="k">SELECT</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">â†’</span><span class="w"> </span><span class="n">BLOCKS</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">0</span><span class="w">                        </span><span class="p">(</span><span class="n">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">A</span><span class="s1">&#39;s lock)</span>
<span class="s1">INSERT order_item                       ...</span>
<span class="s1">COMMIT â†’ releases lock                  â†’ unblocked, reads stock=0</span>
<span class="s1">                                        â†’ stock &lt; quantity â†’ ROLLBACK</span>
<span class="s1">                                        â†’ &quot;Item out of stock&quot; message</span>
</code></pre></div>

<p><strong>Scenario 2: Customer updates cart while checking out</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">Checkout</span> <span class="n">Transaction</span>              <span class="n">Cart</span> <span class="n">Update</span>
<span class="kr">BEGIN</span>                             <span class="kr">BEGIN</span>
<span class="n">SELECT</span> <span class="n">cart_items</span> <span class="kr">FOR</span> <span class="n">UPDATE</span> <span class="err">âœ“</span>    <span class="n">UPDATE</span> <span class="n">cart_items</span> <span class="err">â†’</span> <span class="n">BLOCKS</span>
<span class="p">...</span>                               <span class="p">(</span><span class="n">waiting</span> <span class="n">for</span> <span class="n">checkout</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">...</span><span class="n">processes</span> <span class="n">order</span><span class="p">...</span>             <span class="p">...</span>
<span class="n">DELETE</span> <span class="n">cart_items</span>                  <span class="p">...</span>
<span class="n">COMMIT</span> <span class="err">â†’</span> <span class="n">releases</span> <span class="n">lock</span>            <span class="err">â†’</span> <span class="n">row</span> <span class="n">deleted</span><span class="p">,</span> <span class="n">update</span> <span class="n">affects</span> <span class="mi">0</span> <span class="n">rows</span>
                                  <span class="err">â†’</span> <span class="n">COMMIT</span> <span class="p">(</span><span class="n">no</span> <span class="n">error</span><span class="p">,</span> <span class="n">but</span> <span class="n">cart</span> <span class="n">is</span> <span class="n">empty</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="8-alternative-case-study-social-media-platform">8. Alternative Case Study: Social Media Platform<a class="header-link" href="#8-alternative-case-study-social-media-platform" title="Permanent link">&para;</a></h2>
<h3 id="81-requirements-summary">8.1 Requirements Summary<a class="header-link" href="#81-requirements-summary" title="Permanent link">&para;</a></h3>
<p><strong>SocialBuzz</strong> is a social media platform supporting posts, follows, likes, and a personalized feed.</p>
<h3 id="82-key-entities">8.2 Key Entities<a class="header-link" href="#82-key-entities" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">          </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">username</span><span class="w">    </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">email</span><span class="w">       </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">display_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">bio</span><span class="w">         </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">avatar_url</span><span class="w">  </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">  </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">follows</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">follower_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">followee_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">  </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">follower_id</span><span class="p">,</span><span class="w"> </span><span class="n">followee_id</span><span class="p">),</span>
<span class="w">    </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">follower_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">followee_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">posts</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">          </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">user_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">content</span><span class="w">     </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">media_urls</span><span class="w">  </span><span class="nb">TEXT</span><span class="p">[],</span><span class="w">  </span><span class="c1">-- array of media URLs</span>
<span class="w">    </span><span class="n">like_count</span><span class="w">  </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">      </span><span class="c1">-- denormalized</span>
<span class="w">    </span><span class="n">comment_count</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">    </span><span class="c1">-- denormalized</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">  </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">likes</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">user_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">post_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">posts</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">  </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">post_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">comments</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">          </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">post_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">posts</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">user_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">parent_id</span><span class="w">   </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">comments</span><span class="p">(</span><span class="n">id</span><span class="p">),</span><span class="w">  </span><span class="c1">-- threaded comments</span>
<span class="w">    </span><span class="n">content</span><span class="w">     </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">  </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>

<h3 id="83-the-feed-problem">8.3 The Feed Problem<a class="header-link" href="#83-the-feed-problem" title="Permanent link">&para;</a></h3>
<p>The most challenging query is the personalized feed: "Show recent posts from people I follow."</p>
<p><strong>Pull model</strong> (fan-out on read):</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- At read time, query posts from all followed users</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">display_name</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">avatar_url</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">posts</span><span class="w"> </span><span class="n">p</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">follows</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">followee_id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">follower_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">current_user_id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>

<span class="c1">-- Problem: If a user follows 1000 people, this JOINs a large follows list</span>
<span class="c1">-- with a large posts table. Slow for active users.</span>
</code></pre></div>

<p><strong>Push model</strong> (fan-out on write):</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Create a feed table (denormalized timeline)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">feed_items</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">user_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- the user whose feed this is</span>
<span class="w">    </span><span class="n">post_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">author_id</span><span class="w">   </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">  </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">post_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- When user X creates a post:</span>
<span class="c1">-- Insert a feed_item for EVERY follower of X</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">feed_items</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">post_id</span><span class="p">,</span><span class="w"> </span><span class="n">author_id</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span><span class="p">)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">follower_id</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">post_id</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">author_id</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">created_at</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">follows</span><span class="w"> </span><span class="n">f</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">followee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">author_id</span><span class="p">;</span>

<span class="c1">-- Reading the feed is now trivial:</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">fi</span><span class="p">.</span><span class="n">post_id</span><span class="p">,</span><span class="w"> </span><span class="n">fi</span><span class="p">.</span><span class="n">author_id</span><span class="p">,</span><span class="w"> </span><span class="n">fi</span><span class="p">.</span><span class="n">created_at</span><span class="p">,</span>
<span class="w">       </span><span class="n">p</span><span class="p">.</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">media_urls</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">like_count</span><span class="p">,</span>
<span class="w">       </span><span class="n">u</span><span class="p">.</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">avatar_url</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">feed_items</span><span class="w"> </span><span class="n">fi</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">posts</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">fi</span><span class="p">.</span><span class="n">post_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">fi</span><span class="p">.</span><span class="n">author_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">fi</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">current_user_id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">fi</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>

<span class="c1">-- Problem: If a celebrity has 10 million followers, creating a post</span>
<span class="c1">-- requires 10 million INSERT operations. Slow for popular users.</span>
</code></pre></div>

<p><strong>Hybrid model</strong> (used by Twitter/X):</p>
<div class="highlight"><pre><span></span><code>Regular users (&lt; 10K followers): Push model (fan-out on write)
Celebrity users (&gt; 10K followers): Pull model (fan-out on read)

Feed = Merge(feed_items table, live query for followed celebrities)
</code></pre></div>

<h3 id="84-design-tradeoffs">8.4 Design Tradeoffs<a class="header-link" href="#84-design-tradeoffs" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>E-Commerce</th>
<th>Social Media</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Critical transaction</strong></td>
<td>Place order (ACID required)</td>
<td>Post creation (eventual consistency OK)</td>
</tr>
<tr>
<td><strong>Primary read pattern</strong></td>
<td>Product lookup by ID</td>
<td>Timeline (feed)</td>
</tr>
<tr>
<td><strong>Write pattern</strong></td>
<td>Low frequency, high value</td>
<td>High frequency, low value</td>
</tr>
<tr>
<td><strong>Denormalization</strong></td>
<td>Moderate (avg_rating, totals)</td>
<td>Heavy (feed_items, counters)</td>
</tr>
<tr>
<td><strong>Consistency</strong></td>
<td>Strong (inventory, payments)</td>
<td>Eventual (like counts, feeds)</td>
</tr>
<tr>
<td><strong>Scale challenge</strong></td>
<td>Inventory contention</td>
<td>Fan-out (popular users)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="9-design-review-checklist">9. Design Review Checklist<a class="header-link" href="#9-design-review-checklist" title="Permanent link">&para;</a></h2>
<p>Use this checklist before deploying any database design to production:</p>
<h3 id="91-schema-design">9.1 Schema Design<a class="header-link" href="#91-schema-design" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">Every</span><span class="w"> </span><span class="nx">table</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">clear</span><span class="w"> </span><span class="nx">primary</span><span class="w"> </span><span class="nx">key</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">Foreign</span><span class="w"> </span><span class="nx">keys</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">defined</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nx">relationships</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">ON</span><span class="w"> </span><span class="nx">DELETE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">ON</span><span class="w"> </span><span class="nx">UPDATE</span><span class="w"> </span><span class="nx">actions</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">specified</span><span class="w"> </span><span class="p">(</span><span class="nx">CASCADE</span><span class="p">,</span><span class="w"> </span><span class="nx">SET</span><span class="w"> </span><span class="nx">NULL</span><span class="p">,</span><span class="w"> </span><span class="nx">RESTRICT</span><span class="p">)</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">NOT</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="nx">constraints</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">required</span><span class="w"> </span><span class="nx">fields</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">CHECK</span><span class="w"> </span><span class="nx">constraints</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">validation</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">g</span><span class="p">.,</span><span class="w"> </span><span class="nx">price</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">rating</span><span class="w"> </span><span class="nx">BETWEEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nx">AND</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">UNIQUE</span><span class="w"> </span><span class="nx">constraints</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">natural</span><span class="w"> </span><span class="nx">keys</span><span class="w"> </span><span class="p">(</span><span class="nx">email</span><span class="p">,</span><span class="w"> </span><span class="nx">username</span><span class="p">,</span><span class="w"> </span><span class="nx">SKU</span><span class="p">)</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">Appropriate</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="nx">types</span><span class="w"> </span><span class="p">(</span><span class="nx">DECIMAL</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">money</span><span class="p">,</span><span class="w"> </span><span class="nx">TIMESTAMPTZ</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">dates</span><span class="p">)</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">No</span><span class="w"> </span><span class="nx">redundant</span><span class="w"> </span><span class="nx">columns</span><span class="w"> </span><span class="nx">unless</span><span class="w"> </span><span class="nx">denormalization</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">documented</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">justified</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">Schema</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">least</span><span class="w"> </span><span class="mi">3</span><span class="nx">NF</span><span class="w"> </span><span class="p">(</span><span class="nx">preferably</span><span class="w"> </span><span class="nx">BCNF</span><span class="p">)</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="k">Self</span><span class="o">-</span><span class="nx">referential</span><span class="w"> </span><span class="nx">FKs</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">hierarchies</span><span class="w"> </span><span class="p">(</span><span class="nx">categories</span><span class="p">,</span><span class="w"> </span><span class="nx">comments</span><span class="p">)</span>
</code></pre></div>

<h3 id="92-indexing">9.2 Indexing<a class="header-link" href="#92-indexing" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>[ ] Indexes exist for all foreign keys (PostgreSQL does NOT auto-create FK indexes!)
[ ] Indexes cover the WHERE, JOIN, and ORDER BY columns of frequent queries
[ ] Composite indexes follow the left-prefix rule
[ ] Partial indexes used where appropriate (WHERE is_active = TRUE)
[ ] GIN indexes for full-text search and array columns
[ ] No redundant indexes (index on (a, b) makes index on (a) redundant)
[ ] Index bloat monitoring plan in place
</code></pre></div>

<h3 id="93-data-integrity">9.3 Data Integrity<a class="header-link" href="#93-data-integrity" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nx">money</span><span class="w"> </span><span class="nx">values</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">DECIMAL</span><span class="p">,</span><span class="w"> </span><span class="nx">never</span><span class="w"> </span><span class="nx">FLOAT</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">Timestamps</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">TIMESTAMPTZ</span><span class="w"> </span><span class="p">(</span><span class="nx">timezone</span><span class="o">-</span><span class="nx">aware</span><span class="p">)</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">Enum</span><span class="w"> </span><span class="nx">types</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">CHECK</span><span class="w"> </span><span class="nx">constraints</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="nx">fields</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">Immutable</span><span class="w"> </span><span class="nx">fields</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="k">protected</span><span class="w"> </span><span class="p">(</span><span class="nx">order</span><span class="w"> </span><span class="nx">totals</span><span class="p">,</span><span class="w"> </span><span class="nx">historical</span><span class="w"> </span><span class="nx">prices</span><span class="p">)</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">Soft</span><span class="w"> </span><span class="nx">delete</span><span class="w"> </span><span class="nx">vs</span><span class="w"> </span><span class="nx">hard</span><span class="w"> </span><span class="nx">delete</span><span class="w"> </span><span class="nx">decision</span><span class="w"> </span><span class="nx">documented</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">each</span><span class="w"> </span><span class="nx">table</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">Data</span><span class="w"> </span><span class="nx">retention</span><span class="w"> </span><span class="nx">policy</span><span class="w"> </span><span class="nx">defined</span>
</code></pre></div>

<h3 id="94-performance">9.4 Performance<a class="header-link" href="#94-performance" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>[ ] EXPLAIN ANALYZE run on all critical queries
[ ] No sequential scans on large tables for indexed queries
[ ] Pagination uses keyset pagination, not OFFSET
[ ] N+1 query patterns eliminated (use JOINs or batch fetching)
[ ] Connection pooling configured (PgBouncer)
[ ] Appropriate work_mem and shared_buffers settings
</code></pre></div>

<h3 id="95-transactions">9.5 Transactions<a class="header-link" href="#95-transactions" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">Isolation</span><span class="w"> </span><span class="nx">level</span><span class="w"> </span><span class="nx">chosen</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">each</span><span class="w"> </span><span class="nx">transaction</span><span class="w"> </span><span class="k">type</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">Locking</span><span class="w"> </span><span class="nx">strategy</span><span class="w"> </span><span class="nx">documented</span><span class="w"> </span><span class="p">(</span><span class="nx">which</span><span class="w"> </span><span class="nx">rows</span><span class="o">/</span><span class="nx">tables</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">locked</span><span class="p">)</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">Lock</span><span class="w"> </span><span class="nx">ordering</span><span class="w"> </span><span class="nx">defined</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">prevent</span><span class="w"> </span><span class="nx">deadlocks</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">Long</span><span class="o">-</span><span class="nx">running</span><span class="w"> </span><span class="nx">transactions</span><span class="w"> </span><span class="nx">avoided</span><span class="w"> </span><span class="p">(</span><span class="nx">no</span><span class="w"> </span><span class="nx">API</span><span class="w"> </span><span class="nx">calls</span><span class="w"> </span><span class="nx">inside</span><span class="w"> </span><span class="nx">transactions</span><span class="p">)</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">Retry</span><span class="w"> </span><span class="nx">logic</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">serialization</span><span class="w"> </span><span class="nx">failures</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="nx">Deadlock</span><span class="w"> </span><span class="nx">detection</span><span class="w"> </span><span class="nx">timeout</span><span class="w"> </span><span class="nx">configured</span>
</code></pre></div>

<h3 id="96-security">9.6 Security<a class="header-link" href="#96-security" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>[<span class="w"> </span>]<span class="w"> </span><span class="nv">No</span><span class="w"> </span><span class="nv">plaintext</span><span class="w"> </span><span class="nv">passwords</span><span class="w"> </span><span class="ss">(</span><span class="nv">use</span><span class="w"> </span><span class="nv">bcrypt</span><span class="o">/</span><span class="nv">argon2</span><span class="w"> </span><span class="nv">hashes</span><span class="ss">)</span>
[<span class="w"> </span>]<span class="w"> </span><span class="nv">Payment</span><span class="w"> </span><span class="nv">tokens</span><span class="w"> </span><span class="nv">stored</span>,<span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">card</span><span class="w"> </span><span class="nv">numbers</span><span class="w"> </span><span class="ss">(</span><span class="nv">PCI</span><span class="o">-</span><span class="nv">DSS</span><span class="ss">)</span>
[<span class="w"> </span>]<span class="w"> </span><span class="nv">Row</span><span class="o">-</span><span class="nv">Level</span><span class="w"> </span><span class="nv">Security</span><span class="w"> </span><span class="ss">(</span><span class="nv">RLS</span><span class="ss">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">multi</span><span class="o">-</span><span class="nv">tenant</span><span class="w"> </span><span class="nv">data</span>
[<span class="w"> </span>]<span class="w"> </span><span class="nv">Application</span><span class="w"> </span><span class="nv">user</span><span class="w"> </span><span class="nv">has</span><span class="w"> </span><span class="nv">minimal</span><span class="w"> </span><span class="nv">privileges</span><span class="w"> </span><span class="ss">(</span><span class="nv">no</span><span class="w"> </span><span class="nv">SUPERUSER</span><span class="ss">)</span>
[<span class="w"> </span>]<span class="w"> </span><span class="nv">SQL</span><span class="w"> </span><span class="nv">injection</span><span class="w"> </span><span class="nv">prevented</span><span class="w"> </span><span class="ss">(</span><span class="nv">parameterized</span><span class="w"> </span><span class="nv">queries</span><span class="w"> </span><span class="nv">only</span><span class="ss">)</span>
[<span class="w"> </span>]<span class="w"> </span><span class="nv">Audit</span><span class="w"> </span><span class="nv">logging</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">sensitive</span><span class="w"> </span><span class="nv">operations</span>
</code></pre></div>

<h3 id="97-operations">9.7 Operations<a class="header-link" href="#97-operations" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Backup</span><span class="w"> </span><span class="n">strategy</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="p">(</span><span class="n">pg_dump</span><span class="w"> </span><span class="n">schedule</span><span class="p">,</span><span class="w"> </span><span class="n">WAL</span><span class="w"> </span><span class="n">archiving</span><span class="p">)</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Point</span><span class="o">-</span><span class="ow">in</span><span class="o">-</span><span class="n">time</span><span class="w"> </span><span class="n">recovery</span><span class="w"> </span><span class="p">(</span><span class="n">PITR</span><span class="p">)</span><span class="w"> </span><span class="n">tested</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Monitoring</span><span class="p">:</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">latency</span><span class="p">,</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">bloat</span><span class="p">,</span><span class="w"> </span><span class="n">replication</span><span class="w"> </span><span class="n">lag</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Schema</span><span class="w"> </span><span class="n">migration</span><span class="w"> </span><span class="k">tool</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="p">(</span><span class="n">Flyway</span><span class="p">,</span><span class="w"> </span><span class="n">Alembic</span><span class="p">,</span><span class="w"> </span><span class="n">golang</span><span class="o">-</span><span class="n">migrate</span><span class="p">)</span>
<span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Runbook</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">common</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="n">scenarios</span><span class="w"> </span><span class="p">(</span><span class="n">disk</span><span class="w"> </span><span class="n">full</span><span class="p">,</span><span class="w"> </span><span class="n">replication</span><span class="w"> </span><span class="n">lag</span><span class="p">,</span><span class="w"> </span><span class="n">deadlocks</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="10-common-design-mistakes-and-how-to-avoid-them">10. Common Design Mistakes and How to Avoid Them<a class="header-link" href="#10-common-design-mistakes-and-how-to-avoid-them" title="Permanent link">&para;</a></h2>
<h3 id="mistake-1-using-float-for-money">Mistake 1: Using FLOAT for Money<a class="header-link" href="#mistake-1-using-float-for-money" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- BAD: Floating-point arithmetic causes rounding errors</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">total</span><span class="w"> </span><span class="nb">FLOAT</span><span class="w">  </span><span class="c1">-- 0.1 + 0.2 = 0.30000000000000004</span>
<span class="p">);</span>

<span class="c1">-- GOOD: Use exact decimal types</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">total</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="c1">-- 0.1 + 0.2 = 0.30</span>
<span class="p">);</span>
</code></pre></div>

<h3 id="mistake-2-missing-foreign-key-indexes">Mistake 2: Missing Foreign Key Indexes<a class="header-link" href="#mistake-2-missing-foreign-key-indexes" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- PostgreSQL creates indexes for PRIMARY KEY and UNIQUE, but NOT for FOREIGN KEYS!</span>
<span class="c1">-- This means JOIN queries on FK columns do sequential scans.</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">order_items</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">order_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">orders</span><span class="p">(</span><span class="n">id</span><span class="p">),</span><span class="w">  </span><span class="c1">-- NO automatic index!</span>
<span class="w">    </span><span class="n">product_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">  </span><span class="c1">-- NO automatic index!</span>
<span class="p">);</span>

<span class="c1">-- FIX: Always create indexes on FK columns</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_order_items_order</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">order_items</span><span class="p">(</span><span class="n">order_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_order_items_product</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">order_items</span><span class="p">(</span><span class="n">product_id</span><span class="p">);</span>
</code></pre></div>

<h3 id="mistake-3-storing-derived-data-without-a-maintenance-strategy">Mistake 3: Storing Derived Data Without a Maintenance Strategy<a class="header-link" href="#mistake-3-storing-derived-data-without-a-maintenance-strategy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Denormalization is fine, but you MUST maintain consistency</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">avg_rating</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

<span class="c1">-- BAD: Update manually and hope developers remember</span>
<span class="c1">-- GOOD: Use a trigger</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">update_product_rating</span><span class="p">()</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">$$</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">SET</span>
<span class="w">        </span><span class="n">avg_rating</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">rating</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">reviews</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">product_id</span><span class="p">),</span>
<span class="w">        </span><span class="n">review_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">reviews</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">product_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">product_id</span><span class="p">;</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="k">NEW</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">trg_update_product_rating</span>
<span class="k">AFTER</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">reviews</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">update_product_rating</span><span class="p">();</span>
</code></pre></div>

<h3 id="mistake-4-offset-based-pagination">Mistake 4: OFFSET-Based Pagination<a class="header-link" href="#mistake-4-offset-based-pagination" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- BAD: OFFSET scans and discards rows. Page 1000 reads 20,000 rows!</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="mi">19980</span><span class="p">;</span>
<span class="c1">-- â†‘ Reads 20,000 rows, discards 19,980, returns 20.</span>

<span class="c1">-- GOOD: Keyset pagination (cursor-based)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="err">$</span><span class="n">last_seen_created_at</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>
<span class="c1">-- â†‘ Uses index, reads exactly 20 rows regardless of page number.</span>
</code></pre></div>

<h3 id="mistake-5-the-god-table-eav-anti-pattern">Mistake 5: The God Table (EAV Anti-Pattern)<a class="header-link" href="#mistake-5-the-god-table-eav-anti-pattern" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- BAD: Entity-Attribute-Value pattern</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">properties</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">entity_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span><span class="w">   </span><span class="c1">-- &#39;product&#39;, &#39;user&#39;, etc.</span>
<span class="w">    </span><span class="n">entity_id</span><span class="w">   </span><span class="nb">BIGINT</span><span class="p">,</span>
<span class="w">    </span><span class="k">key</span><span class="w">         </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span><span class="w">  </span><span class="c1">-- &#39;color&#39;, &#39;size&#39;, &#39;price&#39;</span>
<span class="w">    </span><span class="n">value</span><span class="w">       </span><span class="nb">TEXT</span><span class="w">           </span><span class="c1">-- everything is a string!</span>
<span class="p">);</span>

<span class="c1">-- Problems:</span>
<span class="c1">-- 1. No type safety (price stored as text)</span>
<span class="c1">-- 2. No constraints (can&#39;t enforce &quot;price &gt;= 0&quot;)</span>
<span class="c1">-- 3. No foreign keys</span>
<span class="c1">-- 4. Terrible query performance (pivot queries are slow)</span>
<span class="c1">-- 5. No schema documentation</span>

<span class="c1">-- GOOD: Use proper tables with typed columns</span>
<span class="c1">-- If attributes vary by category, consider:</span>
<span class="c1">--   1. PostgreSQL JSONB column for flexible attributes</span>
<span class="c1">--   2. Separate tables per category (product_electronics, product_clothing)</span>
<span class="c1">--   3. Hybrid: common columns in products + JSONB for category-specific</span>
</code></pre></div>

<h3 id="mistake-6-not-capturing-historical-data">Mistake 6: Not Capturing Historical Data<a class="header-link" href="#mistake-6-not-capturing-historical-data" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- BAD: Only storing current state</span>
<span class="c1">-- If a product&#39;s price changes, all historical orders show the new price!</span>

<span class="c1">-- GOOD: Capture state at the time of the event</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">order_items</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">product_id</span><span class="w">  </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">quantity</span><span class="w">    </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">unit_price</span><span class="w">  </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w">  </span><span class="c1">-- price AT TIME OF ORDER, not current price</span>
<span class="w">    </span><span class="n">product_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w">    </span><span class="c1">-- optional: snapshot of product name at order time</span>
<span class="p">);</span>
</code></pre></div>

<h3 id="mistake-7-premature-denormalization">Mistake 7: Premature Denormalization<a class="header-link" href="#mistake-7-premature-denormalization" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Phase</span><span class="p">:</span><span class="w"> </span><span class="n">Before</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">users</span>
<span class="n">Developer</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Let&#39;s denormalize everything for performance!&quot;</span>

<span class="n">Reality</span><span class="w"> </span><span class="n">check</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">properly</span><span class="w"> </span><span class="n">indexed</span><span class="w"> </span><span class="n">PostgreSQL</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="n">most</span><span class="w"> </span><span class="n">workloads</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">100</span><span class="n">M</span><span class="w"> </span><span class="n">rows</span>
<span class="o">-</span><span class="w"> </span><span class="n">Start</span><span class="w"> </span><span class="n">normalized</span><span class="p">,</span><span class="w"> </span><span class="n">measure</span><span class="p">,</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="n">denormalize</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">problems</span>
<span class="o">-</span><span class="w"> </span><span class="n">Premature</span><span class="w"> </span><span class="n">denormalization</span><span class="w"> </span><span class="n">creates</span><span class="w"> </span><span class="n">maintenance</span><span class="w"> </span><span class="n">nightmares</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">measurable</span><span class="w"> </span><span class="n">benefit</span>

<span class="n">Rule</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">thumb</span><span class="p">:</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">fewer</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="mi">10</span><span class="n">M</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">queries</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">indexes</span><span class="p">,</span>
<span class="n">you</span><span class="w"> </span><span class="n">probably</span><span class="w"> </span><span class="n">don</span><span class="s1">&#39;t need denormalization.</span>
</code></pre></div>

<h3 id="mistake-8-ignoring-null-semantics">Mistake 8: Ignoring NULL Semantics<a class="header-link" href="#mistake-8-ignoring-null-semantics" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Surprise: NULL comparisons don&#39;t work as expected</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">category_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="c1">-- Does NOT return rows where category_id IS NULL!</span>

<span class="c1">-- FIX: Handle NULLs explicitly</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">category_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">category_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
<span class="c1">-- Or use: WHERE category_id IS DISTINCT FROM 5;</span>

<span class="c1">-- Also: COUNT(column) ignores NULLs, COUNT(*) counts all rows</span>
<span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">phone</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="p">;</span><span class="w">  </span><span class="c1">-- only counts non-NULL phones</span>
<span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="p">;</span><span class="w">      </span><span class="c1">-- counts all customers</span>
</code></pre></div>

<h3 id="mistake-9-storing-comma-separated-values">Mistake 9: Storing Comma-Separated Values<a class="header-link" href="#mistake-9-storing-comma-separated-values" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- BAD: Storing multiple values in a single column</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">tags</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w">  </span><span class="c1">-- &quot;electronics,wireless,bluetooth&quot;</span>
<span class="p">);</span>

<span class="c1">-- Problems:</span>
<span class="c1">-- 1. Can&#39;t index individual tags efficiently</span>
<span class="c1">-- 2. Can&#39;t enforce referential integrity</span>
<span class="c1">-- 3. &quot;Find products with tag &#39;wireless&#39;&quot; requires LIKE &#39;%wireless%&#39; (slow, incorrect)</span>
<span class="c1">-- 4. Can&#39;t JOIN with a tags table</span>
<span class="c1">-- 5. Violates 1NF</span>

<span class="c1">-- GOOD: Use a junction table</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tags</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">product_tags</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">product_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">tag_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">tags</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="n">tag_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- Or use PostgreSQL arrays with GIN index</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">tags</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">[]</span>
<span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_products_tags</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">GIN</span><span class="p">(</span><span class="n">tags</span><span class="p">);</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">tags</span><span class="w"> </span><span class="o">@&gt;</span><span class="w"> </span><span class="nb">ARRAY</span><span class="p">[</span><span class="s1">&#39;wireless&#39;</span><span class="p">];</span>
</code></pre></div>

<h3 id="mistake-10-not-planning-for-schema-evolution">Mistake 10: Not Planning for Schema Evolution<a class="header-link" href="#mistake-10-not-planning-for-schema-evolution" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- BAD: No migration tool, manual ALTER TABLEs in production</span>

<span class="c1">-- GOOD: Use a migration tool (Flyway, Alembic, golang-migrate)</span>
<span class="c1">-- Each migration is a versioned, reversible SQL file:</span>

<span class="c1">-- V001__create_customers.sql</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="p">(...);</span>

<span class="c1">-- V002__add_phone_to_customers.sql</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">phone</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

<span class="c1">-- V003__create_orders.sql</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(...);</span>

<span class="c1">-- Benefits:</span>
<span class="c1">-- 1. Every schema change is version-controlled</span>
<span class="c1">-- 2. Reproducible across environments (dev, staging, prod)</span>
<span class="c1">-- 3. Rollback capability</span>
<span class="c1">-- 4. Team collaboration (no conflicting manual changes)</span>
</code></pre></div>

<hr />
<h2 id="11-exercises">11. Exercises<a class="header-link" href="#11-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-complete-the-e-commerce-schema">Exercise 1: Complete the E-Commerce Schema<a class="header-link" href="#exercise-1-complete-the-e-commerce-schema" title="Permanent link">&para;</a></h3>
<p>The ShopWave schema above is missing several features. Extend it to support:</p>
<ol>
<li><strong>Product variants</strong>: Products can have variants (e.g., "Blue, Large", "Red, Small") each with its own price, SKU, and stock quantity. Design the tables.</li>
<li><strong>Order status history</strong>: Instead of a single status field, track every status change with a timestamp and the user who made the change.</li>
<li><strong>Seller payouts</strong>: Track commission calculations and payout history for sellers.</li>
</ol>
<p>Write the CREATE TABLE statements for each extension and explain how they integrate with the existing schema.</p>
<h3 id="exercise-2-normalization-analysis">Exercise 2: Normalization Analysis<a class="header-link" href="#exercise-2-normalization-analysis" title="Permanent link">&para;</a></h3>
<p>Consider this denormalized order table:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">flat_orders</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">order_id</span><span class="w">        </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_name</span><span class="w">   </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">customer_email</span><span class="w">  </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<span class="w">    </span><span class="n">product_name</span><span class="w">    </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<span class="w">    </span><span class="n">product_sku</span><span class="w">     </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
<span class="w">    </span><span class="n">product_price</span><span class="w">   </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
<span class="w">    </span><span class="n">quantity</span><span class="w">        </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">order_total</span><span class="w">     </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
<span class="w">    </span><span class="n">order_date</span><span class="w">      </span><span class="nb">DATE</span><span class="p">,</span>
<span class="w">    </span><span class="n">shipping_street</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<span class="w">    </span><span class="n">shipping_city</span><span class="w">   </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">shipping_zip</span><span class="w">    </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>

<ol>
<li>List all functional dependencies.</li>
<li>Identify the candidate key(s).</li>
<li>Determine whether the table is in 1NF, 2NF, 3NF, and BCNF.</li>
<li>Decompose into BCNF, showing each decomposition step.</li>
<li>Verify that your decomposition is lossless-join.</li>
</ol>
<h3 id="exercise-3-index-design-challenge">Exercise 3: Index Design Challenge<a class="header-link" href="#exercise-3-index-design-challenge" title="Permanent link">&para;</a></h3>
<p>Given the ShopWave schema and these query patterns:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Q1: Products on sale (price &lt; original_price) in a category</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">category_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">sale_price</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="p">(</span><span class="n">price</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sale_price</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>

<span class="c1">-- Q2: Customer&#39;s order with specific status in date range</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="err">$</span><span class="mi">3</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="err">$</span><span class="mi">4</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>

<span class="c1">-- Q3: Products reviewed by a specific customer</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">rating</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">created_at</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">reviews</span><span class="w"> </span><span class="n">r</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>

<span class="c1">-- Q4: Sellers with the most orders this month</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">company_name</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">order_count</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">sellers</span><span class="w"> </span><span class="n">s</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">seller_id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">order_items</span><span class="w"> </span><span class="n">oi</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oi</span><span class="p">.</span><span class="n">product_id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">oi</span><span class="p">.</span><span class="n">order_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="p">)</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_count</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</code></pre></div>

<p>For each query:
1. Design the optimal index(es).
2. Write the expected EXPLAIN plan.
3. Estimate the selectivity of each predicate.</p>
<h3 id="exercise-4-transaction-design">Exercise 4: Transaction Design<a class="header-link" href="#exercise-4-transaction-design" title="Permanent link">&para;</a></h3>
<p>Design the transaction for the following business operation:</p>
<p><strong>Apply a bulk discount</strong>: An admin wants to reduce the price of all products in category "Electronics" by 15%, capping the discount at $50 per product, and logging the change in an audit table.</p>
<p>Requirements:
- No product should be visible to customers at an intermediate state (partially discounted)
- The operation should not block product reads for more than 1 second
- All changes must be logged with before/after values</p>
<p>Write the transaction SQL and specify the isolation level.</p>
<h3 id="exercise-5-design-your-own-database">Exercise 5: Design Your Own Database<a class="header-link" href="#exercise-5-design-your-own-database" title="Permanent link">&para;</a></h3>
<p>Choose ONE of the following scenarios and complete a full database design (Phases 1-6):</p>
<p><strong>Option A: Library Management System</strong>
- Patrons, books (multiple copies), checkouts, reservations, fines
- Patrons can check out up to 5 books for 14 days
- Late returns incur $0.25/day fine
- Books can be reserved if all copies are checked out
- Librarians can add/remove books and manage patron accounts</p>
<p><strong>Option B: Restaurant Reservation System</strong>
- Restaurants, tables, reservations, customers, waitlists
- Restaurants have tables of different sizes (2, 4, 6, 8 seats)
- Reservations are for a specific date/time and party size
- Waitlist when no tables are available
- Customers can leave reviews for restaurants</p>
<p><strong>Option C: Online Learning Platform</strong>
- Courses, lessons, students, enrollments, progress tracking, quizzes
- Courses have multiple lessons in a defined order
- Students track progress (completed lessons, quiz scores)
- Instructors create and manage courses
- Certificates issued upon course completion</p>
<p>For your chosen scenario, produce:
1. Functional requirements (at least 8)
2. Data requirements with volumetric estimates
3. ER diagram with cardinalities
4. Normalized relational schema (CREATE TABLE statements)
5. Indexing strategy with justification
6. Two critical transactions with isolation level and locking strategy
7. Three representative queries with expected explain plans</p>
<h3 id="exercise-6-critique-this-design">Exercise 6: Critique This Design<a class="header-link" href="#exercise-6-critique-this-design" title="Permanent link">&para;</a></h3>
<p>Find and fix at least 8 problems in the following schema:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">email</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">password</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">created</span><span class="w"> </span><span class="nb">DATE</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">title</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">price</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span>
<span class="w">    </span><span class="n">category</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">tags</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">  </span><span class="c1">-- comma-separated: &quot;electronics,sale,new&quot;</span>
<span class="w">    </span><span class="n">stock</span><span class="w"> </span><span class="nb">INT</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">user_email</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">product_ids</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">  </span><span class="c1">-- comma-separated: &quot;1,5,12&quot;</span>
<span class="w">    </span><span class="n">quantities</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">   </span><span class="c1">-- comma-separated: &quot;2,1,3&quot;</span>
<span class="w">    </span><span class="n">total</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="nb">date</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">);</span>
</code></pre></div>

<p>For each problem:
1. Identify the issue.
2. Explain why it is problematic.
3. Provide the corrected SQL.</p>
<h3 id="exercise-7-scaling-the-e-commerce-design">Exercise 7: Scaling the E-Commerce Design<a class="header-link" href="#exercise-7-scaling-the-e-commerce-design" title="Permanent link">&para;</a></h3>
<p>The ShopWave platform has grown to:
- 50 million customers
- 10 million products
- 500 million orders
- 1.5 billion order items
- 100 million reviews</p>
<p>The current single-node PostgreSQL can no longer handle the load. Propose a scaling strategy:</p>
<ol>
<li>Which tables should be partitioned? By what key?</li>
<li>Which tables need read replicas?</li>
<li>Which data should be moved to Redis (caching)?</li>
<li>Should any data be moved to a different database type (e.g., Elasticsearch for search, Cassandra for order history)? Justify.</li>
<li>How would you handle the transition from a single database to a distributed architecture without downtime?</li>
</ol>
<h3 id="exercise-8-social-media-feed-design">Exercise 8: Social Media Feed Design<a class="header-link" href="#exercise-8-social-media-feed-design" title="Permanent link">&para;</a></h3>
<p>Using the SocialBuzz schema from Section 8:</p>
<ol>
<li>Implement the hybrid feed model: write the SQL for both the push path (regular users creating posts) and the pull path (merging celebrity posts at read time).</li>
<li>A celebrity with 5 million followers changes their username. How do you update the feed_items table efficiently?</li>
<li>Design a "trending posts" feature: show the 50 posts with the most likes in the last 24 hours. What indexes do you need? How do you handle the write load on like_count?</li>
<li>A user blocks another user. What changes do you need to make to the feed system?</li>
</ol>
<h3 id="exercise-9-migration-planning">Exercise 9: Migration Planning<a class="header-link" href="#exercise-9-migration-planning" title="Permanent link">&para;</a></h3>
<p>You need to add a "product variants" feature to the live ShopWave database (see Exercise 1). Write a zero-downtime migration plan:</p>
<ol>
<li>List the migration steps in order.</li>
<li>For each step, specify whether it requires a lock and for how long.</li>
<li>Describe the backward-compatible application changes needed between migration steps.</li>
<li>What is your rollback plan if something goes wrong mid-migration?</li>
</ol>
<h3 id="exercise-10-design-review">Exercise 10: Design Review<a class="header-link" href="#exercise-10-design-review" title="Permanent link">&para;</a></h3>
<p>Review the complete ShopWave schema (Phase 3 DDL) against the Design Review Checklist (Section 9). For each checklist item that is NOT yet satisfied, describe the gap and provide the SQL fix. Aim to find at least 5 gaps.</p>
<hr />
<h2 id="12-references">12. References<a class="header-link" href="#12-references" title="Permanent link">&para;</a></h2>
<ol>
<li>Elmasri, R. &amp; Navathe, S. (2016). <em>Fundamentals of Database Systems</em>, 7th Edition. Pearson. Chapters 3-9.</li>
<li>Garcia-Molina, H., Ullman, J., &amp; Widom, J. (2008). <em>Database Systems: The Complete Book</em>, 2nd Edition. Pearson.</li>
<li>Kleppmann, M. (2017). <em>Designing Data-Intensive Applications</em>. O'Reilly Media. Chapters 2-3.</li>
<li>Winand, M. (2012). <em>SQL Performance Explained</em>. https://use-the-index-luke.com/</li>
<li>PostgreSQL Documentation. "Partitioning." https://www.postgresql.org/docs/current/ddl-partitioning.html</li>
<li>PostgreSQL Documentation. "Concurrency Control." https://www.postgresql.org/docs/current/mvcc.html</li>
<li>Karwin, B. (2010). <em>SQL Antipatterns</em>. Pragmatic Bookshelf.</li>
<li>Kleppmann, M. (2012). "Designing Data-Intensive Applications: Partitioning." Chapter 6.</li>
<li>Sadalage, P. &amp; Fowler, M. (2012). <em>NoSQL Distilled</em>. Addison-Wesley. (For polyglot persistence comparisons.)</li>
<li>Twitter Engineering Blog. (2013). "How Twitter Stores 250 Million Tweets a Day."</li>
</ol>
<hr />
<p><strong>Previous</strong>: <a href="./15_NewSQL_and_Modern_Trends.md">15. NewSQL and Modern Trends</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Database_Theory/15_NewSQL_and_Modern_Trends.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">NewSQL and Modern Trends</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Database_Theory/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}