{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>05. Data Curation - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Foundation_Models/">Foundation Models</a>
    <span class="separator">/</span>
    <span class="current">05. Data Curation</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>05. Data Curation</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Foundation_Models/04_Pretraining_Objectives.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">04. Pre-training Objectives</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Foundation_Models/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Foundation_Models/06_Pretraining_Infrastructure.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">06. Pre-training Infrastructure</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#1-major-pre-training-datasets">1. Major Pre-training Datasets</a><ul>
<li><a href="#11-dataset-overview">1.1 Dataset Overview</a></li>
<li><a href="#12-major-dataset-comparison">1.2 Major Dataset Comparison</a></li>
<li><a href="#13-the-pile-composition">1.3 The Pile Composition</a></li>
</ul>
</li>
<li><a href="#2-data-collection">2. Data Collection</a><ul>
<li><a href="#21-using-common-crawl">2.1 Using Common Crawl</a></li>
<li><a href="#22-github-code-collection">2.2 GitHub Code Collection</a></li>
</ul>
</li>
<li><a href="#3-data-cleaning-pipeline">3. Data Cleaning Pipeline</a><ul>
<li><a href="#31-quality-filtering">3.1 Quality Filtering</a></li>
<li><a href="#32-deduplication">3.2 Deduplication</a></li>
</ul>
</li>
<li><a href="#4-data-mixing">4. Data Mixing</a><ul>
<li><a href="#41-domain-mixing-strategy">4.1 Domain Mixing Strategy</a></li>
<li><a href="#42-multilingual-mixing">4.2 Multilingual Mixing</a></li>
</ul>
</li>
<li><a href="#5-data-quality-evaluation">5. Data Quality Evaluation</a><ul>
<li><a href="#51-automatic-quality-scoring">5.1 Automatic Quality Scoring</a></li>
</ul>
</li>
<li><a href="#6-practice-fineweb-style-pipeline">6. Practice: FineWeb-style Pipeline</a></li>
<li><a href="#references">References</a><ul>
<li><a href="#datasets">Datasets</a></li>
<li><a href="#papers">Papers</a></li>
<li><a href="#tools">Tools</a></li>
</ul>
</li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="05-data-curation">05. Data Curation<a class="header-link" href="#05-data-curation" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="header-link" href="#overview" title="Permanent link">&para;</a></h2>
<p>The performance of Foundation Models heavily depends on data quality and diversity. "Garbage in, garbage out" is more critical than ever. This lesson covers the construction, refinement, and management of large-scale pre-training datasets.</p>
<hr />
<h2 id="1-major-pre-training-datasets">1. Major Pre-training Datasets<a class="header-link" href="#1-major-pre-training-datasets" title="Permanent link">&para;</a></h2>
<h3 id="11-dataset-overview">1.1 Dataset Overview<a class="header-link" href="#11-dataset-overview" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Pre-training Dataset Evolution                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  2018: BookCorpus + Wikipedia (3.3B tokens) â†’ BERT              â”‚
â”‚         â”‚                                                        â”‚
â”‚  2019: WebText (40GB, Reddit links) â†’ GPT-2                     â”‚
â”‚         â”‚                                                        â”‚
â”‚  2020: C4 (750GB, Common Crawl filtered) â†’ T5                   â”‚
â”‚         â”‚                                                        â”‚
â”‚  2020: The Pile (825GB, 22 sources) â†’ GPT-Neo, Pythia          â”‚
â”‚         â”‚                                                        â”‚
â”‚  2022: ROOTS (1.6TB, 59 languages) â†’ BLOOM                      â”‚
â”‚         â”‚                                                        â”‚
â”‚  2023: RedPajama (1.2T tokens) â†’ RedPajama-INCITE              â”‚
â”‚         â”‚                                                        â”‚
â”‚  2024: FineWeb (15T tokens) â†’ Latest open models               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="12-major-dataset-comparison">1.2 Major Dataset Comparison<a class="header-link" href="#12-major-dataset-comparison" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Dataset</th>
<th>Size</th>
<th>Source</th>
<th>Features</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>The Pile</strong></td>
<td>825GB</td>
<td>22 diverse sources</td>
<td>Includes code, academic, books</td>
</tr>
<tr>
<td><strong>C4</strong></td>
<td>750GB</td>
<td>Common Crawl</td>
<td>English only, filtered</td>
</tr>
<tr>
<td><strong>RedPajama</strong></td>
<td>1.2T tokens</td>
<td>LLaMA recipe replication</td>
<td>Open source</td>
</tr>
<tr>
<td><strong>ROOTS</strong></td>
<td>1.6TB</td>
<td>59 languages</td>
<td>Multilingual, BigScience</td>
</tr>
<tr>
<td><strong>FineWeb</strong></td>
<td>15T tokens</td>
<td>Common Crawl</td>
<td>HuggingFace, latest</td>
</tr>
<tr>
<td><strong>Dolma</strong></td>
<td>3T tokens</td>
<td>Various sources</td>
<td>Allen AI, transparency focus</td>
</tr>
</tbody>
</table>
<h3 id="13-the-pile-composition">1.3 The Pile Composition<a class="header-link" href="#13-the-pile-composition" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># The Pile&#39;s 22 subdatasets</span>
<span class="n">PILE_COMPONENTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Web text</span>
    <span class="s1">&#39;Pile-CC&#39;</span><span class="p">:</span> <span class="mf">227.12</span><span class="p">,</span>      <span class="c1"># Filtered Common Crawl</span>
    <span class="s1">&#39;OpenWebText2&#39;</span><span class="p">:</span> <span class="mf">62.77</span><span class="p">,</span>  <span class="c1"># Reddit-linked webpages</span>

    <span class="c1"># Books and literature</span>
    <span class="s1">&#39;Books3&#39;</span><span class="p">:</span> <span class="mf">100.96</span><span class="p">,</span>       <span class="c1"># Books</span>
    <span class="s1">&#39;BookCorpus2&#39;</span><span class="p">:</span> <span class="mf">6.30</span><span class="p">,</span>    <span class="c1"># Additional books</span>
    <span class="s1">&#39;Gutenberg&#39;</span><span class="p">:</span> <span class="mf">10.88</span><span class="p">,</span>     <span class="c1"># Public domain books</span>

    <span class="c1"># Academic</span>
    <span class="s1">&#39;PubMed Central&#39;</span><span class="p">:</span> <span class="mf">90.27</span><span class="p">,</span>   <span class="c1"># Medical papers</span>
    <span class="s1">&#39;ArXiv&#39;</span><span class="p">:</span> <span class="mf">56.21</span><span class="p">,</span>            <span class="c1"># Scientific papers</span>
    <span class="s1">&#39;PubMed Abstracts&#39;</span><span class="p">:</span> <span class="mf">19.26</span><span class="p">,</span> <span class="c1"># Paper abstracts</span>
    <span class="s1">&#39;PhilPapers&#39;</span><span class="p">:</span> <span class="mf">2.38</span><span class="p">,</span>        <span class="c1"># Philosophy papers</span>
    <span class="s1">&#39;NIH ExPorter&#39;</span><span class="p">:</span> <span class="mf">1.89</span><span class="p">,</span>      <span class="c1"># NIH research info</span>

    <span class="c1"># Code</span>
    <span class="s1">&#39;Github&#39;</span><span class="p">:</span> <span class="mf">95.16</span><span class="p">,</span>        <span class="c1"># GitHub code</span>
    <span class="s1">&#39;StackExchange&#39;</span><span class="p">:</span> <span class="mf">32.20</span><span class="p">,</span> <span class="c1"># Q&amp;A</span>

    <span class="c1"># Other</span>
    <span class="s1">&#39;Wikipedia (en)&#39;</span><span class="p">:</span> <span class="mf">16.11</span><span class="p">,</span>
    <span class="s1">&#39;FreeLaw&#39;</span><span class="p">:</span> <span class="mf">51.15</span><span class="p">,</span>       <span class="c1"># Legal documents</span>
    <span class="s1">&#39;USPTO&#39;</span><span class="p">:</span> <span class="mf">22.90</span><span class="p">,</span>         <span class="c1"># Patents</span>
    <span class="s1">&#39;DM Mathematics&#39;</span><span class="p">:</span> <span class="mf">7.75</span><span class="p">,</span> <span class="c1"># Math problems</span>
    <span class="s1">&#39;Ubuntu IRC&#39;</span><span class="p">:</span> <span class="mf">5.52</span><span class="p">,</span>     <span class="c1"># IRC logs</span>
    <span class="s1">&#39;EuroParl&#39;</span><span class="p">:</span> <span class="mf">4.59</span><span class="p">,</span>       <span class="c1"># EU parliament</span>
    <span class="s1">&#39;HackerNews&#39;</span><span class="p">:</span> <span class="mf">3.90</span><span class="p">,</span>
    <span class="s1">&#39;YoutubeSubtitles&#39;</span><span class="p">:</span> <span class="mf">3.73</span><span class="p">,</span>
    <span class="s1">&#39;Enron Emails&#39;</span><span class="p">:</span> <span class="mf">0.88</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Calculate ratios</span>
<span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">PILE_COMPONENTS</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">PILE_COMPONENTS</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">size</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">GB (</span><span class="si">{</span><span class="n">size</span><span class="o">/</span><span class="n">total</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="2-data-collection">2. Data Collection<a class="header-link" href="#2-data-collection" title="Permanent link">&para;</a></h2>
<h3 id="21-using-common-crawl">2.1 Using Common Crawl<a class="header-link" href="#21-using-common-crawl" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">warcio.archiveiterator</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArchiveIterator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CommonCrawlExtractor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract text from Common Crawl&quot;&quot;&quot;</span>

    <span class="n">CC_INDEX_URL</span> <span class="o">=</span> <span class="s2">&quot;https://index.commoncrawl.org/CC-MAIN-2024-10-index&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_warc_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query WARC file paths for specific domain&quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;*.</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s1">/*&#39;</span><span class="p">,</span>
            <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
            <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="n">limit</span>
        <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CC_INDEX_URL</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_text_from_warc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warc_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract text from WARC file&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;https://data.commoncrawl.org/</span><span class="si">{</span><span class="n">warc_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">stream</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">ArchiveIterator</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">rec_type</span> <span class="o">==</span> <span class="s1">&#39;response&#39;</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">rec_headers</span><span class="o">.</span><span class="n">get_header</span><span class="p">(</span><span class="s1">&#39;WARC-Target-URI&#39;</span><span class="p">)</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">content_stream</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

                    <span class="c1"># Extract text from HTML (using trafilatura, etc.)</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
                            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
                            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">rec_headers</span><span class="o">.</span><span class="n">get_header</span><span class="p">(</span><span class="s1">&#39;WARC-Date&#39;</span><span class="p">)</span>
                        <span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract main text from HTML&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">trafilatura</span>
            <span class="k">return</span> <span class="n">trafilatura</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">bs4</span><span class="w"> </span><span class="kn">import</span> <span class="n">BeautifulSoup</span>
            <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
            <span class="c1"># Remove script, style</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">soup</span><span class="p">([</span><span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;nav&#39;</span><span class="p">,</span> <span class="s1">&#39;footer&#39;</span><span class="p">]):</span>
                <span class="n">tag</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">soup</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<h3 id="22-github-code-collection">2.2 GitHub Code Collection<a class="header-link" href="#22-github-code-collection" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">github</span><span class="w"> </span><span class="kn">import</span> <span class="n">Github</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">GitHubCodeCollector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect code from GitHub&quot;&quot;&quot;</span>

    <span class="c1"># Languages and extensions to collect</span>
    <span class="n">LANGUAGES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;python&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;.py&#39;</span><span class="p">],</span>
        <span class="s1">&#39;javascript&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;.js&#39;</span><span class="p">,</span> <span class="s1">&#39;.jsx&#39;</span><span class="p">,</span> <span class="s1">&#39;.ts&#39;</span><span class="p">,</span> <span class="s1">&#39;.tsx&#39;</span><span class="p">],</span>
        <span class="s1">&#39;java&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;.java&#39;</span><span class="p">],</span>
        <span class="s1">&#39;cpp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;.cpp&#39;</span><span class="p">,</span> <span class="s1">&#39;.hpp&#39;</span><span class="p">,</span> <span class="s1">&#39;.c&#39;</span><span class="p">,</span> <span class="s1">&#39;.h&#39;</span><span class="p">],</span>
        <span class="s1">&#39;go&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;.go&#39;</span><span class="p">],</span>
        <span class="s1">&#39;rust&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;.rs&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">github</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">collect_repos</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">language</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">min_stars</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect popular repositories&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;language:</span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2"> stars:&gt;</span><span class="si">{</span><span class="n">min_stars</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">repos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">search_repositories</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s1">&#39;stars&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">repo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">repos</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">yield</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span>
                <span class="s1">&#39;stars&#39;</span><span class="p">:</span> <span class="n">repo</span><span class="o">.</span><span class="n">stargazers_count</span><span class="p">,</span>
                <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="n">repo</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
                <span class="s1">&#39;license&#39;</span><span class="p">:</span> <span class="n">repo</span><span class="o">.</span><span class="n">license</span><span class="o">.</span><span class="n">key</span> <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">license</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">repo</span><span class="o">.</span><span class="n">html_url</span>
            <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_code_files</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">repo_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">extensions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract code files from repository&quot;&quot;&quot;</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">contents</span><span class="p">:</span>
                <span class="n">file_content</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">file_content</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;dir&quot;</span><span class="p">:</span>
                    <span class="n">contents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">file_content</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">file_content</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">file_content</span><span class="o">.</span><span class="n">decoded_content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="p">{</span>
                            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">file_content</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                            <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
                            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">file_content</span><span class="o">.</span><span class="n">size</span>
                        <span class="p">}</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="3-data-cleaning-pipeline">3. Data Cleaning Pipeline<a class="header-link" href="#3-data-cleaning-pipeline" title="Permanent link">&para;</a></h2>
<h3 id="31-quality-filtering">3.1 Quality Filtering<a class="header-link" href="#31-quality-filtering" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">fasttext</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>

<span class="k">class</span><span class="w"> </span><span class="nc">QualityFilter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Text quality filtering&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lang_model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;lid.176.bin&#39;</span><span class="p">):</span>
        <span class="c1"># FastText language detection model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lang_detector</span> <span class="o">=</span> <span class="n">fasttext</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">lang_model_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_lang</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;en&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter document</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cleaned text or None (filtered out)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. Basic filter</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basic_filter</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># 2. Language filter</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_language_filter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">target_lang</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># 3. Quality score</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quality_score_filter</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># 4. Text cleaning</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cleaned</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_basic_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Basic filtering rules&quot;&quot;&quot;</span>
        <span class="c1"># Min/max length</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Word count</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Average word length (too short/long suggests spam)</span>
        <span class="n">avg_word_len</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">avg_word_len</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">avg_word_len</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Alphabet ratio</span>
        <span class="n">alpha_chars</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alpha_chars</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_language_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_lang</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Language filtering&quot;&quot;&quot;</span>
        <span class="c1"># Detect language from first 500 chars</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang_detector</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">lang</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;__label__&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">lang</span> <span class="o">==</span> <span class="n">target_lang</span> <span class="ow">and</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="mf">0.8</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_quality_score_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Quality score-based filtering&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Line-ending punctuation ratio</span>
        <span class="n">end_punct</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;.!?&#39;</span><span class="p">)</span>
        <span class="n">punct_ratio</span> <span class="o">=</span> <span class="n">end_punct</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Lines starting with capital letter ratio</span>
        <span class="n">cap_start</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">())</span>
        <span class="n">cap_ratio</span> <span class="o">=</span> <span class="n">cap_start</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Bullet/number list ratio (too high suggests list page)</span>
        <span class="n">bullet_lines</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*[\-\*\â€¢\d\.]\s&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
        <span class="n">bullet_ratio</span> <span class="o">=</span> <span class="n">bullet_lines</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Quality score</span>
        <span class="k">if</span> <span class="n">punct_ratio</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>  <span class="c1"># Too little punctuation</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">bullet_ratio</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># Too many lists</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean text&quot;&quot;&quot;</span>
        <span class="c1"># Remove URLs</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;https?://\S+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="c1"># Remove emails</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\S+@\S+\.\S+&#39;</span><span class="p">,</span> <span class="s1">&#39;[EMAIL]&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="c1"># Clean excessive whitespace</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\n{3,}&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39; {2,}&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="c1"># Remove control characters</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isprintable</span><span class="p">()</span> <span class="ow">or</span> <span class="n">c</span> <span class="ow">in</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre></div>

<h3 id="32-deduplication">3.2 Deduplication<a class="header-link" href="#32-deduplication" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datasketch</span><span class="w"> </span><span class="kn">import</span> <span class="n">MinHash</span><span class="p">,</span> <span class="n">MinHashLSH</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DeduplicationPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Large-scale deduplication pipeline&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_perm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">ngram_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_perm</span> <span class="o">=</span> <span class="n">num_perm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngram_size</span> <span class="o">=</span> <span class="n">ngram_size</span>

        <span class="c1"># LSH index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsh</span> <span class="o">=</span> <span class="n">MinHashLSH</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">num_perm</span><span class="o">=</span><span class="n">num_perm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen_hashes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_minhash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MinHash</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate MinHash of text&quot;&quot;&quot;</span>
        <span class="n">minhash</span> <span class="o">=</span> <span class="n">MinHash</span><span class="p">(</span><span class="n">num_perm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_perm</span><span class="p">)</span>

        <span class="c1"># Generate N-grams</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngram_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ngram</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngram_size</span><span class="p">])</span>
            <span class="n">minhash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ngram</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">minhash</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">exact_dedup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exact deduplication (hash-based)</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if unique, False if duplicate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Hash of normalized text</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="n">text_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">normalized</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">text_hash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen_hashes</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">seen_hashes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">text_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fuzzy_dedup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fuzzy deduplication (MinHash LSH)</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if unique, False if near-duplicate found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">minhash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_minhash</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="c1"># Search for similar documents</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsh</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">minhash</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Add new document</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsh</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">minhash</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">deduplicate_stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">documents</span><span class="p">:</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Streaming deduplication</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">documents</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
            <span class="n">doc_id</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

            <span class="c1"># Stage 1: Exact duplicates</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exact_dedup</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Stage 2: Near-duplicates</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fuzzy_dedup</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="n">doc</span>


<span class="c1"># Usage example</span>
<span class="k">def</span><span class="w"> </span><span class="nf">deduplicate_dataset</span><span class="p">(</span><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Deduplicate dataset&quot;&quot;&quot;</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">DeduplicationPipeline</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_documents</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">unique_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">deduplicate_stream</span><span class="p">(</span><span class="n">read_documents</span><span class="p">(</span><span class="n">input_path</span><span class="p">)):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">unique_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">total_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total: </span><span class="si">{</span><span class="n">total_count</span><span class="si">}</span><span class="s2">, Unique: </span><span class="si">{</span><span class="n">unique_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dedup ratio: </span><span class="si">{</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">unique_count</span><span class="o">/</span><span class="n">total_count</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="4-data-mixing">4. Data Mixing<a class="header-link" href="#4-data-mixing" title="Permanent link">&para;</a></h2>
<h3 id="41-domain-mixing-strategy">4.1 Domain Mixing Strategy<a class="header-link" href="#41-domain-mixing-strategy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterator</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DataSource</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Sampling weight</span>
    <span class="n">quality_score</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Quality score (0-1)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DataMixer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mix data from various sources</span>

<span class="sd">    Strategies:</span>
<span class="sd">    1. Quality-based: Sample more from high-quality sources</span>
<span class="sd">    2. Diversity-based: Balance all domains</span>
<span class="sd">    3. Scaling law-based: Search for optimal ratios</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># LLaMA-style mixing ratios</span>
    <span class="n">LLAMA_MIX</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;CommonCrawl&#39;</span><span class="p">:</span> <span class="mf">0.67</span><span class="p">,</span>    <span class="c1"># Web</span>
        <span class="s1">&#39;C4&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>             <span class="c1"># Filtered web</span>
        <span class="s1">&#39;Github&#39;</span><span class="p">:</span> <span class="mf">0.045</span><span class="p">,</span>        <span class="c1"># Code</span>
        <span class="s1">&#39;Wikipedia&#39;</span><span class="p">:</span> <span class="mf">0.045</span><span class="p">,</span>     <span class="c1"># Encyclopedia</span>
        <span class="s1">&#39;Books&#39;</span><span class="p">:</span> <span class="mf">0.045</span><span class="p">,</span>         <span class="c1"># Books</span>
        <span class="s1">&#39;ArXiv&#39;</span><span class="p">:</span> <span class="mf">0.025</span><span class="p">,</span>         <span class="c1"># Scientific</span>
        <span class="s1">&#39;StackExchange&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span>  <span class="c1"># Q&amp;A</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DataSource</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize_weights</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize weights&quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">weight</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="n">source</span><span class="o">.</span><span class="n">weight</span> <span class="o">/=</span> <span class="n">total</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">temperature_sampling</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adjust sampling probabilities with temperature</span>

<span class="sd">        temperature &lt; 1: Focus on high-frequency sources</span>
<span class="sd">        temperature &gt; 1: Distribute more evenly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">weight</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">])</span>

        <span class="c1"># Apply temperature</span>
        <span class="n">adjusted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">)</span>
        <span class="n">adjusted</span> <span class="o">/=</span> <span class="n">adjusted</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">adjusted</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sample batch</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of (source_name, num_samples)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_sampling</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>

        <span class="c1"># Number of documents to sample from each source</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_mixed_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mixed data iterator&quot;&quot;&quot;</span>
        <span class="n">source_iters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_source</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span>
        <span class="p">}</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">batch_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">temperature</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">source_name</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">batch_plan</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="nb">next</span><span class="p">(</span><span class="n">source_iters</span><span class="p">[</span><span class="n">source_name</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                        <span class="c1"># Restart source or terminate</span>
                        <span class="k">break</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_read_source</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read data source&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


<span class="c1"># Search for optimal mixing ratios</span>
<span class="k">def</span><span class="w"> </span><span class="nf">find_optimal_mix</span><span class="p">(</span>
    <span class="n">sources</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DataSource</span><span class="p">],</span>
    <span class="n">validation_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">model_fn</span><span class="p">,</span>
    <span class="n">n_trials</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search for optimal mixing ratios with Bayesian Optimization</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">optuna</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
        <span class="c1"># Sample weight for each source</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span>
                <span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.0</span>
            <span class="p">)</span>

        <span class="c1"># Normalize</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">/</span><span class="n">total</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># Train model and validate</span>
        <span class="c1"># (In practice, use small proxy model)</span>
        <span class="n">val_loss</span> <span class="o">=</span> <span class="n">model_fn</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">validation_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">val_loss</span>

    <span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;minimize&#39;</span><span class="p">)</span>
    <span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="n">n_trials</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">study</span><span class="o">.</span><span class="n">best_params</span>
</code></pre></div>

<h3 id="42-multilingual-mixing">4.2 Multilingual Mixing<a class="header-link" href="#42-multilingual-mixing" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MultilingualMixer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multilingual data mixing</span>

<span class="sd">    Strategies:</span>
<span class="sd">    1. Prevent English over-representation</span>
<span class="sd">    2. Upsample low-resource languages</span>
<span class="sd">    3. Group by language similarity</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Default language ratios (BLOOM style)</span>
    <span class="n">BLOOM_RATIOS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;en&#39;</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span>  <span class="c1"># English</span>
        <span class="s1">&#39;zh&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>  <span class="c1"># Chinese</span>
        <span class="s1">&#39;fr&#39;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">,</span>  <span class="c1"># French</span>
        <span class="s1">&#39;es&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>  <span class="c1"># Spanish</span>
        <span class="s1">&#39;pt&#39;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span>  <span class="c1"># Portuguese</span>
        <span class="s1">&#39;ar&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>  <span class="c1"># Arabic</span>
        <span class="c1"># ... other languages</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">language_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language_weights</span> <span class="o">=</span> <span class="n">language_weights</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">exponential_smoothing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upsample low-resource languages with exponential smoothing</span>

<span class="sd">        P(lang) âˆ P_original(lang)^alpha</span>

<span class="sd">        alpha &lt; 1: Increase low-resource language ratio</span>
<span class="sd">        alpha = 1: Keep original ratio</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smoothed</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">lang</span><span class="p">:</span> <span class="n">weight</span> <span class="o">**</span> <span class="n">alpha</span>
            <span class="k">for</span> <span class="n">lang</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">language_weights</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">smoothed</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">lang</span><span class="p">:</span> <span class="n">w</span><span class="o">/</span><span class="n">total</span> <span class="k">for</span> <span class="n">lang</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">smoothed</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample_by_language</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">documents</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
        <span class="n">target_ratio</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample to match target ratio per language&quot;&quot;&quot;</span>
        <span class="n">by_lang</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">:</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">)</span>
            <span class="n">by_lang</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>

        <span class="n">sampled</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_target</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">lang</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">target_ratio</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">by_lang</span><span class="p">:</span>
                <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_target</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>
                <span class="n">lang_docs</span> <span class="o">=</span> <span class="n">by_lang</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lang_docs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n_samples</span><span class="p">:</span>
                    <span class="c1"># Downsample</span>
                    <span class="n">sampled</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">lang_docs</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Upsample</span>
                    <span class="n">sampled</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">lang_docs</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">sampled</span>
</code></pre></div>

<hr />
<h2 id="5-data-quality-evaluation">5. Data Quality Evaluation<a class="header-link" href="#5-data-quality-evaluation" title="Permanent link">&para;</a></h2>
<h3 id="51-automatic-quality-scoring">5.1 Automatic Quality Scoring<a class="header-link" href="#51-automatic-quality-scoring" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">kenlm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoModelForSequenceClassification</span><span class="p">,</span> <span class="n">AutoTokenizer</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DataQualityScorer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Automatic data quality evaluation&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">perplexity_model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">classifier_model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="c1"># 1. Perplexity-based (KenLM)</span>
        <span class="k">if</span> <span class="n">perplexity_model_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lm</span> <span class="o">=</span> <span class="n">kenlm</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">perplexity_model_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lm</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># 2. Classifier-based (e.g., Wikipedia vs Web)</span>
        <span class="k">if</span> <span class="n">classifier_model_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                <span class="n">classifier_model_name</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">classifier_model_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">perplexity_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        KenLM perplexity score</span>

<span class="sd">        Lower is better (more natural text for language model)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Sentence-level perplexity</span>
        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">bos</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eos</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">perplexity</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">score</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">perplexity</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">classifier_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Quality classifier score (0-1)</span>

<span class="sd">        Higher is better quality</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.5</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
            <span class="n">text</span><span class="p">[:</span><span class="mi">512</span><span class="p">],</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s1">&#39;pt&#39;</span><span class="p">,</span>
            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Positive class probability</span>
        <span class="k">return</span> <span class="n">probs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">heuristic_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Heuristic-based quality score&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># 1. Alphabet ratio</span>
            <span class="s1">&#39;alpha_ratio&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>

            <span class="c1"># 2. Average words per line</span>
            <span class="s1">&#39;words_per_line&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>

            <span class="c1"># 3. Unique lines ratio</span>
            <span class="s1">&#39;unique_lines_ratio&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>

            <span class="c1"># 4. Punctuation ratio</span>
            <span class="s1">&#39;punct_ratio&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="s1">&#39;.,!?;:&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>

            <span class="c1"># 5. Uppercase ratio (too high suggests spam)</span>
            <span class="s1">&#39;caps_ratio&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>

            <span class="c1"># 6. Digit ratio</span>
            <span class="s1">&#39;digit_ratio&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">scores</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">combined_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combined quality score&quot;&quot;&quot;</span>
        <span class="n">heuristics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristic_score</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="c1"># Ideal range for each heuristic</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Alphabet ratio: 0.7-0.9 ideal</span>
        <span class="k">if</span> <span class="n">heuristics</span><span class="p">[</span><span class="s1">&#39;alpha_ratio&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">*=</span> <span class="mf">0.8</span>

        <span class="c1"># Uppercase ratio: &lt; 0.1 ideal</span>
        <span class="k">if</span> <span class="n">heuristics</span><span class="p">[</span><span class="s1">&#39;caps_ratio&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">*=</span> <span class="mf">0.7</span>

        <span class="c1"># Unique lines: &gt; 0.8 ideal</span>
        <span class="k">if</span> <span class="n">heuristics</span><span class="p">[</span><span class="s1">&#39;unique_lines_ratio&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">*=</span> <span class="mf">0.6</span>

        <span class="c1"># Perplexity score (lower is better)</span>
        <span class="n">ppl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perplexity_score</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ppl</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">*=</span> <span class="mf">0.5</span>
        <span class="k">elif</span> <span class="n">ppl</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">*=</span> <span class="mf">0.8</span>

        <span class="k">return</span> <span class="n">score</span>
</code></pre></div>

<hr />
<h2 id="6-practice-fineweb-style-pipeline">6. Practice: FineWeb-style Pipeline<a class="header-link" href="#6-practice-fineweb-style-pipeline" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FineWebPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FineWeb-style data pipeline</span>

<span class="sd">    Steps:</span>
<span class="sd">    1. URL filtering</span>
<span class="sd">    2. Text extraction</span>
<span class="sd">    3. Language detection</span>
<span class="sd">    4. Quality filtering</span>
<span class="sd">    5. Deduplication</span>
<span class="sd">    6. PII removal</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_filter</span> <span class="o">=</span> <span class="n">QualityFilter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dedup</span> <span class="o">=</span> <span class="n">DeduplicationPipeline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_scorer</span> <span class="o">=</span> <span class="n">DataQualityScorer</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">warc_batch</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process batch&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">warc_batch</span><span class="p">:</span>
            <span class="c1"># 1. URL filtering</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url_filter</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]):</span>
                <span class="k">continue</span>

            <span class="c1"># 2. Text extraction</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_text</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;html&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># 3. Quality filtering</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality_filter</span><span class="o">.</span><span class="n">filter_document</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># 4. Quality score</span>
            <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality_scorer</span><span class="o">.</span><span class="n">combined_score</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># 5. PII masking</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_pii</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">],</span>
                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
                <span class="s1">&#39;quality_score&#39;</span><span class="p">:</span> <span class="n">score</span>
            <span class="p">})</span>

        <span class="c1"># 6. Deduplication</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dedup</span><span class="o">.</span><span class="n">deduplicate_stream</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_url_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;URL-based filtering&quot;&quot;&quot;</span>
        <span class="c1"># Blacklist domains</span>
        <span class="n">blacklist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;porn&#39;</span><span class="p">,</span> <span class="s1">&#39;xxx&#39;</span><span class="p">,</span> <span class="s1">&#39;adult&#39;</span><span class="p">,</span> <span class="s1">&#39;gambling&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">b</span> <span class="ow">in</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Allowed extensions</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.gif&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract main text from HTML&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">trafilatura</span>
        <span class="k">return</span> <span class="n">trafilatura</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">html</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_mask_pii</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mask personal information&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

        <span class="c1"># Email</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b[\w.-]+@[\w.-]+\.\w+\b&#39;</span><span class="p">,</span> <span class="s1">&#39;[EMAIL]&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="c1"># Phone number (US format)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b\d</span><span class="si">{3}</span><span class="s1">[-.]?\d</span><span class="si">{3}</span><span class="s1">[-.]?\d</span><span class="si">{4}</span><span class="s1">\b&#39;</span><span class="p">,</span> <span class="s1">&#39;[PHONE]&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="c1"># IP address</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b&#39;</span><span class="p">,</span> <span class="s1">&#39;[IP]&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="c1"># Credit card</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b\d</span><span class="si">{4}</span><span class="s1">[-\s]?\d</span><span class="si">{4}</span><span class="s1">[-\s]?\d</span><span class="si">{4}</span><span class="s1">[-\s]?\d</span><span class="si">{4}</span><span class="s1">\b&#39;</span><span class="p">,</span> <span class="s1">&#39;[CARD]&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">text</span>


<span class="c1"># Execute</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">FineWebPipeline</span><span class="p">()</span>

    <span class="c1"># Process Common Crawl batch</span>
    <span class="n">warc_batch</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>  <span class="c1"># WARC records</span>

    <span class="n">cleaned_data</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span><span class="n">warc_batch</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">warc_batch</span><span class="p">)</span><span class="si">}</span><span class="s2">, Output: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cleaned_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtering ratio: </span><span class="si">{</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">cleaned_data</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">warc_batch</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<h3 id="datasets">Datasets<a class="header-link" href="#datasets" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://pile.eleuther.ai/">The Pile</a></li>
<li><a href="https://github.com/togethercomputer/RedPajama-Data">RedPajama</a></li>
<li><a href="https://huggingface.co/datasets/HuggingFaceFW/fineweb">FineWeb</a></li>
<li><a href="https://github.com/allenai/dolma">Dolma</a></li>
</ul>
<h3 id="papers">Papers<a class="header-link" href="#papers" title="Permanent link">&para;</a></h3>
<ul>
<li>Gao et al. (2020). "The Pile: An 800GB Dataset of Diverse Text"</li>
<li>Penedo et al. (2023). "The RefinedWeb Dataset for Falcon LLM"</li>
<li>Soldaini et al. (2024). "Dolma: An Open Corpus of 3T Tokens"</li>
</ul>
<h3 id="tools">Tools<a class="header-link" href="#tools" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://github.com/adbar/trafilatura">trafilatura</a>: HTML text extraction</li>
<li><a href="https://github.com/ekzhu/datasketch">datasketch</a>: MinHash LSH</li>
<li><a href="https://fasttext.cc/">fasttext</a>: Language detection</li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Foundation_Models/04_Pretraining_Objectives.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">04. Pre-training Objectives</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Foundation_Models/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Foundation_Models/06_Pretraining_Infrastructure.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">06. Pre-training Infrastructure</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}