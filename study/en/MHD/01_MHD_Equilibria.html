{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1. MHD Equilibria - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">üíª</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        ÌïúÍµ≠Ïñ¥
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">‚òÄÔ∏è</span>
                    <span class="theme-icon dark">üåô</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/MHD/">MHD</a>
    <span class="separator">/</span>
    <span class="current">1. MHD Equilibria</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>1. MHD Equilibria</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/MHD/00_Overview.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Magnetohydrodynamics (MHD)</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/MHD/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/MHD/02_Linear_Stability.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">2. Linear Stability Theory</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#1-introduction-to-mhd-equilibria">1. Introduction to MHD Equilibria</a></li>
<li><a href="#2-derivation-of-force-balance-equation">2. Derivation of Force Balance Equation</a><ul>
<li><a href="#21-starting-from-ideal-mhd-momentum-equation">2.1 Starting from Ideal MHD Momentum Equation</a></li>
<li><a href="#22-expressing-in-terms-of-magnetic-field">2.2 Expressing in Terms of Magnetic Field</a></li>
<li><a href="#23-physical-interpretation">2.3 Physical Interpretation</a></li>
</ul>
</li>
<li><a href="#3-consequences-of-force-balance">3. Consequences of Force Balance</a><ul>
<li><a href="#31-pressure-constant-on-flux-surfaces">3.1 Pressure Constant on Flux Surfaces</a></li>
<li><a href="#32-current-perpendicular-to-pressure-gradient">3.2 Current Perpendicular to Pressure Gradient</a></li>
<li><a href="#33-flux-surface-coordinates">3.3 Flux Surface Coordinates</a></li>
</ul>
</li>
<li><a href="#4-one-dimensional-equilibria">4. One-Dimensional Equilibria</a><ul>
<li><a href="#41-pinch-longitudinal-magnetic-field">4.1 Œ∏-Pinch (Longitudinal Magnetic Field)</a></li>
<li><a href="#42-z-pinch-azimuthal-magnetic-field">4.2 Z-Pinch (Azimuthal Magnetic Field)</a></li>
<li><a href="#43-screw-pinch-combined-fields">4.3 Screw Pinch (Combined Fields)</a></li>
</ul>
</li>
<li><a href="#5-grad-shafranov-equation">5. Grad-Shafranov Equation</a><ul>
<li><a href="#51-axisymmetric-equilibria">5.1 Axisymmetric Equilibria</a></li>
<li><a href="#52-derivation-of-grad-shafranov-equation">5.2 Derivation of Grad-Shafranov Equation</a></li>
<li><a href="#53-free-functions">5.3 Free Functions</a></li>
<li><a href="#54-solovev-equilibrium-analytical-solution">5.4 Solovev Equilibrium (Analytical Solution)</a></li>
<li><a href="#55-numerical-solution-methods">5.5 Numerical Solution Methods</a></li>
</ul>
</li>
<li><a href="#6-safety-factor">6. Safety Factor</a><ul>
<li><a href="#61-definition">6.1 Definition</a></li>
<li><a href="#62-cylindrical-approximation">6.2 Cylindrical Approximation</a></li>
<li><a href="#63-relation-to-current-density">6.3 Relation to Current Density</a></li>
<li><a href="#64-significance-for-stability">6.4 Significance for Stability</a></li>
</ul>
</li>
<li><a href="#7-flux-surfaces-and-shafranov-shift">7. Flux Surfaces and Shafranov Shift</a><ul>
<li><a href="#71-nested-flux-surfaces">7.1 Nested Flux Surfaces</a></li>
<li><a href="#72-shafranov-shift">7.2 Shafranov Shift</a></li>
<li><a href="#73-flux-surface-shaping">7.3 Flux Surface Shaping</a></li>
</ul>
</li>
<li><a href="#8-plasma-beta">8. Plasma Beta</a><ul>
<li><a href="#81-definition">8.1 Definition</a></li>
<li><a href="#82-relation-between-betas">8.2 Relation Between Betas</a></li>
<li><a href="#83-beta-limits">8.3 Beta Limits</a></li>
<li><a href="#84-beta-optimization">8.4 Beta Optimization</a></li>
</ul>
</li>
<li><a href="#9-python-implementation-grad-shafranov-solver">9. Python Implementation: Grad-Shafranov Solver</a><ul>
<li><a href="#91-simple-solovev-equilibrium">9.1 Simple Solovev Equilibrium</a></li>
<li><a href="#92-numerical-grad-shafranov-solver">9.2 Numerical Grad-Shafranov Solver</a></li>
</ul>
</li>
<li><a href="#10-beta-calculation">10. Beta Calculation</a></li>
<li><a href="#summary">Summary</a></li>
<li><a href="#practice-problems">Practice Problems</a><ul>
<li><a href="#problem-1-force-balance-in-a-cylindrical-plasma">Problem 1: Force Balance in a Cylindrical Plasma</a></li>
<li><a href="#problem-2-bennett-relation-for-z-pinch">Problem 2: Bennett Relation for Z-Pinch</a></li>
<li><a href="#problem-3-grad-shafranov-with-constant-pressure">Problem 3: Grad-Shafranov with Constant Pressure</a></li>
<li><a href="#problem-4-safety-factor-and-current-profile">Problem 4: Safety Factor and Current Profile</a></li>
<li><a href="#problem-5-beta-limits">Problem 5: Beta Limits</a></li>
</ul>
</li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="1-mhd-equilibria">1. MHD Equilibria<a class="header-link" href="#1-mhd-equilibria" title="Permanent link">&para;</a></h1>
<h2 id="learning-objectives">Learning Objectives<a class="header-link" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<ul>
<li>Derive the MHD force balance equation from the ideal MHD momentum equation</li>
<li>Understand the consequences of force balance: pressure constant on flux surfaces</li>
<li>Analyze 1D equilibria: Œ∏-pinch, Z-pinch, and screw pinch configurations</li>
<li>Formulate and solve the Grad-Shafranov equation for axisymmetric equilibria</li>
<li>Calculate the safety factor q and understand its significance for stability</li>
<li>Compute plasma beta and understand operational limits</li>
<li>Implement numerical solutions for simple equilibrium configurations</li>
</ul>
<h2 id="1-introduction-to-mhd-equilibria">1. Introduction to MHD Equilibria<a class="header-link" href="#1-introduction-to-mhd-equilibria" title="Permanent link">&para;</a></h2>
<p>Magnetohydrodynamic equilibria describe the stationary configurations of a magnetized plasma where all forces are balanced and no net acceleration occurs. Understanding equilibria is fundamental to fusion energy research, astrophysical plasma physics, and any application involving confined plasmas.</p>
<p>An MHD equilibrium satisfies:</p>
<div class="highlight"><pre><span></span><code>‚àÇ/‚àÇt = 0  (time-independent)
v = 0      (static plasma)
</code></pre></div>

<p>The equilibrium state is governed by a balance between:
- <strong>Plasma pressure gradient force</strong>: ‚àáp (pushes outward)
- <strong>Magnetic tension</strong>: (B¬∑‚àá)B/Œº‚ÇÄ (pulls along field lines)
- <strong>Magnetic pressure gradient</strong>: -‚àá(B¬≤/2Œº‚ÇÄ) (pushes from high to low field)</p>
<p>The force balance equation is the foundation of all equilibrium calculations.</p>
<h2 id="2-derivation-of-force-balance-equation">2. Derivation of Force Balance Equation<a class="header-link" href="#2-derivation-of-force-balance-equation" title="Permanent link">&para;</a></h2>
<h3 id="21-starting-from-ideal-mhd-momentum-equation">2.1 Starting from Ideal MHD Momentum Equation<a class="header-link" href="#21-starting-from-ideal-mhd-momentum-equation" title="Permanent link">&para;</a></h3>
<p>The ideal MHD momentum equation is:</p>
<p>$$
\rho\frac{D\mathbf{v}}{Dt} = -\nabla p + \mathbf{J}\times\mathbf{B}
$$</p>
<p>For equilibrium, the left-hand side vanishes (no acceleration, static plasma):</p>
<p>$$
\nabla p = \mathbf{J}\times\mathbf{B}
$$</p>
<p>This is the <strong>fundamental MHD equilibrium equation</strong>.</p>
<h3 id="22-expressing-in-terms-of-magnetic-field">2.2 Expressing in Terms of Magnetic Field<a class="header-link" href="#22-expressing-in-terms-of-magnetic-field" title="Permanent link">&para;</a></h3>
<p>Using Amp√®re's law (neglecting displacement current):</p>
<p>$$
\mathbf{J} = \frac{1}{\mu_0}\nabla\times\mathbf{B}
$$</p>
<p>The force balance becomes:</p>
<p>$$
\nabla p = \frac{1}{\mu_0}(\nabla\times\mathbf{B})\times\mathbf{B}
$$</p>
<p>Using the vector identity:</p>
<p>$$
(\nabla\times\mathbf{B})\times\mathbf{B} = (\mathbf{B}\cdot\nabla)\mathbf{B} - \nabla\left(\frac{B^2}{2}\right)
$$</p>
<p>We obtain:</p>
<p>$$
\nabla p = \frac{1}{\mu_0}\left[(\mathbf{B}\cdot\nabla)\mathbf{B} - \nabla\left(\frac{B^2}{2}\right)\right]
$$</p>
<p>Rearranging:</p>
<p>$$
\nabla\left(p + \frac{B^2}{2\mu_0}\right) = \frac{1}{\mu_0}(\mathbf{B}\cdot\nabla)\mathbf{B}
$$</p>
<p>The left side is the gradient of <strong>total pressure</strong> (kinetic + magnetic):</p>
<p>$$
p_{total} = p + \frac{B^2}{2\mu_0}
$$</p>
<p>The right side represents <strong>magnetic tension</strong> along field lines.</p>
<h3 id="23-physical-interpretation">2.3 Physical Interpretation<a class="header-link" href="#23-physical-interpretation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Force Balance Components:
=======================

1. Pressure gradient: ‚àáp
   - Pushes from high to low pressure
   - Isotropic force

2. Magnetic pressure: -‚àá(B¬≤/2Œº‚ÇÄ)
   - Pushes from high to low field
   - Acts perpendicular to B

3. Magnetic tension: (B¬∑‚àá)B/Œº‚ÇÄ
   - Pulls along curved field lines
   - Like a stretched rubber band

Net force: ‚àáp + ‚àá(B¬≤/2Œº‚ÇÄ) - (B¬∑‚àá)B/Œº‚ÇÄ = 0
</code></pre></div>

<h2 id="3-consequences-of-force-balance">3. Consequences of Force Balance<a class="header-link" href="#3-consequences-of-force-balance" title="Permanent link">&para;</a></h2>
<h3 id="31-pressure-constant-on-flux-surfaces">3.1 Pressure Constant on Flux Surfaces<a class="header-link" href="#31-pressure-constant-on-flux-surfaces" title="Permanent link">&para;</a></h3>
<p>Taking the dot product of the force balance equation with <strong>B</strong>:</p>
<p>$$
\mathbf{B}\cdot\nabla p = \mathbf{B}\cdot(\mathbf{J}\times\mathbf{B}) = 0
$$</p>
<p>This implies:</p>
<p>$$
\mathbf{B}\cdot\nabla p = 0
$$</p>
<p><strong>Consequence</strong>: Pressure is constant along magnetic field lines. In toroidal configurations, field lines lie on nested flux surfaces, so <strong>pressure is constant on each flux surface</strong>.</p>
<h3 id="32-current-perpendicular-to-pressure-gradient">3.2 Current Perpendicular to Pressure Gradient<a class="header-link" href="#32-current-perpendicular-to-pressure-gradient" title="Permanent link">&para;</a></h3>
<p>Taking the dot product of the force balance equation with <strong>J</strong>:</p>
<p>$$
\mathbf{J}\cdot\nabla p = \mathbf{J}\cdot(\mathbf{J}\times\mathbf{B}) = 0
$$</p>
<p>This implies:</p>
<p>$$
\mathbf{J}\cdot\nabla p = 0
$$</p>
<p><strong>Consequence</strong>: Current flows perpendicular to the pressure gradient, hence current also lies on flux surfaces.</p>
<h3 id="33-flux-surface-coordinates">3.3 Flux Surface Coordinates<a class="header-link" href="#33-flux-surface-coordinates" title="Permanent link">&para;</a></h3>
<p>The above two results mean that both <strong>B</strong> and <strong>J</strong> lie on surfaces of constant pressure. These surfaces are called <strong>magnetic flux surfaces</strong>. This is the foundation of flux surface coordinates used in tokamak equilibrium calculations.</p>
<div class="highlight"><pre><span></span><code>Flux Surface Structure:
======================

        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ             ‚îÇ   Outer flux surface (low p)
        ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
        ‚îÇ  ‚îÇ       ‚îÇ  ‚îÇ   Middle flux surface
        ‚îÇ  ‚îÇ   ‚îå‚îÄ‚îê ‚îÇ  ‚îÇ
        ‚îÇ  ‚îÇ   ‚îÇ¬∑‚îÇ ‚îÇ  ‚îÇ   Magnetic axis (peak p)
        ‚îÇ  ‚îÇ   ‚îî‚îÄ‚îò ‚îÇ  ‚îÇ
        ‚îÇ  ‚îÇ       ‚îÇ  ‚îÇ
        ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
        ‚îÇ             ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Properties:
- p = p(œà) where œà labels the flux surface
- B lies in flux surfaces
- J lies in flux surfaces
</code></pre></div>

<h2 id="4-one-dimensional-equilibria">4. One-Dimensional Equilibria<a class="header-link" href="#4-one-dimensional-equilibria" title="Permanent link">&para;</a></h2>
<h3 id="41-pinch-longitudinal-magnetic-field">4.1 Œ∏-Pinch (Longitudinal Magnetic Field)<a class="header-link" href="#41-pinch-longitudinal-magnetic-field" title="Permanent link">&para;</a></h3>
<p>The Œ∏-pinch uses a purely longitudinal (axial) magnetic field to confine plasma radially.</p>
<p><strong>Configuration</strong>:
- Cylindrical geometry (r, Œ∏, z)
- $B_z(r)$, $p(r)$
- $B_r = B_Œ∏ = 0$
- No current in plasma: $J_z = 0$</p>
<p><strong>Force Balance</strong>:</p>
<p>In cylindrical coordinates:</p>
<p>$$
\frac{dp}{dr} = -\frac{1}{\mu_0}\frac{d}{dr}\left(\frac{B_z^2}{2}\right)
$$</p>
<p>Integrating from $r$ to the plasma edge at $r=a$ (where $p(a)=0$):</p>
<p>$$
p(r) = \frac{B_z^2(a) - B_z^2(r)}{2\mu_0}
$$</p>
<p><strong>Physical Picture</strong>:
- Plasma pressure balanced by magnetic pressure
- No magnetic tension (straight field lines)
- Pure radial confinement</p>
<p><strong>Bennett Relation</strong> (total pressure balance):</p>
<p>Integrating over the cross-section:</p>
<p>$$
\int_0^a 2\pi r\, p(r)\, dr = \frac{\pi a^2 B_{ext}^2}{2\mu_0}
$$</p>
<p>where $B_{ext}$ is the external field.</p>
<h3 id="42-z-pinch-azimuthal-magnetic-field">4.2 Z-Pinch (Azimuthal Magnetic Field)<a class="header-link" href="#42-z-pinch-azimuthal-magnetic-field" title="Permanent link">&para;</a></h3>
<p>The Z-pinch uses a self-generated azimuthal magnetic field from an axial current.</p>
<p><strong>Configuration</strong>:
- $B_Œ∏(r)$, $p(r)$
- $J_z(r)$ (axial current)
- $B_r = B_z = 0$</p>
<p><strong>Amp√®re's Law</strong>:</p>
<p>$$
B_Œ∏(r) = \frac{\mu_0}{2\pi r}\int_0^r J_z(r')2\pi r'\, dr' = \frac{\mu_0 I(r)}{2\pi r}
$$</p>
<p>where $I(r)$ is the current enclosed within radius $r$.</p>
<p><strong>Force Balance</strong>:</p>
<p>$$
\frac{dp}{dr} = -\frac{1}{\mu_0}\frac{d}{dr}\left(\frac{B_Œ∏^2}{2}\right) = -\frac{B_Œ∏}{\mu_0 r}
$$</p>
<p>Using $B_Œ∏ = \mu_0 I/(2\pi r)$:</p>
<p>$$
\frac{dp}{dr} = -\frac{J_z B_Œ∏}{\mu_0}
$$</p>
<p><strong>Bennett Relation</strong> (dimensional analysis):</p>
<p>For a uniform current density $J_z = I/(\pi a^2)$:</p>
<p>$$
I^2 = \frac{8\pi}{\mu_0}NkT
$$</p>
<p>where $N$ is the total number of particles and $T$ is temperature.</p>
<p><strong>Physical Picture</strong>:
- Current generates azimuthal field
- Magnetic pressure pinches plasma inward
- Plasma pressure pushes outward
- Highly unstable (kink, sausage instabilities)</p>
<h3 id="43-screw-pinch-combined-fields">4.3 Screw Pinch (Combined Fields)<a class="header-link" href="#43-screw-pinch-combined-fields" title="Permanent link">&para;</a></h3>
<p>The screw pinch combines axial and azimuthal fields for improved stability.</p>
<p><strong>Configuration</strong>:
- $B_z(r)$, $B_Œ∏(r)$, $p(r)$
- $J_z(r)$, $J_Œ∏(r)$</p>
<p><strong>Force Balance</strong>:</p>
<p>$$
\frac{dp}{dr} = -\frac{1}{\mu_0}\frac{d}{dr}\left(\frac{B_z^2 + B_Œ∏^2}{2}\right)
$$</p>
<p><strong>Safety Factor</strong> (pitch of field lines):</p>
<p>$$
q(r) = \frac{rB_z}{RB_Œ∏}
$$</p>
<p>where $R$ is the major radius (for toroidal systems) or a characteristic length.</p>
<p><strong>Physical Picture</strong>:
- $B_z$ provides stability against kink modes
- $B_Œ∏$ provides confinement
- Shear in $q(r)$ stabilizes short-wavelength modes
- Basis for tokamak confinement</p>
<div class="highlight"><pre><span></span><code>Screw Pinch Field Line:
======================

      z ^
        |    /
        |   / ‚Üê Field line spirals
        |  /
        | /
        |/________&gt; Œ∏

q = Œîz / (2œÄR) per poloidal turn
</code></pre></div>

<h2 id="5-grad-shafranov-equation">5. Grad-Shafranov Equation<a class="header-link" href="#5-grad-shafranov-equation" title="Permanent link">&para;</a></h2>
<h3 id="51-axisymmetric-equilibria">5.1 Axisymmetric Equilibria<a class="header-link" href="#51-axisymmetric-equilibria" title="Permanent link">&para;</a></h3>
<p>For axisymmetric toroidal systems (tokamaks, stellarators in simplified form), the equilibrium can be described by a single scalar function: the <strong>poloidal flux function</strong> $\psi(R,Z)$.</p>
<p><strong>Cylindrical Coordinates</strong>: $(R, \phi, Z)$ where $\phi$ is the toroidal angle.</p>
<p><strong>Magnetic Field Representation</strong>:</p>
<p>$$
\mathbf{B} = F(R,Z)\nabla\phi + \nabla\phi\times\nabla\psi
$$</p>
<p>where:
- $F(R,Z) = RB_\phi$ (toroidal field function)
- $\psi$ is the poloidal flux function</p>
<p>In component form:</p>
<p>$$
B_R = \frac{1}{R}\frac{\partial\psi}{\partial Z}, \quad B_Z = -\frac{1}{R}\frac{\partial\psi}{\partial R}, \quad B_\phi = \frac{F}{R}
$$</p>
<h3 id="52-derivation-of-grad-shafranov-equation">5.2 Derivation of Grad-Shafranov Equation<a class="header-link" href="#52-derivation-of-grad-shafranov-equation" title="Permanent link">&para;</a></h3>
<p>Starting from the force balance:</p>
<p>$$
\nabla p = \mathbf{J}\times\mathbf{B}
$$</p>
<p>and using $\mathbf{J} = \nabla\times\mathbf{B}/\mu_0$, the toroidal component gives:</p>
<p>$$
\frac{dp}{d\psi} = -\frac{1}{\mu_0 R^2}\frac{dF}{d\psi}F
$$</p>
<p>The poloidal component yields the <strong>Grad-Shafranov equation</strong>:</p>
<p>$$
\Delta^*\psi \equiv R\frac{\partial}{\partial R}\left(\frac{1}{R}\frac{\partial\psi}{\partial R}\right) + \frac{\partial^2\psi}{\partial Z^2} = -\mu_0 R^2\frac{dp}{d\psi} - F\frac{dF}{d\psi}
$$</p>
<p>This is an <strong>elliptic partial differential equation</strong> for $\psi(R,Z)$.</p>
<h3 id="53-free-functions">5.3 Free Functions<a class="header-link" href="#53-free-functions" title="Permanent link">&para;</a></h3>
<p>The Grad-Shafranov equation requires two <strong>free functions</strong> to be specified:</p>
<ol>
<li><strong>Pressure profile</strong>: $p(\psi)$</li>
<li><strong>Toroidal field function</strong>: $F(\psi)$ (or equivalently $F^2(\psi)$)</li>
</ol>
<p>These functions are determined by:
- Plasma heating and current drive
- Boundary conditions (conducting walls, external coils)
- Transport processes (beyond MHD)</p>
<p>Common choices for analytic solutions:
- $p(\psi) = p_0(1 - \psi/\psi_0)^\alpha$
- $F^2(\psi) = F_0^2 + \beta(\psi - \psi_0)$</p>
<h3 id="54-solovev-equilibrium-analytical-solution">5.4 Solovev Equilibrium (Analytical Solution)<a class="header-link" href="#54-solovev-equilibrium-analytical-solution" title="Permanent link">&para;</a></h3>
<p>For the free functions:</p>
<p>$$
p(\psi) = 0, \quad F^2(\psi) = F_0^2 + c\psi
$$</p>
<p>the Grad-Shafranov equation becomes linear:</p>
<p>$$
\Delta^*\psi = -\mu_0 c R^2
$$</p>
<p><strong>Solovev solution</strong> (for circular cross-section):</p>
<p>$$
\psi(R,Z) = \frac{1}{8}c\mu_0\left[(R^2 - R_0^2)^2 + Z^2\right] + \psi_0
$$</p>
<p>This represents circular flux surfaces shifted outward by the Shafranov shift.</p>
<h3 id="55-numerical-solution-methods">5.5 Numerical Solution Methods<a class="header-link" href="#55-numerical-solution-methods" title="Permanent link">&para;</a></h3>
<p>For general $p(\psi)$ and $F(\psi)$, the Grad-Shafranov equation must be solved numerically:</p>
<p><strong>Iterative Scheme</strong>:
1. Guess initial $\psi^{(0)}(R,Z)$
2. Compute $p(\psi^{(n)})$ and $F(\psi^{(n)})$
3. Solve linear elliptic equation:
   $$
   \Delta^*\psi^{(n+1)} = -\mu_0 R^2\frac{dp}{d\psi}\Big|_{\psi^{(n)}} - F\frac{dF}{d\psi}\Big|_{\psi^{(n)}}
   $$
4. Iterate until convergence: $|\psi^{(n+1)} - \psi^{(n)}| < \epsilon$</p>
<p><strong>Discretization</strong>: Finite difference or finite element methods on $(R,Z)$ grid.</p>
<h2 id="6-safety-factor">6. Safety Factor<a class="header-link" href="#6-safety-factor" title="Permanent link">&para;</a></h2>
<h3 id="61-definition">6.1 Definition<a class="header-link" href="#61-definition" title="Permanent link">&para;</a></h3>
<p>The <strong>safety factor</strong> $q(\psi)$ measures the pitch of magnetic field lines on a flux surface:</p>
<p>$$
q = \frac{1}{2\pi}\oint\frac{d\ell_\parallel}{Rd\phi}
$$</p>
<p>where the integral is over one poloidal turn.</p>
<p><strong>Physical Interpretation</strong>:
- $q$ is the number of toroidal turns a field line makes per poloidal turn
- Rational values ($q = m/n$) define <strong>resonant surfaces</strong> where perturbations can resonate</p>
<h3 id="62-cylindrical-approximation">6.2 Cylindrical Approximation<a class="header-link" href="#62-cylindrical-approximation" title="Permanent link">&para;</a></h3>
<p>For a large-aspect-ratio tokamak ($R \approx R_0 + r\cos\theta$):</p>
<p>$$
q(r) \approx \frac{rB_z}{R_0 B_Œ∏}
$$</p>
<p>Using $B_Œ∏ = \mu_0 I(r)/(2\pi r)$:</p>
<p>$$
q(r) = \frac{2\pi r^2 B_z}{\mu_0 R_0 I(r)}
$$</p>
<h3 id="63-relation-to-current-density">6.3 Relation to Current Density<a class="header-link" href="#63-relation-to-current-density" title="Permanent link">&para;</a></h3>
<p>Differentiating:</p>
<p>$$
\frac{dq}{dr} = \frac{2\pi r B_z}{\mu_0 R_0}\left(\frac{2}{I} - \frac{r J_z}{I}\right)
$$</p>
<p><strong>Magnetic Shear</strong>:</p>
<p>$$
s = \frac{r}{q}\frac{dq}{dr}
$$</p>
<p>Positive shear ($dq/dr > 0$) is typically stabilizing.</p>
<h3 id="64-significance-for-stability">6.4 Significance for Stability<a class="header-link" href="#64-significance-for-stability" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Kruskal-Shafranov criterion</strong>: External kink modes require $q(a) > m/n$</li>
<li>For $m=1, n=1$: $q(a) > 1$ is necessary (but not sufficient)</li>
<li><strong>Internal kink</strong> (sawtooth oscillations): $q(0) < 1$</li>
<li><strong>Rational surfaces</strong> $q = m/n$: sites of tearing modes</li>
</ul>
<div class="highlight"><pre><span></span><code>Typical q-profile in Tokamak:
============================

q |     ___________________  q(a) &gt; 2
  |    /
  |   /                     ‚Üê monotonic (positive shear)
  |  /
  | /                       q(0) ~ 1
  |/________________________ r
  0                        a

Features:
<span class="k">-</span> q(0) ~ 1 (on-axis)
<span class="k">-</span> q(a) &gt; 2-3 (edge, for stability)
<span class="k">-</span> Reversed shear: dq/dr &lt; 0 in core (advanced scenarios)
</code></pre></div>

<h2 id="7-flux-surfaces-and-shafranov-shift">7. Flux Surfaces and Shafranov Shift<a class="header-link" href="#7-flux-surfaces-and-shafranov-shift" title="Permanent link">&para;</a></h2>
<h3 id="71-nested-flux-surfaces">7.1 Nested Flux Surfaces<a class="header-link" href="#71-nested-flux-surfaces" title="Permanent link">&para;</a></h3>
<p>In a well-confined plasma, flux surfaces are nested topological tori. The magnetic axis (innermost surface) is the surface with:
- Highest pressure
- $q(\psi_{axis})$ minimum
- $|\nabla\psi| = 0$</p>
<h3 id="72-shafranov-shift">7.2 Shafranov Shift<a class="header-link" href="#72-shafranov-shift" title="Permanent link">&para;</a></h3>
<p>Due to toroidal effects, the magnetic axis is shifted <strong>outward</strong> (larger $R$) relative to the geometric center.</p>
<p><strong>Physical Origin</strong>:
- Higher field on inboard side ‚Üí higher magnetic pressure
- Plasma pressure gradient creates outward shift to balance</p>
<p><strong>Approximate Formula</strong>:</p>
<p>$$
\Delta_{Shafranov} \approx \frac{a^2\beta_p}{2R_0}
$$</p>
<p>where $\beta_p = 2\mu_0\langle p\rangle/B_p^2$ is the poloidal beta.</p>
<h3 id="73-flux-surface-shaping">7.3 Flux Surface Shaping<a class="header-link" href="#73-flux-surface-shaping" title="Permanent link">&para;</a></h3>
<p>Modern tokamaks use non-circular cross-sections:
- <strong>Elongation</strong> $\kappa = b/a$ (vertical stretching): improves stability and confinement
- <strong>Triangularity</strong> $\delta$: indentation of inboard side, stabilizes ballooning modes</p>
<h2 id="8-plasma-beta">8. Plasma Beta<a class="header-link" href="#8-plasma-beta" title="Permanent link">&para;</a></h2>
<h3 id="81-definition">8.1 Definition<a class="header-link" href="#81-definition" title="Permanent link">&para;</a></h3>
<p><strong>Plasma beta</strong> is the ratio of plasma pressure to magnetic pressure:</p>
<p>$$
\beta = \frac{2\mu_0 p}{B^2}
$$</p>
<p><strong>Volume-averaged beta</strong>:</p>
<p>$$
\langle\beta\rangle = \frac{2\mu_0\langle p\rangle}{\langle B^2\rangle}
$$</p>
<p><strong>Poloidal beta</strong>:</p>
<p>$$
\beta_p = \frac{2\mu_0\langle p\rangle}{B_p^2}
$$</p>
<p><strong>Toroidal beta</strong>:</p>
<p>$$
\beta_t = \frac{2\mu_0\langle p\rangle}{B_t^2}
$$</p>
<h3 id="82-relation-between-betas">8.2 Relation Between Betas<a class="header-link" href="#82-relation-between-betas" title="Permanent link">&para;</a></h3>
<p>For large-aspect-ratio tokamak:</p>
<p>$$
\beta_t \approx \beta_p\left(\frac{B_p}{B_t}\right)^2 \approx \beta_p\left(\frac{a}{R_0}\right)^2\frac{1}{q^2}
$$</p>
<h3 id="83-beta-limits">8.3 Beta Limits<a class="header-link" href="#83-beta-limits" title="Permanent link">&para;</a></h3>
<p>High beta is desirable for fusion reactors (more fusion power), but MHD stability limits $\beta$:</p>
<p><strong>Troyon limit</strong> (empirical scaling):</p>
<p>$$
\beta_N \equiv \frac{\beta_t(\%)}{I_p/(aB_t)} \lesssim 2.8 - 3.5
$$</p>
<p>where $I_p$ is plasma current (MA), $a$ in meters, $B_t$ in Tesla.</p>
<p><strong>Physical origin</strong>:
- High $\beta$ ‚Üí strong pressure gradient ‚Üí pressure-driven instabilities
- External kink modes limit $\beta$ at fixed $q(a)$</p>
<h3 id="84-beta-optimization">8.4 Beta Optimization<a class="header-link" href="#84-beta-optimization" title="Permanent link">&para;</a></h3>
<p>Strategies to increase beta limit:
- High elongation $\kappa$
- High triangularity $\delta$
- Conducting wall stabilization
- Plasma rotation
- Advanced tokamak scenarios (reversed shear, transport barriers)</p>
<h2 id="9-python-implementation-grad-shafranov-solver">9. Python Implementation: Grad-Shafranov Solver<a class="header-link" href="#9-python-implementation-grad-shafranov-solver" title="Permanent link">&para;</a></h2>
<h3 id="91-simple-solovev-equilibrium">9.1 Simple Solovev Equilibrium<a class="header-link" href="#91-simple-solovev-equilibrium" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">solve</span>

<span class="c1"># Solovev equilibrium solver</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SolovevEquilibrium</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">Bt0</span><span class="p">,</span> <span class="n">Ip</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        R0: major radius [m]</span>
<span class="sd">        a: minor radius [m]</span>
<span class="sd">        kappa: elongation</span>
<span class="sd">        delta: triangularity</span>
<span class="sd">        Bt0: toroidal field on axis [T]</span>
<span class="sd">        Ip: plasma current [A]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R0</span> <span class="o">=</span> <span class="n">R0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="n">kappa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bt0</span> <span class="o">=</span> <span class="n">Bt0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ip</span> <span class="o">=</span> <span class="n">Ip</span>

        <span class="c1"># Physical constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1e-7</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_psi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute poloidal flux function (Solovev solution)&quot;&quot;&quot;</span>
        <span class="c1"># Simplified Solovev: circular, low beta</span>
        <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ip</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Normalized coordinates</span>
        <span class="n">r_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">R</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">R0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Z</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>

        <span class="c1"># Flux function (normalized)</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="o">-</span><span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">R0</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">r_norm</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">8</span>

        <span class="k">return</span> <span class="n">psi</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_B</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute magnetic field components&quot;&quot;&quot;</span>
        <span class="c1"># Numerical derivatives</span>
        <span class="n">dR</span> <span class="o">=</span> <span class="mf">0.001</span>
        <span class="n">dZ</span> <span class="o">=</span> <span class="mf">0.001</span>

        <span class="n">dpsi_dR</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R</span><span class="o">+</span><span class="n">dR</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R</span><span class="o">-</span><span class="n">dR</span><span class="p">,</span> <span class="n">Z</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dR</span><span class="p">)</span>
        <span class="n">dpsi_dZ</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="o">+</span><span class="n">dZ</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="o">-</span><span class="n">dZ</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dZ</span><span class="p">)</span>

        <span class="n">BR</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">R</span> <span class="o">*</span> <span class="n">dpsi_dZ</span>
        <span class="n">BZ</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">R</span> <span class="o">*</span> <span class="n">dpsi_dR</span>
        <span class="n">Bphi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bt0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">R0</span> <span class="o">/</span> <span class="n">R</span>

        <span class="k">return</span> <span class="n">BR</span><span class="p">,</span> <span class="n">BZ</span><span class="p">,</span> <span class="n">Bphi</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psi_vals</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute safety factor profile&quot;&quot;&quot;</span>
        <span class="c1"># Simplified q-profile for circular equilibrium</span>
        <span class="n">psi_edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">psi_norm</span> <span class="o">=</span> <span class="n">psi_vals</span> <span class="o">/</span> <span class="n">psi_edge</span>

        <span class="c1"># Parabolic q-profile</span>
        <span class="n">q0</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># On-axis q</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="mf">3.0</span>  <span class="c1"># Edge q</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">q0</span> <span class="o">+</span> <span class="p">(</span><span class="n">qa</span> <span class="o">-</span> <span class="n">q0</span><span class="p">)</span> <span class="o">*</span> <span class="n">psi_norm</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">return</span> <span class="n">q</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_flux_surfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nr</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">nz</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot flux surfaces&quot;&quot;&quot;</span>
        <span class="n">R_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R0</span> <span class="o">-</span> <span class="mf">1.2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R0</span> <span class="o">+</span> <span class="mf">1.2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">nr</span><span class="p">)</span>
        <span class="n">Z_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">nz</span><span class="p">)</span>

        <span class="n">R_mesh</span><span class="p">,</span> <span class="n">Z_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">R_grid</span><span class="p">,</span> <span class="n">Z_grid</span><span class="p">)</span>
        <span class="n">psi_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R_mesh</span><span class="p">,</span> <span class="n">Z_mesh</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="c1"># Contour plot of flux surfaces</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">CS</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">R_mesh</span><span class="p">,</span> <span class="n">Z_mesh</span><span class="p">,</span> <span class="n">psi_mesh</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="c1"># Mark magnetic axis</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;r*&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Magnetic axis&#39;</span><span class="p">)</span>

        <span class="c1"># Mark last closed flux surface</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">R_lcfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="n">Z_lcfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">R_lcfs</span><span class="p">,</span> <span class="n">Z_lcfs</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;LCFS&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;R [m]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Z [m]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Flux Surfaces (Solovev Equilibrium)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_q_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot safety factor profile&quot;&quot;&quot;</span>
        <span class="c1"># Radial coordinate (minor radius)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">R_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R0</span> <span class="o">+</span> <span class="n">r</span>
        <span class="n">Z_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># Compute psi along midplane</span>
        <span class="n">psi_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">R_vals</span><span class="p">])</span>

        <span class="c1"># Compute q</span>
        <span class="n">q_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_q</span><span class="p">(</span><span class="n">psi_vals</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">q_vals</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;q = 1 (sawtooth)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;q = 2 (m=2 resonance)&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a (normalized radius)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;q (safety factor)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Safety Factor Profile&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_pressure_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot pressure and current density profiles&quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="c1"># Parabolic pressure profile</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="mf">1e5</span>  <span class="c1"># Central pressure [Pa]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># Current density (from force balance)</span>
        <span class="c1"># J_phi ~ dp/dr (simplified)</span>
        <span class="n">dp_dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">j_phi</span> <span class="o">=</span> <span class="o">-</span><span class="n">dp_dr</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bt0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">R0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span>  <span class="c1"># Normalized</span>

        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="c1"># Pressure</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pressure [kPa]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pressure Profile&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Current density</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">j_phi</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Current Density (normalized)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Toroidal Current Density Profile&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Example usage</span>
<span class="k">def</span><span class="w"> </span><span class="nf">example_tokamak_equilibrium</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ITER-like parameters&quot;&quot;&quot;</span>
    <span class="n">R0</span> <span class="o">=</span> <span class="mf">6.2</span>    <span class="c1"># Major radius [m]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span>     <span class="c1"># Minor radius [m]</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="mf">1.7</span> <span class="c1"># Elongation</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="mf">0.33</span><span class="c1"># Triangularity</span>
    <span class="n">Bt0</span> <span class="o">=</span> <span class="mf">5.3</span>   <span class="c1"># Toroidal field [T]</span>
    <span class="n">Ip</span> <span class="o">=</span> <span class="mf">15e6</span>   <span class="c1"># Plasma current [A]</span>

    <span class="n">eq</span> <span class="o">=</span> <span class="n">SolovevEquilibrium</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">Bt0</span><span class="p">,</span> <span class="n">Ip</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== ITER-like Tokamak Equilibrium ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Major radius R0 = </span><span class="si">{</span><span class="n">R0</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Minor radius a = </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aspect ratio A = </span><span class="si">{</span><span class="n">R0</span><span class="o">/</span><span class="n">a</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Elongation Œ∫ = </span><span class="si">{</span><span class="n">kappa</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Triangularity Œ¥ = </span><span class="si">{</span><span class="n">delta</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Toroidal field Bt0 = </span><span class="si">{</span><span class="n">Bt0</span><span class="si">}</span><span class="s2"> T&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plasma current Ip = </span><span class="si">{</span><span class="n">Ip</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MA&quot;</span><span class="p">)</span>

    <span class="c1"># Compute some equilibrium quantities</span>
    <span class="n">psi_axis</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">psi_edge</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R0</span> <span class="o">+</span> <span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Flux at axis: </span><span class="si">{</span><span class="n">psi_axis</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2"> Wb&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flux at edge: </span><span class="si">{</span><span class="n">psi_edge</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2"> Wb&quot;</span><span class="p">)</span>

    <span class="c1"># Safety factor</span>
    <span class="n">q_axis</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">compute_q</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">psi_axis</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">q_edge</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">compute_q</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">psi_edge</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Safety factor q(0) = </span><span class="si">{</span><span class="n">q_axis</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Safety factor q(a) = </span><span class="si">{</span><span class="n">q_edge</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Plot results</span>
    <span class="n">fig1</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">plot_flux_surfaces</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/tmp/flux_surfaces.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Flux surfaces plot saved to /tmp/flux_surfaces.png&quot;</span><span class="p">)</span>

    <span class="n">fig2</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">plot_q_profile</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/tmp/q_profile.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;q-profile plot saved to /tmp/q_profile.png&quot;</span><span class="p">)</span>

    <span class="n">fig3</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">plot_pressure_profile</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/tmp/pressure_profile.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pressure profile plot saved to /tmp/pressure_profile.png&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">example_tokamak_equilibrium</span><span class="p">()</span>
</code></pre></div>

<h3 id="92-numerical-grad-shafranov-solver">9.2 Numerical Grad-Shafranov Solver<a class="header-link" href="#92-numerical-grad-shafranov-solver" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">diags</span><span class="p">,</span> <span class="n">csr_matrix</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">spsolve</span>

<span class="k">class</span><span class="w"> </span><span class="nc">GradShafranovSolver</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Numerical solver for Grad-Shafranov equation&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R_min</span><span class="p">,</span> <span class="n">R_max</span><span class="p">,</span> <span class="n">Z_min</span><span class="p">,</span> <span class="n">Z_max</span><span class="p">,</span> <span class="n">nR</span><span class="p">,</span> <span class="n">nZ</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up computational domain</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_min</span> <span class="o">=</span> <span class="n">R_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_max</span> <span class="o">=</span> <span class="n">R_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z_min</span> <span class="o">=</span> <span class="n">Z_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z_max</span> <span class="o">=</span> <span class="n">Z_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nR</span> <span class="o">=</span> <span class="n">nR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nZ</span> <span class="o">=</span> <span class="n">nZ</span>

        <span class="c1"># Grid spacing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">=</span> <span class="p">(</span><span class="n">R_max</span> <span class="o">-</span> <span class="n">R_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nR</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dZ</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z_max</span> <span class="o">-</span> <span class="n">Z_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">R_min</span><span class="p">,</span> <span class="n">R_max</span><span class="p">,</span> <span class="n">nR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">Z_min</span><span class="p">,</span> <span class="n">Z_max</span><span class="p">,</span> <span class="n">nZ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>

        <span class="c1"># Initialize flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nZ</span><span class="p">,</span> <span class="n">nR</span><span class="p">))</span>

        <span class="c1"># Constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1e-7</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_free_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_func</span><span class="p">,</span> <span class="n">F_func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set pressure and toroidal field functions</span>
<span class="sd">        p_func: p(psi) callable</span>
<span class="sd">        F_func: F(psi) callable where F = R*B_phi</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span> <span class="o">=</span> <span class="n">p_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F_func</span> <span class="o">=</span> <span class="n">F_func</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_operator_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build discrete Grad-Shafranov operator matrix</span>
<span class="sd">        Œî* œà = R ‚àÇ/‚àÇR(1/R ‚àÇœà/‚àÇR) + ‚àÇ¬≤œà/‚àÇZ¬≤</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nR</span>
        <span class="n">nZ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nZ</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">nR</span> <span class="o">*</span> <span class="n">nZ</span>

        <span class="c1"># Flatten index: (i,j) -&gt; i*nR + j</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">idx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">i</span> <span class="o">*</span> <span class="n">nR</span> <span class="o">+</span> <span class="n">j</span>

        <span class="c1"># Build sparse matrix</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nZ</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nR</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">idx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

                <span class="c1"># Interior points</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nZ</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nR</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># R derivatives: R ‚àÇ/‚àÇR(1/R ‚àÇœà/‚àÇR)</span>
                    <span class="c1"># = ‚àÇ¬≤œà/‚àÇR¬≤ + (1/R)‚àÇœà/‚àÇR - (œà/R¬≤)</span>
                    <span class="c1"># Discretize: centered differences</span>

                    <span class="c1"># ‚àÇ¬≤œà/‚àÇR¬≤</span>
                    <span class="n">coef_R_pp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dR</span><span class="o">**</span><span class="mi">2</span>
                    <span class="n">coef_R_0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dR</span><span class="o">**</span><span class="mi">2</span>
                    <span class="n">coef_R_mm</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dR</span><span class="o">**</span><span class="mi">2</span>

                    <span class="c1"># (1/R)‚àÇœà/‚àÇR</span>
                    <span class="n">coef_R_p_1st</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">R</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dR</span><span class="p">)</span>
                    <span class="n">coef_R_m_1st</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">R</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dR</span><span class="p">)</span>

                    <span class="c1"># Z derivatives: ‚àÇ¬≤œà/‚àÇZ¬≤</span>
                    <span class="n">coef_Z_pp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dZ</span><span class="o">**</span><span class="mi">2</span>
                    <span class="n">coef_Z_0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dZ</span><span class="o">**</span><span class="mi">2</span>
                    <span class="n">coef_Z_mm</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dZ</span><span class="o">**</span><span class="mi">2</span>

                    <span class="c1"># Combine</span>
                    <span class="c1"># Center</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coef_R_0</span> <span class="o">+</span> <span class="n">coef_Z_0</span><span class="p">)</span>

                    <span class="c1"># R+1</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coef_R_pp</span> <span class="o">+</span> <span class="n">coef_R_p_1st</span><span class="p">)</span>

                    <span class="c1"># R-1</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coef_R_mm</span> <span class="o">+</span> <span class="n">coef_R_m_1st</span><span class="p">)</span>

                    <span class="c1"># Z+1</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coef_Z_pp</span><span class="p">)</span>

                    <span class="c1"># Z-1</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coef_Z_mm</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Boundary: œà = 0</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">matrix</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">matrix</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solve_fixed_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psi_boundary</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve Grad-Shafranov with fixed boundary using Picard iteration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nR</span>
        <span class="n">nZ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nZ</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">nR</span> <span class="o">*</span> <span class="n">nZ</span>

        <span class="c1"># Build operator matrix (constant for linear problem)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_operator_matrix</span><span class="p">()</span>

        <span class="c1"># Picard iteration</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
            <span class="n">psi_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Compute RHS: -Œº‚ÇÄ R¬≤ dp/dœà - F dF/dœà</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nZ</span><span class="p">,</span> <span class="n">nR</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nZ</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nR</span><span class="p">):</span>
                    <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">psi_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                    <span class="c1"># Numerical derivatives of p and F</span>
                    <span class="n">dpsi</span> <span class="o">=</span> <span class="mf">1e-6</span>
                    <span class="n">dpdpsi</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">psi_val</span> <span class="o">+</span> <span class="n">dpsi</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">psi_val</span> <span class="o">-</span> <span class="n">dpsi</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dpsi</span><span class="p">)</span>

                    <span class="n">F_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_func</span><span class="p">(</span><span class="n">psi_val</span><span class="p">)</span>
                    <span class="n">dFdpsi</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F_func</span><span class="p">(</span><span class="n">psi_val</span> <span class="o">+</span> <span class="n">dpsi</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_func</span><span class="p">(</span><span class="n">psi_val</span> <span class="o">-</span> <span class="n">dpsi</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dpsi</span><span class="p">)</span>

                    <span class="n">rhs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mu0</span> <span class="o">*</span> <span class="n">R</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dpdpsi</span> <span class="o">-</span> <span class="n">F_val</span> <span class="o">*</span> <span class="n">dFdpsi</span>

            <span class="c1"># Apply boundary conditions</span>
            <span class="n">rhs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">psi_boundary</span>
            <span class="n">rhs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">psi_boundary</span>
            <span class="n">rhs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi_boundary</span>
            <span class="n">rhs</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi_boundary</span>

            <span class="c1"># Solve linear system</span>
            <span class="n">rhs_flat</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">psi_flat</span> <span class="o">=</span> <span class="n">spsolve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">rhs_flat</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi</span> <span class="o">=</span> <span class="n">psi_flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nZ</span><span class="p">,</span> <span class="n">nR</span><span class="p">))</span>

            <span class="c1"># Check convergence</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi</span> <span class="o">-</span> <span class="n">psi_old</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">: max error = </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converged in </span><span class="si">{</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> iterations&quot;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the computed equilibrium&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="c1"># Flux surfaces</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">CS</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;R [m]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Z [m]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Poloidal Flux Surfaces&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Pressure profile</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">psi_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">psi_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">psi_flat</span><span class="p">)</span>
        <span class="n">psi_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">psi_flat</span><span class="p">)</span>
        <span class="n">psi_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">psi_min</span><span class="p">,</span> <span class="n">psi_max</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">p_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span> <span class="k">for</span> <span class="n">psi</span> <span class="ow">in</span> <span class="n">psi_range</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">psi_range</span><span class="p">,</span> <span class="n">p_range</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;œà [Wb]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pressure [kPa]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pressure Profile p(œà)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Example: solve simple equilibrium</span>
<span class="k">def</span><span class="w"> </span><span class="nf">example_gs_solver</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Example Grad-Shafranov solution&quot;&quot;&quot;</span>

    <span class="c1"># Domain: tokamak-like geometry</span>
    <span class="n">R0</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Major radius</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.3</span>   <span class="c1"># Minor radius</span>

    <span class="n">R_min</span> <span class="o">=</span> <span class="n">R0</span> <span class="o">-</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">a</span>
    <span class="n">R_max</span> <span class="o">=</span> <span class="n">R0</span> <span class="o">+</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">a</span>
    <span class="n">Z_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5</span><span class="o">*</span><span class="n">a</span>
    <span class="n">Z_max</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">a</span>

    <span class="n">nR</span> <span class="o">=</span> <span class="mi">80</span>
    <span class="n">nZ</span> <span class="o">=</span> <span class="mi">80</span>

    <span class="n">solver</span> <span class="o">=</span> <span class="n">GradShafranovSolver</span><span class="p">(</span><span class="n">R_min</span><span class="p">,</span> <span class="n">R_max</span><span class="p">,</span> <span class="n">Z_min</span><span class="p">,</span> <span class="n">Z_max</span><span class="p">,</span> <span class="n">nR</span><span class="p">,</span> <span class="n">nZ</span><span class="p">)</span>

    <span class="c1"># Define free functions</span>
    <span class="c1"># Simple parabolic pressure</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="mf">1e5</span>  <span class="c1"># 100 kPa</span>
    <span class="n">psi0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">p_func</span><span class="p">(</span><span class="n">psi</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">psi</span> <span class="o">&gt;</span> <span class="n">psi0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">psi</span><span class="o">/</span><span class="n">psi0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1"># Constant F (uniform toroidal field)</span>
    <span class="n">Bt0</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># Tesla</span>
    <span class="n">F0</span> <span class="o">=</span> <span class="n">Bt0</span> <span class="o">*</span> <span class="n">R0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">F_func</span><span class="p">(</span><span class="n">psi</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">F0</span>

    <span class="n">solver</span><span class="o">.</span><span class="n">set_free_functions</span><span class="p">(</span><span class="n">p_func</span><span class="p">,</span> <span class="n">F_func</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Grad-Shafranov Solver ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid: </span><span class="si">{</span><span class="n">nR</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">nZ</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Domain: R ‚àà [</span><span class="si">{</span><span class="n">R_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">R_max</span><span class="si">}</span><span class="s2">], Z ‚àà [</span><span class="si">{</span><span class="n">Z_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">Z_max</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Central pressure: </span><span class="si">{</span><span class="n">p0</span><span class="o">/</span><span class="mf">1e3</span><span class="si">}</span><span class="s2"> kPa&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Toroidal field: </span><span class="si">{</span><span class="n">Bt0</span><span class="si">}</span><span class="s2"> T&quot;</span><span class="p">)</span>

    <span class="c1"># Solve</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve_fixed_boundary</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>

    <span class="c1"># Plot</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">plot_solution</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/tmp/gs_solution.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Solution plot saved to /tmp/gs_solution.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">example_gs_solver</span><span class="p">()</span>
</code></pre></div>

<h2 id="10-beta-calculation">10. Beta Calculation<a class="header-link" href="#10-beta-calculation" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compute_beta</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">p_profile</span><span class="p">,</span> <span class="n">B_profiles</span><span class="p">,</span> <span class="n">nr</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute various beta values for a tokamak equilibrium</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    R0: major radius [m]</span>
<span class="sd">    a: minor radius [m]</span>
<span class="sd">    p_profile: function p(r) giving pressure profile</span>
<span class="sd">    B_profiles: dict with &#39;Bt&#39;, &#39;Bp&#39; functions of r</span>
<span class="sd">    nr: number of radial points</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dict with beta_p, beta_t, beta_N</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">nr</span><span class="p">)</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Volume element in torus: dV = 2œÄ R‚ÇÄ ¬∑ 2œÄr dr</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">volume_element</span><span class="p">(</span><span class="n">r_val</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">R0</span> <span class="o">*</span> <span class="n">r_val</span> <span class="o">*</span> <span class="n">dr</span>

    <span class="c1"># Compute volume-averaged quantities</span>
    <span class="n">p_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p_profile</span><span class="p">(</span><span class="n">r_val</span><span class="p">)</span> <span class="k">for</span> <span class="n">r_val</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>
    <span class="n">Bt_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">B_profiles</span><span class="p">[</span><span class="s1">&#39;Bt&#39;</span><span class="p">](</span><span class="n">r_val</span><span class="p">)</span> <span class="k">for</span> <span class="n">r_val</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>
    <span class="n">Bp_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">B_profiles</span><span class="p">[</span><span class="s1">&#39;Bp&#39;</span><span class="p">](</span><span class="n">r_val</span><span class="p">)</span> <span class="k">for</span> <span class="n">r_val</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>

    <span class="c1"># Volume integrals</span>
    <span class="n">V_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">volume_element</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr</span><span class="p">)])</span>

    <span class="n">p_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">p_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">volume_element</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr</span><span class="p">)])</span> <span class="o">/</span> <span class="n">V_total</span>

    <span class="n">Bt2_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">Bt_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">volume_element</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr</span><span class="p">)])</span> <span class="o">/</span> <span class="n">V_total</span>
    <span class="n">Bp2_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">Bp_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">volume_element</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr</span><span class="p">)])</span> <span class="o">/</span> <span class="n">V_total</span>

    <span class="n">mu0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1e-7</span>

    <span class="c1"># Poloidal beta</span>
    <span class="n">beta_p</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu0</span> <span class="o">*</span> <span class="n">p_avg</span> <span class="o">/</span> <span class="n">Bp2_avg</span>

    <span class="c1"># Toroidal beta</span>
    <span class="n">beta_t</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu0</span> <span class="o">*</span> <span class="n">p_avg</span> <span class="o">/</span> <span class="n">Bt2_avg</span>

    <span class="c1"># For beta_N, need plasma current</span>
    <span class="c1"># I_p = ‚àÆ J¬∑dl ~ B_p * circumference / Œº‚ÇÄ</span>
    <span class="n">Bp_edge</span> <span class="o">=</span> <span class="n">Bp_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Ip</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">Bp_edge</span> <span class="o">/</span> <span class="n">mu0</span>

    <span class="c1"># Troyon normalized beta</span>
    <span class="n">Bt_axis</span> <span class="o">=</span> <span class="n">Bt_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">beta_N</span> <span class="o">=</span> <span class="n">beta_t</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="n">Ip</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">Bt_axis</span><span class="p">))</span>  <span class="c1"># percentage</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;beta_p&#39;</span><span class="p">:</span> <span class="n">beta_p</span><span class="p">,</span>
        <span class="s1">&#39;beta_t&#39;</span><span class="p">:</span> <span class="n">beta_t</span><span class="p">,</span>
        <span class="s1">&#39;beta_N&#39;</span><span class="p">:</span> <span class="n">beta_N</span><span class="p">,</span>
        <span class="s1">&#39;p_avg&#39;</span><span class="p">:</span> <span class="n">p_avg</span><span class="p">,</span>
        <span class="s1">&#39;Ip&#39;</span><span class="p">:</span> <span class="n">Ip</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="k">def</span><span class="w"> </span><span class="nf">example_beta_calculation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Example beta calculation for tokamak&quot;&quot;&quot;</span>

    <span class="c1"># ITER-like parameters</span>
    <span class="n">R0</span> <span class="o">=</span> <span class="mf">6.2</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span>

    <span class="c1"># Parabolic pressure profile</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="mf">5e5</span>  <span class="c1"># 500 kPa</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">p_profile</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1"># Magnetic field profiles</span>
    <span class="n">Bt0</span> <span class="o">=</span> <span class="mf">5.3</span>  <span class="c1"># On-axis toroidal field</span>
    <span class="n">Ip</span> <span class="o">=</span> <span class="mf">15e6</span>  <span class="c1"># Plasma current</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Bt_profile</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Bt0</span> <span class="o">*</span> <span class="n">R0</span> <span class="o">/</span> <span class="p">(</span><span class="n">R0</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span>  <span class="c1"># 1/R dependence</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Bp_profile</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="n">mu0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1e-7</span>
        <span class="c1"># From Ampere&#39;s law, current ~ r¬≤ profile</span>
        <span class="n">I_enclosed</span> <span class="o">=</span> <span class="n">Ip</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">mu0</span> <span class="o">*</span> <span class="n">I_enclosed</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="n">B_profiles</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Bt&#39;</span><span class="p">:</span> <span class="n">Bt_profile</span><span class="p">,</span>
        <span class="s1">&#39;Bp&#39;</span><span class="p">:</span> <span class="n">Bp_profile</span>
    <span class="p">}</span>

    <span class="c1"># Compute betas</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">compute_beta</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">p_profile</span><span class="p">,</span> <span class="n">B_profiles</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Beta Calculation ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Major radius R0 = </span><span class="si">{</span><span class="n">R0</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Minor radius a = </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Central pressure p0 = </span><span class="si">{</span><span class="n">p0</span><span class="o">/</span><span class="mf">1e3</span><span class="si">}</span><span class="s2"> kPa&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Toroidal field Bt0 = </span><span class="si">{</span><span class="n">Bt0</span><span class="si">}</span><span class="s2"> T&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plasma current Ip = </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;Ip&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MA&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Average pressure &lt;p&gt; = </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;p_avg&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e3</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> kPa&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Poloidal beta Œ≤_p = </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;beta_p&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Toroidal beta Œ≤_t = </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;beta_t&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> %&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normalized beta Œ≤_N = </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;beta_N&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Troyon limit check</span>
    <span class="n">beta_N_limit</span> <span class="o">=</span> <span class="mf">3.5</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Troyon limit Œ≤_N &lt; </span><span class="si">{</span><span class="n">beta_N_limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;beta_N&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">beta_N_limit</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;‚úì Within stability limit&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;‚úó Exceeds stability limit!&quot;</span><span class="p">)</span>

    <span class="c1"># Plot profiles</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p_profile</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>
    <span class="n">Bt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Bt_profile</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>
    <span class="n">Bp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Bp_profile</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Pressure</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pressure [kPa]&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pressure Profile&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Toroidal field</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">Bt</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;B_t [T]&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Toroidal Field&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Poloidal field</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">Bp</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;B_p [T]&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Poloidal Field&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Local beta</span>
    <span class="n">beta_local</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1e-7</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">Bt</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Bp</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">beta_local</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;m-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Œ≤ [%]&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Local Beta Profile&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/tmp/beta_profiles.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Profiles plot saved to /tmp/beta_profiles.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">example_beta_calculation</span><span class="p">()</span>
</code></pre></div>

<h2 id="summary">Summary<a class="header-link" href="#summary" title="Permanent link">&para;</a></h2>
<p>In this lesson, we have covered the fundamentals of MHD equilibria:</p>
<ol>
<li>
<p><strong>Force Balance</strong>: The fundamental equation $\nabla p = \mathbf{J}\times\mathbf{B}$ balances plasma pressure gradient against magnetic forces (pressure + tension).</p>
</li>
<li>
<p><strong>Consequences</strong>: Pressure and current lie on magnetic flux surfaces, enabling flux surface coordinates.</p>
</li>
<li>
<p><strong>1D Equilibria</strong>: Œ∏-pinch (pure axial field), Z-pinch (self-generated azimuthal field, Bennett relation), and screw pinch (combined fields with shear).</p>
</li>
<li>
<p><strong>Grad-Shafranov Equation</strong>: The elliptic PDE governing axisymmetric toroidal equilibria, requiring specification of two free functions $p(\psi)$ and $F(\psi)$.</p>
</li>
<li>
<p><strong>Safety Factor</strong>: The parameter $q$ measuring field line pitch, critical for stability analysis (Kruskal-Shafranov limit, rational surfaces).</p>
</li>
<li>
<p><strong>Flux Surfaces</strong>: Nested toroidal surfaces on which pressure is constant, with Shafranov shift due to toroidal effects.</p>
</li>
<li>
<p><strong>Plasma Beta</strong>: The ratio of plasma to magnetic pressure, with operational limits set by MHD stability (Troyon limit).</p>
</li>
<li>
<p><strong>Numerical Methods</strong>: Implementation of equilibrium solvers using finite differences and iterative techniques.</p>
</li>
</ol>
<p>These equilibrium concepts form the foundation for understanding plasma stability (next lessons), transport, and confinement in fusion devices.</p>
<h2 id="practice-problems">Practice Problems<a class="header-link" href="#practice-problems" title="Permanent link">&para;</a></h2>
<h3 id="problem-1-force-balance-in-a-cylindrical-plasma">Problem 1: Force Balance in a Cylindrical Plasma<a class="header-link" href="#problem-1-force-balance-in-a-cylindrical-plasma" title="Permanent link">&para;</a></h3>
<p>A cylindrical plasma column has the following profiles:
- Pressure: $p(r) = p_0(1 - r^2/a^2)$ for $r < a$, $p=0$ for $r \geq a$
- Axial field: $B_z = B_0 = \text{const}$
- Azimuthal field: $B_Œ∏(r)$ to be determined</p>
<p><strong>(a)</strong> Using the radial force balance equation, derive $B_Œ∏(r)$.</p>
<p><strong>(b)</strong> Compute the total plasma current $I_p$.</p>
<p><strong>(c)</strong> Calculate the safety factor $q(r)$ assuming major radius $R_0 = 5a$.</p>
<p><strong>(d)</strong> What is $q$ on the magnetic axis ($r=0$)?</p>
<p><strong>Hint</strong>: Use $\nabla p = \mathbf{J}\times\mathbf{B}$ in cylindrical coordinates.</p>
<h3 id="problem-2-bennett-relation-for-z-pinch">Problem 2: Bennett Relation for Z-Pinch<a class="header-link" href="#problem-2-bennett-relation-for-z-pinch" title="Permanent link">&para;</a></h3>
<p>A Z-pinch has uniform density $n = 10^{20}$ m$^{-3}$, temperature $T = 10$ keV, length $L = 1$ m, and radius $a = 1$ cm.</p>
<p><strong>(a)</strong> Calculate the total number of particles $N = n \pi a^2 L$.</p>
<p><strong>(b)</strong> Using the Bennett relation $I^2 = (8\pi/\mu_0)NkT$, compute the required current $I_p$.</p>
<p><strong>(c)</strong> Estimate the magnetic field at the surface $B_Œ∏(a) = \mu_0 I_p/(2\pi a)$.</p>
<p><strong>(d)</strong> Compute the magnetic pressure $B_Œ∏^2/(2\mu_0)$ and compare with plasma pressure $p = nkT$.</p>
<p><strong>(e)</strong> Discuss the stability implications of this configuration.</p>
<h3 id="problem-3-grad-shafranov-with-constant-pressure">Problem 3: Grad-Shafranov with Constant Pressure<a class="header-link" href="#problem-3-grad-shafranov-with-constant-pressure" title="Permanent link">&para;</a></h3>
<p>Consider the Grad-Shafranov equation with:
- $p(\psi) = p_0 = \text{const}$
- $F(\psi) = F_0 = \text{const}$</p>
<p><strong>(a)</strong> Show that the equation reduces to:
$$
\Delta^*\psi = -\mu_0 p_0 R^2
$$</p>
<p><strong>(b)</strong> For a large-aspect-ratio circular tokamak ($R \approx R_0$), approximate this as:
$$
\frac{1}{r}\frac{d}{dr}\left(r\frac{d\psi}{dr}\right) + \frac{d^2\psi}{dz^2} \approx -\mu_0 p_0 R_0^2
$$</p>
<p><strong>(c)</strong> Propose a separable solution $\psi(r,z) = R_r(r)Z_z(z)$ and derive ODEs for $R_r$ and $Z_z$.</p>
<p><strong>(d)</strong> Solve for circular flux surfaces $\psi \propto r^2 + \kappa^2 z^2$ and determine $\kappa$ (elongation).</p>
<h3 id="problem-4-safety-factor-and-current-profile">Problem 4: Safety Factor and Current Profile<a class="header-link" href="#problem-4-safety-factor-and-current-profile" title="Permanent link">&para;</a></h3>
<p>A tokamak has major radius $R_0 = 3$ m, minor radius $a = 1$ m, and toroidal field $B_t = 5$ T (approximately constant). The current density profile is:</p>
<p>$$
J_z(r) = J_0\left(1 - \frac{r^2}{a^2}\right)
$$</p>
<p><strong>(a)</strong> Compute the enclosed current $I(r) = \int_0^r J_z(r') 2\pi r' dr'$.</p>
<p><strong>(b)</strong> Using Amp√®re's law, find $B_Œ∏(r) = \mu_0 I(r)/(2\pi r)$.</p>
<p><strong>(c)</strong> Calculate the safety factor profile $q(r) = rB_t/(R_0 B_Œ∏(r))$.</p>
<p><strong>(d)</strong> Determine $q(0)$ (on-axis) and $q(a)$ (at edge).</p>
<p><strong>(e)</strong> Find the radius $r_s$ where $q(r_s) = 2$ (the $m=2$ rational surface).</p>
<p><strong>(f)</strong> Plot $q(r)$ and identify stability-relevant features.</p>
<h3 id="problem-5-beta-limits">Problem 5: Beta Limits<a class="header-link" href="#problem-5-beta-limits" title="Permanent link">&para;</a></h3>
<p>An experimental tokamak operates with:
- Minor radius $a = 0.5$ m
- Toroidal field $B_t = 3$ T
- Plasma current $I_p = 1$ MA
- Central pressure $p_0 = 10^5$ Pa
- Pressure profile $p(r) = p_0(1 - r^2/a^2)^2$</p>
<p><strong>(a)</strong> Compute the volume-averaged pressure $\langle p\rangle$.</p>
<p><strong>(b)</strong> Calculate the toroidal beta $\beta_t = 2\mu_0\langle p\rangle/B_t^2$.</p>
<p><strong>(c)</strong> Compute the normalized beta $\beta_N = \beta_t(\%)/(I_p[MA]/(a[m]B_t[T]))$.</p>
<p><strong>(d)</strong> Compare $\beta_N$ with the Troyon limit $\beta_N < 3.5$.</p>
<p><strong>(e)</strong> If the experiment wants to double the pressure, what adjustments to $I_p$ or $B_t$ would maintain stability?</p>
<p><strong>Hint</strong>: For volume average in a cylinder: $\langle p\rangle = \frac{\int_0^a p(r) 2\pi r dr}{\pi a^2}$.</p>
<hr />
<p><strong>Previous</strong>: <a href="./00_Overview.md">Overview</a> | <strong>Next</strong>: <a href="./02_Linear_Stability.md">Linear Stability</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/MHD/00_Overview.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Magnetohydrodynamics (MHD)</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/MHD/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/MHD/02_Linear_Stability.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">2. Linear Stability Theory</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">‚Üë</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}