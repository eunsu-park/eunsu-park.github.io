{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3. Pressure-Driven Instabilities - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">üíª</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        ÌïúÍµ≠Ïñ¥
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">‚òÄÔ∏è</span>
                    <span class="theme-icon dark">üåô</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/MHD/">MHD</a>
    <span class="separator">/</span>
    <span class="current">3. Pressure-Driven Instabilities</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>3. Pressure-Driven Instabilities</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/MHD/02_Linear_Stability.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">2. Linear Stability Theory</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/MHD/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/MHD/04_Current_Driven_Instabilities.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">4. Current-Driven Instabilities</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#1-introduction-to-pressure-driven-instabilities">1. Introduction to Pressure-Driven Instabilities</a></li>
<li><a href="#2-interchange-instability">2. Interchange Instability</a><ul>
<li><a href="#21-physical-picture">2.1 Physical Picture</a></li>
<li><a href="#22-curvature-and-pressure-gradient">2.2 Curvature and Pressure Gradient</a></li>
<li><a href="#23-interchange-condition">2.3 Interchange Condition</a></li>
<li><a href="#24-good-vs-bad-curvature-in-tokamaks">2.4 Good vs Bad Curvature in Tokamaks</a></li>
<li><a href="#25-average-curvature-and-stability">2.5 Average Curvature and Stability</a></li>
</ul>
</li>
<li><a href="#3-rayleigh-taylor-instability-in-mhd">3. Rayleigh-Taylor Instability in MHD</a><ul>
<li><a href="#31-hydrodynamic-rayleigh-taylor">3.1 Hydrodynamic Rayleigh-Taylor</a></li>
<li><a href="#32-mhd-rayleigh-taylor-with-transverse-field">3.2 MHD Rayleigh-Taylor with Transverse Field</a></li>
<li><a href="#33-growth-rate">3.3 Growth Rate</a></li>
<li><a href="#34-analogy-to-magnetic-curvature">3.4 Analogy to Magnetic Curvature</a></li>
</ul>
</li>
<li><a href="#4-parker-instability">4. Parker Instability</a><ul>
<li><a href="#41-magnetic-buoyancy">4.1 Magnetic Buoyancy</a></li>
<li><a href="#42-physical-mechanism">4.2 Physical Mechanism</a></li>
<li><a href="#43-dispersion-relation">4.3 Dispersion Relation</a></li>
<li><a href="#44-applications">4.4 Applications</a></li>
</ul>
</li>
<li><a href="#5-ballooning-modes">5. Ballooning Modes</a><ul>
<li><a href="#51-high-n-instabilities-in-toroidal-geometry">5.1 High-n Instabilities in Toroidal Geometry</a></li>
<li><a href="#52-physical-picture">5.2 Physical Picture</a></li>
<li><a href="#53-field-aligned-coordinates">5.3 Field-Aligned Coordinates</a></li>
<li><a href="#54-ballooning-equation">5.4 Ballooning Equation</a></li>
<li><a href="#55-s-diagram">5.5 s-Œ± Diagram</a></li>
<li><a href="#56-connection-to-elms">5.6 Connection to ELMs</a></li>
</ul>
</li>
<li><a href="#6-mercier-criterion">6. Mercier Criterion</a><ul>
<li><a href="#61-local-interchange-stability">6.1 Local Interchange Stability</a></li>
<li><a href="#62-explicit-form">6.2 Explicit Form</a></li>
<li><a href="#63-physical-interpretation">6.3 Physical Interpretation</a></li>
<li><a href="#64-relation-to-suydam-criterion">6.4 Relation to Suydam Criterion</a></li>
<li><a href="#65-limitation">6.5 Limitation</a></li>
</ul>
</li>
<li><a href="#7-numerical-simulations">7. Numerical Simulations</a><ul>
<li><a href="#71-rayleigh-taylor-simulation">7.1 Rayleigh-Taylor Simulation</a></li>
<li><a href="#72-ballooning-stability-analysis">7.2 Ballooning Stability Analysis</a></li>
<li><a href="#73-mercier-criterion-evaluation">7.3 Mercier Criterion Evaluation</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
<li><a href="#practice-problems">Practice Problems</a><ul>
<li><a href="#problem-1-interchange-stability-in-a-mirror">Problem 1: Interchange Stability in a Mirror</a></li>
<li><a href="#problem-2-rt-critical-wavelength">Problem 2: RT Critical Wavelength</a></li>
<li><a href="#problem-3-ballooning-stability-boundary">Problem 3: Ballooning Stability Boundary</a></li>
<li><a href="#problem-4-parker-instability-in-galactic-disk">Problem 4: Parker Instability in Galactic Disk</a></li>
<li><a href="#problem-5-mercier-criterion-components">Problem 5: Mercier Criterion Components</a></li>
</ul>
</li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="3-pressure-driven-instabilities">3. Pressure-Driven Instabilities<a class="header-link" href="#3-pressure-driven-instabilities" title="Permanent link">&para;</a></h1>
<h2 id="learning-objectives">Learning Objectives<a class="header-link" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<ul>
<li>Understand the physical mechanism of interchange instabilities driven by unfavorable curvature</li>
<li>Analyze the Rayleigh-Taylor instability in magnetized plasmas</li>
<li>Study the Parker instability in stratified atmospheres</li>
<li>Derive and apply ballooning mode theory for high-n modes in toroidal geometry</li>
<li>Use the Mercier criterion for local interchange stability</li>
<li>Implement numerical simulations of pressure-driven instabilities</li>
<li>Understand the connection to experimental observations (ELMs in tokamaks)</li>
</ul>
<h2 id="1-introduction-to-pressure-driven-instabilities">1. Introduction to Pressure-Driven Instabilities<a class="header-link" href="#1-introduction-to-pressure-driven-instabilities" title="Permanent link">&para;</a></h2>
<p>Pressure-driven instabilities arise when the <strong>pressure gradient</strong> provides free energy that can drive fluid motion against magnetic field line bending. These instabilities are particularly important in:</p>
<ul>
<li><strong>Fusion plasmas</strong>: Limiting achievable pressure (beta limit)</li>
<li><strong>Astrophysical plasmas</strong>: Solar prominences, coronal mass ejections</li>
<li><strong>Planetary magnetospheres</strong>: Magnetic field configuration in magnetotail</li>
</ul>
<p>The fundamental physics is the competition between:
- <strong>Destabilizing</strong>: Pressure gradient in unfavorable curvature
- <strong>Stabilizing</strong>: Magnetic field line bending (tension)</p>
<div class="highlight"><pre><span></span><code>Pressure-Driven Instability Mechanism:
=====================================

Favorable curvature           Unfavorable curvature
(magnetic well):              (magnetic hill):

    ‚àáp                            ‚àáp
     ‚Üì                             ‚Üë
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  B                   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  B
 (       )                      ‚Äæ‚Äæ‚Äæ‚Äæ‚Äæ‚Äæ‚Äæ
  ‚Äæ‚Äæ‚Äæ‚Äæ‚Äæ‚Äæ‚Äæ                      (       )

Pressure pushes              Pressure pushes
against field bending        in same direction
‚Üí STABLE                     as curvature
                             ‚Üí UNSTABLE
</code></pre></div>

<h2 id="2-interchange-instability">2. Interchange Instability<a class="header-link" href="#2-interchange-instability" title="Permanent link">&para;</a></h2>
<h3 id="21-physical-picture">2.1 Physical Picture<a class="header-link" href="#21-physical-picture" title="Permanent link">&para;</a></h3>
<p>The <strong>interchange instability</strong> occurs when adjacent flux tubes exchange positions. This is analogous to the Rayleigh-Taylor instability in hydrodynamics but with magnetic field replacing gravity.</p>
<p><strong>Energy consideration</strong>:</p>
<p>Consider two flux tubes at different radii with:
- Tube 1 at $r_1$: pressure $p_1$, magnetic field $B_1$
- Tube 2 at $r_2 > r_1$: pressure $p_2 < p_1$, magnetic field $B_2$</p>
<p>If we interchange them, the change in potential energy is:</p>
<p>$$
\delta W \propto (p_1 - p_2)(B_2^2 - B_1^2)
$$</p>
<p><strong>Instability condition</strong>: If $B$ decreases outward faster than $p$, then $\delta W < 0$ ‚Üí unstable.</p>
<h3 id="22-curvature-and-pressure-gradient">2.2 Curvature and Pressure Gradient<a class="header-link" href="#22-curvature-and-pressure-gradient" title="Permanent link">&para;</a></h3>
<p>The stability depends on the sign of:</p>
<p>$$
\kappa \cdot \nabla p
$$</p>
<p>where $\boldsymbol{\kappa} = \mathbf{b}\cdot\nabla\mathbf{b}$ is the field line curvature, and $\mathbf{b} = \mathbf{B}/B$.</p>
<p><strong>Favorable curvature</strong> ($\boldsymbol{\kappa} \cdot \nabla p < 0$):
- Curvature points away from high pressure
- Like a heavy fluid above a light fluid in gravity (stable)</p>
<p><strong>Unfavorable curvature</strong> ($\boldsymbol{\kappa} \cdot \nabla p > 0$):
- Curvature points toward high pressure
- Like a light fluid below a heavy fluid in gravity (unstable)</p>
<h3 id="23-interchange-condition">2.3 Interchange Condition<a class="header-link" href="#23-interchange-condition" title="Permanent link">&para;</a></h3>
<p>From the energy principle, the interchange instability requires:</p>
<p>$$
\int \left[\frac{|\mathbf{B}_1|^2}{\mu_0} - 2(\boldsymbol{\xi}\cdot\boldsymbol{\kappa})(\boldsymbol{\xi}\cdot\nabla p)\right]dV < 0
$$</p>
<p>For incompressible perturbations perpendicular to $\mathbf{B}$:</p>
<p>$$
\delta W \approx -\int (\boldsymbol{\xi}_\perp\cdot\boldsymbol{\kappa})(\boldsymbol{\xi}_\perp\cdot\nabla p)\, dV
$$</p>
<p>If $\boldsymbol{\kappa}\cdot\nabla p > 0$, we can choose $\boldsymbol{\xi}_\perp$ parallel to both $\boldsymbol{\kappa}$ and $\nabla p$ to make $\delta W < 0$.</p>
<h3 id="24-good-vs-bad-curvature-in-tokamaks">2.4 Good vs Bad Curvature in Tokamaks<a class="header-link" href="#24-good-vs-bad-curvature-in-tokamaks" title="Permanent link">&para;</a></h3>
<p>In a tokamak, the magnetic field has toroidal and poloidal components. Going around poloidally:</p>
<p><strong>Outboard side</strong> (low-field side, large $R$):
- Field lines curve inward (toward plasma)
- $\boldsymbol{\kappa}$ points inward
- $\nabla p$ points outward
- $\boldsymbol{\kappa}\cdot\nabla p < 0$ ‚Üí <strong>favorable</strong> ("good curvature")</p>
<p><strong>Inboard side</strong> (high-field side, small $R$):
- Field lines curve outward (away from plasma)
- $\boldsymbol{\kappa}$ points outward
- $\nabla p$ points outward
- $\boldsymbol{\kappa}\cdot\nabla p > 0$ ‚Üí <strong>unfavorable</strong> ("bad curvature")</p>
<div class="highlight"><pre><span></span><code>Tokamak Cross-Section:
=====================

        Bad curvature
             ‚Üì
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ‚ïë           ‚ïë
       ‚ïë  Plasma   ‚ïë  ‚Üê Good curvature
       ‚ïë           ‚ïë
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Instabilities tend to localize
on bad curvature (inboard) side
</code></pre></div>

<h3 id="25-average-curvature-and-stability">2.5 Average Curvature and Stability<a class="header-link" href="#25-average-curvature-and-stability" title="Permanent link">&para;</a></h3>
<p>For a closed field line, the <strong>average curvature</strong> determines stability:</p>
<p>$$
\bar{\kappa} = \frac{1}{L}\oint \boldsymbol{\kappa}\cdot d\mathbf{l}
$$</p>
<p>If $\bar{\kappa}\cdot\nabla p > 0$: potentially unstable (requires detailed calculation).</p>
<p><strong>Magnetic well</strong>: Configuration where $\bar{\kappa}\cdot\nabla p < 0$ everywhere ‚Üí stable.</p>
<h2 id="3-rayleigh-taylor-instability-in-mhd">3. Rayleigh-Taylor Instability in MHD<a class="header-link" href="#3-rayleigh-taylor-instability-in-mhd" title="Permanent link">&para;</a></h2>
<h3 id="31-hydrodynamic-rayleigh-taylor">3.1 Hydrodynamic Rayleigh-Taylor<a class="header-link" href="#31-hydrodynamic-rayleigh-taylor" title="Permanent link">&para;</a></h3>
<p>In hydrodynamics, a heavy fluid on top of a light fluid in a gravitational field is unstable.</p>
<p><strong>Dispersion relation</strong> (no magnetic field):</p>
<p>$$
\omega^2 = -gk\frac{\rho_2 - \rho_1}{\rho_2 + \rho_1}
$$</p>
<p>If $\rho_2 > \rho_1$ (heavy on top): $\omega^2 < 0$ ‚Üí unstable.</p>
<p>Growth rate: $\gamma = \sqrt{gk}$ (independent of viscosity).</p>
<h3 id="32-mhd-rayleigh-taylor-with-transverse-field">3.2 MHD Rayleigh-Taylor with Transverse Field<a class="header-link" href="#32-mhd-rayleigh-taylor-with-transverse-field" title="Permanent link">&para;</a></h3>
<p>Add a horizontal magnetic field $\mathbf{B}_0 = B_0\hat{\mathbf{x}}$ perpendicular to gravity $\mathbf{g} = -g\hat{\mathbf{z}}$.</p>
<p><strong>Modified dispersion relation</strong>:</p>
<p>$$
\omega^2 = -gk\frac{\rho_2 - \rho_1}{\rho_2 + \rho_1} + \frac{B_0^2}{\mu_0(\rho_1 + \rho_2)}k_x^2
$$</p>
<p>where $k_x$ is the wavenumber along the field.</p>
<p><strong>Stability analysis</strong>:</p>
<ul>
<li>
<p>Perturbations with $\mathbf{k} \parallel \mathbf{B}$ ($k_x = k$): stabilized if
  $$
  \frac{B_0^2}{\mu_0} > g(\rho_2 - \rho_1)/k
  $$</p>
</li>
<li>
<p>Perturbations with $\mathbf{k} \perp \mathbf{B}$ ($k_x = 0$): <strong>always unstable</strong> (same as hydro).</p>
</li>
</ul>
<p><strong>Critical wavenumber</strong> for stabilization:</p>
<p>$$
k_c = \frac{g(\rho_2 - \rho_1)\mu_0}{B_0^2}
$$</p>
<p>Short wavelengths ($k > k_c$) are stable; long wavelengths are unstable.</p>
<h3 id="33-growth-rate">3.3 Growth Rate<a class="header-link" href="#33-growth-rate" title="Permanent link">&para;</a></h3>
<p>For unstable modes ($k < k_c$):</p>
<p>$$
\gamma = \sqrt{gk\frac{\rho_2-\rho_1}{\rho_2+\rho_1} - \frac{B_0^2}{\mu_0(\rho_1+\rho_2)}k_x^2}
$$</p>
<p>Maximum growth rate (at $k_x = 0$):</p>
<p>$$
\gamma_{max} = \sqrt{gk\frac{\rho_2-\rho_1}{\rho_2+\rho_1}}
$$</p>
<h3 id="34-analogy-to-magnetic-curvature">3.4 Analogy to Magnetic Curvature<a class="header-link" href="#34-analogy-to-magnetic-curvature" title="Permanent link">&para;</a></h3>
<p>The gravitational acceleration $\mathbf{g}$ can be replaced by effective gravity from magnetic curvature:</p>
<p>$$
\mathbf{g}_{eff} = \frac{B^2}{\mu_0\rho}\boldsymbol{\kappa}
$$</p>
<p>This connects RT instability to interchange instability.</p>
<h2 id="4-parker-instability">4. Parker Instability<a class="header-link" href="#4-parker-instability" title="Permanent link">&para;</a></h2>
<h3 id="41-magnetic-buoyancy">4.1 Magnetic Buoyancy<a class="header-link" href="#41-magnetic-buoyancy" title="Permanent link">&para;</a></h3>
<p>The <strong>Parker instability</strong> (Parker, 1966) occurs in a stratified atmosphere with a horizontal magnetic field. It is driven by <strong>magnetic buoyancy</strong>: the weight of plasma slides along bent field lines.</p>
<p><strong>Configuration</strong>:
- Stratified atmosphere: $\rho(z)$, $p(z)$
- Horizontal field: $\mathbf{B}_0 = B_0(z)\hat{\mathbf{x}}$
- Gravity: $\mathbf{g} = -g\hat{\mathbf{z}}$</p>
<h3 id="42-physical-mechanism">4.2 Physical Mechanism<a class="header-link" href="#42-physical-mechanism" title="Permanent link">&para;</a></h3>
<p>When a field line is bent upward:
1. Plasma slides down along the field line (due to gravity component along $\mathbf{B}$)
2. Density at the apex decreases
3. Magnetic pressure pushes the apex further up
4. <strong>Runaway instability</strong></p>
<div class="highlight"><pre><span></span><code>Parker Instability:
==================

Initial:     Perturbed:
B ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   B ‚ï±‚Äæ‚Äæ‚Äæ‚Äæ‚ï≤
             Plasma slides
   œÅgh         ‚ï≤    ‚ï±
                ‚ï≤  ‚ï±
                 ‚ñº‚ñº
             Less mass at apex
             ‚Üí magnetic buoyancy
             ‚Üí further uplift
</code></pre></div>

<h3 id="43-dispersion-relation">4.3 Dispersion Relation<a class="header-link" href="#43-dispersion-relation" title="Permanent link">&para;</a></h3>
<p>For isothermal atmosphere with scale height $H = kT/(mg)$:</p>
<p>$$
\omega^2 = -\frac{g}{H}\left(1 - \frac{B_0^2}{B_0^2 + \mu_0\rho_0 c_s^2}\right)
$$</p>
<p>where $c_s = \sqrt{\gamma p/\rho}$ is the sound speed.</p>
<p><strong>Instability condition</strong>:</p>
<p>$$
\beta = \frac{2\mu_0 p}{B^2} > \frac{2}{\gamma} \approx 1.2 \quad (\text{for } \gamma=5/3)
$$</p>
<p>If plasma beta is too high, magnetic field cannot support the plasma ‚Üí Parker unstable.</p>
<h3 id="44-applications">4.4 Applications<a class="header-link" href="#44-applications" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Interstellar medium</strong>: Formation of molecular clouds</li>
<li><strong>Solar atmosphere</strong>: Prominence eruptions</li>
<li><strong>Galactic dynamics</strong>: Vertical structure of disk galaxies</li>
</ul>
<h2 id="5-ballooning-modes">5. Ballooning Modes<a class="header-link" href="#5-ballooning-modes" title="Permanent link">&para;</a></h2>
<h3 id="51-high-n-instabilities-in-toroidal-geometry">5.1 High-n Instabilities in Toroidal Geometry<a class="header-link" href="#51-high-n-instabilities-in-toroidal-geometry" title="Permanent link">&para;</a></h3>
<p><strong>Ballooning modes</strong> are high-$n$ (large toroidal mode number) pressure-driven instabilities that localize on the bad curvature side of a torus.</p>
<p><strong>Characteristics</strong>:
- Large $n$ ‚Üí short perpendicular wavelength
- Localized on outboard side (unfavorable curvature)
- Driven by pressure gradient
- Stabilized by magnetic shear and favorable average curvature</p>
<h3 id="52-physical-picture">5.2 Physical Picture<a class="header-link" href="#52-physical-picture" title="Permanent link">&para;</a></h3>
<p>The mode "balloons out" on the bad curvature side, like a balloon expanding where the field is weakest.</p>
<div class="highlight"><pre><span></span><code><span class="gh">Ballooning Mode in Tokamak:</span>
<span class="gh">===========================</span>

   Top view:

        n=10 perturbation
         ‚ïë ‚ïë ‚ïë ‚ïë ‚ïë
    ‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ï¨‚ïê‚ï¨‚ïê‚ï¨‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê  Outboard (bad curvature)
         ‚ïë ‚ïë ‚ïë ‚ïë ‚ïë

         (localized)

    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  Inboard (good curvature)
         (weak)
</code></pre></div>

<h3 id="53-field-aligned-coordinates">5.3 Field-Aligned Coordinates<a class="header-link" href="#53-field-aligned-coordinates" title="Permanent link">&para;</a></h3>
<p>To analyze ballooning modes, use <strong>field-aligned coordinates</strong> $(\psi, \theta, \phi)$ where:
- $\psi$: flux surface label
- $\theta$: poloidal angle (along field)
- $\phi$: toroidal angle</p>
<p>Magnetic field: $\mathbf{B} = \nabla\phi\times\nabla\psi + q(\psi)\nabla\psi\times\nabla\theta$.</p>
<h3 id="54-ballooning-equation">5.4 Ballooning Equation<a class="header-link" href="#54-ballooning-equation" title="Permanent link">&para;</a></h3>
<p>The ballooning mode eigenvalue equation in the limit $n \to \infty$:</p>
<p>$$
\frac{d}{d\theta}\left[g(\theta)\frac{d\hat{\Phi}}{d\theta}\right] + h(\theta)\hat{\Phi} = \lambda\hat{\Phi}
$$</p>
<p>where:
- $g(\theta) = |\nabla\psi|^2/B^2$: metric coefficient
- $h(\theta)$: includes pressure gradient and curvature
- $\lambda$: eigenvalue (related to growth rate)
- $\hat{\Phi}$: ballooning amplitude</p>
<p><strong>Boundary conditions</strong>: $\hat{\Phi}(\theta \pm \infty) = 0$ (localization).</p>
<h3 id="55-s-diagram">5.5 s-Œ± Diagram<a class="header-link" href="#55-s-diagram" title="Permanent link">&para;</a></h3>
<p>Stability is often represented in the <strong>s-Œ± diagram</strong>:</p>
<ul>
<li><strong>Magnetic shear</strong>: $s = (r/q)(dq/dr)$</li>
<li><strong>Pressure gradient</strong>: $\alpha = -(2\mu_0 R_0^2 q^2/B_0^2)(dp/dr)$</li>
</ul>
<div class="highlight"><pre><span></span><code>s-Œ± Stability Diagram:
=====================

Œ± |       UNSTABLE
  |      /
  |     /
  |    /
  |   /  ‚Üê Stability boundary
  |  /
  | /____STABLE____
  |_________________ s
  0

High shear (large s): stabilizing
High pressure gradient (large Œ±): destabilizing
</code></pre></div>

<p><strong>Approximate stability boundary</strong>:</p>
<p>$$
\alpha_c \approx 0.6s
$$</p>
<h3 id="56-connection-to-elms">5.6 Connection to ELMs<a class="header-link" href="#56-connection-to-elms" title="Permanent link">&para;</a></h3>
<p>In tokamaks, ballooning modes are believed to trigger <strong>Edge Localized Modes (ELMs)</strong>:</p>
<ul>
<li>High edge pressure gradient in H-mode</li>
<li>Exceeds ballooning stability boundary</li>
<li>Periodic eruptions (ELMs) relax pressure gradient</li>
<li>Concern for ITER: large ELMs can damage first wall</li>
</ul>
<p><strong>ELM mitigation strategies</strong>:
- Resonant magnetic perturbations (RMPs)
- Pellet injection
- Vertical kicks</p>
<h2 id="6-mercier-criterion">6. Mercier Criterion<a class="header-link" href="#6-mercier-criterion" title="Permanent link">&para;</a></h2>
<h3 id="61-local-interchange-stability">6.1 Local Interchange Stability<a class="header-link" href="#61-local-interchange-stability" title="Permanent link">&para;</a></h3>
<p>The <strong>Mercier criterion</strong> (Mercier, 1960) provides a <strong>necessary condition</strong> for local interchange stability in toroidal geometry.</p>
<p><strong>Criterion</strong>:</p>
<p>$$
D_I = D_S + D_W + D_G > \frac{1}{4}
$$</p>
<p>where:
- $D_S$: magnetic shear contribution
- $D_W$: magnetic well contribution
- $D_G$: geodesic curvature contribution</p>
<h3 id="62-explicit-form">6.2 Explicit Form<a class="header-link" href="#62-explicit-form" title="Permanent link">&para;</a></h3>
<p>For large-aspect-ratio tokamak:</p>
<p>$$
D_S = \frac{1}{4}\left(\frac{r}{q}\frac{dq}{dr}\right)^2
$$</p>
<p>$$
D_W = \frac{\mu_0 r}{B_p^2}\frac{dp}{dr}\left(1 + 2q^2\right)
$$</p>
<p>$$
D_G \approx \frac{r^2}{R_0 q^2}
$$</p>
<p><strong>Stability</strong>: $D_I > 1/4$.</p>
<h3 id="63-physical-interpretation">6.3 Physical Interpretation<a class="header-link" href="#63-physical-interpretation" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>$D_S$</strong>: Shear stabilizes by decoupling flux surfaces</li>
<li><strong>$D_W$</strong>: Negative if pressure gradient is stabilizing (magnetic well)</li>
<li><strong>$D_G$</strong>: Geodesic curvature effect (generally stabilizing)</li>
</ul>
<h3 id="64-relation-to-suydam-criterion">6.4 Relation to Suydam Criterion<a class="header-link" href="#64-relation-to-suydam-criterion" title="Permanent link">&para;</a></h3>
<p>In cylindrical geometry, Mercier criterion reduces to <strong>Suydam criterion</strong> (Lesson 2):</p>
<p>$$
\frac{r}{4}\left(\frac{q'}{q}\right)^2 + \frac{2\mu_0 p'}{B_z^2} > 0
$$</p>
<h3 id="65-limitation">6.5 Limitation<a class="header-link" href="#65-limitation" title="Permanent link">&para;</a></h3>
<p>Like Suydam, Mercier criterion is <strong>necessary</strong> but not <strong>sufficient</strong>. It only checks local interchange; global modes require full stability analysis.</p>
<h2 id="7-numerical-simulations">7. Numerical Simulations<a class="header-link" href="#7-numerical-simulations" title="Permanent link">&para;</a></h2>
<h3 id="71-rayleigh-taylor-simulation">7.1 Rayleigh-Taylor Simulation<a class="header-link" href="#71-rayleigh-taylor-simulation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rayleigh_taylor_growth_rate</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rho1</span><span class="p">,</span> <span class="n">rho2</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">kx_frac</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute growth rate for MHD Rayleigh-Taylor instability</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    k: total wavenumber [1/m]</span>
<span class="sd">    g: gravitational acceleration [m/s^2]</span>
<span class="sd">    rho1: lower fluid density [kg/m^3]</span>
<span class="sd">    rho2: upper fluid density [kg/m^3]</span>
<span class="sd">    B0: horizontal magnetic field [T]</span>
<span class="sd">    kx_frac: fraction of k along B direction (0 to 1)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    gamma: growth rate [1/s] (or 0 if stable)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mu0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1e-7</span>

    <span class="c1"># Wavenumber along field</span>
    <span class="n">kx</span> <span class="o">=</span> <span class="n">kx_frac</span> <span class="o">*</span> <span class="n">k</span>

    <span class="c1"># Atwood number</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">rho2</span> <span class="o">-</span> <span class="n">rho1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rho2</span> <span class="o">+</span> <span class="n">rho1</span><span class="p">)</span>

    <span class="c1"># Alfv√©n speed squared</span>
    <span class="n">vA2</span> <span class="o">=</span> <span class="n">B0</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">mu0</span> <span class="o">*</span> <span class="p">(</span><span class="n">rho1</span> <span class="o">+</span> <span class="n">rho2</span><span class="p">))</span>

    <span class="c1"># Dispersion relation: œâ¬≤ = -gkA + vA¬≤kx¬≤</span>
    <span class="n">omega_sq</span> <span class="o">=</span> <span class="o">-</span><span class="n">g</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">A</span> <span class="o">+</span> <span class="n">vA2</span> <span class="o">*</span> <span class="n">kx</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">if</span> <span class="n">omega_sq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">omega_sq</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Stable (oscillatory)</span>

    <span class="k">return</span> <span class="n">gamma</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_rt_growth_rate</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot RT growth rate vs wavenumber and field strength&quot;&quot;&quot;</span>

    <span class="c1"># Physical parameters</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># m/s^2</span>
    <span class="n">rho1</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># kg/m^3 (light fluid)</span>
    <span class="n">rho2</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># kg/m^3 (heavy fluid)</span>

    <span class="c1"># Wavenumber range</span>
    <span class="n">k_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># [1/m]</span>

    <span class="c1"># Magnetic field strengths</span>
    <span class="n">B_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>  <span class="c1"># [T]</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="c1"># Panel 1: Growth rate vs k for different B (k perpendicular to B)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">B0</span> <span class="ow">in</span> <span class="n">B_vals</span><span class="p">:</span>
        <span class="n">gamma_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">rayleigh_taylor_growth_rate</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rho1</span><span class="p">,</span> <span class="n">rho2</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">kx_frac</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_vals</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">k_vals</span><span class="p">,</span> <span class="n">gamma_vals</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;B = </span><span class="si">{</span><span class="n">B0</span><span class="si">}</span><span class="s1"> T&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavenumber k [1/m]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Growth rate Œ≥ [1/s]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RT Growth Rate vs Wavenumber (k ‚ä• B)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># Panel 2: Growth rate vs angle between k and B</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">k_fixed</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Fixed wavenumber</span>
    <span class="n">kx_frac_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">B0</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]:</span>
        <span class="n">gamma_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">rayleigh_taylor_growth_rate</span><span class="p">(</span><span class="n">k_fixed</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rho1</span><span class="p">,</span> <span class="n">rho2</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">kx_frac</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">kx_frac</span> <span class="ow">in</span> <span class="n">kx_frac_vals</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kx_frac_vals</span><span class="p">,</span> <span class="n">gamma_vals</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;B = </span><span class="si">{</span><span class="n">B0</span><span class="si">}</span><span class="s1"> T&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;k_x / k (alignment with B)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Growth rate Œ≥ [1/s]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;RT Growth Rate vs Field Alignment (k = </span><span class="si">{</span><span class="n">k_fixed</span><span class="si">}</span><span class="s1"> m‚Åª¬π)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="k">def</span><span class="w"> </span><span class="nf">example_rt_instability</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Example: Rayleigh-Taylor instability analysis&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== MHD Rayleigh-Taylor Instability ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Parameters</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mf">10.0</span>
    <span class="n">rho1</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">rho2</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Heavy fluid on top: œÅ‚ÇÇ = </span><span class="si">{</span><span class="n">rho2</span><span class="si">}</span><span class="s2"> kg/m¬≥&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Light fluid below:  œÅ‚ÇÅ = </span><span class="si">{</span><span class="n">rho1</span><span class="si">}</span><span class="s2"> kg/m¬≥&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gravity: g = </span><span class="si">{</span><span class="n">g</span><span class="si">}</span><span class="s2"> m/s¬≤&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wavenumber: k = </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> m‚Åª¬π&quot;</span><span class="p">)</span>

    <span class="c1"># No magnetic field</span>
    <span class="n">gamma_0</span> <span class="o">=</span> <span class="n">rayleigh_taylor_growth_rate</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rho1</span><span class="p">,</span> <span class="n">rho2</span><span class="p">,</span> <span class="n">B0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">kx_frac</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- No magnetic field ---&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Growth rate: Œ≥ = </span><span class="si">{</span><span class="n">gamma_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> s‚Åª¬π&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Growth time: œÑ = </span><span class="si">{</span><span class="mi">1</span><span class="o">/</span><span class="n">gamma_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>

    <span class="c1"># With transverse magnetic field (k perpendicular to B)</span>
    <span class="n">B0</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">gamma_perp</span> <span class="o">=</span> <span class="n">rayleigh_taylor_growth_rate</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rho1</span><span class="p">,</span> <span class="n">rho2</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">kx_frac</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Magnetic field B = </span><span class="si">{</span><span class="n">B0</span><span class="si">}</span><span class="s2"> T (k ‚ä• B) ---&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Growth rate: Œ≥ = </span><span class="si">{</span><span class="n">gamma_perp</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> s‚Åª¬π&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Still unstable!&quot;</span><span class="p">)</span>

    <span class="c1"># With field-aligned perturbation</span>
    <span class="n">gamma_par</span> <span class="o">=</span> <span class="n">rayleigh_taylor_growth_rate</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rho1</span><span class="p">,</span> <span class="n">rho2</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">kx_frac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Magnetic field B = </span><span class="si">{</span><span class="n">B0</span><span class="si">}</span><span class="s2"> T (k ‚à• B) ---&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gamma_par</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Growth rate: Œ≥ = </span><span class="si">{</span><span class="n">gamma_par</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> s‚Åª¬π&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STABLE (Œ≥ = 0)&quot;</span><span class="p">)</span>

    <span class="c1"># Critical wavenumber</span>
    <span class="n">mu0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1e-7</span>
    <span class="n">k_c</span> <span class="o">=</span> <span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="n">rho2</span> <span class="o">-</span> <span class="n">rho1</span><span class="p">)</span> <span class="o">*</span> <span class="n">mu0</span> <span class="o">/</span> <span class="n">B0</span><span class="o">**</span><span class="mi">2</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Critical wavenumber: k_c = </span><span class="si">{</span><span class="n">k_c</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> m‚Åª¬π&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Modes with k &gt; k_c are stable (if k ‚à• B)&quot;</span><span class="p">)</span>

    <span class="c1"># Plot</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_rt_growth_rate</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/tmp/rt_growth_rate.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Growth rate plot saved to /tmp/rt_growth_rate.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">example_rt_instability</span><span class="p">()</span>
</code></pre></div>

<h3 id="72-ballooning-stability-analysis">7.2 Ballooning Stability Analysis<a class="header-link" href="#72-ballooning-stability-analysis" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">fsolve</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ballooning_stability_boundary</span><span class="p">(</span><span class="n">s_vals</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Approximate ballooning stability boundary in s-Œ± space</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    s_vals: array of magnetic shear values</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    alpha_crit: critical alpha for marginal stability</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Empirical fit: Œ±_crit ‚âà 0.6 * s</span>
    <span class="n">alpha_crit</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">s_vals</span>

    <span class="k">return</span> <span class="n">alpha_crit</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compute_alpha_parameter</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">R0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute pressure gradient parameter Œ±</span>

<span class="sd">    Œ± = -(2Œº‚ÇÄR‚ÇÄ¬≤q¬≤/B‚ÇÄ¬≤)(dp/dr)</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    r: minor radius [m]</span>
<span class="sd">    p: pressure [Pa]</span>
<span class="sd">    q: safety factor</span>
<span class="sd">    B0: toroidal field [T]</span>
<span class="sd">    R0: major radius [m]</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    alpha: normalized pressure gradient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mu0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1e-7</span>

    <span class="c1"># Numerical derivative</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">dpdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">dr</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">dr</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dr</span><span class="p">)</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">mu0</span><span class="o">*</span><span class="n">R0</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">B0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dpdx</span>

    <span class="k">return</span> <span class="n">alpha</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_s_alpha_diagram</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot s-Œ± stability diagram&quot;&quot;&quot;</span>

    <span class="c1"># Shear range</span>
    <span class="n">s_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="c1"># Stability boundary</span>
    <span class="n">alpha_crit</span> <span class="o">=</span> <span class="n">ballooning_stability_boundary</span><span class="p">(</span><span class="n">s_vals</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="c1"># Fill stable and unstable regions</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">s_vals</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha_crit</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;STABLE&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">s_vals</span><span class="p">,</span> <span class="n">alpha_crit</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;UNSTABLE&#39;</span><span class="p">)</span>

    <span class="c1"># Boundary</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_vals</span><span class="p">,</span> <span class="n">alpha_crit</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Marginal stability&#39;</span><span class="p">)</span>

    <span class="c1"># Example operating points</span>
    <span class="n">examples</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;Standard H-mode&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s1">&#39;ELMy H-mode&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;Improved confinement&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
        <span class="n">stable</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">&lt;</span> <span class="n">ballooning_stability_boundary</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span> <span class="k">if</span> <span class="n">stable</span> <span class="k">else</span> <span class="s1">&#39;x&#39;</span>
        <span class="n">markersize</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">markeredgewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Magnetic shear s = (r/q)(dq/dr)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pressure parameter Œ±&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Ballooning Stability Diagram (s-Œ±)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="k">def</span><span class="w"> </span><span class="nf">analyze_tokamak_ballooning</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze ballooning stability for a tokamak equilibrium&quot;&quot;&quot;</span>

    <span class="c1"># Tokamak parameters</span>
    <span class="n">R0</span> <span class="o">=</span> <span class="mf">3.0</span>  <span class="c1"># Major radius [m]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">1.0</span>   <span class="c1"># Minor radius [m]</span>
    <span class="n">B0</span> <span class="o">=</span> <span class="mf">5.0</span>  <span class="c1"># Toroidal field [T]</span>

    <span class="c1"># Profiles</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">p_profile</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="mf">5e5</span>  <span class="c1"># Central pressure [Pa]</span>
        <span class="k">return</span> <span class="n">p0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">q_profile</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="n">q0</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="mf">4.0</span>
        <span class="k">return</span> <span class="n">q0</span> <span class="o">+</span> <span class="p">(</span><span class="n">qa</span> <span class="o">-</span> <span class="n">q0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1"># Compute s and Œ± profiles</span>
    <span class="n">r_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

    <span class="n">s_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">alpha_vals</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">r_vals</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q_profile</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># Magnetic shear</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="mf">0.001</span>
        <span class="n">dqdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">q_profile</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">dr</span><span class="p">)</span> <span class="o">-</span> <span class="n">q_profile</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">dr</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dr</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">dqdx</span>

        <span class="c1"># Alpha parameter</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">compute_alpha_parameter</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p_profile</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">R0</span><span class="p">)</span>

        <span class="n">s_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">alpha_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>

    <span class="n">s_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s_vals</span><span class="p">)</span>
    <span class="n">alpha_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">alpha_vals</span><span class="p">)</span>

    <span class="c1"># Check stability</span>
    <span class="n">alpha_crit_vals</span> <span class="o">=</span> <span class="n">ballooning_stability_boundary</span><span class="p">(</span><span class="n">s_vals</span><span class="p">)</span>
    <span class="n">stable</span> <span class="o">=</span> <span class="n">alpha_vals</span> <span class="o">&lt;</span> <span class="n">alpha_crit_vals</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Tokamak Ballooning Stability Analysis ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Major radius: R0 = </span><span class="si">{</span><span class="n">R0</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Minor radius: a = </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Toroidal field: B0 = </span><span class="si">{</span><span class="n">B0</span><span class="si">}</span><span class="s2"> T&quot;</span><span class="p">)</span>

    <span class="c1"># Find most unstable location</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="n">alpha_vals</span> <span class="o">-</span> <span class="n">alpha_crit_vals</span>
    <span class="n">idx_worst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">margin</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Most unstable location:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  r/a = </span><span class="si">{</span><span class="n">r_vals</span><span class="p">[</span><span class="n">idx_worst</span><span class="p">]</span><span class="o">/</span><span class="n">a</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  s = </span><span class="si">{</span><span class="n">s_vals</span><span class="p">[</span><span class="n">idx_worst</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Œ± = </span><span class="si">{</span><span class="n">alpha_vals</span><span class="p">[</span><span class="n">idx_worst</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Œ±_crit = </span><span class="si">{</span><span class="n">alpha_crit_vals</span><span class="p">[</span><span class="n">idx_worst</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Margin: </span><span class="si">{</span><span class="n">margin</span><span class="p">[</span><span class="n">idx_worst</span><span class="p">]</span><span class="si">:</span><span class="s2">+.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">margin</span><span class="p">[</span><span class="n">idx_worst</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Status: UNSTABLE to ballooning modes&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Status: STABLE&quot;</span><span class="p">)</span>

    <span class="c1"># Plot profiles</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Pressure</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">r_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">p_plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">p_profile</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r_plot</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r_plot</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p_plot</span><span class="p">)</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pressure [kPa]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pressure Profile&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Safety factor</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">q_plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">q_profile</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r_plot</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r_plot</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">q_plot</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Safety Factor Profile&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># s-Œ± trajectory</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">s_boundary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">s_vals</span><span class="p">)</span><span class="o">*</span><span class="mf">1.2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">alpha_boundary</span> <span class="o">=</span> <span class="n">ballooning_stability_boundary</span><span class="p">(</span><span class="n">s_boundary</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">s_boundary</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha_boundary</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">s_boundary</span><span class="p">,</span> <span class="n">alpha_boundary</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">alpha_vals</span><span class="p">)</span><span class="o">*</span><span class="mf">1.2</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_vals</span><span class="p">,</span> <span class="n">alpha_vals</span><span class="p">,</span> <span class="s1">&#39;bo-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Equilibrium trajectory&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_boundary</span><span class="p">,</span> <span class="n">alpha_boundary</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Stability boundary&#39;</span><span class="p">)</span>

    <span class="c1"># Mark unstable region</span>
    <span class="n">unstable_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">stable</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">unstable_mask</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_vals</span><span class="p">[</span><span class="n">unstable_mask</span><span class="p">],</span> <span class="n">alpha_vals</span><span class="p">[</span><span class="n">unstable_mask</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Unstable locations&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Œ±&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;s-Œ± Stability Trajectory&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Stability margin</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r_vals</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">r_vals</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">margin</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Unstable&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">r_vals</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">margin</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Stable&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Œ± - Œ±_crit&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Ballooning Stability Margin&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/tmp/ballooning_analysis.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Ballooning analysis plot saved to /tmp/ballooning_analysis.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Also create s-Œ± diagram</span>
    <span class="n">fig2</span> <span class="o">=</span> <span class="n">plot_s_alpha_diagram</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/tmp/s_alpha_diagram.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;s-Œ± diagram saved to /tmp/s_alpha_diagram.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">analyze_tokamak_ballooning</span><span class="p">()</span>
</code></pre></div>

<h3 id="73-mercier-criterion-evaluation">7.3 Mercier Criterion Evaluation<a class="header-link" href="#73-mercier-criterion-evaluation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_mercier_criterion</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">Bp</span><span class="p">,</span> <span class="n">R0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate Mercier criterion: D_I &gt; 1/4</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    r: minor radius [m]</span>
<span class="sd">    q: safety factor</span>
<span class="sd">    p: pressure [Pa]</span>
<span class="sd">    Bp: poloidal field [T]</span>
<span class="sd">    R0: major radius [m]</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    D_I: Mercier stability parameter</span>
<span class="sd">    stable: True if stable, False if unstable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mu0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1e-7</span>

    <span class="c1"># Compute derivatives numerically</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="mf">0.001</span>

    <span class="c1"># Shear contribution</span>
    <span class="n">dqdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">dr</span><span class="p">)</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">dr</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dr</span><span class="p">)</span>
    <span class="n">D_S</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">((</span><span class="n">r</span> <span class="o">/</span> <span class="n">q</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="o">*</span> <span class="n">dqdx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1"># Magnetic well contribution</span>
    <span class="n">dpdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">dr</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">dr</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dr</span><span class="p">)</span>
    <span class="n">D_W</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu0</span> <span class="o">*</span> <span class="n">r</span> <span class="o">/</span> <span class="n">Bp</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dpdx</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Geodesic curvature</span>
    <span class="n">D_G</span> <span class="o">=</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">R0</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Total</span>
    <span class="n">D_I</span> <span class="o">=</span> <span class="n">D_S</span> <span class="o">+</span> <span class="n">D_W</span> <span class="o">+</span> <span class="n">D_G</span>

    <span class="c1"># Stability criterion</span>
    <span class="n">stable</span> <span class="o">=</span> <span class="n">D_I</span> <span class="o">&gt;</span> <span class="mf">0.25</span>

    <span class="k">return</span> <span class="n">D_I</span><span class="p">,</span> <span class="n">D_S</span><span class="p">,</span> <span class="n">D_W</span><span class="p">,</span> <span class="n">D_G</span><span class="p">,</span> <span class="n">stable</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_mercier_stability</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze Mercier stability for a tokamak&quot;&quot;&quot;</span>

    <span class="c1"># Parameters</span>
    <span class="n">R0</span> <span class="o">=</span> <span class="mf">3.0</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="mf">5e5</span>
    <span class="n">Bp0</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="c1"># Profiles</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">q_func</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">3.0</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">p_func</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Bp_func</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="c1"># Approximate: Bp ~ r for parabolic current</span>
        <span class="k">return</span> <span class="n">Bp0</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1e-6</span>

    <span class="c1"># Evaluate over radius</span>
    <span class="n">r_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="mf">0.95</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="n">D_I_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">D_S_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">D_W_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">D_G_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stable_vals</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">r_vals</span><span class="p">:</span>
        <span class="n">D_I</span><span class="p">,</span> <span class="n">D_S</span><span class="p">,</span> <span class="n">D_W</span><span class="p">,</span> <span class="n">D_G</span><span class="p">,</span> <span class="n">stable</span> <span class="o">=</span> <span class="n">evaluate_mercier_criterion</span><span class="p">(</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">q_func</span><span class="p">,</span> <span class="n">p_func</span><span class="p">,</span> <span class="n">Bp_func</span><span class="p">,</span> <span class="n">R0</span><span class="p">)</span>

        <span class="n">D_I_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">D_I</span><span class="p">)</span>
        <span class="n">D_S_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">D_S</span><span class="p">)</span>
        <span class="n">D_W_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">D_W</span><span class="p">)</span>
        <span class="n">D_G_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">D_G</span><span class="p">)</span>
        <span class="n">stable_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stable</span><span class="p">)</span>

    <span class="n">D_I_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">D_I_vals</span><span class="p">)</span>
    <span class="n">D_S_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">D_S_vals</span><span class="p">)</span>
    <span class="n">D_W_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">D_W_vals</span><span class="p">)</span>
    <span class="n">D_G_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">D_G_vals</span><span class="p">)</span>
    <span class="n">stable_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stable_vals</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Mercier Criterion Analysis ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Major radius: R0 = </span><span class="si">{</span><span class="n">R0</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Minor radius: a = </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>

    <span class="c1"># Check if any location is Mercier unstable</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">stable_vals</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">‚úì STABLE: Mercier criterion satisfied at all radii&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">‚úó UNSTABLE: Mercier criterion violated!&quot;</span><span class="p">)</span>
        <span class="n">unstable_r</span> <span class="o">=</span> <span class="n">r_vals</span><span class="p">[</span><span class="o">~</span><span class="n">stable_vals</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Unstable region: r/a ‚àà [</span><span class="si">{</span><span class="n">unstable_r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">a</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">unstable_r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">a</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

    <span class="c1"># Find minimum D_I</span>
    <span class="n">idx_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">D_I_vals</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Most dangerous location:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  r/a = </span><span class="si">{</span><span class="n">r_vals</span><span class="p">[</span><span class="n">idx_min</span><span class="p">]</span><span class="o">/</span><span class="n">a</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  D_I = </span><span class="si">{</span><span class="n">D_I_vals</span><span class="p">[</span><span class="n">idx_min</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (critical: 0.25)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Margin: </span><span class="si">{</span><span class="n">D_I_vals</span><span class="p">[</span><span class="n">idx_min</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.25</span><span class="si">:</span><span class="s2">+.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Plot</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Panel 1: Individual contributions</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r_vals</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">D_S_vals</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;D_S (shear)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r_vals</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">D_W_vals</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;D_W (well)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r_vals</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">D_G_vals</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;D_G (geodesic)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r_vals</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">D_I_vals</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;D_I (total)&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Mercier Contributions&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mercier Stability Parameter Components&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Panel 2: Stability margin</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="n">D_I_vals</span> <span class="o">-</span> <span class="mf">0.25</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r_vals</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">r_vals</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">margin</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Stable (D_I &gt; 0.25)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">r_vals</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">margin</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Unstable (D_I &lt; 0.25)&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;D_I - 0.25&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mercier Stability Margin&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/tmp/mercier_stability.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mercier stability plot saved to /tmp/mercier_stability.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">plot_mercier_stability</span><span class="p">()</span>
</code></pre></div>

<h2 id="summary">Summary<a class="header-link" href="#summary" title="Permanent link">&para;</a></h2>
<p>In this lesson, we have explored pressure-driven MHD instabilities:</p>
<ol>
<li>
<p><strong>Interchange Instability</strong>: Driven by unfavorable curvature ($\boldsymbol{\kappa}\cdot\nabla p > 0$). Stabilized by magnetic shear and favorable average curvature.</p>
</li>
<li>
<p><strong>Rayleigh-Taylor Instability</strong>: Heavy fluid on top of light fluid. Magnetic field stabilizes short wavelengths along field direction but not perpendicular.</p>
</li>
<li>
<p><strong>Parker Instability</strong>: Magnetic buoyancy in stratified atmosphere. Unstable when $\beta > 2/\gamma \approx 1.2$. Important for astrophysical plasmas.</p>
</li>
<li>
<p><strong>Ballooning Modes</strong>: High-$n$ modes localized on bad curvature side in toroidal geometry. Stability boundary in s-Œ± space: $\alpha_c \approx 0.6s$. Connected to ELMs in tokamaks.</p>
</li>
<li>
<p><strong>Mercier Criterion</strong>: Necessary condition for local interchange stability: $D_I = D_S + D_W + D_G > 1/4$. Combines shear, magnetic well, and geodesic curvature.</p>
</li>
<li>
<p><strong>Numerical Tools</strong>: Implementations for RT growth rates, ballooning stability diagrams, and Mercier criterion evaluation.</p>
</li>
</ol>
<p>These instabilities limit achievable plasma pressure (beta limit) and drive the need for careful equilibrium design, shaping, and active control in fusion devices.</p>
<h2 id="practice-problems">Practice Problems<a class="header-link" href="#practice-problems" title="Permanent link">&para;</a></h2>
<h3 id="problem-1-interchange-stability-in-a-mirror">Problem 1: Interchange Stability in a Mirror<a class="header-link" href="#problem-1-interchange-stability-in-a-mirror" title="Permanent link">&para;</a></h3>
<p>A magnetic mirror has field strength $B(z) = B_0(1 + z^2/L^2)$ and uniform pressure $p = p_0$.</p>
<p><strong>(a)</strong> Compute the curvature $\boldsymbol{\kappa} = \mathbf{b}\cdot\nabla\mathbf{b}$ where $\mathbf{b} = \mathbf{B}/B$.</p>
<p><strong>(b)</strong> Evaluate $\boldsymbol{\kappa}\cdot\nabla p$.</p>
<p><strong>(c)</strong> Is this configuration stable or unstable to interchange?</p>
<p><strong>(d)</strong> How would adding a pressure gradient $p(z) = p_0 e^{-z^2/L_p^2}$ affect stability?</p>
<h3 id="problem-2-rt-critical-wavelength">Problem 2: RT Critical Wavelength<a class="header-link" href="#problem-2-rt-critical-wavelength" title="Permanent link">&para;</a></h3>
<p>Plasma with density $\rho_2 = 10^{-6}$ kg/m¬≥ is supported above vacuum ($\rho_1 \approx 0$) by a horizontal magnetic field $B_0 = 1$ T in effective gravity $g_{eff} = 10^4$ m/s¬≤ (centrifugal acceleration).</p>
<p><strong>(a)</strong> Compute the critical wavenumber $k_c$ for RT stability.</p>
<p><strong>(b)</strong> Convert to critical wavelength $\lambda_c = 2\pi/k_c$.</p>
<p><strong>(c)</strong> For $k = 0.5k_c$, compute the growth rate $\gamma$.</p>
<p><strong>(d)</strong> Estimate the growth time $\tau = 1/\gamma$.</p>
<p><strong>(e)</strong> Compare $\tau$ to the Alfv√©n time $\tau_A = \lambda_c/v_A$.</p>
<h3 id="problem-3-ballooning-stability-boundary">Problem 3: Ballooning Stability Boundary<a class="header-link" href="#problem-3-ballooning-stability-boundary" title="Permanent link">&para;</a></h3>
<p>A tokamak has magnetic shear $s = 2.5$ at mid-radius.</p>
<p><strong>(a)</strong> Using the approximate formula $\alpha_c \approx 0.6s$, compute the critical pressure parameter.</p>
<p><strong>(b)</strong> If the actual $\alpha = 2.0$, is the plasma stable or unstable to ballooning?</p>
<p><strong>(c)</strong> By what factor must the pressure gradient be reduced to achieve marginal stability?</p>
<p><strong>(d)</strong> If instead $s$ is increased to 4.0 (while keeping $\alpha=2.0$), does the plasma become stable?</p>
<p><strong>(e)</strong> Discuss two experimental methods to increase $s$ in a tokamak.</p>
<h3 id="problem-4-parker-instability-in-galactic-disk">Problem 4: Parker Instability in Galactic Disk<a class="header-link" href="#problem-4-parker-instability-in-galactic-disk" title="Permanent link">&para;</a></h3>
<p>A galactic disk has:
- Gas density $\rho_0 = 10^{-24}$ kg/m¬≥
- Temperature $T = 10^4$ K
- Magnetic field $B = 5\times 10^{-10}$ T
- Scale height $H = 100$ pc = $3\times 10^{18}$ m</p>
<p><strong>(a)</strong> Compute the gas pressure $p = nkT$ (assume $n = \rho_0/m_p$).</p>
<p><strong>(b)</strong> Calculate plasma beta $\beta = 2\mu_0 p/B^2$.</p>
<p><strong>(c)</strong> Check the Parker instability condition $\beta > 2/\gamma$ (use $\gamma = 5/3$).</p>
<p><strong>(d)</strong> If unstable, estimate the growth rate $\gamma \sim \sqrt{g/H}$ where $g \sim kT/(m_p H)$.</p>
<p><strong>(e)</strong> Convert growth time to years. Is this consistent with observed timescales for molecular cloud formation?</p>
<h3 id="problem-5-mercier-criterion-components">Problem 5: Mercier Criterion Components<a class="header-link" href="#problem-5-mercier-criterion-components" title="Permanent link">&para;</a></h3>
<p>A tokamak has at $r = 0.5a$:
- Safety factor $q = 1.5$
- Magnetic shear $(r/q)(dq/dr) = 1.0$
- Pressure $p = 2\times 10^5$ Pa
- Pressure gradient $dp/dr = -10^6$ Pa/m
- Poloidal field $B_p = 0.4$ T
- Major radius $R_0 = 3$ m</p>
<p><strong>(a)</strong> Compute the shear contribution $D_S = \frac{1}{4}\left(\frac{r}{q}\frac{dq}{dr}\right)^2$.</p>
<p><strong>(b)</strong> Compute the magnetic well contribution $D_W = \frac{\mu_0 r}{B_p^2}\frac{dp}{dr}(1 + 2q^2)$.</p>
<p><strong>(c)</strong> Compute the geodesic curvature $D_G = \frac{r^2}{R_0^2 q^2}$.</p>
<p><strong>(d)</strong> Evaluate $D_I = D_S + D_W + D_G$.</p>
<p><strong>(e)</strong> Check if $D_I > 0.25$ (Mercier stable).</p>
<p><strong>(f)</strong> Which term contributes most to stability/instability?</p>
<hr />
<p><strong>Previous</strong>: <a href="./02_Linear_Stability.md">Linear Stability</a> | <strong>Next</strong>: <a href="./04_Current_Driven_Instabilities.md">Current-Driven Instabilities</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/MHD/02_Linear_Stability.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">2. Linear Stability Theory</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/MHD/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/MHD/04_Current_Driven_Instabilities.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">4. Current-Driven Instabilities</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">‚Üë</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}