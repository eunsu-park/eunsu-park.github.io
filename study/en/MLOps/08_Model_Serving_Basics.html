{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>08. Model Serving Basics - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/MLOps/">MLOps</a>
    <span class="separator">/</span>
    <span class="current">08. Model Serving Basics</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>08. Model Serving Basics</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/MLOps/07_Model_Registry.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">07. Model Registry</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/MLOps/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/MLOps/09_TorchServe_Triton.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">09. TorchServe & Triton Inference Server</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#1-model-serving-concepts">1. Model Serving Concepts</a><ul>
<li><a href="#11-serving-architecture">1.1 Serving Architecture</a></li>
<li><a href="#12-serving-method-comparison">1.2 Serving Method Comparison</a></li>
</ul>
</li>
<li><a href="#2-rest-api-deployment">2. REST API Deployment</a><ul>
<li><a href="#21-model-serving-with-flask">2.1 Model Serving with Flask</a></li>
<li><a href="#22-model-serving-with-fastapi">2.2 Model Serving with FastAPI</a></li>
<li><a href="#23-docker-containerization">2.3 Docker Containerization</a></li>
</ul>
</li>
<li><a href="#3-grpc-serving">3. gRPC Serving</a><ul>
<li><a href="#31-proto-definition">3.1 Proto Definition</a></li>
<li><a href="#32-grpc-server-implementation">3.2 gRPC Server Implementation</a></li>
<li><a href="#33-grpc-client">3.3 gRPC Client</a></li>
<li><a href="#34-rest-vs-grpc-comparison">3.4 REST vs gRPC Comparison</a></li>
</ul>
</li>
<li><a href="#4-batch-inference-vs-online-inference">4. Batch Inference vs Online Inference</a><ul>
<li><a href="#41-batch-inference">4.1 Batch Inference</a></li>
<li><a href="#42-online-inference-optimization">4.2 Online Inference Optimization</a></li>
<li><a href="#43-model-caching">4.3 Model Caching</a></li>
</ul>
</li>
<li><a href="#5-serving-infrastructure">5. Serving Infrastructure</a><ul>
<li><a href="#51-kubernetes-deployment">5.1 Kubernetes Deployment</a></li>
<li><a href="#52-load-balancing">5.2 Load Balancing</a></li>
</ul>
</li>
<li><a href="#6-monitoring-and-logging">6. Monitoring and Logging</a></li>
<li><a href="#practice-exercises">Practice Exercises</a><ul>
<li><a href="#exercise-1-fastapi-serving">Exercise 1: FastAPI Serving</a></li>
<li><a href="#exercise-2-docker-containerization">Exercise 2: Docker Containerization</a></li>
<li><a href="#exercise-3-performance-testing">Exercise 3: Performance Testing</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="08-model-serving-basics">08. Model Serving Basics<a class="header-link" href="#08-model-serving-basics" title="Permanent link">&para;</a></h1>
<h2 id="1-model-serving-concepts">1. Model Serving Concepts<a class="header-link" href="#1-model-serving-concepts" title="Permanent link">&para;</a></h2>
<p>Model serving is providing trained ML models as prediction services in production environments.</p>
<h3 id="11-serving-architecture">1.1 Serving Architecture<a class="header-link" href="#11-serving-architecture" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Model Serving Architecture                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚   â”‚ Client  â”‚                                                       â”‚
â”‚   â”‚(App/Web)â”‚                                                       â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                       â”‚
â”‚        â”‚                                                            â”‚
â”‚        â–¼                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚    Load     â”‚â”€â”€â”€â”€â–¶â”‚    API      â”‚â”€â”€â”€â”€â–¶â”‚   Model     â”‚          â”‚
â”‚   â”‚  Balancer   â”‚     â”‚  Gateway    â”‚     â”‚   Server    â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                   â”‚                 â”‚
â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                             â”‚                     â”‚        â”‚       â”‚
â”‚                             â–¼                     â–¼        â–¼       â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   ...     â”‚
â”‚                       â”‚ Model A  â”‚          â”‚ Model B  â”‚           â”‚
â”‚                       â”‚ (v1.2.0) â”‚          â”‚ (v2.0.0) â”‚           â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="12-serving-method-comparison">1.2 Serving Method Comparison<a class="header-link" href="#12-serving-method-comparison" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Model serving methods</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">serving_methods</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;batch_inference&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Process large amounts of data in bulk&quot;</span><span class="p">,</span>
        <span class="s2">&quot;latency&quot;</span><span class="p">:</span> <span class="s2">&quot;High (minutes~hours)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;use_cases&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Recommendation system pre-computation&quot;</span><span class="p">,</span> <span class="s2">&quot;Report generation&quot;</span><span class="p">,</span> <span class="s2">&quot;Data pipelines&quot;</span><span class="p">],</span>
        <span class="s2">&quot;pros&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;High throughput&quot;</span><span class="p">,</span> <span class="s2">&quot;Cost efficient&quot;</span><span class="p">],</span>
        <span class="s2">&quot;cons&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not real-time&quot;</span><span class="p">,</span> <span class="s2">&quot;Data latency&quot;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;online_inference&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Real-time request-response&quot;</span><span class="p">,</span>
        <span class="s2">&quot;latency&quot;</span><span class="p">:</span> <span class="s2">&quot;Low (ms)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;use_cases&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Fraud detection&quot;</span><span class="p">,</span> <span class="s2">&quot;Search ranking&quot;</span><span class="p">,</span> <span class="s2">&quot;Chatbots&quot;</span><span class="p">],</span>
        <span class="s2">&quot;pros&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Real-time response&quot;</span><span class="p">,</span> <span class="s2">&quot;Latest data&quot;</span><span class="p">],</span>
        <span class="s2">&quot;cons&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Infrastructure cost&quot;</span><span class="p">,</span> <span class="s2">&quot;Complex operations&quot;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;streaming_inference&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Process continuous data streams&quot;</span><span class="p">,</span>
        <span class="s2">&quot;latency&quot;</span><span class="p">:</span> <span class="s2">&quot;Medium (seconds)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;use_cases&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;IoT anomaly detection&quot;</span><span class="p">,</span> <span class="s2">&quot;Real-time analytics&quot;</span><span class="p">],</span>
        <span class="s2">&quot;pros&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Continuous processing&quot;</span><span class="p">,</span> <span class="s2">&quot;Event-driven&quot;</span><span class="p">],</span>
        <span class="s2">&quot;cons&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Complex architecture&quot;</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="2-rest-api-deployment">2. REST API Deployment<a class="header-link" href="#2-rest-api-deployment" title="Permanent link">&para;</a></h2>
<h3 id="21-model-serving-with-flask">2.1 Model Serving with Flask<a class="header-link" href="#21-model-serving-with-flask" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Flask-based model serving</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Load model (at application startup)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;model.pkl&quot;</span><span class="p">)</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;scaler.pkl&quot;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">health</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Health check endpoint&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">})</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/predict&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prediction endpoint&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Parse input data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Missing &#39;features&#39; in request&quot;</span><span class="p">}),</span> <span class="mi">400</span>

        <span class="c1"># Convert to DataFrame</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">features</span><span class="p">])</span>

        <span class="c1"># Preprocessing</span>
        <span class="n">df_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Prediction</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">probability</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">df_scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;prediction&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">prediction</span><span class="p">),</span>
            <span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="n">probability</span><span class="p">,</span>
            <span class="s2">&quot;model_version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span>
        <span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">500</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/batch_predict&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">batch_predict</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Batch prediction endpoint&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;instances&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
        <span class="n">df_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_scaled</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">df_scaled</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;predictions&quot;</span><span class="p">:</span> <span class="n">predictions</span><span class="p">,</span>
            <span class="s2">&quot;probabilities&quot;</span><span class="p">:</span> <span class="n">probabilities</span>
        <span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">500</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
</code></pre></div>

<h3 id="22-model-serving-with-fastapi">2.2 Model Serving with FastAPI<a class="header-link" href="#22-model-serving-with-fastapi" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">FastAPI-based model serving (recommended)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ML Model API&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Machine Learning Model Serving API&quot;</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span>
<span class="p">)</span>

<span class="c1"># Define Pydantic models</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PredictionInput</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prediction input schema&quot;&quot;&quot;</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Customer age&quot;</span><span class="p">)</span>
    <span class="n">tenure</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Months as customer&quot;</span><span class="p">)</span>
    <span class="n">monthly_charges</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Monthly charges&quot;</span><span class="p">)</span>
    <span class="n">total_charges</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Total charges&quot;</span><span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
        <span class="n">json_schema_extra</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;example&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mf">35.0</span><span class="p">,</span>
                <span class="s2">&quot;tenure&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
                <span class="s2">&quot;monthly_charges&quot;</span><span class="p">:</span> <span class="mf">65.5</span><span class="p">,</span>
                <span class="s2">&quot;total_charges&quot;</span><span class="p">:</span> <span class="mf">1572.0</span>
            <span class="p">}</span>
        <span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PredictionOutput</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prediction output schema&quot;&quot;&quot;</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">probability</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="n">model_version</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BatchInput</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Batch input schema&quot;&quot;&quot;</span>
    <span class="n">instances</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PredictionInput</span><span class="p">]</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BatchOutput</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Batch output schema&quot;&quot;&quot;</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">probabilities</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span>

<span class="c1"># Load model</span>
<span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="kc">None</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;startup&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load model at application startup&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">model</span><span class="p">,</span> <span class="n">scaler</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;model.pkl&quot;</span><span class="p">)</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;scaler.pkl&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model loaded successfully&quot;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Health check&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span> <span class="s2">&quot;model_loaded&quot;</span><span class="p">:</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/predict&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PredictionOutput</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">input_data</span><span class="p">:</span> <span class="n">PredictionInput</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Single prediction&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Model not loaded&quot;</span><span class="p">)</span>

    <span class="c1"># Convert input to DataFrame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">input_data</span><span class="o">.</span><span class="n">dict</span><span class="p">()])</span>

    <span class="c1"># Preprocess and predict</span>
    <span class="n">df_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">probability</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">df_scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">PredictionOutput</span><span class="p">(</span>
        <span class="n">prediction</span><span class="o">=</span><span class="n">prediction</span><span class="p">,</span>
        <span class="n">probability</span><span class="o">=</span><span class="n">probability</span><span class="p">,</span>
        <span class="n">model_version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span>
    <span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/batch_predict&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">BatchOutput</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">batch_predict</span><span class="p">(</span><span class="n">input_data</span><span class="p">:</span> <span class="n">BatchInput</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Batch prediction&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Model not loaded&quot;</span><span class="p">)</span>

    <span class="c1"># Convert to DataFrame</span>
    <span class="n">instances</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_data</span><span class="o">.</span><span class="n">instances</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>

    <span class="c1"># Preprocess and predict</span>
    <span class="n">df_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_scaled</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">df_scaled</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">BatchOutput</span><span class="p">(</span>
        <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span>
        <span class="n">probabilities</span><span class="o">=</span><span class="n">probabilities</span>
    <span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>
</code></pre></div>

<h3 id="23-docker-containerization">2.3 Docker Containerization<a class="header-link" href="#23-docker-containerization" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c"># Dockerfile</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9-slim</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="c"># Install dependencies</span>
<span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span>.
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="c"># Copy application code</span>
<span class="k">COPY</span><span class="w"> </span>app.py<span class="w"> </span>.
<span class="k">COPY</span><span class="w"> </span>model.pkl<span class="w"> </span>.
<span class="k">COPY</span><span class="w"> </span>scaler.pkl<span class="w"> </span>.

<span class="c"># Expose port</span>
<span class="k">EXPOSE</span><span class="w"> </span><span class="s">8000</span>

<span class="c"># Run</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;uvicorn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;app:app&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--host&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--port&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;8000&quot;</span><span class="p">]</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code># requirements.txt
fastapi==0.104.0
uvicorn==0.24.0
pydantic==2.5.0
scikit-learn==1.3.0
pandas==2.1.0
joblib==1.3.0
numpy==1.24.0
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Build and run</span>
docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>ml-model-api:latest<span class="w"> </span>.
docker<span class="w"> </span>run<span class="w"> </span>-p<span class="w"> </span><span class="m">8000</span>:8000<span class="w"> </span>ml-model-api:latest
</code></pre></div>

<hr />
<h2 id="3-grpc-serving">3. gRPC Serving<a class="header-link" href="#3-grpc-serving" title="Permanent link">&para;</a></h2>
<h3 id="31-proto-definition">3.1 Proto Definition<a class="header-link" href="#31-proto-definition" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// prediction.proto</span>
<span class="k">syntax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;proto3&quot;</span><span class="p">;</span>

<span class="kn">package</span><span class="w"> </span><span class="nn">prediction</span><span class="p">;</span>

<span class="kd">service</span><span class="w"> </span><span class="n">PredictionService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">rpc</span><span class="w"> </span><span class="n">Predict</span><span class="w"> </span><span class="p">(</span><span class="n">PredictRequest</span><span class="p">)</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">PredictResponse</span><span class="p">);</span>
<span class="w">    </span><span class="k">rpc</span><span class="w"> </span><span class="n">BatchPredict</span><span class="w"> </span><span class="p">(</span><span class="n">BatchPredictRequest</span><span class="p">)</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">BatchPredictResponse</span><span class="p">);</span>
<span class="w">    </span><span class="k">rpc</span><span class="w"> </span><span class="n">HealthCheck</span><span class="w"> </span><span class="p">(</span><span class="n">HealthRequest</span><span class="p">)</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">HealthResponse</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">PredictRequest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">repeated</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="na">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">PredictResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int32</span><span class="w"> </span><span class="na">prediction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">repeated</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="na">probabilities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="na">model_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">BatchPredictRequest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">repeated</span><span class="w"> </span><span class="n">PredictRequest</span><span class="w"> </span><span class="na">instances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">BatchPredictResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">repeated</span><span class="w"> </span><span class="kt">int32</span><span class="w"> </span><span class="na">predictions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">repeated</span><span class="w"> </span><span class="n">Probabilities</span><span class="w"> </span><span class="na">probabilities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">Probabilities</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">repeated</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="na">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">HealthRequest</span><span class="w"> </span><span class="p">{}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">HealthResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="na">model_loaded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="32-grpc-server-implementation">3.2 gRPC Server Implementation<a class="header-link" href="#32-grpc-server-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">gRPC model server</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">grpc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent</span><span class="w"> </span><span class="kn">import</span> <span class="n">futures</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Code generated from proto</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">prediction_pb2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">prediction_pb2_grpc</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PredictionServicer</span><span class="p">(</span><span class="n">prediction_pb2_grpc</span><span class="o">.</span><span class="n">PredictionServiceServicer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;gRPC service implementation&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;model.pkl&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;scaler.pkl&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model loaded&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Single prediction&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">features</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">features_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

        <span class="n">prediction</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features_scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">features_scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">prediction_pb2</span><span class="o">.</span><span class="n">PredictResponse</span><span class="p">(</span>
            <span class="n">prediction</span><span class="o">=</span><span class="n">prediction</span><span class="p">,</span>
            <span class="n">probabilities</span><span class="o">=</span><span class="n">probabilities</span><span class="p">,</span>
            <span class="n">model_version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">BatchPredict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Batch prediction&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">instances</span><span class="p">])</span>
        <span class="n">features_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features_scaled</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">features_scaled</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">prob_messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">prediction_pb2</span><span class="o">.</span><span class="n">Probabilities</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">probabilities</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">prediction_pb2</span><span class="o">.</span><span class="n">BatchPredictResponse</span><span class="p">(</span>
            <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span>
            <span class="n">probabilities</span><span class="o">=</span><span class="n">prob_messages</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">HealthCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Health check&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">prediction_pb2</span><span class="o">.</span><span class="n">HealthResponse</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;healthy&quot;</span><span class="p">,</span>
            <span class="n">model_loaded</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">serve</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start gRPC server&quot;&quot;&quot;</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">server</span><span class="p">(</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">prediction_pb2_grpc</span><span class="o">.</span><span class="n">add_PredictionServiceServicer_to_server</span><span class="p">(</span>
        <span class="n">PredictionServicer</span><span class="p">(),</span> <span class="n">server</span>
    <span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">add_insecure_port</span><span class="p">(</span><span class="s2">&quot;[::]:50051&quot;</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gRPC server started on port 50051&quot;</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">wait_for_termination</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">serve</span><span class="p">()</span>
</code></pre></div>

<h3 id="33-grpc-client">3.3 gRPC Client<a class="header-link" href="#33-grpc-client" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">gRPC client</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">grpc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">prediction_pb2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">prediction_pb2_grpc</span>

<span class="k">def</span><span class="w"> </span><span class="nf">predict_single</span><span class="p">(</span><span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Single prediction request&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">grpc</span><span class="o">.</span><span class="n">insecure_channel</span><span class="p">(</span><span class="s2">&quot;localhost:50051&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">channel</span><span class="p">:</span>
        <span class="n">stub</span> <span class="o">=</span> <span class="n">prediction_pb2_grpc</span><span class="o">.</span><span class="n">PredictionServiceStub</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">prediction_pb2</span><span class="o">.</span><span class="n">PredictRequest</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">stub</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;prediction&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">prediction</span><span class="p">,</span>
            <span class="s2">&quot;probabilities&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">probabilities</span><span class="p">),</span>
            <span class="s2">&quot;model_version&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">model_version</span>
        <span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">predict_batch</span><span class="p">(</span><span class="n">instances</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Batch prediction request&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">grpc</span><span class="o">.</span><span class="n">insecure_channel</span><span class="p">(</span><span class="s2">&quot;localhost:50051&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">channel</span><span class="p">:</span>
        <span class="n">stub</span> <span class="o">=</span> <span class="n">prediction_pb2_grpc</span><span class="o">.</span><span class="n">PredictionServiceStub</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">prediction_pb2</span><span class="o">.</span><span class="n">BatchPredictRequest</span><span class="p">(</span>
            <span class="n">instances</span><span class="o">=</span><span class="p">[</span>
                <span class="n">prediction_pb2</span><span class="o">.</span><span class="n">PredictRequest</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">inst</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">instances</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">stub</span><span class="o">.</span><span class="n">BatchPredict</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;predictions&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">predictions</span><span class="p">),</span>
            <span class="s2">&quot;probabilities&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">probabilities</span><span class="p">]</span>
        <span class="p">}</span>

<span class="c1"># Example usage</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">predict_single</span><span class="p">([</span><span class="mf">35.0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mf">65.5</span><span class="p">,</span> <span class="mf">1572.0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="n">batch_result</span> <span class="o">=</span> <span class="n">predict_batch</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">35.0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mf">65.5</span><span class="p">,</span> <span class="mf">1572.0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">45.0</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mf">85.0</span><span class="p">,</span> <span class="mf">3060.0</span><span class="p">]</span>
<span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">batch_result</span><span class="p">)</span>
</code></pre></div>

<h3 id="34-rest-vs-grpc-comparison">3.4 REST vs gRPC Comparison<a class="header-link" href="#34-rest-vs-grpc-comparison" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">REST vs gRPC comparison</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">comparison</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;REST/HTTP&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP/1.1 or HTTP/2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data_format&quot;</span><span class="p">:</span> <span class="s2">&quot;JSON (text)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="s2">&quot;Optional (OpenAPI)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;streaming&quot;</span><span class="p">:</span> <span class="s2">&quot;Limited&quot;</span><span class="p">,</span>
        <span class="s2">&quot;browser_support&quot;</span><span class="p">:</span> <span class="s2">&quot;Native&quot;</span><span class="p">,</span>
        <span class="s2">&quot;use_cases&quot;</span><span class="p">:</span> <span class="s2">&quot;General web APIs, browser clients&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;gRPC&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP/2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data_format&quot;</span><span class="p">:</span> <span class="s2">&quot;Protocol Buffers (binary)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="s2">&quot;Required (.proto)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;streaming&quot;</span><span class="p">:</span> <span class="s2">&quot;Bidirectional support&quot;</span><span class="p">,</span>
        <span class="s2">&quot;browser_support&quot;</span><span class="p">:</span> <span class="s2">&quot;Requires gRPC-Web&quot;</span><span class="p">,</span>
        <span class="s2">&quot;use_cases&quot;</span><span class="p">:</span> <span class="s2">&quot;Microservices, low latency required&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Performance comparison (general benchmarks)</span>
<span class="n">performance</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;latency&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;REST&quot;</span><span class="p">:</span> <span class="s2">&quot;~50-100ms&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gRPC&quot;</span><span class="p">:</span> <span class="s2">&quot;~10-30ms&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;throughput&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;REST&quot;</span><span class="p">:</span> <span class="s2">&quot;~1000 req/s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gRPC&quot;</span><span class="p">:</span> <span class="s2">&quot;~5000 req/s&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;payload_size&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;REST/JSON&quot;</span><span class="p">:</span> <span class="s2">&quot;100 bytes&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gRPC/Protobuf&quot;</span><span class="p">:</span> <span class="s2">&quot;~50 bytes&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="4-batch-inference-vs-online-inference">4. Batch Inference vs Online Inference<a class="header-link" href="#4-batch-inference-vs-online-inference" title="Permanent link">&para;</a></h2>
<h3 id="41-batch-inference">4.1 Batch Inference<a class="header-link" href="#41-batch-inference" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Batch inference pipeline</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow.parquet</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BatchInference</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Batch inference class&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scaler_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">scaler_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run batch inference&quot;&quot;&quot;</span>
        <span class="c1"># Read large data in chunks</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">ParquetFile</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">reader</span><span class="o">.</span><span class="n">iter_batches</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

            <span class="c1"># Extract features</span>
            <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;monthly_charges&quot;</span><span class="p">,</span> <span class="s2">&quot;total_charges&quot;</span><span class="p">]</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">]</span>

            <span class="c1"># Preprocess and predict</span>
            <span class="n">features_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features_scaled</span><span class="p">)</span>
            <span class="n">probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">features_scaled</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Add results</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;prediction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;probability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probabilities</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;predicted_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Save results</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">final_df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_df</span><span class="p">)</span>

<span class="c1"># Use with scheduler (e.g., Airflow)</span>
<span class="c1"># batch_inference = BatchInference(&quot;model.pkl&quot;, &quot;scaler.pkl&quot;)</span>
<span class="c1"># count = batch_inference.run_batch(</span>
<span class="c1">#     &quot;s3://bucket/daily_data.parquet&quot;,</span>
<span class="c1">#     &quot;s3://bucket/predictions.parquet&quot;</span>
<span class="c1"># )</span>
</code></pre></div>

<h3 id="42-online-inference-optimization">4.2 Online Inference Optimization<a class="header-link" href="#42-online-inference-optimization" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Online inference optimization</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">class</span><span class="w"> </span><span class="nc">OptimizedInference</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimized online inference&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">max_wait_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_wait_ms</span> <span class="o">=</span> <span class="n">max_wait_ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_futures</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Single prediction (with batching)&quot;&quot;&quot;</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_futures</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">request_id</span><span class="p">,</span> <span class="n">features</span><span class="p">))</span>

        <span class="c1"># Trigger batch processing</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_batch</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Process after timeout</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayed_process</span><span class="p">())</span>

        <span class="k">return</span> <span class="k">await</span> <span class="n">future</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_delayed_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delayed processing&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_wait_ms</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_batch</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Batch processing&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Extract requests from queue</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">request_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
            <span class="n">req_id</span><span class="p">,</span> <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
            <span class="n">request_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

        <span class="c1"># Batch prediction</span>
        <span class="n">batch_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">batch_array</span><span class="p">)</span>

        <span class="c1"># Return results</span>
        <span class="k">for</span> <span class="n">req_id</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">request_ids</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">req_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_futures</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result_futures</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">set_result</span><span class="p">({</span><span class="s2">&quot;prediction&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">pred</span><span class="p">)})</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_futures</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span>
</code></pre></div>

<h3 id="43-model-caching">4.3 Model Caching<a class="header-link" href="#43-model-caching" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Model and result caching</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">redis</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CachedInference</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inference with caching&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">redis_client</span><span class="p">:</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># 1 hour</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate cache key&quot;&quot;&quot;</span>
        <span class="n">features_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;pred:</span><span class="si">{</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">features_str</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_with_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cached prediction&quot;&quot;&quot;</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cache_key</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>

        <span class="c1"># Check cache</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cached</span><span class="p">)</span>

        <span class="c1"># Perform prediction</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">features</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">probability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">([</span><span class="n">features</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;prediction&quot;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
            <span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="n">probability</span>
        <span class="p">}</span>

        <span class="c1"># Save to cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span>
            <span class="n">cache_key</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span><span class="p">,</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># In-memory LRU cache (for simple cases)</span>
<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">predict_cached</span><span class="p">(</span><span class="n">features_tuple</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;LRU cached prediction&quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">features_tuple</span><span class="p">)</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">features</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;prediction&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">prediction</span><span class="p">)}</span>
</code></pre></div>

<hr />
<h2 id="5-serving-infrastructure">5. Serving Infrastructure<a class="header-link" href="#5-serving-infrastructure" title="Permanent link">&para;</a></h2>
<h3 id="51-kubernetes-deployment">5.1 Kubernetes Deployment<a class="header-link" href="#51-kubernetes-deployment" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># deployment.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-model-api</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-model</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-model</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-model</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api</span>
<span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-model-api:latest</span>
<span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
<span class="w">          </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">            </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;512Mi&quot;</span>
<span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;250m&quot;</span>
<span class="w">            </span><span class="nt">limits</span><span class="p">:</span>
<span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1Gi&quot;</span>
<span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;500m&quot;</span>
<span class="w">          </span><span class="nt">livenessProbe</span><span class="p">:</span>
<span class="w">            </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">              </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/health</span>
<span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
<span class="w">            </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<span class="w">            </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">          </span><span class="nt">readinessProbe</span><span class="p">:</span>
<span class="w">            </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">              </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/health</span>
<span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
<span class="w">            </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">            </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">          </span><span class="nt">env</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MODEL_PATH</span>
<span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/models/model.pkl&quot;</span>
<span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model-volume</span>
<span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/models</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model-volume</span>
<span class="w">          </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
<span class="w">            </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model-pvc</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-model-service</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-model</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autoscaling/v2</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HorizontalPodAutoscaler</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-model-hpa</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">scaleTargetRef</span><span class="p">:</span>
<span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-model-api</span>
<span class="w">  </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">  </span><span class="nt">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">  </span><span class="nt">metrics</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Resource</span>
<span class="w">      </span><span class="nt">resource</span><span class="p">:</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cpu</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span>
<span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Utilization</span>
<span class="w">          </span><span class="nt">averageUtilization</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">70</span>
</code></pre></div>

<h3 id="52-load-balancing">5.2 Load Balancing<a class="header-link" href="#52-load-balancing" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Serving load balancing strategies</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">load_balancing_strategies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;round_robin&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Distribute requests sequentially&quot;</span><span class="p">,</span>
        <span class="s2">&quot;use_case&quot;</span><span class="p">:</span> <span class="s2">&quot;Uniform request processing time&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;least_connections&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Route to server with fewest connections&quot;</span><span class="p">,</span>
        <span class="s2">&quot;use_case&quot;</span><span class="p">:</span> <span class="s2">&quot;Varying request processing times&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;ip_hash&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Fixed server based on client IP&quot;</span><span class="p">,</span>
        <span class="s2">&quot;use_case&quot;</span><span class="p">:</span> <span class="s2">&quot;Session persistence required&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;weighted&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Weighted distribution by server capacity&quot;</span><span class="p">,</span>
        <span class="s2">&quot;use_case&quot;</span><span class="p">:</span> <span class="s2">&quot;Servers with different specs&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="6-monitoring-and-logging">6. Monitoring and Logging<a class="header-link" href="#6-monitoring-and-logging" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Serving monitoring</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">prometheus_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">Histogram</span><span class="p">,</span> <span class="n">Gauge</span><span class="p">,</span> <span class="n">start_http_server</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># Define Prometheus metrics</span>
<span class="n">PREDICTION_COUNT</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
    <span class="s2">&quot;prediction_total&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Total predictions&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;model_version&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">PREDICTION_LATENCY</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
    <span class="s2">&quot;prediction_latency_seconds&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Prediction latency&quot;</span><span class="p">,</span>
    <span class="n">buckets</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">MODEL_LOAD_TIME</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
    <span class="s2">&quot;model_load_time_seconds&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Time to load model&quot;</span>
<span class="p">)</span>

<span class="c1"># Add metrics to prediction function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">predict_with_metrics</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">features</span><span class="p">])</span>
        <span class="n">PREDICTION_COUNT</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">model_version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;success&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">PREDICTION_COUNT</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">model_version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;error&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
        <span class="k">raise</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">latency</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="n">PREDICTION_LATENCY</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">latency</span><span class="p">)</span>

<span class="c1"># Start Prometheus server</span>
<span class="n">start_http_server</span><span class="p">(</span><span class="mi">9090</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="practice-exercises">Practice Exercises<a class="header-link" href="#practice-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-fastapi-serving">Exercise 1: FastAPI Serving<a class="header-link" href="#exercise-1-fastapi-serving" title="Permanent link">&para;</a></h3>
<p>Create a complete API serving a scikit-learn model with FastAPI.</p>
<h3 id="exercise-2-docker-containerization">Exercise 2: Docker Containerization<a class="header-link" href="#exercise-2-docker-containerization" title="Permanent link">&para;</a></h3>
<p>Build and run the API as a Docker image.</p>
<h3 id="exercise-3-performance-testing">Exercise 3: Performance Testing<a class="header-link" href="#exercise-3-performance-testing" title="Permanent link">&para;</a></h3>
<p>Measure API performance using locust or wrk.</p>
<hr />
<h2 id="summary">Summary<a class="header-link" href="#summary" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>Method</th>
<th>Advantages</th>
<th>Disadvantages</th>
<th>Use Cases</th>
</tr>
</thead>
<tbody>
<tr>
<td>REST API</td>
<td>Simple, universal</td>
<td>Relatively high latency</td>
<td>General web services</td>
</tr>
<tr>
<td>gRPC</td>
<td>Low latency, high throughput</td>
<td>Complexity</td>
<td>Microservices</td>
</tr>
<tr>
<td>Batch Inference</td>
<td>Efficient, cost-effective</td>
<td>Not real-time</td>
<td>Large-scale data processing</td>
</tr>
<tr>
<td>Online Inference</td>
<td>Immediate response</td>
<td>Infrastructure cost</td>
<td>Fraud detection, recommendations</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://fastapi.tiangolo.com/">FastAPI Documentation</a></li>
<li><a href="https://grpc.io/docs/languages/python/">gRPC Python</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/">Kubernetes ML Serving</a></li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/MLOps/07_Model_Registry.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">07. Model Registry</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/MLOps/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/MLOps/09_TorchServe_Triton.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">09. TorchServe & Triton Inference Server</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}