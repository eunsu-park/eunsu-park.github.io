{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synchronization Tools - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/OS_Theory/">OS Theory</a>
    <span class="separator">/</span>
    <span class="current">Synchronization Tools</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Synchronization Tools</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/OS_Theory/07_Synchronization_Basics.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Synchronization Basics</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/OS_Theory/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/OS_Theory/09_Deadlock.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Deadlock</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-mutex">1. Mutex</a><ul>
<li><a href="#concept">Concept</a></li>
<li><a href="#using-pthread_mutex">Using pthread_mutex</a></li>
<li><a href="#mutex-initialization-methods">Mutex Initialization Methods</a></li>
<li><a href="#mutex-types">Mutex Types</a></li>
</ul>
</li>
<li><a href="#2-semaphore">2. Semaphore</a><ul>
<li><a href="#concept_1">Concept</a></li>
<li><a href="#pv-operations-waitsignal">P/V Operations (wait/signal)</a></li>
<li><a href="#using-posix-semaphore">Using POSIX Semaphore</a></li>
<li><a href="#counting-semaphore-example">Counting Semaphore Example</a></li>
<li><a href="#mutex-vs-semaphore">Mutex vs Semaphore</a></li>
</ul>
</li>
<li><a href="#3-monitor">3. Monitor</a><ul>
<li><a href="#concept_2">Concept</a></li>
<li><a href="#monitor-in-java">Monitor in Java</a></li>
</ul>
</li>
<li><a href="#4-condition-variable">4. Condition Variable</a><ul>
<li><a href="#concept_3">Concept</a></li>
<li><a href="#using-pthread-condition-variable">Using pthread Condition Variable</a></li>
<li><a href="#spurious-wakeup">Spurious Wakeup</a></li>
</ul>
</li>
<li><a href="#5-classic-synchronization-problems">5. Classic Synchronization Problems</a><ul>
<li><a href="#producer-consumer-problem-bounded-buffer">Producer-Consumer Problem (Bounded Buffer)</a></li>
<li><a href="#readers-writers-problem">Readers-Writers Problem</a></li>
<li><a href="#dining-philosophers-problem">Dining Philosophers Problem</a></li>
</ul>
</li>
<li><a href="#6-practice-problems">6. Practice Problems</a><ul>
<li><a href="#problem-1-semaphore-value">Problem 1: Semaphore Value</a></li>
<li><a href="#problem-2-producer-consumer">Problem 2: Producer-Consumer</a></li>
<li><a href="#problem-3-monitor-implementation">Problem 3: Monitor Implementation</a></li>
<li><a href="#problem-4-dining-philosophers-deadlock">Problem 4: Dining Philosophers Deadlock</a></li>
<li><a href="#problem-5-condition-variable-usage">Problem 5: Condition Variable Usage</a></li>
</ul>
</li>
<li><a href="#next-steps">Next Steps</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="synchronization-tools">Synchronization Tools<a class="header-link" href="#synchronization-tools" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="header-link" href="#overview" title="Permanent link">&para;</a></h2>
<p>Operating systems and programming languages provide various tools for synchronization. In this lesson, we'll learn about mutexes, semaphores, monitors, condition variables, and solve classic synchronization problems.</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-mutex">Mutex</a></li>
<li><a href="#2-semaphore">Semaphore</a></li>
<li><a href="#3-monitor">Monitor</a></li>
<li><a href="#4-condition-variable">Condition Variable</a></li>
<li><a href="#5-classic-synchronization-problems">Classic Synchronization Problems</a></li>
<li><a href="#6-practice-problems">Practice Problems</a></li>
</ol>
<hr />
<h2 id="1-mutex">1. Mutex<a class="header-link" href="#1-mutex" title="Permanent link">&para;</a></h2>
<h3 id="concept">Concept<a class="header-link" href="#concept" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                    </span><span class="nv">Mutex</span><span class="w"> </span><span class="ss">(</span><span class="nv">Mutual</span><span class="w"> </span><span class="nv">Exclusion</span><span class="ss">)</span><span class="w">              </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                         </span>â”‚
â”‚<span class="w">  </span><span class="nv">Mutex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Short</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">Mutual</span><span class="w"> </span><span class="nv">Exclusion</span><span class="w">                     </span>â”‚
â”‚<span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">Binary</span><span class="w"> </span><span class="nv">Lock</span><span class="w">                                    </span>â”‚
â”‚<span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">Allows</span><span class="w"> </span><span class="nv">only</span><span class="w"> </span><span class="nv">one</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">enter</span><span class="w"> </span><span class="nv">critical</span><span class="w">       </span>â”‚
â”‚<span class="w">          </span><span class="nv">section</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">time</span><span class="w">                              </span>â”‚
â”‚<span class="w">                                                         </span>â”‚
â”‚<span class="w">  </span><span class="nv">States</span>:<span class="w">                                                </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Locked</span>:<span class="w"> </span><span class="nv">One</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="nv">owns</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">lock</span><span class="w">                     </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Unlocked</span>:<span class="w"> </span><span class="nv">Available</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">use</span><span class="w">                          </span>â”‚
â”‚<span class="w">                                                         </span>â”‚
â”‚<span class="w">  </span><span class="nv">Basic</span><span class="w"> </span><span class="nv">Operations</span>:<span class="w">                                      </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">lock</span><span class="ss">()</span>:<span class="w"> </span><span class="nv">Acquire</span><span class="w"> </span><span class="nv">lock</span><span class="w"> </span><span class="ss">(</span><span class="nv">other</span><span class="w"> </span><span class="nv">threads</span><span class="w"> </span><span class="k">wait</span><span class="ss">)</span><span class="w">            </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">unlock</span><span class="ss">()</span>:<span class="w"> </span><span class="nv">Release</span><span class="w"> </span><span class="nv">lock</span><span class="w">                               </span>â”‚
â”‚<span class="w">                                                         </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">          </span><span class="nv">Mutex</span><span class="w"> </span><span class="nv">Operation</span><span class="w"> </span><span class="nv">Visualization</span><span class="w">          </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">                                                 </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="nv">Thread1</span>:<span class="w"> </span>â”€<span class="nv">lock</span><span class="ss">()</span>â”€â”¬â”€â”€â”€<span class="nv">critical</span><span class="w"> </span><span class="nv">section</span>â”€â”€â”€â”¬â”€<span class="nv">unlock</span><span class="ss">()</span>â”€<span class="w"> </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="nv">Thread2</span>:<span class="w"> </span>â”€<span class="nv">lock</span><span class="ss">()</span>â”€â”‚â”€<span class="nv">waiting</span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€<span class="nv">critical</span>â”€<span class="w"> </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">                   </span>â”‚<span class="w">                      </span>â–²<span class="w">           </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">                   </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">           </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">    </span>â”‚
â”‚<span class="w">                                                         </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="using-pthread_mutex">Using pthread_mutex<a class="header-link" href="#using-pthread_mutex" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span>

<span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">mutex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">increment</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span><span class="w">    </span><span class="c1">// Acquire lock</span>
<span class="w">        </span><span class="n">counter</span><span class="o">++</span><span class="p">;</span><span class="w">                      </span><span class="c1">// Critical section</span>
<span class="w">        </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span><span class="w">  </span><span class="c1">// Release lock</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_t</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">;</span>

<span class="w">    </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">increment</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">increment</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Counter: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">counter</span><span class="p">);</span><span class="w">  </span><span class="c1">// 2000000 (correct!)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="mutex-initialization-methods">Mutex Initialization Methods<a class="header-link" href="#mutex-initialization-methods" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Method 1: Static initialization</span>
<span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">mutex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>

<span class="c1">// Method 2: Dynamic initialization</span>
<span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span>
<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w">  </span><span class="c1">// NULL attributes = default</span>

<span class="c1">// Cleanup (for dynamic initialization)</span>
<span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>

<span class="c1">// Attribute setting example</span>
<span class="n">pthread_mutexattr_t</span><span class="w"> </span><span class="n">attr</span><span class="p">;</span>
<span class="n">pthread_mutexattr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
<span class="n">pthread_mutexattr_settype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="n">PTHREAD_MUTEX_RECURSIVE</span><span class="p">);</span><span class="w">  </span><span class="c1">// Recursive mutex</span>
<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
<span class="n">pthread_mutexattr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
</code></pre></div>

<h3 id="mutex-types">Mutex Types<a class="header-link" href="#mutex-types" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Mutex Types                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1. PTHREAD_MUTEX_NORMAL (default)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Recursive lock causes deadlock                 â”‚  â”‚
â”‚  â”‚  â€¢ Unlock by non-owner thread is undefined        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  2. PTHREAD_MUTEX_RECURSIVE                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Same thread can lock multiple times            â”‚  â”‚
â”‚  â”‚  â€¢ Requires unlock as many times as locked        â”‚  â”‚
â”‚  â”‚  â€¢ Useful in recursive functions                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  3. PTHREAD_MUTEX_ERRORCHECK                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Returns error on recursive lock                â”‚  â”‚
â”‚  â”‚  â€¢ Returns error on unlock by non-owner           â”‚  â”‚
â”‚  â”‚  â€¢ For debugging                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="2-semaphore">2. Semaphore<a class="header-link" href="#2-semaphore" title="Permanent link">&para;</a></h2>
<h3 id="concept_1">Concept<a class="header-link" href="#concept_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                   </span><span class="n">Semaphore</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Proposed</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">Dijkstra</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mi">1965</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">Synchronization</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">integer</span><span class="w"> </span><span class="n">value</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">Can</span><span class="w"> </span><span class="n">manage</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="n">resources</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Basic</span><span class="w"> </span><span class="n">Operations</span><span class="p">:</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">wait</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">P</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">down</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">acquire</span><span class="p">()</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">decrement</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">proceed</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">wait</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="k">signal</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">V</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">up</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">release</span><span class="p">()</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">Increment</span><span class="w"> </span><span class="n">value</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">Wake</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">any</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Types</span><span class="p">:</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Binary</span><span class="w"> </span><span class="n">semaphore</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">similar</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">mutex</span><span class="p">)</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Counting</span><span class="w"> </span><span class="n">semaphore</span><span class="p">:</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="err">â‰¥</span><span class="w"> </span><span class="mi">0</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="pv-operations-waitsignal">P/V Operations (wait/signal)<a class="header-link" href="#pv-operations-waitsignal" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="n">P</span><span class="o">/</span><span class="n">V</span><span class="w"> </span><span class="n">Operation</span><span class="w"> </span><span class="n">Definition</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">P</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">wait</span><span class="p">(</span><span class="n">S</span><span class="p">):</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">wait</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">                                        </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">S</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">                             </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">          </span><span class="o">//</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="p">(</span><span class="n">busy</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">blocking</span><span class="p">)</span><span class="w">       </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">      </span><span class="p">}</span><span class="w">                                            </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">      </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">                                   </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="p">}</span><span class="w">                                                </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Proberen</span><span class="w"> </span><span class="p">(</span><span class="n">Dutch</span><span class="p">:</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">test</span><span class="p">)</span><span class="w">                </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">V</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">signal</span><span class="p">(</span><span class="n">S</span><span class="p">):</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="k">signal</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">                                      </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">      </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">                                   </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">      </span><span class="o">//</span><span class="w"> </span><span class="n">wake</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">any</span><span class="w">            </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="p">}</span><span class="w">                                                </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Verhogen</span><span class="w"> </span><span class="p">(</span><span class="n">Dutch</span><span class="p">:</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">increment</span><span class="p">)</span><span class="w">           </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Important</span><span class="p">:</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">performed</span><span class="w"> </span><span class="n">atomically</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="using-posix-semaphore">Using POSIX Semaphore<a class="header-link" href="#using-posix-semaphore" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;semaphore.h&gt;</span>

<span class="n">sem_t</span><span class="w"> </span><span class="n">semaphore</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">increment</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">semaphore</span><span class="p">);</span><span class="w">    </span><span class="c1">// P operation: wait and decrement</span>
<span class="w">        </span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">semaphore</span><span class="p">);</span><span class="w">    </span><span class="c1">// V operation: increment and signal</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_t</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Initialize semaphore (value=1: binary semaphore)</span>
<span class="w">    </span><span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">semaphore</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// 0=shared between threads</span>

<span class="w">    </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">increment</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">increment</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">sem_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">semaphore</span><span class="p">);</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Counter: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">counter</span><span class="p">);</span><span class="w">  </span><span class="c1">// 2000000</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="counting-semaphore-example">Counting Semaphore Example<a class="header-link" href="#counting-semaphore-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;semaphore.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="cp">#define MAX_CONNECTIONS 3</span>

<span class="n">sem_t</span><span class="w"> </span><span class="n">connection_sem</span><span class="p">;</span>

<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Client %d: waiting for connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>

<span class="w">    </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connection_sem</span><span class="p">);</span><span class="w">  </span><span class="c1">// Acquire connection slot</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Client %d: connected (working...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w">  </span><span class="c1">// Simulate work</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Client %d: disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
<span class="w">    </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connection_sem</span><span class="p">);</span><span class="w">  </span><span class="c1">// Return connection slot</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_t</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ids</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// Allow maximum 3 simultaneous connections</span>
<span class="w">    </span><span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connection_sem</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_CONNECTIONS</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">        </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">sem_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connection_sem</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">Example output:</span>
<span class="cm">Client 0: waiting for connection</span>
<span class="cm">Client 0: connected (working...)</span>
<span class="cm">Client 1: waiting for connection</span>
<span class="cm">Client 1: connected (working...)</span>
<span class="cm">Client 2: waiting for connection</span>
<span class="cm">Client 2: connected (working...)</span>
<span class="cm">Client 3: waiting for connection       &lt;- More than 3 wait</span>
<span class="cm">...</span>
<span class="cm">*/</span>
</code></pre></div>

<h3 id="mutex-vs-semaphore">Mutex vs Semaphore<a class="header-link" href="#mutex-vs-semaphore" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">Feature</span><span class="w">      </span><span class="err">â”‚</span><span class="w">       </span><span class="n">Mutex</span><span class="w">         </span><span class="err">â”‚</span><span class="w">      </span><span class="n">Semaphore</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="nb">range</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">1</span><span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â‰¥</span><span class="w"> </span><span class="mi">0</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Ownership</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Yes</span><span class="w"> </span><span class="p">(</span><span class="n">only</span><span class="w"> </span><span class="n">owner</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="p">(</span><span class="n">anyone</span><span class="w"> </span><span class="n">can</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">unlock</span><span class="p">)</span><span class="w">             </span><span class="err">â”‚</span><span class="w"> </span><span class="k">signal</span><span class="p">)</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Purpose</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Mutual</span><span class="w"> </span><span class="n">exclusion</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Resource</span><span class="w"> </span><span class="n">counting</span><span class="p">,</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">signaling</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Recursive</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Possible</span><span class="w"> </span><span class="p">(</span><span class="n">RECURSIVE</span><span class="p">)</span><span class="err">â”‚</span><span class="w"> </span><span class="n">Not</span><span class="w"> </span><span class="n">possible</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">acquisition</span><span class="w">      </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Priority</span><span class="w">         </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">supported</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Typically</span><span class="w"> </span><span class="ow">not</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">inheritance</span><span class="w">      </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">supported</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">cases</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Protect</span><span class="w"> </span><span class="n">shared</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Producer</span><span class="o">-</span><span class="n">consumer</span><span class="p">,</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">pool</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="3-monitor">3. Monitor<a class="header-link" href="#3-monitor" title="Permanent link">&para;</a></h2>
<h3 id="concept_2">Concept<a class="header-link" href="#concept_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="n">Monitor</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Monitor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">High</span><span class="o">-</span><span class="k">level</span><span class="w"> </span><span class="n">abstraction</span><span class="w"> </span><span class="n">encapsulating</span><span class="w"> </span><span class="n">sync</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">Combines</span><span class="w"> </span><span class="n">shared</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">operations</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sync</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="k">Only</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">monitor</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="nc">time</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                   </span><span class="n">Monitor</span><span class="w">                       </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">         </span><span class="n">Shared</span><span class="w"> </span><span class="k">Data</span><span class="w"> </span><span class="p">(</span><span class="n">Private</span><span class="p">)</span><span class="w">           </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">         </span><span class="nc">int</span><span class="w"> </span><span class="n">counter</span><span class="p">;</span><span class="w">                    </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">         </span><span class="nc">int</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">N</span><span class="o">]</span><span class="p">;</span><span class="w">                  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">         </span><span class="k">Condition</span><span class="w"> </span><span class="n">Variables</span><span class="w">             </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">         </span><span class="k">condition</span><span class="w"> </span><span class="n">notEmpty</span><span class="p">;</span><span class="w">             </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">         </span><span class="k">condition</span><span class="w"> </span><span class="n">notFull</span><span class="p">;</span><span class="w">              </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">         </span><span class="n">Procedures</span><span class="w"> </span><span class="p">(</span><span class="k">Public</span><span class="p">)</span><span class="w">             </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">         </span><span class="n">void</span><span class="w"> </span><span class="k">insert</span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">item</span><span class="p">);</span><span class="w">          </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">         </span><span class="nc">int</span><span class="w"> </span><span class="n">remove</span><span class="p">();</span><span class="w">                   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â†</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Queue</span><span class="w">                         </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nl">Features</span><span class="p">:</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Compiler</span><span class="w"> </span><span class="n">automatically</span><span class="w"> </span><span class="n">ensures</span><span class="w"> </span><span class="n">mutual</span><span class="w"> </span><span class="n">exclusion</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Java</span><span class="w"> </span><span class="n">synchronized</span><span class="p">,</span><span class="w"> </span><span class="n">Python</span><span class="w"> </span><span class="n">Lock</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="p">.</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="monitor-in-java">Monitor in Java<a class="header-link" href="#monitor-in-java" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Monitor using Java synchronized</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Counter</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// synchronized method = monitor procedure</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">increment</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">count</span><span class="o">++</span><span class="p">;</span><span class="w">  </span><span class="c1">// Mutual exclusion automatically guaranteed</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">decrement</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getCount</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Usage example</span>
<span class="n">Counter</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Counter</span><span class="p">();</span>

<span class="n">Thread</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">counter</span><span class="p">.</span><span class="na">increment</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>

<span class="n">Thread</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">counter</span><span class="p">.</span><span class="na">increment</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>

<span class="n">t1</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="n">t1</span><span class="p">.</span><span class="na">join</span><span class="p">();</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">counter</span><span class="p">.</span><span class="na">getCount</span><span class="p">());</span><span class="w">  </span><span class="c1">// 2000000</span>
</code></pre></div>

<hr />
<h2 id="4-condition-variable">4. Condition Variable<a class="header-link" href="#4-condition-variable" title="Permanent link">&para;</a></h2>
<h3 id="concept_3">Concept<a class="header-link" href="#concept_3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">               </span><span class="n">Condition</span><span class="w"> </span><span class="n">Variable</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Condition</span><span class="w"> </span><span class="n">Variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tool</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">condition</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                       </span><span class="k">is</span><span class="w"> </span><span class="bp">true</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                     </span><span class="o">=</span><span class="w"> </span><span class="n">Used</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">mutex</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Operations</span><span class="p">:</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">wait</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="n">mutex</span><span class="p">):</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="mf">1.</span><span class="w"> </span><span class="n">Release</span><span class="w"> </span><span class="n">mutex</span><span class="w">                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="mf">2.</span><span class="w"> </span><span class="n">Wait</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">condition</span><span class="w"> </span><span class="n">variable</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="mf">3.</span><span class="w"> </span><span class="n">Re</span><span class="o">-</span><span class="n">acquire</span><span class="w"> </span><span class="n">mutex</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">awakened</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="k">signal</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pthread_cond_signal</span><span class="p">():</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">Wake</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="n">thread</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">broadcast</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pthread_cond_broadcast</span><span class="p">():</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">Wake</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="n">threads</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                   </span><span class="n">Operation</span><span class="w"> </span><span class="n">Flow</span><span class="w">                </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                 </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Thread</span><span class="w"> </span><span class="n">A</span><span class="w">           </span><span class="n">Thread</span><span class="w"> </span><span class="n">B</span><span class="w">                   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">           </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">                 </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span><span class="w">                                   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">condition</span><span class="p">)</span><span class="w">                            </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">      </span><span class="n">wait</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â”€â”€â”</span><span class="w">                           </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="n">release</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                          </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="n">mutex</span><span class="w">    </span><span class="err">â”‚</span><span class="w">  </span><span class="n">lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span><span class="w">             </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="n">wait</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="n">modify</span><span class="w"> </span><span class="n">condition</span><span class="w">        </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w">  </span><span class="k">signal</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w">            </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚</span><span class="w">  </span><span class="n">unlock</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span><span class="w">           </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">re</span><span class="o">-</span><span class="n">acquire</span><span class="w"> </span><span class="n">mutex</span><span class="w">                              </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="k">continue</span><span class="w"> </span><span class="n">critical</span><span class="w"> </span><span class="n">section</span><span class="w">                     </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">unlock</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span><span class="w">                                 </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="using-pthread-condition-variable">Using pthread Condition Variable<a class="header-link" href="#using-pthread-condition-variable" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdbool.h&gt;</span>

<span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">mutex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
<span class="n">pthread_cond_t</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTHREAD_COND_INITIALIZER</span><span class="p">;</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">producer</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>

<span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span>
<span class="w">    </span><span class="n">ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Producer: data ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">);</span><span class="w">  </span><span class="c1">// Wake up consumer</span>
<span class="w">    </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">consumer</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ready</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// Use while loop! (prevent spurious wakeup)</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Consumer: waiting for data...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Consumer: received data = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_t</span><span class="w"> </span><span class="n">prod</span><span class="p">,</span><span class="w"> </span><span class="n">cons</span><span class="p">;</span>

<span class="w">    </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cons</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">consumer</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// Let consumer wait first</span>
<span class="w">    </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prod</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">producer</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">prod</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">cons</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="spurious-wakeup">Spurious Wakeup<a class="header-link" href="#spurious-wakeup" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">               </span><span class="n">Spurious</span><span class="w"> </span><span class="n">Wakeup</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Problem</span><span class="p">:</span><span class="w"> </span><span class="n">Can</span><span class="w"> </span><span class="n">wake</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="k">signal</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Incorrect</span><span class="w"> </span><span class="n">code</span><span class="p">:</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ready</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">                                    </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">      </span><span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Danger</span><span class="o">!</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="p">}</span><span class="w">                                                </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">May</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">condition</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="bp">true</span><span class="w">        </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Correct</span><span class="w"> </span><span class="n">code</span><span class="p">:</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ready</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">                                 </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">      </span><span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span><span class="w">            </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="p">}</span><span class="w">                                                </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Recheck</span><span class="w"> </span><span class="n">condition</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">awakened</span><span class="w">               </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Rule</span><span class="p">:</span><span class="w"> </span><span class="n">Always</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">wait</span><span class="p">()</span><span class="w"> </span><span class="n">inside</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">loop</span><span class="o">!</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="5-classic-synchronization-problems">5. Classic Synchronization Problems<a class="header-link" href="#5-classic-synchronization-problems" title="Permanent link">&para;</a></h2>
<h3 id="producer-consumer-problem-bounded-buffer">Producer-Consumer Problem (Bounded Buffer)<a class="header-link" href="#producer-consumer-problem-bounded-buffer" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Producer-Consumer Problem                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  Setup:                                                 â”‚
â”‚  â€¢ Fixed-size buffer (N items)                          â”‚
â”‚  â€¢ Producer: Add items to buffer                        â”‚
â”‚  â€¢ Consumer: Remove items from buffer                   â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â”‚  Producer â”€â”€â–¶ [  Buffer  ] â”€â”€â–¶ Consumer          â”‚  â”‚
â”‚  â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚  â”‚
â”‚  â”‚            â”‚ ? â”‚ ? â”‚ ? â”‚                          â”‚  â”‚
â”‚  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚  â”‚
â”‚  â”‚            N = 3                                  â”‚  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  Synchronization requirements:                          â”‚
â”‚  1. Producer waits when buffer is full                  â”‚
â”‚  2. Consumer waits when buffer is empty                 â”‚
â”‚  3. Mutual exclusion when accessing buffer              â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;semaphore.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="cp">#define BUFFER_SIZE 5</span>

<span class="kt">int</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
<span class="kt">int</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="n">sem_t</span><span class="w"> </span><span class="n">empty</span><span class="p">;</span><span class="w">  </span><span class="c1">// Number of empty slots (initial: BUFFER_SIZE)</span>
<span class="n">sem_t</span><span class="w"> </span><span class="n">full</span><span class="p">;</span><span class="w">   </span><span class="c1">// Number of full slots (initial: 0)</span>
<span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span>

<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">producer</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">        </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">);</span><span class="w">           </span><span class="c1">// Wait for empty slot</span>
<span class="w">        </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>

<span class="w">        </span><span class="n">buffer</span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">;</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Produce: %d (position %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">);</span>
<span class="w">        </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">;</span>

<span class="w">        </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">full</span><span class="p">);</span><span class="w">            </span><span class="c1">// Increment full slots</span>

<span class="w">        </span><span class="n">usleep</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span><span class="w">  </span><span class="c1">// 0.1s</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">consumer</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">full</span><span class="p">);</span><span class="w">            </span><span class="c1">// Wait for full slot</span>
<span class="w">        </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="n">out</span><span class="p">];</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Consume: %d (position %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">);</span>
<span class="w">        </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">;</span>

<span class="w">        </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">);</span><span class="w">           </span><span class="c1">// Increment empty slots</span>

<span class="w">        </span><span class="n">usleep</span><span class="p">(</span><span class="mi">150000</span><span class="p">);</span><span class="w">  </span><span class="c1">// 0.15s</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_t</span><span class="w"> </span><span class="n">prod</span><span class="p">,</span><span class="w"> </span><span class="n">cons</span><span class="p">;</span>

<span class="w">    </span><span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">full</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prod</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">producer</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cons</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">consumer</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">prod</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">cons</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="readers-writers-problem">Readers-Writers Problem<a class="header-link" href="#readers-writers-problem" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                 </span><span class="nv">Readers</span><span class="o">-</span><span class="nv">Writers</span><span class="w"> </span><span class="nv">Problem</span><span class="w">                  </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                         </span>â”‚
â”‚<span class="w">  </span><span class="nv">Setup</span>:<span class="w">                                                 </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Shared</span><span class="w"> </span><span class="nv">database</span><span class="w">                                      </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Readers</span>:<span class="w"> </span><span class="nv">Only</span><span class="w"> </span><span class="nv">read</span><span class="w"> </span><span class="nv">data</span><span class="w">                              </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Writers</span>:<span class="w"> </span><span class="nv">Modify</span><span class="w"> </span><span class="nv">data</span><span class="w">                                 </span>â”‚
â”‚<span class="w">                                                         </span>â”‚
â”‚<span class="w">  </span><span class="nv">Rules</span>:<span class="w">                                                 </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Multiple</span><span class="w"> </span><span class="nv">readers</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="nv">read</span><span class="w"> </span><span class="nv">simultaneously</span><span class="w">             </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">No</span><span class="w"> </span><span class="nv">access</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nv">writer</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">writing</span><span class="w">                    </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Writer</span><span class="w"> </span><span class="nv">needs</span><span class="w"> </span><span class="nv">exclusive</span><span class="w"> </span><span class="nv">access</span><span class="w">                        </span>â”‚
â”‚<span class="w">                                                         </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">  </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">                                                   </span>â”‚<span class="w">  </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="nv">Reader1</span><span class="w"> </span>â”€â”€<span class="nv">read</span>â”€â”€â”<span class="w">                                </span>â”‚<span class="w">  </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="nv">Reader2</span><span class="w"> </span>â”€â”€<span class="nv">read</span>â”€â”€â”¼â”€â”€â–¶<span class="w"> </span>[<span class="w"> </span><span class="nv">Database</span><span class="w"> </span>]<span class="w">                </span>â”‚<span class="w">  </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="nv">Reader3</span><span class="w"> </span>â”€â”€<span class="nv">read</span>â”€â”€â”˜<span class="w">          </span>â†‘<span class="w">                     </span>â”‚<span class="w">  </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">                             </span>â”‚<span class="w">                     </span>â”‚<span class="w">  </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="nv">Writer</span><span class="w">  </span>â”€â”€â”€â”€â”€â”€â”€â”€<span class="nv">write</span>â”€â”€â”€â”€â”€â”€â”˜<span class="w">                     </span>â”‚<span class="w">  </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">       </span><span class="ss">(</span><span class="nv">exclusive</span><span class="w"> </span><span class="nv">access</span><span class="ss">)</span><span class="w">                          </span>â”‚<span class="w">  </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">                                                   </span>â”‚<span class="w">  </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">  </span>â”‚
â”‚<span class="w">                                                         </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">mutex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
<span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">write_lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">read_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">shared_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">reader</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

<span class="w">    </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="n">read_count</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_lock</span><span class="p">);</span><span class="w">  </span><span class="c1">// First reader blocks writers</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Reading (not critical section, multiple readers allowed)</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Reader %d: data = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">shared_data</span><span class="p">);</span>
<span class="w">    </span><span class="n">usleep</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>

<span class="w">    </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="n">read_count</span><span class="o">--</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_lock</span><span class="p">);</span><span class="w">  </span><span class="c1">// Last reader allows writers</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">writer</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

<span class="w">    </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_lock</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Writing (exclusive access)</span>
<span class="w">    </span><span class="n">shared_data</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Writer %d: changed data to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">shared_data</span><span class="p">);</span>
<span class="w">    </span><span class="n">usleep</span><span class="p">(</span><span class="mi">200000</span><span class="p">);</span>

<span class="w">    </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_lock</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_t</span><span class="w"> </span><span class="n">readers</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">writers</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ids</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">};</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">wids</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">};</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">readers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">reader</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">writers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wids</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">readers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">writers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="dining-philosophers-problem">Dining Philosophers Problem<a class="header-link" href="#dining-philosophers-problem" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">              </span><span class="nv">Dining</span><span class="w"> </span><span class="nv">Philosophers</span><span class="w"> </span><span class="nv">Problem</span><span class="w">                 </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                         </span>â”‚
â”‚<span class="w">  </span><span class="nv">Setup</span>:<span class="w">                                                 </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nv">philosophers</span>,<span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nv">chopsticks</span><span class="w">                         </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Each</span><span class="w"> </span><span class="nv">philosopher</span><span class="w"> </span><span class="nv">either</span><span class="w"> </span><span class="nv">thinks</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">eats</span><span class="w">               </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Need</span><span class="w"> </span><span class="nv">both</span><span class="w"> </span><span class="nv">adjacent</span><span class="w"> </span><span class="nv">chopsticks</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">eat</span><span class="w">                 </span>â”‚
â”‚<span class="w">                                                         </span>â”‚
â”‚<span class="w">           </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">                 </span>â”‚
â”‚<span class="w">           </span>â”‚<span class="w">          </span><span class="nv">P0</span><span class="w">              </span>â”‚<span class="w">                 </span>â”‚
â”‚<span class="w">           </span>â”‚<span class="w">      </span>â—‡<span class="w">       </span>â—‡<span class="w">          </span>â”‚<span class="w">                 </span>â”‚
â”‚<span class="w">           </span>â”‚<span class="w">     </span><span class="nv">C4</span><span class="w">       </span><span class="nv">C0</span><span class="w">          </span>â”‚<span class="w">                 </span>â”‚
â”‚<span class="w">           </span>â”‚<span class="w">                          </span>â”‚<span class="w">                 </span>â”‚
â”‚<span class="w">        </span><span class="nv">P4</span><span class="w"> </span>â—‡<span class="w">                      </span>â—‡<span class="w"> </span><span class="nv">P1</span>â”‚<span class="w">                 </span>â”‚
â”‚<span class="w">           </span>â”‚<span class="w">   </span><span class="nv">C3</span><span class="w">             </span><span class="nv">C1</span><span class="w">     </span>â”‚<span class="w">                 </span>â”‚
â”‚<span class="w">           </span>â”‚<span class="w">                          </span>â”‚<span class="w">                 </span>â”‚
â”‚<span class="w">        </span><span class="nv">P3</span><span class="w"> </span>â—‡â”€â”€â”€â”€â”€â”€<span class="nv">C2</span>â”€â”€â”€â”€â”€â”€â—‡<span class="w"> </span><span class="nv">P2</span><span class="w">       </span>â”‚<span class="w">                 </span>â”‚
â”‚<span class="w">           </span>â”‚<span class="w">                          </span>â”‚<span class="w">                 </span>â”‚
â”‚<span class="w">           </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">                 </span>â”‚
â”‚<span class="w">                                                         </span>â”‚
â”‚<span class="w">  </span><span class="nv">Problem</span>:<span class="w"> </span><span class="nv">Deadlock</span><span class="w"> </span><span class="nv">possible</span><span class="o">!</span><span class="w">                            </span>â”‚
â”‚<span class="w">  </span><span class="k">If</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">philosophers</span><span class="w"> </span><span class="nv">pick</span><span class="w"> </span><span class="nv">up</span><span class="w"> </span><span class="nv">left</span><span class="w"> </span><span class="nv">chopstick</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">no</span><span class="w"> </span><span class="nv">one</span><span class="w"> </span><span class="nv">eats</span>â”‚
â”‚<span class="w">                                                         </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="cp">#define N 5</span>
<span class="cp">#define LEFT(i) (i)</span>
<span class="cp">#define RIGHT(i) ((i + 1) % N)</span>

<span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">chopsticks</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>

<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">philosopher</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Thinking</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Philosopher %d: thinking...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">usleep</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Deadlock prevention: even philosophers pick left first, odd pick right first</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chopsticks</span><span class="p">[</span><span class="n">LEFT</span><span class="p">(</span><span class="n">id</span><span class="p">)]);</span>
<span class="w">            </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chopsticks</span><span class="p">[</span><span class="n">RIGHT</span><span class="p">(</span><span class="n">id</span><span class="p">)]);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chopsticks</span><span class="p">[</span><span class="n">RIGHT</span><span class="p">(</span><span class="n">id</span><span class="p">)]);</span>
<span class="w">            </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chopsticks</span><span class="p">[</span><span class="n">LEFT</span><span class="p">(</span><span class="n">id</span><span class="p">)]);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Eating</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Philosopher %d: eating...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
<span class="w">        </span><span class="n">usleep</span><span class="p">(</span><span class="mi">200000</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Put down chopsticks</span>
<span class="w">        </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chopsticks</span><span class="p">[</span><span class="n">LEFT</span><span class="p">(</span><span class="n">id</span><span class="p">)]);</span>
<span class="w">        </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chopsticks</span><span class="p">[</span><span class="n">RIGHT</span><span class="p">(</span><span class="n">id</span><span class="p">)]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_t</span><span class="w"> </span><span class="n">philosophers</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ids</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chopsticks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">        </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">philosophers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">philosopher</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">philosophers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="6-practice-problems">6. Practice Problems<a class="header-link" href="#6-practice-problems" title="Permanent link">&para;</a></h2>
<h3 id="problem-1-semaphore-value">Problem 1: Semaphore Value<a class="header-link" href="#problem-1-semaphore-value" title="Permanent link">&para;</a></h3>
<p>For a semaphore with initial value 5, what is the final value after performing P, P, V, P, P, P operations in order?</p>
<details>
<summary>Show Answer</summary>

**Operation sequence and value changes:**
- Initial value: 5
- P: 5 - 1 = 4
- P: 4 - 1 = 3
- V: 3 + 1 = 4
- P: 4 - 1 = 3
- P: 3 - 1 = 2
- P: 2 - 1 = 1

**Final value: 1**

</details>

<h3 id="problem-2-producer-consumer">Problem 2: Producer-Consumer<a class="header-link" href="#problem-2-producer-consumer" title="Permanent link">&para;</a></h3>
<p>Explain the roles of the empty and full semaphores in the producer-consumer problem, and why their order is important.</p>
<details>
<summary>Show Answer</summary>

**empty semaphore:**
- Manages number of empty buffer slots
- Initial value: buffer size (N)
- Producer performs P operation (allocate slot)
- Consumer performs V operation (return slot)

**full semaphore:**
- Manages number of filled buffer slots
- Initial value: 0
- Producer performs V operation (notify item added)
- Consumer performs P operation (wait for item)

**Why order is important:**
- Order of semaphore P operation and mutex acquisition
- Wrong order: mutex lock â†’ sem_wait â†’ possible deadlock
- Correct order: sem_wait â†’ mutex lock â†’ prevent deadlock

</details>

<h3 id="problem-3-monitor-implementation">Problem 3: Monitor Implementation<a class="header-link" href="#problem-3-monitor-implementation" title="Permanent link">&para;</a></h3>
<p>Convert the following semaphore code to monitor (condition variable) style.</p>
<div class="highlight"><pre><span></span><code><span class="n">sem_t</span><span class="w"> </span><span class="n">sem</span><span class="p">;</span>
<span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="c1">// Producer</span>
<span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem</span><span class="p">);</span>

<span class="c1">// Consumer</span>
<span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem</span><span class="p">);</span>
</code></pre></div>

<details>
<summary>Show Answer</summary>


<div class="highlight"><pre><span></span><code><span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">mutex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
<span class="n">pthread_cond_t</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTHREAD_COND_INITIALIZER</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="c1">// Producer</span>
<span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="n">pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">);</span>
<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>

<span class="c1">// Consumer</span>
<span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">count</span><span class="o">--</span><span class="p">;</span>
<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</code></pre></div>



</details>

<h3 id="problem-4-dining-philosophers-deadlock">Problem 4: Dining Philosophers Deadlock<a class="header-link" href="#problem-4-dining-philosophers-deadlock" title="Permanent link">&para;</a></h3>
<p>Explain a deadlock scenario in the dining philosophers problem and propose three solution methods.</p>
<details>
<summary>Show Answer</summary>

**Deadlock scenario:**
If all philosophers pick up their left chopstick simultaneously:
- P0: holds C0, waits for C4
- P1: holds C1, waits for C0
- P2: holds C2, waits for C1
- P3: holds C3, waits for C2
- P4: holds C4, waits for C3
â†’ Circular wait â†’ Deadlock!

**Solution methods:**

1. **Asymmetric lock acquisition:**
   - Even philosophers: pick left first
   - Odd philosophers: pick right first
   - Breaks circular wait

2. **Simultaneous chopstick acquisition:**
   - Pick up both chopsticks only when both are available
   - Protected by central mutex

3. **Limit to N-1 philosophers:**
   - Use semaphore to limit maximum 4 at table
   - At least one can use both chopsticks

</details>

<h3 id="problem-5-condition-variable-usage">Problem 5: Condition Variable Usage<a class="header-link" href="#problem-5-condition-variable-usage" title="Permanent link">&para;</a></h3>
<p>Explain why wait() calls on condition variables should be inside a while loop.</p>
<details>
<summary>Show Answer</summary>

**Reason 1: Spurious Wakeup**
- Can wake up without signal from the system
- Will proceed in incorrect state without rechecking condition

**Reason 2: Multiple Waiters**
- Multiple threads may be waiting on same condition variable
- After broadcast, all wake up but only one may satisfy condition
- Others must wait again

**Reason 3: Condition Change**
- Condition may become false again after waking up
- Another thread may use the resource first

**Correct pattern:**

<div class="highlight"><pre><span></span><code><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// Condition is guaranteed to be true</span>
<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</code></pre></div>



</details>

<hr />
<h2 id="next-steps">Next Steps<a class="header-link" href="#next-steps" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="./09_Deadlock.md">09_Deadlock.md</a> - Deadlock conditions, prevention, avoidance, detection</li>
</ul>
<hr />
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://pages.cs.wisc.edu/~remzi/OSTEP/threads-cv.pdf">OSTEP - Condition Variables</a></li>
<li><a href="https://computing.llnl.gov/tutorials/pthreads/">POSIX Threads Programming</a></li>
<li><a href="https://jcip.net/">Java Concurrency in Practice</a></li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/OS_Theory/07_Synchronization_Basics.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Synchronization Basics</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/OS_Theory/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/OS_Theory/09_Deadlock.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Deadlock</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}