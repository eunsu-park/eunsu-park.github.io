{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6. Magnetic Mirrors and Adiabatic Invariants - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">üíª</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        ÌïúÍµ≠Ïñ¥
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">‚òÄÔ∏è</span>
                    <span class="theme-icon dark">üåô</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Plasma_Physics/">Plasma Physics</a>
    <span class="separator">/</span>
    <span class="current">6. Magnetic Mirrors and Adiabatic Invariants</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>6. Magnetic Mirrors and Adiabatic Invariants</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Plasma_Physics/05_Single_Particle_Motion_II.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">5. Single Particle Motion II</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Plasma_Physics/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Plasma_Physics/07_Vlasov_Equation.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">7. Vlasov Equation</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#1-magnetic-mirror-force">1. Magnetic Mirror Force</a><ul>
<li><a href="#11-converging-field-lines">1.1 Converging Field Lines</a></li>
<li><a href="#12-derivation-of-mirror-force">1.2 Derivation of Mirror Force</a></li>
<li><a href="#13-physical-interpretation">1.3 Physical Interpretation</a></li>
</ul>
</li>
<li><a href="#2-first-adiabatic-invariant-magnetic-moment">2. First Adiabatic Invariant: Magnetic Moment Œº</a><ul>
<li><a href="#21-conservation-proof-via-action-angle-variables">2.1 Conservation Proof via Action-Angle Variables</a></li>
<li><a href="#22-physical-meaning-flux-conservation">2.2 Physical Meaning: Flux Conservation</a></li>
<li><a href="#23-breakdown-of-adiabaticity">2.3 Breakdown of Adiabaticity</a></li>
</ul>
</li>
<li><a href="#3-magnetic-mirror-and-bottle">3. Magnetic Mirror and Bottle</a><ul>
<li><a href="#31-mirror-geometry">3.1 Mirror Geometry</a></li>
<li><a href="#32-pitch-angle-and-loss-cone">3.2 Pitch Angle and Loss Cone</a></li>
<li><a href="#33-loss-cone-solid-angle">3.3 Loss Cone Solid Angle</a></li>
<li><a href="#34-magnetic-bottle">3.4 Magnetic Bottle</a></li>
</ul>
</li>
<li><a href="#4-bounce-motion">4. Bounce Motion</a><ul>
<li><a href="#41-bounce-trajectory">4.1 Bounce Trajectory</a></li>
<li><a href="#42-bounce-frequency">4.2 Bounce Frequency</a></li>
<li><a href="#43-bounce-averaged-drift">4.3 Bounce-Averaged Drift</a></li>
</ul>
</li>
<li><a href="#5-second-and-third-adiabatic-invariants">5. Second and Third Adiabatic Invariants</a><ul>
<li><a href="#51-hierarchy-of-timescales">5.1 Hierarchy of Timescales</a></li>
<li><a href="#52-second-adiabatic-invariant-j">5.2 Second Adiabatic Invariant: J</a></li>
<li><a href="#53-physical-meaning-of-j">5.3 Physical Meaning of J</a></li>
<li><a href="#54-third-adiabatic-invariant">5.4 Third Adiabatic Invariant: Œ¶</a></li>
<li><a href="#55-summary-of-adiabatic-invariants">5.5 Summary of Adiabatic Invariants</a></li>
</ul>
</li>
<li><a href="#6-tokamak-orbits">6. Tokamak Orbits</a><ul>
<li><a href="#61-tokamak-geometry-review">6.1 Tokamak Geometry Review</a></li>
<li><a href="#62-trapped-and-passing-particles">6.2 Trapped and Passing Particles</a></li>
<li><a href="#63-banana-orbits">6.3 Banana Orbits</a></li>
<li><a href="#64-passing-particles">6.4 Passing Particles</a></li>
<li><a href="#65-neoclassical-transport">6.5 Neoclassical Transport</a></li>
</ul>
</li>
<li><a href="#7-van-allen-radiation-belts">7. Van Allen Radiation Belts</a><ul>
<li><a href="#71-earths-magnetosphere-as-a-magnetic-mirror">7.1 Earth's Magnetosphere as a Magnetic Mirror</a></li>
<li><a href="#72-two-belt-structure">7.2 Two-Belt Structure</a></li>
<li><a href="#73-particle-motion-in-dipole-field">7.3 Particle Motion in Dipole Field</a></li>
<li><a href="#74-loss-mechanisms">7.4 Loss Mechanisms</a></li>
</ul>
</li>
<li><a href="#8-python-implementations">8. Python Implementations</a><ul>
<li><a href="#81-magnetic-mirror-simulation">8.1 Magnetic Mirror Simulation</a></li>
<li><a href="#82-loss-cone-visualization">8.2 Loss Cone Visualization</a></li>
<li><a href="#83-banana-orbit-simulation-simplified-tokamak">8.3 Banana Orbit Simulation (Simplified Tokamak)</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
<li><a href="#practice-problems">Practice Problems</a><ul>
<li><a href="#problem-1-mirror-confinement-time">Problem 1: Mirror Confinement Time</a></li>
<li><a href="#problem-2-conservation-of-in-a-slowly-varying-field">Problem 2: Conservation of Œº in a Slowly Varying Field</a></li>
<li><a href="#problem-3-bounce-frequency-in-a-parabolic-mirror">Problem 3: Bounce Frequency in a Parabolic Mirror</a></li>
<li><a href="#problem-4-tokamak-banana-width">Problem 4: Tokamak Banana Width</a></li>
<li><a href="#problem-5-second-adiabatic-invariant-in-a-dipole-field">Problem 5: Second Adiabatic Invariant in a Dipole Field</a></li>
</ul>
</li>
<li><a href="#navigation">Navigation</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="6-magnetic-mirrors-and-adiabatic-invariants">6. Magnetic Mirrors and Adiabatic Invariants<a class="header-link" href="#6-magnetic-mirrors-and-adiabatic-invariants" title="Permanent link">&para;</a></h1>
<h2 id="learning-objectives">Learning Objectives<a class="header-link" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<ul>
<li>Understand the magnetic mirror force and its role in particle confinement</li>
<li>Derive the first adiabatic invariant (magnetic moment) and prove its conservation</li>
<li>Analyze magnetic mirror geometry, loss cone, and trapped vs. passing particles</li>
<li>Explore the hierarchy of adiabatic invariants and their associated timescales</li>
<li>Study tokamak orbits (banana orbits and passing particles)</li>
<li>Simulate magnetic mirror confinement and loss cone dynamics using Python</li>
</ul>
<h2 id="1-magnetic-mirror-force">1. Magnetic Mirror Force<a class="header-link" href="#1-magnetic-mirror-force" title="Permanent link">&para;</a></h2>
<h3 id="11-converging-field-lines">1.1 Converging Field Lines<a class="header-link" href="#11-converging-field-lines" title="Permanent link">&para;</a></h3>
<p>In a region where magnetic field lines converge (field strength increases), a gyrating particle experiences a force opposing the motion toward higher field regions. This is the <strong>magnetic mirror force</strong>.</p>
<p>Consider a particle moving along a field line where $B = B(s)$ varies with arc length $s$:</p>
<div class="highlight"><pre><span></span><code>    Weak field              Strong field
    B_low                   B_high
      ‚Üì                       ‚Üì
      |                       |||
      |        particle       |||
      |  ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ moving ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí   |||
      |          ‚Üí            |||
      |                       |||

    Large r_L              Small r_L
    (gyro-radius)          (gyro-radius)
</code></pre></div>

<p>The particle's perpendicular velocity component gyrates with radius $r_L = mv_\perp/(|q|B)$. As $B$ increases, $r_L$ decreases, but the perpendicular kinetic energy changes due to the work done by the Lorentz force.</p>
<h3 id="12-derivation-of-mirror-force">1.2 Derivation of Mirror Force<a class="header-link" href="#12-derivation-of-mirror-force" title="Permanent link">&para;</a></h3>
<p>The magnetic moment is defined as:</p>
<p>$$
\mu = \frac{mv_\perp^2}{2B} = \frac{W_\perp}{B}
$$</p>
<p>where $W_\perp = \frac{1}{2}mv_\perp^2$ is the perpendicular kinetic energy.</p>
<p>For slowly varying fields (adiabatic limit), $\mu$ is conserved (we'll prove this rigorously in Section 2). Assuming $\mu$ = constant:</p>
<p>$$
W_\perp = \mu B = \text{constant} \times B
$$</p>
<p>The total energy is conserved:</p>
<p>$$
W = W_\perp + W_\parallel = \frac{1}{2}m(v_\perp^2 + v_\parallel^2) = \text{constant}
$$</p>
<p>Therefore:</p>
<p>$$
\frac{dW_\parallel}{ds} = -\frac{dW_\perp}{ds} = -\mu\frac{dB}{ds}
$$</p>
<p>The parallel force is:</p>
<p>$$
F_\parallel = \frac{dW_\parallel}{ds} = -\mu\frac{dB}{ds} = -\mu\nabla_\parallel B
$$</p>
<p><strong>This is the magnetic mirror force</strong>: it opposes motion toward regions of higher $B$.</p>
<h3 id="13-physical-interpretation">1.3 Physical Interpretation<a class="header-link" href="#13-physical-interpretation" title="Permanent link">&para;</a></h3>
<p>The mirror force arises because the Lorentz force $\mathbf{F} = q\mathbf{v}\times\mathbf{B}$ has a component along the field line when $\mathbf{B}$ is non-uniform. Consider a particle gyrating in a converging field:</p>
<div class="highlight"><pre><span></span><code>    Top of gyro-orbit (moving toward high B)
         ‚Üë v_perp
         |
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ B field line
         |
         ‚Üì Lorentz force has component opposing motion

    Bottom of gyro-orbit (moving toward low B)
         |
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ B field line
         ‚Üì v_perp
         ‚Üë Lorentz force has component aiding motion

    Net effect: force opposing motion toward high B
</code></pre></div>

<p>Averaging over a gyroperiod gives the mirror force $F_\parallel = -\mu\nabla_\parallel B$.</p>
<h2 id="2-first-adiabatic-invariant-magnetic-moment">2. First Adiabatic Invariant: Magnetic Moment Œº<a class="header-link" href="#2-first-adiabatic-invariant-magnetic-moment" title="Permanent link">&para;</a></h2>
<h3 id="21-conservation-proof-via-action-angle-variables">2.1 Conservation Proof via Action-Angle Variables<a class="header-link" href="#21-conservation-proof-via-action-angle-variables" title="Permanent link">&para;</a></h3>
<p>The magnetic moment $\mu$ is the first adiabatic invariant. To prove its conservation, we use the action-angle formalism from classical mechanics.</p>
<p>The action associated with gyration is:</p>
<p>$$
J_\perp = \oint p_\perp \, dq_\perp
$$</p>
<p>where the integral is over one gyroperiod. For circular motion in a magnetic field:</p>
<p>$$
J_\perp = m v_\perp \cdot 2\pi r_L = m v_\perp \cdot 2\pi \frac{mv_\perp}{|q|B} = \frac{2\pi m^2 v_\perp^2}{|q|B}
$$</p>
<p>The adiabatic invariant is:</p>
<p>$$
I = \frac{J_\perp}{2\pi} = \frac{m^2 v_\perp^2}{|q|B} = \frac{2m}{|q|}\frac{mv_\perp^2}{2B} = \frac{2m}{|q|}\mu
$$</p>
<p>Thus, $\mu$ is conserved when the field varies slowly compared to the gyroperiod:</p>
<p>$$
\frac{1}{\omega_c}\frac{dB}{dt} \ll B
$$</p>
<p>This is the <strong>adiabatic condition</strong> or <strong>slow variation condition</strong>.</p>
<h3 id="22-physical-meaning-flux-conservation">2.2 Physical Meaning: Flux Conservation<a class="header-link" href="#22-physical-meaning-flux-conservation" title="Permanent link">&para;</a></h3>
<p>The magnetic moment can also be interpreted as the magnetic flux through the gyro-orbit:</p>
<p>$$
\Phi_\text{gyro} = \pi r_L^2 B = \pi \left(\frac{mv_\perp}{|q|B}\right)^2 B = \frac{\pi m^2 v_\perp^2}{q^2 B}
$$</p>
<p>This is proportional to $\mu$:</p>
<p>$$
\Phi_\text{gyro} = \frac{\pi m^2 v_\perp^2}{q^2 B} = \frac{\pi m}{q^2} \cdot \frac{mv_\perp^2}{B} = \frac{2\pi m}{q^2}\mu
$$</p>
<p><strong>Conservation of $\mu$ means the magnetic flux through the gyro-orbit is conserved</strong> (for slowly varying fields).</p>
<h3 id="23-breakdown-of-adiabaticity">2.3 Breakdown of Adiabaticity<a class="header-link" href="#23-breakdown-of-adiabaticity" title="Permanent link">&para;</a></h3>
<p>The adiabatic invariance breaks down when:</p>
<ol>
<li><strong>Rapid field variation</strong>: $\frac{1}{\omega_c}\frac{dB}{dt} \sim B$ (comparable to gyroperiod)</li>
<li><strong>Strong gradients</strong>: $r_L |\nabla B| / B \sim 1$ (gradient scale comparable to gyro-radius)</li>
<li><strong>Resonances</strong>: External perturbations at frequency $\omega \approx n\omega_c$ (gyro-resonance)</li>
</ol>
<p>Example: In magnetic reconnection regions, $B$ can change rapidly, violating adiabaticity and allowing particles to change $\mu$.</p>
<h2 id="3-magnetic-mirror-and-bottle">3. Magnetic Mirror and Bottle<a class="header-link" href="#3-magnetic-mirror-and-bottle" title="Permanent link">&para;</a></h2>
<h3 id="31-mirror-geometry">3.1 Mirror Geometry<a class="header-link" href="#31-mirror-geometry" title="Permanent link">&para;</a></h3>
<p>A magnetic mirror consists of two regions of strong field (mirrors) separated by a weak field region:</p>
<div class="highlight"><pre><span></span><code>    Mirror 1              Midplane           Mirror 2
    B_max                   B_min             B_max
      |||                     |                 |||
      |||                     |                 |||
      ||| ‚Üê‚îÄ‚îÄ‚îÄ particle ‚îÄ‚îÄ‚îÄ‚Üí  |  ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí |||
      |||      trapped        |                 |||
      |||                     |                 |||
       ‚Üë                      ‚Üë                  ‚Üë
    Reflection            Equator          Reflection
    point                                   point
</code></pre></div>

<p>The mirror ratio is:</p>
<p>$$
R = \frac{B_{\text{max}}}{B_{\text{min}}}
$$</p>
<h3 id="32-pitch-angle-and-loss-cone">3.2 Pitch Angle and Loss Cone<a class="header-link" href="#32-pitch-angle-and-loss-cone" title="Permanent link">&para;</a></h3>
<p>The pitch angle $\alpha$ is the angle between the velocity and the magnetic field:</p>
<p>$$
\alpha = \arctan\left(\frac{v_\perp}{v_\parallel}\right)
$$</p>
<p>At the midplane (where $B = B_0 = B_{\text{min}}$), the pitch angle is $\alpha_0$:</p>
<p>$$
\tan\alpha_0 = \frac{v_{\perp,0}}{v_{\parallel,0}}
$$</p>
<p>Using conservation of $\mu$ and total energy:</p>
<p>$$
\mu = \frac{mv_\perp^2}{2B} = \text{constant}
$$</p>
<p>$$
v^2 = v_\perp^2 + v_\parallel^2 = \text{constant}
$$</p>
<p>At the mirror point (where $v_\parallel = 0$), $v_\perp = v$ and $B = B_{\text{mirror}}$:</p>
<p>$$
\frac{mv^2}{2B_{\text{mirror}}} = \frac{mv_{\perp,0}^2}{2B_0}
$$</p>
<p>Therefore:</p>
<p>$$
\frac{v_\perp^2}{v^2}\bigg|_{\text{mirror}} = 1 = \frac{v_{\perp,0}^2}{v^2} \cdot \frac{B_{\text{mirror}}}{B_0}
$$</p>
<p>Since $v_{\perp,0}^2/v^2 = \sin^2\alpha_0$:</p>
<p>$$
\sin^2\alpha_0 = \frac{B_0}{B_{\text{mirror}}}
$$</p>
<p>For the particle to be <strong>trapped</strong> (reflected before reaching $B_{\text{max}}$):</p>
<p>$$
\sin^2\alpha_0 > \frac{B_0}{B_{\text{max}}} = \frac{1}{R}
$$</p>
<p>Or equivalently:</p>
<p>$$
\boxed{\alpha_0 > \alpha_c = \arcsin\left(\frac{1}{\sqrt{R}}\right)}
$$</p>
<p>This defines the <strong>loss cone</strong>: particles with $\alpha_0 < \alpha_c$ are not trapped and escape.</p>
<h3 id="33-loss-cone-solid-angle">3.3 Loss Cone Solid Angle<a class="header-link" href="#33-loss-cone-solid-angle" title="Permanent link">&para;</a></h3>
<p>The loss cone in velocity space is a cone around the $v_\parallel$ axis:</p>
<div class="highlight"><pre><span></span><code>    Velocity space

         v_parallel
            ‚Üë
            |       Passing particles
            |      (escape)
            |     /
            |    / Œ±_c (loss cone angle)
            |   /
            |  /_______________
            | /               /
            |/_______________/ ‚Üê Loss cone
           /|
          / |
         /  |
        /   |
    v_perp  | Trapped particles
            | (confined)
</code></pre></div>

<p>The solid angle of the loss cone is:</p>
<p>$$
\Delta\Omega = 2\pi(1 - \cos\alpha_c) = 2\pi\left(1 - \sqrt{1 - \frac{1}{R}}\right)
$$</p>
<p>For large mirror ratio $R \gg 1$:</p>
<p>$$
\Delta\Omega \approx \frac{\pi}{R}
$$</p>
<p>The fraction of particles in the loss cone (assuming isotropic distribution):</p>
<p>$$
f_{\text{loss}} = \frac{\Delta\Omega}{4\pi} \approx \frac{1}{4R}
$$</p>
<h3 id="34-magnetic-bottle">3.4 Magnetic Bottle<a class="header-link" href="#34-magnetic-bottle" title="Permanent link">&para;</a></h3>
<p>A <strong>magnetic bottle</strong> is a mirror configuration with closed field lines, providing confinement in all directions perpendicular to the field. Examples:
- Simple mirror devices
- Biconic cusp
- Minimum-B configurations (quadrupole fields)</p>
<p>The main loss mechanism is:
1. <strong>Scattering into loss cone</strong>: Collisions change pitch angle, scattering trapped particles into the loss cone.
2. <strong>End losses</strong>: Particles in the loss cone escape through the mirror throats.</p>
<p>The confinement time is:</p>
<p>$$
\tau_{\text{conf}} \sim \frac{R}{\nu_c}\frac{1}{f_{\text{loss}}}
$$</p>
<p>where $\nu_c$ is the collision frequency.</p>
<h2 id="4-bounce-motion">4. Bounce Motion<a class="header-link" href="#4-bounce-motion" title="Permanent link">&para;</a></h2>
<h3 id="41-bounce-trajectory">4.1 Bounce Trajectory<a class="header-link" href="#41-bounce-trajectory" title="Permanent link">&para;</a></h3>
<p>A trapped particle bounces between the two mirror points, oscillating in the parallel direction while drifting perpendicular to $\mathbf{B}$ (from grad-B and curvature drifts).</p>
<p>The parallel velocity is:</p>
<p>$$
v_\parallel = \pm\sqrt{v^2 - v_\perp^2} = \pm v\sqrt{1 - \frac{\mu B}{W}}
$$</p>
<p>where the $\pm$ depends on direction of motion. At the mirror point, $v_\parallel = 0$, so:</p>
<p>$$
B_{\text{mirror}} = \frac{W}{\mu} = \frac{mv^2}{2\mu}
$$</p>
<h3 id="42-bounce-frequency">4.2 Bounce Frequency<a class="header-link" href="#42-bounce-frequency" title="Permanent link">&para;</a></h3>
<p>The bounce period is:</p>
<p>$$
\tau_b = 2\int_0^{s_{\text{mirror}}} \frac{ds}{v_\parallel(s)}
$$</p>
<p>where $s$ is arc length along the field line and $s_{\text{mirror}}$ is the distance to the mirror point.</p>
<p>For a parabolic mirror with $B(z) = B_0(1 + z^2/L^2)$:</p>
<p>$$
\tau_b \approx \frac{4L}{v_\parallel}
$$</p>
<p>The bounce frequency is:</p>
<p>$$
\omega_b = \frac{2\pi}{\tau_b} \approx \frac{\pi v_\parallel}{2L}
$$</p>
<p>For typical parameters:
- $v_\parallel \sim 10^5$ m/s
- $L \sim 10$ m (mirror length)
- $\omega_b \sim 10^4$ rad/s</p>
<p>This is much slower than the gyrofrequency $\omega_c \sim 10^8$ rad/s.</p>
<h3 id="43-bounce-averaged-drift">4.3 Bounce-Averaged Drift<a class="header-link" href="#43-bounce-averaged-drift" title="Permanent link">&para;</a></h3>
<p>The grad-B and curvature drifts vary along the field line. For long-term behavior, we average over a bounce period:</p>
<p>$$
\langle\mathbf{v}_D\rangle_b = \frac{1}{\tau_b}\int_0^{\tau_b} \mathbf{v}_D(s(t)) \, dt
$$</p>
<p>This bounce-averaged drift determines the slow evolution of the particle orbit.</p>
<h2 id="5-second-and-third-adiabatic-invariants">5. Second and Third Adiabatic Invariants<a class="header-link" href="#5-second-and-third-adiabatic-invariants" title="Permanent link">&para;</a></h2>
<h3 id="51-hierarchy-of-timescales">5.1 Hierarchy of Timescales<a class="header-link" href="#51-hierarchy-of-timescales" title="Permanent link">&para;</a></h3>
<p>There are three natural timescales in magnetized plasmas:</p>
<p>$$
\omega_c \gg \omega_b \gg \omega_d
$$</p>
<p>where:
- $\omega_c = |q|B/m$: gyrofrequency
- $\omega_b \sim v_\parallel/L$: bounce frequency
- $\omega_d \sim v_D/R$: drift frequency</p>
<p>Each timescale is associated with an adiabatic invariant.</p>
<h3 id="52-second-adiabatic-invariant-j">5.2 Second Adiabatic Invariant: J<a class="header-link" href="#52-second-adiabatic-invariant-j" title="Permanent link">&para;</a></h3>
<p>The second invariant is associated with bounce motion:</p>
<p>$$
\boxed{J = \oint m v_\parallel \, ds}
$$</p>
<p>where the integral is along the field line between the two mirror points. This is the action for bounce motion.</p>
<p><strong>Conservation</strong>: $J$ is conserved when the magnetic field varies slowly compared to the bounce period:</p>
<p>$$
\frac{1}{\omega_b}\frac{\partial B}{\partial t} \ll B
$$</p>
<h3 id="53-physical-meaning-of-j">5.3 Physical Meaning of J<a class="header-link" href="#53-physical-meaning-of-j" title="Permanent link">&para;</a></h3>
<p>$J$ is related to the area enclosed in $(s, p_\parallel)$ phase space:</p>
<div class="highlight"><pre><span></span><code>    p_parallel = m v_parallel
         ‚Üë
         |
         |    /\
         |   /  \    Particle bounces
         |  /    \   between mirror points
         | /      \
         |/        \___
        ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí s (position along field line)
         0       s_mirror

    Area enclosed = J
</code></pre></div>

<p>Conservation of $J$ means particles remain on the same bounce orbit if the field changes slowly.</p>
<h3 id="54-third-adiabatic-invariant">5.4 Third Adiabatic Invariant: Œ¶<a class="header-link" href="#54-third-adiabatic-invariant" title="Permanent link">&para;</a></h3>
<p>The third invariant is associated with drift motion around the axis:</p>
<p>$$
\boxed{\Phi = \oint \mathbf{A}\cdot d\mathbf{l}}
$$</p>
<p>where the integral is around the drift orbit and $\mathbf{A}$ is the vector potential ($\mathbf{B} = \nabla\times\mathbf{A}$).</p>
<p>Using Stokes' theorem:</p>
<p>$$
\Phi = \int_S (\nabla\times\mathbf{A})\cdot d\mathbf{S} = \int_S \mathbf{B}\cdot d\mathbf{S}
$$</p>
<p><strong>$\Phi$ is the magnetic flux enclosed by the drift orbit.</strong></p>
<p><strong>Conservation</strong>: $\Phi$ is conserved when the magnetic field varies slowly compared to the drift period:</p>
<p>$$
\frac{1}{\omega_d}\frac{\partial B}{\partial t} \ll B
$$</p>
<h3 id="55-summary-of-adiabatic-invariants">5.5 Summary of Adiabatic Invariants<a class="header-link" href="#55-summary-of-adiabatic-invariants" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Invariant</th>
<th>Formula</th>
<th>Associated Motion</th>
<th>Timescale</th>
<th>Conservation Condition</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Œº</strong></td>
<td>$\frac{mv_\perp^2}{2B}$</td>
<td>Gyration</td>
<td>$\omega_c^{-1}$</td>
<td>$\tau_c \ll \tau_{\text{var}}$</td>
</tr>
<tr>
<td><strong>J</strong></td>
<td>$\oint mv_\parallel ds$</td>
<td>Bounce</td>
<td>$\omega_b^{-1}$</td>
<td>$\tau_b \ll \tau_{\text{var}}$</td>
</tr>
<tr>
<td><strong>Œ¶</strong></td>
<td>$\oint \mathbf{A}\cdot d\mathbf{l}$</td>
<td>Drift</td>
<td>$\omega_d^{-1}$</td>
<td>$\tau_d \ll \tau_{\text{var}}$</td>
</tr>
</tbody>
</table>
<p>where $\tau_{\text{var}}$ is the characteristic time for field variation.</p>
<p><strong>Key principle</strong>: Each invariant is conserved when the field varies slowly compared to the associated motion period.</p>
<h2 id="6-tokamak-orbits">6. Tokamak Orbits<a class="header-link" href="#6-tokamak-orbits" title="Permanent link">&para;</a></h2>
<h3 id="61-tokamak-geometry-review">6.1 Tokamak Geometry Review<a class="header-link" href="#61-tokamak-geometry-review" title="Permanent link">&para;</a></h3>
<p>A tokamak has:
- <strong>Toroidal field</strong> $B_\phi \propto 1/R$ (decreases with major radius)
- <strong>Poloidal field</strong> $B_\theta$ (from plasma current)
- <strong>Total field</strong>: $\mathbf{B} = B_\phi\hat{\phi} + B_\theta\hat{\theta}$</p>
<p>The field is stronger on the inboard side (small $R$) than the outboard side (large $R$):</p>
<div class="highlight"><pre><span></span><code>    Top view of tokamak

         Weak field
         (outboard)
             |
        ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       /     |     \
      /      o      \   ‚Üê Plasma
     ‚îÇ  (magnetic   ‚îÇ
     ‚îÇ    axis)     ‚îÇ
      \            /
       \          /
        ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
             |
         Strong field
         (inboard)
</code></pre></div>

<p>This creates a magnetic mirror effect in the toroidal direction.</p>
<h3 id="62-trapped-and-passing-particles">6.2 Trapped and Passing Particles<a class="header-link" href="#62-trapped-and-passing-particles" title="Permanent link">&para;</a></h3>
<p>Due to the $1/R$ variation of $B_\phi$, particles can be:</p>
<ol>
<li><strong>Passing particles</strong>: Complete full poloidal circuits around the torus.</li>
<li><strong>Trapped particles</strong>: Reflect between the inboard side (high $B$) and cannot complete the circuit.</li>
</ol>
<p>The trapping condition is similar to a magnetic mirror. At the outboard midplane ($\theta = 0$, $R = R_0 + a$):</p>
<p>$$
\sin^2\alpha_0 < \frac{B_{\text{out}}}{B_{\text{in}}} \approx \frac{R_{\text{in}}}{R_{\text{out}}} = \frac{R_0 - a}{R_0 + a} \approx 1 - \frac{2a}{R_0} = 1 - 2\epsilon
$$</p>
<p>where $\epsilon = a/R_0$ is the inverse aspect ratio.</p>
<p>For small $\epsilon$:</p>
<p>$$
\alpha_c \approx \sqrt{2\epsilon}
$$</p>
<p>The fraction of trapped particles is:</p>
<p>$$
f_{\text{trap}} \approx \sqrt{2\epsilon} \approx \sqrt{\frac{a}{R_0}}
$$</p>
<p>For typical tokamaks with $\epsilon \sim 0.3$:</p>
<p>$$
f_{\text{trap}} \approx 0.77 \approx 77\%
$$</p>
<h3 id="63-banana-orbits">6.3 Banana Orbits<a class="header-link" href="#63-banana-orbits" title="Permanent link">&para;</a></h3>
<p>Trapped particles drift vertically (grad-B + curvature drift) and trace out "banana-shaped" orbits in the poloidal plane:</p>
<div class="highlight"><pre><span></span><code>    Poloidal cross-section

         Top
          |
      ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ
     /    |    \
    ‚îÇ  /‚îÄ‚îÄ‚î¥‚îÄ‚îÄ\  ‚îÇ  ‚Üê Banana orbit
    ‚îÇ ‚îÇ       ‚îÇ ‚îÇ     (trapped particle)
    ‚îÇ  \‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ/  ‚îÇ
     \         /
      ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          |
        Bottom

    Passing orbit: complete circle around
    Banana orbit: reflected, drift creates banana shape
</code></pre></div>

<p>The banana width (radial excursion) is:</p>
<p>$$
\Delta r_b \sim q\rho_i\sqrt{\epsilon}
$$</p>
<p>where:
- $q = rB_\phi/(R_0 B_\theta)$ is the safety factor
- $\rho_i = m_i v_{th,i}/(eB)$ is the ion Larmor radius
- $\epsilon = a/R_0$</p>
<p><strong>Importance</strong>: Banana orbits reduce confinement by:
1. Increasing effective step size for radial transport
2. Creating neoclassical transport (collisional detrapping)</p>
<h3 id="64-passing-particles">6.4 Passing Particles<a class="header-link" href="#64-passing-particles" title="Permanent link">&para;</a></h3>
<p>Passing particles have large $v_\parallel$ and complete full poloidal circuits. They also drift vertically but remain on closed flux surfaces (in ideal axisymmetric geometry).</p>
<p>The orbit shift from the flux surface is:</p>
<p>$$
\Delta r_{\text{pass}} \sim q\rho_i
$$</p>
<p>Much smaller than the banana width.</p>
<h3 id="65-neoclassical-transport">6.5 Neoclassical Transport<a class="header-link" href="#65-neoclassical-transport" title="Permanent link">&para;</a></h3>
<p>The combination of trapped particle orbits and collisions leads to <strong>neoclassical transport</strong>, which exceeds classical (collision-based) transport:</p>
<p>$$
D_{\text{neo}} = \frac{q^2\rho_i^2}{\tau_e}\epsilon^{3/2}
$$</p>
<p>where $\tau_e$ is the electron collision time.</p>
<p>This is larger than classical diffusion $D_{\text{class}} \sim \rho_i^2/\tau_e$ by a factor $\sim q^2\epsilon^{3/2}$.</p>
<h2 id="7-van-allen-radiation-belts">7. Van Allen Radiation Belts<a class="header-link" href="#7-van-allen-radiation-belts" title="Permanent link">&para;</a></h2>
<h3 id="71-earths-magnetosphere-as-a-magnetic-mirror">7.1 Earth's Magnetosphere as a Magnetic Mirror<a class="header-link" href="#71-earths-magnetosphere-as-a-magnetic-mirror" title="Permanent link">&para;</a></h3>
<p>Earth's dipole magnetic field forms a natural magnetic bottle:</p>
<div class="highlight"><pre><span></span><code>    Solar wind
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí

         Magnetopause
           ____
          /    \
         /      \
    ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ Earth ‚îú‚îÄ‚îÄ‚îÄ‚îÄ  Equatorial plane
         \      /
          \____/

    Magnetic field lines:
    <span class="k">-</span> Compressed on dayside (solar wind pressure)
    <span class="k">-</span> Extended on nightside (magnetotail)
    <span class="k">-</span> Particles trapped on closed field lines
</code></pre></div>

<p>Charged particles (electrons and protons from solar wind and cosmic rays) are trapped in the dipole field, forming the Van Allen radiation belts.</p>
<h3 id="72-two-belt-structure">7.2 Two-Belt Structure<a class="header-link" href="#72-two-belt-structure" title="Permanent link">&para;</a></h3>
<p>There are two main belts:</p>
<ol>
<li><strong>Inner belt</strong> ($1.2 - 2$ Earth radii):</li>
<li>Mostly high-energy protons (10-100 MeV)</li>
<li>Source: cosmic ray albedo neutron decay (CRAND)</li>
<li>
<p>Relatively stable</p>
</li>
<li>
<p><strong>Outer belt</strong> ($4 - 6$ Earth radii):</p>
</li>
<li>Mostly electrons (0.1-10 MeV)</li>
<li>Source: solar wind injection during geomagnetic storms</li>
<li>Highly variable</li>
</ol>
<h3 id="73-particle-motion-in-dipole-field">7.3 Particle Motion in Dipole Field<a class="header-link" href="#73-particle-motion-in-dipole-field" title="Permanent link">&para;</a></h3>
<p>Particles undergo three motions:
1. <strong>Gyration</strong> around field lines ($\omega_c \sim 10^4$ rad/s for protons)
2. <strong>Bounce</strong> between mirror points near the poles ($\omega_b \sim 1$ rad/s)
3. <strong>Drift</strong> around Earth ($\omega_d \sim 10^{-3}$ rad/s):
   - Protons drift westward
   - Electrons drift eastward</p>
<p>The drift creates a <strong>ring current</strong> during geomagnetic storms.</p>
<h3 id="74-loss-mechanisms">7.4 Loss Mechanisms<a class="header-link" href="#74-loss-mechanisms" title="Permanent link">&para;</a></h3>
<p>Particles are lost through:
1. <strong>Atmospheric scattering</strong>: Collisions with neutrals at low altitudes
2. <strong>Charge exchange</strong>: Protons capture electrons, become neutral, escape
3. <strong>Wave-particle interactions</strong>: VLF/ELF waves scatter particles into loss cone
4. <strong>Magnetopause shadowing</strong>: Field lines intersect magnetopause, particles escape</p>
<p>Lifetimes range from days (outer belt electrons) to years (inner belt protons).</p>
<h2 id="8-python-implementations">8. Python Implementations<a class="header-link" href="#8-python-implementations" title="Permanent link">&para;</a></h2>
<h3 id="81-magnetic-mirror-simulation">8.1 Magnetic Mirror Simulation<a class="header-link" href="#81-magnetic-mirror-simulation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.mplot3d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Axes3D</span>

<span class="c1"># Constants</span>
<span class="n">m_p</span> <span class="o">=</span> <span class="mf">1.67e-27</span>  <span class="c1"># kg</span>
<span class="n">q_p</span> <span class="o">=</span> <span class="mf">1.6e-19</span>   <span class="c1"># C</span>

<span class="k">def</span><span class="w"> </span><span class="nf">mirror_field</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">B0</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parabolic mirror field: B(z) = B0 * (1 + (z/L)^2 * (R-1))</span>

<span class="sd">    B0: midplane field (T)</span>
<span class="sd">    L: mirror length scale (m)</span>
<span class="sd">    R: mirror ratio B_max/B_min</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">B0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">/</span> <span class="n">L</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">R</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">mirror_grad</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">B0</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gradient of mirror field dB/dz&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">B0</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">R</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span> <span class="o">/</span> <span class="n">L</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">equations_of_motion_mirror</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Equations of motion in mirror field</span>
<span class="sd">    state = [x, y, z, vx, vy, vz]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="n">state</span>

    <span class="c1"># Magnetic field (z-component only, aligned with z-axis)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">mirror_field</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
    <span class="n">Bx</span><span class="p">,</span> <span class="n">By</span><span class="p">,</span> <span class="n">Bz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">B</span>

    <span class="c1"># Lorentz force</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">])</span>
    <span class="n">B_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Bx</span><span class="p">,</span> <span class="n">By</span><span class="p">,</span> <span class="n">Bz</span><span class="p">])</span>
    <span class="n">F_lorentz</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">B_vec</span><span class="p">)</span>

    <span class="c1"># Mirror force (adiabatic approximation)</span>
    <span class="c1"># mu = m * (vx^2 + vy^2) / (2 * B)</span>
    <span class="n">v_perp_sq</span> <span class="o">=</span> <span class="n">vx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vy</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">v_perp_sq</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">B</span><span class="p">)</span>
    <span class="n">F_mirror</span> <span class="o">=</span> <span class="o">-</span><span class="n">mu</span> <span class="o">*</span> <span class="n">mirror_grad</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>

    <span class="c1"># Total force (Lorentz + mirror force in z-direction)</span>
    <span class="n">Fx</span><span class="p">,</span> <span class="n">Fy</span><span class="p">,</span> <span class="n">Fz_lorentz</span> <span class="o">=</span> <span class="n">F_lorentz</span> <span class="o">/</span> <span class="n">m</span>
    <span class="n">Fz</span> <span class="o">=</span> <span class="n">Fz_lorentz</span> <span class="o">+</span> <span class="n">F_mirror</span> <span class="o">/</span> <span class="n">m</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">Fx</span><span class="p">,</span> <span class="n">Fy</span><span class="p">,</span> <span class="n">Fz</span><span class="p">])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rk4_step</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;4th-order Runge-Kutta&quot;&quot;&quot;</span>
    <span class="n">k1</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">k1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">k3</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">k2</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">k4</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">k3</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">k3</span> <span class="o">+</span> <span class="n">k4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>

<span class="k">def</span><span class="w"> </span><span class="nf">simulate_mirror</span><span class="p">(</span><span class="n">v_perp</span><span class="p">,</span> <span class="n">v_para</span><span class="p">,</span> <span class="n">B0</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
                   <span class="n">duration</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate particle in magnetic mirror</span>

<span class="sd">    v_perp: initial perpendicular velocity (m/s)</span>
<span class="sd">    v_para: initial parallel velocity (m/s)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initial conditions</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
    <span class="n">vx0</span><span class="p">,</span> <span class="n">vy0</span><span class="p">,</span> <span class="n">vz0</span> <span class="o">=</span> <span class="n">v_perp</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">v_para</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">vx0</span><span class="p">,</span> <span class="n">vy0</span><span class="p">,</span> <span class="n">vz0</span><span class="p">])</span>

    <span class="c1"># Time array</span>
    <span class="n">num_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">duration</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">)</span>

    <span class="c1"># Storage</span>
    <span class="n">trajectory</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_steps</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>

    <span class="c1"># Integration</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">rk4_step</span><span class="p">(</span><span class="n">equations_of_motion_mirror</span><span class="p">,</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">state</span><span class="p">,</span>
                        <span class="n">dt</span><span class="p">,</span> <span class="n">q_p</span><span class="p">,</span> <span class="n">m_p</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
        <span class="n">trajectory</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>

    <span class="k">return</span> <span class="n">times</span><span class="p">,</span> <span class="n">trajectory</span>

<span class="c1"># Calculate loss cone angle</span>
<span class="n">B0</span> <span class="o">=</span> <span class="mf">1e-3</span>  <span class="c1"># Tesla</span>
<span class="n">L</span> <span class="o">=</span> <span class="mf">10.0</span>   <span class="c1"># meters</span>
<span class="n">R</span> <span class="o">=</span> <span class="mf">5.0</span>    <span class="c1"># mirror ratio</span>

<span class="n">alpha_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">R</span><span class="p">))</span> <span class="o">*</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># degrees</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mirror ratio R = </span><span class="si">{</span><span class="n">R</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loss cone angle: </span><span class="si">{</span><span class="n">alpha_c</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">¬∞&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trapping condition: Œ± &gt; </span><span class="si">{</span><span class="n">alpha_c</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">¬∞</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Simulate trapped and lost particles</span>
<span class="n">v_total</span> <span class="o">=</span> <span class="mf">1e5</span>  <span class="c1"># m/s</span>

<span class="c1"># Trapped particle (Œ± = 60¬∞ &gt; Œ±_c)</span>
<span class="n">alpha_trapped</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
<span class="n">v_perp_trapped</span> <span class="o">=</span> <span class="n">v_total</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha_trapped</span><span class="p">)</span>
<span class="n">v_para_trapped</span> <span class="o">=</span> <span class="n">v_total</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha_trapped</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trapped particle: Œ± = 60¬∞&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  v_perp = </span><span class="si">{</span><span class="n">v_perp_trapped</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> m/s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  v_para = </span><span class="si">{</span><span class="n">v_para_trapped</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> m/s&quot;</span><span class="p">)</span>

<span class="n">t_trap</span><span class="p">,</span> <span class="n">traj_trap</span> <span class="o">=</span> <span class="n">simulate_mirror</span><span class="p">(</span><span class="n">v_perp_trapped</span><span class="p">,</span> <span class="n">v_para_trapped</span><span class="p">,</span>
                                     <span class="n">B0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="c1"># Lost particle (Œ± = 20¬∞ &lt; Œ±_c)</span>
<span class="n">alpha_lost</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
<span class="n">v_perp_lost</span> <span class="o">=</span> <span class="n">v_total</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha_lost</span><span class="p">)</span>
<span class="n">v_para_lost</span> <span class="o">=</span> <span class="n">v_total</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha_lost</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Lost particle: Œ± = 20¬∞&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  v_perp = </span><span class="si">{</span><span class="n">v_perp_lost</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> m/s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  v_para = </span><span class="si">{</span><span class="n">v_para_lost</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> m/s&quot;</span><span class="p">)</span>

<span class="n">t_lost</span><span class="p">,</span> <span class="n">traj_lost</span> <span class="o">=</span> <span class="n">simulate_mirror</span><span class="p">(</span><span class="n">v_perp_lost</span><span class="p">,</span> <span class="n">v_para_lost</span><span class="p">,</span>
                                     <span class="n">B0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># 3D trajectories</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">traj_trap</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">traj_trap</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">traj_trap</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Trapped&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x (m)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y (m)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;z (m)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trapped Particle (Œ± = 60¬∞ &gt; Œ±_c = </span><span class="si">{</span><span class="n">alpha_c</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">¬∞)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">traj_lost</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">traj_lost</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">traj_lost</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Lost&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x (m)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y (m)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;z (m)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Lost Particle (Œ± = 20¬∞ &lt; Œ±_c = </span><span class="si">{</span><span class="n">alpha_c</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">¬∞)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Z vs time (bounce motion)</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_trap</span><span class="p">,</span> <span class="n">traj_trap</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Trapped&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">L</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mirror at ¬±</span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1"> m&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="n">L</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;z (m)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Bounce Motion&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Magnetic field along z</span>
<span class="n">z_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">L</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">L</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">B_array</span> <span class="o">=</span> <span class="n">mirror_field</span><span class="p">(</span><span class="n">z_array</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>

<span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z_array</span><span class="p">,</span> <span class="n">B_array</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;z (m)&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;B (mT)&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Magnetic Field Profile&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Velocity components vs time</span>
<span class="n">ax5</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">v_perp_trap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">traj_trap</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">traj_trap</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">v_para_trap</span> <span class="o">=</span> <span class="n">traj_trap</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_trap</span><span class="p">,</span> <span class="n">v_perp_trap</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;v_perp&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_trap</span><span class="p">,</span> <span class="n">v_para_trap</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;v_para&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Velocity (km/s)&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Velocity Components (Trapped)&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Adiabatic invariant Œº</span>
<span class="n">B_traj_trap</span> <span class="o">=</span> <span class="n">mirror_field</span><span class="p">(</span><span class="n">traj_trap</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">B0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
<span class="n">mu_trap</span> <span class="o">=</span> <span class="n">m_p</span> <span class="o">*</span> <span class="n">v_perp_trap</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">B_traj_trap</span><span class="p">)</span>

<span class="n">ax6</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_trap</span><span class="p">,</span> <span class="n">mu_trap</span> <span class="o">/</span> <span class="n">mu_trap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Œº(t) / Œº(0)&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conservation of Magnetic Moment Œº&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Œº = const&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;magnetic_mirror.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Saved: magnetic_mirror.png&quot;</span><span class="p">)</span>

<span class="c1"># Calculate bounce period</span>
<span class="n">z_positions</span> <span class="o">=</span> <span class="n">traj_trap</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
<span class="c1"># Find turning points (where v_z changes sign)</span>
<span class="n">v_z</span> <span class="o">=</span> <span class="n">traj_trap</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">sign_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">v_z</span><span class="p">))</span>
<span class="n">bounce_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sign_changes</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bounce_indices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">tau_bounce</span> <span class="o">=</span> <span class="n">t_trap</span><span class="p">[</span><span class="n">bounce_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">t_trap</span><span class="p">[</span><span class="n">bounce_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">omega_bounce</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">tau_bounce</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Bounce period: </span><span class="si">{</span><span class="n">tau_bounce</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bounce frequency: </span><span class="si">{</span><span class="n">omega_bounce</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> rad/s&quot;</span><span class="p">)</span>

    <span class="c1"># Compare with gyrofrequency</span>
    <span class="n">omega_c</span> <span class="o">=</span> <span class="n">q_p</span> <span class="o">*</span> <span class="n">B0</span> <span class="o">/</span> <span class="n">m_p</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gyrofrequency: </span><span class="si">{</span><span class="n">omega_c</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> rad/s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ratio œâ_c/œâ_b: </span><span class="si">{</span><span class="n">omega_c</span><span class="o">/</span><span class="n">omega_bounce</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="82-loss-cone-visualization">8.2 Loss Cone Visualization<a class="header-link" href="#82-loss-cone-visualization" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Loss cone in velocity space</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># 3D velocity space</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>

<span class="c1"># Generate loss cone</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">alpha_cone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha_c</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">theta_grid</span><span class="p">,</span> <span class="n">alpha_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">alpha_cone</span><span class="p">)</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">v_total</span>
<span class="n">vx_cone</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha_grid</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_grid</span><span class="p">)</span>
<span class="n">vy_cone</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha_grid</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_grid</span><span class="p">)</span>
<span class="n">vz_cone</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha_grid</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">vx_cone</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">vy_cone</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">vz_cone</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Loss cone&#39;</span><span class="p">)</span>

<span class="c1"># Generate trapped region (example particles)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">n_particles</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">alpha_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_particles</span><span class="p">))</span>
<span class="n">theta_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">n_particles</span><span class="p">)</span>

<span class="c1"># Separate trapped and lost</span>
<span class="n">trapped_mask</span> <span class="o">=</span> <span class="n">alpha_samples</span> <span class="o">&gt;</span> <span class="n">alpha_c</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
<span class="n">lost_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">trapped_mask</span>

<span class="n">vx_trapped</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha_samples</span><span class="p">[</span><span class="n">trapped_mask</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_samples</span><span class="p">[</span><span class="n">trapped_mask</span><span class="p">])</span>
<span class="n">vy_trapped</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha_samples</span><span class="p">[</span><span class="n">trapped_mask</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_samples</span><span class="p">[</span><span class="n">trapped_mask</span><span class="p">])</span>
<span class="n">vz_trapped</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha_samples</span><span class="p">[</span><span class="n">trapped_mask</span><span class="p">])</span>

<span class="n">vx_lost</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha_samples</span><span class="p">[</span><span class="n">lost_mask</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_samples</span><span class="p">[</span><span class="n">lost_mask</span><span class="p">])</span>
<span class="n">vy_lost</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha_samples</span><span class="p">[</span><span class="n">lost_mask</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_samples</span><span class="p">[</span><span class="n">lost_mask</span><span class="p">])</span>
<span class="n">vz_lost</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha_samples</span><span class="p">[</span><span class="n">lost_mask</span><span class="p">])</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">vx_trapped</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">vy_trapped</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">vz_trapped</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span>
           <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Trapped&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">vx_lost</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">vy_lost</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">vz_lost</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span>
           <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Lost&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;vx (km/s)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;vy (km/s)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;vz (km/s)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loss Cone in Velocity Space</span><span class="se">\n</span><span class="s1">Œ±_c = </span><span class="si">{</span><span class="n">alpha_c</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">¬∞, R = </span><span class="si">{</span><span class="n">R</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># 2D pitch angle distribution</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">alpha_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">alpha_rad</span> <span class="o">=</span> <span class="n">alpha_deg</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span>

<span class="c1"># Distribution function (isotropic) proportional to sin(Œ±)</span>
<span class="n">f_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha_rad</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">alpha_deg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">f_alpha</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">alpha_deg</span> <span class="o">&lt;</span> <span class="n">alpha_c</span><span class="p">),</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Loss cone (escaping)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">alpha_deg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">f_alpha</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">alpha_deg</span> <span class="o">&gt;=</span> <span class="n">alpha_c</span><span class="p">),</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Trapped&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alpha_deg</span><span class="p">,</span> <span class="n">f_alpha</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">alpha_c</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
           <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Œ±_c = </span><span class="si">{</span><span class="n">alpha_c</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">¬∞&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pitch Angle Œ± (degrees)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;f(Œ±) ‚àù sin(Œ±)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pitch Angle Distribution&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;loss_cone.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saved: loss_cone.png&quot;</span><span class="p">)</span>

<span class="c1"># Calculate fraction in loss cone</span>
<span class="n">solid_angle_loss</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha_c</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span>
<span class="n">solid_angle_total</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">frac_loss</span> <span class="o">=</span> <span class="n">solid_angle_loss</span> <span class="o">/</span> <span class="n">solid_angle_total</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loss cone solid angle: </span><span class="si">{</span><span class="n">solid_angle_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> sr&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fraction in loss cone: </span><span class="si">{</span><span class="n">frac_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">frac_loss</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fraction trapped: </span><span class="si">{</span><span class="mi">1</span><span class="o">-</span><span class="n">frac_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">frac_loss</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="83-banana-orbit-simulation-simplified-tokamak">8.3 Banana Orbit Simulation (Simplified Tokamak)<a class="header-link" href="#83-banana-orbit-simulation-simplified-tokamak" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">tokamak_field</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">R0</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">B0</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simplified tokamak field</span>

<span class="sd">    R, Z: cylindrical coordinates (m)</span>
<span class="sd">    R0: major radius (m)</span>
<span class="sd">    a: minor radius (m)</span>
<span class="sd">    B0: field at magnetic axis (T)</span>
<span class="sd">    q: safety factor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Toroidal field (1/R dependence)</span>
    <span class="n">B_phi</span> <span class="o">=</span> <span class="n">B0</span> <span class="o">*</span> <span class="n">R0</span> <span class="o">/</span> <span class="n">R</span>

    <span class="c1"># Poloidal field (simplified, from plasma current)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">R</span> <span class="o">-</span> <span class="n">R0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">:</span>
        <span class="n">B_theta</span> <span class="o">=</span> <span class="n">B0</span> <span class="o">*</span> <span class="n">r</span> <span class="o">/</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">R0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">B_theta</span> <span class="o">=</span> <span class="n">B0</span> <span class="o">*</span> <span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">R0</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>

    <span class="c1"># Components in cylindrical coordinates</span>
    <span class="n">B_R</span> <span class="o">=</span> <span class="o">-</span><span class="n">B_theta</span> <span class="o">*</span> <span class="n">Z</span> <span class="o">/</span> <span class="n">r</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">B_Z</span> <span class="o">=</span> <span class="n">B_theta</span> <span class="o">*</span> <span class="p">(</span><span class="n">R</span> <span class="o">-</span> <span class="n">R0</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">B_R</span><span class="p">,</span> <span class="n">B_Z</span><span class="p">,</span> <span class="n">B_phi</span>

<span class="k">def</span><span class="w"> </span><span class="nf">tokamak_magnitude</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">R0</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">B0</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Total field magnitude&quot;&quot;&quot;</span>
    <span class="n">B_R</span><span class="p">,</span> <span class="n">B_Z</span><span class="p">,</span> <span class="n">B_phi</span> <span class="o">=</span> <span class="n">tokamak_field</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">R0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B_R</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">B_Z</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">B_phi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Plot tokamak field magnitude</span>
<span class="n">R_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">Z_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">R_mesh</span><span class="p">,</span> <span class="n">Z_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">R_grid</span><span class="p">,</span> <span class="n">Z_grid</span><span class="p">)</span>

<span class="n">B_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">R_mesh</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Z_grid</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R_grid</span><span class="p">)):</span>
        <span class="n">B_mag</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokamak_magnitude</span><span class="p">(</span><span class="n">R_mesh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">Z_mesh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Field contours</span>
<span class="n">contour</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">R_mesh</span><span class="p">,</span> <span class="n">Z_mesh</span><span class="p">,</span> <span class="n">B_mag</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">R_mesh</span><span class="p">,</span> <span class="n">Z_mesh</span><span class="p">,</span> <span class="n">B_mag</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
           <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;B (T)&#39;</span><span class="p">)</span>

<span class="c1"># Mark regions</span>
<span class="n">R0</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.5</span>
<span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">R0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Last closed flux surface&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">R0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;r*&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Magnetic axis&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;R (m)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Z (m)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Tokamak Magnetic Field |B|&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Field along midplane</span>
<span class="n">R_midplane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">B_midplane</span> <span class="o">=</span> <span class="p">[</span><span class="n">tokamak_magnitude</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">R_midplane</span><span class="p">]</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">R_midplane</span><span class="p">,</span> <span class="n">B_midplane</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">R0</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Inboard edge&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">R0</span><span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Outboard edge&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">R0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Magnetic axis&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;R (m)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;B (T)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Field Along Midplane (Z=0)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tokamak_field.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saved: tokamak_field.png&quot;</span><span class="p">)</span>

<span class="c1"># Calculate trapping fraction</span>
<span class="n">epsilon</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">R0</span>
<span class="n">f_trapped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">epsilon</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tokamak parameters:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Major radius R0 = </span><span class="si">{</span><span class="n">R0</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Minor radius a = </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Inverse aspect ratio Œµ = </span><span class="si">{</span><span class="n">epsilon</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Trapped fraction ‚âà sqrt(2Œµ) = </span><span class="si">{</span><span class="n">f_trapped</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">f_trapped</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="c1"># Banana width estimate</span>
<span class="n">T_keV</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># keV</span>
<span class="n">T_J</span> <span class="o">=</span> <span class="n">T_keV</span> <span class="o">*</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="n">q_p</span>
<span class="n">v_th_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">T_J</span> <span class="o">/</span> <span class="n">m_p</span><span class="p">)</span>
<span class="n">rho_i</span> <span class="o">=</span> <span class="n">m_p</span> <span class="o">*</span> <span class="n">v_th_i</span> <span class="o">/</span> <span class="p">(</span><span class="n">q_p</span> <span class="o">*</span> <span class="n">B0</span><span class="p">)</span>
<span class="n">q_safety</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">banana_width</span> <span class="o">=</span> <span class="n">q_safety</span> <span class="o">*</span> <span class="n">rho_i</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Banana orbit:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Ion temperature T_i = </span><span class="si">{</span><span class="n">T_keV</span><span class="si">}</span><span class="s2"> keV&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Thermal velocity v_th = </span><span class="si">{</span><span class="n">v_th_i</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> m/s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Ion Larmor radius œÅ_i = </span><span class="si">{</span><span class="n">rho_i</span><span class="o">*</span><span class="mf">1e3</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Banana width Œîr_b ‚âà </span><span class="si">{</span><span class="n">banana_width</span><span class="o">*</span><span class="mf">1e3</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="summary">Summary<a class="header-link" href="#summary" title="Permanent link">&para;</a></h2>
<p>In this lesson, we explored magnetic mirrors and adiabatic invariants:</p>
<ol>
<li>
<p><strong>Magnetic mirror force</strong>: $F_\parallel = -\mu\nabla_\parallel B$ reflects particles from high-field regions, enabling confinement in magnetic bottles.</p>
</li>
<li>
<p><strong>First adiabatic invariant Œº</strong>: The magnetic moment $\mu = mv_\perp^2/(2B)$ is conserved when fields vary slowly compared to the gyroperiod. This corresponds to conservation of flux through the gyro-orbit.</p>
</li>
<li>
<p><strong>Loss cone</strong>: Particles with pitch angle $\alpha < \alpha_c = \arcsin(1/\sqrt{R})$ escape through mirror throats. The fraction in the loss cone is $\sim 1/(4R)$ for large $R$.</p>
</li>
<li>
<p><strong>Bounce motion</strong>: Trapped particles oscillate between mirror points with frequency $\omega_b \sim v_\parallel/L$, much slower than gyrofrequency.</p>
</li>
<li>
<p><strong>Hierarchy of invariants</strong>:</p>
</li>
<li>$\mu$: gyration (fastest)</li>
<li>$J = \oint mv_\parallel ds$: bounce (intermediate)</li>
<li>
<p>$\Phi = \oint \mathbf{A}\cdot d\mathbf{l}$: drift (slowest)</p>
</li>
<li>
<p><strong>Tokamak orbits</strong>: The $1/R$ variation creates trapped (banana) and passing particles. Trapped fraction $\sim\sqrt{\epsilon}$ where $\epsilon = a/R_0$.</p>
</li>
<li>
<p><strong>Van Allen belts</strong>: Earth's dipole field forms a natural magnetic bottle, trapping charged particles from space.</p>
</li>
</ol>
<p>Understanding adiabatic invariants is crucial for:
- Designing magnetic confinement devices
- Predicting particle transport
- Analyzing space plasma dynamics</p>
<h2 id="practice-problems">Practice Problems<a class="header-link" href="#practice-problems" title="Permanent link">&para;</a></h2>
<h3 id="problem-1-mirror-confinement-time">Problem 1: Mirror Confinement Time<a class="header-link" href="#problem-1-mirror-confinement-time" title="Permanent link">&para;</a></h3>
<p>A simple magnetic mirror has $B_{\text{min}} = 0.2$ T, $B_{\text{max}} = 1.0$ T, and length $L = 5$ m. The plasma density is $n = 10^{18}$ m$^{-3}$ and temperature $T = 100$ eV. The collision frequency is $\nu_c = 10^4$ s$^{-1}$.</p>
<p>(a) Calculate the mirror ratio $R$ and loss cone angle $\alpha_c$.</p>
<p>(b) Estimate the fraction of particles in the loss cone (assume isotropic distribution).</p>
<p>(c) Calculate the confinement time $\tau_{\text{conf}} \sim (R/\nu_c)(1/f_{\text{loss}})$.</p>
<p>(d) Compare with the collision time $\tau_c = 1/\nu_c$. Is this a well-confined plasma?</p>
<hr />
<h3 id="problem-2-conservation-of-in-a-slowly-varying-field">Problem 2: Conservation of Œº in a Slowly Varying Field<a class="header-link" href="#problem-2-conservation-of-in-a-slowly-varying-field" title="Permanent link">&para;</a></h3>
<p>A proton with initial energy $W = 1$ keV and pitch angle $\alpha_0 = 45¬∞$ moves in a magnetic field that increases from $B_0 = 0.1$ T to $B_1 = 0.5$ T over a distance $L = 10$ m.</p>
<p>(a) Calculate the initial magnetic moment $\mu$.</p>
<p>(b) Assuming $\mu$ is conserved, find the final perpendicular and parallel velocities.</p>
<p>(c) What is the final pitch angle $\alpha_1$?</p>
<p>(d) Verify that total energy is conserved.</p>
<p>(e) Check the adiabatic condition: is $r_L |\nabla B|/B \ll 1$?</p>
<hr />
<h3 id="problem-3-bounce-frequency-in-a-parabolic-mirror">Problem 3: Bounce Frequency in a Parabolic Mirror<a class="header-link" href="#problem-3-bounce-frequency-in-a-parabolic-mirror" title="Permanent link">&para;</a></h3>
<p>In a parabolic mirror with $B(z) = B_0(1 + z^2/L^2)$ where $B_0 = 0.5$ T and $L = 10$ m, a deuteron has energy $W = 10$ keV and pitch angle $\alpha_0 = 60¬∞$ at the midplane ($z = 0$).</p>
<p>(a) Find the mirror point $z_{\text{mirror}}$ where $v_\parallel = 0$.</p>
<p>(b) Estimate the bounce period $\tau_b$ using $\tau_b \approx 4z_{\text{mirror}}/\langle v_\parallel\rangle$ where $\langle v_\parallel\rangle$ is the average parallel velocity.</p>
<p>(c) Calculate the bounce frequency $\omega_b = 2\pi/\tau_b$.</p>
<p>(d) Compare with the gyrofrequency $\omega_c$ at the midplane. Verify $\omega_c \gg \omega_b$.</p>
<p><strong>Hint</strong>: Use energy conservation: $\frac{1}{2}mv^2\sin^2\alpha_0 = \frac{1}{2}mv^2\frac{B(z_m)}{B_0}$.</p>
<hr />
<h3 id="problem-4-tokamak-banana-width">Problem 4: Tokamak Banana Width<a class="header-link" href="#problem-4-tokamak-banana-width" title="Permanent link">&para;</a></h3>
<p>In a tokamak with $R_0 = 3$ m, $a = 1$ m, $B_0 = 5$ T, and safety factor $q = 2$, calculate the banana width for deuterium ions with temperature $T_i = 20$ keV.</p>
<p>(a) Compute the inverse aspect ratio $\epsilon = a/R_0$.</p>
<p>(b) Calculate the ion Larmor radius $\rho_i = m_i v_{th,i}/(eB_0)$ where $v_{th,i} = \sqrt{2k_BT_i/m_i}$.</p>
<p>(c) Estimate the banana width $\Delta r_b \approx q\rho_i\sqrt{\epsilon}$.</p>
<p>(d) What fraction of the minor radius is the banana width? Is this significant for confinement?</p>
<p>(e) Calculate the trapped particle fraction $f_{\text{trap}} \approx \sqrt{2\epsilon}$.</p>
<hr />
<h3 id="problem-5-second-adiabatic-invariant-in-a-dipole-field">Problem 5: Second Adiabatic Invariant in a Dipole Field<a class="header-link" href="#problem-5-second-adiabatic-invariant-in-a-dipole-field" title="Permanent link">&para;</a></h3>
<p>An electron is trapped on a dipole field line at $L = 4$ Earth radii ($L$ is the equatorial crossing distance in units of $R_E = 6.37\times 10^6$ m). The magnetic field on this line varies as:</p>
<p>$$
B(s) = B_{\text{eq}}\sqrt{1 + 3\sin^2\lambda}/\cos^6\lambda
$$</p>
<p>where $\lambda$ is magnetic latitude and $B_{\text{eq}} = 10^{-6}$ T is the equatorial field.</p>
<p>(a) The electron has energy $W = 100$ keV and equatorial pitch angle $\alpha_{\text{eq}} = 45¬∞$. Find the mirror latitude $\lambda_m$ where the particle reflects.</p>
<p>(b) Estimate the arc length $s_m$ from equator to mirror point (use $s \approx LR_E\lambda$ for small $\lambda$).</p>
<p>(c) Calculate the second invariant $J = \oint mv_\parallel ds \approx 4m\langle v_\parallel\rangle s_m$ (approximate).</p>
<p>(d) If the field slowly decreases (e.g., during a geomagnetic storm), $J$ remains constant. Explain qualitatively how the mirror latitude changes.</p>
<p><strong>Hint</strong>: For $\lambda_m$, use $\sin^2\alpha_{\text{eq}} = B_{\text{eq}}/B(\lambda_m)$.</p>
<hr />
<h2 id="navigation">Navigation<a class="header-link" href="#navigation" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Previous</strong>: <a href="./05_Single_Particle_Motion_II.md">Single Particle Motion II</a></li>
<li><strong>Next</strong>: <a href="./07_Vlasov_Equation.md">Vlasov Equation</a></li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Plasma_Physics/05_Single_Particle_Motion_II.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">5. Single Particle Motion II</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Plasma_Physics/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Plasma_Physics/07_Vlasov_Equation.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">7. Vlasov Equation</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">‚Üë</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}