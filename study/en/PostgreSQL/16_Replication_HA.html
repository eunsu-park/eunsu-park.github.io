{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>16. Replication & High Availability - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/PostgreSQL/">PostgreSQL</a>
    <span class="separator">/</span>
    <span class="current">16. Replication & High Availability</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>16. Replication & High Availability</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/PostgreSQL/15_Query_Optimization.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">15. Advanced PostgreSQL Query Optimization</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/PostgreSQL/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/PostgreSQL/17_Window_Functions.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">17. Window Functions & Analytics Queries</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-replication-overview">1. Replication Overview</a><ul>
<li><a href="#11-purpose-of-replication">1.1 Purpose of Replication</a></li>
<li><a href="#12-replication-type-comparison">1.2 Replication Type Comparison</a></li>
<li><a href="#13-wal-write-ahead-logging-basics">1.3 WAL (Write-Ahead Logging) Basics</a></li>
</ul>
</li>
<li><a href="#2-physical-replication-streaming-replication">2. Physical Replication (Streaming Replication)</a><ul>
<li><a href="#21-architecture">2.1 Architecture</a></li>
<li><a href="#22-primary-server-configuration">2.2 Primary Server Configuration</a></li>
<li><a href="#23-standby-server-configuration">2.3 Standby Server Configuration</a></li>
<li><a href="#24-synchronous-vs-asynchronous-replication">2.4 Synchronous vs Asynchronous Replication</a></li>
<li><a href="#25-cascading-replication">2.5 Cascading Replication</a></li>
</ul>
</li>
<li><a href="#3-logical-replication">3. Logical Replication</a><ul>
<li><a href="#31-logical-replication-overview">3.1 Logical Replication Overview</a></li>
<li><a href="#32-publisher-configuration">3.2 Publisher Configuration</a></li>
<li><a href="#33-subscriber-configuration">3.3 Subscriber Configuration</a></li>
<li><a href="#34-logical-replication-use-cases">3.4 Logical Replication Use Cases</a></li>
<li><a href="#35-conflict-handling">3.5 Conflict Handling</a></li>
</ul>
</li>
<li><a href="#4-replication-monitoring">4. Replication Monitoring</a><ul>
<li><a href="#41-check-replication-status">4.1 Check Replication Status</a></li>
<li><a href="#42-monitor-replication-slots">4.2 Monitor Replication Slots</a></li>
<li><a href="#43-create-monitoring-view">4.3 Create Monitoring View</a></li>
</ul>
</li>
<li><a href="#5-failover-and-switchover">5. Failover and Switchover</a><ul>
<li><a href="#51-concept-clarification">5.1 Concept Clarification</a></li>
<li><a href="#52-manual-failover">5.2 Manual Failover</a></li>
<li><a href="#53-recover-old-primary-with-pg_rewind">5.3 Recover Old Primary with pg_rewind</a></li>
<li><a href="#54-automatic-failover-script-example">5.4 Automatic Failover Script Example</a></li>
</ul>
</li>
<li><a href="#6-high-availability-solutions">6. High Availability Solutions</a><ul>
<li><a href="#61-patroni">6.1 Patroni</a></li>
<li><a href="#62-high-availability-architecture">6.2 High Availability Architecture</a></li>
<li><a href="#63-haproxy-configuration">6.3 HAProxy Configuration</a></li>
<li><a href="#64-integration-with-pgbouncer">6.4 Integration with PgBouncer</a></li>
<li><a href="#65-cloud-environment-high-availability">6.5 Cloud Environment High Availability</a></li>
</ul>
</li>
<li><a href="#7-practice-problems">7. Practice Problems</a><ul>
<li><a href="#exercise-1-configure-streaming-replication">Exercise 1: Configure Streaming Replication</a></li>
<li><a href="#exercise-2-configure-logical-replication">Exercise 2: Configure Logical Replication</a></li>
<li><a href="#exercise-3-replication-monitoring-dashboard">Exercise 3: Replication Monitoring Dashboard</a></li>
</ul>
</li>
<li><a href="#next-steps">Next Steps</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="16-replication-high-availability">16. Replication &amp; High Availability<a class="header-link" href="#16-replication-high-availability" title="Permanent link">&para;</a></h1>
<h2 id="learning-objectives">Learning Objectives<a class="header-link" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<ul>
<li>Understand PostgreSQL replication architecture and types</li>
<li>Configure and manage streaming replication</li>
<li>Use logical replication for selective data replication</li>
<li>Implement failover strategies and automation</li>
<li>Design high availability clusters</li>
</ul>
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-replication-overview">Replication Overview</a></li>
<li><a href="#2-physical-replication-streaming-replication">Physical Replication (Streaming Replication)</a></li>
<li><a href="#3-logical-replication">Logical Replication</a></li>
<li><a href="#4-replication-monitoring">Replication Monitoring</a></li>
<li><a href="#5-failover-and-switchover">Failover and Switchover</a></li>
<li><a href="#6-high-availability-solutions">High Availability Solutions</a></li>
<li><a href="#7-practice-problems">Practice Problems</a></li>
</ol>
<hr />
<h2 id="1-replication-overview">1. Replication Overview<a class="header-link" href="#1-replication-overview" title="Permanent link">&para;</a></h2>
<h3 id="11-purpose-of-replication">1.1 Purpose of Replication<a class="header-link" href="#11-purpose-of-replication" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="n">Replication</span><span class="w"> </span><span class="n">Purposes</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">High</span><span class="w"> </span><span class="n">Availability</span><span class="w"> </span><span class="p">(</span><span class="n">HA</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Minimize</span><span class="w"> </span><span class="n">downtime</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">auto</span><span class="o">/</span><span class="n">manual</span><span class="w"> </span><span class="n">failover</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Read</span><span class="w"> </span><span class="n">Scaling</span><span class="w">            </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Distribute</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">queries</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">standby</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Disaster</span><span class="w"> </span><span class="n">Recovery</span><span class="w"> </span><span class="p">(</span><span class="n">DR</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Geographically</span><span class="w"> </span><span class="n">distributed</span><span class="w"> </span><span class="n">replicas</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">DR</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Backup</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Run</span><span class="w"> </span><span class="n">backups</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">standby</span><span class="p">,</span><span class="w"> </span><span class="n">reduce</span><span class="w"> </span><span class="n">prod</span><span class="w"> </span><span class="nb">load</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="n">Analytics</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Run</span><span class="w"> </span><span class="n">heavy</span><span class="w"> </span><span class="n">analytical</span><span class="w"> </span><span class="n">queries</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">replica</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="12-replication-type-comparison">1.2 Replication Type Comparison<a class="header-link" href="#12-replication-type-comparison" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                </span><span class="err">â”‚</span><span class="w">   </span><span class="nx">Physical</span><span class="w"> </span><span class="nx">Repl</span><span class="w">     </span><span class="err">â”‚</span><span class="w">   </span><span class="nx">Logical</span><span class="w"> </span><span class="nx">Repl</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Unit</span><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Byte</span><span class="o">-</span><span class="nx">level</span><span class="w"> </span><span class="p">(</span><span class="nx">WAL</span><span class="p">)</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Row</span><span class="o">-</span><span class="nx">level</span><span class="w"> </span><span class="nx">changes</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Scope</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Entire</span><span class="w"> </span><span class="nx">cluster</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Selective</span><span class="w"> </span><span class="p">(</span><span class="nx">table</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Version</span><span class="w"> </span><span class="nx">Compat</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Same</span><span class="w"> </span><span class="nx">major</span><span class="w"> </span><span class="nx">version</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Different</span><span class="w"> </span><span class="nx">versions</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Standby</span><span class="w"> </span><span class="nx">Query</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Read</span><span class="o">-</span><span class="nx">only</span><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Read</span><span class="o">/</span><span class="nx">Write</span><span class="w"> </span><span class="nx">possible</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="nx">Complexity</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Simple</span><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Medium</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Use</span><span class="w"> </span><span class="nx">Case</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">HA</span><span class="p">,</span><span class="w"> </span><span class="nx">read</span><span class="w"> </span><span class="nx">scaling</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Migration</span><span class="p">,</span><span class="w"> </span><span class="nx">integration</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="13-wal-write-ahead-logging-basics">1.3 WAL (Write-Ahead Logging) Basics<a class="header-link" href="#13-wal-write-ahead-logging-basics" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Check WAL settings</span>
<span class="k">SHOW</span><span class="w"> </span><span class="n">wal_level</span><span class="p">;</span><span class="w">           </span><span class="c1">-- replica or logical</span>
<span class="k">SHOW</span><span class="w"> </span><span class="n">max_wal_senders</span><span class="p">;</span><span class="w">     </span><span class="c1">-- Number of WAL sender processes</span>
<span class="k">SHOW</span><span class="w"> </span><span class="n">max_replication_slots</span><span class="p">;</span>
<span class="k">SHOW</span><span class="w"> </span><span class="n">wal_keep_size</span><span class="p">;</span><span class="w">       </span><span class="c1">-- WAL retention size</span>

<span class="c1">-- Check WAL position</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">pg_current_wal_lsn</span><span class="p">();</span><span class="w">           </span><span class="c1">-- Current WAL position</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">pg_walfile_name</span><span class="p">(</span><span class="n">pg_current_wal_lsn</span><span class="p">());</span><span class="w">  </span><span class="c1">-- WAL file name</span>
</code></pre></div>

<hr />
<h2 id="2-physical-replication-streaming-replication">2. Physical Replication (Streaming Replication)<a class="header-link" href="#2-physical-replication-streaming-replication" title="Permanent link">&para;</a></h2>
<h3 id="21-architecture">2.1 Architecture<a class="header-link" href="#21-architecture" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Streaming Replication Architecture             â”‚
â”‚                                                                 â”‚
â”‚   Primary                           Standby                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚             â”‚    WAL Stream     â”‚             â”‚           â”‚
â”‚   â”‚  PostgreSQL â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  PostgreSQL â”‚           â”‚
â”‚   â”‚   (R/W)     â”‚                   â”‚   (R/O)     â”‚           â”‚
â”‚   â”‚             â”‚                   â”‚             â”‚           â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚           â”‚
â”‚   â”‚ â”‚wal_senderâ”‚â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”‚wal_recv â”‚ â”‚           â”‚
â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                 â”‚
â”‚   [Synchronous/Asynchronous options available]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="22-primary-server-configuration">2.2 Primary Server Configuration<a class="header-link" href="#22-primary-server-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># postgresql.conf (Primary)</span>
<span class="nv">listen_addresses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;*&#39;</span>
<span class="nv">wal_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>replica
<span class="nv">max_wal_senders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<span class="nv">wal_keep_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>1GB
<span class="nv">max_replication_slots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>

<span class="c1"># Synchronous replication settings (optional)</span>
<span class="nv">synchronous_commit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>on
<span class="nv">synchronous_standby_names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;standby1&#39;</span>

<span class="c1"># pg_hba.conf (allow replication connections)</span>
<span class="c1"># TYPE  DATABASE        USER            ADDRESS                 METHOD</span>
host<span class="w">    </span>replication<span class="w">     </span>replicator<span class="w">      </span><span class="m">192</span>.168.1.0/24<span class="w">          </span>scram-sha-256
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">-- Create replication user</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">replicator</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">REPLICATION</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;secure_password&#39;</span><span class="p">;</span>

<span class="c1">-- Create replication slot (recommended)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">pg_create_physical_replication_slot</span><span class="p">(</span><span class="s1">&#39;standby1_slot&#39;</span><span class="p">);</span>

<span class="c1">-- Check replication slots</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_replication_slots</span><span class="p">;</span>
</code></pre></div>

<h3 id="23-standby-server-configuration">2.3 Standby Server Configuration<a class="header-link" href="#23-standby-server-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. Create base backup from Primary</span>
pg_basebackup<span class="w"> </span>-h<span class="w"> </span>primary_host<span class="w"> </span>-U<span class="w"> </span>replicator<span class="w"> </span>-D<span class="w"> </span>/var/lib/postgresql/data<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-Fp<span class="w"> </span>-Xs<span class="w"> </span>-P<span class="w"> </span>-R

<span class="c1"># -R option: auto-create standby.signal file and primary_conninfo</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># postgresql.conf (Standby)</span>
<span class="nv">hot_standby</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>on<span class="w">                  </span><span class="c1"># Allow read queries</span>
<span class="nv">hot_standby_feedback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>on<span class="w">         </span><span class="c1"># Prevent query conflicts</span>
<span class="nv">max_standby_streaming_delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>30s<span class="w"> </span><span class="c1"># Query wait time</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># postgresql.auto.conf (auto-generated by pg_basebackup -R)</span>
<span class="nv">primary_conninfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;host=primary_host port=5432 user=replicator password=secure_password&#39;</span>
<span class="nv">primary_slot_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;standby1_slot&#39;</span>
</code></pre></div>

<h3 id="24-synchronous-vs-asynchronous-replication">2.4 Synchronous vs Asynchronous Replication<a class="header-link" href="#24-synchronous-vs-asynchronous-replication" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Asynchronous replication (default)</span>
<span class="c1">-- Primary commits immediately, standby may lag</span>
<span class="n">synchronous_commit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">on</span><span class="w">  </span><span class="c1">-- guarantees local only</span>

<span class="c1">-- Synchronous replication</span>
<span class="n">synchronous_commit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">on</span>
<span class="n">synchronous_standby_names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;FIRST 1 (standby1, standby2)&#39;</span>

<span class="c1">-- Synchronous replication options</span>
<span class="c1">-- remote_write: to remote OS buffer</span>
<span class="c1">-- remote_apply: to remote apply (safest, slowest)</span>
<span class="n">synchronous_commit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remote_apply</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>Synchronous replication configuration example:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ synchronous_standby_names = &#39;FIRST 2 (s1, s2, s3)&#39;             â”‚
â”‚                                                                 â”‚
â”‚   - FIRST 2: requires confirmation from first 2 standbys       â”‚
â”‚   - ANY 2: requires confirmation from any 2 standbys           â”‚
â”‚   - s1, s2, s3: priority based on application_name             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="25-cascading-replication">2.5 Cascading Replication<a class="header-link" href="#25-cascading-replication" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">Cascading</span><span class="w"> </span><span class="n">Replication</span><span class="w"> </span><span class="n">Topology</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="n">Primary</span><span class="w"> </span><span class="err">â”€â”€â–º</span><span class="w"> </span><span class="n">Standby1</span><span class="w"> </span><span class="err">â”€â”€â–º</span><span class="w"> </span><span class="n">Standby2</span><span class="w"> </span><span class="err">â”€â”€â–º</span><span class="w"> </span><span class="n">Standby3</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">              </span><span class="p">(</span><span class="n">relay</span><span class="p">)</span><span class="w">       </span><span class="p">(</span><span class="n">relay</span><span class="p">)</span><span class="w">       </span><span class="p">(</span><span class="n">final</span><span class="p">)</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="n">Advantages</span><span class="p">:</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Reduce</span><span class="w"> </span><span class="n">Primary</span><span class="w"> </span><span class="nb">load</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Efficient</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="n">bandwidth</span><span class="w"> </span><span class="n">usage</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Better</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">geographic</span><span class="w"> </span><span class="n">distribution</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Standby1 (relay server)</span>
<span class="c1"># postgresql.conf</span>
<span class="nv">hot_standby</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>on

<span class="c1"># Standby2 (receive from Standby1)</span>
<span class="c1"># set Standby1 address in primary_conninfo</span>
<span class="nv">primary_conninfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;host=standby1_host ...&#39;</span>
</code></pre></div>

<hr />
<h2 id="3-logical-replication">3. Logical Replication<a class="header-link" href="#3-logical-replication" title="Permanent link">&para;</a></h2>
<h3 id="31-logical-replication-overview">3.1 Logical Replication Overview<a class="header-link" href="#31-logical-replication-overview" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Logical Replication Architecture               â”‚
â”‚                                                                 â”‚
â”‚   Publisher                         Subscriber                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚ PostgreSQL  â”‚   Publication     â”‚ PostgreSQL  â”‚           â”‚
â”‚   â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚             â”‚           â”‚
â”‚   â”‚  Table A    â”‚   Subscription    â”‚  Table A    â”‚           â”‚
â”‚   â”‚  Table B    â”‚                   â”‚  Table B    â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                 â”‚
â”‚   Features:                                                     â”‚
â”‚   - Table-level selective replication                          â”‚
â”‚   - Replication between different PostgreSQL versions          â”‚
â”‚   - Subscriber can also write                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="32-publisher-configuration">3.2 Publisher Configuration<a class="header-link" href="#32-publisher-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- postgresql.conf</span>
<span class="c1">-- wal_level = logical  (required)</span>

<span class="c1">-- Create publication</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">my_pub</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="p">,</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span>

<span class="c1">-- Publish all tables</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">all_tables_pub</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="p">;</span>

<span class="c1">-- Publish specific operations only</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">insert_only_pub</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span>
<span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">publish</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;insert&#39;</span><span class="p">);</span>

<span class="c1">-- Row filter (PostgreSQL 15+)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">active_users_pub</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;active&#39;</span><span class="p">);</span>

<span class="c1">-- Column filter (PostgreSQL 15+)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">partial_pub</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">);</span>

<span class="c1">-- Check publications</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_publication</span><span class="p">;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_publication_tables</span><span class="p">;</span>
</code></pre></div>

<h3 id="33-subscriber-configuration">3.3 Subscriber Configuration<a class="header-link" href="#33-subscriber-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Create target tables (requires same schema)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span><span class="k">LIKE</span><span class="w"> </span><span class="n">source_db</span><span class="p">.</span><span class="n">users</span><span class="w"> </span><span class="k">INCLUDING</span><span class="w"> </span><span class="k">ALL</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span><span class="k">LIKE</span><span class="w"> </span><span class="n">source_db</span><span class="p">.</span><span class="n">orders</span><span class="w"> </span><span class="k">INCLUDING</span><span class="w"> </span><span class="k">ALL</span><span class="p">);</span>

<span class="c1">-- Create subscription</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">my_sub</span>
<span class="k">CONNECTION</span><span class="w"> </span><span class="s1">&#39;host=publisher_host dbname=source_db user=replicator password=xxx&#39;</span>
<span class="n">PUBLICATION</span><span class="w"> </span><span class="n">my_pub</span><span class="p">;</span>

<span class="c1">-- Without initial data copy (if already synced)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">my_sub</span>
<span class="k">CONNECTION</span><span class="w"> </span><span class="s1">&#39;...&#39;</span>
<span class="n">PUBLICATION</span><span class="w"> </span><span class="n">my_pub</span>
<span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">copy_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">);</span>

<span class="c1">-- Manage subscription</span>
<span class="k">ALTER</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">my_sub</span><span class="w"> </span><span class="n">DISABLE</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">my_sub</span><span class="w"> </span><span class="n">ENABLE</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">my_sub</span><span class="w"> </span><span class="n">REFRESH</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="p">;</span>

<span class="c1">-- Check subscription status</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_subscription</span><span class="p">;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_subscription</span><span class="p">;</span>
</code></pre></div>

<h3 id="34-logical-replication-use-cases">3.4 Logical Replication Use Cases<a class="header-link" href="#34-logical-replication-use-cases" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 1. Version upgrade (minimal downtime)</span>
<span class="c1">-- Set up logical replication old version â†’ new version, then switchover</span>

<span class="c1">-- 2. Selective data replication (data warehouse)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">analytics_pub</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">sales</span><span class="p">,</span><span class="w"> </span><span class="n">customers</span><span class="p">,</span><span class="w"> </span><span class="n">products</span>
<span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;APAC&#39;</span><span class="p">);</span>

<span class="c1">-- 3. Data consolidation (multiple sources â†’ single target)</span>
<span class="c1">-- Source DB 1</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">region1_pub</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span>

<span class="c1">-- Source DB 2</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">region2_pub</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span>

<span class="c1">-- Target DB</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">sub1</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">region1_pub</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">sub2</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">region2_pub</span><span class="p">;</span>

<span class="c1">-- 4. Real-time reporting database</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">reporting_pub</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">transactions</span><span class="p">,</span><span class="w"> </span><span class="n">accounts</span><span class="p">,</span><span class="w"> </span><span class="n">audit_logs</span><span class="p">;</span>
</code></pre></div>

<h3 id="35-conflict-handling">3.5 Conflict Handling<a class="header-link" href="#35-conflict-handling" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Conflicts can occur in logical replication</span>
<span class="c1">-- (since Subscriber allows writes)</span>

<span class="c1">-- Check conflicts</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_subscription</span><span class="p">;</span>
<span class="c1">-- srsubstate: &#39;e&#39; = error</span>

<span class="c1">-- Conflict options:</span>
<span class="c1">-- 1. Manually resolve conflict row</span>
<span class="c1">-- 2. Skip transaction</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">pg_replication_origin_advance</span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;pg_&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">subid</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="w">  </span><span class="c1">-- origin name</span>
<span class="w">    </span><span class="s1">&#39;0/XXXXXXX&#39;</span><span class="p">::</span><span class="n">pg_lsn</span><span class="w">    </span><span class="c1">-- LSN to skip</span>
<span class="p">);</span>

<span class="c1">-- 3. Restart replication</span>
<span class="k">ALTER</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">my_sub</span><span class="w"> </span><span class="n">DISABLE</span><span class="p">;</span>
<span class="c1">-- After resolving issue</span>
<span class="k">ALTER</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">my_sub</span><span class="w"> </span><span class="n">ENABLE</span><span class="p">;</span>
</code></pre></div>

<hr />
<h2 id="4-replication-monitoring">4. Replication Monitoring<a class="header-link" href="#4-replication-monitoring" title="Permanent link">&para;</a></h2>
<h3 id="41-check-replication-status">4.1 Check Replication Status<a class="header-link" href="#41-check-replication-status" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Primary: WAL sender status</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">client_addr</span><span class="p">,</span>
<span class="w">    </span><span class="k">state</span><span class="p">,</span>
<span class="w">    </span><span class="n">sent_lsn</span><span class="p">,</span>
<span class="w">    </span><span class="n">write_lsn</span><span class="p">,</span>
<span class="w">    </span><span class="n">flush_lsn</span><span class="p">,</span>
<span class="w">    </span><span class="n">replay_lsn</span><span class="p">,</span>
<span class="w">    </span><span class="n">sync_state</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_wal_lsn_diff</span><span class="p">(</span><span class="n">sent_lsn</span><span class="p">,</span><span class="w"> </span><span class="n">replay_lsn</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">replay_lag_bytes</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_replication</span><span class="p">;</span>

<span class="c1">-- Replication lag time (Primary)</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">client_addr</span><span class="p">,</span>
<span class="w">    </span><span class="k">state</span><span class="p">,</span>
<span class="w">    </span><span class="n">write_lag</span><span class="p">,</span>
<span class="w">    </span><span class="n">flush_lag</span><span class="p">,</span>
<span class="w">    </span><span class="n">replay_lag</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_replication</span><span class="p">;</span>

<span class="c1">-- Standby: current replication status</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">pg_is_in_recovery</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">is_standby</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_last_wal_receive_lsn</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">received_lsn</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_last_wal_replay_lsn</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">replayed_lsn</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_last_xact_replay_timestamp</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">last_replay_time</span><span class="p">,</span>
<span class="w">    </span><span class="k">EXTRACT</span><span class="p">(</span><span class="n">EPOCH</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pg_last_xact_replay_timestamp</span><span class="p">()))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">lag_seconds</span><span class="p">;</span>
</code></pre></div>

<h3 id="42-monitor-replication-slots">4.2 Monitor Replication Slots<a class="header-link" href="#42-monitor-replication-slots" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Replication slot status</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">slot_name</span><span class="p">,</span>
<span class="w">    </span><span class="n">slot_type</span><span class="p">,</span>
<span class="w">    </span><span class="n">active</span><span class="p">,</span>
<span class="w">    </span><span class="n">restart_lsn</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_wal_lsn_diff</span><span class="p">(</span><span class="n">pg_current_wal_lsn</span><span class="p">(),</span><span class="w"> </span><span class="n">restart_lsn</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">retained_bytes</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_replication_slots</span><span class="p">;</span>

<span class="c1">-- Check WAL accumulation from inactive slots</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">slot_name</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_wal_lsn_diff</span><span class="p">(</span><span class="n">pg_current_wal_lsn</span><span class="p">(),</span><span class="w"> </span><span class="n">restart_lsn</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">retained</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_replication_slots</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">active</span><span class="p">;</span>

<span class="c1">-- Clean up inactive slots (caution!)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">pg_drop_replication_slot</span><span class="p">(</span><span class="s1">&#39;unused_slot&#39;</span><span class="p">);</span>
</code></pre></div>

<h3 id="43-create-monitoring-view">4.3 Create Monitoring View<a class="header-link" href="#43-create-monitoring-view" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Comprehensive replication monitoring view</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">v_replication_status</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="s1">&#39;physical&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">repl_type</span><span class="p">,</span>
<span class="w">    </span><span class="n">client_addr</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">application_name</span><span class="p">,</span>
<span class="w">    </span><span class="k">state</span><span class="p">,</span>
<span class="w">    </span><span class="n">sync_state</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_wal_lsn_diff</span><span class="p">(</span><span class="n">sent_lsn</span><span class="p">,</span><span class="w"> </span><span class="n">replay_lsn</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">lag_size</span><span class="p">,</span>
<span class="w">    </span><span class="k">COALESCE</span><span class="p">(</span><span class="n">replay_lag</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">lag_time</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_replication</span>

<span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span>

<span class="k">SELECT</span>
<span class="w">    </span><span class="s1">&#39;logical&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">repl_type</span><span class="p">,</span>
<span class="w">    </span><span class="n">subconninfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">subname</span><span class="p">,</span>
<span class="w">    </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">subenabled</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;active&#39;</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;disabled&#39;</span><span class="w"> </span><span class="k">END</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;async&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;N/A&#39;</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_subscription</span><span class="p">;</span>
</code></pre></div>

<hr />
<h2 id="5-failover-and-switchover">5. Failover and Switchover<a class="header-link" href="#5-failover-and-switchover" title="Permanent link">&para;</a></h2>
<h3 id="51-concept-clarification">5.1 Concept Clarification<a class="header-link" href="#51-concept-clarification" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w"> </span><span class="nv">Switchover</span><span class="w">                                                       </span>â”‚
â”‚<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">Planned</span><span class="w"> </span><span class="nv">role</span><span class="w"> </span><span class="nv">transition</span><span class="w">                                       </span>â”‚
â”‚<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">Used</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">maintenance</span>,<span class="w"> </span><span class="nv">upgrades</span><span class="w">                                </span>â”‚
â”‚<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">No</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="nv">loss</span><span class="w">                                                  </span>â”‚
â”‚<span class="w">                                                                 </span>â”‚
â”‚<span class="w"> </span><span class="nv">Failover</span><span class="w">                                                         </span>â”‚
â”‚<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">Unplanned</span><span class="w"> </span><span class="nv">role</span><span class="w"> </span><span class="nv">transition</span><span class="w"> </span><span class="nv">during</span><span class="w"> </span><span class="nv">failure</span><span class="w">                      </span>â”‚
â”‚<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">Standby</span><span class="w"> </span><span class="nv">promoted</span><span class="w"> </span><span class="nv">when</span><span class="w"> </span><span class="nv">Primary</span><span class="w"> </span><span class="nv">fails</span><span class="w">                           </span>â”‚
â”‚<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">Possible</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="nv">loss</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">async</span><span class="w"> </span><span class="nv">replication</span><span class="w">                     </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="52-manual-failover">5.2 Manual Failover<a class="header-link" href="#52-manual-failover" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Promote standby (using pg_ctl)</span>
pg_ctl<span class="w"> </span>promote<span class="w"> </span>-D<span class="w"> </span>/var/lib/postgresql/data

<span class="c1"># Or using SQL</span>
SELECT<span class="w"> </span>pg_promote<span class="o">()</span><span class="p">;</span>

<span class="c1"># Or using trigger file (legacy)</span>
touch<span class="w"> </span>/var/lib/postgresql/data/promote
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">-- Verify promotion</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">pg_is_in_recovery</span><span class="p">();</span><span class="w">  </span><span class="c1">-- false means Primary</span>
</code></pre></div>

<h3 id="53-recover-old-primary-with-pg_rewind">5.3 Recover Old Primary with pg_rewind<a class="header-link" href="#53-recover-old-primary-with-pg_rewind" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Convert old Primary to new Standby after failure</span>
<span class="c1"># (resolve timeline divergence)</span>

<span class="c1"># 1. Stop old Primary</span>
pg_ctl<span class="w"> </span>stop<span class="w"> </span>-D<span class="w"> </span>/var/lib/postgresql/data

<span class="c1"># 2. Run pg_rewind</span>
pg_rewind<span class="w"> </span>--target-pgdata<span class="o">=</span>/var/lib/postgresql/data<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>--source-server<span class="o">=</span><span class="s2">&quot;host=new_primary port=5432 user=replicator&quot;</span>

<span class="c1"># 3. Create standby.signal and configure</span>
touch<span class="w"> </span>/var/lib/postgresql/data/standby.signal

<span class="c1"># 4. Start</span>
pg_ctl<span class="w"> </span>start<span class="w"> </span>-D<span class="w"> </span>/var/lib/postgresql/data
</code></pre></div>

<h3 id="54-automatic-failover-script-example">5.4 Automatic Failover Script Example<a class="header-link" href="#54-automatic-failover-script-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># simple_failover.sh</span>

<span class="nv">PRIMARY_HOST</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span>
<span class="nv">STANDBY_HOST</span><span class="o">=</span><span class="s2">&quot;standby&quot;</span>
<span class="nv">VIP</span><span class="o">=</span><span class="s2">&quot;192.168.1.100&quot;</span>

check_primary<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>pg_isready<span class="w"> </span>-h<span class="w"> </span><span class="nv">$PRIMARY_HOST</span><span class="w"> </span>-p<span class="w"> </span><span class="m">5432</span><span class="w"> </span>-q
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">$?</span>
<span class="o">}</span>

promote_standby<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>ssh<span class="w"> </span><span class="nv">$STANDBY_HOST</span><span class="w"> </span><span class="s2">&quot;pg_ctl promote -D /var/lib/postgresql/data&quot;</span>
<span class="o">}</span>

move_vip<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="c1"># Remove VIP from old Primary</span>
<span class="w">    </span>ssh<span class="w"> </span><span class="nv">$PRIMARY_HOST</span><span class="w"> </span><span class="s2">&quot;ip addr del </span><span class="nv">$VIP</span><span class="s2">/24 dev eth0&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null
<span class="w">    </span><span class="c1"># Assign VIP to new Primary</span>
<span class="w">    </span>ssh<span class="w"> </span><span class="nv">$STANDBY_HOST</span><span class="w"> </span><span class="s2">&quot;ip addr add </span><span class="nv">$VIP</span><span class="s2">/24 dev eth0&quot;</span>
<span class="o">}</span>

<span class="c1"># Main logic</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>check_primary<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Primary failure detected, starting failover...&quot;</span>
<span class="w">    </span>promote_standby
<span class="w">    </span>sleep<span class="w"> </span><span class="m">5</span>
<span class="w">    </span>move_vip
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Failover complete&quot;</span>
<span class="k">fi</span>
</code></pre></div>

<hr />
<h2 id="6-high-availability-solutions">6. High Availability Solutions<a class="header-link" href="#6-high-availability-solutions" title="Permanent link">&para;</a></h2>
<h3 id="61-patroni">6.1 Patroni<a class="header-link" href="#61-patroni" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># patroni.yml</span>
<span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-cluster</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1</span>

<span class="nt">restapi</span><span class="p">:</span>
<span class="w">  </span><span class="nt">listen</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0.0.0:8008</span>
<span class="w">  </span><span class="nt">connect_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1:8008</span>

<span class="nt">etcd</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">etcd1:2379,etcd2:2379,etcd3:2379</span>

<span class="nt">bootstrap</span><span class="p">:</span>
<span class="w">  </span><span class="nt">dcs</span><span class="p">:</span>
<span class="w">    </span><span class="nt">ttl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<span class="w">    </span><span class="nt">loop_wait</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">    </span><span class="nt">retry_timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">    </span><span class="nt">maximum_lag_on_failover</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1048576</span>
<span class="w">    </span><span class="nt">postgresql</span><span class="p">:</span>
<span class="w">      </span><span class="nt">use_pg_rewind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">parameters</span><span class="p">:</span>
<span class="w">        </span><span class="nt">wal_level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replica</span>
<span class="w">        </span><span class="nt">hot_standby</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">on</span>
<span class="w">        </span><span class="nt">max_wal_senders</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">        </span><span class="nt">max_replication_slots</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">        </span><span class="nt">wal_keep_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1GB</span>

<span class="w">  </span><span class="nt">initdb</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">encoding</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">UTF8</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data-checksums</span>

<span class="nt">postgresql</span><span class="p">:</span>
<span class="w">  </span><span class="nt">listen</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0.0.0:5432</span>
<span class="w">  </span><span class="nt">connect_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1:5432</span>
<span class="w">  </span><span class="nt">data_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/postgresql/data</span>
<span class="w">  </span><span class="nt">authentication</span><span class="p">:</span>
<span class="w">    </span><span class="nt">replication</span><span class="p">:</span>
<span class="w">      </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replicator</span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rep_password</span>
<span class="w">    </span><span class="nt">superuser</span><span class="p">:</span>
<span class="w">      </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_password</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Check Patroni cluster status</span>
patronictl<span class="w"> </span>-c<span class="w"> </span>/etc/patroni/patroni.yml<span class="w"> </span>list

<span class="c1"># Manual switchover</span>
patronictl<span class="w"> </span>-c<span class="w"> </span>/etc/patroni/patroni.yml<span class="w"> </span>switchover

<span class="c1"># Manual failover (forcibly remove Primary)</span>
patronictl<span class="w"> </span>-c<span class="w"> </span>/etc/patroni/patroni.yml<span class="w"> </span>failover
</code></pre></div>

<h3 id="62-high-availability-architecture">6.2 High Availability Architecture<a class="header-link" href="#62-high-availability-architecture" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Patroni + HAProxy Architecture                  â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚   â”‚   HAProxy     â”‚ â—„â”€â”€ VIP                                    â”‚
â”‚   â”‚  (Load Bal)   â”‚                                            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚           â”‚                                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                              â”‚
â”‚     â”‚           â”‚                                              â”‚
â”‚   â”Œâ”€â”´â”€â”       â”Œâ”€â”´â”€â”       â”Œâ”€â”€â”€â”                               â”‚
â”‚   â”‚N1 â”‚       â”‚N2 â”‚       â”‚N3 â”‚    PostgreSQL + Patroni       â”‚
â”‚   â””â”€â”¬â”€â”˜       â””â”€â”¬â”€â”˜       â””â”€â”¬â”€â”˜                               â”‚
â”‚     â”‚           â”‚           â”‚                                   â”‚
â”‚   â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”                               â”‚
â”‚   â”‚      etcd Cluster          â”‚   Distributed consensus store â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="63-haproxy-configuration">6.3 HAProxy Configuration<a class="header-link" href="#63-haproxy-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> haproxy.cfg
global
    maxconn 1000

defaults
    mode tcp
    timeout connect 10s
    timeout client 30s
    timeout server 30s

listen postgres_write
    bind <span class="gs">*:5432</span>
<span class="gs">    option httpchk GET /master</span>
<span class="gs">    http-check expect status 200</span>
<span class="gs">    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions</span>
<span class="gs">    server node1 node1:5432 check port 8008</span>
<span class="gs">    server node2 node2:5432 check port 8008</span>
<span class="gs">    server node3 node3:5432 check port 8008</span>

<span class="gs">listen postgres_read</span>
<span class="gs">    bind *</span>:5433
    balance roundrobin
    option httpchk GET /replica
    http-check expect status 200
    default-server inter 3s fall 3 rise 2
    server node1 node1:5432 check port 8008
    server node2 node2:5432 check port 8008
    server node3 node3:5432 check port 8008
</code></pre></div>

<h3 id="64-integration-with-pgbouncer">6.4 Integration with PgBouncer<a class="header-link" href="#64-integration-with-pgbouncer" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># pgbouncer.ini</span>
<span class="k">[databases]</span>
<span class="na">mydb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">host=haproxy_vip port=5432 dbname=mydb</span>

<span class="k">[pgbouncer]</span>
<span class="na">listen_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0.0.0.0</span>
<span class="na">listen_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">6432</span>
<span class="na">auth_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">scram-sha-256</span>
<span class="na">auth_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/etc/pgbouncer/userlist.txt</span>
<span class="na">pool_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">transaction</span>
<span class="na">max_client_conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1000</span>
<span class="na">default_pool_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">25</span>
</code></pre></div>

<h3 id="65-cloud-environment-high-availability">6.5 Cloud Environment High Availability<a class="header-link" href="#65-cloud-environment-high-availability" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- AWS RDS: Multi-AZ automatic failover</span>
<span class="c1">-- Automatically configured when enabled</span>

<span class="c1">-- Azure Database for PostgreSQL: HA option</span>
<span class="c1">-- Select Zone-redundant HA</span>

<span class="c1">-- GCP Cloud SQL: Regional HA</span>
<span class="c1">-- Automatically configure failover replica</span>

<span class="c1">-- Application connection strings</span>
<span class="c1">-- Read/Write separation example</span>
<span class="c1">-- Primary: postgresql://primary.example.com:5432/mydb</span>
<span class="c1">-- Read: postgresql://read.example.com:5432/mydb</span>
</code></pre></div>

<hr />
<h2 id="7-practice-problems">7. Practice Problems<a class="header-link" href="#7-practice-problems" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-configure-streaming-replication">Exercise 1: Configure Streaming Replication<a class="header-link" href="#exercise-1-configure-streaming-replication" title="Permanent link">&para;</a></h3>
<p>Set up Primary-Standby configuration using Docker.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># docker-compose.yml</span>
version:<span class="w"> </span><span class="s1">&#39;3.8&#39;</span>
services:
<span class="w">  </span>primary:
<span class="w">    </span>image:<span class="w"> </span>postgres:16
<span class="w">    </span>environment:
<span class="w">      </span>POSTGRES_PASSWORD:<span class="w"> </span>postgres
<span class="w">      </span>POSTGRES_INITDB_ARGS:<span class="w"> </span><span class="s2">&quot;--data-checksums&quot;</span>
<span class="w">    </span>command:<span class="w"> </span><span class="p">|</span>
<span class="w">      </span>postgres
<span class="w">      </span>-c<span class="w"> </span><span class="nv">wal_level</span><span class="o">=</span>replica
<span class="w">      </span>-c<span class="w"> </span><span class="nv">max_wal_senders</span><span class="o">=</span><span class="m">3</span>
<span class="w">      </span>-c<span class="w"> </span><span class="nv">max_replication_slots</span><span class="o">=</span><span class="m">3</span>
<span class="w">      </span>-c<span class="w"> </span><span class="nv">hot_standby</span><span class="o">=</span>on
<span class="w">    </span>ports:
<span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;5432:5432&quot;</span>
<span class="w">    </span>volumes:
<span class="w">      </span>-<span class="w"> </span>primary_data:/var/lib/postgresql/data

<span class="w">  </span>standby:
<span class="w">    </span>image:<span class="w"> </span>postgres:16
<span class="w">    </span>environment:
<span class="w">      </span>POSTGRES_PASSWORD:<span class="w"> </span>postgres
<span class="w">      </span>PGDATA:<span class="w"> </span>/var/lib/postgresql/data
<span class="w">    </span>depends_on:
<span class="w">      </span>-<span class="w"> </span>primary
<span class="w">    </span><span class="c1"># standby initialization script required</span>
<span class="w">    </span>ports:
<span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;5433:5432&quot;</span>
<span class="w">    </span>volumes:
<span class="w">      </span>-<span class="w"> </span>standby_data:/var/lib/postgresql/data

volumes:
<span class="w">  </span>primary_data:
<span class="w">  </span>standby_data:
</code></pre></div>

<h3 id="exercise-2-configure-logical-replication">Exercise 2: Configure Logical Replication<a class="header-link" href="#exercise-2-configure-logical-replication" title="Permanent link">&para;</a></h3>
<p>Set up logical replication to replicate only specific tables.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Publisher (source_db)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">price</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
<span class="w">    </span><span class="n">category</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">category</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span>
<span class="w">    </span><span class="p">(</span><span class="s1">&#39;Laptop&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">999</span><span class="p">.</span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Electronics&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="p">(</span><span class="s1">&#39;Book&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="p">.</span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Books&#39;</span><span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">products_pub</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="p">;</span>

<span class="c1">-- Subscriber (target_db)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span><span class="k">LIKE</span><span class="w"> </span><span class="n">source_db</span><span class="p">.</span><span class="n">products</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">products_sub</span>
<span class="k">CONNECTION</span><span class="w"> </span><span class="s1">&#39;host=source_host dbname=source_db user=replicator&#39;</span>
<span class="n">PUBLICATION</span><span class="w"> </span><span class="n">products_pub</span><span class="p">;</span>
</code></pre></div>

<h3 id="exercise-3-replication-monitoring-dashboard">Exercise 3: Replication Monitoring Dashboard<a class="header-link" href="#exercise-3-replication-monitoring-dashboard" title="Permanent link">&para;</a></h3>
<p>Write a query that comprehensively shows replication status.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Example answer</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="s1">&#39;Replication Lag&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">metric</span><span class="p">,</span>
<span class="w">    </span><span class="k">COALESCE</span><span class="p">(</span>
<span class="w">        </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_wal_lsn_diff</span><span class="p">(</span><span class="n">sent_lsn</span><span class="p">,</span><span class="w"> </span><span class="n">replay_lsn</span><span class="p">))</span>
<span class="w">         </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_replication</span>
<span class="w">         </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">        </span><span class="s1">&#39;No standby&#39;</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">value</span>
<span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="s1">&#39;Standby Count&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)::</span><span class="nb">text</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_replication</span><span class="p">)</span>
<span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="s1">&#39;Replication Slots&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)::</span><span class="nb">text</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_replication_slots</span><span class="p">);</span>
</code></pre></div>

<hr />
<h2 id="next-steps">Next Steps<a class="header-link" href="#next-steps" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="./17_Window_Functions.md">17. Window Functions and Analytics</a></li>
<li><a href="./18_Table_Partitioning.md">18. Table Partitioning</a></li>
</ul>
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://www.postgresql.org/docs/current/high-availability.html">PostgreSQL Replication</a></li>
<li><a href="https://www.postgresql.org/docs/current/logical-replication.html">Logical Replication</a></li>
<li><a href="https://patroni.readthedocs.io/">Patroni Documentation</a></li>
<li><a href="https://www.postgresql.org/docs/current/app-pgbasebackup.html">pg_basebackup</a></li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/PostgreSQL/15_Query_Optimization.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">15. Advanced PostgreSQL Query Optimization</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/PostgreSQL/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/PostgreSQL/17_Window_Functions.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">17. Window Functions & Analytics Queries</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}