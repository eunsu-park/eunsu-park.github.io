{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>20. Security and Access Control - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/PostgreSQL/">PostgreSQL</a>
    <span class="separator">/</span>
    <span class="current">20. Security and Access Control</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>20. Security and Access Control</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/PostgreSQL/19_Full_Text_Search.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">19. Full-Text Search</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/PostgreSQL/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-security-overview">1. Security Overview</a><ul>
<li><a href="#11-postgresql-security-layers">1.1 PostgreSQL Security Layers</a></li>
</ul>
</li>
<li><a href="#2-roles-and-privileges">2. Roles and Privileges</a><ul>
<li><a href="#21-role-management">2.1 Role Management</a></li>
<li><a href="#22-object-privileges">2.2 Object Privileges</a></li>
<li><a href="#23-column-level-privileges">2.3 Column-Level Privileges</a></li>
<li><a href="#24-inspecting-privileges">2.4 Inspecting Privileges</a></li>
</ul>
</li>
<li><a href="#3-row-level-security-rls">3. Row-Level Security (RLS)</a><ul>
<li><a href="#31-rls-basics">3.1 RLS Basics</a></li>
<li><a href="#32-policy-types">3.2 Policy Types</a></li>
<li><a href="#33-multi-tenant-rls">3.3 Multi-Tenant RLS</a></li>
<li><a href="#34-department-based-access">3.4 Department-Based Access</a></li>
</ul>
</li>
<li><a href="#4-authentication-pg_hbaconf">4. Authentication (pg_hba.conf)</a><ul>
<li><a href="#41-pg_hbaconf-structure">4.1 pg_hba.conf Structure</a></li>
<li><a href="#42-authentication-methods">4.2 Authentication Methods</a></li>
<li><a href="#43-password-management">4.3 Password Management</a></li>
<li><a href="#44-reload-configuration">4.4 Reload Configuration</a></li>
</ul>
</li>
<li><a href="#5-ssltls-connections">5. SSL/TLS Connections</a><ul>
<li><a href="#51-enable-ssl">5.1 Enable SSL</a></li>
<li><a href="#52-client-certificate-authentication">5.2 Client Certificate Authentication</a></li>
<li><a href="#53-verify-ssl-connection">5.3 Verify SSL Connection</a></li>
</ul>
</li>
<li><a href="#6-audit-logging">6. Audit Logging</a><ul>
<li><a href="#61-basic-logging-postgresqlconf">6.1 Basic Logging (postgresql.conf)</a></li>
<li><a href="#62-pgaudit-extension">6.2 pgAudit Extension</a></li>
<li><a href="#63-custom-audit-table">6.3 Custom Audit Table</a></li>
</ul>
</li>
<li><a href="#7-security-best-practices">7. Security Best Practices</a><ul>
<li><a href="#71-principle-of-least-privilege">7.1 Principle of Least Privilege</a></li>
<li><a href="#72-sql-injection-prevention">7.2 SQL Injection Prevention</a></li>
<li><a href="#73-data-encryption">7.3 Data Encryption</a></li>
<li><a href="#74-connection-security-checklist">7.4 Connection Security Checklist</a></li>
</ul>
</li>
<li><a href="#8-practice-problems">8. Practice Problems</a><ul>
<li><a href="#exercise-1-multi-tenant-application">Exercise 1: Multi-Tenant Application</a></li>
<li><a href="#exercise-2-audit-system">Exercise 2: Audit System</a></li>
<li><a href="#exercise-3-role-hierarchy">Exercise 3: Role Hierarchy</a></li>
</ul>
</li>
<li><a href="#next-steps">Next Steps</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="20-security-and-access-control">20. Security and Access Control<a class="header-link" href="#20-security-and-access-control" title="Permanent link">&para;</a></h1>
<h2 id="learning-objectives">Learning Objectives<a class="header-link" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<ul>
<li>Manage roles and privileges effectively</li>
<li>Implement Row-Level Security (RLS)</li>
<li>Configure pg_hba.conf for authentication</li>
<li>Set up SSL/TLS encrypted connections</li>
<li>Enable audit logging for compliance</li>
<li>Apply security best practices</li>
</ul>
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-security-overview">Security Overview</a></li>
<li><a href="#2-roles-and-privileges">Roles and Privileges</a></li>
<li><a href="#3-row-level-security-rls">Row-Level Security (RLS)</a></li>
<li><a href="#4-authentication-pg_hbaconf">Authentication (pg_hba.conf)</a></li>
<li><a href="#5-ssltls-connections">SSL/TLS Connections</a></li>
<li><a href="#6-audit-logging">Audit Logging</a></li>
<li><a href="#7-security-best-practices">Security Best Practices</a></li>
<li><a href="#8-practice-problems">Practice Problems</a></li>
</ol>
<hr />
<h2 id="1-security-overview">1. Security Overview<a class="header-link" href="#1-security-overview" title="Permanent link">&para;</a></h2>
<h3 id="11-postgresql-security-layers">1.1 PostgreSQL Security Layers<a class="header-link" href="#11-postgresql-security-layers" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="nx">PostgreSQL</span><span class="w"> </span><span class="nx">Security</span><span class="w"> </span><span class="nx">Architecture</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Layer</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nx">Network</span><span class="w"> </span><span class="nx">Security</span><span class="w">                           </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Firewall</span><span class="p">,</span><span class="w"> </span><span class="nx">listen_addresses</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="w">             </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                      </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Layer</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nx">Authentication</span><span class="w"> </span><span class="p">(</span><span class="nx">pg_hba</span><span class="p">.</span><span class="nx">conf</span><span class="p">)</span><span class="w">               </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Who</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">connect</span><span class="p">?</span><span class="w"> </span><span class="nx">From</span><span class="w"> </span><span class="k">where</span><span class="p">?</span><span class="w"> </span><span class="nx">How</span><span class="p">?</span><span class="w">            </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                      </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Layer</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="nx">Authorization</span><span class="w"> </span><span class="p">(</span><span class="nx">GRANT</span><span class="o">/</span><span class="nx">REVOKE</span><span class="p">)</span><span class="w">               </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Object</span><span class="o">-</span><span class="nx">level</span><span class="w"> </span><span class="nx">privileges</span><span class="w">                      </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                      </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Layer</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="nx">Row</span><span class="o">-</span><span class="nx">Level</span><span class="w"> </span><span class="nx">Security</span><span class="w"> </span><span class="p">(</span><span class="nx">RLS</span><span class="p">)</span><span class="w">                   </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Row</span><span class="o">-</span><span class="nx">level</span><span class="w"> </span><span class="nx">access</span><span class="w"> </span><span class="nx">control</span><span class="w"> </span><span class="nx">policies</span><span class="w">            </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                      </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Layer</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="nx">Column</span><span class="o">-</span><span class="nx">Level</span><span class="w"> </span><span class="nx">Security</span><span class="w">                      </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Column</span><span class="o">-</span><span class="nx">specific</span><span class="w"> </span><span class="nx">GRANT</span><span class="w">                        </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                      </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Layer</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="nx">Encryption</span><span class="w">                                 </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">SSL</span><span class="o">/</span><span class="nx">TLS</span><span class="p">,</span><span class="w"> </span><span class="nx">pgcrypto</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="o">-</span><span class="nx">at</span><span class="o">-</span><span class="nx">rest</span><span class="w">              </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="2-roles-and-privileges">2. Roles and Privileges<a class="header-link" href="#2-roles-and-privileges" title="Permanent link">&para;</a></h2>
<h3 id="21-role-management">2.1 Role Management<a class="header-link" href="#21-role-management" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Create roles</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">app_reader</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;secure_password&#39;</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">app_writer</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;secure_password&#39;</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">app_admin</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;secure_password&#39;</span><span class="w"> </span><span class="n">CREATEROLE</span><span class="p">;</span>

<span class="c1">-- Group roles (no LOGIN)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">readonly_group</span><span class="w"> </span><span class="n">NOLOGIN</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">readwrite_group</span><span class="w"> </span><span class="n">NOLOGIN</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">admin_group</span><span class="w"> </span><span class="n">NOLOGIN</span><span class="p">;</span>

<span class="c1">-- Role membership</span>
<span class="k">GRANT</span><span class="w"> </span><span class="n">readonly_group</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">app_reader</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="n">readwrite_group</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">app_writer</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="n">admin_group</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">app_admin</span><span class="p">;</span>

<span class="c1">-- Role attributes</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">app_reader</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">statement_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;30s&#39;</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">app_writer</span><span class="w"> </span><span class="k">CONNECTION</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">app_admin</span><span class="w"> </span><span class="k">VALID</span><span class="w"> </span><span class="k">UNTIL</span><span class="w"> </span><span class="s1">&#39;2026-12-31&#39;</span><span class="p">;</span>
</code></pre></div>

<h3 id="22-object-privileges">2.2 Object Privileges<a class="header-link" href="#22-object-privileges" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Schema privileges</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">USAGE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">readonly_group</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">admin_group</span><span class="p">;</span>

<span class="c1">-- Table privileges</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">readonly_group</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="k">INSERT</span><span class="p">,</span><span class="w"> </span><span class="k">UPDATE</span><span class="p">,</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">readwrite_group</span><span class="p">;</span>

<span class="c1">-- Default privileges for future objects</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span>
<span class="w">    </span><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">readonly_group</span><span class="p">;</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span>
<span class="w">    </span><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="k">INSERT</span><span class="p">,</span><span class="w"> </span><span class="k">UPDATE</span><span class="p">,</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">readwrite_group</span><span class="p">;</span>

<span class="c1">-- Sequence privileges</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">USAGE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">SEQUENCES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">readwrite_group</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span>
<span class="w">    </span><span class="k">GRANT</span><span class="w"> </span><span class="k">USAGE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">SEQUENCES</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">readwrite_group</span><span class="p">;</span>

<span class="c1">-- Function privileges</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">FUNCTIONS</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">readwrite_group</span><span class="p">;</span>
</code></pre></div>

<h3 id="23-column-level-privileges">2.3 Column-Level Privileges<a class="header-link" href="#23-column-level-privileges" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Grant access to specific columns only</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">email</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
<span class="w">    </span><span class="n">ssn</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">);</span>

<span class="c1">-- HR can see everything</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">hr_role</span><span class="p">;</span>

<span class="c1">-- Managers can see non-sensitive columns</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">manager_role</span><span class="p">;</span>

<span class="c1">-- Revoke access</span>
<span class="k">REVOKE</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="p">(</span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="n">ssn</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">manager_role</span><span class="p">;</span>
</code></pre></div>

<h3 id="24-inspecting-privileges">2.4 Inspecting Privileges<a class="header-link" href="#24-inspecting-privileges" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Check table privileges</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">grantee</span><span class="p">,</span><span class="w"> </span><span class="n">privilege_type</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">role_table_grants</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;employees&#39;</span><span class="p">;</span>

<span class="c1">-- Check column privileges</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">grantee</span><span class="p">,</span><span class="w"> </span><span class="k">column_name</span><span class="p">,</span><span class="w"> </span><span class="n">privilege_type</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">column_privileges</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;employees&#39;</span><span class="p">;</span>

<span class="c1">-- List role memberships</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">rolname</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">role</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">rolname</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">member</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_auth_members</span><span class="w"> </span><span class="n">am</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">pg_roles</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">am</span><span class="p">.</span><span class="n">roleid</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">pg_roles</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">am</span><span class="p">.</span><span class="n">member</span><span class="p">;</span>

<span class="c1">-- Check current user&#39;s privileges</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">has_table_privilege</span><span class="p">(</span><span class="s1">&#39;app_reader&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;employees&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SELECT&#39;</span><span class="p">);</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">has_schema_privilege</span><span class="p">(</span><span class="s1">&#39;app_reader&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;public&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;USAGE&#39;</span><span class="p">);</span>
</code></pre></div>

<hr />
<h2 id="3-row-level-security-rls">3. Row-Level Security (RLS)<a class="header-link" href="#3-row-level-security-rls" title="Permanent link">&para;</a></h2>
<h3 id="31-rls-basics">3.1 RLS Basics<a class="header-link" href="#31-rls-basics" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Enable RLS on a table</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">documents</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">title</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">content</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">owner_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">current_user</span><span class="p">,</span>
<span class="w">    </span><span class="n">department</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">is_public</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">FALSE</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">documents</span><span class="w"> </span><span class="n">ENABLE</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">LEVEL</span><span class="w"> </span><span class="k">SECURITY</span><span class="p">;</span>

<span class="c1">-- Policy: users can only see their own documents or public ones</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">documents_select</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">documents</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">owner_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">current_user</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">is_public</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span><span class="p">);</span>

<span class="c1">-- Policy: users can only modify their own documents</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">documents_modify</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">documents</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">ALL</span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">owner_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">current_user</span><span class="p">)</span>
<span class="w">    </span><span class="k">WITH</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">owner_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">current_user</span><span class="p">);</span>
</code></pre></div>

<h3 id="32-policy-types">3.2 Policy Types<a class="header-link" href="#32-policy-types" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- USING: filters rows for SELECT, UPDATE (existing rows), DELETE</span>
<span class="c1">-- WITH CHECK: validates rows for INSERT, UPDATE (new rows)</span>

<span class="c1">-- Insert policy</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">documents_insert</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">documents</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">INSERT</span>
<span class="w">    </span><span class="k">WITH</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">owner_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">current_user</span><span class="p">);</span>

<span class="c1">-- Update policy (separate USING and WITH CHECK)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">documents_update</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">documents</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">owner_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">current_user</span><span class="p">)</span><span class="w">           </span><span class="c1">-- can only see own rows</span>
<span class="w">    </span><span class="k">WITH</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">owner_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">current_user</span><span class="p">);</span><span class="w">     </span><span class="c1">-- can only set self as owner</span>

<span class="c1">-- Delete policy</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">documents_delete</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">documents</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">DELETE</span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">owner_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">current_user</span><span class="p">);</span>
</code></pre></div>

<h3 id="33-multi-tenant-rls">3.3 Multi-Tenant RLS<a class="header-link" href="#33-multi-tenant-rls" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Tenant isolation using application-set variable</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tenant_data</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">tenant_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">data</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tenant_data</span><span class="w"> </span><span class="n">ENABLE</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">LEVEL</span><span class="w"> </span><span class="k">SECURITY</span><span class="p">;</span>

<span class="c1">-- Policy using session variable</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">tenant_isolation</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">tenant_data</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">ALL</span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">tenant_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">&#39;app.tenant_id&#39;</span><span class="p">)::</span><span class="nb">INT</span><span class="p">)</span>
<span class="w">    </span><span class="k">WITH</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">tenant_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">&#39;app.tenant_id&#39;</span><span class="p">)::</span><span class="nb">INT</span><span class="p">);</span>

<span class="c1">-- Application sets tenant context</span>
<span class="k">SET</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="n">tenant_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;42&#39;</span><span class="p">;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tenant_data</span><span class="p">;</span><span class="w">  </span><span class="c1">-- only sees tenant 42&#39;s data</span>

<span class="c1">-- Bypass RLS for admin role</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tenant_data</span><span class="w"> </span><span class="k">FORCE</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">LEVEL</span><span class="w"> </span><span class="k">SECURITY</span><span class="p">;</span><span class="w">  </span><span class="c1">-- apply to table owner too</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">admin_bypass</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">tenant_data</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">ALL</span>
<span class="w">    </span><span class="k">TO</span><span class="w"> </span><span class="n">admin_group</span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="k">TRUE</span><span class="p">)</span>
<span class="w">    </span><span class="k">WITH</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="k">TRUE</span><span class="p">);</span>
</code></pre></div>

<h3 id="34-department-based-access">3.4 Department-Based Access<a class="header-link" href="#34-department-based-access" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Users see documents from their department + public ones</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">user_departments</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">username</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">department</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
<span class="p">);</span>

<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_departments</span><span class="w"> </span><span class="k">VALUES</span>
<span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;engineering&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;marketing&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;charlie&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;engineering&#39;</span><span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">dept_access</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">documents</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="n">is_public</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span>
<span class="w">        </span><span class="k">OR</span><span class="w"> </span><span class="n">owner_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">current_user</span>
<span class="w">        </span><span class="k">OR</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">user_departments</span>
<span class="w">            </span><span class="k">WHERE</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">current_user</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
</code></pre></div>

<hr />
<h2 id="4-authentication-pg_hbaconf">4. Authentication (pg_hba.conf)<a class="header-link" href="#4-authentication-pg_hbaconf" title="Permanent link">&para;</a></h2>
<h3 id="41-pg_hbaconf-structure">4.1 pg_hba.conf Structure<a class="header-link" href="#41-pg_hbaconf-structure" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> TYPE  DATABASE  USER       ADDRESS        METHOD

<span class="gh">#</span> Local connections
local   all       postgres                  peer
local   all       all                       scram-sha-256

<span class="gh">#</span> IPv4 connections
host    all       all        127.0.0.1/32   scram-sha-256
host    mydb      app_user   10.0.0.0/8     scram-sha-256
host    all       all        0.0.0.0/0      reject

<span class="gh">#</span> IPv6 connections
host    all       all        ::1/128        scram-sha-256

<span class="gh">#</span> SSL required
hostssl mydb      app_user   10.0.0.0/8     scram-sha-256
hostnossl all     all        0.0.0.0/0      reject
</code></pre></div>

<h3 id="42-authentication-methods">4.2 Authentication Methods<a class="header-link" href="#42-authentication-methods" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Method         â”‚ Description                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ trust          â”‚ No authentication (NEVER in production)           â”‚
â”‚ reject         â”‚ Always reject connection                          â”‚
â”‚ scram-sha-256  â”‚ Challenge-response (recommended)                  â”‚
â”‚ md5            â”‚ MD5 hash (legacy, use scram-sha-256 instead)     â”‚
â”‚ password       â”‚ Cleartext (NEVER use)                             â”‚
â”‚ peer           â”‚ OS user = PG user (local only)                   â”‚
â”‚ ident          â”‚ OS user mapping (TCP/IP)                          â”‚
â”‚ cert           â”‚ SSL client certificate                            â”‚
â”‚ ldap           â”‚ LDAP server authentication                        â”‚
â”‚ gss            â”‚ Kerberos/GSSAPI                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="43-password-management">4.3 Password Management<a class="header-link" href="#43-password-management" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Use scram-sha-256 (default in PG 14+)</span>
<span class="k">SET</span><span class="w"> </span><span class="n">password_encryption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;scram-sha-256&#39;</span><span class="p">;</span>

<span class="c1">-- Create user with encrypted password</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">app_user</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;strong_password_here&#39;</span><span class="p">;</span>

<span class="c1">-- Force password change</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">app_user</span><span class="w"> </span><span class="k">VALID</span><span class="w"> </span><span class="k">UNTIL</span><span class="w"> </span><span class="s1">&#39;2026-03-01&#39;</span><span class="p">;</span>

<span class="c1">-- Check password encryption method</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">rolname</span><span class="p">,</span><span class="w"> </span><span class="n">rolpassword</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s1">&#39;^SCRAM-SHA-256&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">is_scram</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_authid</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">rolcanlogin</span><span class="p">;</span>
</code></pre></div>

<h3 id="44-reload-configuration">4.4 Reload Configuration<a class="header-link" href="#44-reload-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># After editing pg_hba.conf, reload:</span>
pg_ctl<span class="w"> </span>reload<span class="w"> </span>-D<span class="w"> </span>/path/to/data

<span class="c1"># Or from SQL:</span>
<span class="c1"># SELECT pg_reload_conf();</span>

<span class="c1"># Verify current settings</span>
<span class="c1"># SELECT * FROM pg_hba_file_rules;  -- PG 15+</span>
</code></pre></div>

<hr />
<h2 id="5-ssltls-connections">5. SSL/TLS Connections<a class="header-link" href="#5-ssltls-connections" title="Permanent link">&para;</a></h2>
<h3 id="51-enable-ssl">5.1 Enable SSL<a class="header-link" href="#51-enable-ssl" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Generate self-signed certificate</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-x509<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span>-nodes<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-out<span class="w"> </span>server.crt<span class="w"> </span>-keyout<span class="w"> </span>server.key<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=postgres-server&quot;</span>

chmod<span class="w"> </span><span class="m">600</span><span class="w"> </span>server.key
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="gh">#</span> postgresql.conf
ssl = on
ssl_cert_file = &#39;server.crt&#39;
ssl_key_file = &#39;server.key&#39;
ssl_min_protocol_version = &#39;TLSv1.2&#39;
ssl_ciphers = &#39;HIGH:MEDIUM:+3DES:!aNULL&#39;
</code></pre></div>

<h3 id="52-client-certificate-authentication">5.2 Client Certificate Authentication<a class="header-link" href="#52-client-certificate-authentication" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Generate CA</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-x509<span class="w"> </span>-days<span class="w"> </span><span class="m">3650</span><span class="w"> </span>-nodes<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-out<span class="w"> </span>root.crt<span class="w"> </span>-keyout<span class="w"> </span>root.key<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=MyCA&quot;</span>

<span class="c1"># Generate client certificate</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-nodes<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-out<span class="w"> </span>client.csr<span class="w"> </span>-keyout<span class="w"> </span>client.key<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=app_user&quot;</span>

openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-in<span class="w"> </span>client.csr<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-CA<span class="w"> </span>root.crt<span class="w"> </span>-CAkey<span class="w"> </span>root.key<span class="w"> </span>-CAcreateserial<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-out<span class="w"> </span>client.crt
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="gh">#</span> pg_hba.conf â€” require client certificate
hostssl mydb  app_user  10.0.0.0/8  cert  clientcert=verify-full
</code></pre></div>

<h3 id="53-verify-ssl-connection">5.3 Verify SSL Connection<a class="header-link" href="#53-verify-ssl-connection" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Check if current connection uses SSL</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="k">version</span><span class="p">,</span><span class="w"> </span><span class="n">cipher</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_ssl</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pg_backend_pid</span><span class="p">();</span>

<span class="c1">-- Check all SSL connections</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="k">version</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">cipher</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">usename</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">client_addr</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_ssl</span><span class="w"> </span><span class="n">s</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">pg_stat_activity</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">pid</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">ssl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>
</code></pre></div>

<hr />
<h2 id="6-audit-logging">6. Audit Logging<a class="header-link" href="#6-audit-logging" title="Permanent link">&para;</a></h2>
<h3 id="61-basic-logging-postgresqlconf">6.1 Basic Logging (postgresql.conf)<a class="header-link" href="#61-basic-logging-postgresqlconf" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> postgresql.conf
log_statement = &#39;all&#39;           # none, ddl, mod, all
log_min_duration_statement = 0  # log all statements with duration
log_connections = on
log_disconnections = on
log_line_prefix = &#39;%t [%p] %u@%d &#39;  # timestamp, pid, user, database
</code></pre></div>

<h3 id="62-pgaudit-extension">6.2 pgAudit Extension<a class="header-link" href="#62-pgaudit-extension" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Install pgAudit (must be in shared_preload_libraries)</span>
<span class="c1">-- postgresql.conf: shared_preload_libraries = &#39;pgaudit&#39;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">pgaudit</span><span class="p">;</span>

<span class="c1">-- Configure audit logging</span>
<span class="k">SET</span><span class="w"> </span><span class="n">pgaudit</span><span class="p">.</span><span class="n">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;write, ddl&#39;</span><span class="p">;</span><span class="w">        </span><span class="c1">-- log writes and DDL</span>
<span class="k">SET</span><span class="w"> </span><span class="n">pgaudit</span><span class="p">.</span><span class="n">log_catalog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w">          </span><span class="c1">-- skip system catalog queries</span>
<span class="k">SET</span><span class="w"> </span><span class="n">pgaudit</span><span class="p">.</span><span class="n">log_relation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">on</span><span class="p">;</span><span class="w">          </span><span class="c1">-- log object names</span>
<span class="k">SET</span><span class="w"> </span><span class="n">pgaudit</span><span class="p">.</span><span class="n">log_statement_once</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">on</span><span class="p">;</span><span class="w">    </span><span class="c1">-- log statement only once</span>

<span class="c1">-- Role-based auditing</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">auditor</span><span class="w"> </span><span class="n">NOLOGIN</span><span class="p">;</span>
<span class="k">SET</span><span class="w"> </span><span class="n">pgaudit</span><span class="p">.</span><span class="k">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;auditor&#39;</span><span class="p">;</span>

<span class="c1">-- Grant audit on specific tables</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="k">INSERT</span><span class="p">,</span><span class="w"> </span><span class="k">UPDATE</span><span class="p">,</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">auditor</span><span class="p">;</span>
<span class="c1">-- Now all DML on employees is audited</span>
</code></pre></div>

<h3 id="63-custom-audit-table">6.3 Custom Audit Table<a class="header-link" href="#63-custom-audit-table" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Simple audit trail</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">audit_log</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="k">table_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">operation</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- INSERT, UPDATE, DELETE</span>
<span class="w">    </span><span class="n">old_data</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="n">new_data</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="n">changed_by</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">current_user</span><span class="p">,</span>
<span class="w">    </span><span class="n">changed_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">-- Generic audit trigger</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">audit_trigger_func</span><span class="p">()</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">$$</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">TG_OP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;INSERT&#39;</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">audit_log</span><span class="w"> </span><span class="p">(</span><span class="k">table_name</span><span class="p">,</span><span class="w"> </span><span class="k">operation</span><span class="p">,</span><span class="w"> </span><span class="n">new_data</span><span class="p">)</span>
<span class="w">        </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="n">TG_TABLE_NAME</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;INSERT&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">to_jsonb</span><span class="p">(</span><span class="k">NEW</span><span class="p">));</span>
<span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="k">NEW</span><span class="p">;</span>
<span class="w">    </span><span class="k">ELSIF</span><span class="w"> </span><span class="n">TG_OP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;UPDATE&#39;</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">audit_log</span><span class="w"> </span><span class="p">(</span><span class="k">table_name</span><span class="p">,</span><span class="w"> </span><span class="k">operation</span><span class="p">,</span><span class="w"> </span><span class="n">old_data</span><span class="p">,</span><span class="w"> </span><span class="n">new_data</span><span class="p">)</span>
<span class="w">        </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="n">TG_TABLE_NAME</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;UPDATE&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">to_jsonb</span><span class="p">(</span><span class="k">OLD</span><span class="p">),</span><span class="w"> </span><span class="n">to_jsonb</span><span class="p">(</span><span class="k">NEW</span><span class="p">));</span>
<span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="k">NEW</span><span class="p">;</span>
<span class="w">    </span><span class="k">ELSIF</span><span class="w"> </span><span class="n">TG_OP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;DELETE&#39;</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">audit_log</span><span class="w"> </span><span class="p">(</span><span class="k">table_name</span><span class="p">,</span><span class="w"> </span><span class="k">operation</span><span class="p">,</span><span class="w"> </span><span class="n">old_data</span><span class="p">)</span>
<span class="w">        </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="n">TG_TABLE_NAME</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">to_jsonb</span><span class="p">(</span><span class="k">OLD</span><span class="p">));</span>
<span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="k">OLD</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="p">;</span>

<span class="c1">-- Apply to tables</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">employees_audit</span>
<span class="w">    </span><span class="k">AFTER</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">employees</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">audit_trigger_func</span><span class="p">();</span>
</code></pre></div>

<hr />
<h2 id="7-security-best-practices">7. Security Best Practices<a class="header-link" href="#7-security-best-practices" title="Permanent link">&para;</a></h2>
<h3 id="71-principle-of-least-privilege">7.1 Principle of Least Privilege<a class="header-link" href="#71-principle-of-least-privilege" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 1. Revoke default public access</span>
<span class="k">REVOKE</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">PUBLIC</span><span class="p">;</span>
<span class="k">REVOKE</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">PUBLIC</span><span class="p">;</span>

<span class="c1">-- 2. Create application-specific schemas</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="n">app_schema</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">USAGE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="n">app_schema</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">app_role</span><span class="p">;</span>

<span class="c1">-- 3. Separate roles by function</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">migration_role</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;...&#39;</span><span class="p">;</span><span class="w">  </span><span class="c1">-- DDL only</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">app_role</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;...&#39;</span><span class="p">;</span><span class="w">         </span><span class="c1">-- DML only</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">report_role</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;...&#39;</span><span class="p">;</span><span class="w">      </span><span class="c1">-- SELECT only</span>

<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="k">INSERT</span><span class="p">,</span><span class="w"> </span><span class="k">UPDATE</span><span class="p">,</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="n">app_schema</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">app_role</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="n">app_schema</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">report_role</span><span class="p">;</span>
</code></pre></div>

<h3 id="72-sql-injection-prevention">7.2 SQL Injection Prevention<a class="header-link" href="#72-sql-injection-prevention" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- NEVER build queries with string concatenation</span>
<span class="c1">-- BAD:</span>
<span class="c1">-- EXECUTE &#39;SELECT * FROM users WHERE name = &#39;&#39;&#39; || user_input || &#39;&#39;&#39;&#39;;</span>

<span class="c1">-- GOOD: Use parameterized queries</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">safe_search</span><span class="p">(</span><span class="n">search_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">SETOF</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">$$</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">QUERY</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">search_name</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="p">;</span>

<span class="c1">-- GOOD: Use format() with %L for literals, %I for identifiers</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">dynamic_query</span><span class="p">(</span><span class="k">table_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">SETOF</span><span class="w"> </span><span class="n">RECORD</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">$$</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">QUERY</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">format</span><span class="p">(</span>
<span class="w">        </span><span class="s1">&#39;SELECT * FROM %I WHERE %I = %L&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="k">table_name</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>
<span class="w">    </span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="p">;</span>
</code></pre></div>

<h3 id="73-data-encryption">7.3 Data Encryption<a class="header-link" href="#73-data-encryption" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Enable pgcrypto</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">pgcrypto</span><span class="p">;</span>

<span class="c1">-- Encrypt sensitive data</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">ssn_encrypted</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Alice&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">pgp_sym_encrypt</span><span class="p">(</span><span class="s1">&#39;123-45-6789&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;encryption_key&#39;</span><span class="p">));</span>

<span class="c1">-- Decrypt</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">pgp_sym_decrypt</span><span class="p">(</span><span class="n">ssn_encrypted</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;encryption_key&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ssn</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="p">;</span>

<span class="c1">-- Hash passwords (use bcrypt)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">password_hash</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Alice&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">crypt</span><span class="p">(</span><span class="s1">&#39;user_password&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">gen_salt</span><span class="p">(</span><span class="s1">&#39;bf&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)));</span>

<span class="c1">-- Verify password</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">password_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crypt</span><span class="p">(</span><span class="s1">&#39;user_password&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">password_hash</span><span class="p">);</span>
</code></pre></div>

<h3 id="74-connection-security-checklist">7.4 Connection Security Checklist<a class="header-link" href="#74-connection-security-checklist" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="nx">Security</span><span class="w"> </span><span class="nx">Checklist</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Network</span><span class="p">:</span><span class="w">                                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â˜</span><span class="w"> </span><span class="nx">listen_addresses</span><span class="w"> </span><span class="nx">limited</span><span class="w"> </span><span class="p">(</span><span class="k">not</span><span class="w"> </span><span class="sc">&#39;*&#39;</span><span class="p">)</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â˜</span><span class="w"> </span><span class="nx">Firewall</span><span class="w"> </span><span class="nx">restricts</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="mi">5432</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â˜</span><span class="w"> </span><span class="nx">SSL</span><span class="o">/</span><span class="nx">TLS</span><span class="w"> </span><span class="nx">enabled</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">required</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Authentication</span><span class="p">:</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â˜</span><span class="w"> </span><span class="nx">scram</span><span class="o">-</span><span class="nx">sha</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nx">auth</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â˜</span><span class="w"> </span><span class="nx">No</span><span class="w"> </span><span class="nx">trust</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nx">method</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â˜</span><span class="w"> </span><span class="nx">pg_hba</span><span class="p">.</span><span class="nx">conf</span><span class="w"> </span><span class="nx">uses</span><span class="w"> </span><span class="nx">specific</span><span class="w"> </span><span class="nx">addresses</span><span class="w"> </span><span class="p">(</span><span class="k">not</span><span class="w"> </span><span class="m m-Double">0.0.0.0</span><span class="o">/</span><span class="mi">0</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Authorization</span><span class="p">:</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â˜</span><span class="w"> </span><span class="nx">PUBLIC</span><span class="w"> </span><span class="nx">schema</span><span class="w"> </span><span class="nx">privileges</span><span class="w"> </span><span class="nx">revoked</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â˜</span><span class="w"> </span><span class="nx">Least</span><span class="o">-</span><span class="nx">privilege</span><span class="w"> </span><span class="nx">roles</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â˜</span><span class="w"> </span><span class="nx">RLS</span><span class="w"> </span><span class="nx">enabled</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">multi</span><span class="o">-</span><span class="nx">tenant</span><span class="w"> </span><span class="nx">data</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Monitoring</span><span class="p">:</span><span class="w">                                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â˜</span><span class="w"> </span><span class="nx">Audit</span><span class="w"> </span><span class="nx">logging</span><span class="w"> </span><span class="nx">enabled</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â˜</span><span class="w"> </span><span class="nx">Failed</span><span class="w"> </span><span class="nx">login</span><span class="w"> </span><span class="nx">monitoring</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â˜</span><span class="w"> </span><span class="nx">Suspicious</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">detection</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Data</span><span class="p">:</span><span class="w">                                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â˜</span><span class="w"> </span><span class="nx">Sensitive</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="nx">encrypted</span><span class="w"> </span><span class="p">(</span><span class="nx">pgcrypto</span><span class="p">)</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â˜</span><span class="w"> </span><span class="nx">Passwords</span><span class="w"> </span><span class="nx">hashed</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">bcrypt</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â˜</span><span class="w"> </span><span class="nx">Regular</span><span class="w"> </span><span class="nx">backup</span><span class="w"> </span><span class="nx">encryption</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="8-practice-problems">8. Practice Problems<a class="header-link" href="#8-practice-problems" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-multi-tenant-application">Exercise 1: Multi-Tenant Application<a class="header-link" href="#exercise-1-multi-tenant-application" title="Permanent link">&para;</a></h3>
<p>Set up RLS for a SaaS application with tenant isolation.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Example answer</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tenant_orders</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">tenant_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">product</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">amount</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tenant_orders</span><span class="w"> </span><span class="n">ENABLE</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">LEVEL</span><span class="w"> </span><span class="k">SECURITY</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tenant_orders</span><span class="w"> </span><span class="k">FORCE</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">LEVEL</span><span class="w"> </span><span class="k">SECURITY</span><span class="p">;</span>

<span class="c1">-- Tenant isolation policy</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">tenant_orders_isolation</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">tenant_orders</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">ALL</span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">tenant_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">&#39;app.tenant_id&#39;</span><span class="p">)::</span><span class="nb">INT</span><span class="p">)</span>
<span class="w">    </span><span class="k">WITH</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">tenant_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">&#39;app.tenant_id&#39;</span><span class="p">)::</span><span class="nb">INT</span><span class="p">);</span>

<span class="c1">-- Admin bypass</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">tenant_orders_admin</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">tenant_orders</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">ALL</span>
<span class="w">    </span><span class="k">TO</span><span class="w"> </span><span class="n">admin_group</span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="k">TRUE</span><span class="p">);</span>

<span class="c1">-- Test</span>
<span class="k">SET</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="n">tenant_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">;</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">tenant_orders</span><span class="w"> </span><span class="p">(</span><span class="n">tenant_id</span><span class="p">,</span><span class="w"> </span><span class="n">product</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Widget&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tenant_orders</span><span class="p">;</span><span class="w">  </span><span class="c1">-- only tenant 1&#39;s orders</span>
</code></pre></div>

<h3 id="exercise-2-audit-system">Exercise 2: Audit System<a class="header-link" href="#exercise-2-audit-system" title="Permanent link">&para;</a></h3>
<p>Create a comprehensive audit system for the employees table.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Example answer</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">employee_audit</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="k">operation</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">employee_id</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">old_values</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="n">new_values</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="n">changed_fields</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">[],</span>
<span class="w">    </span><span class="n">user_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">current_user</span><span class="p">,</span>
<span class="w">    </span><span class="n">client_ip</span><span class="w"> </span><span class="n">INET</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">inet_client_addr</span><span class="p">(),</span>
<span class="w">    </span><span class="n">occurred_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">employee_audit_trigger</span><span class="p">()</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">$$</span>
<span class="k">DECLARE</span>
<span class="w">    </span><span class="n">changed</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">[]</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;{}&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">col</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">;</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">TG_OP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;UPDATE&#39;</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="k">FOR</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">column_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span>
<span class="w">                   </span><span class="k">WHERE</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;employees&#39;</span><span class="w"> </span><span class="n">LOOP</span>
<span class="w">            </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;SELECT ($1).%I IS DISTINCT FROM ($2).%I&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">)</span>
<span class="w">            </span><span class="k">INTO</span><span class="w"> </span><span class="k">STRICT</span><span class="w"> </span><span class="n">changed</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="k">NEW</span><span class="p">,</span><span class="w"> </span><span class="k">OLD</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span><span class="w"> </span><span class="n">LOOP</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>

<span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">employee_audit</span><span class="w"> </span><span class="p">(</span><span class="k">operation</span><span class="p">,</span><span class="w"> </span><span class="n">employee_id</span><span class="p">,</span><span class="w"> </span><span class="n">old_values</span><span class="p">,</span><span class="w"> </span><span class="n">new_values</span><span class="p">)</span>
<span class="w">    </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="n">TG_OP</span><span class="p">,</span>
<span class="w">        </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">OLD</span><span class="p">.</span><span class="n">id</span><span class="p">),</span>
<span class="w">        </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">TG_OP</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;INSERT&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">to_jsonb</span><span class="p">(</span><span class="k">OLD</span><span class="p">)</span><span class="w"> </span><span class="k">END</span><span class="p">,</span>
<span class="w">        </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">TG_OP</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;DELETE&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">to_jsonb</span><span class="p">(</span><span class="k">NEW</span><span class="p">)</span><span class="w"> </span><span class="k">END</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">NEW</span><span class="p">,</span><span class="w"> </span><span class="k">OLD</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">trg_employee_audit</span>
<span class="w">    </span><span class="k">AFTER</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">employees</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">employee_audit_trigger</span><span class="p">();</span>
</code></pre></div>

<h3 id="exercise-3-role-hierarchy">Exercise 3: Role Hierarchy<a class="header-link" href="#exercise-3-role-hierarchy" title="Permanent link">&para;</a></h3>
<p>Create a role hierarchy for a web application.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Example answer</span>
<span class="c1">-- Base roles</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">web_anonymous</span><span class="w"> </span><span class="n">NOLOGIN</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">web_user</span><span class="w"> </span><span class="n">NOLOGIN</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">web_admin</span><span class="w"> </span><span class="n">NOLOGIN</span><span class="p">;</span>

<span class="c1">-- Inheritance hierarchy</span>
<span class="k">GRANT</span><span class="w"> </span><span class="n">web_anonymous</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">web_user</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="n">web_user</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">web_admin</span><span class="p">;</span>

<span class="c1">-- Privileges (cumulative through inheritance)</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">USAGE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">web_anonymous</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">products</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">categories</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">web_anonymous</span><span class="p">;</span>

<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="k">INSERT</span><span class="p">,</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">orders</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">web_user</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">reviews</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">web_user</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">USAGE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">SEQUENCES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">web_user</span><span class="p">;</span>

<span class="k">GRANT</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">web_admin</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">SEQUENCES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">web_admin</span><span class="p">;</span>

<span class="c1">-- Login roles</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">api_anon</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;...&#39;</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">web_anonymous</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">api_user</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;...&#39;</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">web_user</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">api_admin</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;...&#39;</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">web_admin</span><span class="p">;</span>
</code></pre></div>

<hr />
<h2 id="next-steps">Next Steps<a class="header-link" href="#next-steps" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="./19_Full_Text_Search.md">19. Full-Text Search</a></li>
<li><a href="./15_Query_Optimization.md">15. Query Optimization</a></li>
</ul>
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://www.postgresql.org/docs/current/user-manag.html">PostgreSQL Roles</a></li>
<li><a href="https://www.postgresql.org/docs/current/ddl-rowsecurity.html">Row-Level Security</a></li>
<li><a href="https://www.postgresql.org/docs/current/auth-pg-hba-conf.html">pg_hba.conf</a></li>
<li><a href="https://www.postgresql.org/docs/current/ssl-tcp.html">SSL Support</a></li>
<li><a href="https://www.pgaudit.org/">pgAudit</a></li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/PostgreSQL/19_Full_Text_Search.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">19. Full-Text Search</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/PostgreSQL/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}