{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cryptography Basics - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Security/">Security</a>
    <span class="separator">/</span>
    <span class="current">Cryptography Basics</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Cryptography Basics</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/01_Security_Fundamentals.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Security Fundamentals and Threat Modeling</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/03_Hashing_and_Integrity.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Hashing and Data Integrity</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-cryptography-overview">1. Cryptography Overview</a><ul>
<li><a href="#11-the-landscape">1.1 The Landscape</a></li>
<li><a href="#12-key-concepts">1.2 Key Concepts</a></li>
<li><a href="#13-python-cryptography-library-setup">1.3 Python Cryptography Library Setup</a></li>
</ul>
</li>
<li><a href="#2-symmetric-encryption">2. Symmetric Encryption</a><ul>
<li><a href="#21-aes-advanced-encryption-standard">2.1 AES (Advanced Encryption Standard)</a></li>
<li><a href="#22-fernet-high-level-symmetric-encryption">2.2 Fernet: High-Level Symmetric Encryption</a></li>
</ul>
</li>
<li><a href="#3-block-cipher-modes-of-operation">3. Block Cipher Modes of Operation</a><ul>
<li><a href="#31-ecb-mode-never-use-this">3.1 ECB Mode (NEVER Use This)</a></li>
<li><a href="#32-cbc-mode-legacy-use-with-care">3.2 CBC Mode (Legacy, Use with Care)</a></li>
<li><a href="#33-ctr-mode">3.3 CTR Mode</a></li>
</ul>
</li>
<li><a href="#4-aes-gcm-the-modern-standard">4. AES-GCM: The Modern Standard</a><ul>
<li><a href="#41-aes-gcm-implementation">4.1 AES-GCM Implementation</a></li>
<li><a href="#42-file-encryption-with-aes-gcm">4.2 File Encryption with AES-GCM</a></li>
</ul>
</li>
<li><a href="#5-chacha20-poly1305">5. ChaCha20-Poly1305</a><ul>
<li><a href="#51-chacha20-poly1305-implementation">5.1 ChaCha20-Poly1305 Implementation</a></li>
<li><a href="#52-xchacha20-poly1305-extended-nonce">5.2 XChaCha20-Poly1305 (Extended Nonce)</a></li>
</ul>
</li>
<li><a href="#6-asymmetric-encryption">6. Asymmetric Encryption</a><ul>
<li><a href="#61-hybrid-encryption">6.1 Hybrid Encryption</a></li>
</ul>
</li>
<li><a href="#7-rsa">7. RSA</a><ul>
<li><a href="#71-rsa-key-generation-and-encryption">7.1 RSA Key Generation and Encryption</a></li>
<li><a href="#72-rsa-hybrid-encryption">7.2 RSA Hybrid Encryption</a></li>
</ul>
</li>
<li><a href="#8-elliptic-curve-cryptography">8. Elliptic Curve Cryptography</a><ul>
<li><a href="#81-ecdsa-elliptic-curve-digital-signature-algorithm">8.1 ECDSA (Elliptic Curve Digital Signature Algorithm)</a></li>
<li><a href="#82-ed25519-modern-signature-algorithm">8.2 Ed25519 (Modern Signature Algorithm)</a></li>
</ul>
</li>
<li><a href="#9-key-exchange">9. Key Exchange</a><ul>
<li><a href="#91-diffie-hellman-key-exchange">9.1 Diffie-Hellman Key Exchange</a></li>
<li><a href="#92-ecdh-elliptic-curve-diffie-hellman">9.2 ECDH (Elliptic Curve Diffie-Hellman)</a></li>
<li><a href="#93-x25519-key-exchange">9.3 X25519 Key Exchange</a></li>
</ul>
</li>
<li><a href="#10-digital-signatures">10. Digital Signatures</a><ul>
<li><a href="#101-how-digital-signatures-work">10.1 How Digital Signatures Work</a></li>
<li><a href="#102-practical-document-signing-system">10.2 Practical: Document Signing System</a></li>
</ul>
</li>
<li><a href="#11-common-pitfalls-and-how-to-avoid-them">11. Common Pitfalls and How to Avoid Them</a><ul>
<li><a href="#111-the-deadly-sins-of-cryptography">11.1 The Deadly Sins of Cryptography</a></li>
<li><a href="#112-nonce-reuse-disaster">11.2 Nonce Reuse Disaster</a></li>
<li><a href="#113-secure-vs-insecure-random">11.3 Secure vs Insecure Random</a></li>
</ul>
</li>
<li><a href="#12-modern-recommendations">12. Modern Recommendations</a><ul>
<li><a href="#121-algorithm-selection-guide-2025">12.1 Algorithm Selection Guide (2025+)</a></li>
<li><a href="#122-key-size-recommendations">12.2 Key Size Recommendations</a></li>
<li><a href="#123-post-quantum-cryptography">12.3 Post-Quantum Cryptography</a></li>
</ul>
</li>
<li><a href="#13-exercises">13. Exercises</a><ul>
<li><a href="#exercise-1-symmetric-encryption-beginner">Exercise 1: Symmetric Encryption (Beginner)</a></li>
<li><a href="#exercise-2-hybrid-encryption-intermediate">Exercise 2: Hybrid Encryption (Intermediate)</a></li>
<li><a href="#exercise-3-key-exchange-protocol-intermediate">Exercise 3: Key Exchange Protocol (Intermediate)</a></li>
<li><a href="#exercise-4-nonce-reuse-attack-advanced">Exercise 4: Nonce Reuse Attack (Advanced)</a></li>
<li><a href="#exercise-5-digital-signature-verification-advanced">Exercise 5: Digital Signature Verification (Advanced)</a></li>
<li><a href="#exercise-6-cryptographic-audit-advanced">Exercise 6: Cryptographic Audit (Advanced)</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="cryptography-basics">Cryptography Basics<a class="header-link" href="#cryptography-basics" title="Permanent link">&para;</a></h1>
<p><strong>Previous</strong>: <a href="./01_Security_Fundamentals.md">01. Security Fundamentals</a> | <strong>Next</strong>: <a href="./03_Hashing_and_Integrity.md">03. Hashing and Data Integrity</a></p>
<hr />
<p>Cryptography is the practice of securing communication and data so that only intended parties can access it. This lesson covers the two main branches of modern cryptography -- symmetric and asymmetric encryption -- along with key exchange protocols, digital signatures, and practical Python implementations. By the end, you will be able to choose the right cryptographic primitive for a given problem and avoid the most common pitfalls.</p>
<p><strong>Difficulty</strong>: â­â­â­</p>
<p><strong>Learning Objectives</strong>:
- Understand the difference between symmetric and asymmetric encryption
- Implement AES-GCM and ChaCha20-Poly1305 encryption in Python
- Understand RSA, ECDSA, and Ed25519 for asymmetric cryptography
- Implement Diffie-Hellman and ECDH key exchange
- Create and verify digital signatures
- Recognize and avoid common cryptographic pitfalls
- Apply modern cryptographic recommendations</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-cryptography-overview">Cryptography Overview</a></li>
<li><a href="#2-symmetric-encryption">Symmetric Encryption</a></li>
<li><a href="#3-block-cipher-modes-of-operation">Block Cipher Modes of Operation</a></li>
<li><a href="#4-aes-gcm-the-modern-standard">AES-GCM: The Modern Standard</a></li>
<li><a href="#5-chacha20-poly1305">ChaCha20-Poly1305</a></li>
<li><a href="#6-asymmetric-encryption">Asymmetric Encryption</a></li>
<li><a href="#7-rsa">RSA</a></li>
<li><a href="#8-elliptic-curve-cryptography">Elliptic Curve Cryptography</a></li>
<li><a href="#9-key-exchange">Key Exchange</a></li>
<li><a href="#10-digital-signatures">Digital Signatures</a></li>
<li><a href="#11-common-pitfalls-and-how-to-avoid-them">Common Pitfalls and How to Avoid Them</a></li>
<li><a href="#12-modern-recommendations">Modern Recommendations</a></li>
<li><a href="#13-exercises">Exercises</a></li>
<li><a href="#14-references">References</a></li>
</ol>
<hr />
<h2 id="1-cryptography-overview">1. Cryptography Overview<a class="header-link" href="#1-cryptography-overview" title="Permanent link">&para;</a></h2>
<h3 id="11-the-landscape">1.1 The Landscape<a class="header-link" href="#11-the-landscape" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Modern Cryptography Taxonomy                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Cryptography                                                        â”‚
â”‚  â”œâ”€â”€ Symmetric (shared key)                                          â”‚
â”‚  â”‚   â”œâ”€â”€ Block Ciphers                                               â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ AES (128/192/256-bit key)                               â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ Modes: ECB, CBC, CTR, GCM, CCM                        â”‚
â”‚  â”‚   â”‚   â””â”€â”€ Legacy: DES, 3DES, Blowfish (avoid)                   â”‚
â”‚  â”‚   â””â”€â”€ Stream Ciphers                                              â”‚
â”‚  â”‚       â”œâ”€â”€ ChaCha20(-Poly1305)                                    â”‚
â”‚  â”‚       â””â”€â”€ Legacy: RC4 (broken, avoid)                            â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€â”€ Asymmetric (public/private key pair)                            â”‚
â”‚  â”‚   â”œâ”€â”€ Encryption                                                  â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ RSA-OAEP                                               â”‚
â”‚  â”‚   â”‚   â””â”€â”€ ECIES (Elliptic Curve Integrated Encryption)           â”‚
â”‚  â”‚   â”œâ”€â”€ Digital Signatures                                          â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ RSA-PSS                                                â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ ECDSA (secp256r1, secp384r1)                          â”‚
â”‚  â”‚   â”‚   â””â”€â”€ Ed25519 / Ed448                                       â”‚
â”‚  â”‚   â””â”€â”€ Key Exchange                                                â”‚
â”‚  â”‚       â”œâ”€â”€ Diffie-Hellman (DH)                                    â”‚
â”‚  â”‚       â”œâ”€â”€ ECDH (X25519, P-256)                                   â”‚
â”‚  â”‚       â””â”€â”€ Post-quantum: ML-KEM (CRYSTALS-Kyber)                 â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€â”€ Hash Functions (covered in Lesson 03)                           â”‚
â”‚  â”‚   â”œâ”€â”€ SHA-2 (SHA-256, SHA-512)                                   â”‚
â”‚  â”‚   â”œâ”€â”€ SHA-3 (Keccak)                                             â”‚
â”‚  â”‚   â””â”€â”€ BLAKE2/BLAKE3                                              â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â””â”€â”€ Key Derivation Functions                                        â”‚
â”‚      â”œâ”€â”€ HKDF                                                        â”‚
â”‚      â”œâ”€â”€ PBKDF2                                                      â”‚
â”‚      â””â”€â”€ scrypt / Argon2 (password-based)                           â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="12-key-concepts">1.2 Key Concepts<a class="header-link" href="#12-key-concepts" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                    </span><span class="nv">Core</span><span class="w"> </span><span class="nv">Cryptographic</span><span class="w"> </span><span class="nv">Concepts</span><span class="w">                       </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">Term</span><span class="w">               </span>â”‚<span class="w"> </span><span class="nv">Definition</span><span class="w">                                     </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">Plaintext</span><span class="w">          </span>â”‚<span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">original</span>,<span class="w"> </span><span class="nv">unencrypted</span><span class="w"> </span><span class="nv">data</span><span class="w">                 </span>â”‚
â”‚<span class="w"> </span><span class="nv">Ciphertext</span><span class="w">         </span>â”‚<span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">encrypted</span><span class="w"> </span><span class="ss">(</span><span class="nv">unreadable</span><span class="ss">)</span><span class="w"> </span><span class="nv">output</span><span class="w">              </span>â”‚
â”‚<span class="w"> </span><span class="nv">Key</span><span class="w">                </span>â”‚<span class="w"> </span><span class="nv">Secret</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="nv">used</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">encryption</span><span class="o">/</span><span class="nv">decryption</span><span class="w">    </span>â”‚
â”‚<span class="w"> </span><span class="nv">Nonce</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">IV</span><span class="w">         </span>â”‚<span class="w"> </span><span class="nv">Number</span><span class="w"> </span><span class="nv">used</span><span class="w"> </span><span class="nv">once</span><span class="c1">; prevents identical plaintext â”‚</span>
â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">producing</span><span class="w"> </span><span class="nv">identical</span><span class="w"> </span><span class="nv">ciphertext</span><span class="w">            </span>â”‚
â”‚<span class="w"> </span><span class="nv">Authenticated</span><span class="w"> </span><span class="nv">enc</span>.<span class="w"> </span>â”‚<span class="w"> </span><span class="nv">Encryption</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">also</span><span class="w"> </span><span class="nv">verifies</span><span class="w"> </span><span class="nv">integrity</span><span class="w"> </span><span class="ss">(</span><span class="nv">AEAD</span><span class="ss">)</span>â”‚
â”‚<span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">derivation</span><span class="w">     </span>â”‚<span class="w"> </span><span class="nv">Deriving</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">cryptographic</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">password</span><span class="w">  </span>â”‚
â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">another</span><span class="w"> </span><span class="nv">key</span><span class="w">                                </span>â”‚
â”‚<span class="w"> </span><span class="nv">Forward</span><span class="w"> </span><span class="nv">secrecy</span><span class="w">    </span>â”‚<span class="w"> </span><span class="nv">Compromise</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">long</span><span class="o">-</span><span class="nv">term</span><span class="w"> </span><span class="nv">keys</span><span class="w"> </span><span class="nv">does</span><span class="w"> </span><span class="nv">not</span><span class="w">         </span>â”‚
â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="nv">compromise</span><span class="w"> </span><span class="nv">past</span><span class="w"> </span><span class="nv">session</span><span class="w"> </span><span class="nv">keys</span><span class="w">                  </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="13-python-cryptography-library-setup">1.3 Python Cryptography Library Setup<a class="header-link" href="#13-python-cryptography-library-setup" title="Permanent link">&para;</a></h3>
<p>All code examples in this lesson use the <code>cryptography</code> library, which provides both high-level recipes and low-level primitives.</p>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>cryptography
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Verify installation</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cryptography</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cryptography version: </span><span class="si">{</span><span class="n">cryptography</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># The library has two main layers:</span>
<span class="c1"># 1. High-level (recipes): cryptography.fernet, cryptography.hazmat.primitives.kdf</span>
<span class="c1"># 2. Low-level (hazmat): cryptography.hazmat.primitives.ciphers, asymmetric, etc.</span>
<span class="c1">#</span>
<span class="c1"># &quot;hazmat&quot; stands for &quot;hazardous materials&quot; - these primitives can be</span>
<span class="c1"># misused. Always prefer high-level APIs when available.</span>
</code></pre></div>

<hr />
<h2 id="2-symmetric-encryption">2. Symmetric Encryption<a class="header-link" href="#2-symmetric-encryption" title="Permanent link">&para;</a></h2>
<p>Symmetric encryption uses the same key for both encryption and decryption. It is fast and suitable for encrypting large amounts of data.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">         </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">         </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="nv">Plaintext</span><span class="w"> </span>â”‚â”€â”€<span class="nv">Key</span>â”€â”€â–¶â”‚<span class="w"> </span><span class="nv">Encrypt</span><span class="w">  </span>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚<span class="nv">Ciphertext</span>â”‚
â”‚<span class="w"> </span><span class="s2">&quot;Hello&quot;</span><span class="w">  </span>â”‚<span class="w">         </span>â”‚<span class="w"> </span><span class="ss">(</span><span class="nv">AES</span><span class="ss">)</span><span class="w">    </span>â”‚<span class="w">         </span>â”‚<span class="w"> </span><span class="mi">0</span><span class="nv">xA3F1</span>..<span class="w"> </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">         </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">         </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">         </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">         </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="nv">Ciphertext</span>â”‚â”€â”€<span class="nv">Key</span>â”€â”€â–¶â”‚<span class="w"> </span><span class="nv">Decrypt</span><span class="w">  </span>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚<span class="nv">Plaintext</span><span class="w"> </span>â”‚
â”‚<span class="w"> </span><span class="mi">0</span><span class="nv">xA3F1</span>..<span class="w"> </span>â”‚<span class="w">         </span>â”‚<span class="w"> </span><span class="ss">(</span><span class="nv">AES</span><span class="ss">)</span><span class="w">    </span>â”‚<span class="w">         </span>â”‚<span class="w"> </span><span class="s2">&quot;Hello&quot;</span><span class="w">  </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">         </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">         </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

<span class="w">         </span><span class="nv">Same</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="nv">used</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">both</span><span class="w"> </span><span class="nv">operations</span><span class="o">!</span>
</code></pre></div>

<h3 id="21-aes-advanced-encryption-standard">2.1 AES (Advanced Encryption Standard)<a class="header-link" href="#21-aes-advanced-encryption-standard" title="Permanent link">&para;</a></h3>
<p>AES is the most widely used symmetric cipher. It operates on 128-bit blocks and supports key sizes of 128, 192, or 256 bits.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AES Key Sizes                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Key Size â”‚ Rounds   â”‚ Security â”‚ Use Case                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 128-bit  â”‚ 10       â”‚ ~128 bit â”‚ General purpose, fast              â”‚
â”‚ 192-bit  â”‚ 12       â”‚ ~192 bit â”‚ Rarely used in practice            â”‚
â”‚ 256-bit  â”‚ 14       â”‚ ~256 bit â”‚ Government/military, post-quantum  â”‚
â”‚          â”‚          â”‚          â”‚ resistance margin                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="22-fernet-high-level-symmetric-encryption">2.2 Fernet: High-Level Symmetric Encryption<a class="header-link" href="#22-fernet-high-level-symmetric-encryption" title="Permanent link">&para;</a></h3>
<p>For simple use cases, the <code>Fernet</code> class provides authenticated encryption with a simple API.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.fernet</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fernet</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>

<span class="c1"># Generate a random key (URL-safe base64 encoded)</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">Fernet</span><span class="o">.</span><span class="n">generate_key</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key: </span><span class="si">{</span><span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="si">}</span><span class="s2"> bytes = &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="si">}</span><span class="s2"> bits&quot;</span><span class="p">)</span>

<span class="c1"># Create cipher</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="c1"># Encrypt</span>
<span class="n">plaintext</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Sensitive financial data: account balance $50,000&quot;</span>
<span class="n">ciphertext</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Plaintext:  </span><span class="si">{</span><span class="n">plaintext</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ciphertext: </span><span class="si">{</span><span class="n">ciphertext</span><span class="p">[:</span><span class="mi">60</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ciphertext length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>

<span class="c1"># Decrypt</span>
<span class="n">decrypted</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">decrypted</span> <span class="o">==</span> <span class="n">plaintext</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decrypted:  </span><span class="si">{</span><span class="n">decrypted</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Fernet includes a timestamp - you can set a TTL (time-to-live)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;temporary secret&quot;</span><span class="p">)</span>
<span class="c1"># time.sleep(2)  # Uncomment to test expiration</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># Valid for 60 seconds</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Token is still valid&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Token expired: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>What Fernet does under the hood:</strong></p>
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">Generate</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="mf">128</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">IV</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Encrypt</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">AES</span><span class="o">-</span><span class="mf">128</span><span class="o">-</span><span class="n">CBC</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">HMAC</span><span class="o">-</span><span class="n">SHA256</span><span class="w"> </span><span class="kr">for</span><span class="w"> </span><span class="n">authentication</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">Concatenate</span><span class="p">:</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="err">||</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="err">||</span><span class="w"> </span><span class="n">IV</span><span class="w"> </span><span class="err">||</span><span class="w"> </span><span class="n">ciphertext</span><span class="w"> </span><span class="err">||</span><span class="w"> </span><span class="n">HMAC</span>
<span class="mf">5.</span><span class="w"> </span><span class="n">Base64</span><span class="o">-</span><span class="n">encode</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">result</span>
</code></pre></div>

<hr />
<h2 id="3-block-cipher-modes-of-operation">3. Block Cipher Modes of Operation<a class="header-link" href="#3-block-cipher-modes-of-operation" title="Permanent link">&para;</a></h2>
<p>A block cipher (like AES) encrypts fixed-size blocks. Modes of operation define how to handle messages longer than one block.</p>
<h3 id="31-ecb-mode-never-use-this">3.1 ECB Mode (NEVER Use This)<a class="header-link" href="#31-ecb-mode-never-use-this" title="Permanent link">&para;</a></h3>
<p>ECB (Electronic Codebook) encrypts each block independently. Identical plaintext blocks produce identical ciphertext blocks, leaking patterns.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="n">ECB</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">WHY</span><span class="w"> </span><span class="n">IT</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="n">BROKEN</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Plaintext</span><span class="w"> </span><span class="nl">blocks</span><span class="p">:</span><span class="w">    </span><span class="o">[</span><span class="n">AAAA</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">BBBB</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">AAAA</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">CCCC</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">AAAA</span><span class="o">]</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                          </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                         </span><span class="n">AES</span><span class="w">    </span><span class="n">AES</span><span class="w">    </span><span class="n">AES</span><span class="w">    </span><span class="n">AES</span><span class="w">    </span><span class="n">AES</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                          </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Ciphertext</span><span class="w"> </span><span class="nl">blocks</span><span class="p">:</span><span class="w">   </span><span class="o">[</span><span class="n">X1X1</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">Y2Y2</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">X1X1</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">Z3Z3</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">X1X1</span><span class="o">]</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nl">Problem</span><span class="p">:</span><span class="w"> </span><span class="n">Identical</span><span class="w"> </span><span class="n">plaintext</span><span class="w"> </span><span class="n">blocks</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">identical</span><span class="w"> </span><span class="n">ciphertext</span><span class="err">!</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">An</span><span class="w"> </span><span class="n">attacker</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">patterns</span><span class="w"> </span><span class="k">without</span><span class="w"> </span><span class="n">decrypting</span><span class="p">.</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Classic</span><span class="w"> </span><span class="nl">example</span><span class="p">:</span><span class="w"> </span><span class="n">ECB</span><span class="o">-</span><span class="n">encrypted</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="nc">image</span><span class="w"> </span><span class="n">preserves</span><span class="w"> </span><span class="n">shapes</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">because</span><span class="w"> </span><span class="n">adjacent</span><span class="w"> </span><span class="n">identical</span><span class="w"> </span><span class="n">pixels</span><span class="w"> </span><span class="n">produce</span><span class="w"> </span><span class="n">identical</span><span class="w"> </span><span class="n">ciphertext</span><span class="p">.</span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Demonstration: ECB leaks patterns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.ciphers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cipher</span><span class="p">,</span> <span class="n">algorithms</span><span class="p">,</span> <span class="n">modes</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>  <span class="c1"># AES-256</span>

<span class="c1"># ECB mode (DO NOT USE in production - for demonstration only)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ecb_encrypt_block</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Encrypt a single block with AES-ECB. For demonstration only!&quot;&quot;&quot;</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">modes</span><span class="o">.</span><span class="n">ECB</span><span class="p">())</span>
    <span class="n">encryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encryptor</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span> <span class="o">+</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

<span class="c1"># Same plaintext block produces same ciphertext</span>
<span class="n">block1</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;AAAAAAAAAAAAAAAA&quot;</span>  <span class="c1"># 16 bytes = 1 AES block</span>
<span class="n">block2</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;BBBBBBBBBBBBBBBB&quot;</span>

<span class="n">ct1a</span> <span class="o">=</span> <span class="n">ecb_encrypt_block</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">block1</span><span class="p">)</span>
<span class="n">ct1b</span> <span class="o">=</span> <span class="n">ecb_encrypt_block</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">block1</span><span class="p">)</span>  <span class="c1"># Same input</span>
<span class="n">ct2</span>  <span class="o">=</span> <span class="n">ecb_encrypt_block</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">block2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ECB Pattern Leak Demonstration:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Block &#39;AAA...&#39; â†’ </span><span class="si">{</span><span class="n">ct1a</span><span class="o">.</span><span class="n">hex</span><span class="p">()[:</span><span class="mi">32</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Block &#39;AAA...&#39; â†’ </span><span class="si">{</span><span class="n">ct1b</span><span class="o">.</span><span class="n">hex</span><span class="p">()[:</span><span class="mi">32</span><span class="p">]</span><span class="si">}</span><span class="s2">... (SAME ciphertext!)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Block &#39;BBB...&#39; â†’ </span><span class="si">{</span><span class="n">ct2</span><span class="o">.</span><span class="n">hex</span><span class="p">()[:</span><span class="mi">32</span><span class="p">]</span><span class="si">}</span><span class="s2">... (different)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ct1a == ct1b: </span><span class="si">{</span><span class="n">ct1a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ct1b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># True - this is the problem</span>
</code></pre></div>

<h3 id="32-cbc-mode-legacy-use-with-care">3.2 CBC Mode (Legacy, Use with Care)<a class="header-link" href="#32-cbc-mode-legacy-use-with-care" title="Permanent link">&para;</a></h3>
<p>CBC (Cipher Block Chaining) XORs each plaintext block with the previous ciphertext block before encryption. Requires a random IV.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                        </span><span class="nv">CBC</span><span class="w"> </span><span class="nv">Mode</span><span class="w">                                   </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">     </span><span class="nv">IV</span><span class="w"> </span>â”€â”€â”<span class="w">                                                      </span>â”‚
â”‚<span class="w">          </span>â–¼<span class="w">                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">P1</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="nv">XOR</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="nv">AES</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="nv">C1</span><span class="w">                                    </span>â”‚
â”‚<span class="w">                          </span>â”‚<span class="w">                                      </span>â”‚
â”‚<span class="w">                          </span>â–¼<span class="w">                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">P2</span><span class="w"> </span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶<span class="w"> </span><span class="nv">XOR</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="nv">AES</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="nv">C2</span><span class="w">                            </span>â”‚
â”‚<span class="w">                                  </span>â”‚<span class="w">                              </span>â”‚
â”‚<span class="w">                                  </span>â–¼<span class="w">                              </span>â”‚
â”‚<span class="w">  </span><span class="nv">P3</span><span class="w"> </span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶<span class="w"> </span><span class="nv">XOR</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="nv">AES</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="nv">C3</span><span class="w">                    </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="nv">Each</span><span class="w"> </span><span class="nv">ciphertext</span><span class="w"> </span><span class="nv">block</span><span class="w"> </span><span class="nv">depends</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">ALL</span><span class="w"> </span><span class="nv">previous</span><span class="w"> </span><span class="nv">blocks</span>.<span class="w">          </span>â”‚
â”‚<span class="w">  </span><span class="k">Random</span><span class="w"> </span><span class="nv">IV</span><span class="w"> </span><span class="nv">ensures</span><span class="w"> </span><span class="nv">same</span><span class="w"> </span><span class="nv">plaintext</span><span class="w"> </span><span class="nv">encrypts</span><span class="w"> </span><span class="nv">differently</span>.<span class="w">         </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>âš <span class="w"> </span><span class="nv">Requires</span><span class="w"> </span><span class="nv">padding</span><span class="w"> </span><span class="ss">(</span><span class="nv">e</span>.<span class="nv">g</span>.,<span class="w"> </span><span class="nv">PKCS</span><span class="sc">#7</span><span class="ss">)</span><span class="w">                             </span>â”‚
â”‚<span class="w">  </span>âš <span class="w"> </span><span class="nv">Vulnerable</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">padding</span><span class="w"> </span><span class="nv">oracle</span><span class="w"> </span><span class="nv">attacks</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">authenticated</span><span class="w">    </span>â”‚
â”‚<span class="w">  </span>âš <span class="w"> </span><span class="nv">Not</span><span class="w"> </span><span class="nv">parallelizable</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">encryption</span><span class="w">                           </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.ciphers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cipher</span><span class="p">,</span> <span class="n">algorithms</span><span class="p">,</span> <span class="n">modes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">padding</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="k">def</span><span class="w"> </span><span class="nf">aes_cbc_encrypt</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;AES-CBC encryption with PKCS7 padding. Returns (iv, ciphertext).&quot;&quot;&quot;</span>
    <span class="n">iv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>  <span class="c1"># Random 128-bit IV</span>

    <span class="c1"># Pad plaintext to block size</span>
    <span class="n">padder</span> <span class="o">=</span> <span class="n">padding</span><span class="o">.</span><span class="n">PKCS7</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="o">.</span><span class="n">padder</span><span class="p">()</span>
    <span class="n">padded</span> <span class="o">=</span> <span class="n">padder</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span> <span class="o">+</span> <span class="n">padder</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

    <span class="c1"># Encrypt</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">iv</span><span class="p">))</span>
    <span class="n">encryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encryptor</span><span class="p">()</span>
    <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">padded</span><span class="p">)</span> <span class="o">+</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">iv</span><span class="p">,</span> <span class="n">ciphertext</span>

<span class="k">def</span><span class="w"> </span><span class="nf">aes_cbc_decrypt</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">iv</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;AES-CBC decryption with PKCS7 unpadding.&quot;&quot;&quot;</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">iv</span><span class="p">))</span>
    <span class="n">decryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decryptor</span><span class="p">()</span>
    <span class="n">padded</span> <span class="o">=</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span> <span class="o">+</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

    <span class="c1"># Remove padding</span>
    <span class="n">unpadder</span> <span class="o">=</span> <span class="n">padding</span><span class="o">.</span><span class="n">PKCS7</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="o">.</span><span class="n">unpadder</span><span class="p">()</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="n">unpadder</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">padded</span><span class="p">)</span> <span class="o">+</span> <span class="n">unpadder</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">plaintext</span>

<span class="c1"># Usage</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>  <span class="c1"># AES-256</span>
<span class="n">message</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;CBC mode requires padding and a random IV for each message&quot;</span>

<span class="n">iv</span><span class="p">,</span> <span class="n">ct</span> <span class="o">=</span> <span class="n">aes_cbc_encrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IV:         </span><span class="si">{</span><span class="n">iv</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ciphertext: </span><span class="si">{</span><span class="n">ct</span><span class="o">.</span><span class="n">hex</span><span class="p">()[:</span><span class="mi">64</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

<span class="n">pt</span> <span class="o">=</span> <span class="n">aes_cbc_decrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decrypted:  </span><span class="si">{</span><span class="n">pt</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Same plaintext, different IV â†’ different ciphertext</span>
<span class="n">iv2</span><span class="p">,</span> <span class="n">ct2</span> <span class="o">=</span> <span class="n">aes_cbc_encrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Same message, new IV:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ct1: </span><span class="si">{</span><span class="n">ct</span><span class="o">.</span><span class="n">hex</span><span class="p">()[:</span><span class="mi">32</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ct2: </span><span class="si">{</span><span class="n">ct2</span><span class="o">.</span><span class="n">hex</span><span class="p">()[:</span><span class="mi">32</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Same? </span><span class="si">{</span><span class="n">ct</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ct2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># False - good!</span>
</code></pre></div>

<h3 id="33-ctr-mode">3.3 CTR Mode<a class="header-link" href="#33-ctr-mode" title="Permanent link">&para;</a></h3>
<p>CTR (Counter) mode turns a block cipher into a stream cipher. It is parallelizable and does not require padding.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CTR Mode                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Nonce|Counter=0 â”€â”€â–¶ AES â”€â”€â–¶ Keystream0 â”€â”€XORâ”€â”€â–¶ C0            â”‚
â”‚                                               â–²                  â”‚
â”‚                                               â”‚                  â”‚
â”‚                                              P0                  â”‚
â”‚                                                                  â”‚
â”‚  Nonce|Counter=1 â”€â”€â–¶ AES â”€â”€â–¶ Keystream1 â”€â”€XORâ”€â”€â–¶ C1            â”‚
â”‚                                               â–²                  â”‚
â”‚                                               â”‚                  â”‚
â”‚                                              P1                  â”‚
â”‚                                                                  â”‚
â”‚  âœ“ Parallelizable (encryption and decryption)                   â”‚
â”‚  âœ“ No padding needed                                            â”‚
â”‚  âœ“ Can seek to any block                                        â”‚
â”‚  âš  Nonce reuse is catastrophic (XOR of two plaintexts leaked)   â”‚
â”‚  âš  No authentication (use GCM instead)                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="4-aes-gcm-the-modern-standard">4. AES-GCM: The Modern Standard<a class="header-link" href="#4-aes-gcm-the-modern-standard" title="Permanent link">&para;</a></h2>
<p>GCM (Galois/Counter Mode) combines CTR mode encryption with GMAC authentication. It provides both confidentiality and integrity in a single operation -- this is called Authenticated Encryption with Associated Data (AEAD).</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AES-GCM (AEAD)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Input:  Key, Nonce (96-bit), Plaintext, AAD (optional)             â”‚
â”‚  Output: Ciphertext, Authentication Tag (128-bit)                   â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  Nonce   â”‚â”€â”€â”€â”€â–¶â”‚  AES-CTR    â”‚â”€â”€â”€â”€â–¶â”‚ Ciphertext â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  Encryption â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚                       â”‚
â”‚  â”‚  AAD    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚                       â”‚
â”‚  â”‚(header) â”‚          â–¼                    â–¼                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                  â”‚   GHASH     â”‚â”€â”€â”€â”€â–¶â”‚   Auth   â”‚                  â”‚
â”‚                  â”‚  (GMAC)    â”‚     â”‚   Tag    â”‚                  â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                      â”‚
â”‚  AAD = Associated Authenticated Data                                â”‚
â”‚  - Authenticated but NOT encrypted                                  â”‚
â”‚  - Example: message headers, packet sequence numbers                â”‚
â”‚  - Tampering with AAD causes authentication to fail                 â”‚
â”‚                                                                      â”‚
â”‚  âœ“ AEAD: Confidentiality + Integrity + Authenticity                â”‚
â”‚  âœ“ Parallelizable                                                   â”‚
â”‚  âœ“ Hardware acceleration (AES-NI)                                   â”‚
â”‚  âš  Nonce MUST be unique per key (never reuse!)                     â”‚
â”‚  âš  96-bit nonce limits to ~2^32 encryptions per key               â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="41-aes-gcm-implementation">4.1 AES-GCM Implementation<a class="header-link" href="#41-aes-gcm-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.ciphers.aead</span><span class="w"> </span><span class="kn">import</span> <span class="n">AESGCM</span>

<span class="k">def</span><span class="w"> </span><span class="nf">aes_gcm_encrypt</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
                     <span class="n">aad</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encrypt with AES-GCM.</span>
<span class="sd">    Returns (nonce, ciphertext_with_tag).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aesgcm</span> <span class="o">=</span> <span class="n">AESGCM</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">nonce</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>  <span class="c1"># 96-bit nonce (NIST recommended)</span>
    <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">aesgcm</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">,</span> <span class="n">aad</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">ciphertext</span>

<span class="k">def</span><span class="w"> </span><span class="nf">aes_gcm_decrypt</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">nonce</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
                     <span class="n">aad</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decrypt with AES-GCM.</span>
<span class="sd">    Raises InvalidTag if authentication fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aesgcm</span> <span class="o">=</span> <span class="n">AESGCM</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aesgcm</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">,</span> <span class="n">aad</span><span class="p">)</span>

<span class="c1"># Generate a 256-bit key</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">AESGCM</span><span class="o">.</span><span class="n">generate_key</span><span class="p">(</span><span class="n">bit_length</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key: </span><span class="si">{</span><span class="n">key</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="si">}</span><span class="s2"> bits)&quot;</span><span class="p">)</span>

<span class="c1"># Encrypt a message</span>
<span class="n">message</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Top secret: The missile codes are 12345&quot;</span>
<span class="n">aad</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;message-id: 42, timestamp: 2026-01-15&quot;</span>  <span class="c1"># Authenticated but not encrypted</span>

<span class="n">nonce</span><span class="p">,</span> <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">aes_gcm_encrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">aad</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Nonce:      </span><span class="si">{</span><span class="n">nonce</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ciphertext: </span><span class="si">{</span><span class="n">ciphertext</span><span class="o">.</span><span class="n">hex</span><span class="p">()[:</span><span class="mi">64</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CT length:  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;(plaintext: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="si">}</span><span class="s2"> + tag: 16)&quot;</span><span class="p">)</span>

<span class="c1"># Decrypt</span>
<span class="n">plaintext</span> <span class="o">=</span> <span class="n">aes_gcm_decrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">,</span> <span class="n">aad</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decrypted:  </span><span class="si">{</span><span class="n">plaintext</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Tamper with ciphertext â†’ authentication fails</span>
<span class="n">tampered_ct</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>
<span class="n">tampered_ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0xFF</span>  <span class="c1"># Flip bits in first byte</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">aes_gcm_decrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">tampered_ct</span><span class="p">),</span> <span class="n">aad</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Should have failed!&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tamper detected: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Tamper with AAD â†’ authentication fails</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">aes_gcm_decrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;tampered AAD&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Should have failed!&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AAD tamper detected: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="42-file-encryption-with-aes-gcm">4.2 File Encryption with AES-GCM<a class="header-link" href="#42-file-encryption-with-aes-gcm" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.ciphers.aead</span><span class="w"> </span><span class="kn">import</span> <span class="n">AESGCM</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FileEncryptor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Encrypt/decrypt files using AES-256-GCM.&quot;&quot;&quot;</span>

    <span class="n">CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 64 KB chunks</span>
    <span class="n">NONCE_SIZE</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="n">TAG_SIZE</span> <span class="o">=</span> <span class="mi">16</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Key must be 256 bits (32 bytes)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aesgcm</span> <span class="o">=</span> <span class="n">AESGCM</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">encrypt_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encrypt a file chunk by chunk.</span>
<span class="sd">        Format: [nonce (12B)][chunk_count (4B)][encrypted_chunk1][encrypted_chunk2]...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">input_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input file not found: </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">file_size</span> <span class="o">=</span> <span class="n">input_file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span>
        <span class="n">chunks_written</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="c1"># Write file nonce (used as base; each chunk gets nonce + counter)</span>
            <span class="n">base_nonce</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NONCE_SIZE</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">base_nonce</span><span class="p">)</span>

            <span class="c1"># Placeholder for chunk count</span>
            <span class="n">chunk_count_pos</span> <span class="o">=</span> <span class="n">fout</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>  <span class="c1"># Will update later</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CHUNK_SIZE</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># Derive unique nonce for this chunk</span>
                <span class="n">chunk_nonce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive_chunk_nonce</span><span class="p">(</span><span class="n">base_nonce</span><span class="p">,</span> <span class="n">chunks_written</span><span class="p">)</span>

                <span class="c1"># AAD includes chunk index to prevent reordering</span>
                <span class="n">aad</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">chunks_written</span><span class="p">)</span>

                <span class="n">encrypted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aesgcm</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">chunk_nonce</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">aad</span><span class="p">)</span>

                <span class="c1"># Write: [length (4B)][encrypted_data]</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)))</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span>
                <span class="n">chunks_written</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Update chunk count</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">chunk_count_pos</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">chunks_written</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="n">file_size</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="n">chunks_written</span><span class="p">,</span>
            <span class="s2">&quot;output_size&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decrypt_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decrypt a file encrypted with encrypt_file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="n">base_nonce</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NONCE_SIZE</span><span class="p">)</span>
            <span class="n">chunk_count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">chunk_count</span><span class="p">):</span>
                <span class="n">chunk_nonce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive_chunk_nonce</span><span class="p">(</span><span class="n">base_nonce</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">aad</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

                <span class="n">enc_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">encrypted</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">enc_len</span><span class="p">)</span>

                <span class="n">decrypted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aesgcm</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">chunk_nonce</span><span class="p">,</span> <span class="n">encrypted</span><span class="p">,</span> <span class="n">aad</span><span class="p">)</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">decrypted</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;chunks_decrypted&quot;</span><span class="p">:</span> <span class="n">chunk_count</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_derive_chunk_nonce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_nonce</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">chunk_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Derive a unique nonce for each chunk by XORing with chunk index.&quot;&quot;&quot;</span>
        <span class="n">nonce_int</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">base_nonce</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="o">^</span> <span class="n">chunk_index</span>
        <span class="k">return</span> <span class="n">nonce_int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NONCE_SIZE</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>

<span class="c1"># Usage example</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">AESGCM</span><span class="o">.</span><span class="n">generate_key</span><span class="p">(</span><span class="n">bit_length</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="n">encryptor</span> <span class="o">=</span> <span class="n">FileEncryptor</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="c1"># Create a test file</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Hello, encrypted world! &quot;</span> <span class="o">*</span> <span class="mi">10000</span>  <span class="c1"># ~240 KB</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/tmp/test_plain.bin&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

<span class="c1"># Encrypt</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">encrypt_file</span><span class="p">(</span><span class="s2">&quot;/tmp/test_plain.bin&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/test_encrypted.bin&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encrypted: </span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Decrypt</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">decrypt_file</span><span class="p">(</span><span class="s2">&quot;/tmp/test_encrypted.bin&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/test_decrypted.bin&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decrypted: </span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Verify</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/tmp/test_decrypted.bin&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">decrypted_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">decrypted_data</span> <span class="o">==</span> <span class="n">test_data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Verification: OK - decrypted data matches original&quot;</span><span class="p">)</span>

<span class="c1"># Clean up</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;/tmp/test_plain.bin&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/test_encrypted.bin&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/test_decrypted.bin&quot;</span><span class="p">]:</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="5-chacha20-poly1305">5. ChaCha20-Poly1305<a class="header-link" href="#5-chacha20-poly1305" title="Permanent link">&para;</a></h2>
<p>ChaCha20-Poly1305 is an AEAD cipher that combines the ChaCha20 stream cipher with the Poly1305 MAC. It is the primary alternative to AES-GCM.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="n">AES</span><span class="o">-</span><span class="n">GCM</span><span class="w"> </span><span class="n">vs</span><span class="w"> </span><span class="n">ChaCha20</span><span class="o">-</span><span class="n">Poly1305</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">AES</span><span class="o">-</span><span class="mi">256</span><span class="o">-</span><span class="n">GCM</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="n">ChaCha20</span><span class="o">-</span><span class="n">Poly1305</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Key</span><span class="w"> </span><span class="n">size</span><span class="w">         </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="n">bits</span><span class="w">             </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="n">bits</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Nonce</span><span class="w"> </span><span class="n">size</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="n">bits</span><span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="n">bits</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Tag</span><span class="w"> </span><span class="n">size</span><span class="w">         </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="n">bits</span><span class="w">             </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="n">bits</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Speed</span><span class="w"> </span><span class="p">(</span><span class="n">HW</span><span class="w"> </span><span class="n">accel</span><span class="p">)</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Very</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="p">(</span><span class="n">AES</span><span class="o">-</span><span class="n">NI</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Slower</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">AES</span><span class="o">-</span><span class="n">NI</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Speed</span><span class="w"> </span><span class="p">(</span><span class="n">software</span><span class="p">)</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Slower</span><span class="w">               </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Faster</span><span class="w"> </span><span class="p">(</span><span class="n">no</span><span class="w"> </span><span class="n">special</span><span class="w"> </span><span class="n">HW</span><span class="p">)</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Mobile</span><span class="o">/</span><span class="n">embedded</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Needs</span><span class="w"> </span><span class="n">HW</span><span class="w"> </span><span class="n">support</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Excellent</span><span class="w"> </span><span class="p">(</span><span class="n">pure</span><span class="w"> </span><span class="n">software</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Side</span><span class="w"> </span><span class="n">channels</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Needs</span><span class="w"> </span><span class="n">care</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="n">tables</span><span class="p">)</span><span class="err">â”‚</span><span class="w"> </span><span class="n">Inherently</span><span class="w"> </span><span class="n">constant</span><span class="o">-</span><span class="n">time</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Used</span><span class="w"> </span><span class="n">by</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="n">TLS</span><span class="p">,</span><span class="w"> </span><span class="n">IPsec</span><span class="p">,</span><span class="w"> </span><span class="n">disk</span><span class="w"> </span><span class="n">enc</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="p">(</span><span class="n">Google</span><span class="o">/</span><span class="n">CF</span><span class="p">),</span><span class="w"> </span><span class="n">WireGuard</span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Nonce</span><span class="w"> </span><span class="n">misuse</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Catastrophic</span><span class="w">         </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Catastrophic</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Post</span><span class="o">-</span><span class="n">quantum</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Neither</span><span class="w"> </span><span class="n">provides</span><span class="w"> </span><span class="n">PQ</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Neither</span><span class="w"> </span><span class="n">provides</span><span class="w"> </span><span class="n">PQ</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">resistance</span><span class="w"> </span><span class="n">alone</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">resistance</span><span class="w"> </span><span class="n">alone</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="51-chacha20-poly1305-implementation">5.1 ChaCha20-Poly1305 Implementation<a class="header-link" href="#51-chacha20-poly1305-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.ciphers.aead</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChaCha20Poly1305</span>

<span class="c1"># Generate a 256-bit key</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">ChaCha20Poly1305</span><span class="o">.</span><span class="n">generate_key</span><span class="p">()</span>
<span class="n">chacha</span> <span class="o">=</span> <span class="n">ChaCha20Poly1305</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="c1"># Encrypt</span>
<span class="n">nonce</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>  <span class="c1"># 96-bit nonce</span>
<span class="n">message</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;ChaCha20-Poly1305 is great for mobile and embedded devices&quot;</span>
<span class="n">aad</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;metadata: device=mobile, version=1&quot;</span>

<span class="n">ciphertext</span> <span class="o">=</span> <span class="n">chacha</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">aad</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plaintext:  </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ciphertext: </span><span class="si">{</span><span class="n">ciphertext</span><span class="o">.</span><span class="n">hex</span><span class="p">()[:</span><span class="mi">64</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CT length:  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span><span class="si">}</span><span class="s2"> (plaintext </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="si">}</span><span class="s2"> + tag 16)&quot;</span><span class="p">)</span>

<span class="c1"># Decrypt</span>
<span class="n">plaintext</span> <span class="o">=</span> <span class="n">chacha</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">,</span> <span class="n">aad</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">plaintext</span> <span class="o">==</span> <span class="n">message</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decrypted:  </span><span class="si">{</span><span class="n">plaintext</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Tamper detection</span>
<span class="n">tampered</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>
<span class="n">tampered</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0x01</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">chacha</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">tampered</span><span class="p">),</span> <span class="n">aad</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tamper detected: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="52-xchacha20-poly1305-extended-nonce">5.2 XChaCha20-Poly1305 (Extended Nonce)<a class="header-link" href="#52-xchacha20-poly1305-extended-nonce" title="Permanent link">&para;</a></h3>
<p>XChaCha20 uses a 192-bit nonce (vs 96-bit), which is large enough to be randomly generated without realistic collision risk. This eliminates the nonce-management burden.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># XChaCha20 is available through libsodium bindings (PyNaCl)</span>
<span class="c1"># pip install pynacl</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">nacl.secret</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nacl.utils</span>

<span class="c1"># XChaCha20-Poly1305 with 192-bit random nonce</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">nacl</span><span class="o">.</span><span class="n">secret</span><span class="o">.</span><span class="n">SecretBox</span><span class="o">.</span><span class="n">KEY_SIZE</span><span class="p">)</span>  <span class="c1"># 256-bit</span>
<span class="n">box</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">.</span><span class="n">secret</span><span class="o">.</span><span class="n">SecretBox</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="c1"># Encrypt - nonce is generated automatically (192-bit, random-safe)</span>
<span class="n">message</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;With XChaCha20, random nonces are always safe&quot;</span>
<span class="n">encrypted</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nonce size: </span><span class="si">{</span><span class="n">box</span><span class="o">.</span><span class="n">NONCE_SIZE</span><span class="si">}</span><span class="s2"> bytes = </span><span class="si">{</span><span class="n">box</span><span class="o">.</span><span class="n">NONCE_SIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="si">}</span><span class="s2"> bits&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encrypted length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>

<span class="c1"># Decrypt</span>
<span class="n">decrypted</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decrypted: </span><span class="si">{</span><span class="n">decrypted</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="6-asymmetric-encryption">6. Asymmetric Encryption<a class="header-link" href="#6-asymmetric-encryption" title="Permanent link">&para;</a></h2>
<p>Asymmetric (public-key) cryptography uses a key pair: a public key for encryption (or verification) and a private key for decryption (or signing).</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Asymmetric Cryptography                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Key Generation                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â”‚ KeyGen() â”‚â”€â”€â–¶ Private Key (keep secret!)                         â”‚
â”‚  â”‚          â”‚â”€â”€â–¶ Public Key  (share freely)                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚                                                                      â”‚
â”‚  Encryption (anyone â†’ key owner)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   Public Key   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ Plaintext â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Encrypt  â”‚â”€â”€â–¶ Ciphertext            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                      â”‚
â”‚  Decryption (only key owner)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   Private Key  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚Ciphertext â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Decrypt  â”‚â”€â”€â–¶ Plaintext             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                      â”‚
â”‚  Signing (key owner â†’ anyone can verify)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   Private Key  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ Message   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Sign    â”‚â”€â”€â–¶ Signature             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                      â”‚
â”‚  Verification (anyone with public key)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   Public Key   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ Message + â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Verify   â”‚â”€â”€â–¶ Valid / Invalid       â”‚
â”‚  â”‚ Signature â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="61-hybrid-encryption">6.1 Hybrid Encryption<a class="header-link" href="#61-hybrid-encryption" title="Permanent link">&para;</a></h3>
<p>Asymmetric encryption is slow and limited in the amount of data it can encrypt. In practice, we use <strong>hybrid encryption</strong>: encrypt the data with a symmetric key, then encrypt the symmetric key with the recipient's public key.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="n">Hybrid</span><span class="w"> </span><span class="n">Encryption</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nl">Sender</span><span class="p">:</span><span class="w">                                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">Generate</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="k">symmetric</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.,</span><span class="w"> </span><span class="n">AES</span><span class="o">-</span><span class="mi">256</span><span class="p">)</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">Encrypt</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">symmetric</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">AES</span><span class="o">-</span><span class="n">GCM</span><span class="p">)</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="n">Encrypt</span><span class="w"> </span><span class="k">symmetric</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">recipient</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">RSA</span><span class="p">)</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">4.</span><span class="w"> </span><span class="nl">Send</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">encrypted_key</span><span class="o">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">[</span><span class="n">encrypted_data</span><span class="o">]</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nl">Recipient</span><span class="p">:</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">Decrypt</span><span class="w"> </span><span class="k">symmetric</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">RSA</span><span class="p">)</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">Decrypt</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">symmetric</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">AES</span><span class="o">-</span><span class="n">GCM</span><span class="p">)</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">This</span><span class="w"> </span><span class="n">gives</span><span class="w"> </span><span class="nl">us</span><span class="p">:</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Speed</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">symmetric</span><span class="w"> </span><span class="n">encryption</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">bulk</span><span class="w"> </span><span class="k">data</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Convenience</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">public</span><span class="o">-</span><span class="k">key</span><span class="w"> </span><span class="n">encryption</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="n">distribution</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="7-rsa">7. RSA<a class="header-link" href="#7-rsa" title="Permanent link">&para;</a></h2>
<p>RSA (Rivest-Shamir-Adleman) is the most widely deployed asymmetric algorithm. Its security is based on the difficulty of factoring large integers.</p>
<h3 id="71-rsa-key-generation-and-encryption">7.1 RSA Key Generation and Encryption<a class="header-link" href="#71-rsa-key-generation-and-encryption" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric</span><span class="w"> </span><span class="kn">import</span> <span class="n">rsa</span><span class="p">,</span> <span class="n">padding</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">hashes</span><span class="p">,</span> <span class="n">serialization</span>

<span class="c1"># Generate RSA key pair</span>
<span class="n">private_key</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span>
    <span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span>
    <span class="n">key_size</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span>  <span class="c1"># 2048 minimum, 4096 recommended</span>
<span class="p">)</span>
<span class="n">public_key</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>

<span class="c1"># Display key info</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key size: </span><span class="si">{</span><span class="n">private_key</span><span class="o">.</span><span class="n">key_size</span><span class="si">}</span><span class="s2"> bits&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Public exponent: </span><span class="si">{</span><span class="n">private_key</span><span class="o">.</span><span class="n">private_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="o">.</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Serialize keys (PEM format)</span>
<span class="n">private_pem</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">private_bytes</span><span class="p">(</span>
    <span class="n">encoding</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">PEM</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">PrivateFormat</span><span class="o">.</span><span class="n">PKCS8</span><span class="p">,</span>
    <span class="n">encryption_algorithm</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">BestAvailableEncryption</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;my-password&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">public_pem</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span>
    <span class="n">encoding</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">PEM</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">PublicFormat</span><span class="o">.</span><span class="n">SubjectPublicKeyInfo</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Public key (first 80 chars):</span><span class="se">\n</span><span class="si">{</span><span class="n">public_pem</span><span class="o">.</span><span class="n">decode</span><span class="p">()[:</span><span class="mi">80</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

<span class="c1"># Encrypt with public key (using OAEP padding - ALWAYS use OAEP, never PKCS1v15)</span>
<span class="n">message</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Secret message for RSA encryption&quot;</span>
<span class="n">ciphertext</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span>
    <span class="n">message</span><span class="p">,</span>
    <span class="n">padding</span><span class="o">.</span><span class="n">OAEP</span><span class="p">(</span>
        <span class="n">mgf</span><span class="o">=</span><span class="n">padding</span><span class="o">.</span><span class="n">MGF1</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">()),</span>
        <span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
        <span class="n">label</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Ciphertext: </span><span class="si">{</span><span class="n">ciphertext</span><span class="o">.</span><span class="n">hex</span><span class="p">()[:</span><span class="mi">64</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CT length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>

<span class="c1"># Decrypt with private key</span>
<span class="n">plaintext</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span>
    <span class="n">ciphertext</span><span class="p">,</span>
    <span class="n">padding</span><span class="o">.</span><span class="n">OAEP</span><span class="p">(</span>
        <span class="n">mgf</span><span class="o">=</span><span class="n">padding</span><span class="o">.</span><span class="n">MGF1</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">()),</span>
        <span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
        <span class="n">label</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decrypted: </span><span class="si">{</span><span class="n">plaintext</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="72-rsa-hybrid-encryption">7.2 RSA Hybrid Encryption<a class="header-link" href="#72-rsa-hybrid-encryption" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric</span><span class="w"> </span><span class="kn">import</span> <span class="n">rsa</span><span class="p">,</span> <span class="n">padding</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">hashes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.ciphers.aead</span><span class="w"> </span><span class="kn">import</span> <span class="n">AESGCM</span>

<span class="k">class</span><span class="w"> </span><span class="nc">HybridEncryptor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RSA + AES-GCM hybrid encryption.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">public_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span> <span class="o">=</span> <span class="n">public_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">private_key</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_keypair</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a new RSA key pair and return an encryptor.&quot;&quot;&quot;</span>
        <span class="n">private_key</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span>
            <span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span>
            <span class="n">key_size</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">public_key</span><span class="o">=</span><span class="n">private_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">(),</span>
            <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Encrypt data using hybrid encryption.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Public key required for encryption&quot;</span><span class="p">)</span>

        <span class="c1"># 1. Generate random AES-256 key</span>
        <span class="n">aes_key</span> <span class="o">=</span> <span class="n">AESGCM</span><span class="o">.</span><span class="n">generate_key</span><span class="p">(</span><span class="n">bit_length</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>

        <span class="c1"># 2. Encrypt data with AES-GCM</span>
        <span class="n">nonce</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">aesgcm</span> <span class="o">=</span> <span class="n">AESGCM</span><span class="p">(</span><span class="n">aes_key</span><span class="p">)</span>
        <span class="n">encrypted_data</span> <span class="o">=</span> <span class="n">aesgcm</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># 3. Encrypt AES key with RSA public key</span>
        <span class="n">encrypted_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span>
            <span class="n">aes_key</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">.</span><span class="n">OAEP</span><span class="p">(</span>
                <span class="n">mgf</span><span class="o">=</span><span class="n">padding</span><span class="o">.</span><span class="n">MGF1</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">()),</span>
                <span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
                <span class="n">label</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 4. Package everything together</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;encrypted_key&quot;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">encrypted_key</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
            <span class="s2">&quot;nonce&quot;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">nonce</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
            <span class="s2">&quot;ciphertext&quot;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">encrypted_data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decrypt hybrid-encrypted data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Private key required for decryption&quot;</span><span class="p">)</span>

        <span class="c1"># 1. Decrypt AES key with RSA private key</span>
        <span class="n">encrypted_key</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">package</span><span class="p">[</span><span class="s2">&quot;encrypted_key&quot;</span><span class="p">])</span>
        <span class="n">aes_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span>
            <span class="n">encrypted_key</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">.</span><span class="n">OAEP</span><span class="p">(</span>
                <span class="n">mgf</span><span class="o">=</span><span class="n">padding</span><span class="o">.</span><span class="n">MGF1</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">()),</span>
                <span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
                <span class="n">label</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 2. Decrypt data with AES-GCM</span>
        <span class="n">nonce</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">package</span><span class="p">[</span><span class="s2">&quot;nonce&quot;</span><span class="p">])</span>
        <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">package</span><span class="p">[</span><span class="s2">&quot;ciphertext&quot;</span><span class="p">])</span>
        <span class="n">aesgcm</span> <span class="o">=</span> <span class="n">AESGCM</span><span class="p">(</span><span class="n">aes_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">aesgcm</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># Usage</span>
<span class="n">encryptor</span> <span class="o">=</span> <span class="n">HybridEncryptor</span><span class="o">.</span><span class="n">generate_keypair</span><span class="p">()</span>

<span class="c1"># Encrypt a large message</span>
<span class="n">large_message</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">100000</span>  <span class="c1"># 100 KB - too large for raw RSA</span>
<span class="n">package</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">large_message</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hybrid Encryption Package:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Encrypted key length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">package</span><span class="p">[</span><span class="s1">&#39;encrypted_key&#39;</span><span class="p">]))</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Nonce: </span><span class="si">{</span><span class="n">package</span><span class="p">[</span><span class="s1">&#39;nonce&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Ciphertext length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">package</span><span class="p">[</span><span class="s1">&#39;ciphertext&#39;</span><span class="p">]))</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>

<span class="c1"># Decrypt</span>
<span class="n">decrypted</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">decrypted</span> <span class="o">==</span> <span class="n">large_message</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Decrypted successfully: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">decrypted</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes match original&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="8-elliptic-curve-cryptography">8. Elliptic Curve Cryptography<a class="header-link" href="#8-elliptic-curve-cryptography" title="Permanent link">&para;</a></h2>
<p>ECC provides the same security as RSA with much smaller key sizes, making it faster and more efficient.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">              </span><span class="nv">RSA</span><span class="w"> </span><span class="nv">vs</span><span class="w"> </span><span class="nv">Elliptic</span><span class="w"> </span><span class="nv">Curve</span><span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">Sizes</span><span class="w">                         </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">Security</span><span class="w"> </span><span class="nv">Level</span><span class="w">   </span>â”‚<span class="w"> </span><span class="nv">RSA</span><span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">Size</span><span class="w">     </span>â”‚<span class="w"> </span><span class="nv">ECC</span><span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">Size</span><span class="w">                   </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="mi">128</span><span class="o">-</span><span class="nv">bit</span><span class="w">          </span>â”‚<span class="w"> </span><span class="mi">3072</span><span class="w"> </span><span class="nv">bits</span><span class="w">        </span>â”‚<span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="nv">bits</span><span class="w"> </span><span class="ss">(</span><span class="nv">P</span><span class="o">-</span><span class="mi">256</span><span class="o">/</span><span class="nv">secp256r1</span><span class="ss">)</span><span class="w">     </span>â”‚
â”‚<span class="w"> </span><span class="mi">192</span><span class="o">-</span><span class="nv">bit</span><span class="w">          </span>â”‚<span class="w"> </span><span class="mi">7680</span><span class="w"> </span><span class="nv">bits</span><span class="w">        </span>â”‚<span class="w"> </span><span class="mi">384</span><span class="w"> </span><span class="nv">bits</span><span class="w"> </span><span class="ss">(</span><span class="nv">P</span><span class="o">-</span><span class="mi">384</span><span class="o">/</span><span class="nv">secp384r1</span><span class="ss">)</span><span class="w">     </span>â”‚
â”‚<span class="w"> </span><span class="mi">256</span><span class="o">-</span><span class="nv">bit</span><span class="w">          </span>â”‚<span class="w"> </span><span class="mi">15360</span><span class="w"> </span><span class="nv">bits</span><span class="w">       </span>â”‚<span class="w"> </span><span class="mi">521</span><span class="w"> </span><span class="nv">bits</span><span class="w"> </span><span class="ss">(</span><span class="nv">P</span><span class="o">-</span><span class="mi">521</span><span class="o">/</span><span class="nv">secp521r1</span><span class="ss">)</span><span class="w">     </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">ECC</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="o">~</span><span class="mi">10</span><span class="o">-</span><span class="mi">15</span><span class="nv">x</span><span class="w"> </span><span class="nv">smaller</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">equivalent</span><span class="w"> </span><span class="nv">security</span><span class="o">!</span><span class="w">                     </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="81-ecdsa-elliptic-curve-digital-signature-algorithm">8.1 ECDSA (Elliptic Curve Digital Signature Algorithm)<a class="header-link" href="#81-ecdsa-elliptic-curve-digital-signature-algorithm" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric</span><span class="w"> </span><span class="kn">import</span> <span class="n">ec</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">hashes</span>

<span class="c1"># Generate key pair using P-256 curve (NIST recommended)</span>
<span class="n">private_key</span> <span class="o">=</span> <span class="n">ec</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span><span class="n">ec</span><span class="o">.</span><span class="n">SECP256R1</span><span class="p">())</span>
<span class="n">public_key</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Curve: </span><span class="si">{</span><span class="n">private_key</span><span class="o">.</span><span class="n">curve</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key size: </span><span class="si">{</span><span class="n">private_key</span><span class="o">.</span><span class="n">curve</span><span class="o">.</span><span class="n">key_size</span><span class="si">}</span><span class="s2"> bits&quot;</span><span class="p">)</span>

<span class="c1"># Sign a message</span>
<span class="n">message</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;This message is signed with ECDSA&quot;</span>
<span class="n">signature</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span>
    <span class="n">message</span><span class="p">,</span>
    <span class="n">ec</span><span class="o">.</span><span class="n">ECDSA</span><span class="p">(</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Signature: </span><span class="si">{</span><span class="n">signature</span><span class="o">.</span><span class="n">hex</span><span class="p">()[:</span><span class="mi">64</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signature length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>  <span class="c1"># ~70-72 bytes for P-256</span>

<span class="c1"># Verify</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">public_key</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ec</span><span class="o">.</span><span class="n">ECDSA</span><span class="p">(</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">()))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Signature valid!&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Signature invalid!&quot;</span><span class="p">)</span>

<span class="c1"># Tampered message fails</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">public_key</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;tampered message&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">.</span><span class="n">ECDSA</span><span class="p">(</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">()))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Should have failed!&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tampered message: signature verification failed (expected)&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="82-ed25519-modern-signature-algorithm">8.2 Ed25519 (Modern Signature Algorithm)<a class="header-link" href="#82-ed25519-modern-signature-algorithm" title="Permanent link">&para;</a></h3>
<p>Ed25519 is a modern EdDSA signature scheme using Curve25519. It is deterministic (no random nonce needed during signing), fast, and resistant to side-channel attacks.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric.ed25519</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ed25519PrivateKey</span>

<span class="c1"># Generate Ed25519 key pair</span>
<span class="n">private_key</span> <span class="o">=</span> <span class="n">Ed25519PrivateKey</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
<span class="n">public_key</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>

<span class="c1"># Sign (no hash algorithm parameter needed - it uses SHA-512 internally)</span>
<span class="n">message</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Ed25519 is the recommended signature algorithm for new systems&quot;</span>
<span class="n">signature</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signature: </span><span class="si">{</span><span class="n">signature</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signature length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>  <span class="c1"># Always 64 bytes</span>

<span class="c1"># Verify</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">public_key</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ed25519 signature valid!&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Key sizes are small</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.serialization</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Encoding</span><span class="p">,</span> <span class="n">PublicFormat</span><span class="p">,</span> <span class="n">PrivateFormat</span><span class="p">,</span> <span class="n">NoEncryption</span>
<span class="p">)</span>

<span class="n">pub_bytes</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span><span class="n">Encoding</span><span class="o">.</span><span class="n">Raw</span><span class="p">,</span> <span class="n">PublicFormat</span><span class="o">.</span><span class="n">Raw</span><span class="p">)</span>
<span class="n">priv_bytes</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">private_bytes</span><span class="p">(</span><span class="n">Encoding</span><span class="o">.</span><span class="n">Raw</span><span class="p">,</span> <span class="n">PrivateFormat</span><span class="o">.</span><span class="n">Raw</span><span class="p">,</span> <span class="n">NoEncryption</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Public key:  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pub_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pub_bytes</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="si">}</span><span class="s2"> bits)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Private key: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">priv_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">priv_bytes</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="si">}</span><span class="s2"> bits)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signature:   </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="si">}</span><span class="s2"> bits)&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="nx">Signature</span><span class="w"> </span><span class="nx">Algorithm</span><span class="w"> </span><span class="nx">Comparison</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">RSA</span><span class="o">-</span><span class="mi">2048</span><span class="w"> </span><span class="err">â”‚</span><span class="nx">ECDSA</span><span class="w"> </span><span class="nx">P256</span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Ed25519</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Ed448</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Pub</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="nx">B</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="nx">B</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="nx">B</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="nx">B</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Sig</span><span class="w"> </span><span class="nx">size</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="nx">B</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="o">~</span><span class="mi">72</span><span class="w"> </span><span class="nx">B</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="nx">B</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">114</span><span class="w"> </span><span class="nx">B</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Sign</span><span class="w"> </span><span class="nx">speed</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Slow</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Fast</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Very</span><span class="w"> </span><span class="nx">fast</span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Fast</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Verify</span><span class="w"> </span><span class="nx">speed</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Fast</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Moderate</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Fast</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Fast</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Deterministic</span><span class="err">â”‚</span><span class="w"> </span><span class="nx">No</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">No</span><span class="o">*</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Yes</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Yes</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Side</span><span class="o">-</span><span class="nx">channel</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Needs</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Needs</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Inherent</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Inherent</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">resistance</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">care</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">care</span><span class="w">     </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Standard</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">PKCS</span><span class="err">#</span><span class="mi">1</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">FIPS</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">RFC</span><span class="w"> </span><span class="mi">8032</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">RFC</span><span class="w"> </span><span class="mi">8032</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">RFC</span><span class="w"> </span><span class="mi">6979</span><span class="w"> </span><span class="nx">provides</span><span class="w"> </span><span class="nx">deterministic</span><span class="w"> </span><span class="nx">ECDSA</span><span class="p">,</span><span class="w"> </span><span class="nx">but</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nx">impls</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">it</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Recommendation</span><span class="p">:</span><span class="w"> </span><span class="nx">Use</span><span class="w"> </span><span class="nx">Ed25519</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">new</span><span class="w"> </span><span class="nx">systems</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="9-key-exchange">9. Key Exchange<a class="header-link" href="#9-key-exchange" title="Permanent link">&para;</a></h2>
<p>Key exchange protocols allow two parties to establish a shared secret over an insecure channel.</p>
<h3 id="91-diffie-hellman-key-exchange">9.1 Diffie-Hellman Key Exchange<a class="header-link" href="#91-diffie-hellman-key-exchange" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">               </span><span class="nv">Diffie</span><span class="o">-</span><span class="nv">Hellman</span><span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">Exchange</span><span class="w">                             </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">   </span><span class="nv">Alice</span><span class="w">                                        </span><span class="nv">Bob</span><span class="w">                   </span>â”‚
â”‚<span class="w">   </span>â”€â”€â”€â”€â”€<span class="w">                                        </span>â”€â”€â”€<span class="w">                   </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">   </span><span class="mi">1</span>.<span class="w"> </span><span class="nv">Choose</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="nv">key</span>:<span class="w"> </span><span class="nv">a</span><span class="w">                     </span><span class="mi">1</span>.<span class="w"> </span><span class="nv">Choose</span><span class="w"> </span><span class="nv">private</span>:<span class="w"> </span><span class="nv">b</span><span class="w">  </span>â”‚
â”‚<span class="w">   </span><span class="mi">2</span>.<span class="w"> </span><span class="nv">Compute</span>:<span class="w"> </span><span class="nv">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">a</span><span class="w"> </span><span class="nv">mod</span><span class="w"> </span><span class="nv">p</span><span class="w">                    </span><span class="mi">2</span>.<span class="w"> </span><span class="nv">Compute</span>:<span class="w"> </span><span class="nv">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">b</span><span class="w">   </span>â”‚
â”‚<span class="w">                                                    </span><span class="nv">mod</span><span class="w"> </span><span class="nv">p</span><span class="w">             </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">   </span><span class="mi">3</span>.<span class="w"> </span><span class="k">Send</span><span class="w"> </span><span class="nv">A</span><span class="w"> </span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶<span class="w"> </span><span class="nv">Receive</span><span class="w"> </span><span class="nv">A</span><span class="w">            </span>â”‚
â”‚<span class="w">      </span><span class="nv">Receive</span><span class="w"> </span><span class="nv">B</span><span class="w"> </span>â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<span class="w"> </span><span class="mi">4</span>.<span class="w"> </span><span class="k">Send</span><span class="w"> </span><span class="nv">B</span><span class="w">             </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">   </span><span class="mi">5</span>.<span class="w"> </span><span class="nv">Compute</span>:<span class="w">                                  </span><span class="mi">5</span>.<span class="w"> </span><span class="nv">Compute</span>:<span class="w">           </span>â”‚
â”‚<span class="w">      </span><span class="nv">shared</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">B</span><span class="o">^</span><span class="nv">a</span><span class="w"> </span><span class="nv">mod</span><span class="w"> </span><span class="nv">p</span><span class="w">                           </span><span class="nv">shared</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">A</span><span class="o">^</span><span class="nv">b</span><span class="w"> </span><span class="nv">mod</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span>â”‚
â”‚<span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="ss">(</span><span class="nv">g</span><span class="o">^</span><span class="nv">b</span><span class="ss">)</span><span class="o">^</span><span class="nv">a</span><span class="w"> </span><span class="nv">mod</span><span class="w"> </span><span class="nv">p</span><span class="w">                              </span><span class="o">=</span><span class="w"> </span><span class="ss">(</span><span class="nv">g</span><span class="o">^</span><span class="nv">a</span><span class="ss">)</span><span class="o">^</span><span class="nv">b</span><span class="w">   </span>â”‚
â”‚<span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="ss">(</span><span class="nv">ab</span><span class="ss">)</span><span class="w"> </span><span class="nv">mod</span><span class="w"> </span><span class="nv">p</span><span class="w">                                  </span><span class="nv">mod</span><span class="w"> </span><span class="nv">p</span><span class="w">    </span>â”‚
â”‚<span class="w">                                                          </span><span class="o">=</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="ss">(</span><span class="nv">ab</span><span class="ss">)</span><span class="w">    </span>â”‚
â”‚<span class="w">                                                            </span><span class="nv">mod</span><span class="w"> </span><span class="nv">p</span><span class="w">     </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">   </span><span class="nv">Both</span><span class="w"> </span><span class="nv">arrive</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">SAME</span><span class="w"> </span><span class="nv">shared</span><span class="w"> </span><span class="nv">secret</span>:<span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="ss">(</span><span class="nv">ab</span><span class="ss">)</span><span class="w"> </span><span class="nv">mod</span><span class="w"> </span><span class="nv">p</span><span class="w">               </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">   </span><span class="nv">Eve</span><span class="w"> </span><span class="nv">sees</span>:<span class="w"> </span><span class="nv">g</span>,<span class="w"> </span><span class="nv">p</span>,<span class="w"> </span><span class="nv">A</span><span class="o">=</span><span class="nv">g</span><span class="o">^</span><span class="nv">a</span>,<span class="w"> </span><span class="nv">B</span><span class="o">=</span><span class="nv">g</span><span class="o">^</span><span class="nv">b</span><span class="w">                                     </span>â”‚
â”‚<span class="w">   </span><span class="nv">Computing</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">A</span><span class="w"> </span><span class="nv">requires</span><span class="w"> </span><span class="nv">solving</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">Discrete</span><span class="w"> </span><span class="nv">Logarithm</span><span class="w">        </span>â”‚
â”‚<span class="w">   </span><span class="nv">Problem</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="nv">believed</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">computationally</span><span class="w"> </span><span class="nv">infeasible</span><span class="w"> </span><span class="k">for</span><span class="w">          </span>â”‚
â”‚<span class="w">   </span><span class="nv">large</span><span class="w"> </span><span class="nv">primes</span>.<span class="w">                                                     </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="92-ecdh-elliptic-curve-diffie-hellman">9.2 ECDH (Elliptic Curve Diffie-Hellman)<a class="header-link" href="#92-ecdh-elliptic-curve-diffie-hellman" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric</span><span class="w"> </span><span class="kn">import</span> <span class="n">ec</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">hashes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.kdf.hkdf</span><span class="w"> </span><span class="kn">import</span> <span class="n">HKDF</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ecdh_key_exchange</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Demonstrate ECDH key exchange between Alice and Bob.</span>
<span class="sd">    Uses X25519-equivalent (P-256 shown here for compatibility).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Alice generates her key pair</span>
    <span class="n">alice_private</span> <span class="o">=</span> <span class="n">ec</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span><span class="n">ec</span><span class="o">.</span><span class="n">SECP256R1</span><span class="p">())</span>
    <span class="n">alice_public</span> <span class="o">=</span> <span class="n">alice_private</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>

    <span class="c1"># Bob generates his key pair</span>
    <span class="n">bob_private</span> <span class="o">=</span> <span class="n">ec</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span><span class="n">ec</span><span class="o">.</span><span class="n">SECP256R1</span><span class="p">())</span>
    <span class="n">bob_public</span> <span class="o">=</span> <span class="n">bob_private</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>

    <span class="c1"># Alice computes shared secret using her private key + Bob&#39;s public key</span>
    <span class="n">alice_shared</span> <span class="o">=</span> <span class="n">alice_private</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">ec</span><span class="o">.</span><span class="n">ECDH</span><span class="p">(),</span> <span class="n">bob_public</span><span class="p">)</span>

    <span class="c1"># Bob computes shared secret using his private key + Alice&#39;s public key</span>
    <span class="n">bob_shared</span> <span class="o">=</span> <span class="n">bob_private</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">ec</span><span class="o">.</span><span class="n">ECDH</span><span class="p">(),</span> <span class="n">alice_public</span><span class="p">)</span>

    <span class="c1"># Both shared secrets are identical</span>
    <span class="k">assert</span> <span class="n">alice_shared</span> <span class="o">==</span> <span class="n">bob_shared</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ECDH shared secret: </span><span class="si">{</span><span class="n">alice_shared</span><span class="o">.</span><span class="n">hex</span><span class="p">()[:</span><span class="mi">32</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shared secret length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">alice_shared</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>

    <span class="c1"># Derive actual encryption key from shared secret using HKDF</span>
    <span class="c1"># (raw ECDH output should NOT be used directly as an encryption key)</span>
    <span class="n">alice_key</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span>
        <span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
        <span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>  <span class="c1"># 256-bit key for AES-256</span>
        <span class="n">salt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">info</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;ecdh-derived-key-v1&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">derive</span><span class="p">(</span><span class="n">alice_shared</span><span class="p">)</span>

    <span class="n">bob_key</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span>
        <span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
        <span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">salt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">info</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;ecdh-derived-key-v1&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">derive</span><span class="p">(</span><span class="n">bob_shared</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">alice_key</span> <span class="o">==</span> <span class="n">bob_key</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Derived AES key: </span><span class="si">{</span><span class="n">alice_key</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">alice_key</span>

<span class="n">derived_key</span> <span class="o">=</span> <span class="n">ecdh_key_exchange</span><span class="p">()</span>
</code></pre></div>

<h3 id="93-x25519-key-exchange">9.3 X25519 Key Exchange<a class="header-link" href="#93-x25519-key-exchange" title="Permanent link">&para;</a></h3>
<p>X25519 is the recommended ECDH curve for modern applications (used in TLS 1.3, WireGuard, Signal).</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric.x25519</span><span class="w"> </span><span class="kn">import</span> <span class="n">X25519PrivateKey</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.kdf.hkdf</span><span class="w"> </span><span class="kn">import</span> <span class="n">HKDF</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">hashes</span>

<span class="c1"># Alice</span>
<span class="n">alice_private</span> <span class="o">=</span> <span class="n">X25519PrivateKey</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
<span class="n">alice_public</span> <span class="o">=</span> <span class="n">alice_private</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>

<span class="c1"># Bob</span>
<span class="n">bob_private</span> <span class="o">=</span> <span class="n">X25519PrivateKey</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
<span class="n">bob_public</span> <span class="o">=</span> <span class="n">bob_private</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>

<span class="c1"># Exchange</span>
<span class="n">alice_shared</span> <span class="o">=</span> <span class="n">alice_private</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">bob_public</span><span class="p">)</span>
<span class="n">bob_shared</span> <span class="o">=</span> <span class="n">bob_private</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">alice_public</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">alice_shared</span> <span class="o">==</span> <span class="n">bob_shared</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X25519 shared secret: </span><span class="si">{</span><span class="n">alice_shared</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Derive keys using HKDF</span>
<span class="k">def</span><span class="w"> </span><span class="nf">derive_keys</span><span class="p">(</span><span class="n">shared_secret</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Derive separate keys for encryption and MAC from shared secret.&quot;&quot;&quot;</span>
    <span class="c1"># Encryption key</span>
    <span class="n">enc_key</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span>
        <span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
        <span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">salt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">info</span><span class="o">=</span><span class="n">context</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;-enc&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">derive</span><span class="p">(</span><span class="n">shared_secret</span><span class="p">)</span>

    <span class="c1"># MAC key (for additional message authentication if needed)</span>
    <span class="n">mac_key</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span>
        <span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
        <span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">salt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">info</span><span class="o">=</span><span class="n">context</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;-mac&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">derive</span><span class="p">(</span><span class="n">shared_secret</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;encryption_key&quot;</span><span class="p">:</span> <span class="n">enc_key</span><span class="p">,</span> <span class="s2">&quot;mac_key&quot;</span><span class="p">:</span> <span class="n">mac_key</span><span class="p">}</span>

<span class="n">keys</span> <span class="o">=</span> <span class="n">derive_keys</span><span class="p">(</span><span class="n">alice_shared</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;session-2026-01-15&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encryption key: </span><span class="si">{</span><span class="n">keys</span><span class="p">[</span><span class="s1">&#39;encryption_key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAC key:        </span><span class="si">{</span><span class="n">keys</span><span class="p">[</span><span class="s1">&#39;mac_key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="10-digital-signatures">10. Digital Signatures<a class="header-link" href="#10-digital-signatures" title="Permanent link">&para;</a></h2>
<p>Digital signatures provide authentication, integrity, and non-repudiation. They allow anyone to verify that a message was created by the holder of a specific private key and has not been modified.</p>
<h3 id="101-how-digital-signatures-work">10.1 How Digital Signatures Work<a class="header-link" href="#101-how-digital-signatures-work" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Digital Signature Process                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  SIGNING (by the author, using their private key):                  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Message  â”‚â”€â”€â”€â”€â–¶â”‚  Hash    â”‚â”€â”€â”€â”€â–¶â”‚  Sign    â”‚â”€â”€â”€â”€â–¶â”‚ Signature â”‚  â”‚
â”‚  â”‚          â”‚     â”‚ (SHA-256)â”‚     â”‚(Private  â”‚     â”‚           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  Key)    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                      â”‚
â”‚  VERIFICATION (by anyone, using the author&#39;s public key):           â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚ Message  â”‚â”€â”€â”€â”€â–¶â”‚  Hash    â”‚â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ (SHA-256)â”‚     â”‚                                â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â–¼                                â”‚
â”‚                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  Verify  â”‚â”€â”€â”€â”€â–¶â”‚ Valid /  â”‚       â”‚
â”‚  â”‚ Signature â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚(Public   â”‚     â”‚ Invalid  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  Key)    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="102-practical-document-signing-system">10.2 Practical: Document Signing System<a class="header-link" href="#102-practical-document-signing-system" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric.ed25519</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ed25519PrivateKey</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.serialization</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Encoding</span><span class="p">,</span> <span class="n">PublicFormat</span><span class="p">,</span> <span class="n">PrivateFormat</span><span class="p">,</span> <span class="n">NoEncryption</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SignedDocument</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A document with a digital signature.&quot;&quot;&quot;</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">author</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">public_key</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Base64-encoded public key</span>
    <span class="n">signature</span><span class="p">:</span> <span class="nb">str</span>   <span class="c1"># Base64-encoded signature</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DocumentSigner</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sign and verify documents using Ed25519.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">Ed25519PrivateKey</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_public_key_b64</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get base64-encoded public key for sharing.&quot;&quot;&quot;</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span><span class="n">Encoding</span><span class="o">.</span><span class="n">Raw</span><span class="p">,</span> <span class="n">PublicFormat</span><span class="o">.</span><span class="n">Raw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sign_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">author</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SignedDocument</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sign a document and return it with the signature.&quot;&quot;&quot;</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Create canonical message to sign</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_canonical_message</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

        <span class="c1"># Sign</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SignedDocument</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
            <span class="n">author</span><span class="o">=</span><span class="n">author</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="n">public_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_public_key_b64</span><span class="p">(),</span>
            <span class="n">signature</span><span class="o">=</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">verify_document</span><span class="p">(</span><span class="n">doc</span><span class="p">:</span> <span class="n">SignedDocument</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify a signed document. Returns verification result.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric.ed25519</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ed25519PublicKey</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Reconstruct the canonical message</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">DocumentSigner</span><span class="o">.</span><span class="n">_canonical_message</span><span class="p">(</span>
                <span class="n">doc</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">timestamp</span>
            <span class="p">)</span>

            <span class="c1"># Decode public key and signature</span>
            <span class="n">pub_bytes</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">public_key</span><span class="p">)</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">signature</span><span class="p">)</span>

            <span class="c1"># Load public key</span>
            <span class="n">public_key</span> <span class="o">=</span> <span class="n">Ed25519PublicKey</span><span class="o">.</span><span class="n">from_public_bytes</span><span class="p">(</span><span class="n">pub_bytes</span><span class="p">)</span>

            <span class="c1"># Verify</span>
            <span class="n">public_key</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
                <span class="s2">&quot;signed_at&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">timestamp</span><span class="p">),</span>
                <span class="s2">&quot;public_key&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">public_key</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
            <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_canonical_message</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">author</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a canonical byte representation for signing.&quot;&quot;&quot;</span>
        <span class="n">canonical</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
            <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="n">author</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
        <span class="p">},</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">canonical</span>

<span class="c1"># Create signers for Alice and Bob</span>
<span class="n">alice_signer</span> <span class="o">=</span> <span class="n">DocumentSigner</span><span class="p">()</span>
<span class="n">bob_signer</span> <span class="o">=</span> <span class="n">DocumentSigner</span><span class="p">()</span>

<span class="c1"># Alice signs a document</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">alice_signer</span><span class="o">.</span><span class="n">sign_document</span><span class="p">(</span>
    <span class="n">content</span><span class="o">=</span><span class="s2">&quot;I, Alice, hereby agree to pay Bob $100.&quot;</span><span class="p">,</span>
    <span class="n">author</span><span class="o">=</span><span class="s2">&quot;Alice&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Signed Document:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Content:   </span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Author:    </span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">author</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Timestamp: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Signature: </span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">signature</span><span class="p">[:</span><span class="mi">40</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

<span class="c1"># Anyone can verify using Alice&#39;s public key (embedded in document)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">DocumentSigner</span><span class="o">.</span><span class="n">verify_document</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Verification: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Tamper with the document</span>
<span class="n">tampered_doc</span> <span class="o">=</span> <span class="n">SignedDocument</span><span class="p">(</span>
    <span class="n">content</span><span class="o">=</span><span class="s2">&quot;I, Alice, hereby agree to pay Bob $10000.&quot;</span><span class="p">,</span>  <span class="c1"># Changed!</span>
    <span class="n">author</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
    <span class="n">timestamp</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
    <span class="n">public_key</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">public_key</span><span class="p">,</span>
    <span class="n">signature</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">tamper_result</span> <span class="o">=</span> <span class="n">DocumentSigner</span><span class="o">.</span><span class="n">verify_document</span><span class="p">(</span><span class="n">tampered_doc</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tampered verification: </span><span class="si">{</span><span class="n">tamper_result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="11-common-pitfalls-and-how-to-avoid-them">11. Common Pitfalls and How to Avoid Them<a class="header-link" href="#11-common-pitfalls-and-how-to-avoid-them" title="Permanent link">&para;</a></h2>
<h3 id="111-the-deadly-sins-of-cryptography">11.1 The Deadly Sins of Cryptography<a class="header-link" href="#111-the-deadly-sins-of-cryptography" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">          </span><span class="n">Top</span><span class="w"> </span><span class="n">Cryptographic</span><span class="w"> </span><span class="n">Pitfalls</span><span class="w"> </span><span class="p">(</span><span class="ow">and</span><span class="w"> </span><span class="n">How</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Avoid</span><span class="w"> </span><span class="n">Them</span><span class="p">)</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="c1">#  â”‚ Pitfall            â”‚ Correct Approach                          â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">ECB</span><span class="w"> </span><span class="n">mode</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">AES</span><span class="o">-</span><span class="n">GCM</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">ChaCha20</span><span class="o">-</span><span class="n">Poly1305</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Reusing</span><span class="w"> </span><span class="n">nonces</span><span class="o">/</span><span class="n">IVs</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">nonce</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="p">(</span><span class="ow">or</span><span class="w"> </span><span class="n">counter</span><span class="p">)</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">key</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">XChaCha20</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">random</span><span class="o">-</span><span class="n">safe</span><span class="w"> </span><span class="n">nonces</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">3</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Encrypt</span><span class="w"> </span><span class="n">without</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Always</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">AEAD</span><span class="w"> </span><span class="p">(</span><span class="n">GCM</span><span class="p">,</span><span class="w"> </span><span class="n">Poly1305</span><span class="p">)</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">authenticating</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Never</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">raw</span><span class="w"> </span><span class="n">CBC</span><span class="o">/</span><span class="n">CTR</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">4</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Rolling</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">own</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">established</span><span class="w"> </span><span class="n">libraries</span><span class="w"> </span><span class="p">(</span><span class="n">cryptography</span><span class="p">,</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">crypto</span><span class="w">             </span><span class="err">â”‚</span><span class="w"> </span><span class="n">libsodium</span><span class="o">/</span><span class="n">NaCl</span><span class="p">,</span><span class="w"> </span><span class="n">OpenSSL</span><span class="p">)</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">5</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Weak</span><span class="o">/</span><span class="n">predictable</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">secrets</span><span class="w"> </span><span class="n">module</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">numbers</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">NEVER</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">crypto</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">6</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Hardcoded</span><span class="w"> </span><span class="n">keys</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">management</span><span class="w"> </span><span class="p">(</span><span class="n">AWS</span><span class="w"> </span><span class="n">KMS</span><span class="p">,</span><span class="w"> </span><span class="n">Vault</span><span class="p">)</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="n">code</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Environment</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">minimum</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">7</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">MD5</span><span class="o">/</span><span class="n">SHA</span><span class="o">-</span><span class="mi">1</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="o">+</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">hashes</span><span class="p">,</span><span class="w"> </span><span class="n">bcrypt</span><span class="o">/</span><span class="n">argon2</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">passwords</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">passwords</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">8</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">RSA</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">PKCS</span><span class="c1">#1    â”‚ Use RSA-OAEP for encryption              â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">v1</span><span class="o">.</span><span class="mi">5</span><span class="w"> </span><span class="n">padding</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">RSA</span><span class="o">-</span><span class="n">PSS</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">signatures</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">9</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Comparing</span><span class="w"> </span><span class="n">MACs</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="o">==</span><span class="w">            </span><span class="err">â”‚</span><span class="w"> </span><span class="n">constant</span><span class="o">-</span><span class="n">time</span><span class="w"> </span><span class="n">comparison</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Not</span><span class="w"> </span><span class="n">rotating</span><span class="w"> </span><span class="n">keys</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Implement</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">rotation</span><span class="w"> </span><span class="n">schedules</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">versioning</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="112-nonce-reuse-disaster">11.2 Nonce Reuse Disaster<a class="header-link" href="#112-nonce-reuse-disaster" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.ciphers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cipher</span><span class="p">,</span> <span class="n">algorithms</span><span class="p">,</span> <span class="n">modes</span>

<span class="c1"># Demonstration: Why nonce reuse with CTR/GCM is catastrophic</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="n">nonce</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>  <span class="c1"># Same nonce used twice - BAD!</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ctr_encrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">):</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">modes</span><span class="o">.</span><span class="n">CTR</span><span class="p">(</span><span class="n">nonce</span><span class="p">))</span>
    <span class="n">encryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encryptor</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span> <span class="o">+</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

<span class="c1"># Two messages encrypted with the SAME key and nonce</span>
<span class="n">msg1</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Attack at dawn!!!&quot;</span>  <span class="c1"># 17 bytes</span>
<span class="n">msg2</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Retreat at night!&quot;</span>  <span class="c1"># 17 bytes</span>

<span class="n">ct1</span> <span class="o">=</span> <span class="n">ctr_encrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">msg1</span><span class="p">)</span>
<span class="n">ct2</span> <span class="o">=</span> <span class="n">ctr_encrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">msg2</span><span class="p">)</span>

<span class="c1"># XOR of two ciphertexts = XOR of two plaintexts!</span>
<span class="c1"># In CTR mode: ct = plaintext XOR keystream</span>
<span class="c1"># So: ct1 XOR ct2 = (msg1 XOR keystream) XOR (msg2 XOR keystream)</span>
<span class="c1">#                  = msg1 XOR msg2  (keystream cancels out!)</span>

<span class="n">xor_result</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ct1</span><span class="p">,</span> <span class="n">ct2</span><span class="p">))</span>
<span class="n">expected</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">msg1</span><span class="p">,</span> <span class="n">msg2</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nonce Reuse Attack Demonstration:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ct1 XOR ct2:  </span><span class="si">{</span><span class="n">xor_result</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  msg1 XOR msg2: </span><span class="si">{</span><span class="n">expected</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Match: </span><span class="si">{</span><span class="n">xor_result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  An attacker who knows msg1 can recover msg2:&quot;</span><span class="p">)</span>
<span class="n">recovered</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xor_result</span><span class="p">,</span> <span class="n">msg1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Recovered msg2: </span><span class="si">{</span><span class="n">recovered</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  LESSON: Never reuse a nonce with the same key!&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="113-secure-vs-insecure-random">11.3 Secure vs Insecure Random<a class="header-link" href="#113-secure-vs-insecure-random" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="c1"># INSECURE - never use for cryptography</span>
<span class="c1"># random.random() uses Mersenne Twister (MT19937)</span>
<span class="c1"># It is deterministic and predictable if you observe enough outputs</span>
<span class="n">insecure_key</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">)])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INSECURE key: </span><span class="si">{</span><span class="n">insecure_key</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Source: random.random() - Mersenne Twister (PREDICTABLE)&quot;</span><span class="p">)</span>

<span class="c1"># SECURE - use for cryptography</span>
<span class="n">secure_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SECURE key:   </span><span class="si">{</span><span class="n">secure_key</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Source: os.urandom() - OS CSPRNG (/dev/urandom)&quot;</span><span class="p">)</span>

<span class="c1"># ALSO SECURE - Python 3.6+ secrets module</span>
<span class="n">secure_token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SECURE key:   </span><span class="si">{</span><span class="n">secure_token</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Source: secrets.token_bytes() - wraps os.urandom()&quot;</span><span class="p">)</span>

<span class="c1"># For URL-safe tokens</span>
<span class="n">url_token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">URL-safe token: </span><span class="si">{</span><span class="n">url_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># For comparison tokens (timing-safe)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Constant-time comparison: </span><span class="si">{</span><span class="n">secrets</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="12-modern-recommendations">12. Modern Recommendations<a class="header-link" href="#12-modern-recommendations" title="Permanent link">&para;</a></h2>
<h3 id="121-algorithm-selection-guide-2025">12.1 Algorithm Selection Guide (2025+)<a class="header-link" href="#121-algorithm-selection-guide-2025" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">               </span><span class="nv">Modern</span><span class="w"> </span><span class="nv">Cryptographic</span><span class="w"> </span><span class="nv">Recommendations</span><span class="w">                   </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">Use</span><span class="w"> </span><span class="nv">Case</span><span class="w">        </span>â”‚<span class="w"> </span><span class="nv">Recommended</span><span class="w"> </span><span class="nv">Algorithm</span><span class="ss">(</span><span class="nv">s</span><span class="ss">)</span><span class="w">                          </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">Symmetric</span><span class="w"> </span><span class="nv">enc</span>.<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">AES</span><span class="o">-</span><span class="mi">256</span><span class="o">-</span><span class="nv">GCM</span><span class="w"> </span><span class="ss">(</span><span class="nv">with</span><span class="w"> </span><span class="nv">hardware</span><span class="ss">)</span><span class="w"> </span><span class="nv">or</span><span class="w">                   </span>â”‚
â”‚<span class="w">                 </span>â”‚<span class="w"> </span><span class="nv">ChaCha20</span><span class="o">-</span><span class="nv">Poly1305</span><span class="w"> </span><span class="ss">(</span><span class="nv">without</span><span class="w"> </span><span class="nv">hardware</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">mobile</span><span class="ss">)</span><span class="w">     </span>â”‚
â”‚<span class="w">                 </span>â”‚<span class="w"> </span><span class="nv">XChaCha20</span><span class="o">-</span><span class="nv">Poly1305</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">random</span><span class="w"> </span><span class="nv">nonces</span><span class="w"> </span><span class="nv">needed</span><span class="w">       </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">exchange</span><span class="w">    </span>â”‚<span class="w"> </span><span class="nv">X25519</span><span class="w"> </span><span class="ss">(</span><span class="nv">ECDH</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">Curve25519</span><span class="ss">)</span><span class="w">                    </span>â”‚
â”‚<span class="w">                 </span>â”‚<span class="w"> </span><span class="nv">ML</span><span class="o">-</span><span class="nv">KEM</span><span class="w"> </span><span class="ss">(</span><span class="nv">post</span><span class="o">-</span><span class="nv">quantum</span>,<span class="w"> </span><span class="nv">hybrid</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">X25519</span><span class="ss">)</span><span class="w">        </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">Digital</span><span class="w"> </span><span class="nv">sig</span>.<span class="w">    </span>â”‚<span class="w"> </span><span class="nv">Ed25519</span><span class="w"> </span><span class="ss">(</span><span class="nv">general</span><span class="w"> </span><span class="nv">purpose</span><span class="ss">)</span><span class="w">                        </span>â”‚
â”‚<span class="w">                 </span>â”‚<span class="w"> </span><span class="nv">Ed448</span><span class="w"> </span><span class="ss">(</span><span class="nv">higher</span><span class="w"> </span><span class="nv">security</span><span class="w"> </span><span class="nv">margin</span><span class="ss">)</span><span class="w">                   </span>â”‚
â”‚<span class="w">                 </span>â”‚<span class="w"> </span><span class="nv">ECDSA</span><span class="w"> </span><span class="nv">P</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="ss">(</span><span class="nv">legacy</span><span class="w"> </span><span class="nv">compatibility</span><span class="ss">)</span><span class="w">               </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">Hashing</span><span class="w">         </span>â”‚<span class="w"> </span><span class="nv">SHA</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">SHA</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="ss">(</span><span class="nv">general</span><span class="ss">)</span><span class="w">                    </span>â”‚
â”‚<span class="w">                 </span>â”‚<span class="w"> </span><span class="nv">BLAKE3</span><span class="w"> </span><span class="ss">(</span><span class="nv">speed</span><span class="o">-</span><span class="nv">critical</span><span class="ss">)</span><span class="w">                          </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">Password</span><span class="w"> </span><span class="nv">hash</span><span class="w">   </span>â”‚<span class="w"> </span><span class="nv">Argon2id</span><span class="w"> </span><span class="ss">(</span><span class="nv">preferred</span><span class="ss">)</span><span class="w">                             </span>â”‚
â”‚<span class="w">                 </span>â”‚<span class="w"> </span><span class="nv">bcrypt</span><span class="w"> </span><span class="ss">(</span><span class="nv">widely</span><span class="w"> </span><span class="nv">supported</span><span class="ss">)</span><span class="w">                        </span>â”‚
â”‚<span class="w">                 </span>â”‚<span class="w"> </span><span class="nv">scrypt</span><span class="w"> </span><span class="ss">(</span><span class="nv">memory</span><span class="o">-</span><span class="nv">hard</span><span class="w"> </span><span class="nv">alternative</span><span class="ss">)</span><span class="w">                 </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">derivation</span><span class="w">  </span>â”‚<span class="w"> </span><span class="nv">HKDF</span><span class="o">-</span><span class="nv">SHA256</span><span class="w"> </span><span class="ss">(</span><span class="nv">from</span><span class="w"> </span><span class="nv">high</span><span class="o">-</span><span class="nv">entropy</span><span class="w"> </span><span class="nv">input</span><span class="ss">)</span><span class="w">            </span>â”‚
â”‚<span class="w">                 </span>â”‚<span class="w"> </span><span class="nv">Argon2id</span><span class="w"> </span><span class="ss">(</span><span class="nv">from</span><span class="w"> </span><span class="nv">passwords</span><span class="ss">)</span><span class="w">                        </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">TLS</span><span class="w">             </span>â”‚<span class="w"> </span><span class="nv">TLS</span><span class="w"> </span><span class="mi">1</span>.<span class="mi">3</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">X25519</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">AES</span><span class="o">-</span><span class="mi">256</span><span class="o">-</span><span class="nv">GCM</span><span class="w">               </span>â”‚
â”‚<span class="w">                 </span>â”‚<span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">ChaCha20</span><span class="o">-</span><span class="nv">Poly1305</span><span class="w">                              </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">AVOID</span><span class="w">           </span>â”‚<span class="w"> </span><span class="nv">MD5</span>,<span class="w"> </span><span class="nv">SHA</span><span class="o">-</span><span class="mi">1</span>,<span class="w"> </span><span class="nv">DES</span>,<span class="w"> </span><span class="mi">3</span><span class="nv">DES</span>,<span class="w"> </span><span class="nv">RC4</span>,<span class="w"> </span><span class="nv">RSA</span><span class="o">-</span><span class="mi">1024</span>,<span class="w">           </span>â”‚
â”‚<span class="w">                 </span>â”‚<span class="w"> </span><span class="nv">ECB</span><span class="w"> </span><span class="nv">mode</span>,<span class="w"> </span><span class="nv">PKCS</span><span class="sc">#1</span><span class="w"> </span><span class="nv">v1</span>.<span class="mi">5</span>,<span class="w"> </span><span class="nv">custom</span><span class="w"> </span><span class="nv">algorithms</span><span class="w">        </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="122-key-size-recommendations">12.2 Key Size Recommendations<a class="header-link" href="#122-key-size-recommendations" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">              </span><span class="nv">Minimum</span><span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">Sizes</span><span class="w"> </span><span class="ss">(</span><span class="nv">NIST</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">ANSSI</span><span class="w"> </span><span class="mi">2025</span><span class="o">+</span><span class="ss">)</span><span class="w">                  </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">Algorithm</span><span class="w">           </span>â”‚<span class="w"> </span><span class="nv">Minimum</span><span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">Size</span><span class="w">                              </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">AES</span><span class="w">                 </span>â”‚<span class="w"> </span><span class="mi">128</span><span class="o">-</span><span class="nv">bit</span><span class="w"> </span><span class="ss">(</span><span class="mi">256</span><span class="o">-</span><span class="nv">bit</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">post</span><span class="o">-</span><span class="nv">quantum</span><span class="w"> </span><span class="nv">margin</span><span class="ss">)</span><span class="w">    </span>â”‚
â”‚<span class="w"> </span><span class="nv">RSA</span><span class="w"> </span><span class="ss">(</span><span class="k">if</span><span class="w"> </span><span class="nv">you</span><span class="w"> </span><span class="nv">must</span><span class="ss">)</span><span class="w">   </span>â”‚<span class="w"> </span><span class="mi">3072</span><span class="o">-</span><span class="nv">bit</span><span class="w"> </span><span class="ss">(</span><span class="mi">4096</span><span class="w"> </span><span class="nv">recommended</span><span class="ss">)</span><span class="w">                  </span>â”‚
â”‚<span class="w"> </span><span class="nv">ECDSA</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">ECDH</span><span class="w">        </span>â”‚<span class="w"> </span><span class="nv">P</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">Curve25519</span><span class="w"> </span><span class="ss">(</span><span class="mi">256</span><span class="o">-</span><span class="nv">bit</span><span class="ss">)</span><span class="w">                </span>â”‚
â”‚<span class="w"> </span><span class="nv">EdDSA</span><span class="w">               </span>â”‚<span class="w"> </span><span class="nv">Ed25519</span><span class="w"> </span><span class="ss">(</span><span class="mi">256</span><span class="o">-</span><span class="nv">bit</span><span class="ss">)</span><span class="w">                            </span>â”‚
â”‚<span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="nv">output</span><span class="w">         </span>â”‚<span class="w"> </span><span class="mi">256</span><span class="o">-</span><span class="nv">bit</span><span class="w"> </span><span class="ss">(</span><span class="nv">SHA</span><span class="o">-</span><span class="mi">256</span>,<span class="w"> </span><span class="nv">SHA</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="mi">256</span>,<span class="w"> </span><span class="nv">BLAKE2b</span><span class="o">-</span><span class="mi">256</span><span class="ss">)</span><span class="w">   </span>â”‚
â”‚<span class="w"> </span><span class="nv">HMAC</span><span class="w"> </span><span class="nv">key</span><span class="w">            </span>â”‚<span class="w"> </span><span class="nv">Same</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">hash</span><span class="w"> </span><span class="nv">output</span><span class="w"> </span><span class="nv">size</span><span class="w"> </span><span class="ss">(</span><span class="mi">256</span><span class="o">-</span><span class="nv">bit</span><span class="ss">)</span><span class="w">           </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="123-post-quantum-cryptography">12.3 Post-Quantum Cryptography<a class="header-link" href="#123-post-quantum-cryptography" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">              </span><span class="nv">Post</span><span class="o">-</span><span class="nv">Quantum</span><span class="w"> </span><span class="nv">Cryptography</span><span class="w"> </span><span class="ss">(</span><span class="nv">PQC</span><span class="ss">)</span><span class="w">                         </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Problem</span>:<span class="w"> </span><span class="nv">Quantum</span><span class="w"> </span><span class="nv">computers</span><span class="w"> </span><span class="ss">(</span><span class="nv">Shor</span><span class="err">&#39;s algorithm) will break:          â”‚</span>
<span class="err">â”‚  - RSA (factoring)                                                  â”‚</span>
<span class="err">â”‚  - ECDSA/ECDH (elliptic curve discrete log)                        â”‚</span>
<span class="err">â”‚  - DH (discrete log)                                                â”‚</span>
<span class="err">â”‚                                                                      â”‚</span>
<span class="err">â”‚  NOT affected by quantum:                                            â”‚</span>
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">AES</span><span class="w"> </span><span class="ss">(</span><span class="nv">Grover</span><span class="err">&#39;s algorithm halves effective key size:               â”‚</span>
<span class="err">â”‚    AES-256 â†’ ~128-bit security, still safe)                        â”‚</span>
<span class="err">â”‚  - SHA-256 (similar halving, still adequate)                        â”‚</span>
<span class="err">â”‚                                                                      â”‚</span>
<span class="err">â”‚  NIST PQC Standards (finalized 2024):                               â”‚</span>
<span class="err">â”‚  â”œâ”€â”€ ML-KEM (CRYSTALS-Kyber) â€” key encapsulation                   â”‚</span>
<span class="err">â”‚  â”œâ”€â”€ ML-DSA (CRYSTALS-Dilithium) â€” digital signatures              â”‚</span>
<span class="err">â”‚  â”œâ”€â”€ SLH-DSA (SPHINCS+) â€” hash-based signatures                   â”‚</span>
<span class="err">â”‚  â””â”€â”€ FN-DSA (FALCON) â€” lattice-based signatures                   â”‚</span>
<span class="err">â”‚                                                                      â”‚</span>
<span class="err">â”‚  Current recommendation: Hybrid mode                                â”‚</span>
<span class="err">â”‚  - Use X25519 + ML-KEM together for key exchange                   â”‚</span>
<span class="err">â”‚  - If classical OR PQ algorithm is broken, you are still safe      â”‚</span>
<span class="err">â”‚  - Chrome, Firefox, and Cloudflare already support hybrid PQ       â”‚</span>
<span class="err">â”‚                                                                      â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="13-exercises">13. Exercises<a class="header-link" href="#13-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-symmetric-encryption-beginner">Exercise 1: Symmetric Encryption (Beginner)<a class="header-link" href="#exercise-1-symmetric-encryption-beginner" title="Permanent link">&para;</a></h3>
<p>Write a Python function that:
1. Takes a plaintext string and a password as input
2. Derives an AES-256 key from the password using PBKDF2 (with a random salt)
3. Encrypts the plaintext with AES-GCM
4. Returns a single base64-encoded string containing: salt + nonce + ciphertext
5. Write the corresponding decryption function</p>
<p>Hints:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.kdf.pbkdf2</span><span class="w"> </span><span class="kn">import</span> <span class="n">PBKDF2HMAC</span>
<span class="c1"># Use iterations=600000, salt_size=16, nonce_size=12</span>
</code></pre></div>

<h3 id="exercise-2-hybrid-encryption-intermediate">Exercise 2: Hybrid Encryption (Intermediate)<a class="header-link" href="#exercise-2-hybrid-encryption-intermediate" title="Permanent link">&para;</a></h3>
<p>Implement a simplified version of PGP-like encryption:
1. Alice generates an RSA-4096 key pair
2. Bob generates an RSA-4096 key pair
3. Alice wants to send a signed and encrypted message to Bob:
   - Sign the message with Alice's private key
   - Generate a random AES-256 key
   - Encrypt the message with AES-GCM
   - Encrypt the AES key with Bob's public RSA key
   - Package: encrypted_key + nonce + ciphertext + signature + alice_public_key
4. Bob receives the package and:
   - Decrypts the AES key with his private RSA key
   - Decrypts the message with AES-GCM
   - Verifies the signature using Alice's public key</p>
<h3 id="exercise-3-key-exchange-protocol-intermediate">Exercise 3: Key Exchange Protocol (Intermediate)<a class="header-link" href="#exercise-3-key-exchange-protocol-intermediate" title="Permanent link">&para;</a></h3>
<p>Simulate a secure chat between Alice and Bob:
1. Both perform X25519 key exchange
2. Derive separate keys for each direction (Alice-to-Bob, Bob-to-Alice) using HKDF
3. Each message gets a unique nonce (use a counter)
4. Messages are encrypted with ChaCha20-Poly1305
5. Include a message counter to detect replay attacks</p>
<h3 id="exercise-4-nonce-reuse-attack-advanced">Exercise 4: Nonce Reuse Attack (Advanced)<a class="header-link" href="#exercise-4-nonce-reuse-attack-advanced" title="Permanent link">&para;</a></h3>
<p>Given two ciphertexts encrypted with AES-CTR using the same key and nonce:</p>
<div class="highlight"><pre><span></span><code>ct1 = bytes.fromhex(&quot;a1b2c3d4e5f6071829&quot;)
ct2 = bytes.fromhex(&quot;b4a3d2c5f4e7162738&quot;)
</code></pre></div>

<p>And knowing that plaintext1 is <code>b"plaintext"</code>:
1. Recover plaintext2
2. Explain why this attack works mathematically
3. Describe how to prevent this vulnerability</p>
<h3 id="exercise-5-digital-signature-verification-advanced">Exercise 5: Digital Signature Verification (Advanced)<a class="header-link" href="#exercise-5-digital-signature-verification-advanced" title="Permanent link">&para;</a></h3>
<p>Build a simple code-signing system:
1. A "publisher" signs Python scripts with Ed25519
2. A "runner" verifies signatures before executing scripts
3. Maintain a registry of trusted public keys
4. Handle key rotation (old signatures should remain valid with old keys)
5. Add timestamp verification (reject signatures older than 30 days)</p>
<h3 id="exercise-6-cryptographic-audit-advanced">Exercise 6: Cryptographic Audit (Advanced)<a class="header-link" href="#exercise-6-cryptographic-audit-advanced" title="Permanent link">&para;</a></h3>
<p>Review the following code and identify ALL cryptographic vulnerabilities. There are at least 8 issues:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Crypto.Cipher</span><span class="w"> </span><span class="kn">import</span> <span class="n">AES</span>  <span class="c1"># PyCryptodome</span>

<span class="k">def</span><span class="w"> </span><span class="nf">encrypt_message</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>  <span class="c1"># 128-bit key from MD5</span>
    <span class="n">iv</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">16</span>  <span class="c1"># Static IV</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>

    <span class="c1"># Manual padding</span>
    <span class="n">pad_len</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">padded</span> <span class="o">=</span> <span class="n">message</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">pad_len</span><span class="p">)</span> <span class="o">*</span> <span class="n">pad_len</span>

    <span class="n">encrypted</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">padded</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">stored_hash</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span> <span class="n">stored_hash</span>
</code></pre></div>

<p>For each vulnerability, explain:
- What is wrong
- Why it is dangerous
- How to fix it</p>
<hr />
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li>Ferguson, Schneier, Kohno. <em>Cryptography Engineering</em>. Wiley, 2010.</li>
<li>Bernstein, D.J. "Curve25519: New Diffie-Hellman Speed Records". 2006.</li>
<li>NIST SP 800-175B: Guideline for Using Cryptographic Standards</li>
<li>NIST Post-Quantum Cryptography - https://csrc.nist.gov/projects/post-quantum-cryptography</li>
<li>Python <code>cryptography</code> library docs - https://cryptography.io/</li>
<li>Latacora, "Cryptographic Right Answers" (2018, updated regularly)</li>
<li>RFC 8032: Edwards-Curve Digital Signature Algorithm (EdDSA)</li>
<li>RFC 8439: ChaCha20 and Poly1305 for IETF Protocols</li>
</ul>
<hr />
<p><strong>Previous</strong>: <a href="./01_Security_Fundamentals.md">01. Security Fundamentals</a> | <strong>Next</strong>: <a href="./03_Hashing_and_Integrity.md">03. Hashing and Data Integrity</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/01_Security_Fundamentals.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Security Fundamentals and Threat Modeling</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/03_Hashing_and_Integrity.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Hashing and Data Integrity</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}