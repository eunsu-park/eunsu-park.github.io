{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hashing and Data Integrity - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Security/">Security</a>
    <span class="separator">/</span>
    <span class="current">Hashing and Data Integrity</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Hashing and Data Integrity</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/02_Cryptography_Basics.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Cryptography Basics</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/04_TLS_and_PKI.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">TLS/SSL and Public Key Infrastructure</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-what-is-a-hash-function">1. What Is a Hash Function?</a><ul>
<li><a href="#11-non-cryptographic-vs-cryptographic-hashes">1.1 Non-Cryptographic vs Cryptographic Hashes</a></li>
</ul>
</li>
<li><a href="#2-cryptographic-hash-properties">2. Cryptographic Hash Properties</a><ul>
<li><a href="#21-the-avalanche-effect">2.1 The Avalanche Effect</a></li>
</ul>
</li>
<li><a href="#3-hash-function-survey">3. Hash Function Survey</a><ul>
<li><a href="#31-hash-function-comparison">3.1 Hash Function Comparison</a></li>
<li><a href="#32-sha-2-family">3.2 SHA-2 Family</a></li>
<li><a href="#33-sha-3-keccak">3.3 SHA-3 (Keccak)</a></li>
<li><a href="#34-blake2-and-blake3">3.4 BLAKE2 and BLAKE3</a></li>
</ul>
</li>
<li><a href="#4-python-hashing-with-hashlib">4. Python Hashing with hashlib</a><ul>
<li><a href="#41-basic-hashing">4.1 Basic Hashing</a></li>
<li><a href="#42-incremental-hashing-streaming">4.2 Incremental Hashing (Streaming)</a></li>
<li><a href="#43-blake2-with-key-keyed-hashing">4.3 BLAKE2 with Key (Keyed Hashing)</a></li>
<li><a href="#44-blake3">4.4 BLAKE3</a></li>
</ul>
</li>
<li><a href="#5-password-hashing">5. Password Hashing</a><ul>
<li><a href="#51-bcrypt">5.1 bcrypt</a></li>
<li><a href="#52-scrypt">5.2 scrypt</a></li>
<li><a href="#53-argon2-recommended">5.3 Argon2 (Recommended)</a></li>
<li><a href="#54-password-hashing-comparison">5.4 Password Hashing Comparison</a></li>
<li><a href="#55-complete-password-storage-system">5.5 Complete Password Storage System</a></li>
</ul>
</li>
<li><a href="#6-hmac-message-authentication">6. HMAC: Message Authentication</a><ul>
<li><a href="#61-hmac-in-python">6.1 HMAC in Python</a></li>
<li><a href="#62-practical-api-request-signing">6.2 Practical: API Request Signing</a></li>
<li><a href="#63-webhook-signature-verification">6.3 Webhook Signature Verification</a></li>
</ul>
</li>
<li><a href="#7-merkle-trees">7. Merkle Trees</a><ul>
<li><a href="#71-merkle-tree-implementation">7.1 Merkle Tree Implementation</a></li>
</ul>
</li>
<li><a href="#8-content-addressable-storage">8. Content-Addressable Storage</a><ul>
<li><a href="#81-cas-implementation">8.1 CAS Implementation</a></li>
<li><a href="#82-git-style-object-store">8.2 Git-Style Object Store</a></li>
</ul>
</li>
<li><a href="#9-timing-attacks-and-constant-time-comparison">9. Timing Attacks and Constant-Time Comparison</a><ul>
<li><a href="#91-the-problem">9.1 The Problem</a></li>
<li><a href="#92-vulnerable-vs-secure-comparison">9.2 Vulnerable vs Secure Comparison</a></li>
<li><a href="#93-rules-for-timing-safe-code">9.3 Rules for Timing-Safe Code</a></li>
</ul>
</li>
<li><a href="#10-hash-function-attacks-and-mitigations">10. Hash Function Attacks and Mitigations</a><ul>
<li><a href="#101-known-attacks">10.1 Known Attacks</a></li>
<li><a href="#102-length-extension-attack">10.2 Length-Extension Attack</a></li>
</ul>
</li>
<li><a href="#11-exercises">11. Exercises</a><ul>
<li><a href="#exercise-1-hash-explorer-beginner">Exercise 1: Hash Explorer (Beginner)</a></li>
<li><a href="#exercise-2-password-cracker-defense-intermediate">Exercise 2: Password Cracker Defense (Intermediate)</a></li>
<li><a href="#exercise-3-merkle-tree-file-verifier-intermediate">Exercise 3: Merkle Tree File Verifier (Intermediate)</a></li>
<li><a href="#exercise-4-hmac-based-api-authentication-intermediate">Exercise 4: HMAC-based API Authentication (Intermediate)</a></li>
<li><a href="#exercise-5-content-addressable-file-sync-advanced">Exercise 5: Content-Addressable File Sync (Advanced)</a></li>
<li><a href="#exercise-6-timing-attack-lab-advanced">Exercise 6: Timing Attack Lab (Advanced)</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="hashing-and-data-integrity">Hashing and Data Integrity<a class="header-link" href="#hashing-and-data-integrity" title="Permanent link">&para;</a></h1>
<p><strong>Previous</strong>: <a href="./02_Cryptography_Basics.md">02. Cryptography Basics</a> | <strong>Next</strong>: <a href="./04_TLS_and_PKI.md">04. TLS/SSL and Public Key Infrastructure</a></p>
<hr />
<p>Hash functions are the workhorses of modern security. They appear everywhere: password storage, digital signatures, message authentication, blockchain, software distribution, and data deduplication. This lesson covers hash functions in depth, from the mathematical properties that make them useful to practical implementations of password hashing, HMACs, and Merkle trees.</p>
<p><strong>Difficulty</strong>: â­â­â­</p>
<p><strong>Learning Objectives</strong>:
- Understand the properties of cryptographic hash functions
- Implement hashing with SHA-256, SHA-3, BLAKE2, and BLAKE3
- Store passwords securely using bcrypt, scrypt, and Argon2
- Construct and verify HMACs for message authentication
- Build and understand Merkle trees
- Implement content-addressable storage
- Recognize and prevent timing attacks using constant-time comparison</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-what-is-a-hash-function">What Is a Hash Function?</a></li>
<li><a href="#2-cryptographic-hash-properties">Cryptographic Hash Properties</a></li>
<li><a href="#3-hash-function-survey">Hash Function Survey</a></li>
<li><a href="#4-python-hashing-with-hashlib">Python Hashing with hashlib</a></li>
<li><a href="#5-password-hashing">Password Hashing</a></li>
<li><a href="#6-hmac-message-authentication">HMAC: Message Authentication</a></li>
<li><a href="#7-merkle-trees">Merkle Trees</a></li>
<li><a href="#8-content-addressable-storage">Content-Addressable Storage</a></li>
<li><a href="#9-timing-attacks-and-constant-time-comparison">Timing Attacks and Constant-Time Comparison</a></li>
<li><a href="#10-hash-function-attacks-and-mitigations">Hash Function Attacks and Mitigations</a></li>
<li><a href="#11-exercises">Exercises</a></li>
<li><a href="#12-references">References</a></li>
</ol>
<hr />
<h2 id="1-what-is-a-hash-function">1. What Is a Hash Function?<a class="header-link" href="#1-what-is-a-hash-function" title="Permanent link">&para;</a></h2>
<p>A hash function takes an arbitrary-length input and produces a fixed-length output (the "hash" or "digest"). A <strong>cryptographic</strong> hash function has additional security properties that make it suitable for security applications.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Hash Function                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚   Input (any size)           Hash Function         Output (fixed)    â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                                      â”‚
â”‚   &quot;Hello&quot;           â”€â”€â”€â”€â”€â”€â–¶  SHA-256  â”€â”€â”€â”€â”€â”€â–¶  2cf24dba5fb0...      â”‚
â”‚   (5 bytes)                                    (32 bytes / 256 bits) â”‚
â”‚                                                                      â”‚
â”‚   &quot;Hello World&quot;     â”€â”€â”€â”€â”€â”€â–¶  SHA-256  â”€â”€â”€â”€â”€â”€â–¶  a591a6d40bf4...      â”‚
â”‚   (11 bytes)                                   (32 bytes / 256 bits) â”‚
â”‚                                                                      â”‚
â”‚   War and Peace     â”€â”€â”€â”€â”€â”€â–¶  SHA-256  â”€â”€â”€â”€â”€â”€â–¶  b28f8b893c45...      â”‚
â”‚   (~3.2 MB)                                    (32 bytes / 256 bits) â”‚
â”‚                                                                      â”‚
â”‚   Key insight: Regardless of input size, the output is ALWAYS       â”‚
â”‚   the same fixed size.                                              â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="11-non-cryptographic-vs-cryptographic-hashes">1.1 Non-Cryptographic vs Cryptographic Hashes<a class="header-link" href="#11-non-cryptographic-vs-cryptographic-hashes" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">        </span><span class="nv">Non</span><span class="o">-</span><span class="nv">Cryptographic</span><span class="w"> </span><span class="nv">vs</span><span class="w"> </span><span class="nv">Cryptographic</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="nv">Functions</span><span class="w">             </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                  </span>â”‚<span class="w"> </span><span class="nv">Non</span><span class="o">-</span><span class="nv">Cryptographic</span><span class="w">    </span>â”‚<span class="w"> </span><span class="nv">Cryptographic</span><span class="w">              </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">Purpose</span><span class="w">          </span>â”‚<span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="nv">tables</span>,<span class="w"> </span><span class="nv">checksums</span>â”‚<span class="w"> </span><span class="nv">Security</span><span class="w"> </span><span class="nv">applications</span><span class="w">     </span>â”‚
â”‚<span class="w"> </span><span class="nv">Speed</span><span class="w">            </span>â”‚<span class="w"> </span><span class="nv">Extremely</span><span class="w"> </span><span class="nv">fast</span><span class="w">       </span>â”‚<span class="w"> </span><span class="nv">Intentionally</span><span class="w"> </span><span class="nv">slower</span><span class="w">      </span>â”‚
â”‚<span class="w"> </span><span class="nv">Collision</span><span class="w"> </span><span class="nv">resist</span>.â”‚<span class="w"> </span><span class="nv">Weak</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">none</span><span class="w">          </span>â”‚<span class="w"> </span><span class="nv">Strong</span><span class="w"> </span><span class="ss">(</span><span class="nv">required</span><span class="ss">)</span><span class="w">         </span>â”‚
â”‚<span class="w"> </span><span class="nv">Pre</span><span class="o">-</span><span class="nv">image</span><span class="w"> </span><span class="nv">resist</span>.â”‚<span class="w"> </span><span class="nv">Not</span><span class="w"> </span><span class="nv">guaranteed</span><span class="w">       </span>â”‚<span class="w"> </span><span class="nv">Strong</span><span class="w"> </span><span class="ss">(</span><span class="nv">required</span><span class="ss">)</span><span class="w">         </span>â”‚
â”‚<span class="w"> </span><span class="nv">Examples</span><span class="w">         </span>â”‚<span class="w"> </span><span class="k">CRC32</span>,<span class="w"> </span><span class="nv">MurmurHash</span>,<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">SHA</span><span class="o">-</span><span class="mi">256</span>,<span class="w"> </span><span class="nv">SHA</span><span class="o">-</span><span class="mi">3</span>,<span class="w"> </span><span class="nv">BLAKE2</span>,<span class="w">  </span>â”‚
â”‚<span class="w">                  </span>â”‚<span class="w"> </span><span class="nv">xxHash</span>,<span class="w"> </span><span class="nv">FNV</span><span class="w">          </span>â”‚<span class="w"> </span><span class="nv">BLAKE3</span><span class="w">                    </span>â”‚
â”‚<span class="w"> </span><span class="nv">Use</span><span class="w"> </span><span class="nv">cases</span><span class="w">        </span>â”‚<span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="nv">maps</span>,<span class="w"> </span><span class="nv">checksums</span>,â”‚<span class="w"> </span><span class="nv">Passwords</span>,<span class="w"> </span><span class="nv">signatures</span>,<span class="w">   </span>â”‚
â”‚<span class="w">                  </span>â”‚<span class="w"> </span><span class="nv">deduplication</span><span class="w">        </span>â”‚<span class="w"> </span><span class="nv">certificates</span>,<span class="w"> </span><span class="nv">HMAC</span><span class="w">       </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w"> </span><span class="nv">RULE</span>:<span class="w"> </span><span class="nv">NEVER</span><span class="w"> </span><span class="nv">use</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">non</span><span class="o">-</span><span class="nv">cryptographic</span><span class="w"> </span><span class="nv">hash</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">security</span><span class="w"> </span><span class="nv">purposes</span>.<span class="w">    </span>â”‚
â”‚<span class="w"> </span><span class="nv">NEVER</span><span class="w"> </span><span class="nv">use</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">cryptographic</span><span class="w"> </span><span class="nv">hash</span><span class="w"> </span><span class="nv">where</span><span class="w"> </span><span class="nv">speed</span><span class="w"> </span><span class="nv">matters</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">security</span><span class="w">    </span>â”‚
â”‚<span class="w"> </span><span class="nv">does</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="ss">(</span><span class="nv">e</span>.<span class="nv">g</span>.,<span class="w"> </span><span class="nv">hash</span><span class="w"> </span><span class="nv">tables</span><span class="ss">)</span>.<span class="w">                                      </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="2-cryptographic-hash-properties">2. Cryptographic Hash Properties<a class="header-link" href="#2-cryptographic-hash-properties" title="Permanent link">&para;</a></h2>
<p>A secure cryptographic hash function must satisfy three properties:</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">             </span><span class="nv">Three</span><span class="w"> </span><span class="nv">Properties</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">Cryptographic</span><span class="w"> </span><span class="nv">Hashes</span><span class="w">                  </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">1</span>.<span class="w"> </span><span class="nv">PRE</span><span class="o">-</span><span class="nv">IMAGE</span><span class="w"> </span><span class="nv">RESISTANCE</span><span class="w"> </span><span class="ss">(</span><span class="nv">one</span><span class="o">-</span><span class="nv">way</span><span class="ss">)</span><span class="w">                                  </span>â”‚
â”‚<span class="w">     </span><span class="nv">Given</span><span class="w"> </span><span class="nv">hash</span><span class="w"> </span><span class="nv">h</span>,<span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">infeasible</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">find</span><span class="w"> </span><span class="nv">any</span><span class="w"> </span><span class="nv">m</span><span class="w"> </span><span class="nv">such</span><span class="w"> </span><span class="nv">that</span><span class="w">          </span>â”‚
â”‚<span class="w">     </span><span class="nv">H</span><span class="ss">(</span><span class="nv">m</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">h</span>.<span class="w">                                                       </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">     </span><span class="nv">Hash</span><span class="w"> </span>â”€â”€â•³â”€â”€â–¶<span class="w"> </span><span class="nv">Original</span><span class="w"> </span><span class="nv">input</span><span class="w">                                     </span>â”‚
â”‚<span class="w">     </span><span class="ss">(</span><span class="nv">You</span><span class="w"> </span><span class="nv">cannot</span><span class="w"> </span><span class="nv">reverse</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">hash</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">get</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">input</span><span class="ss">)</span><span class="w">                    </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">2</span>.<span class="w"> </span><span class="nv">SECOND</span><span class="w"> </span><span class="nv">PRE</span><span class="o">-</span><span class="nv">IMAGE</span><span class="w"> </span><span class="nv">RESISTANCE</span><span class="w"> </span><span class="ss">(</span><span class="nv">weak</span><span class="w"> </span><span class="nv">collision</span><span class="w"> </span><span class="nv">resistance</span><span class="ss">)</span><span class="w">         </span>â”‚
â”‚<span class="w">     </span><span class="nv">Given</span><span class="w"> </span><span class="nv">m</span>â‚,<span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">infeasible</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">find</span><span class="w"> </span><span class="nv">m</span>â‚‚<span class="w"> </span>â‰ <span class="w"> </span><span class="nv">m</span>â‚<span class="w"> </span><span class="nv">such</span><span class="w"> </span><span class="nv">that</span><span class="w">          </span>â”‚
â”‚<span class="w">     </span><span class="nv">H</span><span class="ss">(</span><span class="nv">m</span>â‚<span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">H</span><span class="ss">(</span><span class="nv">m</span>â‚‚<span class="ss">)</span>.<span class="w">                                                 </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">     </span><span class="s2">&quot;Hello&quot;</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">abc123</span><span class="w">    </span><span class="nv">Cannot</span><span class="w"> </span><span class="nv">find</span><span class="w"> </span><span class="nv">another</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">abc123</span><span class="w">          </span>â”‚
â”‚<span class="w">     </span><span class="ss">(</span><span class="nv">Cannot</span><span class="w"> </span><span class="nv">find</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">second</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">same</span><span class="w"> </span><span class="nv">hash</span><span class="ss">)</span><span class="w">                 </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">3</span>.<span class="w"> </span><span class="nv">COLLISION</span><span class="w"> </span><span class="nv">RESISTANCE</span><span class="w"> </span><span class="ss">(</span><span class="nv">strong</span><span class="w"> </span><span class="nv">collision</span><span class="w"> </span><span class="nv">resistance</span><span class="ss">)</span><span class="w">               </span>â”‚
â”‚<span class="w">     </span><span class="nv">It</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">infeasible</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">find</span><span class="w"> </span><span class="nv">ANY</span><span class="w"> </span><span class="nv">two</span><span class="w"> </span><span class="nv">distinct</span><span class="w"> </span><span class="nv">messages</span><span class="w"> </span><span class="nv">m</span>â‚<span class="w"> </span>â‰ <span class="w"> </span><span class="nv">m</span>â‚‚<span class="w">     </span>â”‚
â”‚<span class="w">     </span><span class="nv">such</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">H</span><span class="ss">(</span><span class="nv">m</span>â‚<span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">H</span><span class="ss">(</span><span class="nv">m</span>â‚‚<span class="ss">)</span>.<span class="w">                                       </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">     </span><span class="nv">Cannot</span><span class="w"> </span><span class="nv">find</span><span class="w"> </span><span class="nv">ANY</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">inputs</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">same</span><span class="w"> </span><span class="nv">hash</span><span class="w">               </span>â”‚
â”‚<span class="w">     </span><span class="ss">(</span><span class="nv">This</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">strictly</span><span class="w"> </span><span class="nv">stronger</span><span class="w"> </span><span class="nv">than</span><span class="w"> </span><span class="nv">second</span><span class="w"> </span><span class="nv">pre</span><span class="o">-</span><span class="nv">image</span><span class="w"> </span><span class="nv">resistance</span><span class="ss">)</span><span class="w">    </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Security</span><span class="w"> </span><span class="nv">levels</span><span class="w"> </span><span class="ss">(</span><span class="k">for</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">n</span><span class="o">-</span><span class="nv">bit</span><span class="w"> </span><span class="nv">hash</span><span class="ss">)</span>:<span class="w">                               </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Pre</span><span class="o">-</span><span class="nv">image</span>:<span class="w">    </span><span class="nv">O</span><span class="ss">(</span><span class="mi">2</span><span class="o">^</span><span class="nv">n</span><span class="ss">)</span><span class="w"> </span><span class="nv">work</span><span class="w"> </span><span class="ss">(</span><span class="nv">birthday</span><span class="w"> </span><span class="nv">paradox</span><span class="w"> </span><span class="nv">does</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">apply</span><span class="ss">)</span><span class="w">     </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="mi">2</span><span class="nv">nd</span><span class="w"> </span><span class="nv">pre</span><span class="o">-</span><span class="nv">image</span>:<span class="w"> </span><span class="nv">O</span><span class="ss">(</span><span class="mi">2</span><span class="o">^</span><span class="nv">n</span><span class="ss">)</span><span class="w"> </span><span class="nv">work</span><span class="w">                                      </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Collision</span>:<span class="w">     </span><span class="nv">O</span><span class="ss">(</span><span class="mi">2</span><span class="o">^</span><span class="ss">(</span><span class="nv">n</span><span class="o">/</span><span class="mi">2</span><span class="ss">))</span><span class="w"> </span><span class="nv">work</span><span class="w"> </span><span class="ss">(</span><span class="nv">birthday</span><span class="w"> </span><span class="nv">paradox</span><span class="ss">)</span><span class="w">               </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">This</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">why</span><span class="w"> </span><span class="nv">SHA</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="nv">provides</span><span class="w"> </span><span class="mi">128</span><span class="o">-</span><span class="nv">bit</span><span class="w"> </span><span class="nv">collision</span><span class="w"> </span><span class="nv">resistance</span><span class="w">          </span>â”‚
â”‚<span class="w">  </span><span class="ss">(</span><span class="mi">2</span><span class="o">^</span><span class="mi">128</span><span class="w"> </span>â‰ˆ<span class="w"> </span><span class="mi">3</span>.<span class="mi">4</span><span class="w"> </span>Ã—<span class="w"> </span><span class="mi">10</span><span class="o">^</span><span class="mi">38</span><span class="w"> </span><span class="nv">operations</span><span class="ss">)</span>.<span class="w">                                 </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="21-the-avalanche-effect">2.1 The Avalanche Effect<a class="header-link" href="#21-the-avalanche-effect" title="Permanent link">&para;</a></h3>
<p>A good hash function exhibits the <strong>avalanche effect</strong>: a tiny change in input produces a drastically different output.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>

<span class="c1"># Demonstrate the avalanche effect</span>
<span class="n">msg1</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Hello, World!&quot;</span>
<span class="n">msg2</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Hello, World?&quot;</span>  <span class="c1"># Changed &#39;!&#39; to &#39;?&#39;</span>
<span class="n">msg3</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Hello, World! &quot;</span> <span class="c1"># Added a space</span>

<span class="n">hash1</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">msg1</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="n">hash2</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">msg2</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="n">hash3</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">msg3</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Avalanche Effect Demonstration (SHA-256):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  &#39;</span><span class="si">{</span><span class="n">msg1</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; â†’ </span><span class="si">{</span><span class="n">hash1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  &#39;</span><span class="si">{</span><span class="n">msg2</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; â†’ </span><span class="si">{</span><span class="n">hash2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  &#39;</span><span class="si">{</span><span class="n">msg3</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;â†’ </span><span class="si">{</span><span class="n">hash3</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Count differing bits</span>
<span class="k">def</span><span class="w"> </span><span class="nf">bit_difference</span><span class="p">(</span><span class="n">hex1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hex2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Count the number of differing bits between two hex strings.&quot;&quot;&quot;</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hex1</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hex2</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">xor</span> <span class="o">=</span> <span class="n">b1</span> <span class="o">^</span> <span class="n">b2</span>
    <span class="n">diff_bits</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">xor</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">total_bits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hex1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
    <span class="k">return</span> <span class="n">diff_bits</span><span class="p">,</span> <span class="n">total_bits</span>

<span class="n">diff</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="n">bit_difference</span><span class="p">(</span><span class="n">hash1</span><span class="p">,</span> <span class="n">hash2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Bits changed (1 char diff): </span><span class="si">{</span><span class="n">diff</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">diff</span><span class="o">/</span><span class="n">total</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="n">diff2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">bit_difference</span><span class="p">(</span><span class="n">hash1</span><span class="p">,</span> <span class="n">hash3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Bits changed (space added): </span><span class="si">{</span><span class="n">diff2</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">diff2</span><span class="o">/</span><span class="n">total</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Ideal: ~50% of bits differ for any change</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Expected for random: ~</span><span class="si">{</span><span class="n">total</span><span class="o">//</span><span class="mi">2</span><span class="si">}</span><span class="s2"> bits (</span><span class="si">{</span><span class="mf">50.0</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="3-hash-function-survey">3. Hash Function Survey<a class="header-link" href="#3-hash-function-survey" title="Permanent link">&para;</a></h2>
<h3 id="31-hash-function-comparison">3.1 Hash Function Comparison<a class="header-link" href="#31-hash-function-comparison" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                </span><span class="n">Hash</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="n">Comparison</span><span class="w"> </span><span class="n">Table</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Algorithm</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Output</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Speed</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Status</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Notes</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">GB</span><span class="o">/</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="w">   </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">MD5</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">128</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="o">~</span><span class="mf">5.0</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="n">BROKEN</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Collisions</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="mi">2004</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">1</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">160</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="o">~</span><span class="mf">3.0</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="n">BROKEN</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">SHAttered</span><span class="w"> </span><span class="n">attack</span><span class="w"> </span><span class="mi">2017</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">256</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="o">~</span><span class="mf">1.5</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="n">SECURE</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Most</span><span class="w"> </span><span class="n">widely</span><span class="w"> </span><span class="n">used</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">512</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">512</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="o">~</span><span class="mf">2.0</span><span class="err">â€ </span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">SECURE</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Faster</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="mi">64</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">CPUs</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="mi">256</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">256</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="o">~</span><span class="mf">0.5</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="n">SECURE</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Different</span><span class="w"> </span><span class="n">construction</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">BLAKE2b</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">256</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="o">~</span><span class="mf">3.5</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="n">SECURE</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">BLAKE2s</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">256</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="o">~</span><span class="mf">2.0</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="n">SECURE</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Optimized</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">BLAKE3</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">256</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="o">~</span><span class="mf">10.0</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">SECURE</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Parallelizable</span><span class="p">,</span><span class="w"> </span><span class="n">newest</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Approximate</span><span class="w"> </span><span class="n">throughput</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">modern</span><span class="w"> </span><span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">hardware</span><span class="w"> </span><span class="n">support</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="err">â€ </span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">512</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="mi">64</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">processors</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Recommendation</span><span class="p">:</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">interoperability</span><span class="p">,</span><span class="w"> </span><span class="n">BLAKE2b</span><span class="o">/</span><span class="n">BLAKE3</span><span class="w"> </span><span class="k">for</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">performance</span><span class="o">-</span><span class="n">sensitive</span><span class="w"> </span><span class="n">applications</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="32-sha-2-family">3.2 SHA-2 Family<a class="header-link" href="#32-sha-2-family" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SHA-2 Family                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Variant      â”‚ Output   â”‚ Block    â”‚ Word     â”‚ Rounds              â”‚
â”‚              â”‚ (bits)   â”‚ (bits)   â”‚ (bits)   â”‚                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SHA-224      â”‚ 224      â”‚ 512      â”‚ 32       â”‚ 64                  â”‚
â”‚ SHA-256      â”‚ 256      â”‚ 512      â”‚ 32       â”‚ 64                  â”‚
â”‚ SHA-384      â”‚ 384      â”‚ 1024     â”‚ 64       â”‚ 80                  â”‚
â”‚ SHA-512      â”‚ 512      â”‚ 1024     â”‚ 64       â”‚ 80                  â”‚
â”‚ SHA-512/256  â”‚ 256      â”‚ 1024     â”‚ 64       â”‚ 80                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SHA-256 and SHA-512 are the most commonly used.                     â”‚
â”‚ SHA-512/256 gives SHA-256 output size with SHA-512&#39;s speed on       â”‚
â”‚ 64-bit processors and is not vulnerable to length-extension.        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="33-sha-3-keccak">3.3 SHA-3 (Keccak)<a class="header-link" href="#33-sha-3-keccak" title="Permanent link">&para;</a></h3>
<p>SHA-3 uses the <strong>sponge construction</strong>, which is fundamentally different from SHA-2's Merkle-Damgard construction. This diversity is valuable: if SHA-2 is ever broken, SHA-3 will likely remain secure.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">SHA</span><span class="o">-</span><span class="mi">3</span><span class="w"> </span><span class="n">Sponge</span><span class="w"> </span><span class="n">Construction</span><span class="w"> </span><span class="p">(</span><span class="n">Simplified</span><span class="p">)</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="k">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">0...0</span><span class="o">]</span><span class="w">  </span><span class="p">(</span><span class="mi">1600</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Keccak</span><span class="p">)</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">ABSORBING</span><span class="w"> </span><span class="nl">PHASE</span><span class="p">:</span><span class="w">                                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">   </span><span class="n">XOR</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">   </span><span class="n">XOR</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">msgâ‚</span><span class="w">  </span><span class="err">â”‚â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â–¶â”‚</span><span class="w"> </span><span class="n">msgâ‚‚</span><span class="w">  </span><span class="err">â”‚â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="p">...</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">   </span><span class="k">State</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">   </span><span class="k">State</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">SQUEEZING</span><span class="w"> </span><span class="nl">PHASE</span><span class="p">:</span><span class="w">                                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">...</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="o">[</span><span class="n">outputâ‚</span><span class="o">]</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="o">[</span><span class="n">outputâ‚‚</span><span class="o">]</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="p">...</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Keccak</span><span class="w"> </span><span class="n">permutation</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="n">sub</span><span class="o">-</span><span class="n">rounds</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="n">rounds</span><span class="p">)</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="k">Key</span><span class="w"> </span><span class="nl">advantage</span><span class="p">:</span><span class="w"> </span><span class="ow">NOT</span><span class="w"> </span><span class="n">vulnerable</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">length</span><span class="o">-</span><span class="n">extension</span><span class="w"> </span><span class="n">attacks</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="n">unlike</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">512</span><span class="p">)</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="34-blake2-and-blake3">3.4 BLAKE2 and BLAKE3<a class="header-link" href="#34-blake2-and-blake3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                   </span><span class="nv">BLAKE2</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">BLAKE3</span><span class="w">                                  </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">BLAKE2</span><span class="w"> </span><span class="ss">(</span><span class="nv">RFC</span><span class="w"> </span><span class="mi">7693</span><span class="ss">)</span>:<span class="w">                                                 </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">BLAKE2b</span>:<span class="w"> </span><span class="nv">Optimized</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mi">64</span><span class="o">-</span><span class="nv">bit</span><span class="w"> </span><span class="nv">platforms</span><span class="w"> </span><span class="ss">(</span><span class="nv">up</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="nv">bytes</span><span class="ss">)</span><span class="w">      </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">BLAKE2s</span>:<span class="w"> </span><span class="nv">Optimized</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="nv">bit</span><span class="w"> </span><span class="nv">platforms</span><span class="w"> </span><span class="ss">(</span><span class="nv">up</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="nv">bytes</span><span class="ss">)</span><span class="w">      </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Built</span><span class="o">-</span><span class="nv">in</span><span class="w"> </span><span class="nv">keying</span><span class="w"> </span><span class="ss">(</span><span class="nv">can</span><span class="w"> </span><span class="nv">act</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">MAC</span><span class="w"> </span><span class="nv">without</span><span class="w"> </span><span class="nv">HMAC</span><span class="ss">)</span><span class="w">               </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Built</span><span class="o">-</span><span class="nv">in</span><span class="w"> </span><span class="nv">personalization</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">salt</span><span class="w"> </span><span class="nv">support</span><span class="w">                      </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Tree</span><span class="w"> </span><span class="nv">hashing</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">parallelism</span><span class="w">                             </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€<span class="w"> </span><span class="nv">Used</span><span class="w"> </span><span class="nv">in</span>:<span class="w"> </span><span class="nv">Argon2</span><span class="w"> </span><span class="nv">password</span><span class="w"> </span><span class="nv">hash</span>,<span class="w"> </span><span class="nv">WireGuard</span>,<span class="w"> </span><span class="nv">libsodium</span><span class="w">           </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">BLAKE3</span><span class="w"> </span><span class="ss">(</span><span class="mi">2020</span><span class="ss">)</span>:<span class="w">                                                     </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Based</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">BLAKE2</span><span class="w"> </span><span class="nv">but</span><span class="w"> </span><span class="nv">redesigned</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">speed</span><span class="w">                      </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Merkle</span><span class="w"> </span><span class="nv">tree</span><span class="w"> </span><span class="nv">structure</span><span class="w"> </span><span class="ss">(</span><span class="nv">inherently</span><span class="w"> </span><span class="nv">parallelizable</span><span class="ss">)</span><span class="w">             </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Single</span><span class="w"> </span><span class="nv">algorithm</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">hash</span>,<span class="w"> </span><span class="nv">MAC</span>,<span class="w"> </span><span class="nv">KDF</span>,<span class="w"> </span><span class="nv">XOF</span><span class="w">                     </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="mi">256</span><span class="o">-</span><span class="nv">bit</span><span class="w"> </span><span class="nv">output</span><span class="w"> </span><span class="ss">(</span><span class="nv">extendable</span><span class="ss">)</span><span class="w">                                   </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="o">~</span><span class="mi">10</span><span class="nv">x</span><span class="w"> </span><span class="nv">faster</span><span class="w"> </span><span class="nv">than</span><span class="w"> </span><span class="nv">SHA</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">modern</span><span class="w"> </span><span class="nv">CPUs</span><span class="w">                       </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€<span class="w"> </span><span class="nv">Used</span><span class="w"> </span><span class="nv">in</span>:<span class="w"> </span><span class="nv">Bao</span><span class="w"> </span><span class="ss">(</span><span class="nv">verified</span><span class="w"> </span><span class="nv">streaming</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">many</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">projects</span><span class="w">          </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="4-python-hashing-with-hashlib">4. Python Hashing with hashlib<a class="header-link" href="#4-python-hashing-with-hashlib" title="Permanent link">&para;</a></h2>
<h3 id="41-basic-hashing">4.1 Basic Hashing<a class="header-link" href="#41-basic-hashing" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>

<span class="n">message</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;The quick brown fox jumps over the lazy dog&quot;</span>

<span class="c1"># SHA-256 (most common)</span>
<span class="n">sha256</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHA-256:   </span><span class="si">{</span><span class="n">sha256</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># SHA-512</span>
<span class="n">sha512</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha512</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHA-512:   </span><span class="si">{</span><span class="n">sha512</span><span class="p">[:</span><span class="mi">64</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span><span class="si">{</span><span class="n">sha512</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># SHA-3-256</span>
<span class="n">sha3_256</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha3_256</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHA-3-256: </span><span class="si">{</span><span class="n">sha3_256</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># BLAKE2b (variable output size, up to 64 bytes)</span>
<span class="n">blake2b</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">blake2b</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">digest_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BLAKE2b:   </span><span class="si">{</span><span class="n">blake2b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># BLAKE2s (variable output size, up to 32 bytes)</span>
<span class="n">blake2s</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">blake2s</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">digest_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BLAKE2s:   </span><span class="si">{</span><span class="n">blake2s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># List all available algorithms</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Available: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">algorithms_available</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="42-incremental-hashing-streaming">4.2 Incremental Hashing (Streaming)<a class="header-link" href="#42-incremental-hashing-streaming" title="Permanent link">&para;</a></h3>
<p>For large files, you should hash data incrementally rather than loading everything into memory:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">def</span><span class="w"> </span><span class="nf">hash_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sha256&quot;</span><span class="p">,</span>
              <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hash a file incrementally without loading it all into memory.&quot;&quot;&quot;</span>
    <span class="n">hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="c1"># Create a test file</span>
<span class="n">test_file</span> <span class="o">=</span> <span class="s2">&quot;/tmp/test_hash_file.bin&quot;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">test_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Line </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: some data for hashing</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

<span class="c1"># Hash it</span>
<span class="n">sha256_hash</span> <span class="o">=</span> <span class="n">hash_file</span><span class="p">(</span><span class="n">test_file</span><span class="p">,</span> <span class="s2">&quot;sha256&quot;</span><span class="p">)</span>
<span class="n">sha3_hash</span> <span class="o">=</span> <span class="n">hash_file</span><span class="p">(</span><span class="n">test_file</span><span class="p">,</span> <span class="s2">&quot;sha3_256&quot;</span><span class="p">)</span>
<span class="n">blake2_hash</span> <span class="o">=</span> <span class="n">hash_file</span><span class="p">(</span><span class="n">test_file</span><span class="p">,</span> <span class="s2">&quot;blake2b&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File size: </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">test_file</span><span class="p">)</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHA-256:   </span><span class="si">{</span><span class="n">sha256_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHA-3-256: </span><span class="si">{</span><span class="n">sha3_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BLAKE2b:   </span><span class="si">{</span><span class="n">blake2_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Equivalent to reading all at once (but memory-efficient)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">test_file</span><span class="p">)</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span> <span class="n">sha256_hash</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Incremental hash matches full-read hash: OK&quot;</span><span class="p">)</span>

<span class="c1"># Clean up</span>
<span class="n">Path</span><span class="p">(</span><span class="n">test_file</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</code></pre></div>

<h3 id="43-blake2-with-key-keyed-hashing">4.3 BLAKE2 with Key (Keyed Hashing)<a class="header-link" href="#43-blake2-with-key-keyed-hashing" title="Permanent link">&para;</a></h3>
<p>BLAKE2 has built-in support for keyed hashing, making it usable as a MAC without the HMAC construction:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="c1"># BLAKE2b with key (acts as a MAC)</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>  <span class="c1"># 256-bit key</span>
<span class="n">message</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Authenticate this message&quot;</span>

<span class="c1"># Keyed hash</span>
<span class="n">mac</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">blake2b</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">digest_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BLAKE2b keyed hash: </span><span class="si">{</span><span class="n">mac</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Verify</span>
<span class="n">verification</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">blake2b</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">digest_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verification match: </span><span class="si">{</span><span class="n">mac</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">verification</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># With personalization (domain separation)</span>
<span class="n">mac1</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">blake2b</span><span class="p">(</span>
    <span class="sa">b</span><span class="s2">&quot;shared data&quot;</span><span class="p">,</span>
    <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
    <span class="n">person</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;payment-v1&quot;</span><span class="p">,</span>  <span class="c1"># Max 16 bytes</span>
    <span class="n">digest_size</span><span class="o">=</span><span class="mi">32</span>
<span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="n">mac2</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">blake2b</span><span class="p">(</span>
    <span class="sa">b</span><span class="s2">&quot;shared data&quot;</span><span class="p">,</span>
    <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
    <span class="n">person</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;session-v1&quot;</span><span class="p">,</span>  <span class="c1"># Different domain</span>
    <span class="n">digest_size</span><span class="o">=</span><span class="mi">32</span>
<span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Same data, different personalization:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  payment context: </span><span class="si">{</span><span class="n">mac1</span><span class="p">[:</span><span class="mi">32</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  session context: </span><span class="si">{</span><span class="n">mac2</span><span class="p">[:</span><span class="mi">32</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Same? </span><span class="si">{</span><span class="n">mac1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">mac2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># False - different domains</span>
</code></pre></div>

<h3 id="44-blake3">4.4 BLAKE3<a class="header-link" href="#44-blake3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># pip install blake3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">blake3</span>

<span class="n">message</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;BLAKE3 is extremely fast&quot;</span>

<span class="c1"># Basic hash</span>
<span class="n">digest</span> <span class="o">=</span> <span class="n">blake3</span><span class="o">.</span><span class="n">blake3</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BLAKE3: </span><span class="si">{</span><span class="n">digest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Keyed hash (for MAC)</span>
<span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="mi">32</span>  <span class="c1"># 32-byte key required</span>
<span class="n">keyed</span> <span class="o">=</span> <span class="n">blake3</span><span class="o">.</span><span class="n">blake3</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BLAKE3 keyed: </span><span class="si">{</span><span class="n">keyed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Key derivation</span>
<span class="n">derived</span> <span class="o">=</span> <span class="n">blake3</span><span class="o">.</span><span class="n">blake3</span><span class="p">(</span>
    <span class="sa">b</span><span class="s2">&quot;input key material&quot;</span><span class="p">,</span>
    <span class="n">derive_key_context</span><span class="o">=</span><span class="s2">&quot;my-app 2026-01-15 encryption key&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BLAKE3 KDF: </span><span class="si">{</span><span class="n">derived</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Incremental hashing</span>
<span class="n">hasher</span> <span class="o">=</span> <span class="n">blake3</span><span class="o">.</span><span class="n">blake3</span><span class="p">()</span>
<span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Hello, &quot;</span><span class="p">)</span>
<span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;World!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BLAKE3 incremental: </span><span class="si">{</span><span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Extendable output (XOF) - get any number of bytes</span>
<span class="n">digest_64</span> <span class="o">=</span> <span class="n">blake3</span><span class="o">.</span><span class="n">blake3</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BLAKE3 64-byte: </span><span class="si">{</span><span class="n">digest_64</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="5-password-hashing">5. Password Hashing<a class="header-link" href="#5-password-hashing" title="Permanent link">&para;</a></h2>
<p>Password hashing is fundamentally different from general-purpose hashing. Passwords have low entropy (humans choose predictable passwords), so an attacker who obtains password hashes can try to brute-force them. Password hashing algorithms are designed to be <strong>deliberately slow</strong> to make brute-force attacks impractical.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">        </span><span class="n">Why</span><span class="w"> </span><span class="k">General</span><span class="o">-</span><span class="n">Purpose</span><span class="w"> </span><span class="n">Hashes</span><span class="w"> </span><span class="k">Are</span><span class="w"> </span><span class="n">BAD</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Passwords</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="n">speed</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">modern</span><span class="w"> </span><span class="nl">GPU</span><span class="p">:</span><span class="w"> </span><span class="o">~</span><span class="mi">10</span><span class="w"> </span><span class="n">billion</span><span class="w"> </span><span class="n">hashes</span><span class="o">/</span><span class="k">second</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Password</span><span class="w"> </span><span class="ss">&quot;P@ssw0rd&quot;</span><span class="err">:</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">d74ff0ee8da3b9806b18c877d</span><span class="p">...</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="nc">Time</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">brute</span><span class="o">-</span><span class="n">force</span><span class="w"> </span><span class="mi">8</span><span class="o">-</span><span class="nc">char</span><span class="w"> </span><span class="nl">password</span><span class="p">:</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">minutes</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">bcrypt</span><span class="w"> </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="err">:</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="n">bcrypt</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span><span class="n">b</span><span class="err">$</span><span class="mi">12</span><span class="err">$</span><span class="n">LJ3m4ys3Tdb2vNQhk9Oy</span><span class="p">...</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="nc">Time</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">brute</span><span class="o">-</span><span class="nl">force</span><span class="p">:</span><span class="w"> </span><span class="n">years</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">centuries</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="nl">DIFFERENCES</span><span class="p">:</span><span class="w">                                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Password</span><span class="w"> </span><span class="n">hashes</span><span class="w"> </span><span class="k">include</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">SALT</span><span class="w"> </span><span class="p">(</span><span class="n">prevents</span><span class="w"> </span><span class="n">rainbow</span><span class="w"> </span><span class="n">tables</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Password</span><span class="w"> </span><span class="n">hashes</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">tunable</span><span class="w"> </span><span class="k">WORK</span><span class="w"> </span><span class="n">FACTOR</span><span class="w"> </span><span class="p">(</span><span class="n">adapts</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">hardware</span><span class="p">)</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Password</span><span class="w"> </span><span class="n">hashes</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">require</span><span class="w"> </span><span class="k">large</span><span class="w"> </span><span class="n">MEMORY</span><span class="w"> </span><span class="p">(</span><span class="n">defeats</span><span class="w"> </span><span class="n">GPU</span><span class="w"> </span><span class="n">attacks</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">NEVER</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="n">passwords</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="n">MD5</span><span class="p">,</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="k">general</span><span class="w"> </span><span class="n">hash</span><span class="err">!</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="51-bcrypt">5.1 bcrypt<a class="header-link" href="#51-bcrypt" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># pip install bcrypt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">bcrypt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="n">password</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;correct-horse-battery-staple&quot;</span>

<span class="c1"># Hash a password</span>
<span class="c1"># bcrypt automatically generates a random 16-byte salt</span>
<span class="c1"># cost=12 means 2^12 = 4096 iterations</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">hashed</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">gensalt</span><span class="p">(</span><span class="n">rounds</span><span class="o">=</span><span class="mi">12</span><span class="p">))</span>
<span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Password:  </span><span class="si">{</span><span class="n">password</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash:      </span><span class="si">{</span><span class="n">hashed</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time:      </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Anatomy of a bcrypt hash:</span>
<span class="c1"># $2b$12$LJ3m4ys3Tdb2vNQhk9OyAeKK3b3eAGQjT5xKp2JFe5cF5NY5U/a2e</span>
<span class="c1"># â”œâ”€â”€â”¤â”œâ”€â”¤â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="c1"># Algo Cost       Salt (22 chars)         Hash (31 chars)</span>
<span class="c1">#</span>
<span class="c1"># $2b = bcrypt version</span>
<span class="c1"># $12 = cost factor (2^12 iterations)</span>

<span class="c1"># Verify a password</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">is_valid</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">hashed</span><span class="p">)</span>
<span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid password: </span><span class="si">{</span><span class="n">is_valid</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>

<span class="c1"># Wrong password</span>
<span class="n">is_valid</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;wrong-password&quot;</span><span class="p">,</span> <span class="n">hashed</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong password: </span><span class="si">{</span><span class="n">is_valid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Each hash is unique even for the same password (different salt)</span>
<span class="n">hash2</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">gensalt</span><span class="p">(</span><span class="n">rounds</span><span class="o">=</span><span class="mi">12</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Hash 1: </span><span class="si">{</span><span class="n">hashed</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash 2: </span><span class="si">{</span><span class="n">hash2</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Same?   </span><span class="si">{</span><span class="n">hashed</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">hash2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># False (different salts)</span>
<span class="c1"># But both verify the same password</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Both verify &#39;correct-horse-battery-staple&#39;: &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="n">password</span><span class="p">,</span><span class="w"> </span><span class="n">hashed</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="n">password</span><span class="p">,</span><span class="w"> </span><span class="n">hash2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="52-scrypt">5.2 scrypt<a class="header-link" href="#52-scrypt" title="Permanent link">&para;</a></h3>
<p>scrypt is <strong>memory-hard</strong>: it requires a large amount of memory proportional to the cost parameter, making it resistant to GPU and ASIC attacks.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="n">password</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;my-secure-password&quot;</span>
<span class="n">salt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

<span class="c1"># scrypt parameters:</span>
<span class="c1"># n = CPU/memory cost (must be power of 2). Higher = slower + more memory.</span>
<span class="c1"># r = block size (8 is standard)</span>
<span class="c1"># p = parallelism (1 is standard)</span>
<span class="c1"># Memory usage â‰ˆ 128 * n * r bytes</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">derived</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">scrypt</span><span class="p">(</span>
    <span class="n">password</span><span class="p">,</span>
    <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span>
    <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">14</span><span class="p">,</span>    <span class="c1"># 16384 iterations</span>
    <span class="n">r</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>        <span class="c1"># Block size</span>
    <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>        <span class="c1"># Parallelism</span>
    <span class="n">dklen</span><span class="o">=</span><span class="mi">32</span>    <span class="c1"># Output 256 bits</span>
<span class="p">)</span>
<span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scrypt derived key: </span><span class="si">{</span><span class="n">derived</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Salt:              </span><span class="si">{</span><span class="n">salt</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time:              </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memory used:       ~</span><span class="si">{</span><span class="mi">128</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="o">**</span><span class="mi">14</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>

<span class="c1"># Verify</span>
<span class="n">derived2</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">scrypt</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">14</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dklen</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verification:      </span><span class="si">{</span><span class="n">derived</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">derived2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="53-argon2-recommended">5.3 Argon2 (Recommended)<a class="header-link" href="#53-argon2-recommended" title="Permanent link">&para;</a></h3>
<p>Argon2 won the 2015 Password Hashing Competition and is the currently recommended algorithm. It comes in three variants:</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span>                      <span class="n">Argon2</span> <span class="n">Variants</span>                                <span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span> <span class="n">Variant</span>      <span class="err">â”‚</span> <span class="n">Description</span>                                         <span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span> <span class="n">Argon2d</span>      <span class="err">â”‚</span> <span class="n">Data</span><span class="o">-</span><span class="n">dependent</span> <span class="n">memory</span> <span class="n">access</span><span class="p">.</span> <span class="n">Faster</span><span class="p">,</span> <span class="n">more</span> <span class="n">GPU</span><span class="o">-</span>     <span class="err">â”‚</span>
<span class="err">â”‚</span>              <span class="err">â”‚</span> <span class="n">resistant</span><span class="p">,</span> <span class="n">but</span> <span class="n">vulnerable</span> <span class="n">to</span> <span class="n">side</span><span class="o">-</span><span class="n">channel</span> <span class="n">attacks</span><span class="p">.</span>   <span class="err">â”‚</span>
<span class="err">â”‚</span>              <span class="err">â”‚</span> <span class="n">Best</span> <span class="n">for</span> <span class="n">cryptocurrency</span> <span class="n">mining</span><span class="p">,</span> <span class="n">NOT</span> <span class="n">for</span> <span class="n">passwords</span><span class="p">.</span>   <span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span> <span class="n">Argon2i</span>      <span class="err">â”‚</span> <span class="n">Data</span><span class="o">-</span><span class="n">independent</span> <span class="n">memory</span> <span class="n">access</span><span class="p">.</span> <span class="n">Resistant</span> <span class="n">to</span> <span class="n">side</span><span class="o">-</span>  <span class="err">â”‚</span>
<span class="err">â”‚</span>              <span class="err">â”‚</span> <span class="n">channel</span> <span class="n">attacks</span><span class="p">.</span> <span class="n">Better</span> <span class="n">for</span> <span class="n">password</span> <span class="n">hashing</span> <span class="n">in</span>      <span class="err">â”‚</span>
<span class="err">â”‚</span>              <span class="err">â”‚</span> <span class="n">shared</span> <span class="n">environments</span><span class="p">.</span>                                <span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span> <span class="n">Argon2id</span>     <span class="err">â”‚</span> <span class="n">Hybrid</span><span class="p">:</span> <span class="n">first</span> <span class="n">pass</span> <span class="n">is</span> <span class="n">Argon2i</span><span class="p">,</span> <span class="n">subsequent</span> <span class="n">passes</span>   <span class="err">â”‚</span>
<span class="err">â”‚</span>              <span class="err">â”‚</span> <span class="n">are</span> <span class="n">Argon2d</span><span class="p">.</span> <span class="n">RECOMMENDED</span> <span class="n">for</span> <span class="n">password</span> <span class="n">hashing</span><span class="p">.</span>      <span class="err">â”‚</span>
<span class="err">â”‚</span>              <span class="err">â”‚</span> <span class="n">Best</span> <span class="n">of</span> <span class="n">both</span> <span class="n">worlds</span><span class="p">.</span>                                <span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># pip install argon2-cffi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">argon2</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHasher</span><span class="p">,</span> <span class="n">Type</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># Create a hasher with recommended parameters</span>
<span class="c1"># Adjust time_cost and memory_cost based on your server&#39;s capabilities</span>
<span class="c1"># Target: ~0.5-1.0 seconds per hash</span>
<span class="n">ph</span> <span class="o">=</span> <span class="n">PasswordHasher</span><span class="p">(</span>
    <span class="n">time_cost</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>          <span class="c1"># Number of iterations</span>
    <span class="n">memory_cost</span><span class="o">=</span><span class="mi">65536</span><span class="p">,</span>    <span class="c1"># Memory in KB (64 MB)</span>
    <span class="n">parallelism</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>        <span class="c1"># Number of threads</span>
    <span class="n">hash_len</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>          <span class="c1"># Output hash length</span>
    <span class="n">salt_len</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>          <span class="c1"># Salt length</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span>         <span class="c1"># Argon2id (recommended)</span>
<span class="p">)</span>

<span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;correct-horse-battery-staple&quot;</span>

<span class="c1"># Hash</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">hashed</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Argon2id hash: </span><span class="si">{</span><span class="n">hashed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Anatomy of an Argon2 hash string:</span>
<span class="c1"># $argon2id$v=19$m=65536,t=3,p=4$c2FsdDEyMzQ1Njc4$aXaShZ7S2X3yBqBvP5WF4w</span>
<span class="c1"># â”œâ”€â”€â”€â”€â”€â”€â”€â”¤â”œâ”€â”€â”€â”¤â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="c1">#   Algo    Ver    Parameters         Salt (b64)           Hash (b64)</span>

<span class="c1"># Verify</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">is_valid</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">hashed</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid password: </span><span class="si">{</span><span class="n">is_valid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verification failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Wrong password</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ph</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">hashed</span><span class="p">,</span> <span class="s2">&quot;wrong-password&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong password: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Check if rehash is needed (parameters changed)</span>
<span class="k">if</span> <span class="n">ph</span><span class="o">.</span><span class="n">check_needs_rehash</span><span class="p">(</span><span class="n">hashed</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hash needs rehash with updated parameters&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hash parameters are current&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="54-password-hashing-comparison">5.4 Password Hashing Comparison<a class="header-link" href="#54-password-hashing-comparison" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Password Hashing Algorithm Comparison                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Algorithm   â”‚ Memory  â”‚ GPU/ASIC      â”‚ Side-Ch. â”‚ Recommendation   â”‚
â”‚             â”‚ Hard?   â”‚ Resistant?    â”‚ Safe?    â”‚                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ bcrypt      â”‚ No      â”‚ Moderate      â”‚ Yes      â”‚ Good (mature)    â”‚
â”‚ scrypt      â”‚ Yes     â”‚ Good          â”‚ Partial  â”‚ Good             â”‚
â”‚ Argon2id    â”‚ Yes     â”‚ Best          â”‚ Yes      â”‚ Best (preferred) â”‚
â”‚ PBKDF2      â”‚ No      â”‚ Poor          â”‚ Yes      â”‚ Legacy only      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚ Recommended parameters (2025+, targeting ~0.5s on server):          â”‚
â”‚ â€¢ Argon2id: m=64MB, t=3, p=4                                       â”‚
â”‚ â€¢ bcrypt:   cost=12 to 14                                           â”‚
â”‚ â€¢ scrypt:   N=2^15, r=8, p=1                                       â”‚
â”‚ â€¢ PBKDF2:   600,000+ iterations with SHA-256                        â”‚
â”‚                                                                      â”‚
â”‚ OWASP recommends: Argon2id first, bcrypt second.                    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="55-complete-password-storage-system">5.5 Complete Password Storage System<a class="header-link" href="#55-complete-password-storage-system" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">argon2</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHasher</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">exceptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserRecord</span><span class="p">:</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">password_hash</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">last_login</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">failed_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">locked_until</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PasswordStore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Production-quality password storage using Argon2id.&quot;&quot;&quot;</span>

    <span class="n">MAX_ATTEMPTS</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">LOCKOUT_SECONDS</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># 5 minutes</span>
    <span class="n">MIN_PASSWORD_LENGTH</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasher</span> <span class="o">=</span> <span class="n">PasswordHasher</span><span class="p">(</span>
            <span class="n">time_cost</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">memory_cost</span><span class="o">=</span><span class="mi">65536</span><span class="p">,</span>
            <span class="n">parallelism</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">hash_len</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
            <span class="n">salt_len</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">UserRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_password_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check password against basic strength requirements.&quot;&quot;&quot;</span>
        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_PASSWORD_LENGTH</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Password must be at least </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">MIN_PASSWORD_LENGTH</span><span class="si">}</span><span class="s2"> chars&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">password</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">password</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Password must contain uppercase letters&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">):</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Password must contain digits&quot;</span><span class="p">)</span>

        <span class="c1"># Check against common passwords (abbreviated list)</span>
        <span class="n">common</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">,</span> <span class="s2">&quot;qwerty&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;letmein&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">password</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">common</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Password is too common&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">issues</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a new user.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Username already exists&quot;</span><span class="p">}</span>

        <span class="n">issues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_password_strength</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">issues</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Weak password&quot;</span><span class="p">,</span> <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="n">issues</span><span class="p">}</span>

        <span class="n">hashed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasher</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">UserRecord</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
            <span class="n">password_hash</span><span class="o">=</span><span class="n">hashed</span><span class="p">,</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2"> registered&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Authenticate a user.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
            <span class="c1"># Perform a dummy hash to prevent timing-based user enumeration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hasher</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="s2">&quot;dummy-to-waste-time&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credentials&quot;</span><span class="p">}</span>

        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>

        <span class="c1"># Check lockout</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="ow">and</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span><span class="p">:</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Account locked. Try in </span><span class="si">{</span><span class="n">remaining</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hasher</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password_hash</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

            <span class="c1"># Check if rehash needed (parameters upgraded)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasher</span><span class="o">.</span><span class="n">check_needs_rehash</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password_hash</span><span class="p">):</span>
                <span class="n">user</span><span class="o">.</span><span class="n">password_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasher</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>

            <span class="n">user</span><span class="o">.</span><span class="n">failed_attempts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">user</span><span class="o">.</span><span class="n">last_login</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Welcome, </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">}</span>

        <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">VerifyMismatchError</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">failed_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">failed_attempts</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_ATTEMPTS</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOCKOUT_SECONDS</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credentials&quot;</span><span class="p">,</span>
                <span class="s2">&quot;attempts_remaining&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_ATTEMPTS</span> <span class="o">-</span> <span class="n">user</span><span class="o">.</span><span class="n">failed_attempts</span><span class="p">)</span>
            <span class="p">}</span>

<span class="c1"># Usage</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">PasswordStore</span><span class="p">()</span>

<span class="c1"># Register</span>
<span class="nb">print</span><span class="p">(</span><span class="n">store</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;short&quot;</span><span class="p">))</span>  <span class="c1"># Fails - too short</span>
<span class="nb">print</span><span class="p">(</span><span class="n">store</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;MySecureP@ss123&quot;</span><span class="p">))</span>  <span class="c1"># Succeeds</span>
<span class="nb">print</span><span class="p">(</span><span class="n">store</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;AnotherPassword1&quot;</span><span class="p">))</span>  <span class="c1"># Fails - exists</span>

<span class="c1"># Authenticate</span>
<span class="nb">print</span><span class="p">(</span><span class="n">store</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;MySecureP@ss123&quot;</span><span class="p">))</span>  <span class="c1"># Success</span>
<span class="nb">print</span><span class="p">(</span><span class="n">store</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;wrong-password&quot;</span><span class="p">))</span>    <span class="c1"># Failure</span>
<span class="nb">print</span><span class="p">(</span><span class="n">store</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="s2">&quot;anything&quot;</span><span class="p">))</span>            <span class="c1"># User not found</span>
</code></pre></div>

<hr />
<h2 id="6-hmac-message-authentication">6. HMAC: Message Authentication<a class="header-link" href="#6-hmac-message-authentication" title="Permanent link">&para;</a></h2>
<p>HMAC (Hash-based Message Authentication Code) provides both integrity and authenticity. It combines a secret key with a hash function to produce a tag that can only be created and verified by someone who knows the key.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        HMAC Construction                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  HMAC(K, m) = H((K&#39; âŠ• opad) || H((K&#39; âŠ• ipad) || m))               â”‚
â”‚                                                                      â”‚
â”‚  Where:                                                              â”‚
â”‚  K  = secret key                                                    â”‚
â”‚  K&#39; = key padded/hashed to block size                               â”‚
â”‚  opad = 0x5c repeated to block size                                 â”‚
â”‚  ipad = 0x36 repeated to block size                                 â”‚
â”‚  H  = hash function (SHA-256, etc.)                                 â”‚
â”‚  || = concatenation                                                 â”‚
â”‚  âŠ•  = XOR                                                           â”‚
â”‚                                                                      â”‚
â”‚  Step by step:                                                      â”‚
â”‚  1. If key &gt; block size: K&#39; = H(K)                                  â”‚
â”‚  2. Else: K&#39; = K padded with zeros                                  â”‚
â”‚  3. Inner hash: H((K&#39; âŠ• ipad) || message)                          â”‚
â”‚  4. Outer hash: H((K&#39; âŠ• opad) || inner_hash)                       â”‚
â”‚                                                                      â”‚
â”‚  Why not just H(key || message)?                                    â”‚
â”‚  â†’ Vulnerable to length-extension attacks with Merkle-Damgard       â”‚
â”‚    hashes (SHA-256). HMAC&#39;s nested structure prevents this.         â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="61-hmac-in-python">6.1 HMAC in Python<a class="header-link" href="#61-hmac-in-python" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hmac</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># Generate a secret key</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>  <span class="c1"># 256-bit key</span>

<span class="c1"># Create HMAC</span>
<span class="n">message</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Transfer $1000 to account 12345&quot;</span>
<span class="n">mac</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message: </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HMAC:    </span><span class="si">{</span><span class="n">mac</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Verify HMAC (constant-time comparison)</span>
<span class="n">received_mac</span> <span class="o">=</span> <span class="n">mac</span>
<span class="n">is_valid</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span>
    <span class="n">mac</span><span class="p">,</span>
    <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid:   </span><span class="si">{</span><span class="n">is_valid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Tampered message</span>
<span class="n">tampered</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Transfer $9999 to account 12345&quot;</span>
<span class="n">is_valid</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span>
    <span class="n">mac</span><span class="p">,</span>
    <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">tampered</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tampered valid: </span><span class="si">{</span><span class="n">is_valid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># False</span>
</code></pre></div>

<h3 id="62-practical-api-request-signing">6.2 Practical: API Request Signing<a class="header-link" href="#62-practical-api-request-signing" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hmac</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlencode</span>

<span class="k">class</span><span class="w"> </span><span class="nc">APIRequestSigner</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sign API requests using HMAC-SHA256.</span>
<span class="sd">    Similar to AWS Signature V4, Stripe webhook signatures, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_secret</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_secret</span> <span class="o">=</span> <span class="n">api_secret</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sign_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">body</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sign an API request and return headers.&quot;&quot;&quot;</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="ow">or</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">ts_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>

        <span class="c1"># Build canonical request string</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">body</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">canonical</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">ts_str</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">body_str</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Compute HMAC</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api_secret</span><span class="p">,</span>
            <span class="n">canonical</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
            <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span>
        <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;X-API-Key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
            <span class="s2">&quot;X-Timestamp&quot;</span><span class="p">:</span> <span class="n">ts_str</span><span class="p">,</span>
            <span class="s2">&quot;X-Signature&quot;</span><span class="p">:</span> <span class="n">signature</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">verify_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">max_age_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify a signed API request.&quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-API-Key&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Signature&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Check API key</span>
        <span class="k">if</span> <span class="n">api_key</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid API key&quot;</span><span class="p">}</span>

        <span class="c1"># Check timestamp (prevent replay attacks)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
            <span class="n">age</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="n">max_age_seconds</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Request too old (</span><span class="si">{</span><span class="n">age</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid timestamp&quot;</span><span class="p">}</span>

        <span class="c1"># Recompute and verify signature</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">body</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">canonical</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">body_str</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api_secret</span><span class="p">,</span>
            <span class="n">canonical</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
            <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span>
        <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid signature&quot;</span><span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">}</span>

<span class="c1"># Usage</span>
<span class="n">api_key</span> <span class="o">=</span> <span class="s2">&quot;ak_live_abc123&quot;</span>
<span class="n">api_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="n">signer</span> <span class="o">=</span> <span class="n">APIRequestSigner</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="n">api_secret</span><span class="p">)</span>

<span class="c1"># Sign a request</span>
<span class="n">headers</span> <span class="o">=</span> <span class="n">signer</span><span class="o">.</span><span class="n">sign_request</span><span class="p">(</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
    <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/v1/transfers&quot;</span><span class="p">,</span>
    <span class="n">body</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="s2">&quot;USD&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;acct_xyz&quot;</span><span class="p">}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Signed Request Headers:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Verify the request</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">signer</span><span class="o">.</span><span class="n">verify_request</span><span class="p">(</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
    <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/v1/transfers&quot;</span><span class="p">,</span>
    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
    <span class="n">body</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="s2">&quot;USD&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;acct_xyz&quot;</span><span class="p">}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Verification: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Tampered body</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">signer</span><span class="o">.</span><span class="n">verify_request</span><span class="p">(</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
    <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/v1/transfers&quot;</span><span class="p">,</span>
    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
    <span class="n">body</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mi">9999</span><span class="p">,</span> <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="s2">&quot;USD&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;acct_xyz&quot;</span><span class="p">}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tampered body: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="63-webhook-signature-verification">6.3 Webhook Signature Verification<a class="header-link" href="#63-webhook-signature-verification" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hmac</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>

<span class="k">def</span><span class="w"> </span><span class="nf">verify_webhook_signature</span><span class="p">(</span>
    <span class="n">payload</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
    <span class="n">signature_header</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">secret</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
    <span class="n">tolerance_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify a webhook signature (Stripe-style).</span>
<span class="sd">    Header format: t=&lt;timestamp&gt;,v1=&lt;signature&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Parse the header</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">signature_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
        <span class="n">elements</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">received_sig</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">received_sig</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Check timestamp freshness</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance_seconds</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Compute expected signature</span>
    <span class="n">signed_payload</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="n">payload</span>
    <span class="n">expected_sig</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
        <span class="n">secret</span><span class="p">,</span> <span class="n">signed_payload</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span>
    <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="c1"># Constant-time comparison</span>
    <span class="k">return</span> <span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">expected_sig</span><span class="p">,</span> <span class="n">received_sig</span><span class="p">)</span>

<span class="c1"># Simulate webhook</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="n">webhook_secret</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;whsec_test_secret_key_123&quot;</span>
<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;{&quot;event&quot;:&quot;payment.success&quot;,&quot;amount&quot;:5000}&#39;</span>
<span class="n">ts</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
<span class="n">sig</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
    <span class="n">webhook_secret</span><span class="p">,</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="n">payload</span><span class="p">,</span>
    <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span>
<span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;t=</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">,v1=</span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="n">is_valid</span> <span class="o">=</span> <span class="n">verify_webhook_signature</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">webhook_secret</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Webhook signature valid: </span><span class="si">{</span><span class="n">is_valid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Tampered payload</span>
<span class="n">is_valid</span> <span class="o">=</span> <span class="n">verify_webhook_signature</span><span class="p">(</span>
    <span class="sa">b</span><span class="s1">&#39;{&quot;event&quot;:&quot;payment.success&quot;,&quot;amount&quot;:50000}&#39;</span><span class="p">,</span>  <span class="c1"># Changed amount</span>
    <span class="n">header</span><span class="p">,</span>
    <span class="n">webhook_secret</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tampered webhook valid: </span><span class="si">{</span><span class="n">is_valid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="7-merkle-trees">7. Merkle Trees<a class="header-link" href="#7-merkle-trees" title="Permanent link">&para;</a></h2>
<p>A Merkle tree is a binary tree of hashes where each leaf node is a hash of a data block, and each internal node is a hash of its children. The root hash (Merkle root) summarizes all the data.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                       </span><span class="nv">Merkle</span><span class="w"> </span><span class="nv">Tree</span><span class="w">                                     </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">                        </span><span class="nv">Root</span><span class="w"> </span><span class="nv">Hash</span><span class="w">                                     </span>â”‚
â”‚<span class="w">                      </span><span class="nv">H</span><span class="ss">(</span><span class="nv">H12</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">H34</span><span class="ss">)</span><span class="w">                                  </span>â”‚
â”‚<span class="w">                       </span><span class="o">/</span><span class="w">        </span>\<span class="w">                                     </span>â”‚
â”‚<span class="w">                      </span><span class="o">/</span><span class="w">          </span>\<span class="w">                                    </span>â”‚
â”‚<span class="w">                   </span><span class="nv">H12</span><span class="w">            </span><span class="nv">H34</span><span class="w">                                 </span>â”‚
â”‚<span class="w">                </span><span class="nv">H</span><span class="ss">(</span><span class="nv">H1</span><span class="o">||</span><span class="nv">H2</span><span class="ss">)</span><span class="w">      </span><span class="nv">H</span><span class="ss">(</span><span class="nv">H3</span><span class="o">||</span><span class="nv">H4</span><span class="ss">)</span><span class="w">                             </span>â”‚
â”‚<span class="w">                </span><span class="o">/</span><span class="w">      </span>\<span class="w">        </span><span class="o">/</span><span class="w">      </span>\<span class="w">                              </span>â”‚
â”‚<span class="w">              </span><span class="nv">H1</span><span class="w">       </span><span class="nv">H2</span><span class="w">     </span><span class="nv">H3</span><span class="w">       </span><span class="nv">H4</span><span class="w">                            </span>â”‚
â”‚<span class="w">            </span><span class="nv">H</span><span class="ss">(</span><span class="nv">D1</span><span class="ss">)</span><span class="w">    </span><span class="nv">H</span><span class="ss">(</span><span class="nv">D2</span><span class="ss">)</span><span class="w">  </span><span class="nv">H</span><span class="ss">(</span><span class="nv">D3</span><span class="ss">)</span><span class="w">   </span><span class="nv">H</span><span class="ss">(</span><span class="nv">D4</span><span class="ss">)</span><span class="w">                           </span>â”‚
â”‚<span class="w">              </span><span class="o">|</span><span class="w">        </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">        </span><span class="o">|</span><span class="w">                              </span>â”‚
â”‚<span class="w">            </span><span class="nv">Data1</span><span class="w">   </span><span class="nv">Data2</span><span class="w">   </span><span class="nv">Data3</span><span class="w">   </span><span class="nv">Data4</span><span class="w">                            </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Properties</span>:<span class="w">                                                        </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Root</span><span class="w"> </span><span class="nv">hash</span><span class="w"> </span><span class="nv">changes</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">ANY</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="nv">block</span><span class="w"> </span><span class="nv">changes</span><span class="w">                      </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Can</span><span class="w"> </span><span class="nv">verify</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">single</span><span class="w"> </span><span class="nv">block</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">O</span><span class="ss">(</span><span class="nv">log</span><span class="w"> </span><span class="nv">n</span><span class="ss">)</span><span class="w"> </span><span class="nv">hashes</span><span class="w"> </span><span class="ss">(</span><span class="nv">Merkle</span><span class="w"> </span><span class="nv">proof</span><span class="ss">)</span><span class="w">   </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Used</span><span class="w"> </span><span class="nv">in</span>:<span class="w"> </span><span class="nv">Git</span>,<span class="w"> </span><span class="nv">Bitcoin</span>,<span class="w"> </span><span class="nv">Certificate</span><span class="w"> </span><span class="nv">Transparency</span>,<span class="w"> </span><span class="nv">IPFS</span><span class="w">            </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="71-merkle-tree-implementation">7.1 Merkle Tree Implementation<a class="header-link" href="#71-merkle-tree-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sha256</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MerkleNode</span><span class="p">:</span>
    <span class="nb">hash</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">left</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;MerkleNode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">right</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;MerkleNode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MerkleTree</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A complete Merkle tree implementation with proof generation/verification.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_blocks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_blocks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot create Merkle tree from empty data&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">leaves</span> <span class="o">=</span> <span class="p">[</span><span class="n">MerkleNode</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="n">sha256</span><span class="p">(</span><span class="n">block</span><span class="p">))</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">data_blocks</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leaves</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MerkleNode</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MerkleNode</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build the tree bottom-up.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># If odd number of nodes, duplicate the last one</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">parent_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hash</span> <span class="o">+</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hash</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">MerkleNode</span><span class="p">(</span>
                <span class="nb">hash</span><span class="o">=</span><span class="n">sha256</span><span class="p">(</span><span class="n">combined</span><span class="p">),</span>
                <span class="n">left</span><span class="o">=</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">right</span><span class="o">=</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">parent_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_tree</span><span class="p">(</span><span class="n">parent_nodes</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">root_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_proof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a Merkle proof for the leaf at the given index.</span>
<span class="sd">        Returns list of (hash, position) tuples where position is &#39;left&#39; or &#39;right&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leaves</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> out of range&quot;</span><span class="p">)</span>

        <span class="n">proof</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaves</span><span class="p">[:]</span>

        <span class="c1"># If odd, duplicate last</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">current_index</span> <span class="o">=</span> <span class="n">index</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">next_level</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">current_index</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">current_index</span><span class="p">:</span>
                    <span class="c1"># This is the pair containing our node</span>
                    <span class="k">if</span> <span class="n">current_index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Our node is on the left, sibling is on the right</span>
                        <span class="n">proof</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Our node is on the right, sibling is on the left</span>
                        <span class="n">proof</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">))</span>

                <span class="n">combined</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hash</span> <span class="o">+</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hash</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">MerkleNode</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="n">sha256</span><span class="p">(</span><span class="n">combined</span><span class="p">))</span>
                <span class="n">next_level</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

            <span class="n">current_index</span> <span class="o">=</span> <span class="n">current_index</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">next_level</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">proof</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">verify_proof</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">proof</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">],</span> <span class="n">root_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify a Merkle proof.&quot;&quot;&quot;</span>
        <span class="n">current_hash</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">sibling_hash</span><span class="p">,</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">proof</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
                <span class="n">combined</span> <span class="o">=</span> <span class="n">sibling_hash</span> <span class="o">+</span> <span class="n">current_hash</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combined</span> <span class="o">=</span> <span class="n">current_hash</span> <span class="o">+</span> <span class="n">sibling_hash</span>
            <span class="n">current_hash</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">current_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span> <span class="o">==</span> <span class="n">root_hash</span>

<span class="c1"># Build a Merkle tree</span>
<span class="n">data_blocks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sa">b</span><span class="s2">&quot;Transaction: Alice -&gt; Bob $100&quot;</span><span class="p">,</span>
    <span class="sa">b</span><span class="s2">&quot;Transaction: Bob -&gt; Charlie $50&quot;</span><span class="p">,</span>
    <span class="sa">b</span><span class="s2">&quot;Transaction: Charlie -&gt; Dave $25&quot;</span><span class="p">,</span>
    <span class="sa">b</span><span class="s2">&quot;Transaction: Dave -&gt; Alice $75&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">MerkleTree</span><span class="p">(</span><span class="n">data_blocks</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merkle root: </span><span class="si">{</span><span class="n">tree</span><span class="o">.</span><span class="n">root_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leaves: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">leaves</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Generate proof for transaction at index 1</span>
<span class="n">proof</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">get_proof</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Proof for block 1 (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">proof</span><span class="p">)</span><span class="si">}</span><span class="s2"> nodes):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">proof</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">pos</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">h</span><span class="o">.</span><span class="n">hex</span><span class="p">()[:</span><span class="mi">32</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

<span class="c1"># Verify the proof</span>
<span class="n">is_valid</span> <span class="o">=</span> <span class="n">MerkleTree</span><span class="o">.</span><span class="n">verify_proof</span><span class="p">(</span>
    <span class="n">data_blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">proof</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">root_hash</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Proof valid: </span><span class="si">{</span><span class="n">is_valid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Tampered data fails</span>
<span class="n">is_valid</span> <span class="o">=</span> <span class="n">MerkleTree</span><span class="o">.</span><span class="n">verify_proof</span><span class="p">(</span>
    <span class="sa">b</span><span class="s2">&quot;Transaction: Bob -&gt; Charlie $5000&quot;</span><span class="p">,</span>  <span class="c1"># Tampered!</span>
    <span class="n">proof</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">root_hash</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tampered proof valid: </span><span class="si">{</span><span class="n">is_valid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Show efficiency: verifying 1 block out of 1M requires only ~20 hashes</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="n">n_blocks</span> <span class="o">=</span> <span class="mi">1_000_000</span>
<span class="n">proof_size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">n_blocks</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">For </span><span class="si">{</span><span class="n">n_blocks</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> blocks:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Proof size: </span><span class="si">{</span><span class="n">proof_size</span><span class="si">}</span><span class="s2"> hashes (</span><span class="si">{</span><span class="n">proof_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="si">}</span><span class="s2"> bytes)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  vs checking all: </span><span class="si">{</span><span class="n">n_blocks</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Efficiency: </span><span class="si">{</span><span class="n">n_blocks</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">proof_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">x smaller&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="8-content-addressable-storage">8. Content-Addressable Storage<a class="header-link" href="#8-content-addressable-storage" title="Permanent link">&para;</a></h2>
<p>Content-addressable storage (CAS) uses the hash of data as its address/key. This is the foundation of Git, IPFS, Docker layers, and many deduplication systems.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">Content</span><span class="o">-</span><span class="n">Addressable</span><span class="w"> </span><span class="n">Storage</span><span class="w"> </span><span class="p">(</span><span class="n">CAS</span><span class="p">)</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Traditional</span><span class="w"> </span><span class="n">Storage</span><span class="o">:</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="n">filename</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">data</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">report</span><span class="p">.</span><span class="n">pdf</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="p">[</span><span class="n">file</span><span class="w"> </span><span class="n">contents</span><span class="p">]</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Content</span><span class="o">-</span><span class="n">Addressable</span><span class="w"> </span><span class="n">Storage</span><span class="o">:</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="n">hash</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">data</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="n">sha256</span><span class="o">:</span><span class="n">a3f2b8</span><span class="p">...</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="p">[</span><span class="n">file</span><span class="w"> </span><span class="n">contents</span><span class="p">]</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Benefits</span><span class="o">:</span><span class="w">                                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Automatic</span><span class="w"> </span><span class="n">deduplication</span><span class="w"> </span><span class="p">(</span><span class="n">same</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="n">once</span><span class="p">)</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Built</span><span class="o">-</span><span class="k">in</span><span class="w"> </span><span class="n">integrity</span><span class="w"> </span><span class="n">verification</span><span class="w"> </span><span class="p">(</span><span class="n">hash</span><span class="w"> </span><span class="n">IS</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">address</span><span class="p">)</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Immutable</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">design</span><span class="w"> </span><span class="p">(</span><span class="n">changing</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="n">changes</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">address</span><span class="p">)</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Cache</span><span class="o">-</span><span class="n">friendly</span><span class="w"> </span><span class="p">(</span><span class="n">content</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="n">changes</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">given</span><span class="w"> </span><span class="n">address</span><span class="p">)</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Used</span><span class="w"> </span><span class="k">in</span><span class="o">:</span><span class="w">                                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Git</span><span class="w"> </span><span class="p">(</span><span class="n">blob</span><span class="w"> </span><span class="n">objects</span><span class="w"> </span><span class="n">addressed</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">SHA</span><span class="mi">-1</span><span class="o">/</span><span class="n">SHA</span><span class="mi">-256</span><span class="p">)</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="p">(</span><span class="n">image</span><span class="w"> </span><span class="n">layers</span><span class="w"> </span><span class="n">addressed</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">SHA</span><span class="mi">-256</span><span class="p">)</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">IPFS</span><span class="w"> </span><span class="p">(</span><span class="n">blocks</span><span class="w"> </span><span class="n">addressed</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">multihash</span><span class="p">)</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Nix</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="n">manager</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Content</span><span class="w"> </span><span class="n">delivery</span><span class="w"> </span><span class="n">networks</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="81-cas-implementation">8.1 CAS Implementation<a class="header-link" href="#81-cas-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CASStats</span><span class="p">:</span>
    <span class="n">total_objects</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">deduplicated_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ContentAddressableStore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple content-addressable store using SHA-256.</span>
<span class="sd">    Similar to how Git stores objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">store_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_hash_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute SHA-256 hash of content.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_object_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the filesystem path for an object.</span>
<span class="sd">        Uses first 2 chars as directory (like Git) to avoid</span>
<span class="sd">        too many files in a single directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_dir</span> <span class="o">/</span> <span class="n">content_hash</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">content_hash</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Store data and return its content hash.</span>
<span class="sd">        If data already exists, this is a no-op (deduplication).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">content_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash_content</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">obj_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_path</span><span class="p">(</span><span class="n">content_hash</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">obj_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">obj_path</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">content_hash</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve data by its content hash.&quot;&quot;&quot;</span>
        <span class="n">obj_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_path</span><span class="p">(</span><span class="n">content_hash</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">obj_path</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>

        <span class="c1"># Verify integrity on read</span>
        <span class="n">actual_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash_content</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">actual_hash</span> <span class="o">!=</span> <span class="n">content_hash</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Integrity error! Expected </span><span class="si">{</span><span class="n">content_hash</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">actual_hash</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if an object exists.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_path</span><span class="p">(</span><span class="n">content_hash</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete an object (use with care in production).&quot;&quot;&quot;</span>
        <span class="n">obj_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_path</span><span class="p">(</span><span class="n">content_hash</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">obj_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="c1"># Clean up empty directory</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rmdir</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CASStats</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute storage statistics.&quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">CASStats</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">subdir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">obj_file</span> <span class="ow">in</span> <span class="n">subdir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
                    <span class="n">stats</span><span class="o">.</span><span class="n">total_objects</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">stats</span><span class="o">.</span><span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">obj_file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span>
        <span class="k">return</span> <span class="n">stats</span>

<span class="c1"># Usage</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">ContentAddressableStore</span><span class="p">(</span><span class="s2">&quot;/tmp/cas_demo&quot;</span><span class="p">)</span>

<span class="c1"># Store some data</span>
<span class="n">data1</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Hello, content-addressable world!&quot;</span>
<span class="n">data2</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Another piece of data&quot;</span>
<span class="n">data3</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Hello, content-addressable world!&quot;</span>  <span class="c1"># Duplicate of data1!</span>

<span class="n">hash1</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span>
<span class="n">hash2</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span>
<span class="n">hash3</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">data3</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data 1 hash: </span><span class="si">{</span><span class="n">hash1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data 2 hash: </span><span class="si">{</span><span class="n">hash2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data 3 hash: </span><span class="si">{</span><span class="n">hash3</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data 1 == Data 3 hash? </span><span class="si">{</span><span class="n">hash1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">hash3</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># True - deduplication!</span>

<span class="c1"># Retrieve by hash</span>
<span class="n">retrieved</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hash1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Retrieved: </span><span class="si">{</span><span class="n">retrieved</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Integrity: </span><span class="si">{</span><span class="n">retrieved</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">data1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Stats</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Store stats:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Objects: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">total_objects</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 2, not 3 (dedup!)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total bytes: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">total_bytes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Clean up</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s2">&quot;/tmp/cas_demo&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="82-git-style-object-store">8.2 Git-Style Object Store<a class="header-link" href="#82-git-style-object-store" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span><span class="w"> </span><span class="nc">GitObjectStore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simplified Git object store.</span>
<span class="sd">    Git stores objects as: header + content, compressed with zlib.</span>
<span class="sd">    Header format: &quot;&lt;type&gt; &lt;size&gt;\0&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">git_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objects_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">git_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;objects&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objects_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">hash_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;blob&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hash an object (like &#39;git hash-object&#39;).&quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="se">\0</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">full_content</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">data</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">full_content</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>  <span class="c1"># Git uses SHA-1 (transitioning to SHA-256)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;blob&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write an object to the store (like &#39;git hash-object -w&#39;).&quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="se">\0</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">full_content</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">data</span>
        <span class="n">obj_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">full_content</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="c1"># Store compressed</span>
        <span class="n">obj_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects_dir</span> <span class="o">/</span> <span class="n">obj_hash</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">obj_hash</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">obj_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">compressed</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">full_content</span><span class="p">)</span>
            <span class="n">obj_path</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">obj_hash</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read an object (like &#39;git cat-file&#39;).&quot;&quot;&quot;</span>
        <span class="n">obj_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects_dir</span> <span class="o">/</span> <span class="n">obj_hash</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">obj_hash</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object </span><span class="si">{</span><span class="n">obj_hash</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

        <span class="n">compressed</span> <span class="o">=</span> <span class="n">obj_path</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
        <span class="n">full_content</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span>

        <span class="c1"># Parse header</span>
        <span class="n">null_pos</span> <span class="o">=</span> <span class="n">full_content</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">full_content</span><span class="p">[:</span><span class="n">null_pos</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">obj_type</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">full_content</span><span class="p">[</span><span class="n">null_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="s2">&quot;Size mismatch&quot;</span>
        <span class="k">return</span> <span class="n">obj_type</span><span class="p">,</span> <span class="n">data</span>

<span class="c1"># Usage</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">GitObjectStore</span><span class="p">(</span><span class="s2">&quot;/tmp/git_demo/.git&quot;</span><span class="p">)</span>

<span class="c1"># Store a blob (file content)</span>
<span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;print(&#39;Hello, World!&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="n">blob_hash</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">write_object</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;blob&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Blob hash: </span><span class="si">{</span><span class="n">blob_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Read it back</span>
<span class="n">obj_type</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">read_object</span><span class="p">(</span><span class="n">blob_hash</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type: </span><span class="si">{</span><span class="n">obj_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Content: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Store a tree (directory listing) - simplified</span>
<span class="n">tree_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;100644 hello.py</span><span class="se">\0</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">blob_hash</span><span class="p">)</span>
<span class="n">tree_hash</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">write_object</span><span class="p">(</span><span class="n">tree_content</span><span class="p">,</span> <span class="s2">&quot;tree&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tree hash: </span><span class="si">{</span><span class="n">tree_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Clean up</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s2">&quot;/tmp/git_demo&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="9-timing-attacks-and-constant-time-comparison">9. Timing Attacks and Constant-Time Comparison<a class="header-link" href="#9-timing-attacks-and-constant-time-comparison" title="Permanent link">&para;</a></h2>
<h3 id="91-the-problem">9.1 The Problem<a class="header-link" href="#91-the-problem" title="Permanent link">&para;</a></h3>
<p>When comparing two strings character by character, the time taken depends on where the first difference occurs. An attacker can measure response times to determine how many characters of a secret value they have guessed correctly.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                    </span><span class="nv">Timing</span><span class="w"> </span><span class="nv">Attack</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">String</span><span class="w"> </span><span class="nv">Comparison</span><span class="w">                 </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Secret</span><span class="w"> </span><span class="nv">MAC</span>:<span class="w"> </span><span class="s2">&quot;a3f2b8c9d1e4&quot;</span><span class="w">                                        </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Attempt</span><span class="w"> </span><span class="mi">1</span>:<span class="w"> </span><span class="s2">&quot;x3f2b8c9d1e4&quot;</span><span class="w">  </span>â†’<span class="w"> </span><span class="nv">Fails</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">position</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span>â†’<span class="w"> </span><span class="o">~</span><span class="mi">100</span><span class="w"> </span><span class="nv">ns</span><span class="w">     </span>â”‚
â”‚<span class="w">  </span><span class="nv">Attempt</span><span class="w"> </span><span class="mi">2</span>:<span class="w"> </span><span class="s2">&quot;a4f2b8c9d1e4&quot;</span><span class="w">  </span>â†’<span class="w"> </span><span class="nv">Fails</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">position</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span>â†’<span class="w"> </span><span class="o">~</span><span class="mi">110</span><span class="w"> </span><span class="nv">ns</span><span class="w">     </span>â”‚
â”‚<span class="w">  </span><span class="nv">Attempt</span><span class="w"> </span><span class="mi">3</span>:<span class="w"> </span><span class="s2">&quot;a3g2b8c9d1e4&quot;</span><span class="w">  </span>â†’<span class="w"> </span><span class="nv">Fails</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">position</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span>â†’<span class="w"> </span><span class="o">~</span><span class="mi">120</span><span class="w"> </span><span class="nv">ns</span><span class="w">     </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">The</span><span class="w"> </span><span class="nv">attacker</span><span class="w"> </span><span class="nv">notices</span><span class="w"> </span><span class="nv">each</span><span class="w"> </span><span class="nv">correct</span><span class="w"> </span><span class="nv">character</span><span class="w"> </span><span class="nv">adds</span><span class="w"> </span><span class="o">~</span><span class="mi">10</span><span class="w"> </span><span class="nv">ns</span>.<span class="w">           </span>â”‚
â”‚<span class="w">  </span><span class="nv">By</span><span class="w"> </span><span class="nv">trying</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">values</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">each</span><span class="w"> </span><span class="nv">position</span>,<span class="w"> </span><span class="nv">they</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="nv">recover</span><span class="w">           </span>â”‚
â”‚<span class="w">  </span><span class="nv">the</span><span class="w"> </span><span class="nv">entire</span><span class="w"> </span><span class="nv">MAC</span><span class="w"> </span><span class="nv">one</span><span class="w"> </span><span class="nv">character</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">time</span>:<span class="w"> </span><span class="nv">O</span><span class="ss">(</span><span class="nv">n</span><span class="w"> </span>Ã—<span class="w"> </span><span class="mi">16</span><span class="ss">)</span><span class="w"> </span><span class="nv">instead</span><span class="w"> </span><span class="nv">of</span><span class="w">      </span>â”‚
â”‚<span class="w">  </span><span class="nv">O</span><span class="ss">(</span><span class="mi">16</span><span class="o">^</span><span class="nv">n</span><span class="ss">)</span>.<span class="w">                                                           </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="k">For</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="nv">character</span><span class="w"> </span><span class="nv">hex</span><span class="w"> </span><span class="nv">MAC</span>:<span class="w">                                        </span>â”‚
â”‚<span class="w">  </span><span class="nv">Brute</span><span class="w"> </span><span class="nv">force</span>:<span class="w"> </span><span class="mi">16</span><span class="o">^</span><span class="mi">32</span><span class="w"> </span>â‰ˆ<span class="w"> </span><span class="mi">3</span>.<span class="mi">4</span><span class="w"> </span>Ã—<span class="w"> </span><span class="mi">10</span><span class="o">^</span><span class="mi">38</span><span class="w"> </span><span class="nv">attempts</span><span class="w">                       </span>â”‚
â”‚<span class="w">  </span><span class="nv">Timing</span><span class="w"> </span><span class="nv">attack</span>:<span class="w"> </span><span class="mi">32</span><span class="w"> </span>Ã—<span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="nv">attempts</span><span class="w"> </span><span class="ss">(</span><span class="o">!</span><span class="ss">)</span><span class="w">                        </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="92-vulnerable-vs-secure-comparison">9.2 Vulnerable vs Secure Comparison<a class="header-link" href="#92-vulnerable-vs-secure-comparison" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hmac</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="c1"># VULNERABLE: Early-exit string comparison</span>
<span class="k">def</span><span class="w"> </span><span class="nf">insecure_compare</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DO NOT USE! Vulnerable to timing attacks.</span>
<span class="sd">    Returns False as soon as a mismatch is found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">y</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Early exit leaks information!</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># SECURE: Constant-time comparison</span>
<span class="k">def</span><span class="w"> </span><span class="nf">secure_compare</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constant-time comparison. Takes the same time regardless</span>
<span class="sd">    of where (or if) the strings differ.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="c1"># Demonstrate the timing difference</span>
<span class="n">secret_mac</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;secret-key&quot;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;message&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="c1"># Generate test MACs with increasing correct prefix length</span>
<span class="n">test_macs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">secret_mac</span><span class="p">),</span> <span class="mi">4</span><span class="p">):</span>
    <span class="n">correct_prefix</span> <span class="o">=</span> <span class="n">secret_mac</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
    <span class="n">wrong_suffix</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">secret_mac</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">test_macs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correct_prefix</span> <span class="o">+</span> <span class="n">wrong_suffix</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Timing Attack Demonstration&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Secret MAC: </span><span class="si">{</span><span class="n">secret_mac</span><span class="p">[:</span><span class="mi">32</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Measure insecure comparison times</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;INSECURE comparison (early exit):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="n">test_macs</span><span class="p">[:</span><span class="mi">8</span><span class="p">]:</span>
    <span class="n">correct_chars</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">secret_mac</span><span class="p">))</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter_ns</span><span class="p">()</span>
        <span class="n">insecure_compare</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">secret_mac</span><span class="p">)</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter_ns</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">correct_chars</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2"> correct chars â†’ avg </span><span class="si">{</span><span class="n">avg</span><span class="si">:</span><span class="s2">6.0f</span><span class="si">}</span><span class="s2"> ns&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Measure secure comparison times</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SECURE comparison (constant-time):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="n">test_macs</span><span class="p">[:</span><span class="mi">8</span><span class="p">]:</span>
    <span class="n">correct_chars</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">secret_mac</span><span class="p">))</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter_ns</span><span class="p">()</span>
        <span class="n">secure_compare</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">secret_mac</span><span class="p">)</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter_ns</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">correct_chars</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2"> correct chars â†’ avg </span><span class="si">{</span><span class="n">avg</span><span class="si">:</span><span class="s2">6.0f</span><span class="si">}</span><span class="s2"> ns&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Note: Secure comparison time should be roughly constant&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;regardless of how many characters match.&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="93-rules-for-timing-safe-code">9.3 Rules for Timing-Safe Code<a class="header-link" href="#93-rules-for-timing-safe-code" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">               </span><span class="n">Rules</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Constant</span><span class="o">-</span><span class="nc">Time</span><span class="w"> </span><span class="n">Operations</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">NEVER</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">compare</span><span class="w"> </span><span class="n">secrets</span><span class="w"> </span><span class="p">(</span><span class="n">MACs</span><span class="p">,</span><span class="w"> </span><span class="n">tokens</span><span class="p">,</span><span class="w"> </span><span class="n">passwords</span><span class="p">)</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="k">USE</span><span class="err">:</span><span class="w"> </span><span class="n">hmac</span><span class="p">.</span><span class="n">compare_digest</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">secrets</span><span class="p">.</span><span class="n">compare_digest</span><span class="p">()</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">NEVER</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">early</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="k">data</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nl">BAD</span><span class="p">:</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">mac</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">expected</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">False</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nl">GOOD</span><span class="p">:</span><span class="w"> </span><span class="k">result</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">mac</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">expected</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">)</span><span class="w">   </span><span class="err">#</span><span class="w"> </span><span class="n">accumulate</span><span class="w"> </span><span class="n">diffs</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="n">NEVER</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="k">data</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nl">BAD</span><span class="p">:</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">secret_key</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;a&#39;</span><span class="err">:</span><span class="w"> </span><span class="p">...</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nl">GOOD</span><span class="p">:</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">constant</span><span class="o">-</span><span class="nc">time</span><span class="w"> </span><span class="n">selection</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">masking</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">4.</span><span class="w"> </span><span class="n">NEVER</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">arrays</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="k">values</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nl">BAD</span><span class="p">:</span><span class="w">  </span><span class="nc">table</span><span class="o">[</span><span class="n">secret_byte</span><span class="o">]</span><span class="w">   </span><span class="err">#</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="n">timing</span><span class="w"> </span><span class="n">leak</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nl">GOOD</span><span class="p">:</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">constant</span><span class="o">-</span><span class="nc">time</span><span class="w"> </span><span class="n">lookup</span><span class="w"> </span><span class="n">tables</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">5.</span><span class="w"> </span><span class="n">ALWAYS</span><span class="w"> </span><span class="n">verify</span><span class="w"> </span><span class="n">MACs</span><span class="w"> </span><span class="k">before</span><span class="w"> </span><span class="n">decrypting</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">This</span><span class="w"> </span><span class="n">prevents</span><span class="w"> </span><span class="n">padding</span><span class="w"> </span><span class="n">oracle</span><span class="w"> </span><span class="n">attacks</span><span class="w"> </span><span class="p">(</span><span class="n">Encrypt</span><span class="o">-</span><span class="k">then</span><span class="o">-</span><span class="n">MAC</span><span class="p">)</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="10-hash-function-attacks-and-mitigations">10. Hash Function Attacks and Mitigations<a class="header-link" href="#10-hash-function-attacks-and-mitigations" title="Permanent link">&para;</a></h2>
<h3 id="101-known-attacks">10.1 Known Attacks<a class="header-link" href="#101-known-attacks" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                </span><span class="n">Hash</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="n">Attack</span><span class="w"> </span><span class="n">Summary</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Attack</span><span class="w">             </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Description</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">Status</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Birthday</span><span class="w"> </span><span class="n">attack</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="n">ANY</span><span class="w"> </span><span class="n">collision</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">O</span><span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="o">^</span><span class="mi">128</span><span class="w"> </span><span class="p">(</span><span class="n">safe</span><span class="p">),</span><span class="w"> </span><span class="n">MD5</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="o">^</span><span class="mi">64</span><span class="w"> </span><span class="p">(</span><span class="n">broken</span><span class="p">)</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Length</span><span class="o">-</span><span class="n">extension</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Given</span><span class="w"> </span><span class="n">H</span><span class="p">(</span><span class="n">m</span><span class="p">),</span><span class="w"> </span><span class="n">compute</span><span class="w"> </span><span class="n">H</span><span class="p">(</span><span class="n">m</span><span class="o">||</span><span class="n">pad</span><span class="o">||</span><span class="n">suffix</span><span class="p">)</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">knowing</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="w"> </span><span class="n">Affects</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mf">512.</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">NOT</span><span class="p">:</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">BLAKE2</span><span class="p">,</span><span class="w"> </span><span class="n">HMAC</span><span class="p">,</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">512</span><span class="o">/</span><span class="mi">256</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Rainbow</span><span class="w"> </span><span class="n">tables</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Precomputed</span><span class="w"> </span><span class="nb">hash</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">password</span><span class="w"> </span><span class="n">lookup</span><span class="w"> </span><span class="n">tables</span><span class="o">.</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Defeated</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">salting</span><span class="w"> </span><span class="n">passwords</span><span class="o">.</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nb nb-Type">Dictionary</span><span class="w"> </span><span class="n">attack</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Try</span><span class="w"> </span><span class="n">common</span><span class="w"> </span><span class="n">passwords</span><span class="w"> </span><span class="n">against</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="nb">hash</span><span class="o">.</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Mitigated</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">slow</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="n">hashes</span><span class="w"> </span><span class="p">(</span><span class="n">Argon2</span><span class="p">)</span><span class="o">.</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">GPU</span><span class="w"> </span><span class="n">brute</span><span class="w"> </span><span class="n">force</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">GPUs</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">compute</span><span class="w"> </span><span class="n">billions</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">hashes</span><span class="o">/</span><span class="n">second</span><span class="o">.</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Mitigated</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">memory</span><span class="o">-</span><span class="n">hard</span><span class="w"> </span><span class="n">hashes</span><span class="w"> </span><span class="p">(</span><span class="n">Argon2id</span><span class="p">)</span><span class="o">.</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">SHAttered</span><span class="w"> </span><span class="p">(</span><span class="mi">2017</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Practical</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="n">collision</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">Google</span><span class="o">.</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Two</span><span class="w"> </span><span class="n">PDFs</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">considered</span><span class="w"> </span><span class="n">broken</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">security</span><span class="o">.</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Multi</span><span class="o">-</span><span class="n">collision</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="n">many</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="nb">hash</span><span class="o">.</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Easier</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">iterative</span><span class="w"> </span><span class="n">hashes</span><span class="o">.</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">3</span><span class="s1">&#39;s sponge construction is more resistant. â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="102-length-extension-attack">10.2 Length-Extension Attack<a class="header-link" href="#102-length-extension-attack" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Length-extension attack demonstration</span>
<span class="c1"># This is why you should use HMAC instead of H(key || message)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sha256_pad</span><span class="p">(</span><span class="n">message_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute SHA-256 padding for a message of given length.&quot;&quot;&quot;</span>
    <span class="n">bit_len</span> <span class="o">=</span> <span class="n">message_len</span> <span class="o">*</span> <span class="mi">8</span>
    <span class="c1"># Padding: 1 bit, then zeros, then 64-bit length</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x80</span><span class="s1">&#39;</span>
    <span class="n">padding</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="p">((</span><span class="mi">56</span> <span class="o">-</span> <span class="p">(</span><span class="n">message_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">64</span><span class="p">)</span> <span class="o">%</span> <span class="mi">64</span><span class="p">)</span>
    <span class="n">padding</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;Q&#39;</span><span class="p">,</span> <span class="n">bit_len</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">padding</span>

<span class="c1"># The vulnerability: H(secret || message) is NOT a secure MAC</span>
<span class="c1">#</span>
<span class="c1"># If an attacker knows:</span>
<span class="c1">#   - H(secret || message)  (the MAC)</span>
<span class="c1">#   - len(secret)           (or can guess it)</span>
<span class="c1">#   - message               (the original message)</span>
<span class="c1">#</span>
<span class="c1"># They can compute H(secret || message || padding || extension)</span>
<span class="c1"># WITHOUT knowing the secret!</span>
<span class="c1">#</span>
<span class="c1"># This is because SHA-256 processes data in blocks, and the hash</span>
<span class="c1"># state after processing (secret || message || padding) is exactly</span>
<span class="c1"># the public hash value. The attacker can resume hashing from there.</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Length-Extension Attack Concept:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VULNERABLE construction: MAC = SHA-256(secret || message)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;An attacker who knows MAC and len(secret) can extend the message.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SAFE alternatives:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  1. HMAC-SHA256(key, message)     â€” HMAC construction&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  2. SHA-3-256(key || message)      â€” SHA-3 is not vulnerable&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  3. BLAKE2b(message, key=key)      â€” Built-in keying&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  4. SHA-512/256(key || message)    â€” Truncated hash&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="11-exercises">11. Exercises<a class="header-link" href="#11-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-hash-explorer-beginner">Exercise 1: Hash Explorer (Beginner)<a class="header-link" href="#exercise-1-hash-explorer-beginner" title="Permanent link">&para;</a></h3>
<p>Write a Python program that:
1. Takes a filename as input
2. Computes SHA-256, SHA-3-256, BLAKE2b-256, and BLAKE3 hashes
3. Displays all hashes and the time taken for each
4. Compares the speed of each algorithm on a 100 MB file
5. Verifies the file has not been modified by comparing hashes</p>
<h3 id="exercise-2-password-cracker-defense-intermediate">Exercise 2: Password Cracker Defense (Intermediate)<a class="header-link" href="#exercise-2-password-cracker-defense-intermediate" title="Permanent link">&para;</a></h3>
<p>Implement a password cracking simulation:
1. Create a list of 1000 "user accounts" with passwords hashed using:
   a. Plain SHA-256 (no salt)
   b. SHA-256 with unique salt
   c. bcrypt (cost=10)
   d. Argon2id (default parameters)
2. Attempt to crack all passwords using a dictionary of 10,000 common passwords
3. Measure and compare the time needed for each hashing method
4. Generate a report showing cracked vs uncracked percentages</p>
<h3 id="exercise-3-merkle-tree-file-verifier-intermediate">Exercise 3: Merkle Tree File Verifier (Intermediate)<a class="header-link" href="#exercise-3-merkle-tree-file-verifier-intermediate" title="Permanent link">&para;</a></h3>
<p>Build a file integrity verification system using Merkle trees:
1. Given a directory, compute a Merkle tree over all files (sorted by path)
2. Store the Merkle root and tree structure
3. Later, verify any individual file by recomputing only O(log n) hashes
4. Generate a Merkle proof that can be independently verified
5. Handle file additions and deletions efficiently</p>
<h3 id="exercise-4-hmac-based-api-authentication-intermediate">Exercise 4: HMAC-based API Authentication (Intermediate)<a class="header-link" href="#exercise-4-hmac-based-api-authentication-intermediate" title="Permanent link">&para;</a></h3>
<p>Implement a complete API authentication system:
1. Server issues API key + secret to each client
2. Client signs each request with HMAC-SHA256:
   - Include: method, path, timestamp, body hash, nonce
3. Server verifies: valid signature, fresh timestamp (within 5 min), unused nonce
4. Implement replay attack protection using a nonce cache
5. Handle clock skew between client and server</p>
<h3 id="exercise-5-content-addressable-file-sync-advanced">Exercise 5: Content-Addressable File Sync (Advanced)<a class="header-link" href="#exercise-5-content-addressable-file-sync-advanced" title="Permanent link">&para;</a></h3>
<p>Build a simplified file synchronization system (like rsync with content addressing):
1. Both sides maintain a CAS of their files
2. To sync, exchange only the list of content hashes
3. Transfer only the blocks that the other side is missing
4. Verify integrity of all received blocks
5. Use a Merkle tree to efficiently detect which parts of large files differ</p>
<h3 id="exercise-6-timing-attack-lab-advanced">Exercise 6: Timing Attack Lab (Advanced)<a class="header-link" href="#exercise-6-timing-attack-lab-advanced" title="Permanent link">&para;</a></h3>
<p>Build a controlled timing attack:
1. Create a server that verifies API tokens using insecure comparison (<code>==</code>)
2. Write a client that measures response times to guess the token one character at a time
3. Demonstrate that the attack recovers the full token
4. Fix the server to use <code>hmac.compare_digest()</code>
5. Show that the attack no longer works
6. Discuss other timing side channels (cache timing, power analysis)</p>
<hr />
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li>Aumasson, J.P. (2017). <em>Serious Cryptography</em>. No Starch Press.</li>
<li>NIST FIPS 180-4: Secure Hash Standard (SHA-2)</li>
<li>NIST FIPS 202: SHA-3 Standard</li>
<li>RFC 7693: The BLAKE2 Cryptographic Hash</li>
<li>BLAKE3 Specification - https://github.com/BLAKE3-team/BLAKE3-specs</li>
<li>RFC 2104: HMAC: Keyed-Hashing for Message Authentication</li>
<li>OWASP Password Storage Cheat Sheet - https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html</li>
<li>Argon2 Reference - https://github.com/P-H-C/phc-winner-argon2</li>
<li>Merkle, R.C. (1979). "A Certified Digital Signature"</li>
</ul>
<hr />
<p><strong>Previous</strong>: <a href="./02_Cryptography_Basics.md">02. Cryptography Basics</a> | <strong>Next</strong>: <a href="./04_TLS_and_PKI.md">04. TLS/SSL and Public Key Infrastructure</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/02_Cryptography_Basics.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Cryptography Basics</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/04_TLS_and_PKI.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">TLS/SSL and Public Key Infrastructure</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}