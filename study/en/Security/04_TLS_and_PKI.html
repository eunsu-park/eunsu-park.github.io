{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TLS/SSL and Public Key Infrastructure - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Security/">Security</a>
    <span class="separator">/</span>
    <span class="current">TLS/SSL and Public Key Infrastructure</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>TLS/SSL and Public Key Infrastructure</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/03_Hashing_and_Integrity.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Hashing and Data Integrity</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/05_Authentication.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">05. Authentication Systems</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-tls-overview-and-history">1. TLS Overview and History</a><ul>
<li><a href="#11-protocol-evolution">1.1 Protocol Evolution</a></li>
<li><a href="#12-where-tls-sits-in-the-stack">1.2 Where TLS Sits in the Stack</a></li>
<li><a href="#13-what-tls-provides">1.3 What TLS Provides</a></li>
</ul>
</li>
<li><a href="#2-tls-13-handshake-in-detail">2. TLS 1.3 Handshake in Detail</a><ul>
<li><a href="#21-full-handshake-1-rtt">2.1 Full Handshake (1-RTT)</a></li>
<li><a href="#22-key-derivation-in-tls-13">2.2 Key Derivation in TLS 1.3</a></li>
<li><a href="#23-tls-13-vs-tls-12">2.3 TLS 1.3 vs TLS 1.2</a></li>
<li><a href="#24-0-rtt-zero-round-trip-time-resumption">2.4 0-RTT (Zero Round Trip Time) Resumption</a></li>
</ul>
</li>
<li><a href="#3-cipher-suites">3. Cipher Suites</a><ul>
<li><a href="#31-tls-13-cipher-suites">3.1 TLS 1.3 Cipher Suites</a></li>
<li><a href="#32-understanding-tls-12-cipher-suite-names">3.2 Understanding TLS 1.2 Cipher Suite Names</a></li>
</ul>
</li>
<li><a href="#4-x509-certificates">4. X.509 Certificates</a><ul>
<li><a href="#41-certificate-structure">4.1 Certificate Structure</a></li>
<li><a href="#42-reading-certificates-in-python">4.2 Reading Certificates in Python</a></li>
</ul>
</li>
<li><a href="#5-certificate-chains-and-trust">5. Certificate Chains and Trust</a><ul>
<li><a href="#51-chain-of-trust">5.1 Chain of Trust</a></li>
<li><a href="#52-certificate-chain-verification-in-python">5.2 Certificate Chain Verification in Python</a></li>
</ul>
</li>
<li><a href="#6-certificate-authorities-ca">6. Certificate Authorities (CA)</a><ul>
<li><a href="#61-how-cas-work">6.1 How CAs Work</a></li>
<li><a href="#62-certificate-revocation">6.2 Certificate Revocation</a></li>
<li><a href="#63-certificate-transparency-ct">6.3 Certificate Transparency (CT)</a></li>
</ul>
</li>
<li><a href="#7-lets-encrypt-and-acme">7. Let's Encrypt and ACME</a><ul>
<li><a href="#71-acme-protocol-overview">7.1 ACME Protocol Overview</a></li>
<li><a href="#72-certbot-commands">7.2 Certbot Commands</a></li>
<li><a href="#73-certificate-files">7.3 Certificate Files</a></li>
</ul>
</li>
<li><a href="#8-certificate-pinning">8. Certificate Pinning</a><ul>
<li><a href="#81-certificate-pinning-in-python">8.1 Certificate Pinning in Python</a></li>
</ul>
</li>
<li><a href="#9-mutual-tls-mtls">9. Mutual TLS (mTLS)</a><ul>
<li><a href="#91-mtls-implementation">9.1 mTLS Implementation</a></li>
</ul>
</li>
<li><a href="#10-python-tls-programming">10. Python TLS Programming</a><ul>
<li><a href="#101-secure-https-client">10.1 Secure HTTPS Client</a></li>
<li><a href="#102-tls-server-with-python">10.2 TLS Server with Python</a></li>
</ul>
</li>
<li><a href="#11-creating-certificates-with-openssl">11. Creating Certificates with OpenSSL</a><ul>
<li><a href="#111-self-signed-certificate-development">11.1 Self-Signed Certificate (Development)</a></li>
<li><a href="#112-ca-server-certificate-full-process">11.2 CA + Server Certificate (Full Process)</a></li>
<li><a href="#113-ecdsa-certificates-smaller-faster">11.3 ECDSA Certificates (Smaller, Faster)</a></li>
<li><a href="#114-client-certificate-for-mtls">11.4 Client Certificate for mTLS</a></li>
</ul>
</li>
<li><a href="#12-common-misconfigurations">12. Common Misconfigurations</a><ul>
<li><a href="#121-security-headers-checklist">12.1 Security Headers Checklist</a></li>
</ul>
</li>
<li><a href="#13-testing-tls-configurations">13. Testing TLS Configurations</a><ul>
<li><a href="#131-command-line-tools">13.1 Command-Line Tools</a></li>
<li><a href="#132-python-tls-scanner">13.2 Python TLS Scanner</a></li>
<li><a href="#133-continuous-certificate-monitoring">13.3 Continuous Certificate Monitoring</a></li>
</ul>
</li>
<li><a href="#14-exercises">14. Exercises</a><ul>
<li><a href="#exercise-1-tls-handshake-trace-beginner">Exercise 1: TLS Handshake Trace (Beginner)</a></li>
<li><a href="#exercise-2-certificate-generation-lab-intermediate">Exercise 2: Certificate Generation Lab (Intermediate)</a></li>
<li><a href="#exercise-3-mtls-service-intermediate">Exercise 3: mTLS Service (Intermediate)</a></li>
<li><a href="#exercise-4-tls-configuration-auditor-advanced">Exercise 4: TLS Configuration Auditor (Advanced)</a></li>
<li><a href="#exercise-5-certificate-monitoring-system-advanced">Exercise 5: Certificate Monitoring System (Advanced)</a></li>
<li><a href="#exercise-6-implement-simplified-tls-educational">Exercise 6: Implement Simplified TLS (Educational)</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="tlsssl-and-public-key-infrastructure">TLS/SSL and Public Key Infrastructure<a class="header-link" href="#tlsssl-and-public-key-infrastructure" title="Permanent link">&para;</a></h1>
<p><strong>Previous</strong>: <a href="./03_Hashing_and_Integrity.md">03. Hashing and Data Integrity</a> | <strong>Next</strong>: <a href="./05_Authentication.md">05. Authentication Systems</a></p>
<hr />
<p>Transport Layer Security (TLS) is the protocol that makes HTTPS possible. It secures virtually all web traffic, email, messaging, VPN, and API communication. This lesson provides a deep technical walkthrough of TLS 1.3, the certificate trust model (PKI), practical OpenSSL and Python usage, mutual TLS, and common misconfigurations that undermine security.</p>
<p><strong>Difficulty</strong>: â­â­â­â­</p>
<p><strong>Learning Objectives</strong>:
- Understand the complete TLS 1.3 handshake step by step
- Explain certificate chains and the web of trust
- Work with X.509 certificates using OpenSSL and Python
- Understand Certificate Authorities and certificate issuance
- Configure Let's Encrypt with the ACME protocol
- Implement certificate pinning and mutual TLS (mTLS)
- Create self-signed certificates for development
- Identify and fix common TLS misconfigurations
- Test TLS configurations using standard tools</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-tls-overview-and-history">TLS Overview and History</a></li>
<li><a href="#2-tls-13-handshake-in-detail">TLS 1.3 Handshake in Detail</a></li>
<li><a href="#3-cipher-suites">Cipher Suites</a></li>
<li><a href="#4-x509-certificates">X.509 Certificates</a></li>
<li><a href="#5-certificate-chains-and-trust">Certificate Chains and Trust</a></li>
<li><a href="#6-certificate-authorities-ca">Certificate Authorities (CA)</a></li>
<li><a href="#7-lets-encrypt-and-acme">Let's Encrypt and ACME</a></li>
<li><a href="#8-certificate-pinning">Certificate Pinning</a></li>
<li><a href="#9-mutual-tls-mtls">Mutual TLS (mTLS)</a></li>
<li><a href="#10-python-tls-programming">Python TLS Programming</a></li>
<li><a href="#11-creating-certificates-with-openssl">Creating Certificates with OpenSSL</a></li>
<li><a href="#12-common-misconfigurations">Common Misconfigurations</a></li>
<li><a href="#13-testing-tls-configurations">Testing TLS Configurations</a></li>
<li><a href="#14-exercises">Exercises</a></li>
<li><a href="#15-references">References</a></li>
</ol>
<hr />
<h2 id="1-tls-overview-and-history">1. TLS Overview and History<a class="header-link" href="#1-tls-overview-and-history" title="Permanent link">&para;</a></h2>
<h3 id="11-protocol-evolution">1.1 Protocol Evolution<a class="header-link" href="#11-protocol-evolution" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span>                  <span class="n">TLS</span><span class="o">/</span><span class="n">SSL</span> <span class="n">Version</span> <span class="n">History</span>                              <span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span> <span class="n">Protocol</span> <span class="err">â”‚</span> <span class="n">Year</span> <span class="err">â”‚</span> <span class="n">Status</span>    <span class="err">â”‚</span> <span class="n">Notes</span>                                  <span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span> <span class="n">SSL</span> <span class="mf">1.0</span>  <span class="err">â”‚</span> <span class="mi">1994</span> <span class="err">â”‚</span> <span class="n">NEVER</span> <span class="n">REL</span><span class="p">.</span><span class="err">â”‚</span> <span class="n">Never</span> <span class="n">released</span> <span class="p">(</span><span class="n">serious</span> <span class="n">flaws</span><span class="p">)</span>        <span class="err">â”‚</span>
<span class="err">â”‚</span> <span class="n">SSL</span> <span class="mf">2.0</span>  <span class="err">â”‚</span> <span class="mi">1995</span> <span class="err">â”‚</span> <span class="n">DEPRECATED</span><span class="err">â”‚</span> <span class="n">Completely</span> <span class="n">broken</span><span class="p">,</span> <span class="n">disable</span> <span class="n">everywhere</span> <span class="err">â”‚</span>
<span class="err">â”‚</span> <span class="n">SSL</span> <span class="mf">3.0</span>  <span class="err">â”‚</span> <span class="mi">1996</span> <span class="err">â”‚</span> <span class="n">DEPRECATED</span><span class="err">â”‚</span> <span class="n">POODLE</span> <span class="n">attack</span> <span class="p">(</span><span class="mi">2014</span><span class="p">),</span> <span class="n">broken</span>          <span class="err">â”‚</span>
<span class="err">â”‚</span> <span class="n">TLS</span> <span class="mf">1.0</span>  <span class="err">â”‚</span> <span class="mi">1999</span> <span class="err">â”‚</span> <span class="n">DEPRECATED</span><span class="err">â”‚</span> <span class="n">BEAST</span> <span class="n">attack</span> <span class="p">(</span><span class="mi">2011</span><span class="p">),</span> <span class="n">end</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">life</span> <span class="mi">2020</span><span class="err">â”‚</span>
<span class="err">â”‚</span> <span class="n">TLS</span> <span class="mf">1.1</span>  <span class="err">â”‚</span> <span class="mi">2006</span> <span class="err">â”‚</span> <span class="n">DEPRECATED</span><span class="err">â”‚</span> <span class="n">No</span> <span class="n">known</span> <span class="n">attacks</span><span class="p">,</span> <span class="n">but</span> <span class="n">weak</span> <span class="n">ciphers</span>   <span class="err">â”‚</span>
<span class="err">â”‚</span> <span class="n">TLS</span> <span class="mf">1.2</span>  <span class="err">â”‚</span> <span class="mi">2008</span> <span class="err">â”‚</span> <span class="n">SUPPORTED</span> <span class="err">â”‚</span> <span class="n">Still</span> <span class="n">widely</span> <span class="n">used</span><span class="p">,</span> <span class="n">secure</span> <span class="n">when</span>       <span class="err">â”‚</span>
<span class="err">â”‚</span>          <span class="err">â”‚</span>      <span class="err">â”‚</span>           <span class="err">â”‚</span> <span class="n">properly</span> <span class="n">configured</span>                   <span class="err">â”‚</span>
<span class="err">â”‚</span> <span class="n">TLS</span> <span class="mf">1.3</span>  <span class="err">â”‚</span> <span class="mi">2018</span> <span class="err">â”‚</span> <span class="n">PREFERRED</span> <span class="err">â”‚</span> <span class="n">Major</span> <span class="n">redesign</span><span class="p">:</span> <span class="n">faster</span><span class="p">,</span> <span class="n">more</span> <span class="n">secure</span>  <span class="err">â”‚</span>
<span class="err">â”‚</span>          <span class="err">â”‚</span>      <span class="err">â”‚</span>           <span class="err">â”‚</span> <span class="n">Removed</span> <span class="n">all</span> <span class="n">weak</span> <span class="n">algorithms</span>           <span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span>                                                                      <span class="err">â”‚</span>
<span class="err">â”‚</span> <span class="n">CURRENT</span> <span class="n">RECOMMENDATION</span> <span class="p">(</span><span class="mi">2025</span><span class="o">+</span><span class="p">):</span>                                     <span class="err">â”‚</span>
<span class="err">â”‚</span> <span class="err">â€¢</span> <span class="n">Enable</span> <span class="n">TLS</span> <span class="mf">1.3</span> <span class="p">(</span><span class="n">preferred</span><span class="p">)</span> <span class="n">and</span> <span class="n">TLS</span> <span class="mf">1.2</span> <span class="p">(</span><span class="n">fallback</span><span class="p">)</span>               <span class="err">â”‚</span>
<span class="err">â”‚</span> <span class="err">â€¢</span> <span class="n">Disable</span> <span class="n">everything</span> <span class="n">below</span> <span class="n">TLS</span> <span class="mf">1.2</span>                                  <span class="err">â”‚</span>
<span class="err">â”‚</span> <span class="err">â€¢</span> <span class="n">Use</span> <span class="n">only</span> <span class="n">strong</span> <span class="n">cipher</span> <span class="n">suites</span>                                     <span class="err">â”‚</span>
<span class="err">â”‚</span>                                                                      <span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="12-where-tls-sits-in-the-stack">1.2 Where TLS Sits in the Stack<a class="header-link" href="#12-where-tls-sits-in-the-stack" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Protocol Stack with TLS                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Application Layer                                           â”‚    â”‚
â”‚  â”‚  HTTP, SMTP, IMAP, FTP, MQTT, gRPC, WebSocket              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                               â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  TLS (Transport Layer Security)                              â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚  Handshake  â”‚  â”‚ Record       â”‚  â”‚  Alert          â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  Protocol   â”‚  â”‚ Protocol     â”‚  â”‚  Protocol       â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                               â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Transport Layer (TCP)                                       â”‚    â”‚
â”‚  â”‚  Port 443 (HTTPS), 465 (SMTPS), 993 (IMAPS), etc.          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                               â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Internet Layer (IP)                                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="13-what-tls-provides">1.3 What TLS Provides<a class="header-link" href="#13-what-tls-provides" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                    </span><span class="nv">TLS</span><span class="w"> </span><span class="nv">Security</span><span class="w"> </span><span class="nv">Properties</span><span class="w">                           </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">1</span>.<span class="w"> </span><span class="nv">CONFIDENTIALITY</span><span class="w">                                                 </span>â”‚
â”‚<span class="w">     </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Data</span><span class="w"> </span><span class="nv">encrypted</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">transit</span><span class="w"> </span><span class="ss">(</span><span class="nv">AES</span><span class="o">-</span><span class="nv">GCM</span>,<span class="w"> </span><span class="nv">ChaCha20</span><span class="o">-</span><span class="nv">Poly1305</span><span class="ss">)</span><span class="w">     </span>â”‚
â”‚<span class="w">     </span>â””â”€â”€<span class="w"> </span><span class="nv">Eavesdroppers</span><span class="w"> </span><span class="nv">see</span><span class="w"> </span><span class="nv">only</span><span class="w"> </span><span class="nv">encrypted</span><span class="w"> </span><span class="nv">gibberish</span><span class="w">                  </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">2</span>.<span class="w"> </span><span class="nv">INTEGRITY</span><span class="w">                                                       </span>â”‚
â”‚<span class="w">     </span>â”œâ”€â”€<span class="w"> </span><span class="nv">AEAD</span><span class="w"> </span><span class="nv">ciphers</span><span class="w"> </span><span class="nv">authenticate</span><span class="w"> </span><span class="nv">every</span><span class="w"> </span><span class="nv">record</span><span class="w">                      </span>â”‚
â”‚<span class="w">     </span>â””â”€â”€<span class="w"> </span><span class="nv">Any</span><span class="w"> </span><span class="nv">tampering</span><span class="w"> </span><span class="nv">detected</span><span class="w"> </span><span class="nv">immediately</span><span class="w">                          </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">3</span>.<span class="w"> </span><span class="nv">AUTHENTICATION</span><span class="w">                                                  </span>â”‚
â”‚<span class="w">     </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Server</span><span class="w"> </span><span class="nv">proves</span><span class="w"> </span><span class="nv">identity</span><span class="w"> </span><span class="nv">via</span><span class="w"> </span><span class="nv">X</span>.<span class="mi">509</span><span class="w"> </span><span class="nv">certificate</span><span class="w">                </span>â”‚
â”‚<span class="w">     </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Optional</span>:<span class="w"> </span><span class="nv">client</span><span class="w"> </span><span class="nv">authentication</span><span class="w"> </span><span class="ss">(</span><span class="nv">mTLS</span><span class="ss">)</span><span class="w">                      </span>â”‚
â”‚<span class="w">     </span>â””â”€â”€<span class="w"> </span><span class="nv">Prevents</span><span class="w"> </span><span class="nv">man</span><span class="o">-</span><span class="nv">in</span><span class="o">-</span><span class="nv">the</span><span class="o">-</span><span class="nv">middle</span><span class="w"> </span><span class="nv">attacks</span><span class="w">                          </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">4</span>.<span class="w"> </span><span class="nv">FORWARD</span><span class="w"> </span><span class="nv">SECRECY</span><span class="w"> </span><span class="ss">(</span><span class="nv">TLS</span><span class="w"> </span><span class="mi">1</span>.<span class="mi">3</span><span class="w"> </span><span class="nv">mandatory</span><span class="ss">)</span><span class="w">                            </span>â”‚
â”‚<span class="w">     </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Ephemeral</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="nv">exchange</span><span class="w"> </span><span class="ss">(</span><span class="nv">ECDHE</span><span class="ss">)</span><span class="w">                              </span>â”‚
â”‚<span class="w">     </span>â””â”€â”€<span class="w"> </span><span class="nv">Past</span><span class="w"> </span><span class="nv">sessions</span><span class="w"> </span><span class="nv">cannot</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">decrypted</span><span class="w"> </span><span class="nv">even</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">long</span><span class="o">-</span><span class="nv">term</span><span class="w">         </span>â”‚
â”‚<span class="w">         </span><span class="nv">private</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">later</span><span class="w"> </span><span class="nv">compromised</span><span class="w">                            </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="2-tls-13-handshake-in-detail">2. TLS 1.3 Handshake in Detail<a class="header-link" href="#2-tls-13-handshake-in-detail" title="Permanent link">&para;</a></h2>
<p>TLS 1.3 dramatically simplified the handshake compared to TLS 1.2, reducing it from 2 round trips to 1 (or 0 with 0-RTT).</p>
<h3 id="21-full-handshake-1-rtt">2.1 Full Handshake (1-RTT)<a class="header-link" href="#21-full-handshake-1-rtt" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TLS 1.3 Full Handshake (1-RTT)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚   Client                                          Server             â”‚
â”‚   â”€â”€â”€â”€â”€â”€                                          â”€â”€â”€â”€â”€â”€             â”‚
â”‚                                                                      â”‚
â”‚   â”Œâ”€ ClientHello â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶                   â”‚
â”‚   â”‚  â€¢ Supported TLS versions (1.3)                                 â”‚
â”‚   â”‚  â€¢ Cipher suites (e.g., TLS_AES_256_GCM_SHA384)               â”‚
â”‚   â”‚  â€¢ Key shares (X25519 public key)  â†â”€â”€ NEW in 1.3             â”‚
â”‚   â”‚  â€¢ Supported groups (X25519, P-256)                            â”‚
â”‚   â”‚  â€¢ Signature algorithms (Ed25519, ECDSA-P256-SHA256)           â”‚
â”‚   â”‚  â€¢ Random (32 bytes)                                           â”‚
â”‚   â”‚  â€¢ SNI (Server Name Indication)                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚                                                                      â”‚
â”‚           â”Œâ”€ ServerHello â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚
â”‚           â”‚  â€¢ Selected TLS version (1.3)                           â”‚
â”‚           â”‚  â€¢ Selected cipher suite                                â”‚
â”‚           â”‚  â€¢ Server key share (X25519 public key)                 â”‚
â”‚           â”‚  â€¢ Random (32 bytes)                                    â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚                                                                      â”‚
â”‚           â”Œâ”€ {EncryptedExtensions} â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (encrypted)   â”‚
â”‚           â”‚  â€¢ Server extensions                                    â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚                                                                      â”‚
â”‚           â”Œâ”€ {Certificate} â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (encrypted)   â”‚
â”‚           â”‚  â€¢ Server&#39;s X.509 certificate chain                    â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚                                                                      â”‚
â”‚           â”Œâ”€ {CertificateVerify} â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (encrypted)   â”‚
â”‚           â”‚  â€¢ Digital signature over handshake transcript          â”‚
â”‚           â”‚  â€¢ Proves server owns the private key                  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚                                                                      â”‚
â”‚           â”Œâ”€ {Finished} â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (encrypted)  â”‚
â”‚           â”‚  â€¢ MAC over entire handshake transcript                â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚                                                                      â”‚
â”‚   â”Œâ”€ {Finished} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ (encrypted)    â”‚
â”‚   â”‚  â€¢ Client&#39;s MAC over handshake transcript                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚                                                                      â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                â”‚
â”‚   Application Data flows in both directions (encrypted)             â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                â”‚
â”‚                                                                      â”‚
â”‚   Key insight: In TLS 1.3, the key exchange happens in the FIRST   â”‚
â”‚   message (ClientHello includes key shares), so all subsequent      â”‚
â”‚   messages after ServerHello are encrypted.                         â”‚
â”‚                                                                      â”‚
â”‚   Compare to TLS 1.2: 2-RTT handshake, certificate sent in        â”‚
â”‚   plaintext, no mandatory forward secrecy.                          â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="22-key-derivation-in-tls-13">2.2 Key Derivation in TLS 1.3<a class="header-link" href="#22-key-derivation-in-tls-13" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="nx">TLS</span><span class="w"> </span><span class="m m-Double">1.3</span><span class="w"> </span><span class="nx">Key</span><span class="w"> </span><span class="nx">Schedule</span><span class="w"> </span><span class="p">(</span><span class="nx">Simplified</span><span class="p">)</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">ECDHE</span><span class="w"> </span><span class="nx">shared</span><span class="w"> </span><span class="nx">secret</span><span class="w"> </span><span class="p">(</span><span class="nx">from</span><span class="w"> </span><span class="nx">X25519</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="nx">exchange</span><span class="p">)</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span><span class="w">                                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">            </span><span class="err">â–¼</span><span class="w">                                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">HKDF</span><span class="o">-</span><span class="nx">Extract</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â†</span><span class="w"> </span><span class="nx">IKM</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ECDHE</span><span class="w"> </span><span class="nx">shared</span><span class="w"> </span><span class="nx">secret</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="nx">Early</span><span class="w"> </span><span class="nx">Secret</span><span class="p">)</span><span class="w"> </span><span class="err">â”‚</span><span class="w">    </span><span class="nx">Salt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â–¼</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">HKDF</span><span class="o">-</span><span class="nx">Extract</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â†</span><span class="w"> </span><span class="nx">IKM</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ECDHE</span><span class="w"> </span><span class="nx">shared</span><span class="w"> </span><span class="nx">secret</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="p">(</span><span class="nx">Handshake</span><span class="w"> </span><span class="nx">Secret</span><span class="p">)</span><span class="err">â”‚</span><span class="w">   </span><span class="nx">Salt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">derived</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">early</span><span class="w"> </span><span class="nx">secret</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="err">â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”</span><span class="w">                                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span><span class="w">         </span><span class="err">â”‚</span><span class="w">                                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="err">â–¼</span><span class="w">         </span><span class="err">â–¼</span><span class="w">                                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="nx">Client</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="nx">Server</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â†</span><span class="w"> </span><span class="nx">HKDF</span><span class="o">-</span><span class="nx">Expand</span><span class="o">-</span><span class="nx">Label</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="nx">Handshk</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="nx">Handshk</span><span class="w"> </span><span class="err">â”‚</span><span class="w">   </span><span class="p">(</span><span class="nx">derive</span><span class="w"> </span><span class="nx">traffic</span><span class="w"> </span><span class="nx">keys</span><span class="w"> </span><span class="nx">from</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="nx">Traffic</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="nx">Traffic</span><span class="w"> </span><span class="err">â”‚</span><span class="w">    </span><span class="nx">handshake</span><span class="w"> </span><span class="nx">secret</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">transcript</span><span class="w"> </span><span class="nx">hash</span><span class="p">)</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="nx">Key</span><span class="o">/</span><span class="nx">IV</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="nx">Key</span><span class="o">/</span><span class="nx">IV</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â–¼</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">HKDF</span><span class="o">-</span><span class="nx">Extract</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â†</span><span class="w"> </span><span class="nx">IKM</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="nx">Master</span><span class="w"> </span><span class="nx">Secret</span><span class="p">)</span><span class="w"> </span><span class="err">â”‚</span><span class="w">    </span><span class="nx">Salt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">derived</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">handshake</span><span class="w"> </span><span class="nx">secret</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="err">â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”</span><span class="w">                                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span><span class="w">         </span><span class="err">â”‚</span><span class="w">                                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="err">â–¼</span><span class="w">         </span><span class="err">â–¼</span><span class="w">                                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="nx">Client</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="nx">Server</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â†</span><span class="w"> </span><span class="nx">HKDF</span><span class="o">-</span><span class="nx">Expand</span><span class="o">-</span><span class="nx">Label</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="nx">App</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="nx">App</span><span class="w">     </span><span class="err">â”‚</span><span class="w">   </span><span class="p">(</span><span class="nx">derive</span><span class="w"> </span><span class="nx">application</span><span class="w"> </span><span class="nx">traffic</span><span class="w"> </span><span class="nx">keys</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="nx">Traffic</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="nx">Traffic</span><span class="w"> </span><span class="err">â”‚</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="nx">Key</span><span class="o">/</span><span class="nx">IV</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="nx">Key</span><span class="o">/</span><span class="nx">IV</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Each</span><span class="w"> </span><span class="nx">direction</span><span class="w"> </span><span class="nx">gets</span><span class="w"> </span><span class="nx">its</span><span class="w"> </span><span class="nx">OWN</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">IV</span><span class="p">.</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Keys</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">derived</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">shared</span><span class="w"> </span><span class="nx">secret</span><span class="w"> </span><span class="nx">AND</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">handshake</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">transcript</span><span class="p">,</span><span class="w"> </span><span class="nx">binding</span><span class="w"> </span><span class="nx">them</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">specific</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="23-tls-13-vs-tls-12">2.3 TLS 1.3 vs TLS 1.2<a class="header-link" href="#23-tls-13-vs-tls-12" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="nx">TLS</span><span class="w"> </span><span class="m m-Double">1.3</span><span class="w"> </span><span class="nx">vs</span><span class="w"> </span><span class="nx">TLS</span><span class="w"> </span><span class="m m-Double">1.2</span><span class="w"> </span><span class="nx">Improvements</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Feature</span><span class="w">             </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">TLS</span><span class="w"> </span><span class="m m-Double">1.2</span><span class="w">             </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">TLS</span><span class="w"> </span><span class="m m-Double">1.3</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Handshake</span><span class="w"> </span><span class="nx">RTT</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nx">round</span><span class="w"> </span><span class="nx">trips</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nx">round</span><span class="w"> </span><span class="nx">trip</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="nx">RTT</span><span class="w"> </span><span class="nx">resumption</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">No</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Yes</span><span class="w"> </span><span class="p">(</span><span class="nx">optional</span><span class="p">)</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Forward</span><span class="w"> </span><span class="nx">secrecy</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Optional</span><span class="w"> </span><span class="p">(</span><span class="nx">ECDHE</span><span class="p">)</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Mandatory</span><span class="w"> </span><span class="p">(</span><span class="nx">always</span><span class="p">)</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">RSA</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="nx">exchange</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Supported</span><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Removed</span><span class="w"> </span><span class="p">(</span><span class="nx">no</span><span class="w"> </span><span class="nx">FS</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Static</span><span class="w"> </span><span class="nx">DH</span><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Supported</span><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Removed</span><span class="w"> </span><span class="p">(</span><span class="nx">no</span><span class="w"> </span><span class="nx">FS</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">CBC</span><span class="w"> </span><span class="nx">mode</span><span class="w"> </span><span class="nx">ciphers</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Supported</span><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Removed</span><span class="w"> </span><span class="p">(</span><span class="nx">padding</span><span class="w"> </span><span class="nx">oracle</span><span class="p">)</span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">RC4</span><span class="w">                 </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Supported</span><span class="w"> </span><span class="p">(</span><span class="nx">weak</span><span class="p">)</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Removed</span><span class="w"> </span><span class="p">(</span><span class="nx">broken</span><span class="p">)</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Compression</span><span class="w">         </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Supported</span><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Removed</span><span class="w"> </span><span class="p">(</span><span class="nx">CRIME</span><span class="w"> </span><span class="nx">attack</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Renegotiation</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Supported</span><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Removed</span><span class="w"> </span><span class="p">(</span><span class="nx">complexity</span><span class="p">)</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Encrypt</span><span class="w"> </span><span class="nx">cert</span><span class="p">?</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">No</span><span class="w"> </span><span class="p">(</span><span class="nx">plaintext</span><span class="p">)</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Yes</span><span class="w"> </span><span class="p">(</span><span class="nx">encrypted</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Cipher</span><span class="w"> </span><span class="nx">suites</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">300</span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">many</span><span class="w"> </span><span class="nx">weak</span><span class="p">)</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">(</span><span class="nx">all</span><span class="w"> </span><span class="nx">strong</span><span class="p">)</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Change</span><span class="w"> </span><span class="nx">Cipher</span><span class="w"> </span><span class="nx">Spec</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Separate</span><span class="w"> </span><span class="nx">message</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Removed</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">Key</span><span class="w"> </span><span class="nx">derivation</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">PRF</span><span class="w"> </span><span class="p">(</span><span class="nx">TLS</span><span class="w"> </span><span class="m m-Double">1.2</span><span class="w"> </span><span class="nx">PRF</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">HKDF</span><span class="w"> </span><span class="p">(</span><span class="nx">stronger</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="nx">TLS</span><span class="w"> </span><span class="m m-Double">1.3</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">simpler</span><span class="p">,</span><span class="w"> </span><span class="nx">faster</span><span class="p">,</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">no</span><span class="w"> </span><span class="nx">known</span><span class="w"> </span><span class="nx">weak</span><span class="w"> </span><span class="nx">configurations</span><span class="p">.</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="24-0-rtt-zero-round-trip-time-resumption">2.4 0-RTT (Zero Round Trip Time) Resumption<a class="header-link" href="#24-0-rtt-zero-round-trip-time-resumption" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                 </span><span class="nx">TLS</span><span class="w"> </span><span class="m m-Double">1.3</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="nx">RTT</span><span class="w"> </span><span class="nx">Resumption</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">After</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">full</span><span class="w"> </span><span class="nx">handshake</span><span class="p">,</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="nx">sends</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="nx">ticket</span><span class="p">.</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">On</span><span class="w"> </span><span class="nx">reconnection</span><span class="p">,</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">send</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="nx">immediately</span><span class="p">:</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="nx">Client</span><span class="w">                                          </span><span class="nx">Server</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”€â”€â”€â”€â”€â”€</span><span class="w">                                          </span><span class="err">â”€â”€â”€â”€â”€â”€</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”Œâ”€</span><span class="w"> </span><span class="nx">ClientHello</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">EarlyData</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">Session</span><span class="w"> </span><span class="nx">ticket</span><span class="w"> </span><span class="p">(</span><span class="nx">from</span><span class="w"> </span><span class="nx">previous</span><span class="w"> </span><span class="nx">connection</span><span class="p">)</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="nx">RTT</span><span class="w"> </span><span class="nx">application</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">(</span><span class="nx">encrypted</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">PSK</span><span class="p">)</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">âš </span><span class="w"> </span><span class="nx">WARNING</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="nx">RTT</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">NOT</span><span class="w"> </span><span class="nx">replay</span><span class="o">-</span><span class="nx">safe</span><span class="p">!</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="nx">An</span><span class="w"> </span><span class="nx">attacker</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">replay</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">ClientHello</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">EarlyData</span><span class="p">.</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="nx">Rules</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="nx">RTT</span><span class="p">:</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">ONLY</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">idempotent</span><span class="w"> </span><span class="nx">requests</span><span class="w"> </span><span class="p">(</span><span class="nx">GET</span><span class="p">,</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">POST</span><span class="p">)</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">Server</span><span class="w"> </span><span class="nx">must</span><span class="w"> </span><span class="nx">implement</span><span class="w"> </span><span class="nx">replay</span><span class="w"> </span><span class="nx">protection</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">Limit</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="nx">RTT</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="nx">size</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">Many</span><span class="w"> </span><span class="nx">deployments</span><span class="w"> </span><span class="nx">disable</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="nx">RTT</span><span class="w"> </span><span class="nx">entirely</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="3-cipher-suites">3. Cipher Suites<a class="header-link" href="#3-cipher-suites" title="Permanent link">&para;</a></h2>
<h3 id="31-tls-13-cipher-suites">3.1 TLS 1.3 Cipher Suites<a class="header-link" href="#31-tls-13-cipher-suites" title="Permanent link">&para;</a></h3>
<p>TLS 1.3 has only 5 cipher suites, all of which are AEAD:</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="n">TLS</span><span class="w"> </span><span class="mf">1.3</span><span class="w"> </span><span class="n">Cipher</span><span class="w"> </span><span class="n">Suites</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Cipher</span><span class="w"> </span><span class="n">Suite</span><span class="w">                            </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Notes</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">TLS_AES_256_GCM_SHA384</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Strong</span><span class="p">,</span><span class="w"> </span><span class="n">widely</span><span class="w"> </span><span class="n">supported</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">TLS_AES_128_GCM_SHA256</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Default</span><span class="p">,</span><span class="w"> </span><span class="n">very</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="n">w</span><span class="o">/</span><span class="w"> </span><span class="n">HW</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">TLS_CHACHA20_POLY1305_SHA256</span><span class="w">            </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Best</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">mobile</span><span class="o">/</span><span class="n">no</span><span class="w"> </span><span class="n">AES</span><span class="o">-</span><span class="n">NI</span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">TLS_AES_128_CCM_SHA256</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">constrained</span><span class="w"> </span><span class="n">devices</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">TLS_AES_128_CCM_8_SHA256</span><span class="w">                </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Short</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">IoT</span><span class="w"> </span><span class="n">only</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="mf">1.3</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="n">suite</span><span class="w"> </span><span class="n">ONLY</span><span class="w"> </span><span class="n">specifies</span><span class="p">:</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">AEAD</span><span class="w"> </span><span class="n">algorithm</span><span class="w"> </span><span class="p">(</span><span class="n">AES</span><span class="o">-</span><span class="n">GCM</span><span class="p">,</span><span class="w"> </span><span class="n">ChaCha20</span><span class="o">-</span><span class="n">Poly1305</span><span class="p">,</span><span class="w"> </span><span class="n">AES</span><span class="o">-</span><span class="n">CCM</span><span class="p">)</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Hash</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">HKDF</span><span class="w"> </span><span class="p">(</span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">384</span><span class="p">)</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Key</span><span class="w"> </span><span class="n">exchange</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="n">algorithms</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">negotiated</span><span class="w"> </span><span class="n">separately</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">extensions</span><span class="w"> </span><span class="p">(</span><span class="n">supported_groups</span><span class="p">,</span><span class="w"> </span><span class="n">signature_algorithms</span><span class="p">)</span><span class="o">.</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Recommended</span><span class="w"> </span><span class="n">priority</span><span class="p">:</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">TLS_AES_256_GCM_SHA384</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">TLS_CHACHA20_POLY1305_SHA256</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="n">TLS_AES_128_GCM_SHA256</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="32-understanding-tls-12-cipher-suite-names">3.2 Understanding TLS 1.2 Cipher Suite Names<a class="header-link" href="#32-understanding-tls-12-cipher-suite-names" title="Permanent link">&para;</a></h3>
<p>For legacy compatibility, understanding TLS 1.2 cipher suite naming is important:</p>
<div class="highlight"><pre><span></span><code>TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
â”‚    â”‚      â”‚        â”‚   â”‚    â”‚    â”‚
â”‚    â”‚      â”‚        â”‚   â”‚    â”‚    â””â”€â”€ PRF hash (SHA-384)
â”‚    â”‚      â”‚        â”‚   â”‚    â””â”€â”€â”€â”€â”€â”€â”€ AEAD mode (GCM)
â”‚    â”‚      â”‚        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Key size (256-bit)
â”‚    â”‚      â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Encryption (AES)
â”‚    â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Authentication (RSA cert)
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Key Exchange (ECDHE = forward secrecy)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Protocol (TLS)

GOOD TLS 1.2 cipher suites (all have ECDHE for forward secrecy):
  TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
  TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
  TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256
  TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256
  TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256

BAD TLS 1.2 cipher suites (disable these):
  TLS_RSA_WITH_AES_256_CBC_SHA256        (no forward secrecy, CBC)
  TLS_RSA_WITH_3DES_EDE_CBC_SHA          (no FS, 3DES, CBC)
  TLS_RSA_WITH_RC4_128_SHA               (no FS, RC4 broken)
  TLS_DHE_RSA_WITH_AES_256_CBC_SHA       (CBC, weak DH possible)
</code></pre></div>

<hr />
<h2 id="4-x509-certificates">4. X.509 Certificates<a class="header-link" href="#4-x509-certificates" title="Permanent link">&para;</a></h2>
<p>An X.509 certificate binds a public key to an identity (domain name, organization). It is the foundation of TLS authentication.</p>
<h3 id="41-certificate-structure">4.1 Certificate Structure<a class="header-link" href="#41-certificate-structure" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                    </span><span class="nv">X</span>.<span class="mi">509</span><span class="w"> </span><span class="nv">v3</span><span class="w"> </span><span class="nv">Certificate</span><span class="w"> </span><span class="nv">Structure</span><span class="w">                     </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">tbsCertificate</span><span class="w"> </span><span class="ss">(</span><span class="nv">To</span><span class="w"> </span><span class="nv">Be</span><span class="w"> </span><span class="nv">Signed</span><span class="ss">)</span>:<span class="w">                                     </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Version</span>:<span class="w"> </span><span class="nv">v3</span><span class="w"> </span><span class="ss">(</span><span class="nv">most</span><span class="w"> </span><span class="nv">common</span><span class="ss">)</span><span class="w">                                      </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Serial</span><span class="w"> </span><span class="nv">Number</span>:<span class="w"> </span><span class="nv">unique</span><span class="w"> </span><span class="nv">identifier</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">CA</span><span class="w">                       </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Signature</span><span class="w"> </span><span class="nv">Algorithm</span>:<span class="w"> </span><span class="nv">e</span>.<span class="nv">g</span>.,<span class="w"> </span><span class="nv">SHA256withRSA</span>,<span class="w"> </span><span class="nv">Ed25519</span><span class="w">              </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Issuer</span>:<span class="w"> </span><span class="nv">DN</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">CA</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">signed</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">cert</span><span class="w">                     </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">   </span>â””â”€â”€<span class="w"> </span><span class="nv">CN</span><span class="o">=</span><span class="nv">Let</span><span class="s1">&#39;s Encrypt Authority X3, O=Let&#39;</span><span class="nv">s</span><span class="w"> </span><span class="nv">Encrypt</span>,<span class="w"> </span><span class="nv">C</span><span class="o">=</span><span class="nv">US</span><span class="w">     </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Validity</span>:<span class="w">                                                      </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">   </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Not</span><span class="w"> </span><span class="nv">Before</span>:<span class="w"> </span><span class="mi">2026</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span>:<span class="mi">00</span>:<span class="mi">00</span><span class="w"> </span><span class="nv">UTC</span><span class="w">                      </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">   </span>â””â”€â”€<span class="w"> </span><span class="nv">Not</span><span class="w"> </span><span class="nv">After</span>:<span class="w">  </span><span class="mi">2026</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span><span class="w"> </span><span class="mi">23</span>:<span class="mi">59</span>:<span class="mi">59</span><span class="w"> </span><span class="nv">UTC</span><span class="w">                      </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Subject</span>:<span class="w"> </span><span class="nv">DN</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">certificate</span><span class="w"> </span><span class="nv">holder</span><span class="w">                          </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">   </span>â””â”€â”€<span class="w"> </span><span class="nv">CN</span><span class="o">=</span><span class="nv">www</span>.<span class="nv">example</span>.<span class="nv">com</span><span class="w">                                        </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Subject</span><span class="w"> </span><span class="nv">Public</span><span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">Info</span>:<span class="w">                                       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">   </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Algorithm</span>:<span class="w"> </span><span class="nv">RSA</span><span class="w"> </span><span class="ss">(</span><span class="mi">2048</span><span class="o">-</span><span class="nv">bit</span><span class="ss">)</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">ECDSA</span><span class="w"> </span><span class="ss">(</span><span class="nv">P</span><span class="o">-</span><span class="mi">256</span><span class="ss">)</span><span class="w">               </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">   </span>â””â”€â”€<span class="w"> </span><span class="nv">Public</span><span class="w"> </span><span class="nv">Key</span>:<span class="w"> </span>[<span class="nv">actual</span><span class="w"> </span><span class="nv">public</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="nv">bytes</span>]<span class="w">                     </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€<span class="w"> </span><span class="nv">Extensions</span><span class="w"> </span><span class="ss">(</span><span class="nv">v3</span><span class="ss">)</span>:<span class="w">                                               </span>â”‚
â”‚<span class="w">      </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Subject</span><span class="w"> </span><span class="nv">Alternative</span><span class="w"> </span><span class="nv">Names</span><span class="w"> </span><span class="ss">(</span><span class="nv">SAN</span><span class="ss">)</span>:<span class="w">                           </span>â”‚
â”‚<span class="w">      </span>â”‚<span class="w">   </span>â”œâ”€â”€<span class="w"> </span><span class="nv">DNS</span>:<span class="w"> </span><span class="nv">example</span>.<span class="nv">com</span><span class="w">                                      </span>â”‚
â”‚<span class="w">      </span>â”‚<span class="w">   </span>â”œâ”€â”€<span class="w"> </span><span class="nv">DNS</span>:<span class="w"> </span><span class="nv">www</span>.<span class="nv">example</span>.<span class="nv">com</span><span class="w">                                  </span>â”‚
â”‚<span class="w">      </span>â”‚<span class="w">   </span>â””â”€â”€<span class="w"> </span><span class="nv">DNS</span>:<span class="w"> </span><span class="nv">api</span>.<span class="nv">example</span>.<span class="nv">com</span><span class="w">                                  </span>â”‚
â”‚<span class="w">      </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">Usage</span>:<span class="w">                                                 </span>â”‚
â”‚<span class="w">      </span>â”‚<span class="w">   </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Digital</span><span class="w"> </span><span class="nv">Signature</span><span class="w">                                     </span>â”‚
â”‚<span class="w">      </span>â”‚<span class="w">   </span>â””â”€â”€<span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">Encipherment</span><span class="w">                                      </span>â”‚
â”‚<span class="w">      </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Extended</span><span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">Usage</span>:<span class="w">                                        </span>â”‚
â”‚<span class="w">      </span>â”‚<span class="w">   </span>â””â”€â”€<span class="w"> </span><span class="nv">TLS</span><span class="w"> </span><span class="nv">Web</span><span class="w"> </span><span class="nv">Server</span><span class="w"> </span><span class="nv">Authentication</span><span class="w">                         </span>â”‚
â”‚<span class="w">      </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Basic</span><span class="w"> </span><span class="nv">Constraints</span>:<span class="w">                                         </span>â”‚
â”‚<span class="w">      </span>â”‚<span class="w">   </span>â””â”€â”€<span class="w"> </span><span class="nv">CA</span>:<span class="w"> </span><span class="nv">FALSE</span><span class="w"> </span><span class="ss">(</span><span class="nv">this</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">leaf</span><span class="o">/</span><span class="k">end</span><span class="o">-</span><span class="nv">entity</span><span class="w"> </span><span class="nv">cert</span><span class="ss">)</span><span class="w">            </span>â”‚
â”‚<span class="w">      </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Authority</span><span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">Identifier</span>:<span class="w"> </span>[<span class="nv">CA</span><span class="err">&#39;s key ID]                   â”‚</span>
<span class="err">â”‚      â”œâ”€â”€ CRL Distribution Points: http://crl.example.com/ca.crl   â”‚</span>
<span class="err">â”‚      â””â”€â”€ Authority Information Access:                              â”‚</span>
<span class="err">â”‚          â”œâ”€â”€ OCSP: http://ocsp.example.com                         â”‚</span>
<span class="err">â”‚          â””â”€â”€ CA Issuers: http://crt.example.com/ca.crt             â”‚</span>
<span class="err">â”‚                                                                      â”‚</span>
<span class="err">â”‚  Signature Algorithm: SHA256withRSA                                  â”‚</span>
â”‚<span class="w">  </span><span class="nv">Signature</span><span class="w"> </span><span class="nv">Value</span>:<span class="w"> </span>[<span class="nv">CA</span><span class="err">&#39;s digital signature over tbsCertificate]      â”‚</span>
<span class="err">â”‚                                                                      â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="42-reading-certificates-in-python">4.2 Reading Certificates in Python<a class="header-link" href="#42-reading-certificates-in-python" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography</span><span class="w"> </span><span class="kn">import</span> <span class="n">x509</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.x509.oid</span><span class="w"> </span><span class="kn">import</span> <span class="n">NameOID</span><span class="p">,</span> <span class="n">ExtensionOID</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">hashes</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_server_certificate</span><span class="p">(</span><span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">443</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve and parse a server&#39;s TLS certificate.&quot;&quot;&quot;</span>
    <span class="c1"># Connect and get certificate in DER format</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssock</span><span class="p">:</span>
            <span class="n">der_cert</span> <span class="o">=</span> <span class="n">ssock</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">(</span><span class="n">binary_form</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x509</span><span class="o">.</span><span class="n">load_der_x509_certificate</span><span class="p">(</span><span class="n">der_cert</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">print_certificate_info</span><span class="p">(</span><span class="n">cert</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display detailed certificate information.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;X.509 CERTIFICATE DETAILS&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

    <span class="c1"># Subject</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Subject:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">cert</span><span class="o">.</span><span class="n">subject</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">attr</span><span class="o">.</span><span class="n">oid</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">attr</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Issuer</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Issuer:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">cert</span><span class="o">.</span><span class="n">issuer</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">attr</span><span class="o">.</span><span class="n">oid</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">attr</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Validity</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Validity:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Not Before: </span><span class="si">{</span><span class="n">cert</span><span class="o">.</span><span class="n">not_valid_before_utc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Not After:  </span><span class="si">{</span><span class="n">cert</span><span class="o">.</span><span class="n">not_valid_after_utc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">days_remaining</span> <span class="o">=</span> <span class="p">(</span><span class="n">cert</span><span class="o">.</span><span class="n">not_valid_after_utc</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;VALID&quot;</span> <span class="k">if</span> <span class="n">cert</span><span class="o">.</span><span class="n">not_valid_before_utc</span> <span class="o">&lt;=</span> <span class="n">now</span> <span class="o">&lt;=</span> <span class="n">cert</span><span class="o">.</span><span class="n">not_valid_after_utc</span> <span class="k">else</span> <span class="s2">&quot;EXPIRED&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Status:     </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">days_remaining</span><span class="si">}</span><span class="s2"> days remaining)&quot;</span><span class="p">)</span>

    <span class="c1"># Serial and Version</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Serial Number: </span><span class="si">{</span><span class="n">cert</span><span class="o">.</span><span class="n">serial_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Version:       v</span><span class="si">{</span><span class="n">cert</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Public Key</span>
    <span class="n">pub_key</span> <span class="o">=</span> <span class="n">cert</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>
    <span class="n">key_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">pub_key</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Public Key:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Algorithm: </span><span class="si">{</span><span class="n">key_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pub_key</span><span class="p">,</span> <span class="s1">&#39;key_size&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Key Size:  </span><span class="si">{</span><span class="n">pub_key</span><span class="o">.</span><span class="n">key_size</span><span class="si">}</span><span class="s2"> bits&quot;</span><span class="p">)</span>

    <span class="c1"># Signature</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Signature Algorithm: </span><span class="si">{</span><span class="n">cert</span><span class="o">.</span><span class="n">signature_algorithm_oid</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Fingerprints</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fingerprints:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SHA-256: </span><span class="si">{</span><span class="n">cert</span><span class="o">.</span><span class="n">fingerprint</span><span class="p">(</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SHA-1:   </span><span class="si">{</span><span class="n">cert</span><span class="o">.</span><span class="n">fingerprint</span><span class="p">(</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA1</span><span class="p">())</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Extensions</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Extensions:&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">san</span> <span class="o">=</span> <span class="n">cert</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">get_extension_for_oid</span><span class="p">(</span><span class="n">ExtensionOID</span><span class="o">.</span><span class="n">SUBJECT_ALTERNATIVE_NAME</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">san</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">get_attributes_for_oid</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">oid</span><span class="o">.</span><span class="n">ExtensionOID</span><span class="o">.</span><span class="n">SUBJECT_ALTERNATIVE_NAME</span><span class="p">)</span>
        <span class="n">dns_names</span> <span class="o">=</span> <span class="n">san</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">get_attributes_for_oid</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">DNSName</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">san</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;get_attributes_for_oid&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="c1"># Alternative approach for SAN</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">san</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SAN: </span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">x509</span><span class="o">.</span><span class="n">ExtensionNotFound</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  No SAN extension&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">basic</span> <span class="o">=</span> <span class="n">cert</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">get_extension_for_oid</span><span class="p">(</span><span class="n">ExtensionOID</span><span class="o">.</span><span class="n">BASIC_CONSTRAINTS</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Basic Constraints: CA=</span><span class="si">{</span><span class="n">basic</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ca</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">x509</span><span class="o">.</span><span class="n">ExtensionNotFound</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="c1"># Example: Inspect a real certificate</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">cert</span> <span class="o">=</span> <span class="n">get_server_certificate</span><span class="p">(</span><span class="s2">&quot;www.google.com&quot;</span><span class="p">)</span>
    <span class="n">print_certificate_info</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not fetch certificate: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(This requires network access)&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="5-certificate-chains-and-trust">5. Certificate Chains and Trust<a class="header-link" href="#5-certificate-chains-and-trust" title="Permanent link">&para;</a></h2>
<h3 id="51-chain-of-trust">5.1 Chain of Trust<a class="header-link" href="#51-chain-of-trust" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="nx">Certificate</span><span class="w"> </span><span class="nx">Chain</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">Trust</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">ROOT</span><span class="w"> </span><span class="nx">CA</span><span class="w"> </span><span class="nx">Certificate</span><span class="w"> </span><span class="p">(</span><span class="k">Self</span><span class="o">-</span><span class="nx">signed</span><span class="p">)</span><span class="w">                        </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Issuer</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Root CA&quot;</span><span class="w">                                    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Subject</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Root CA&quot;</span><span class="w">  </span><span class="p">(</span><span class="nx">Issuer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">Subject</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="kp">self</span><span class="o">-</span><span class="nx">signed</span><span class="p">)</span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Valid</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="o">-</span><span class="mi">30</span><span class="w"> </span><span class="nx">years</span><span class="w">                                   </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Stored</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">OS</span><span class="o">/</span><span class="nx">browser</span><span class="w"> </span><span class="nx">trust</span><span class="w"> </span><span class="nx">store</span><span class="w">                     </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">Signs</span><span class="p">:</span><span class="w"> </span><span class="nx">Intermediate</span><span class="w"> </span><span class="nx">CA</span><span class="w"> </span><span class="nx">certificate</span><span class="w">                   </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">signs</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                           </span><span class="err">â–¼</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">INTERMEDIATE</span><span class="w"> </span><span class="nx">CA</span><span class="w"> </span><span class="nx">Certificate</span><span class="w">                              </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Issuer</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Root CA&quot;</span><span class="w">                                    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Subject</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Intermediate CA&quot;</span><span class="w">                           </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Valid</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="o">-</span><span class="mi">10</span><span class="w"> </span><span class="nx">years</span><span class="w">                                    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Basic</span><span class="w"> </span><span class="nx">Constraints</span><span class="p">:</span><span class="w"> </span><span class="nx">CA</span><span class="p">=</span><span class="nx">TRUE</span><span class="w">                           </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">Signs</span><span class="p">:</span><span class="w"> </span><span class="nx">End</span><span class="o">-</span><span class="nx">entity</span><span class="w"> </span><span class="p">(</span><span class="nx">leaf</span><span class="p">)</span><span class="w"> </span><span class="nx">certificates</span><span class="w">               </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">signs</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                           </span><span class="err">â–¼</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">END</span><span class="o">-</span><span class="nx">ENTITY</span><span class="w"> </span><span class="p">(</span><span class="nx">LEAF</span><span class="p">)</span><span class="w"> </span><span class="nx">Certificate</span><span class="w">                            </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Issuer</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Intermediate CA&quot;</span><span class="w">                            </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Subject</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;www.example.com&quot;</span><span class="w">                           </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Valid</span><span class="p">:</span><span class="w"> </span><span class="mi">90</span><span class="w"> </span><span class="nx">days</span><span class="w"> </span><span class="p">(</span><span class="nx">Let</span><span class="err">&#39;</span><span class="nx">s</span><span class="w"> </span><span class="nx">Encrypt</span><span class="p">)</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nx">year</span><span class="w">             </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Basic</span><span class="w"> </span><span class="nx">Constraints</span><span class="p">:</span><span class="w"> </span><span class="nx">CA</span><span class="p">=</span><span class="nx">FALSE</span><span class="w">                          </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">your</span><span class="w"> </span><span class="nx">server</span><span class="err">&#39;</span><span class="nx">s</span><span class="w"> </span><span class="nx">certificate</span><span class="w">                   </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">VERIFICATION</span><span class="w"> </span><span class="nx">PROCESS</span><span class="p">:</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="nx">Receive</span><span class="w"> </span><span class="nx">leaf</span><span class="w"> </span><span class="nx">cert</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">intermediate</span><span class="w"> </span><span class="nx">cert</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">server</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="nx">Verify</span><span class="w"> </span><span class="nx">leaf</span><span class="w"> </span><span class="nx">cert</span><span class="w"> </span><span class="nx">signature</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">intermediate</span><span class="err">&#39;</span><span class="nx">s</span><span class="w"> </span><span class="nx">public</span><span class="w"> </span><span class="nx">key</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="nx">Verify</span><span class="w"> </span><span class="nx">intermediate</span><span class="w"> </span><span class="nx">cert</span><span class="w"> </span><span class="nx">signature</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">root</span><span class="err">&#39;</span><span class="nx">s</span><span class="w"> </span><span class="nx">public</span><span class="w"> </span><span class="nx">key</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="nx">Check</span><span class="w"> </span><span class="nx">root</span><span class="w"> </span><span class="nx">cert</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">local</span><span class="w"> </span><span class="nx">trust</span><span class="w"> </span><span class="nx">store</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="nx">Check</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nx">certs</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">within</span><span class="w"> </span><span class="nx">validity</span><span class="w"> </span><span class="nx">period</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">6</span><span class="p">.</span><span class="w"> </span><span class="nx">Check</span><span class="w"> </span><span class="nx">revocation</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="p">(</span><span class="nx">CRL</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">OCSP</span><span class="p">)</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">7</span><span class="p">.</span><span class="w"> </span><span class="nx">Check</span><span class="w"> </span><span class="nx">leaf</span><span class="w"> </span><span class="nx">cert</span><span class="err">&#39;</span><span class="nx">s</span><span class="w"> </span><span class="nx">SAN</span><span class="w"> </span><span class="nx">matches</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">requested</span><span class="w"> </span><span class="nx">hostname</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="52-certificate-chain-verification-in-python">5.2 Certificate Chain Verification in Python<a class="header-link" href="#52-certificate-chain-verification-in-python" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography</span><span class="w"> </span><span class="kn">import</span> <span class="n">x509</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric</span><span class="w"> </span><span class="kn">import</span> <span class="n">rsa</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">padding</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">hashes</span><span class="p">,</span> <span class="n">serialization</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.x509.oid</span><span class="w"> </span><span class="kn">import</span> <span class="n">NameOID</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ipaddress</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_ca_certificate</span><span class="p">(</span>
    <span class="n">subject_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">key_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">,</span>
    <span class="n">valid_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3650</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a self-signed CA certificate.&quot;&quot;&quot;</span>
    <span class="c1"># Generate CA key pair</span>
    <span class="n">ca_key</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span>
        <span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span>
        <span class="n">key_size</span><span class="o">=</span><span class="n">key_size</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">subject</span> <span class="o">=</span> <span class="n">issuer</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">Name</span><span class="p">([</span>
        <span class="n">x509</span><span class="o">.</span><span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="o">.</span><span class="n">COUNTRY_NAME</span><span class="p">,</span> <span class="s2">&quot;US&quot;</span><span class="p">),</span>
        <span class="n">x509</span><span class="o">.</span><span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="o">.</span><span class="n">ORGANIZATION_NAME</span><span class="p">,</span> <span class="s2">&quot;Demo CA&quot;</span><span class="p">),</span>
        <span class="n">x509</span><span class="o">.</span><span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="o">.</span><span class="n">COMMON_NAME</span><span class="p">,</span> <span class="n">subject_name</span><span class="p">),</span>
    <span class="p">])</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

    <span class="n">ca_cert</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">x509</span><span class="o">.</span><span class="n">CertificateBuilder</span><span class="p">()</span>
        <span class="o">.</span><span class="n">subject_name</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>
        <span class="o">.</span><span class="n">issuer_name</span><span class="p">(</span><span class="n">issuer</span><span class="p">)</span>
        <span class="o">.</span><span class="n">public_key</span><span class="p">(</span><span class="n">ca_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">())</span>
        <span class="o">.</span><span class="n">serial_number</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">random_serial_number</span><span class="p">())</span>
        <span class="o">.</span><span class="n">not_valid_before</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
        <span class="o">.</span><span class="n">not_valid_after</span><span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">valid_days</span><span class="p">))</span>
        <span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">BasicConstraints</span><span class="p">(</span><span class="n">ca</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">path_length</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">KeyUsage</span><span class="p">(</span>
                <span class="n">digital_signature</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">key_cert_sign</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">crl_sign</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">content_commitment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">key_encipherment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">data_encipherment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">key_agreement</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">encipher_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">decipher_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ca_key</span><span class="p">,</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">ca_key</span><span class="p">,</span> <span class="n">ca_cert</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_server_certificate</span><span class="p">(</span>
    <span class="n">ca_key</span><span class="p">,</span>
    <span class="n">ca_cert</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">,</span>
    <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">valid_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a server certificate signed by the CA.&quot;&quot;&quot;</span>
    <span class="c1"># Generate server key pair</span>
    <span class="n">server_key</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span>
        <span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span>
        <span class="n">key_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

    <span class="n">server_cert</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">x509</span><span class="o">.</span><span class="n">CertificateBuilder</span><span class="p">()</span>
        <span class="o">.</span><span class="n">subject_name</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">Name</span><span class="p">([</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="o">.</span><span class="n">COMMON_NAME</span><span class="p">,</span> <span class="n">hostname</span><span class="p">),</span>
        <span class="p">]))</span>
        <span class="o">.</span><span class="n">issuer_name</span><span class="p">(</span><span class="n">ca_cert</span><span class="o">.</span><span class="n">subject</span><span class="p">)</span>
        <span class="o">.</span><span class="n">public_key</span><span class="p">(</span><span class="n">server_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">())</span>
        <span class="o">.</span><span class="n">serial_number</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">random_serial_number</span><span class="p">())</span>
        <span class="o">.</span><span class="n">not_valid_before</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
        <span class="o">.</span><span class="n">not_valid_after</span><span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">valid_days</span><span class="p">))</span>
        <span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">SubjectAlternativeName</span><span class="p">([</span>
                <span class="n">x509</span><span class="o">.</span><span class="n">DNSName</span><span class="p">(</span><span class="n">hostname</span><span class="p">),</span>
                <span class="n">x509</span><span class="o">.</span><span class="n">DNSName</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*.</span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="n">critical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">BasicConstraints</span><span class="p">(</span><span class="n">ca</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">path_length</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
            <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">KeyUsage</span><span class="p">(</span>
                <span class="n">digital_signature</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">key_encipherment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">content_commitment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">data_encipherment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">key_agreement</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">key_cert_sign</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">crl_sign</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">encipher_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">decipher_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">ExtendedKeyUsage</span><span class="p">([</span>
                <span class="n">x509</span><span class="o">.</span><span class="n">oid</span><span class="o">.</span><span class="n">ExtendedKeyUsageOID</span><span class="o">.</span><span class="n">SERVER_AUTH</span><span class="p">,</span>
            <span class="p">]),</span>
            <span class="n">critical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ca_key</span><span class="p">,</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">server_key</span><span class="p">,</span> <span class="n">server_cert</span>

<span class="k">def</span><span class="w"> </span><span class="nf">verify_certificate_chain</span><span class="p">(</span>
    <span class="n">leaf_cert</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">,</span>
    <span class="n">intermediate_certs</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">trusted_roots</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify a certificate chain manually.</span>
<span class="sd">    In production, use ssl.SSLContext which handles this automatically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;checks&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

    <span class="c1"># Build the chain: leaf â†’ intermediates â†’ root</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="p">[</span><span class="n">leaf_cert</span><span class="p">]</span> <span class="o">+</span> <span class="n">intermediate_certs</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cert</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chain</span><span class="p">):</span>
        <span class="n">cert_name</span> <span class="o">=</span> <span class="s2">&quot;Leaf&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Intermediate </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Check validity period</span>
        <span class="k">if</span> <span class="n">cert</span><span class="o">.</span><span class="n">not_valid_before_utc</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cert_name</span><span class="si">}</span><span class="s2">: Not yet valid&quot;</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">cert</span><span class="o">.</span><span class="n">not_valid_after_utc</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cert_name</span><span class="si">}</span><span class="s2">: Expired&quot;</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">days_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">cert</span><span class="o">.</span><span class="n">not_valid_after_utc</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;checks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cert_name</span><span class="si">}</span><span class="s2">: Valid (</span><span class="si">{</span><span class="n">days_left</span><span class="si">}</span><span class="s2"> days remaining)&quot;</span><span class="p">)</span>

        <span class="c1"># Verify signature (issuer signed this cert)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Next cert in chain should be the issuer</span>
            <span class="n">issuer_cert</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Last cert should be signed by a trusted root</span>
            <span class="n">issuer_cert</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">trusted_roots</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">subject</span> <span class="o">==</span> <span class="n">cert</span><span class="o">.</span><span class="n">issuer</span><span class="p">:</span>
                    <span class="n">issuer_cert</span> <span class="o">=</span> <span class="n">root</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">issuer_cert</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cert_name</span><span class="si">}</span><span class="s2">: Issuer not found in trust store&quot;</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>

        <span class="c1"># Verify digital signature</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">issuer_pub</span> <span class="o">=</span> <span class="n">issuer_cert</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>
            <span class="n">issuer_pub</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span>
                <span class="n">cert</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span>
                <span class="n">cert</span><span class="o">.</span><span class="n">tbs_certificate_bytes</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">.</span><span class="n">PKCS1v15</span><span class="p">(),</span>
                <span class="n">cert</span><span class="o">.</span><span class="n">signature_hash_algorithm</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;checks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cert_name</span><span class="si">}</span><span class="s2">: Signature valid (signed by </span><span class="si">{</span><span class="n">issuer_cert</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">rfc4514_string</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cert_name</span><span class="si">}</span><span class="s2">: Signature verification failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Check hostname against SAN</span>
    <span class="k">if</span> <span class="n">hostname</span> <span class="ow">and</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">san</span> <span class="o">=</span> <span class="n">leaf_cert</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">get_extension_for_class</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">SubjectAlternativeName</span><span class="p">)</span>
            <span class="n">dns_names</span> <span class="o">=</span> <span class="n">san</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">get_attributes_for_oid</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">DNSName</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">san</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;get_attributes_for_oid&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">san</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">hostname</span> <span class="ow">in</span> <span class="n">names</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;*.&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">hostname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span>
            <span class="p">):</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;checks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hostname &#39;</span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s2">&#39; matches SAN&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hostname &#39;</span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s2">&#39; not in SAN: </span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">x509</span><span class="o">.</span><span class="n">ExtensionNotFound</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No SAN extension found&quot;</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Create a complete certificate chain</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating Certificate Chain&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="c1"># 1. Create Root CA</span>
<span class="n">ca_key</span><span class="p">,</span> <span class="n">ca_cert</span> <span class="o">=</span> <span class="n">create_ca_certificate</span><span class="p">(</span><span class="s2">&quot;Demo Root CA&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Root CA: </span><span class="si">{</span><span class="n">ca_cert</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">rfc4514_string</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 2. Create server certificate</span>
<span class="n">server_key</span><span class="p">,</span> <span class="n">server_cert</span> <span class="o">=</span> <span class="n">create_server_certificate</span><span class="p">(</span>
    <span class="n">ca_key</span><span class="p">,</span> <span class="n">ca_cert</span><span class="p">,</span> <span class="s2">&quot;example.com&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server:  </span><span class="si">{</span><span class="n">server_cert</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">rfc4514_string</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 3. Verify the chain</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">verify_certificate_chain</span><span class="p">(</span>
    <span class="n">leaf_cert</span><span class="o">=</span><span class="n">server_cert</span><span class="p">,</span>
    <span class="n">intermediate_certs</span><span class="o">=</span><span class="p">[],</span>  <span class="c1"># Direct CA signing (no intermediate)</span>
    <span class="n">trusted_roots</span><span class="o">=</span><span class="p">[</span><span class="n">ca_cert</span><span class="p">],</span>
    <span class="n">hostname</span><span class="o">=</span><span class="s2">&quot;example.com&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Chain Verification: </span><span class="si">{</span><span class="s1">&#39;VALID&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;INVALID&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;checks&quot;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [OK] </span><span class="si">{</span><span class="n">check</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [!!] </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Test with wrong hostname</span>
<span class="n">result2</span> <span class="o">=</span> <span class="n">verify_certificate_chain</span><span class="p">(</span>
    <span class="n">leaf_cert</span><span class="o">=</span><span class="n">server_cert</span><span class="p">,</span>
    <span class="n">intermediate_certs</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">trusted_roots</span><span class="o">=</span><span class="p">[</span><span class="n">ca_cert</span><span class="p">],</span>
    <span class="n">hostname</span><span class="o">=</span><span class="s2">&quot;evil.com&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Wrong hostname: </span><span class="si">{</span><span class="s1">&#39;VALID&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">result2</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;INVALID&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">result2</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [!!] </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="6-certificate-authorities-ca">6. Certificate Authorities (CA)<a class="header-link" href="#6-certificate-authorities-ca" title="Permanent link">&para;</a></h2>
<h3 id="61-how-cas-work">6.1 How CAs Work<a class="header-link" href="#61-how-cas-work" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Certificate Authority Process                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  1. DOMAIN OWNER generates key pair and CSR                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
â”‚     â”‚ Private Key  â”‚ (keep secret!)                                 â”‚
â”‚     â”‚ Public Key   â”‚ â†’ embedded in CSR                              â”‚
â”‚     â”‚ CSR          â”‚ â†’ sent to CA                                   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚            â”‚                                                        â”‚
â”‚            â–¼                                                        â”‚
â”‚  2. CA VALIDATES domain ownership                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚     â”‚  DV (Domain Validation):                     â”‚                â”‚
â”‚     â”‚    HTTP challenge, DNS challenge, or email    â”‚                â”‚
â”‚     â”‚                                               â”‚                â”‚
â”‚     â”‚  OV (Organization Validation):                â”‚                â”‚
â”‚     â”‚    DV + verify organization identity          â”‚                â”‚
â”‚     â”‚                                               â”‚                â”‚
â”‚     â”‚  EV (Extended Validation):                    â”‚                â”‚
â”‚     â”‚    OV + extensive legal/physical verification â”‚                â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚            â”‚                                                        â”‚
â”‚            â–¼                                                        â”‚
â”‚  3. CA SIGNS the certificate                                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
â”‚     â”‚ CA creates   â”‚                                                â”‚
â”‚     â”‚ X.509 cert  â”‚ â†’ signed with CA&#39;s private key                 â”‚
â”‚     â”‚ with owner&#39;sâ”‚                                                 â”‚
â”‚     â”‚ public key  â”‚                                                 â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚            â”‚                                                        â”‚
â”‚            â–¼                                                        â”‚
â”‚  4. DOMAIN OWNER installs cert on server                           â”‚
â”‚     Server sends cert chain during TLS handshake                   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="62-certificate-revocation">6.2 Certificate Revocation<a class="header-link" href="#62-certificate-revocation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">Certificate</span><span class="w"> </span><span class="n">Revocation</span><span class="w"> </span><span class="n">Methods</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Method</span><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Description</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">CRL</span><span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Certificate</span><span class="w"> </span><span class="n">Revocation</span><span class="w"> </span><span class="n">List</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">RFC</span><span class="w"> </span><span class="mi">5280</span><span class="p">)</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â€¢</span><span class="w"> </span><span class="n">CA</span><span class="w"> </span><span class="n">publishes</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">signed</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">revoked</span><span class="w"> </span><span class="n">certs</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Clients</span><span class="w"> </span><span class="n">download</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">list</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Problem</span><span class="p">:</span><span class="w"> </span><span class="n">lists</span><span class="w"> </span><span class="n">grow</span><span class="w"> </span><span class="n">large</span><span class="p">,</span><span class="w"> </span><span class="n">stale</span><span class="w"> </span><span class="n">data</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">OCSP</span><span class="w">             </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Online</span><span class="w"> </span><span class="n">Certificate</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="n">Protocol</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">RFC</span><span class="w"> </span><span class="mi">6960</span><span class="p">)</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="n">asks</span><span class="w"> </span><span class="n">CA</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Is this cert revoked?&quot;</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Real</span><span class="o">-</span><span class="n">time</span><span class="w"> </span><span class="n">response</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Problem</span><span class="p">:</span><span class="w"> </span><span class="n">privacy</span><span class="w"> </span><span class="p">(</span><span class="n">CA</span><span class="w"> </span><span class="n">sees</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">sites</span><span class="w"> </span><span class="n">you</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w">   </span><span class="n">visit</span><span class="p">),</span><span class="w"> </span><span class="n">availability</span><span class="w"> </span><span class="n">dependency</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">OCSP</span><span class="w"> </span><span class="n">Stapling</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">fetches</span><span class="w"> </span><span class="n">OCSP</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">attaches</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">to</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">RFC</span><span class="w"> </span><span class="mi">6066</span><span class="p">)</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="n">handshake</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="n">verifies</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="n">contacting</span><span class="w"> </span><span class="n">CA</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Best</span><span class="w"> </span><span class="n">practice</span><span class="o">!</span><span class="w"> </span><span class="n">Configure</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">server</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">signed</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">CA</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="o">-</span><span class="n">limited</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">CRLite</span><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Compressed</span><span class="w"> </span><span class="n">revocation</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">pushed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">browser</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">Firefox</span><span class="p">)</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Complete</span><span class="w"> </span><span class="n">revocation</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="n">needed</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Very</span><span class="w"> </span><span class="n">efficient</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">MB</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">revocations</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">Short</span><span class="o">-</span><span class="n">lived</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Certificates</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">days</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">certificates</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â€¢</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">revocation</span><span class="w"> </span><span class="n">needed</span><span class="w"> </span><span class="p">(</span><span class="n">cert</span><span class="w"> </span><span class="n">expires</span><span class="w"> </span><span class="n">before</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w">   </span><span class="n">revocation</span><span class="w"> </span><span class="n">would</span><span class="w"> </span><span class="n">take</span><span class="w"> </span><span class="n">effect</span><span class="p">)</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Let</span><span class="s1">&#39;s Encrypt certs: 90 days                  â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="63-certificate-transparency-ct">6.3 Certificate Transparency (CT)<a class="header-link" href="#63-certificate-transparency-ct" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">              </span><span class="nv">Certificate</span><span class="w"> </span><span class="nv">Transparency</span><span class="w"> </span><span class="ss">(</span><span class="nv">RFC</span><span class="w"> </span><span class="mi">6962</span><span class="ss">)</span><span class="w">                     </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Problem</span>:<span class="w"> </span><span class="nv">A</span><span class="w"> </span><span class="nv">rogue</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">compromised</span><span class="w"> </span><span class="nv">CA</span><span class="w"> </span><span class="nv">could</span><span class="w"> </span><span class="nv">issue</span><span class="w"> </span><span class="nv">fraudulent</span><span class="w">          </span>â”‚
â”‚<span class="w">  </span><span class="nv">certificates</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">any</span><span class="w"> </span><span class="nv">domain</span>.<span class="w">                                       </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Solution</span>:<span class="w"> </span><span class="nv">ALL</span><span class="w"> </span><span class="nv">certificates</span><span class="w"> </span><span class="nv">must</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">publicly</span><span class="w"> </span><span class="nv">logged</span>.<span class="w">                </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">  </span><span class="nv">issue</span><span class="w"> </span><span class="nv">cert</span><span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”<span class="w">  </span><span class="nv">submit</span><span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”<span class="w">               </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">Domain</span><span class="w"> </span>â”‚<span class="w"> </span>â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<span class="w"> </span>â”‚<span class="w"> </span><span class="nv">CA</span><span class="w">  </span>â”‚<span class="w"> </span>â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚<span class="w">  </span><span class="nv">CT</span><span class="w">   </span>â”‚<span class="w">               </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">Owner</span><span class="w">  </span>â”‚<span class="w">              </span>â”‚<span class="w">     </span>â”‚<span class="w">          </span>â”‚<span class="w">  </span><span class="nv">Log</span><span class="w">  </span>â”‚<span class="w">               </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">              </span>â””â”€â”€â”€â”€â”€â”˜<span class="w">          </span>â””â”€â”€â”€â”¬â”€â”€â”€â”˜<span class="w">               </span>â”‚
â”‚<span class="w">                                               </span>â”‚<span class="w">                     </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">  </span><span class="nv">SCT</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">TLS</span><span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”<span class="w">  </span><span class="nv">check</span><span class="w">    </span>â”‚<span class="w">                     </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="nv">Browser</span><span class="w"> </span>â”‚<span class="w"> </span>â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<span class="w"> </span>â”‚<span class="nv">Servr</span>â”‚<span class="w">          </span>â”‚<span class="w">                     </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">        </span>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚<span class="w">     </span>â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">                     </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">        </span>â”‚<span class="w">   </span><span class="nv">verify</span><span class="w"> </span><span class="nv">SCT</span><span class="w">  </span>â””â”€â”€â”€â”€â”€â”˜<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nv">SCT</span><span class="w">                    </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜<span class="w">                                                       </span>â”‚
â”‚<span class="w">       </span>â”‚<span class="w">                                                            </span>â”‚
â”‚<span class="w">       </span>â–¼<span class="w">                                                            </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">                                                    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="nv">Monitor</span><span class="w">   </span>â”‚<span class="w">  </span><span class="nv">Watches</span><span class="w"> </span><span class="nv">CT</span><span class="w"> </span><span class="nv">logs</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">unauthorized</span><span class="w"> </span><span class="nv">certificates</span><span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="nv">Service</span><span class="w">   </span>â”‚<span class="w">  </span><span class="nv">Domain</span><span class="w"> </span><span class="nv">owners</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="nv">detect</span><span class="w"> </span><span class="nv">rogue</span><span class="w"> </span><span class="nv">certs</span><span class="w">             </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">                                                    </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">SCT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Signed</span><span class="w"> </span><span class="nv">Certificate</span><span class="w"> </span><span class="nv">Timestamp</span><span class="w"> </span><span class="ss">(</span><span class="nv">proof</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">logging</span><span class="ss">)</span><span class="w">             </span>â”‚
â”‚<span class="w">  </span><span class="nv">Chrome</span><span class="o">/</span><span class="nv">Firefox</span><span class="w"> </span><span class="nv">REQUIRE</span><span class="w"> </span><span class="nv">CT</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">publicly</span><span class="w"> </span><span class="nv">trusted</span><span class="w"> </span><span class="nv">certificates</span>.<span class="w">  </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Search</span><span class="w"> </span><span class="nv">CT</span><span class="w"> </span><span class="nv">logs</span>:<span class="w"> </span><span class="nv">https</span>:<span class="o">//</span><span class="nv">crt</span>.<span class="nv">sh</span><span class="o">/</span><span class="w">                                   </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="7-lets-encrypt-and-acme">7. Let's Encrypt and ACME<a class="header-link" href="#7-lets-encrypt-and-acme" title="Permanent link">&para;</a></h2>
<h3 id="71-acme-protocol-overview">7.1 ACME Protocol Overview<a class="header-link" href="#71-acme-protocol-overview" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">         </span><span class="n">ACME</span><span class="w"> </span><span class="n">Protocol</span><span class="w"> </span><span class="p">(</span><span class="n">Automatic</span><span class="w"> </span><span class="n">Certificate</span><span class="w"> </span><span class="n">Management</span><span class="p">)</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                       </span><span class="n">RFC</span><span class="w"> </span><span class="mi">8555</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="n">Client</span><span class="w"> </span><span class="p">(</span><span class="n">certbot</span><span class="p">)</span><span class="w">                          </span><span class="n">Let</span><span class="s1">&#39;s Encrypt            â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">                          </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="mf">1.</span><span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">Account</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="n">acme</span><span class="o">/</span><span class="n">new</span><span class="o">-</span><span class="n">acct</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                           </span><span class="err">â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="n">URL</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="mf">2.</span><span class="w"> </span><span class="n">Submit</span><span class="w"> </span><span class="n">Order</span><span class="w">                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="n">acme</span><span class="o">/</span><span class="n">new</span><span class="o">-</span><span class="n">order</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="n">identifiers</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;example.com&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                           </span><span class="err">â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="n">Authorization</span><span class="w"> </span><span class="n">URLs</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="mf">3.</span><span class="w"> </span><span class="n">Complete</span><span class="w"> </span><span class="n">Challenges</span><span class="w"> </span><span class="p">(</span><span class="n">prove</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="n">ownership</span><span class="p">)</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">HTTP</span><span class="o">-</span><span class="mi">01</span><span class="w"> </span><span class="n">Challenge</span><span class="p">:</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">PUT</span><span class="w"> </span><span class="o">/.</span><span class="n">well</span><span class="o">-</span><span class="n">known</span><span class="o">/</span><span class="n">acme</span><span class="o">-</span><span class="n">challenge</span><span class="o">/</span><span class="p">{</span><span class="n">token</span><span class="p">}</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="err">â†’</span><span class="w"> </span><span class="n">Let</span><span class="s1">&#39;s Encrypt GETs this URL to verify                       â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">DNS</span><span class="o">-</span><span class="mi">01</span><span class="w"> </span><span class="n">Challenge</span><span class="p">:</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">Create</span><span class="w"> </span><span class="n">TXT</span><span class="w"> </span><span class="n">record</span><span class="p">:</span><span class="w"> </span><span class="n">_acme</span><span class="o">-</span><span class="n">challenge</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="err">â†’</span><span class="w"> </span><span class="n">Let</span><span class="s1">&#39;s Encrypt queries DNS to verify                          â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="mf">4.</span><span class="w"> </span><span class="n">Finalize</span><span class="w"> </span><span class="n">Order</span><span class="w"> </span><span class="p">(</span><span class="n">submit</span><span class="w"> </span><span class="n">CSR</span><span class="p">)</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="n">acme</span><span class="o">/</span><span class="n">finalize</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="n">csr</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;MIIBkTCB...&quot;</span><span class="w"> </span><span class="p">}</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                           </span><span class="err">â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="n">Certificate</span><span class="w"> </span><span class="n">URL</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="mf">5.</span><span class="w"> </span><span class="n">Download</span><span class="w"> </span><span class="n">Certificate</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">GET</span><span class="w"> </span><span class="o">/</span><span class="n">acme</span><span class="o">/</span><span class="n">cert</span><span class="o">/</span><span class="n">abc123</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                           </span><span class="err">â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="n">PEM</span><span class="w"> </span><span class="n">certificate</span><span class="w"> </span><span class="n">chain</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="mf">6.</span><span class="w"> </span><span class="n">Auto</span><span class="o">-</span><span class="n">renewal</span><span class="w"> </span><span class="p">(</span><span class="n">before</span><span class="w"> </span><span class="n">expiration</span><span class="p">,</span><span class="w"> </span><span class="n">typically</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">days</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">Repeat</span><span class="w"> </span><span class="n">steps</span><span class="w"> </span><span class="mi">2</span><span class="o">-</span><span class="mi">5</span><span class="w"> </span><span class="n">automatically</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="72-certbot-commands">7.2 Certbot Commands<a class="header-link" href="#72-certbot-commands" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Install certbot</span>
<span class="c1"># Ubuntu/Debian</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>certbot<span class="w"> </span>python3-certbot-nginx

<span class="c1"># macOS</span>
brew<span class="w"> </span>install<span class="w"> </span>certbot

<span class="c1"># Obtain a certificate (standalone mode - stops web server temporarily)</span>
sudo<span class="w"> </span>certbot<span class="w"> </span>certonly<span class="w"> </span>--standalone<span class="w"> </span>-d<span class="w"> </span>example.com<span class="w"> </span>-d<span class="w"> </span>www.example.com

<span class="c1"># Obtain with Nginx plugin (no downtime)</span>
sudo<span class="w"> </span>certbot<span class="w"> </span>--nginx<span class="w"> </span>-d<span class="w"> </span>example.com<span class="w"> </span>-d<span class="w"> </span>www.example.com

<span class="c1"># Obtain with DNS challenge (for wildcards)</span>
sudo<span class="w"> </span>certbot<span class="w"> </span>certonly<span class="w"> </span>--manual<span class="w"> </span>--preferred-challenges<span class="w"> </span>dns<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;*.example.com&quot;</span>

<span class="c1"># Test renewal</span>
sudo<span class="w"> </span>certbot<span class="w"> </span>renew<span class="w"> </span>--dry-run

<span class="c1"># Actual renewal (usually via cron/systemd timer)</span>
sudo<span class="w"> </span>certbot<span class="w"> </span>renew

<span class="c1"># View certificates</span>
sudo<span class="w"> </span>certbot<span class="w"> </span>certificates

<span class="c1"># Revoke a certificate</span>
sudo<span class="w"> </span>certbot<span class="w"> </span>revoke<span class="w"> </span>--cert-path<span class="w"> </span>/etc/letsencrypt/live/example.com/cert.pem
</code></pre></div>

<h3 id="73-certificate-files">7.3 Certificate Files<a class="header-link" href="#73-certificate-files" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">cert</span><span class="o">.</span><span class="n">pem</span><span class="w">       </span><span class="c1"># Your domain&#39;s certificate (leaf only)</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">chain</span><span class="o">.</span><span class="n">pem</span><span class="w">      </span><span class="c1"># Intermediate CA certificate(s)</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">fullchain</span><span class="o">.</span><span class="n">pem</span><span class="w">  </span><span class="c1"># cert.pem + chain.pem (what most servers need)</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">privkey</span><span class="o">.</span><span class="n">pem</span><span class="w">    </span><span class="c1"># Your private key (KEEP SECRET!)</span>
<span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">README</span>

<span class="c1"># Nginx configuration</span>
<span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="w"> </span><span class="n">http2</span><span class="p">;</span>
<span class="w">    </span><span class="n">server_name</span><span class="w"> </span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>

<span class="w">    </span><span class="n">ssl_certificate</span><span class="w">     </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">fullchain</span><span class="o">.</span><span class="n">pem</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_certificate_key</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">privkey</span><span class="o">.</span><span class="n">pem</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Modern TLS configuration</span>
<span class="w">    </span><span class="n">ssl_protocols</span><span class="w"> </span><span class="n">TLSv1</span><span class="o">.</span><span class="mi">2</span><span class="w"> </span><span class="n">TLSv1</span><span class="o">.</span><span class="mi">3</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_ciphers</span><span class="w"> </span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="n">SHA256</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="n">SHA256</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="n">SHA384</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="n">SHA384</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">CHACHA20</span><span class="o">-</span><span class="n">POLY1305</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">CHACHA20</span><span class="o">-</span><span class="n">POLY1305</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_prefer_server_ciphers</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># HSTS</span>
<span class="w">    </span><span class="n">add_header</span><span class="w"> </span><span class="n">Strict</span><span class="o">-</span><span class="n">Transport</span><span class="o">-</span><span class="n">Security</span><span class="w"> </span><span class="s2">&quot;max-age=63072000; includeSubDomains; preload&quot;</span><span class="w"> </span><span class="n">always</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># OCSP Stapling</span>
<span class="w">    </span><span class="n">ssl_stapling</span><span class="w"> </span><span class="n">on</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_stapling_verify</span><span class="w"> </span><span class="n">on</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_trusted_certificate</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">chain</span><span class="o">.</span><span class="n">pem</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="8-certificate-pinning">8. Certificate Pinning<a class="header-link" href="#8-certificate-pinning" title="Permanent link">&para;</a></h2>
<p>Certificate pinning restricts which certificates are accepted for a given domain, preventing attacks even if a CA is compromised.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">              </span><span class="nv">Certificate</span><span class="w"> </span><span class="nv">Pinning</span><span class="w"> </span><span class="nv">Strategies</span><span class="w">                           </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">1</span>.<span class="w"> </span><span class="nv">PUBLIC</span><span class="w"> </span><span class="nv">KEY</span><span class="w"> </span><span class="nv">PINNING</span><span class="w"> </span><span class="ss">(</span><span class="nv">recommended</span><span class="ss">)</span><span class="w">                                </span>â”‚
â”‚<span class="w">     </span><span class="nv">Pin</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">hash</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">public</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="ss">(</span><span class="nv">not</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">whole</span><span class="w"> </span><span class="nv">cert</span><span class="ss">)</span>.<span class="w">           </span>â”‚
â”‚<span class="w">     </span><span class="nv">Survives</span><span class="w"> </span><span class="nv">certificate</span><span class="w"> </span><span class="nv">renewal</span><span class="w"> </span><span class="ss">(</span><span class="nv">key</span><span class="w"> </span><span class="nv">stays</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">same</span><span class="ss">)</span>.<span class="w">             </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">2</span>.<span class="w"> </span><span class="nv">CERTIFICATE</span><span class="w"> </span><span class="nv">PINNING</span><span class="w">                                             </span>â”‚
â”‚<span class="w">     </span><span class="nv">Pin</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">hash</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">entire</span><span class="w"> </span><span class="nv">certificate</span>.<span class="w">                        </span>â”‚
â”‚<span class="w">     </span><span class="nv">Must</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="nv">pins</span><span class="w"> </span><span class="nv">when</span><span class="w"> </span><span class="nv">certificate</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">renewed</span>.<span class="w">                  </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">3</span>.<span class="w"> </span><span class="nv">INTERMEDIATE</span><span class="w"> </span><span class="nv">CA</span><span class="w"> </span><span class="nv">PINNING</span><span class="w">                                         </span>â”‚
â”‚<span class="w">     </span><span class="nv">Pin</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">intermediate</span><span class="w"> </span><span class="nv">CA</span><span class="err">&#39;s public key.                          â”‚</span>
<span class="err">â”‚     More flexible than leaf pinning.                               â”‚</span>
<span class="err">â”‚                                                                      â”‚</span>
<span class="err">â”‚  IMPORTANT WARNINGS:                                                â”‚</span>
<span class="err">â”‚  â€¢ HPKP (HTTP Public Key Pinning) is DEPRECATED in browsers       â”‚</span>
<span class="err">â”‚    (too easy to brick a domain permanently)                         â”‚</span>
<span class="err">â”‚  â€¢ Use pinning primarily in mobile apps and API clients            â”‚</span>
<span class="err">â”‚  â€¢ ALWAYS include a backup pin                                     â”‚</span>
<span class="err">â”‚  â€¢ Certificate Transparency is now preferred over pinning          â”‚</span>
<span class="err">â”‚    for web browsers                                                 â”‚</span>
<span class="err">â”‚                                                                      â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="81-certificate-pinning-in-python">8.1 Certificate Pinning in Python<a class="header-link" href="#81-certificate-pinning-in-python" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography</span><span class="w"> </span><span class="kn">import</span> <span class="n">x509</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.serialization</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Encoding</span><span class="p">,</span> <span class="n">PublicFormat</span>
<span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PinnedHTTPSConnection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;HTTPS connection with certificate pinning.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">443</span><span class="p">,</span>
                 <span class="n">pinned_hashes</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            hostname: Server hostname</span>
<span class="sd">            port: Server port</span>
<span class="sd">            pinned_hashes: List of SHA-256 hashes of accepted</span>
<span class="sd">                           public keys (base64-encoded)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pinned_hashes</span> <span class="o">=</span> <span class="n">pinned_hashes</span> <span class="ow">or</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_pubkey_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert_der</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute SHA-256 hash of certificate&#39;s public key.&quot;&quot;&quot;</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">load_der_x509_certificate</span><span class="p">(</span><span class="n">cert_der</span><span class="p">)</span>
        <span class="n">pub_key_bytes</span> <span class="o">=</span> <span class="n">cert</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span>
            <span class="n">Encoding</span><span class="o">.</span><span class="n">DER</span><span class="p">,</span>
            <span class="n">PublicFormat</span><span class="o">.</span><span class="n">SubjectPublicKeyInfo</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">pub_key_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Connect with certificate pin verification.&quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssock</span><span class="p">:</span>
                <span class="c1"># Get the certificate chain</span>
                <span class="n">cert_der</span> <span class="o">=</span> <span class="n">ssock</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">(</span><span class="n">binary_form</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">cert_info</span> <span class="o">=</span> <span class="n">ssock</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>

                <span class="c1"># Compute public key hash</span>
                <span class="n">actual_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pubkey_hash</span><span class="p">(</span><span class="n">cert_der</span><span class="p">)</span>

                <span class="c1"># Check pin</span>
                <span class="n">pin_valid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_hashes</span><span class="p">:</span>
                    <span class="n">pin_valid</span> <span class="o">=</span> <span class="n">actual_hash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_hashes</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
                    <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="n">ssock</span><span class="o">.</span><span class="n">version</span><span class="p">(),</span>
                    <span class="s2">&quot;cipher&quot;</span><span class="p">:</span> <span class="n">ssock</span><span class="o">.</span><span class="n">cipher</span><span class="p">(),</span>
                    <span class="s2">&quot;cert_subject&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cert_info</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]),</span>
                    <span class="s2">&quot;cert_issuer&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cert_info</span><span class="p">[</span><span class="s2">&quot;issuer&quot;</span><span class="p">]),</span>
                    <span class="s2">&quot;pubkey_hash&quot;</span><span class="p">:</span> <span class="n">actual_hash</span><span class="p">,</span>
                    <span class="s2">&quot;pin_valid&quot;</span><span class="p">:</span> <span class="n">pin_valid</span><span class="p">,</span>
                    <span class="s2">&quot;pinned_hashes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_hashes</span><span class="p">,</span>
                <span class="p">}</span>

<span class="c1"># First, discover the pin for a server</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">discovery</span> <span class="o">=</span> <span class="n">PinnedHTTPSConnection</span><span class="p">(</span><span class="s2">&quot;www.google.com&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">discovery</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Certificate Pin Discovery:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Host:         </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Protocol:     </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;protocol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cipher:       </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;cipher&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Subject:      </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;cert_subject&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pubkey Hash:  </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;pubkey_hash&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Now connect with the pin</span>
    <span class="n">pinned</span> <span class="o">=</span> <span class="n">PinnedHTTPSConnection</span><span class="p">(</span>
        <span class="s2">&quot;www.google.com&quot;</span><span class="p">,</span>
        <span class="n">pinned_hashes</span><span class="o">=</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;pubkey_hash&quot;</span><span class="p">]]</span>
    <span class="p">)</span>
    <span class="n">pinned_result</span> <span class="o">=</span> <span class="n">pinned</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Pin valid:    </span><span class="si">{</span><span class="n">pinned_result</span><span class="p">[</span><span class="s1">&#39;pin_valid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Wrong pin</span>
    <span class="n">wrong</span> <span class="o">=</span> <span class="n">PinnedHTTPSConnection</span><span class="p">(</span>
        <span class="s2">&quot;www.google.com&quot;</span><span class="p">,</span>
        <span class="n">pinned_hashes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;0000000000000000000000000000000000000000000000000000000000000000&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">wrong_result</span> <span class="o">=</span> <span class="n">wrong</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Wrong pin:    </span><span class="si">{</span><span class="n">wrong_result</span><span class="p">[</span><span class="s1">&#39;pin_valid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network error (expected in offline environments): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="9-mutual-tls-mtls">9. Mutual TLS (mTLS)<a class="header-link" href="#9-mutual-tls-mtls" title="Permanent link">&para;</a></h2>
<p>In standard TLS, only the server presents a certificate. In mutual TLS, both the client and server present certificates and verify each other. This is used for service-to-service communication, API authentication, and zero-trust architectures.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">Standard</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="n">vs</span><span class="w"> </span><span class="n">Mutual</span><span class="w"> </span><span class="n">TLS</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">STANDARD</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="p">(</span><span class="n">one</span><span class="o">-</span><span class="n">way</span><span class="p">)</span><span class="o">:</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Client</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="w"> </span><span class="s">&quot;Who are you?&quot;</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="w"> </span><span class="n">Server</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">â—€â”€â”€â”€</span><span class="w"> </span><span class="p">[</span><span class="n">Server</span><span class="w"> </span><span class="n">Certificate</span><span class="p">]</span><span class="w"> </span><span class="err">â”€â”€â”€</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">â”€â”€â”€â”€</span><span class="w"> </span><span class="s">&quot;OK, I trust you&quot;</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â–¶</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Only</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">SERVER</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">authenticated</span><span class="p">.</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Client</span><span class="w"> </span><span class="n">identity</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">verified</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">means</span><span class="w"> </span><span class="p">(</span><span class="n">JWT</span><span class="p">,</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="p">.)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">MUTUAL</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="p">(</span><span class="n">two</span><span class="o">-</span><span class="n">way</span><span class="p">)</span><span class="o">:</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Client</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="w"> </span><span class="s">&quot;Who are you?&quot;</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="w"> </span><span class="n">Server</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">â—€â”€â”€â”€</span><span class="w"> </span><span class="p">[</span><span class="n">Server</span><span class="w"> </span><span class="n">Certificate</span><span class="p">]</span><span class="w"> </span><span class="err">â”€â”€â”€</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">â—€â”€â”€â”€</span><span class="w"> </span><span class="s">&quot;Who are YOU?&quot;</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">â”€â”€â”€â”€</span><span class="w"> </span><span class="p">[</span><span class="n">Client</span><span class="w"> </span><span class="n">Certificate</span><span class="p">]</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â–¶</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">â—€â”€â”€â”€</span><span class="w"> </span><span class="s">&quot;OK, I trust you&quot;</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">â”€â”€â”€â”€</span><span class="w"> </span><span class="s">&quot;OK, I trust you too&quot;</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">BOTH</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">authenticated</span><span class="p">.</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">passwords</span><span class="p">,</span><span class="w"> </span><span class="n">tokens</span><span class="p">,</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="n">needed</span><span class="p">.</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Use</span><span class="w"> </span><span class="n">cases</span><span class="o">:</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Microservice</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">microservice</span><span class="w"> </span><span class="p">(</span><span class="n">Istio</span><span class="p">,</span><span class="w"> </span><span class="n">Linkerd</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="n">mesh</span><span class="p">)</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">partners</span><span class="o">/</span><span class="n">machines</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">IoT</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">authentication</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Zero</span><span class="o">-</span><span class="n">trust</span><span class="w"> </span><span class="n">networks</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="n">Database</span><span class="w"> </span><span class="n">connections</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="91-mtls-implementation">9.1 mTLS Implementation<a class="header-link" href="#91-mtls-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography</span><span class="w"> </span><span class="kn">import</span> <span class="n">x509</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">hashes</span><span class="p">,</span> <span class="n">serialization</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric</span><span class="w"> </span><span class="kn">import</span> <span class="n">rsa</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.x509.oid</span><span class="w"> </span><span class="kn">import</span> <span class="n">NameOID</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_mtls_certificates</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create CA, server, and client certificates for mTLS.&quot;&quot;&quot;</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
    <span class="n">base</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

    <span class="c1"># 1. Create CA</span>
    <span class="n">ca_key</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span><span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span> <span class="n">key_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">)</span>
    <span class="n">ca_cert</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">x509</span><span class="o">.</span><span class="n">CertificateBuilder</span><span class="p">()</span>
        <span class="o">.</span><span class="n">subject_name</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">Name</span><span class="p">([</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="o">.</span><span class="n">COMMON_NAME</span><span class="p">,</span> <span class="s2">&quot;mTLS Demo CA&quot;</span><span class="p">),</span>
        <span class="p">]))</span>
        <span class="o">.</span><span class="n">issuer_name</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">Name</span><span class="p">([</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="o">.</span><span class="n">COMMON_NAME</span><span class="p">,</span> <span class="s2">&quot;mTLS Demo CA&quot;</span><span class="p">),</span>
        <span class="p">]))</span>
        <span class="o">.</span><span class="n">public_key</span><span class="p">(</span><span class="n">ca_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">())</span>
        <span class="o">.</span><span class="n">serial_number</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">random_serial_number</span><span class="p">())</span>
        <span class="o">.</span><span class="n">not_valid_before</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
        <span class="o">.</span><span class="n">not_valid_after</span><span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">))</span>
        <span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">BasicConstraints</span><span class="p">(</span><span class="n">ca</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">path_length</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">critical</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ca_key</span><span class="p">,</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
    <span class="p">)</span>

    <span class="c1"># 2. Create Server Certificate</span>
    <span class="n">server_key</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span><span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span> <span class="n">key_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">)</span>
    <span class="n">server_cert</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">x509</span><span class="o">.</span><span class="n">CertificateBuilder</span><span class="p">()</span>
        <span class="o">.</span><span class="n">subject_name</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">Name</span><span class="p">([</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="o">.</span><span class="n">COMMON_NAME</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">),</span>
        <span class="p">]))</span>
        <span class="o">.</span><span class="n">issuer_name</span><span class="p">(</span><span class="n">ca_cert</span><span class="o">.</span><span class="n">subject</span><span class="p">)</span>
        <span class="o">.</span><span class="n">public_key</span><span class="p">(</span><span class="n">server_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">())</span>
        <span class="o">.</span><span class="n">serial_number</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">random_serial_number</span><span class="p">())</span>
        <span class="o">.</span><span class="n">not_valid_before</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
        <span class="o">.</span><span class="n">not_valid_after</span><span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">90</span><span class="p">))</span>
        <span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">SubjectAlternativeName</span><span class="p">([</span>
                <span class="n">x509</span><span class="o">.</span><span class="n">DNSName</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">),</span>
                <span class="n">x509</span><span class="o">.</span><span class="n">IPAddress</span><span class="p">(</span><span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_address</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">)),</span>
            <span class="p">]),</span> <span class="n">critical</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">ExtendedKeyUsage</span><span class="p">([</span>
                <span class="n">x509</span><span class="o">.</span><span class="n">oid</span><span class="o">.</span><span class="n">ExtendedKeyUsageOID</span><span class="o">.</span><span class="n">SERVER_AUTH</span><span class="p">,</span>
            <span class="p">]),</span> <span class="n">critical</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ca_key</span><span class="p">,</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
    <span class="p">)</span>

    <span class="c1"># 3. Create Client Certificate</span>
    <span class="n">client_key</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span><span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span> <span class="n">key_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">)</span>
    <span class="n">client_cert</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">x509</span><span class="o">.</span><span class="n">CertificateBuilder</span><span class="p">()</span>
        <span class="o">.</span><span class="n">subject_name</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">Name</span><span class="p">([</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="o">.</span><span class="n">COMMON_NAME</span><span class="p">,</span> <span class="s2">&quot;api-client-1&quot;</span><span class="p">),</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="o">.</span><span class="n">ORGANIZATION_NAME</span><span class="p">,</span> <span class="s2">&quot;My App&quot;</span><span class="p">),</span>
        <span class="p">]))</span>
        <span class="o">.</span><span class="n">issuer_name</span><span class="p">(</span><span class="n">ca_cert</span><span class="o">.</span><span class="n">subject</span><span class="p">)</span>
        <span class="o">.</span><span class="n">public_key</span><span class="p">(</span><span class="n">client_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">())</span>
        <span class="o">.</span><span class="n">serial_number</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">random_serial_number</span><span class="p">())</span>
        <span class="o">.</span><span class="n">not_valid_before</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
        <span class="o">.</span><span class="n">not_valid_after</span><span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">90</span><span class="p">))</span>
        <span class="o">.</span><span class="n">add_extension</span><span class="p">(</span>
            <span class="n">x509</span><span class="o">.</span><span class="n">ExtendedKeyUsage</span><span class="p">([</span>
                <span class="n">x509</span><span class="o">.</span><span class="n">oid</span><span class="o">.</span><span class="n">ExtendedKeyUsageOID</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="p">,</span>
            <span class="p">]),</span> <span class="n">critical</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ca_key</span><span class="p">,</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
    <span class="p">)</span>

    <span class="c1"># Write all certificates and keys</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">cert</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;ca&quot;</span><span class="p">,</span> <span class="n">ca_key</span><span class="p">,</span> <span class="n">ca_cert</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;server&quot;</span><span class="p">,</span> <span class="n">server_key</span><span class="p">,</span> <span class="n">server_cert</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;client&quot;</span><span class="p">,</span> <span class="n">client_key</span><span class="p">,</span> <span class="n">client_cert</span><span class="p">),</span>
    <span class="p">]:</span>
        <span class="n">cert_path</span> <span class="o">=</span> <span class="n">base</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_cert.pem&quot;</span>
        <span class="n">key_path</span> <span class="o">=</span> <span class="n">base</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_key.pem&quot;</span>

        <span class="n">cert_path</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="n">cert</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">PEM</span><span class="p">))</span>
        <span class="n">key_path</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">private_bytes</span><span class="p">(</span>
            <span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">PEM</span><span class="p">,</span>
            <span class="n">serialization</span><span class="o">.</span><span class="n">PrivateFormat</span><span class="o">.</span><span class="n">TraditionalOpenSSL</span><span class="p">,</span>
            <span class="n">serialization</span><span class="o">.</span><span class="n">NoEncryption</span><span class="p">(),</span>
        <span class="p">))</span>

        <span class="n">files</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_cert&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cert_path</span><span class="p">)</span>
        <span class="n">files</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">files</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ipaddress</span>

<span class="c1"># Create certificates</span>
<span class="n">certs</span> <span class="o">=</span> <span class="n">create_mtls_certificates</span><span class="p">(</span><span class="s2">&quot;/tmp/mtls_demo&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generated certificates:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">certs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_mtls_server_context</span><span class="p">(</span><span class="n">certs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an SSL context for a mTLS server.&quot;&quot;&quot;</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLS_SERVER</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">minimum_version</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">TLSVersion</span><span class="o">.</span><span class="n">TLSv1_2</span>

    <span class="c1"># Load server certificate and key</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span>
        <span class="n">certfile</span><span class="o">=</span><span class="n">certs</span><span class="p">[</span><span class="s2">&quot;server_cert&quot;</span><span class="p">],</span>
        <span class="n">keyfile</span><span class="o">=</span><span class="n">certs</span><span class="p">[</span><span class="s2">&quot;server_key&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Require client certificate (this is what makes it mTLS)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>

    <span class="c1"># Trust only our CA for client certificates</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cafile</span><span class="o">=</span><span class="n">certs</span><span class="p">[</span><span class="s2">&quot;ca_cert&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">ctx</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_mtls_client_context</span><span class="p">(</span><span class="n">certs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an SSL context for a mTLS client.&quot;&quot;&quot;</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLS_CLIENT</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">minimum_version</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">TLSVersion</span><span class="o">.</span><span class="n">TLSv1_2</span>

    <span class="c1"># Load client certificate and key</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span>
        <span class="n">certfile</span><span class="o">=</span><span class="n">certs</span><span class="p">[</span><span class="s2">&quot;client_cert&quot;</span><span class="p">],</span>
        <span class="n">keyfile</span><span class="o">=</span><span class="n">certs</span><span class="p">[</span><span class="s2">&quot;client_key&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Trust our CA for server certificate verification</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cafile</span><span class="o">=</span><span class="n">certs</span><span class="p">[</span><span class="s2">&quot;ca_cert&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">ctx</span>

<span class="c1"># Simple mTLS echo server</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mtls_server</span><span class="p">(</span><span class="n">certs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run a simple mTLS server.&quot;&quot;&quot;</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">create_mtls_server_context</span><span class="p">(</span><span class="n">certs</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssock</span><span class="p">:</span>
            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">ssock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">conn</span><span class="p">:</span>
                <span class="c1"># Get client certificate info</span>
                <span class="n">client_cert</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                <span class="n">client_cn</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">client_cert</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">])[</span><span class="s2">&quot;commonName&quot;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [Server] Client authenticated: </span><span class="si">{</span><span class="n">client_cn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Echo received data</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hello </span><span class="si">{</span><span class="n">client_cn</span><span class="si">}</span><span class="s2">! You said: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

<span class="c1"># Test mTLS</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">8443</span>
<span class="n">server_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">mtls_server</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">certs</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="n">server_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Wait for server to start</span>

<span class="c1"># Connect as client</span>
<span class="n">client_ctx</span> <span class="o">=</span> <span class="n">create_mtls_client_context</span><span class="p">(</span><span class="n">certs</span><span class="p">)</span>
<span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">client_ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssock</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [Client] Connected with </span><span class="si">{</span><span class="n">ssock</span><span class="o">.</span><span class="n">version</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [Client] Server cert: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">ssock</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()[</span><span class="s1">&#39;subject&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ssock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Hello from mTLS client!&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">ssock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [Client] Response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Clean up</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s2">&quot;/tmp/mtls_demo&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="10-python-tls-programming">10. Python TLS Programming<a class="header-link" href="#10-python-tls-programming" title="Permanent link">&para;</a></h2>
<h3 id="101-secure-https-client">10.1 Secure HTTPS Client<a class="header-link" href="#101-secure-https-client" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_secure_request</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make an HTTPS request with security best practices.&quot;&quot;&quot;</span>
    <span class="c1"># Create a secure SSL context</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">()</span>

    <span class="c1"># Enforce minimum TLS version</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">minimum_version</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">TLSVersion</span><span class="o">.</span><span class="n">TLSv1_2</span>

    <span class="c1"># Disable compression (prevents CRIME attack)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_COMPRESSION</span>

    <span class="c1"># Set strong cipher suites (for TLS 1.2 fallback)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">set_ciphers</span><span class="p">(</span>
        <span class="s2">&quot;ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Make request</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
            <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">),</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
        <span class="p">}</span>

<span class="c1"># Example</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">make_secure_request</span><span class="p">(</span><span class="s2">&quot;https://www.example.com&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;URL: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="102-tls-server-with-python">10.2 TLS Server with Python<a class="header-link" href="#102-tls-server-with-python" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_tls_server</span><span class="p">(</span><span class="n">certfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">keyfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8443</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a TLS server with modern configuration.&quot;&quot;&quot;</span>
    <span class="c1"># Create SSL context</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLS_SERVER</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">minimum_version</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">TLSVersion</span><span class="o">.</span><span class="n">TLSv1_2</span>

    <span class="c1"># Load certificate and key</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">certfile</span><span class="o">=</span><span class="n">certfile</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="n">keyfile</span><span class="p">)</span>

    <span class="c1"># Strong ciphers</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">set_ciphers</span><span class="p">(</span>
        <span class="s2">&quot;ECDHE+AESGCM:ECDHE+CHACHA20&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Security options</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_COMPRESSION</span>    <span class="c1"># Prevent CRIME</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_SINGLE_DH_USE</span>     <span class="c1"># Fresh DH params</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_SINGLE_ECDH_USE</span>   <span class="c1"># Fresh ECDH params</span>

    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TLS server listening on </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssock</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">ssock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection from </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Protocol: </span><span class="si">{</span><span class="n">conn</span><span class="o">.</span><span class="n">version</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cipher:   </span><span class="si">{</span><span class="n">conn</span><span class="o">.</span><span class="n">cipher</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Handle connection</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s2">&quot;</span>
                                <span class="sa">b</span><span class="s2">&quot;Content-Type: text/plain</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
                                <span class="sa">b</span><span class="s2">&quot;Hello, TLS!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="11-creating-certificates-with-openssl">11. Creating Certificates with OpenSSL<a class="header-link" href="#11-creating-certificates-with-openssl" title="Permanent link">&para;</a></h2>
<h3 id="111-self-signed-certificate-development">11.1 Self-Signed Certificate (Development)<a class="header-link" href="#111-self-signed-certificate-development" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Generate a self-signed certificate for development</span>
<span class="c1"># (DO NOT use in production!)</span>

<span class="c1"># One-liner: generate key + cert in one command</span>
openssl<span class="w"> </span>req<span class="w"> </span>-x509<span class="w"> </span>-newkey<span class="w"> </span>rsa:4096<span class="w"> </span>-sha256<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-nodes<span class="w"> </span>-keyout<span class="w"> </span>server.key<span class="w"> </span>-out<span class="w"> </span>server.crt<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=localhost&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-addext<span class="w"> </span><span class="s2">&quot;subjectAltName=DNS:localhost,IP:127.0.0.1&quot;</span>

<span class="c1"># Verify the certificate</span>
openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>server.crt<span class="w"> </span>-text<span class="w"> </span>-noout

<span class="c1"># Check the key</span>
openssl<span class="w"> </span>rsa<span class="w"> </span>-in<span class="w"> </span>server.key<span class="w"> </span>-check<span class="w"> </span>-noout
</code></pre></div>

<h3 id="112-ca-server-certificate-full-process">11.2 CA + Server Certificate (Full Process)<a class="header-link" href="#112-ca-server-certificate-full-process" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Step 1: Create CA private key</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-aes256<span class="w"> </span>-out<span class="w"> </span>ca.key<span class="w"> </span><span class="m">4096</span>
<span class="c1"># Enter passphrase for CA key (remember this!)</span>

<span class="c1"># Step 2: Create CA certificate (self-signed)</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-x509<span class="w"> </span>-sha256<span class="w"> </span>-days<span class="w"> </span><span class="m">3650</span><span class="w"> </span>-key<span class="w"> </span>ca.key<span class="w"> </span>-out<span class="w"> </span>ca.crt<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-subj<span class="w"> </span><span class="s2">&quot;/C=US/O=My Organization/CN=My Root CA&quot;</span>

<span class="c1"># Step 3: Create server private key (no passphrase for automation)</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>server.key<span class="w"> </span><span class="m">2048</span>

<span class="c1"># Step 4: Create Certificate Signing Request (CSR)</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-sha256<span class="w"> </span>-key<span class="w"> </span>server.key<span class="w"> </span>-out<span class="w"> </span>server.csr<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=myserver.example.com&quot;</span>

<span class="c1"># Step 5: Create a config file for SAN (Subject Alternative Names)</span>
cat<span class="w"> </span>&gt;<span class="w"> </span>server_ext.cnf<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s">authorityKeyIdentifier=keyid,issuer</span>
<span class="s">basicConstraints=CA:FALSE</span>
<span class="s">keyUsage=digitalSignature,keyEncipherment</span>
<span class="s">extendedKeyUsage=serverAuth</span>
<span class="s">subjectAltName=@alt_names</span>

<span class="s">[alt_names]</span>
<span class="s">DNS.1 = myserver.example.com</span>
<span class="s">DNS.2 = *.myserver.example.com</span>
<span class="s">IP.1 = 192.168.1.100</span>
<span class="s">EOF</span>

<span class="c1"># Step 6: Sign the CSR with the CA key</span>
openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-sha256<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-in<span class="w"> </span>server.csr<span class="w"> </span>-CA<span class="w"> </span>ca.crt<span class="w"> </span>-CAkey<span class="w"> </span>ca.key<span class="w"> </span>-CAcreateserial<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-out<span class="w"> </span>server.crt<span class="w"> </span>-extfile<span class="w"> </span>server_ext.cnf

<span class="c1"># Step 7: Verify the certificate</span>
openssl<span class="w"> </span>verify<span class="w"> </span>-CAfile<span class="w"> </span>ca.crt<span class="w"> </span>server.crt

<span class="c1"># Step 8: View certificate details</span>
openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>server.crt<span class="w"> </span>-text<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-30

<span class="c1"># Step 9: Create fullchain (server cert + CA cert)</span>
cat<span class="w"> </span>server.crt<span class="w"> </span>ca.crt<span class="w"> </span>&gt;<span class="w"> </span>fullchain.crt
</code></pre></div>

<h3 id="113-ecdsa-certificates-smaller-faster">11.3 ECDSA Certificates (Smaller, Faster)<a class="header-link" href="#113-ecdsa-certificates-smaller-faster" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Generate ECDSA key (P-256 curve)</span>
openssl<span class="w"> </span>ecparam<span class="w"> </span>-genkey<span class="w"> </span>-name<span class="w"> </span>prime256v1<span class="w"> </span>-out<span class="w"> </span>server_ec.key

<span class="c1"># Or Ed25519 (if supported by your OpenSSL version)</span>
openssl<span class="w"> </span>genpkey<span class="w"> </span>-algorithm<span class="w"> </span>Ed25519<span class="w"> </span>-out<span class="w"> </span>server_ed25519.key

<span class="c1"># Create CSR with ECDSA key</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-sha256<span class="w"> </span>-key<span class="w"> </span>server_ec.key<span class="w"> </span>-out<span class="w"> </span>server_ec.csr<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=myserver.example.com&quot;</span>

<span class="c1"># Self-signed ECDSA certificate</span>
openssl<span class="w"> </span>req<span class="w"> </span>-x509<span class="w"> </span>-sha256<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span>-key<span class="w"> </span>server_ec.key<span class="w"> </span>-out<span class="w"> </span>server_ec.crt<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=localhost&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-addext<span class="w"> </span><span class="s2">&quot;subjectAltName=DNS:localhost,IP:127.0.0.1&quot;</span>

<span class="c1"># Compare sizes</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;RSA-2048 cert size:&quot;</span>
wc<span class="w"> </span>-c<span class="w"> </span>server.crt
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;ECDSA P-256 cert size:&quot;</span>
wc<span class="w"> </span>-c<span class="w"> </span>server_ec.crt
</code></pre></div>

<h3 id="114-client-certificate-for-mtls">11.4 Client Certificate for mTLS<a class="header-link" href="#114-client-certificate-for-mtls" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Generate client key</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>client.key<span class="w"> </span><span class="m">2048</span>

<span class="c1"># Create client CSR</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-sha256<span class="w"> </span>-key<span class="w"> </span>client.key<span class="w"> </span>-out<span class="w"> </span>client.csr<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=api-client-1/O=My App&quot;</span>

<span class="c1"># Sign with CA (note: extendedKeyUsage = clientAuth)</span>
cat<span class="w"> </span>&gt;<span class="w"> </span>client_ext.cnf<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s">basicConstraints=CA:FALSE</span>
<span class="s">keyUsage=digitalSignature</span>
<span class="s">extendedKeyUsage=clientAuth</span>
<span class="s">EOF</span>

openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-sha256<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-in<span class="w"> </span>client.csr<span class="w"> </span>-CA<span class="w"> </span>ca.crt<span class="w"> </span>-CAkey<span class="w"> </span>ca.key<span class="w"> </span>-CAcreateserial<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-out<span class="w"> </span>client.crt<span class="w"> </span>-extfile<span class="w"> </span>client_ext.cnf

<span class="c1"># Create PKCS12 bundle (for importing into browsers/apps)</span>
openssl<span class="w"> </span>pkcs12<span class="w"> </span>-export<span class="w"> </span>-out<span class="w"> </span>client.p12<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-inkey<span class="w"> </span>client.key<span class="w"> </span>-in<span class="w"> </span>client.crt<span class="w"> </span>-certfile<span class="w"> </span>ca.crt

<span class="c1"># Verify client cert</span>
openssl<span class="w"> </span>verify<span class="w"> </span>-CAfile<span class="w"> </span>ca.crt<span class="w"> </span>client.crt
</code></pre></div>

<hr />
<h2 id="12-common-misconfigurations">12. Common Misconfigurations<a class="header-link" href="#12-common-misconfigurations" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">         </span><span class="n">Common</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="n">Misconfigurations</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">How</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Fix</span><span class="w"> </span><span class="n">Them</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="c1"># â”‚ Misconfiguration             â”‚ Fix                              â”‚</span>
<span class="err">â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Legacy</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="n">versions</span><span class="w"> </span><span class="n">enabled</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Disable</span><span class="w"> </span><span class="n">SSL</span><span class="w"> </span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span><span class="mf">1.1</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">TLS</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="n">SSL</span><span class="w"> </span><span class="mf">3.0</span><span class="p">)</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="n">min_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TLSv1</span><span class="o">.</span><span class="mi">2</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Weak</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="n">suites</span><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">AEAD</span><span class="w"> </span><span class="n">ciphers</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">ECDHE</span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">RC4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="n">DES</span><span class="p">,</span><span class="w"> </span><span class="n">CBC</span><span class="w"> </span><span class="n">without</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Disable</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">FS</span><span class="w"> </span><span class="n">suites</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="n">AEAD</span><span class="p">,</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">RSA</span><span class="p">)</span><span class="w">          </span><span class="err">â”‚</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Self</span><span class="o">-</span><span class="n">signed</span><span class="w"> </span><span class="n">cert</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">prod</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">Let</span><span class="s1">&#39;s Encrypt (free!)       â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                              </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Self</span><span class="o">-</span><span class="n">signed</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">dev</span><span class="o">/</span><span class="n">testing</span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Expired</span><span class="w"> </span><span class="n">certificate</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Auto</span><span class="o">-</span><span class="n">renew</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">certbot</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                              </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Monitor</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="n">tools</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Missing</span><span class="w"> </span><span class="n">intermediate</span><span class="w"> </span><span class="n">cert</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Always</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">full</span><span class="w"> </span><span class="n">chain</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">incomplete</span><span class="w"> </span><span class="n">chain</span><span class="p">)</span><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">fullchain</span><span class="o">.</span><span class="n">pem</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">cert</span><span class="o">.</span><span class="n">pem</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">HSTS</span><span class="w"> </span><span class="n">header</span><span class="w">               </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">Strict</span><span class="o">-</span><span class="n">Transport</span><span class="o">-</span><span class="n">Security</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                              </span><span class="err">â”‚</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="nb">max</span><span class="o">-</span><span class="n">age</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">HTTP</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">HTTPS</span><span class="w"> </span><span class="n">redirect</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="n">permanent</span><span class="w"> </span><span class="n">redirect</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">missing</span><span class="w">                      </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Register</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">HSTS</span><span class="w"> </span><span class="nb">preload</span><span class="w"> </span><span class="n">list</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Private</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">too</span><span class="w"> </span><span class="n">permissive</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">chmod</span><span class="w"> </span><span class="mi">600</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">files</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">world</span><span class="o">-</span><span class="n">readable</span><span class="p">)</span><span class="w">             </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Own</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="w"> </span><span class="n">only</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="n">compression</span><span class="w"> </span><span class="n">enabled</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Disable</span><span class="w"> </span><span class="p">(</span><span class="n">prevents</span><span class="w"> </span><span class="n">CRIME</span><span class="w"> </span><span class="n">attack</span><span class="p">)</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                              </span><span class="err">â”‚</span><span class="w"> </span><span class="n">ssl_options</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">OP_NO_COMPRESSION</span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="mi">10</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">OCSP</span><span class="w"> </span><span class="n">stapling</span><span class="w">             </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Enable</span><span class="w"> </span><span class="n">OCSP</span><span class="w"> </span><span class="n">stapling</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">server</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                              </span><span class="err">â”‚</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="p">(</span><span class="n">improves</span><span class="w"> </span><span class="n">performance</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="mi">11</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Wildcard</span><span class="w"> </span><span class="n">cert</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">site</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">SAN</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">specific</span><span class="w"> </span><span class="n">domains</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                              </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Wildcards</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="mi">12</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Certificate</span><span class="w"> </span><span class="n">pinning</span><span class="w"> </span><span class="n">without</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">ALWAYS</span><span class="w"> </span><span class="n">include</span><span class="w"> </span><span class="n">backup</span><span class="w"> </span><span class="n">pins</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">backup</span><span class="w"> </span><span class="n">pins</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Or</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">CT</span><span class="w"> </span><span class="n">instead</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">pinning</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="121-security-headers-checklist">12.1 Security Headers Checklist<a class="header-link" href="#121-security-headers-checklist" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Recommended security headers for HTTPS sites</span>

<span class="n">SECURITY_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Force HTTPS for 2 years, include subdomains</span>
    <span class="s2">&quot;Strict-Transport-Security&quot;</span><span class="p">:</span> <span class="s2">&quot;max-age=63072000; includeSubDomains; preload&quot;</span><span class="p">,</span>

    <span class="c1"># Prevent MIME type sniffing</span>
    <span class="s2">&quot;X-Content-Type-Options&quot;</span><span class="p">:</span> <span class="s2">&quot;nosniff&quot;</span><span class="p">,</span>

    <span class="c1"># Prevent clickjacking</span>
    <span class="s2">&quot;X-Frame-Options&quot;</span><span class="p">:</span> <span class="s2">&quot;DENY&quot;</span><span class="p">,</span>

    <span class="c1"># Enable XSS filter (legacy browsers)</span>
    <span class="s2">&quot;X-XSS-Protection&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>  <span class="c1"># &quot;0&quot; is now recommended (CSP is better)</span>

    <span class="c1"># Content Security Policy</span>
    <span class="s2">&quot;Content-Security-Policy&quot;</span><span class="p">:</span> <span class="s2">&quot;default-src &#39;self&#39;; script-src &#39;self&#39;; style-src &#39;self&#39;&quot;</span><span class="p">,</span>

    <span class="c1"># Referrer Policy</span>
    <span class="s2">&quot;Referrer-Policy&quot;</span><span class="p">:</span> <span class="s2">&quot;strict-origin-when-cross-origin&quot;</span><span class="p">,</span>

    <span class="c1"># Permissions Policy (formerly Feature-Policy)</span>
    <span class="s2">&quot;Permissions-Policy&quot;</span><span class="p">:</span> <span class="s2">&quot;camera=(), microphone=(), geolocation=()&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Flask example</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">make_response</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_security_headers</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">SECURITY_HEADERS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<hr />
<h2 id="13-testing-tls-configurations">13. Testing TLS Configurations<a class="header-link" href="#13-testing-tls-configurations" title="Permanent link">&para;</a></h2>
<h3 id="131-command-line-tools">13.1 Command-Line Tools<a class="header-link" href="#131-command-line-tools" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Test TLS connection with OpenSSL s_client</span>
openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>example.com:443<span class="w"> </span>-servername<span class="w"> </span>example.com

<span class="c1"># Show full certificate chain</span>
openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>example.com:443<span class="w"> </span>-servername<span class="w"> </span>example.com<span class="w"> </span>-showcerts

<span class="c1"># Test specific TLS version</span>
openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>example.com:443<span class="w"> </span>-tls1_3
openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>example.com:443<span class="w"> </span>-tls1_2

<span class="c1"># Check certificate expiration</span>
<span class="nb">echo</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>example.com:443<span class="w"> </span>-servername<span class="w"> </span>example.com<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-noout<span class="w"> </span>-dates

<span class="c1"># Check supported cipher suites</span>
nmap<span class="w"> </span>--script<span class="w"> </span>ssl-enum-ciphers<span class="w"> </span>-p<span class="w"> </span><span class="m">443</span><span class="w"> </span>example.com

<span class="c1"># Test with testssl.sh (comprehensive scanner)</span>
<span class="c1"># git clone https://github.com/drwetter/testssl.sh.git</span>
./testssl.sh<span class="w"> </span>example.com

<span class="c1"># Test with sslyze</span>
pip<span class="w"> </span>install<span class="w"> </span>sslyze
sslyze<span class="w"> </span>example.com
</code></pre></div>

<h3 id="132-python-tls-scanner">13.2 Python TLS Scanner<a class="header-link" href="#132-python-tls-scanner" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TLSScanResult</span><span class="p">:</span>
    <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">supported_protocols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">certificate_info</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">cipher_suite</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">issues</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">recommendations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">scan_tls</span><span class="p">(</span><span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">443</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TLSScanResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Scan a server&#39;s TLS configuration.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">TLSScanResult</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>

    <span class="c1"># Test supported protocols</span>
    <span class="n">protocols</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;TLSv1.0&quot;</span><span class="p">:</span> <span class="n">ssl</span><span class="o">.</span><span class="n">TLSVersion</span><span class="o">.</span><span class="n">TLSv1</span><span class="p">,</span>
        <span class="s2">&quot;TLSv1.1&quot;</span><span class="p">:</span> <span class="n">ssl</span><span class="o">.</span><span class="n">TLSVersion</span><span class="o">.</span><span class="n">TLSv1_1</span><span class="p">,</span>
        <span class="s2">&quot;TLSv1.2&quot;</span><span class="p">:</span> <span class="n">ssl</span><span class="o">.</span><span class="n">TLSVersion</span><span class="o">.</span><span class="n">TLSv1_2</span><span class="p">,</span>
        <span class="s2">&quot;TLSv1.3&quot;</span><span class="p">:</span> <span class="n">ssl</span><span class="o">.</span><span class="n">TLSVersion</span><span class="o">.</span><span class="n">TLSv1_3</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">protocols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLS_CLIENT</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">minimum_version</span> <span class="o">=</span> <span class="n">version</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">maximum_version</span> <span class="o">=</span> <span class="n">version</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_default_certs</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssock</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">supported_protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;TLSv1.0&quot;</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;TLS 1.0 supported (deprecated)&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;TLSv1.1&quot;</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;TLS 1.1 supported (deprecated)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="ne">ConnectionRefusedError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
            <span class="k">pass</span>

    <span class="c1"># Get certificate and cipher info with best available protocol</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssock</span><span class="p">:</span>
                <span class="c1"># Protocol and cipher</span>
                <span class="n">result</span><span class="o">.</span><span class="n">cipher_suite</span> <span class="o">=</span> <span class="n">ssock</span><span class="o">.</span><span class="n">cipher</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Certificate info</span>
                <span class="n">cert</span> <span class="o">=</span> <span class="n">ssock</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                <span class="n">result</span><span class="o">.</span><span class="n">certificate_info</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span> <span class="p">())),</span>
                    <span class="s2">&quot;issuer&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;issuer&quot;</span><span class="p">,</span> <span class="p">())),</span>
                    <span class="s2">&quot;notAfter&quot;</span><span class="p">:</span> <span class="n">cert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notAfter&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;notBefore&quot;</span><span class="p">:</span> <span class="n">cert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notBefore&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;serialNumber&quot;</span><span class="p">:</span> <span class="n">cert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;serialNumber&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">cert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;san&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subjectAltName&quot;</span><span class="p">,</span> <span class="p">())</span>
                    <span class="p">],</span>
                <span class="p">}</span>

                <span class="c1"># Check expiration</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
                <span class="n">not_after</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">cert_time_to_seconds</span><span class="p">(</span><span class="n">cert</span><span class="p">[</span><span class="s2">&quot;notAfter&quot;</span><span class="p">])</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
                <span class="n">days_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">not_after</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">/</span> <span class="mi">86400</span>
                <span class="k">if</span> <span class="n">days_left</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Certificate EXPIRED </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">days_left</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> days ago!&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">days_left</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Certificate expires in </span><span class="si">{</span><span class="n">days_left</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> days!&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Generate recommendations</span>
    <span class="k">if</span> <span class="s2">&quot;TLSv1.3&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">supported_protocols</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Enable TLS 1.3 for better security and performance&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;TLSv1.0&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">supported_protocols</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Disable TLS 1.0 (deprecated since 2020)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;TLSv1.1&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">supported_protocols</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Disable TLS 1.1 (deprecated since 2020)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">issues</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Configuration looks good!&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span><span class="w"> </span><span class="nf">print_scan_result</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="n">TLSScanResult</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pretty-print a TLS scan result.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TLS Scan: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">hostname</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Supported Protocols:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">proto</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">supported_protocols</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;[!!]&quot;</span> <span class="k">if</span> <span class="s2">&quot;1.0&quot;</span> <span class="ow">in</span> <span class="n">proto</span> <span class="ow">or</span> <span class="s2">&quot;1.1&quot;</span> <span class="ow">in</span> <span class="n">proto</span> <span class="k">else</span> <span class="s2">&quot;[OK]&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">proto</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">cipher_suite</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Negotiated Cipher: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">cipher_suite</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">certificate_info</span><span class="p">:</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">certificate_info</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Certificate:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Subject: </span><span class="si">{</span><span class="n">ci</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;commonName&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Issuer:  </span><span class="si">{</span><span class="n">ci</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;issuer&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;commonName&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Valid:   </span><span class="si">{</span><span class="n">ci</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notBefore&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">ci</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notAfter&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ci</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;san&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SANs:    </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ci</span><span class="p">[</span><span class="s1">&#39;san&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">issues</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Issues (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">issues</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">issues</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [!!] </span><span class="si">{</span><span class="n">issue</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">recommendations</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recommendations:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">recommendations</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --&gt; </span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Run scan</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">scan_tls</span><span class="p">(</span><span class="s2">&quot;www.google.com&quot;</span><span class="p">)</span>
    <span class="n">print_scan_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scan failed (network required): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="133-continuous-certificate-monitoring">13.3 Continuous Certificate Monitoring<a class="header-link" href="#133-continuous-certificate-monitoring" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CertMonitorEntry</span><span class="p">:</span>
    <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">443</span>
    <span class="n">warning_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>   <span class="c1"># Warn if less than this many days left</span>
    <span class="n">critical_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span>   <span class="c1"># Critical if less than this many days</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CertificateMonitor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Monitor certificate expiration across multiple domains.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CertMonitorEntry</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_certificate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="n">CertMonitorEntry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check a single certificate&#39;s expiration.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span>
                <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span>
                    <span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">hostname</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">ssock</span><span class="p">:</span>
                    <span class="n">cert</span> <span class="o">=</span> <span class="n">ssock</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                    <span class="n">not_after</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">cert_time_to_seconds</span><span class="p">(</span><span class="n">cert</span><span class="p">[</span><span class="s2">&quot;notAfter&quot;</span><span class="p">])</span>
                    <span class="n">days_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">not_after</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">/</span> <span class="mi">86400</span>

                    <span class="k">if</span> <span class="n">days_left</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;EXPIRED&quot;</span>
                    <span class="k">elif</span> <span class="n">days_left</span> <span class="o">&lt;</span> <span class="n">entry</span><span class="o">.</span><span class="n">critical_days</span><span class="p">:</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;CRITICAL&quot;</span>
                    <span class="k">elif</span> <span class="n">days_left</span> <span class="o">&lt;</span> <span class="n">entry</span><span class="o">.</span><span class="n">warning_days</span><span class="p">:</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;WARNING&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;OK&quot;</span>

                    <span class="k">return</span> <span class="p">{</span>
                        <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                        <span class="s2">&quot;days_remaining&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">days_left</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="s2">&quot;expires&quot;</span><span class="p">:</span> <span class="n">cert</span><span class="p">[</span><span class="s2">&quot;notAfter&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;issuer&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cert</span><span class="p">[</span><span class="s2">&quot;issuer&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;commonName&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="n">ssock</span><span class="o">.</span><span class="n">version</span><span class="p">(),</span>
                    <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
            <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check all monitored certificates.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_certificate</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print a formatted monitoring report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Certificate Monitoring Report&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

        <span class="n">status_icons</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;OK&quot;</span><span class="p">:</span> <span class="s2">&quot;[OK]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;WARNING&quot;</span><span class="p">:</span> <span class="s2">&quot;[!!]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CRITICAL&quot;</span><span class="p">:</span> <span class="s2">&quot;[XX]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;EXPIRED&quot;</span><span class="p">:</span> <span class="s2">&quot;[XX]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ERROR&quot;</span><span class="p">:</span> <span class="s2">&quot;[??]&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;days_remaining&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">999</span><span class="p">)):</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="n">status_icons</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">],</span> <span class="s2">&quot;[??]&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;days_remaining&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">30s</span><span class="si">}</span><span class="s2"> &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;days_remaining&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">6.0f</span><span class="si">}</span><span class="s2"> days  &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">30s</span><span class="si">}</span><span class="s2"> &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;N/A&#39;</span><span class="si">:</span><span class="s2">&gt;6s</span><span class="si">}</span><span class="s2">       &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># Usage</span>
<span class="n">monitor</span> <span class="o">=</span> <span class="n">CertificateMonitor</span><span class="p">([</span>
    <span class="n">CertMonitorEntry</span><span class="p">(</span><span class="s2">&quot;www.google.com&quot;</span><span class="p">),</span>
    <span class="n">CertMonitorEntry</span><span class="p">(</span><span class="s2">&quot;github.com&quot;</span><span class="p">),</span>
    <span class="n">CertMonitorEntry</span><span class="p">(</span><span class="s2">&quot;expired.badssl.com&quot;</span><span class="p">),</span>  <span class="c1"># Known expired cert for testing</span>
<span class="p">])</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">check_all</span><span class="p">()</span>
    <span class="n">monitor</span><span class="o">.</span><span class="n">print_report</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Monitoring requires network access: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="14-exercises">14. Exercises<a class="header-link" href="#14-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-tls-handshake-trace-beginner">Exercise 1: TLS Handshake Trace (Beginner)<a class="header-link" href="#exercise-1-tls-handshake-trace-beginner" title="Permanent link">&para;</a></h3>
<p>Using <code>openssl s_client</code>, connect to three different websites and answer:
1. What TLS version was negotiated?
2. What cipher suite was selected?
3. How many certificates are in the chain?
4. What is the root CA?
5. When does the leaf certificate expire?</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Template command:</span>
<span class="nb">echo</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>&lt;host&gt;:443<span class="w"> </span>-servername<span class="w"> </span>&lt;host&gt;<span class="w"> </span><span class="m">2</span>&gt;/dev/null
</code></pre></div>

<p>Compare the results for: google.com, github.com, and letsencrypt.org.</p>
<h3 id="exercise-2-certificate-generation-lab-intermediate">Exercise 2: Certificate Generation Lab (Intermediate)<a class="header-link" href="#exercise-2-certificate-generation-lab-intermediate" title="Permanent link">&para;</a></h3>
<p>Using Python's <code>cryptography</code> library:
1. Create a Root CA with a 4096-bit RSA key (valid for 10 years)
2. Create an Intermediate CA signed by the Root (valid for 5 years)
3. Create a server certificate signed by the Intermediate (valid for 90 days)
4. Write all certificates and keys to PEM files
5. Verify the complete chain programmatically
6. Test the chain with <code>openssl verify</code></p>
<h3 id="exercise-3-mtls-service-intermediate">Exercise 3: mTLS Service (Intermediate)<a class="header-link" href="#exercise-3-mtls-service-intermediate" title="Permanent link">&para;</a></h3>
<p>Build a simple HTTP API protected by mTLS:
1. Create CA, server, and two client certificates
2. Write a Flask/HTTP server that requires client certificates
3. Extract the client's Common Name from the certificate
4. Implement authorization based on the client CN
5. Write a client that presents its certificate
6. Show that connections without a valid client cert are rejected</p>
<h3 id="exercise-4-tls-configuration-auditor-advanced">Exercise 4: TLS Configuration Auditor (Advanced)<a class="header-link" href="#exercise-4-tls-configuration-auditor-advanced" title="Permanent link">&para;</a></h3>
<p>Build a comprehensive TLS scanner that checks:
1. Supported TLS versions (flag TLS 1.0/1.1 as deprecated)
2. Supported cipher suites (flag weak ones)
3. Certificate chain completeness
4. Certificate expiration date
5. HSTS header presence and max-age
6. OCSP stapling status
7. Key size (flag RSA &lt; 2048 or ECDSA &lt; 256)
8. Forward secrecy support
9. Output a score (A+ to F) similar to SSL Labs</p>
<h3 id="exercise-5-certificate-monitoring-system-advanced">Exercise 5: Certificate Monitoring System (Advanced)<a class="header-link" href="#exercise-5-certificate-monitoring-system-advanced" title="Permanent link">&para;</a></h3>
<p>Build a production-quality certificate monitoring system:
1. Accept a list of domains from a YAML/JSON config file
2. Check certificate expiration on a schedule (cron-compatible)
3. Send alerts (email/Slack/webhook) when certificates are:
   - Expiring within 30 days (warning)
   - Expiring within 7 days (critical)
   - Already expired (emergency)
4. Track certificate changes (issuer changed, key changed)
5. Store history in SQLite for trend analysis
6. Generate an HTML report</p>
<h3 id="exercise-6-implement-simplified-tls-educational">Exercise 6: Implement Simplified TLS (Educational)<a class="header-link" href="#exercise-6-implement-simplified-tls-educational" title="Permanent link">&para;</a></h3>
<p>Build a simplified version of the TLS handshake (educational, not for production):
1. Client sends: supported cipher suites, random nonce, X25519 public key
2. Server responds: selected cipher, random nonce, X25519 public key, certificate
3. Both derive shared secret using X25519
4. Both derive encryption keys using HKDF
5. Server sends: signature over the handshake transcript
6. Client verifies the signature using the certificate's public key
7. Both exchange encrypted messages using AES-GCM</p>
<p>This exercise demonstrates the core mechanics of TLS 1.3 without the full complexity of the real protocol.</p>
<hr />
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li>Rescorla, E. (2018). <em>The Transport Layer Security (TLS) Protocol Version 1.3</em> (RFC 8446).</li>
<li>Mozilla Server Side TLS - https://wiki.mozilla.org/Security/Server_Side_TLS</li>
<li>SSL Labs Best Practices - https://github.com/ssllabs/research/wiki/SSL-and-TLS-Deployment-Best-Practices</li>
<li>Let's Encrypt Documentation - https://letsencrypt.org/docs/</li>
<li>RFC 8555: Automatic Certificate Management Environment (ACME)</li>
<li>RFC 6125: Representation and Verification of Domain-Based Application Service Identity</li>
<li>Bulletproof TLS and PKI (Ivan Ristic, 2022) - https://www.feistyduck.com/books/bulletproof-tls-and-pki/</li>
<li>Certificate Transparency - https://certificate.transparency.dev/</li>
<li>testssl.sh - https://testssl.sh/</li>
<li>Python <code>cryptography</code> library - https://cryptography.io/</li>
<li>BadSSL.com - https://badssl.com/ (test various TLS misconfigurations)</li>
</ul>
<hr />
<p><strong>Previous</strong>: <a href="./03_Hashing_and_Integrity.md">03. Hashing and Data Integrity</a> | <strong>Next</strong>: <a href="./05_Authentication.md">05. Authentication Systems</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/03_Hashing_and_Integrity.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Hashing and Data Integrity</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/05_Authentication.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">05. Authentication Systems</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}