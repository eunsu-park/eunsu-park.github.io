{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>05. Authentication Systems - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Security/">Security</a>
    <span class="separator">/</span>
    <span class="current">05. Authentication Systems</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>05. Authentication Systems</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/04_TLS_and_PKI.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">TLS/SSL and Public Key Infrastructure</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/06_Authorization.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">06. Authorization and Access Control</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#1-password-based-authentication">1. Password-Based Authentication</a><ul>
<li><a href="#11-the-password-problem">1.1 The Password Problem</a></li>
<li><a href="#12-why-not-store-plaintext-passwords">1.2 Why Not Store Plaintext Passwords?</a></li>
<li><a href="#13-hashing-salting-and-key-stretching">1.3 Hashing, Salting, and Key Stretching</a></li>
<li><a href="#14-python-implementation-password-hashing">1.4 Python Implementation: Password Hashing</a></li>
<li><a href="#15-password-policies">1.5 Password Policies</a></li>
</ul>
</li>
<li><a href="#2-multi-factor-authentication-mfa">2. Multi-Factor Authentication (MFA)</a><ul>
<li><a href="#21-authentication-factors">2.1 Authentication Factors</a></li>
<li><a href="#22-totp-time-based-one-time-password">2.2 TOTP (Time-Based One-Time Password)</a></li>
<li><a href="#23-fido2-webauthn">2.3 FIDO2 / WebAuthn</a></li>
</ul>
</li>
<li><a href="#3-oauth-20-and-openid-connect">3. OAuth 2.0 and OpenID Connect</a><ul>
<li><a href="#31-oauth-20-overview">3.1 OAuth 2.0 Overview</a></li>
<li><a href="#32-authorization-code-flow-most-common">3.2 Authorization Code Flow (Most Common)</a></li>
<li><a href="#33-authorization-code-flow-with-pkce">3.3 Authorization Code Flow with PKCE</a></li>
<li><a href="#34-openid-connect-oidc">3.4 OpenID Connect (OIDC)</a></li>
<li><a href="#35-python-example-oauth-20-client">3.5 Python Example: OAuth 2.0 Client</a></li>
</ul>
</li>
<li><a href="#4-session-management">4. Session Management</a><ul>
<li><a href="#41-server-side-sessions-cookie-based">4.1 Server-Side Sessions (Cookie-Based)</a></li>
<li><a href="#42-secure-cookie-attributes">4.2 Secure Cookie Attributes</a></li>
<li><a href="#43-session-security-best-practices">4.3 Session Security Best Practices</a></li>
</ul>
</li>
<li><a href="#5-json-web-tokens-jwt">5. JSON Web Tokens (JWT)</a><ul>
<li><a href="#51-jwt-structure">5.1 JWT Structure</a></li>
<li><a href="#52-jwt-signing-algorithms">5.2 JWT Signing Algorithms</a></li>
<li><a href="#53-python-jwt-implementation">5.3 Python JWT Implementation</a></li>
<li><a href="#54-common-jwt-pitfalls">5.4 Common JWT Pitfalls</a></li>
</ul>
</li>
<li><a href="#6-password-reset-flows">6. Password Reset Flows</a><ul>
<li><a href="#61-secure-password-reset-design">6.1 Secure Password Reset Design</a></li>
<li><a href="#62-implementation">6.2 Implementation</a></li>
</ul>
</li>
<li><a href="#7-biometric-authentication">7. Biometric Authentication</a><ul>
<li><a href="#71-overview">7.1 Overview</a></li>
<li><a href="#72-biometric-template-security">7.2 Biometric Template Security</a></li>
<li><a href="#73-biometric-tradeoffs">7.3 Biometric Tradeoffs</a></li>
</ul>
</li>
<li><a href="#8-authentication-architecture-patterns">8. Authentication Architecture Patterns</a><ul>
<li><a href="#81-choosing-the-right-pattern">8.1 Choosing the Right Pattern</a></li>
<li><a href="#82-centralized-authentication-auth-service-pattern">8.2 Centralized Authentication (Auth Service Pattern)</a></li>
</ul>
</li>
<li><a href="#9-exercises">9. Exercises</a><ul>
<li><a href="#exercise-1-implement-secure-password-storage">Exercise 1: Implement Secure Password Storage</a></li>
<li><a href="#exercise-2-totp-integration">Exercise 2: TOTP Integration</a></li>
<li><a href="#exercise-3-jwt-security-audit">Exercise 3: JWT Security Audit</a></li>
<li><a href="#exercise-4-oauth-20-flow-implementation">Exercise 4: OAuth 2.0 Flow Implementation</a></li>
<li><a href="#exercise-5-password-reset-security-review">Exercise 5: Password Reset Security Review</a></li>
</ul>
</li>
<li><a href="#10-summary">10. Summary</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="05-authentication-systems">05. Authentication Systems<a class="header-link" href="#05-authentication-systems" title="Permanent link">&para;</a></h1>
<p><strong>Previous</strong>: <a href="./04_TLS_and_PKI.md">04. TLS/SSL and Public Key Infrastructure</a> | <strong>Next</strong>: <a href="06_Authorization.md">06. Authorization and Access Control</a></p>
<hr />
<p>Authentication is the process of verifying that a user or system is who they claim to be. It answers the question "Who are you?" and is the foundation upon which all access control decisions rest. A poorly implemented authentication system can render even the most sophisticated authorization and encryption useless. This lesson covers password-based authentication, multi-factor authentication, token-based systems, OAuth 2.0/OIDC, session management, and biometric approaches, with practical Python examples throughout.</p>
<h2 id="learning-objectives">Learning Objectives<a class="header-link" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<ul>
<li>Implement secure password storage using salting and key stretching</li>
<li>Understand and implement multi-factor authentication (TOTP, FIDO2/WebAuthn)</li>
<li>Describe OAuth 2.0 and OpenID Connect authorization/authentication flows</li>
<li>Manage sessions securely using cookies, tokens, and JWTs</li>
<li>Identify and avoid common JWT pitfalls</li>
<li>Design secure password reset flows</li>
<li>Understand biometric authentication concepts and tradeoffs</li>
</ul>
<hr />
<h2 id="1-password-based-authentication">1. Password-Based Authentication<a class="header-link" href="#1-password-based-authentication" title="Permanent link">&para;</a></h2>
<h3 id="11-the-password-problem">1.1 The Password Problem<a class="header-link" href="#11-the-password-problem" title="Permanent link">&para;</a></h3>
<p>Passwords remain the most common authentication method despite their well-known weaknesses.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Password Authentication Flow                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   User                    Server                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚   â”‚ Form â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Receive  â”‚                          â”‚
â”‚   â”‚ user â”‚  username +    â”‚ username â”‚                           â”‚
â”‚   â”‚ pass â”‚  password      â”‚ + pass   â”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                â”‚                                 â”‚
â”‚                                â–¼                                 â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                         â”‚  Hash the    â”‚                        â”‚
â”‚                         â”‚  provided    â”‚                        â”‚
â”‚                         â”‚  password    â”‚                        â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                â”‚                                 â”‚
â”‚                                â–¼                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚  Compare hash to   â”‚                       â”‚
â”‚                    â”‚  stored hash in DB â”‚                       â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                             â”‚                                    â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                      â”‚             â”‚                             â”‚
â”‚                   Match?        No Match?                        â”‚
â”‚                      â”‚             â”‚                             â”‚
â”‚                      â–¼             â–¼                             â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                  â”‚ Grant  â”‚   â”‚ Deny   â”‚                        â”‚
â”‚                  â”‚ Access â”‚   â”‚ Access â”‚                        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="12-why-not-store-plaintext-passwords">1.2 Why Not Store Plaintext Passwords?<a class="header-link" href="#12-why-not-store-plaintext-passwords" title="Permanent link">&para;</a></h3>
<p>If an attacker gains access to your database (via SQL injection, backup theft, insider threat, etc.), plaintext passwords are immediately compromised. The principle of <strong>defense in depth</strong> requires that even a database breach does not directly expose user credentials.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">NEVER</span><span class="w"> </span><span class="n">DO</span><span class="w"> </span><span class="nl">THIS</span><span class="p">:</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">users</span><span class="w"> </span><span class="nc">table</span><span class="err">:</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">password</span><span class="w">       </span><span class="err">â”‚</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">alice</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">MyP</span><span class="nv">@ssw0rd</span><span class="err">!</span><span class="w">    </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â†</span><span class="w"> </span><span class="n">Plaintext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">catastrophe</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">bob</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="n">hunter2</span><span class="w">        </span><span class="err">â”‚</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nl">INSTEAD</span><span class="p">:</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">users</span><span class="w"> </span><span class="nc">table</span><span class="err">:</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">password_hash</span><span class="w">                                </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">alice</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span><span class="n">b</span><span class="err">$</span><span class="mi">12</span><span class="err">$</span><span class="n">LJ3m4ys3Lk0aB</span><span class="p">...</span><span class="w">  </span><span class="p">(</span><span class="n">bcrypt</span><span class="w"> </span><span class="n">hash</span><span class="p">)</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">bob</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="err">$</span><span class="n">argon2id</span><span class="err">$</span><span class="n">v</span><span class="o">=</span><span class="mi">19</span><span class="err">$</span><span class="n">m</span><span class="o">=</span><span class="mf">65536.</span><span class="p">..</span><span class="w"> </span><span class="p">(</span><span class="n">argon2</span><span class="w"> </span><span class="n">hash</span><span class="p">)</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="13-hashing-salting-and-key-stretching">1.3 Hashing, Salting, and Key Stretching<a class="header-link" href="#13-hashing-salting-and-key-stretching" title="Permanent link">&para;</a></h3>
<p><strong>Hashing</strong> converts a password into a fixed-length string. But simple hashing (MD5, SHA-256) is vulnerable to rainbow tables and brute force.</p>
<p><strong>Salting</strong> adds a unique random value to each password before hashing, defeating rainbow tables.</p>
<p><strong>Key Stretching</strong> applies the hash function thousands or millions of times, making brute force computationally expensive.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="n">Password</span><span class="w"> </span><span class="n">Hashing</span><span class="w"> </span><span class="n">Pipeline</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="ss">&quot;MyP@ssw0rd!&quot;</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">        </span><span class="err">â”‚</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">        </span><span class="err">â–¼</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Generate</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w">  </span><span class="n">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;x9Kp2mQ...&quot;</span><span class="w">  </span><span class="p">(</span><span class="n">random</span><span class="p">,</span><span class="w"> </span><span class="k">unique</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Random</span><span class="w"> </span><span class="n">Salt</span><span class="w"> </span><span class="err">â”‚</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w">                                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">          </span><span class="err">â–¼</span><span class="w">                                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Concatenate</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w">  </span><span class="ss">&quot;x9Kp2mQ...&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;MyP@ssw0rd!&quot;</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="n">salt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="err">â”‚</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w">                                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">          </span><span class="err">â–¼</span><span class="w">                                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="k">Key</span><span class="w"> </span><span class="n">Stretching</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w">  </span><span class="n">Apply</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="mi">000</span><span class="o">+</span><span class="w"> </span><span class="n">iterations</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="n">bcrypt</span><span class="o">/</span><span class="n">argon2</span><span class="p">)</span><span class="w"> </span><span class="err">â”‚</span><span class="w">      </span><span class="ow">or</span><span class="w"> </span><span class="n">memory</span><span class="o">-</span><span class="n">hard</span><span class="w"> </span><span class="k">function</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w">                                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">          </span><span class="err">â–¼</span><span class="w">                                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="ss">&quot;$2b$12$x9Kp2mQ.../hashed_output&quot;</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="p">(</span><span class="n">salt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="n">together</span><span class="p">)</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<p><strong>Recommended Algorithms (in order of preference):</strong></p>
<table>
<thead>
<tr>
<th>Algorithm</th>
<th>Type</th>
<th>Key Feature</th>
<th>Recommended Parameters</th>
</tr>
</thead>
<tbody>
<tr>
<td>Argon2id</td>
<td>Memory-hard</td>
<td>GPU/ASIC resistant</td>
<td>m=65536, t=3, p=4</td>
</tr>
<tr>
<td>bcrypt</td>
<td>CPU-hard</td>
<td>Widely supported</td>
<td>cost factor 12+</td>
</tr>
<tr>
<td>scrypt</td>
<td>Memory-hard</td>
<td>Good alternative</td>
<td>N=2^15, r=8, p=1</td>
</tr>
<tr>
<td>PBKDF2</td>
<td>Iteration-based</td>
<td>NIST approved</td>
<td>600,000+ iterations (SHA-256)</td>
</tr>
</tbody>
</table>
<h3 id="14-python-implementation-password-hashing">1.4 Python Implementation: Password Hashing<a class="header-link" href="#14-python-implementation-password-hashing" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">password_hashing.py - Secure password storage with bcrypt and argon2</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">bcrypt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Method 1: bcrypt (most widely used)</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">hash_password_bcrypt</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hash a password using bcrypt with automatic salting.&quot;&quot;&quot;</span>
    <span class="c1"># bcrypt automatically generates a salt and includes it in the output</span>
    <span class="c1"># The cost factor (rounds) controls computation time: 2^rounds iterations</span>
    <span class="n">password_bytes</span> <span class="o">=</span> <span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">salt</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">gensalt</span><span class="p">(</span><span class="n">rounds</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>  <span class="c1"># 2^12 = 4096 iterations</span>
    <span class="n">hashed</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">password_bytes</span><span class="p">,</span> <span class="n">salt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hashed</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">verify_password_bcrypt</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stored_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify a password against a bcrypt hash.&quot;&quot;&quot;</span>
    <span class="n">password_bytes</span> <span class="o">=</span> <span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">stored_bytes</span> <span class="o">=</span> <span class="n">stored_hash</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="n">password_bytes</span><span class="p">,</span> <span class="n">stored_bytes</span><span class="p">)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Method 2: Argon2 (recommended by OWASP)</span>
<span class="c1"># ==============================================================</span>

<span class="c1"># pip install argon2-cffi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">argon2</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHasher</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">argon2.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">VerifyMismatchError</span>

<span class="k">def</span><span class="w"> </span><span class="nf">hash_password_argon2</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hash a password using Argon2id.&quot;&quot;&quot;</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">PasswordHasher</span><span class="p">(</span>
        <span class="n">time_cost</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>        <span class="c1"># Number of iterations</span>
        <span class="n">memory_cost</span><span class="o">=</span><span class="mi">65536</span><span class="p">,</span>   <span class="c1"># 64 MB of memory</span>
        <span class="n">parallelism</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>       <span class="c1"># Number of parallel threads</span>
        <span class="n">hash_len</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>         <span class="c1"># Length of the hash output</span>
        <span class="n">salt_len</span><span class="o">=</span><span class="mi">16</span>          <span class="c1"># Length of the random salt</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ph</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">verify_password_argon2</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stored_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify a password against an Argon2 hash.&quot;&quot;&quot;</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">PasswordHasher</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ph</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">stored_hash</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">VerifyMismatchError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Method 3: PBKDF2 (built into Python, no external deps)</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">hash_password_pbkdf2</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hash a password using PBKDF2-HMAC-SHA256.&quot;&quot;&quot;</span>
    <span class="n">salt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>  <span class="c1"># 32-byte random salt</span>
    <span class="n">iterations</span> <span class="o">=</span> <span class="mi">600_000</span>   <span class="c1"># OWASP recommended minimum for SHA-256</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">pbkdf2_hmac</span><span class="p">(</span>
        <span class="s1">&#39;sha256&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
        <span class="n">salt</span><span class="p">,</span>
        <span class="n">iterations</span><span class="p">,</span>
        <span class="n">dklen</span><span class="o">=</span><span class="mi">32</span>
    <span class="p">)</span>

    <span class="c1"># Store salt + iterations + hash together</span>
    <span class="c1"># Format: iterations$salt_hex$hash_hex</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="s2">$</span><span class="si">{</span><span class="n">salt</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">$</span><span class="si">{</span><span class="n">key</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">verify_password_pbkdf2</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stored</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify a password against a PBKDF2 hash.&quot;&quot;&quot;</span>
    <span class="n">iterations_str</span><span class="p">,</span> <span class="n">salt_hex</span><span class="p">,</span> <span class="n">hash_hex</span> <span class="o">=</span> <span class="n">stored</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)</span>
    <span class="n">iterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">iterations_str</span><span class="p">)</span>
    <span class="n">salt</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">salt_hex</span><span class="p">)</span>
    <span class="n">stored_key</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">hash_hex</span><span class="p">)</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">pbkdf2_hmac</span><span class="p">(</span>
        <span class="s1">&#39;sha256&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
        <span class="n">salt</span><span class="p">,</span>
        <span class="n">iterations</span><span class="p">,</span>
        <span class="n">dklen</span><span class="o">=</span><span class="mi">32</span>
    <span class="p">)</span>

    <span class="c1"># Use constant-time comparison to prevent timing attacks</span>
    <span class="k">return</span> <span class="n">secrets</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">stored_key</span><span class="p">)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Demo</span>
<span class="c1"># ==============================================================</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_password</span> <span class="o">=</span> <span class="s2">&quot;MySecureP@ssw0rd!&quot;</span>

    <span class="c1"># bcrypt</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== bcrypt ===&quot;</span><span class="p">)</span>
    <span class="n">hashed</span> <span class="o">=</span> <span class="n">hash_password_bcrypt</span><span class="p">(</span><span class="n">test_password</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash: </span><span class="si">{</span><span class="n">hashed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verify (correct): </span><span class="si">{</span><span class="n">verify_password_bcrypt</span><span class="p">(</span><span class="n">test_password</span><span class="p">,</span><span class="w"> </span><span class="n">hashed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verify (wrong):   </span><span class="si">{</span><span class="n">verify_password_bcrypt</span><span class="p">(</span><span class="s1">&#39;wrong&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">hashed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Argon2</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Argon2id ===&quot;</span><span class="p">)</span>
    <span class="n">hashed</span> <span class="o">=</span> <span class="n">hash_password_argon2</span><span class="p">(</span><span class="n">test_password</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash: </span><span class="si">{</span><span class="n">hashed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verify (correct): </span><span class="si">{</span><span class="n">verify_password_argon2</span><span class="p">(</span><span class="n">test_password</span><span class="p">,</span><span class="w"> </span><span class="n">hashed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verify (wrong):   </span><span class="si">{</span><span class="n">verify_password_argon2</span><span class="p">(</span><span class="s1">&#39;wrong&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">hashed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># PBKDF2</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== PBKDF2 ===&quot;</span><span class="p">)</span>
    <span class="n">hashed</span> <span class="o">=</span> <span class="n">hash_password_pbkdf2</span><span class="p">(</span><span class="n">test_password</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash: </span><span class="si">{</span><span class="n">hashed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verify (correct): </span><span class="si">{</span><span class="n">verify_password_pbkdf2</span><span class="p">(</span><span class="n">test_password</span><span class="p">,</span><span class="w"> </span><span class="n">hashed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verify (wrong):   </span><span class="si">{</span><span class="n">verify_password_pbkdf2</span><span class="p">(</span><span class="s1">&#39;wrong&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">hashed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="15-password-policies">1.5 Password Policies<a class="header-link" href="#15-password-policies" title="Permanent link">&para;</a></h3>
<p>Strong passwords alone are insufficient. A comprehensive password policy includes:</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">               </span><span class="nv">Modern</span><span class="w"> </span><span class="nv">Password</span><span class="w"> </span><span class="nv">Policy</span><span class="w"> </span><span class="ss">(</span><span class="nv">NIST</span><span class="w"> </span><span class="nv">SP</span><span class="w"> </span><span class="mi">800</span><span class="o">-</span><span class="mi">63</span><span class="nv">B</span><span class="ss">)</span><span class="w">           </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="k">DO</span>:<span class="w">                                                             </span>â”‚
â”‚<span class="w">  </span>âœ“<span class="w"> </span><span class="nv">Minimum</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="nv">characters</span><span class="w"> </span><span class="ss">(</span><span class="mi">12</span><span class="o">+</span><span class="w"> </span><span class="nv">recommended</span><span class="ss">)</span><span class="w">                       </span>â”‚
â”‚<span class="w">  </span>âœ“<span class="w"> </span><span class="nv">Maximum</span><span class="w"> </span><span class="mi">64</span><span class="o">+</span><span class="w"> </span><span class="nv">characters</span><span class="w"> </span><span class="nv">allowed</span><span class="w">                               </span>â”‚
â”‚<span class="w">  </span>âœ“<span class="w"> </span><span class="nv">Allow</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">printable</span><span class="w"> </span><span class="nv">ASCII</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">Unicode</span><span class="w"> </span><span class="nv">characters</span><span class="w">                </span>â”‚
â”‚<span class="w">  </span>âœ“<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="nv">against</span><span class="w"> </span><span class="nv">breached</span><span class="w"> </span><span class="nv">password</span><span class="w"> </span><span class="nv">lists</span><span class="w"> </span><span class="ss">(</span><span class="nv">haveibeenpwned</span>.<span class="nv">com</span><span class="ss">)</span><span class="w">    </span>â”‚
â”‚<span class="w">  </span>âœ“<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="nv">against</span><span class="w"> </span><span class="nv">common</span><span class="w"> </span><span class="nv">passwords</span><span class="w"> </span><span class="ss">(</span><span class="nv">password</span>,<span class="w"> </span><span class="mi">123456</span>,<span class="w"> </span><span class="nv">etc</span>.<span class="ss">)</span><span class="w">      </span>â”‚
â”‚<span class="w">  </span>âœ“<span class="w"> </span><span class="nv">Allow</span><span class="w"> </span><span class="nv">paste</span><span class="w"> </span><span class="nv">into</span><span class="w"> </span><span class="nv">password</span><span class="w"> </span><span class="nv">fields</span><span class="w"> </span><span class="ss">(</span><span class="k">for</span><span class="w"> </span><span class="nv">password</span><span class="w"> </span><span class="nv">managers</span><span class="ss">)</span><span class="w">      </span>â”‚
â”‚<span class="w">  </span>âœ“<span class="w"> </span><span class="k">Show</span><span class="w"> </span><span class="nv">password</span><span class="w"> </span><span class="nv">strength</span><span class="w"> </span><span class="nv">meter</span><span class="w">                                  </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="nv">DON</span><span class="err">&#39;T:                                                          â”‚</span>
<span class="err">â”‚  âœ— Force arbitrary complexity rules (uppercase + number + ...)   â”‚</span>
<span class="err">â”‚  âœ— Force periodic password rotation (unless breach suspected)    â”‚</span>
<span class="err">â”‚  âœ— Use password hints or knowledge-based questions               â”‚</span>
<span class="err">â”‚  âœ— Truncate passwords silently                                   â”‚</span>
<span class="err">â”‚  âœ— Use SMS for password recovery (SIM swapping attacks)          â”‚</span>
<span class="err">â”‚                                                                  â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">password_policy.py - Modern password validation per NIST guidelines</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span>


<span class="c1"># Common passwords list (top 20 - in practice, use a much larger list)</span>
<span class="n">COMMON_PASSWORDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">,</span> <span class="s2">&quot;123456789&quot;</span><span class="p">,</span> <span class="s2">&quot;12345678&quot;</span><span class="p">,</span> <span class="s2">&quot;12345&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1234567&quot;</span><span class="p">,</span> <span class="s2">&quot;qwerty&quot;</span><span class="p">,</span> <span class="s2">&quot;abc123&quot;</span><span class="p">,</span> <span class="s2">&quot;password1&quot;</span><span class="p">,</span> <span class="s2">&quot;111111&quot;</span><span class="p">,</span>
    <span class="s2">&quot;iloveyou&quot;</span><span class="p">,</span> <span class="s2">&quot;1234567890&quot;</span><span class="p">,</span> <span class="s2">&quot;123123&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;letmein&quot;</span><span class="p">,</span>
    <span class="s2">&quot;welcome&quot;</span><span class="p">,</span> <span class="s2">&quot;monkey&quot;</span><span class="p">,</span> <span class="s2">&quot;dragon&quot;</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">,</span> <span class="s2">&quot;000000&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_password_strength</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate password against modern security guidelines.</span>
<span class="sd">    Returns (is_valid, list_of_issues).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Length check (NIST minimum: 8, recommended: 12+)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Password must be at least 8 characters long&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
        <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Warning: 12+ characters recommended for better security&quot;</span><span class="p">)</span>

    <span class="c1"># Common password check</span>
    <span class="k">if</span> <span class="n">password</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">COMMON_PASSWORDS</span><span class="p">:</span>
        <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;This is a commonly used password&quot;</span><span class="p">)</span>

    <span class="c1"># Repetitive pattern check</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(.)\1+$&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Password cannot be a single repeated character&quot;</span><span class="p">)</span>

    <span class="c1"># Sequential pattern check</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(012|123|234|345|456|567|678|789|890)&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Warning: Contains sequential number pattern&quot;</span><span class="p">)</span>

    <span class="c1"># Context-specific check (would include username, email, etc.)</span>
    <span class="c1"># In production, also check against the user&#39;s personal info</span>

    <span class="n">is_valid</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
        <span class="ow">not</span> <span class="n">issue</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Warning&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">issues</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">is_valid</span><span class="p">,</span> <span class="n">issues</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_breached_password</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if password appears in known breaches using the</span>
<span class="sd">    Have I Been Pwned API (k-anonymity model - only first 5</span>
<span class="sd">    chars of SHA-1 hash are sent).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sha1</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;https://api.pwnedpasswords.com/range/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

        <span class="c1"># Response contains lines of &quot;SUFFIX:COUNT&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">hash_suffix</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hash_suffix</span> <span class="o">==</span> <span class="n">suffix</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Password has been breached</span>

        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Password not found in breaches</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span><span class="p">:</span>
        <span class="c1"># If API is unavailable, fail open (but log the error)</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_passwords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;short&quot;</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MyStr0ng&amp;Secure!Pass&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aaaaaaaaaaaa&quot;</span><span class="p">,</span>
        <span class="s2">&quot;12345678&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">pwd</span> <span class="ow">in</span> <span class="n">test_passwords</span><span class="p">:</span>
        <span class="n">is_valid</span><span class="p">,</span> <span class="n">issues</span> <span class="o">=</span> <span class="n">check_password_strength</span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;PASS&quot;</span> <span class="k">if</span> <span class="n">is_valid</span> <span class="k">else</span> <span class="s2">&quot;FAIL&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">] &#39;</span><span class="si">{</span><span class="n">pwd</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">issues</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">issue</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="2-multi-factor-authentication-mfa">2. Multi-Factor Authentication (MFA)<a class="header-link" href="#2-multi-factor-authentication-mfa" title="Permanent link">&para;</a></h2>
<h3 id="21-authentication-factors">2.1 Authentication Factors<a class="header-link" href="#21-authentication-factors" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Authentication Factors                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Factor 1: Something You KNOW                                    â”‚
â”‚  â”œâ”€â”€ Password                                                    â”‚
â”‚  â”œâ”€â”€ PIN                                                         â”‚
â”‚  â””â”€â”€ Security questions (discouraged)                            â”‚
â”‚                                                                  â”‚
â”‚  Factor 2: Something You HAVE                                    â”‚
â”‚  â”œâ”€â”€ Smartphone (TOTP app)                                       â”‚
â”‚  â”œâ”€â”€ Hardware security key (YubiKey, Titan)                      â”‚
â”‚  â”œâ”€â”€ Smart card                                                  â”‚
â”‚  â””â”€â”€ SMS (weak - SIM swapping risk)                              â”‚
â”‚                                                                  â”‚
â”‚  Factor 3: Something You ARE                                     â”‚
â”‚  â”œâ”€â”€ Fingerprint                                                 â”‚
â”‚  â”œâ”€â”€ Face recognition                                            â”‚
â”‚  â”œâ”€â”€ Iris scan                                                   â”‚
â”‚  â””â”€â”€ Voice recognition                                           â”‚
â”‚                                                                  â”‚
â”‚  MFA = Combining 2+ different factors                            â”‚
â”‚  (password + TOTP = 2FA, but two passwords â‰  2FA)               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="22-totp-time-based-one-time-password">2.2 TOTP (Time-Based One-Time Password)<a class="header-link" href="#22-totp-time-based-one-time-password" title="Permanent link">&para;</a></h3>
<p>TOTP generates a short-lived code based on a shared secret and the current time. Defined in RFC 6238.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                     </span><span class="nv">TOTP</span><span class="w"> </span><span class="nv">Algorithm</span><span class="w">                                </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="nv">Setup</span><span class="w"> </span><span class="ss">(</span><span class="nv">one</span><span class="o">-</span><span class="nv">time</span><span class="ss">)</span>:<span class="w">                                               </span>â”‚
â”‚<span class="w">  </span><span class="mi">1</span>.<span class="w"> </span><span class="nv">Server</span><span class="w"> </span><span class="nv">generates</span><span class="w"> </span><span class="k">random</span><span class="w"> </span><span class="nv">secret</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="ss">(</span><span class="nv">base32</span><span class="w"> </span><span class="nv">encoded</span><span class="ss">)</span><span class="w">          </span>â”‚
â”‚<span class="w">  </span><span class="mi">2</span>.<span class="w"> </span><span class="nv">Server</span><span class="w"> </span><span class="nv">shares</span><span class="w"> </span><span class="nv">secret</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">user</span><span class="w"> </span><span class="nv">via</span><span class="w"> </span><span class="nv">QR</span><span class="w"> </span><span class="nv">code</span><span class="w">                   </span>â”‚
â”‚<span class="w">  </span><span class="mi">3</span>.<span class="w"> </span><span class="nv">User</span><span class="w"> </span><span class="nv">scans</span><span class="w"> </span><span class="nv">QR</span><span class="w"> </span><span class="nv">code</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">authenticator</span><span class="w"> </span><span class="nv">app</span><span class="w">                    </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="nv">Verification</span><span class="w"> </span><span class="ss">(</span><span class="nv">each</span><span class="w"> </span><span class="nv">login</span><span class="ss">)</span>:<span class="w">                                      </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">       </span><span class="nv">Shared</span><span class="w"> </span><span class="nv">Secret</span><span class="w">              </span><span class="nv">Current</span><span class="w"> </span><span class="nv">Time</span><span class="w">                    </span>â”‚
â”‚<span class="w">            </span>â”‚<span class="w">                          </span>â”‚<span class="w">                          </span>â”‚
â”‚<span class="w">            </span>â–¼<span class="w">                          </span>â–¼<span class="w">                          </span>â”‚
â”‚<span class="w">       </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">            </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">                   </span>â”‚
â”‚<span class="w">       </span>â”‚<span class="w"> </span><span class="nv">Secret</span><span class="w">  </span>â”‚<span class="w">            </span>â”‚<span class="w">  </span><span class="nv">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">floor</span><span class="w">   </span>â”‚<span class="w">                   </span>â”‚
â”‚<span class="w">       </span>â”‚<span class="w">  </span><span class="nv">Key</span><span class="w">    </span>â”‚<span class="w">            </span>â”‚<span class="w">  </span><span class="ss">(</span><span class="nv">time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">30</span><span class="ss">)</span><span class="w"> </span>â”‚<span class="w">                   </span>â”‚
â”‚<span class="w">       </span>â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜<span class="w">            </span>â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">                   </span>â”‚
â”‚<span class="w">            </span>â”‚<span class="w">                        </span>â”‚<span class="w">                            </span>â”‚
â”‚<span class="w">            </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">                            </span>â”‚
â”‚<span class="w">                     </span>â”‚<span class="w">                                            </span>â”‚
â”‚<span class="w">                     </span>â–¼<span class="w">                                            </span>â”‚
â”‚<span class="w">              </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">                                    </span>â”‚
â”‚<span class="w">              </span>â”‚<span class="w"> </span><span class="nv">HMAC</span><span class="o">-</span><span class="nv">SHA1</span><span class="w">   </span>â”‚<span class="w">                                    </span>â”‚
â”‚<span class="w">              </span>â”‚<span class="w"> </span><span class="ss">(</span><span class="nv">secret</span>,<span class="w"> </span><span class="nv">T</span><span class="ss">)</span><span class="w"> </span>â”‚<span class="w">                                    </span>â”‚
â”‚<span class="w">              </span>â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜<span class="w">                                    </span>â”‚
â”‚<span class="w">                     </span>â”‚<span class="w">                                            </span>â”‚
â”‚<span class="w">                     </span>â–¼<span class="w">                                            </span>â”‚
â”‚<span class="w">              </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">                                    </span>â”‚
â”‚<span class="w">              </span>â”‚<span class="w"> </span><span class="nv">Truncate</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span>â”‚<span class="w">                                    </span>â”‚
â”‚<span class="w">              </span>â”‚<span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="nv">digits</span><span class="w">   </span>â”‚<span class="w">                                    </span>â”‚
â”‚<span class="w">              </span>â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜<span class="w">                                    </span>â”‚
â”‚<span class="w">                     </span>â”‚<span class="w">                                            </span>â”‚
â”‚<span class="w">                     </span>â–¼<span class="w">                                            </span>â”‚
â”‚<span class="w">                  </span><span class="s2">&quot;482916&quot;</span><span class="w">   </span><span class="ss">(</span><span class="nv">valid</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="nv">seconds</span><span class="ss">)</span><span class="w">              </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">totp_example.py - TOTP implementation using pyotp</span>
<span class="sd">pip install pyotp qrcode[pil]</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyotp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">qrcode</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TOTPManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manage TOTP-based two-factor authentication.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secrets</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># In production, store in encrypted database</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">enroll_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">issuer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;MyApp&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a TOTP secret for a new user.</span>
<span class="sd">        Returns the provisioning URI for QR code generation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate a random base32 secret (160 bits)</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="n">pyotp</span><span class="o">.</span><span class="n">random_base32</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secrets</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">secret</span>

        <span class="c1"># Generate provisioning URI for authenticator apps</span>
        <span class="n">totp</span> <span class="o">=</span> <span class="n">pyotp</span><span class="o">.</span><span class="n">TOTP</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">totp</span><span class="o">.</span><span class="n">provisioning_uri</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
            <span class="n">issuer_name</span><span class="o">=</span><span class="n">issuer</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">uri</span><span class="p">,</span> <span class="n">secret</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_qr_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;totp_qr.png&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a QR code image from the provisioning URI.&quot;&quot;&quot;</span>
        <span class="n">qr</span> <span class="o">=</span> <span class="n">qrcode</span><span class="o">.</span><span class="n">QRCode</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">box_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">qr</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="n">qr</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">qr</span><span class="o">.</span><span class="n">make_image</span><span class="p">(</span><span class="n">fill_color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">back_color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;QR code saved to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">verify_totp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify a TOTP code for the given user.</span>
<span class="sd">        Allows 1 period of clock drift (Â±30 seconds).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">secrets</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secrets</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
        <span class="n">totp</span> <span class="o">=</span> <span class="n">pyotp</span><span class="o">.</span><span class="n">TOTP</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span>

        <span class="c1"># valid_window=1 allows codes from t-1 and t+1 periods</span>
        <span class="k">return</span> <span class="n">totp</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">valid_window</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current TOTP code (for testing only).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">secrets</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secrets</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
        <span class="n">totp</span> <span class="o">=</span> <span class="n">pyotp</span><span class="o">.</span><span class="n">TOTP</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">totp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>


<span class="c1"># Backup codes for account recovery</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_backup_codes</span><span class="p">(</span><span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate one-time-use backup codes.</span>
<span class="sd">    Each code is 8 characters, alphanumeric.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
    <span class="n">codes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="c1"># 8 hex characters</span>
        <span class="c1"># Format as XXXX-XXXX for readability</span>
        <span class="n">formatted</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">code</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">code</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">codes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatted</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">codes</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">TOTPManager</span><span class="p">()</span>

    <span class="c1"># Enroll user</span>
    <span class="n">uri</span><span class="p">,</span> <span class="n">secret</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">enroll_user</span><span class="p">(</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Secret: </span><span class="si">{</span><span class="n">secret</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;URI: </span><span class="si">{</span><span class="n">uri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Generate current code</span>
    <span class="n">current_code</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_current_code</span><span class="p">(</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Current TOTP code: </span><span class="si">{</span><span class="n">current_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Verify</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verification: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">verify_totp</span><span class="p">(</span><span class="s1">&#39;alice@example.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">current_code</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong code:   </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">verify_totp</span><span class="p">(</span><span class="s1">&#39;alice@example.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;000000&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Generate backup codes</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Backup Codes:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">generate_backup_codes</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="23-fido2-webauthn">2.3 FIDO2 / WebAuthn<a class="header-link" href="#23-fido2-webauthn" title="Permanent link">&para;</a></h3>
<p>FIDO2 (Fast Identity Online) and its web component WebAuthn represent the strongest form of authentication available today. They use public-key cryptography and are phishing-resistant.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  WebAuthn Registration Flow                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Browser (Client)           Server (Relying Party)              â”‚
â”‚        â”‚                          â”‚                              â”‚
â”‚        â”‚   1. Request challenge   â”‚                              â”‚
â”‚        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚                              â”‚
â”‚        â”‚                          â”‚                              â”‚
â”‚        â”‚   2. Challenge +         â”‚                              â”‚
â”‚        â”‚      RP info + user info â”‚                              â”‚
â”‚        â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                              â”‚
â”‚        â”‚                          â”‚                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                     â”‚                              â”‚
â”‚   â”‚ Browser â”‚                     â”‚                              â”‚
â”‚   â”‚ prompts â”‚                     â”‚                              â”‚
â”‚   â”‚ user to â”‚                     â”‚                              â”‚
â”‚   â”‚ touch   â”‚                     â”‚                              â”‚
â”‚   â”‚ key or  â”‚                     â”‚                              â”‚
â”‚   â”‚ use     â”‚                     â”‚                              â”‚
â”‚   â”‚ biometr.â”‚                     â”‚                              â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                     â”‚                              â”‚
â”‚        â”‚                          â”‚                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚                              â”‚
â”‚   â”‚ Authenticator     â”‚          â”‚                              â”‚
â”‚   â”‚ generates new     â”‚          â”‚                              â”‚
â”‚   â”‚ key pair:         â”‚          â”‚                              â”‚
â”‚   â”‚ - Private key     â”‚          â”‚                              â”‚
â”‚   â”‚   (stored in key) â”‚          â”‚                              â”‚
â”‚   â”‚ - Public key      â”‚          â”‚                              â”‚
â”‚   â”‚   (sent to server)â”‚          â”‚                              â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚                              â”‚
â”‚        â”‚                          â”‚                              â”‚
â”‚        â”‚   3. Public key +        â”‚                              â”‚
â”‚        â”‚      signed challenge    â”‚                              â”‚
â”‚        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚                              â”‚
â”‚        â”‚                          â”‚                              â”‚
â”‚        â”‚                    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                       â”‚
â”‚        â”‚                    â”‚ Verify    â”‚                        â”‚
â”‚        â”‚                    â”‚ signature â”‚                        â”‚
â”‚        â”‚                    â”‚ Store     â”‚                        â”‚
â”‚        â”‚                    â”‚ public keyâ”‚                        â”‚
â”‚        â”‚                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚        â”‚                          â”‚                              â”‚
â”‚        â”‚   4. Registration OK     â”‚                              â”‚
â”‚        â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                              â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>Key advantages of WebAuthn:</strong></p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Passwords</th>
<th>TOTP</th>
<th>WebAuthn/FIDO2</th>
</tr>
</thead>
<tbody>
<tr>
<td>Phishing resistant</td>
<td>No</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr>
<td>No shared secrets on server</td>
<td>No</td>
<td>No</td>
<td>Yes (public key only)</td>
</tr>
<tr>
<td>User effort</td>
<td>High (memorize)</td>
<td>Medium (copy code)</td>
<td>Low (touch/biometric)</td>
</tr>
<tr>
<td>Replay attacks</td>
<td>Vulnerable</td>
<td>Time-limited</td>
<td>Not possible</td>
</tr>
<tr>
<td>Breach impact</td>
<td>High</td>
<td>Medium</td>
<td>Minimal</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3-oauth-20-and-openid-connect">3. OAuth 2.0 and OpenID Connect<a class="header-link" href="#3-oauth-20-and-openid-connect" title="Permanent link">&para;</a></h2>
<h3 id="31-oauth-20-overview">3.1 OAuth 2.0 Overview<a class="header-link" href="#31-oauth-20-overview" title="Permanent link">&para;</a></h3>
<p>OAuth 2.0 is an <strong>authorization</strong> framework (not authentication). It allows a third-party application to access resources on behalf of a user without sharing the user's credentials.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OAuth 2.0 Roles                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Resource Owner  = The user who owns the data                    â”‚
â”‚  Client          = The application requesting access             â”‚
â”‚  Authorization   = The server that authenticates the user        â”‚
â”‚    Server          and issues tokens (e.g., Google, GitHub)      â”‚
â”‚  Resource Server = The API server holding protected resources    â”‚
â”‚                                                                  â”‚
â”‚  Example:                                                        â”‚
â”‚  &quot;MyApp wants to access your Google Calendar&quot;                    â”‚
â”‚                                                                  â”‚
â”‚  Resource Owner    = You (the Google user)                       â”‚
â”‚  Client            = MyApp                                       â”‚
â”‚  Authorization     = accounts.google.com                         â”‚
â”‚    Server                                                        â”‚
â”‚  Resource Server   = calendar.googleapis.com                     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="32-authorization-code-flow-most-common">3.2 Authorization Code Flow (Most Common)<a class="header-link" href="#32-authorization-code-flow-most-common" title="Permanent link">&para;</a></h3>
<p>This is the recommended flow for server-side web applications.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">          </span><span class="nv">OAuth</span><span class="w"> </span><span class="mi">2</span>.<span class="mi">0</span><span class="w"> </span><span class="nv">Authorization</span><span class="w"> </span><span class="nv">Code</span><span class="w"> </span><span class="nv">Flow</span><span class="w">                       </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="nv">User</span><span class="w">        </span><span class="nv">Client</span><span class="w"> </span><span class="nv">App</span><span class="w">       </span><span class="nv">Auth</span><span class="w"> </span><span class="nv">Server</span><span class="w">      </span><span class="nv">Resource</span><span class="w"> </span><span class="nv">Server</span><span class="w">   </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">              </span>â”‚<span class="w">                </span>â”‚<span class="w">                  </span>â”‚<span class="w">            </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">  </span><span class="mi">1</span>.<span class="w"> </span><span class="nv">Click</span><span class="w">    </span>â”‚<span class="w">                </span>â”‚<span class="w">                  </span>â”‚<span class="w">            </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">  </span><span class="err">&quot;Login w/   â”‚                â”‚                  â”‚            â”‚</span>
â”‚<span class="w">   </span>â”‚<span class="w">   </span><span class="nv">Google</span><span class="err">&quot;    â”‚                â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚                â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚  2. Redirect   â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚  to auth URL   â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚                â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚  3. User logs in and         â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚     consents to permissions  â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚                â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚  4. Redirect back with       â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚     authorization code       â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚                â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚  (code)      â”‚                â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚  5. Exchange   â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚  code for      â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚  tokens        â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚                â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚  6. Access +   â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚  Refresh tokensâ”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚                â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚  7. API request with access token â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚                â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚  8. Protected resource            â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚</span>
<span class="err">â”‚   â”‚              â”‚                â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚  9. Response â”‚                â”‚                  â”‚            â”‚</span>
<span class="err">â”‚   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                  â”‚            â”‚</span>
<span class="err">â”‚                                                                  â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="33-authorization-code-flow-with-pkce">3.3 Authorization Code Flow with PKCE<a class="header-link" href="#33-authorization-code-flow-with-pkce" title="Permanent link">&para;</a></h3>
<p>PKCE (Proof Key for Code Exchange) is <strong>required</strong> for public clients (SPAs, mobile apps) and recommended for all clients.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                      </span><span class="nx">PKCE</span><span class="w"> </span><span class="nx">Extension</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Before</span><span class="w"> </span><span class="nx">redirect</span><span class="w"> </span><span class="p">(</span><span class="nx">step</span><span class="w"> </span><span class="mi">2</span><span class="p">):</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="nx">generates</span><span class="w"> </span><span class="nx">random</span><span class="w"> </span><span class="s">&quot;code_verifier&quot;</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">code_verifier</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">random_string</span><span class="p">(</span><span class="mi">43</span><span class="o">-</span><span class="mi">128</span><span class="w"> </span><span class="nx">chars</span><span class="p">)</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="nx">computes</span><span class="w"> </span><span class="s">&quot;code_challenge&quot;</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">code_challenge</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">BASE64URL</span><span class="p">(</span><span class="nx">SHA256</span><span class="p">(</span><span class="nx">code_verifier</span><span class="p">))</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="nx">sends</span><span class="w"> </span><span class="nx">code_challenge</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">authorization</span><span class="w"> </span><span class="nx">request</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">authorize</span><span class="p">?</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="nx">response_type</span><span class="p">=</span><span class="nx">code</span><span class="o">&amp;</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="nx">client_id</span><span class="p">=</span><span class="o">...&amp;</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="nx">code_challenge</span><span class="p">=</span><span class="o">...&amp;</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="nx">code_challenge_method</span><span class="p">=</span><span class="nx">S256</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">At</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="nx">exchange</span><span class="w"> </span><span class="p">(</span><span class="nx">step</span><span class="w"> </span><span class="mi">5</span><span class="p">):</span><span class="w">                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="nx">sends</span><span class="w"> </span><span class="nx">code_verifier</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="nx">request</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">token</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="nx">grant_type</span><span class="p">=</span><span class="nx">authorization_code</span><span class="o">&amp;</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="nx">code</span><span class="p">=</span><span class="o">...&amp;</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="nx">code_verifier</span><span class="p">=</span><span class="o">...</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="nx">Server</span><span class="w"> </span><span class="nx">verifies</span><span class="p">:</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">BASE64URL</span><span class="p">(</span><span class="nx">SHA256</span><span class="p">(</span><span class="nx">code_verifier</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">stored</span><span class="w"> </span><span class="nx">code_challenge</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Why</span><span class="p">?</span><span class="w"> </span><span class="nx">Prevents</span><span class="w"> </span><span class="nx">authorization</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="nx">interception</span><span class="w"> </span><span class="nx">attacks</span><span class="p">.</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">An</span><span class="w"> </span><span class="nx">attacker</span><span class="w"> </span><span class="nx">who</span><span class="w"> </span><span class="nx">steals</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="nx">cannot</span><span class="w"> </span><span class="nx">exchange</span><span class="w"> </span><span class="nx">it</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">without</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">code_verifier</span><span class="p">.</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="34-openid-connect-oidc">3.4 OpenID Connect (OIDC)<a class="header-link" href="#34-openid-connect-oidc" title="Permanent link">&para;</a></h3>
<p>OpenID Connect is an <strong>authentication</strong> layer built on top of OAuth 2.0. While OAuth 2.0 provides authorization ("this app can access your calendar"), OIDC provides authentication ("this user is alice@example.com").</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">              </span><span class="nv">OAuth</span><span class="w"> </span><span class="mi">2</span>.<span class="mi">0</span><span class="w"> </span><span class="nv">vs</span><span class="w"> </span><span class="nv">OpenID</span><span class="w"> </span><span class="k">Connect</span><span class="w">                         </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="nv">OAuth</span><span class="w"> </span><span class="mi">2</span>.<span class="mi">0</span>:<span class="w">                                                      </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Purpose</span>:<span class="w"> </span><span class="nv">Authorization</span><span class="w"> </span><span class="ss">(</span><span class="nv">access</span><span class="w"> </span><span class="nv">delegation</span><span class="ss">)</span><span class="w">                    </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Token</span>:<span class="w"> </span><span class="nv">Access</span><span class="w"> </span><span class="nv">Token</span><span class="w"> </span><span class="ss">(</span><span class="nv">opaque</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">JWT</span><span class="ss">)</span><span class="w">                           </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Question</span><span class="w"> </span><span class="nv">answered</span>:<span class="w"> </span><span class="s2">&quot;What can this app do?&quot;</span><span class="w">                    </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="nv">OpenID</span><span class="w"> </span><span class="k">Connect</span><span class="w"> </span><span class="ss">(</span><span class="nv">OIDC</span><span class="ss">)</span>:<span class="w">                                          </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Purpose</span>:<span class="w"> </span><span class="nv">Authentication</span><span class="w"> </span><span class="ss">(</span><span class="nv">identity</span><span class="w"> </span><span class="nv">verification</span><span class="ss">)</span><span class="w">               </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Token</span>:<span class="w"> </span><span class="nv">ID</span><span class="w"> </span><span class="nv">Token</span><span class="w"> </span><span class="ss">(</span><span class="nv">always</span><span class="w"> </span><span class="nv">JWT</span><span class="ss">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">Access</span><span class="w"> </span><span class="nv">Token</span><span class="w">                   </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Question</span><span class="w"> </span><span class="nv">answered</span>:<span class="w"> </span><span class="s2">&quot;Who is this user?&quot;</span><span class="w">                        </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Adds</span>:<span class="w"> </span><span class="nv">UserInfo</span><span class="w"> </span><span class="nv">endpoint</span>,<span class="w"> </span><span class="nv">standard</span><span class="w"> </span><span class="nv">claims</span><span class="w"> </span><span class="ss">(</span><span class="nv">sub</span>,<span class="w"> </span><span class="nv">email</span>,<span class="w"> </span><span class="nv">name</span><span class="ss">)</span><span class="w">   </span>â”‚
â”‚<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nv">Scope</span>:<span class="w"> </span><span class="s2">&quot;openid&quot;</span><span class="w"> </span><span class="ss">(</span><span class="nv">required</span><span class="ss">)</span>,<span class="w"> </span><span class="s2">&quot;profile&quot;</span>,<span class="w"> </span><span class="s2">&quot;email&quot;</span><span class="w">               </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="nv">OIDC</span><span class="w"> </span><span class="nv">builds</span><span class="w"> </span><span class="nv">ON</span><span class="w"> </span><span class="nv">TOP</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">OAuth</span><span class="w"> </span><span class="mi">2</span>.<span class="mi">0</span>:<span class="w">                                </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">                            </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">       </span><span class="nv">OpenID</span><span class="w"> </span><span class="k">Connect</span><span class="w">            </span>â”‚<span class="w">  </span>â†<span class="w"> </span><span class="nv">Authentication</span><span class="w">          </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">   </span>â”‚<span class="w">                            </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>â”‚<span class="w">      </span><span class="nv">OAuth</span><span class="w"> </span><span class="mi">2</span>.<span class="mi">0</span><span class="w">           </span>â”‚<span class="w">   </span>â”‚<span class="w">  </span>â†<span class="w"> </span><span class="nv">Authorization</span><span class="w">           </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">   </span>â”‚<span class="w">   </span>â”‚<span class="w">                            </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>â”‚<span class="w">  </span>â”‚<span class="w">     </span><span class="nv">HTTP</span><span class="o">/</span><span class="nv">TLS</span><span class="w">      </span>â”‚<span class="w">   </span>â”‚<span class="w">   </span>â”‚<span class="w">  </span>â†<span class="w"> </span><span class="nv">Transport</span><span class="w">               </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">   </span>â”‚<span class="w">   </span>â”‚<span class="w">                            </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">   </span>â”‚<span class="w">                            </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">                            </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="35-python-example-oauth-20-client">3.5 Python Example: OAuth 2.0 Client<a class="header-link" href="#35-python-example-oauth-20-client" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">oauth_client.py - OAuth 2.0 Authorization Code Flow with PKCE</span>
<span class="sd">Using the requests-oauthlib library</span>
<span class="sd">pip install requests-oauthlib</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlencode</span><span class="p">,</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">parse_qs</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="c1"># OAuth 2.0 Configuration (example with GitHub)</span>
<span class="n">OAUTH_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OAUTH_CLIENT_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;your-client-id&quot;</span><span class="p">),</span>
    <span class="s2">&quot;client_secret&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OAUTH_CLIENT_SECRET&quot;</span><span class="p">,</span> <span class="s2">&quot;your-secret&quot;</span><span class="p">),</span>
    <span class="s2">&quot;authorize_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://github.com/login/oauth/authorize&quot;</span><span class="p">,</span>
    <span class="s2">&quot;token_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://github.com/login/oauth/access_token&quot;</span><span class="p">,</span>
    <span class="s2">&quot;userinfo_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.github.com/user&quot;</span><span class="p">,</span>
    <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="s2">&quot;http://localhost:5000/callback&quot;</span><span class="p">,</span>
    <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot;read:user user:email&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_pkce_pair</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate PKCE code_verifier and code_challenge.&quot;&quot;&quot;</span>
    <span class="c1"># code_verifier: 43-128 chars, unreserved URI characters</span>
    <span class="n">code_verifier</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span>
        <span class="n">secrets</span><span class="o">.</span><span class="n">token_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>

    <span class="c1"># code_challenge: BASE64URL(SHA256(code_verifier))</span>
    <span class="n">digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">code_verifier</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
    <span class="n">code_challenge</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">code_verifier</span><span class="p">,</span> <span class="n">code_challenge</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initiate OAuth 2.0 Authorization Code Flow.&quot;&quot;&quot;</span>
    <span class="c1"># Generate PKCE pair</span>
    <span class="n">code_verifier</span><span class="p">,</span> <span class="n">code_challenge</span> <span class="o">=</span> <span class="n">generate_pkce_pair</span><span class="p">()</span>

    <span class="c1"># Generate state for CSRF protection</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

    <span class="c1"># Store in session</span>
    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;oauth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;code_verifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code_verifier</span>

    <span class="c1"># Build authorization URL</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">],</span>
        <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;redirect_uri&quot;</span><span class="p">],</span>
        <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">],</span>
        <span class="s2">&quot;response_type&quot;</span><span class="p">:</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span>
        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
        <span class="s2">&quot;code_challenge&quot;</span><span class="p">:</span> <span class="n">code_challenge</span><span class="p">,</span>
        <span class="s2">&quot;code_challenge_method&quot;</span><span class="p">:</span> <span class="s2">&quot;S256&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">auth_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s1">&#39;authorize_url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">auth_url</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/callback&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle OAuth 2.0 callback with authorization code.&quot;&quot;&quot;</span>
    <span class="c1"># Verify state to prevent CSRF</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;oauth_state&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;State mismatch - possible CSRF attack&quot;</span><span class="p">,</span> <span class="mi">403</span>

    <span class="c1"># Check for errors</span>
    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;OAuth error: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">400</span>

    <span class="c1"># Exchange authorization code for tokens</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">)</span>
    <span class="n">token_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;token_url&quot;</span><span class="p">],</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;client_secret&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;client_secret&quot;</span><span class="p">],</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
            <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;redirect_uri&quot;</span><span class="p">],</span>
            <span class="s2">&quot;grant_type&quot;</span><span class="p">:</span> <span class="s2">&quot;authorization_code&quot;</span><span class="p">,</span>
            <span class="s2">&quot;code_verifier&quot;</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code_verifier&quot;</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="n">token_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="n">access_token</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;access_token&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">access_token</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Failed to obtain access token&quot;</span><span class="p">,</span> <span class="mi">400</span>

    <span class="c1"># Fetch user info</span>
    <span class="n">user_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;userinfo_url&quot;</span><span class="p">],</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="n">user_info</span> <span class="o">=</span> <span class="n">user_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="c1"># Store user in session</span>
    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
        <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">user_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">),</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">user_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">user_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># Clean up OAuth state</span>
    <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;oauth_state&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;code_verifier&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/profile&quot;</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/profile&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">profile</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display user profile (protected route).&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/logout&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear session and log out.&quot;&quot;&quot;</span>
    <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="4-session-management">4. Session Management<a class="header-link" href="#4-session-management" title="Permanent link">&para;</a></h2>
<h3 id="41-server-side-sessions-cookie-based">4.1 Server-Side Sessions (Cookie-Based)<a class="header-link" href="#41-server-side-sessions-cookie-based" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                </span><span class="nt">Server-Side</span><span class="w"> </span><span class="nt">Session</span><span class="w"> </span><span class="nt">Flow</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">Browser</span><span class="w">                          </span><span class="nt">Server</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                                </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="nt">1</span><span class="o">.</span><span class="w"> </span><span class="nt">POST</span><span class="w"> </span><span class="o">/</span><span class="nt">login</span><span class="w">                </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="o">(</span><span class="nt">username</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nt">password</span><span class="o">)</span><span class="w">         </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                                </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                          </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                          </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">Validate</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                          </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">Create</span><span class="w">    </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                          </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">session</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                          </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">ID</span><span class="o">=</span><span class="nt">abc123</span><span class="w"> </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                          </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">Store</span><span class="w"> </span><span class="nt">in</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                          </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">Redis</span><span class="o">/</span><span class="nt">DB</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                          </span><span class="err">â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                                </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="nt">2</span><span class="o">.</span><span class="w"> </span><span class="nt">Set-Cookie</span><span class="o">:</span><span class="w">                </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="nt">session_id</span><span class="o">=</span><span class="nt">abc123</span><span class="o">;</span><span class="w">            </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="nt">HttpOnly</span><span class="o">;</span><span class="w"> </span><span class="nt">Secure</span><span class="o">;</span><span class="w">             </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="nt">SameSite</span><span class="o">=</span><span class="nt">Lax</span><span class="w">                  </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                                </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="nt">3</span><span class="o">.</span><span class="w"> </span><span class="nt">GET</span><span class="w"> </span><span class="o">/</span><span class="nt">dashboard</span><span class="w">             </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="nt">Cookie</span><span class="o">:</span><span class="w"> </span><span class="nt">session_id</span><span class="o">=</span><span class="nt">abc123</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                          </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                          </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">Look</span><span class="w"> </span><span class="nt">up</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                          </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">session</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                          </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">in</span><span class="w"> </span><span class="nt">store</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                          </span><span class="err">â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="nt">4</span><span class="o">.</span><span class="w"> </span><span class="nt">Response</span><span class="w"> </span><span class="nt">with</span><span class="w"> </span><span class="nt">user</span><span class="w"> </span><span class="nt">data</span><span class="w">    </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="42-secure-cookie-attributes">4.2 Secure Cookie Attributes<a class="header-link" href="#42-secure-cookie-attributes" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nt">Set-Cookie</span><span class="o">:</span><span class="w"> </span><span class="nt">session_id</span><span class="o">=</span><span class="nt">abc123</span><span class="o">;</span>
<span class="w">            </span><span class="nt">HttpOnly</span><span class="o">;</span><span class="w">        </span><span class="err">â†</span><span class="w"> </span><span class="nt">Cannot</span><span class="w"> </span><span class="nt">be</span><span class="w"> </span><span class="nt">accessed</span><span class="w"> </span><span class="nt">by</span><span class="w"> </span><span class="nt">JavaScript</span><span class="w"> </span><span class="o">(</span><span class="nt">XSS</span><span class="w"> </span><span class="nt">protection</span><span class="o">)</span>
<span class="w">            </span><span class="nt">Secure</span><span class="o">;</span><span class="w">          </span><span class="err">â†</span><span class="w"> </span><span class="nt">Only</span><span class="w"> </span><span class="nt">sent</span><span class="w"> </span><span class="nt">over</span><span class="w"> </span><span class="nt">HTTPS</span>
<span class="w">            </span><span class="nt">SameSite</span><span class="o">=</span><span class="nt">Lax</span><span class="o">;</span><span class="w">    </span><span class="err">â†</span><span class="w"> </span><span class="nt">CSRF</span><span class="w"> </span><span class="nt">protection</span><span class="w"> </span><span class="o">(</span><span class="nt">not</span><span class="w"> </span><span class="nt">sent</span><span class="w"> </span><span class="nt">on</span><span class="w"> </span><span class="nt">cross-site</span><span class="w"> </span><span class="nt">POST</span><span class="o">)</span>
<span class="w">            </span><span class="nt">Path</span><span class="o">=/;</span><span class="w">          </span><span class="err">â†</span><span class="w"> </span><span class="nt">Cookie</span><span class="w"> </span><span class="nt">scope</span>
<span class="w">            </span><span class="nt">Max-Age</span><span class="o">=</span><span class="nt">3600</span><span class="o">;</span><span class="w">    </span><span class="err">â†</span><span class="w"> </span><span class="nt">Expires</span><span class="w"> </span><span class="nt">in</span><span class="w"> </span><span class="nt">1</span><span class="w"> </span><span class="nt">hour</span>
<span class="w">            </span><span class="nt">Domain</span><span class="o">=</span><span class="p">.</span><span class="nc">app</span><span class="p">.</span><span class="nc">com</span><span class="w">  </span><span class="err">â†</span><span class="w"> </span><span class="nt">Sent</span><span class="w"> </span><span class="nt">to</span><span class="w"> </span><span class="nt">subdomains</span><span class="w"> </span><span class="nt">too</span>
</code></pre></div>

<table>
<thead>
<tr>
<th>Attribute</th>
<th>Purpose</th>
<th>Recommended Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>HttpOnly</code></td>
<td>Prevent XSS from reading cookie</td>
<td>Always set</td>
</tr>
<tr>
<td><code>Secure</code></td>
<td>HTTPS only</td>
<td>Always set in production</td>
</tr>
<tr>
<td><code>SameSite</code></td>
<td>CSRF protection</td>
<td><code>Lax</code> (or <code>Strict</code> for sensitive actions)</td>
</tr>
<tr>
<td><code>Max-Age</code></td>
<td>Session duration</td>
<td>1-24 hours depending on sensitivity</td>
</tr>
<tr>
<td><code>Path</code></td>
<td>URL scope</td>
<td><code>/</code> or specific path</td>
</tr>
</tbody>
</table>
<h3 id="43-session-security-best-practices">4.3 Session Security Best Practices<a class="header-link" href="#43-session-security-best-practices" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">session_security.py - Secure session management with Flask</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Session configuration</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">SECRET_KEY</span><span class="o">=</span><span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
    <span class="n">SESSION_COOKIE_HTTPONLY</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>     <span class="c1"># Prevent JavaScript access</span>
    <span class="n">SESSION_COOKIE_SECURE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>       <span class="c1"># HTTPS only</span>
    <span class="n">SESSION_COOKIE_SAMESITE</span><span class="o">=</span><span class="s1">&#39;Lax&#39;</span><span class="p">,</span>    <span class="c1"># CSRF protection</span>
    <span class="n">PERMANENT_SESSION_LIFETIME</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># Session timeout</span>
    <span class="n">SESSION_COOKIE_NAME</span><span class="o">=</span><span class="s1">&#39;__Host-session&#39;</span><span class="p">,</span>  <span class="c1"># __Host- prefix forces Secure+Path=/</span>
<span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">check_session_security</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Middleware to enforce session security policies.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;user_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span>  <span class="c1"># Not logged in, skip checks</span>

    <span class="c1"># 1. Session timeout (absolute)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">created_at</span> <span class="o">&gt;</span> <span class="mi">3600</span><span class="p">:</span>  <span class="c1"># 1 hour absolute timeout</span>
        <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>

    <span class="c1"># 2. Idle timeout</span>
    <span class="n">last_active</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_active&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_active</span> <span class="o">&gt;</span> <span class="mi">900</span><span class="p">:</span>  <span class="c1"># 15 min idle timeout</span>
        <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>

    <span class="c1"># 3. Update last active time</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;last_active&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># 4. IP binding (optional - can cause issues with mobile users)</span>
    <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ip_address&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">:</span>
        <span class="c1"># Log suspicious activity</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;IP change detected for user </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ip_address&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">regenerate_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Regenerate session ID after authentication state change.</span>
<span class="sd">    Prevents session fixation attacks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Preserve necessary data</span>
    <span class="n">old_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

    <span class="c1"># Clear old session</span>
    <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># Create new session with fresh ID</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_id</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;last_active&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;ip_address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span>
    <span class="n">session</span><span class="o">.</span><span class="n">permanent</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Use PERMANENT_SESSION_LIFETIME</span>

    <span class="c1"># Note: Flask automatically generates a new session ID</span>
    <span class="c1"># when the session is modified after being cleared</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>

    <span class="c1"># Validate credentials (simplified)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="c1"># IMPORTANT: Regenerate session after login</span>
        <span class="n">regenerate_session</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;dashboard&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="s2">&quot;Invalid credentials&quot;</span><span class="p">,</span> <span class="mi">401</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Properly destroy the session.&quot;&quot;&quot;</span>
    <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
    <span class="c1"># Explicitly expire the cookie</span>
    <span class="n">response</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="s1">&#39;__Host-session&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<hr />
<h2 id="5-json-web-tokens-jwt">5. JSON Web Tokens (JWT)<a class="header-link" href="#5-json-web-tokens-jwt" title="Permanent link">&para;</a></h2>
<h3 id="51-jwt-structure">5.1 JWT Structure<a class="header-link" href="#51-jwt-structure" title="Permanent link">&para;</a></h3>
<p>A JWT consists of three Base64URL-encoded parts separated by dots.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                     </span><span class="n">JWT</span><span class="w"> </span><span class="n">Structure</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</span><span class="o">.</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4iLCJpYXQiOjE2M</span><span class="o">.</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">     </span><span class="n">HEADER</span><span class="w">       </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â†</span><span class="w"> </span><span class="n">Algorithm</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="n">type</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="p">{</span><span class="w">               </span><span class="err">â”‚</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;HS256&quot;</span><span class="err">â”‚</span><span class="w">    </span><span class="n">HMAC</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT&quot;</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="n">JSON</span><span class="w"> </span><span class="n">Web</span><span class="w"> </span><span class="n">Token</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="p">}</span><span class="w">               </span><span class="err">â”‚</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="o">.</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">     </span><span class="n">PAYLOAD</span><span class="w">      </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â†</span><span class="w"> </span><span class="n">Claims</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="p">{</span><span class="w">               </span><span class="err">â”‚</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1234&quot;</span><span class="w"> </span><span class="err">â”‚</span><span class="w">    </span><span class="n">Subject</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="n">ID</span><span class="p">)</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John&quot;</span><span class="err">â”‚</span><span class="w">    </span><span class="n">Custom</span><span class="w"> </span><span class="n">claim</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">163.</span><span class="o">..</span><span class="w"> </span><span class="err">â”‚</span><span class="w">    </span><span class="n">Issued</span><span class="w"> </span><span class="n">at</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">163.</span><span class="o">..</span><span class="w"> </span><span class="err">â”‚</span><span class="w">    </span><span class="n">Expiration</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;myapp&quot;</span><span class="err">â”‚</span><span class="w">    </span><span class="n">Issuer</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;api&quot;</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="n">Audience</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="p">}</span><span class="w">               </span><span class="err">â”‚</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="o">.</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="n">SIGNATURE</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â†</span><span class="w"> </span><span class="n">Integrity</span><span class="w"> </span><span class="n">verification</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                  </span><span class="err">â”‚</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">HMACSHA256</span><span class="p">(</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="n">base64url</span><span class="p">(</span><span class="w">    </span><span class="err">â”‚</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">      </span><span class="n">header</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;.&quot;</span><span class="w"> </span><span class="o">+</span><span class="w">         </span><span class="err">â”‚</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="n">base64url</span><span class="p">(</span><span class="w">    </span><span class="err">â”‚</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">      </span><span class="n">payload</span><span class="p">),</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="n">secret</span><span class="w">        </span><span class="err">â”‚</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="p">)</span><span class="w">               </span><span class="err">â”‚</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="52-jwt-signing-algorithms">5.2 JWT Signing Algorithms<a class="header-link" href="#52-jwt-signing-algorithms" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Algorithm</th>
<th>Type</th>
<th>Key</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>HS256</td>
<td>Symmetric</td>
<td>Shared secret</td>
<td>Single service (same key signs and verifies)</td>
</tr>
<tr>
<td>RS256</td>
<td>Asymmetric</td>
<td>RSA key pair</td>
<td>Microservices (private key signs, public key verifies)</td>
</tr>
<tr>
<td>ES256</td>
<td>Asymmetric</td>
<td>ECDSA key pair</td>
<td>Modern alternative to RS256 (smaller keys)</td>
</tr>
<tr>
<td>EdDSA</td>
<td>Asymmetric</td>
<td>Ed25519 pair</td>
<td>Best performance, smallest keys</td>
</tr>
<tr>
<td><strong>none</strong></td>
<td><strong>None</strong></td>
<td><strong>None</strong></td>
<td><strong>NEVER USE - critical vulnerability</strong></td>
</tr>
</tbody>
</table>
<h3 id="53-python-jwt-implementation">5.3 Python JWT Implementation<a class="header-link" href="#53-python-jwt-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">jwt_auth.py - JWT creation, verification, and common patterns</span>
<span class="sd">pip install PyJWT cryptography</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Symmetric (HS256) - For single-service applications</span>
<span class="c1"># ==============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">JWTManagerSymmetric</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;JWT manager using HMAC-SHA256 (symmetric key).&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># In production, load from environment variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">secret_key</span> <span class="ow">or</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">roles</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">expires_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a short-lived access token.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>           <span class="c1"># Subject (user identifier)</span>
            <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>                <span class="c1"># Issued at</span>
            <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expires_minutes</span><span class="p">),</span>  <span class="c1"># Expiration</span>
            <span class="s2">&quot;iss&quot;</span><span class="p">:</span> <span class="s2">&quot;myapp&quot;</span><span class="p">,</span>            <span class="c1"># Issuer</span>
            <span class="s2">&quot;aud&quot;</span><span class="p">:</span> <span class="s2">&quot;myapp-api&quot;</span><span class="p">,</span>        <span class="c1"># Audience</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;access&quot;</span><span class="p">,</span>          <span class="c1"># Token type</span>
            <span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="n">roles</span> <span class="ow">or</span> <span class="p">[],</span>      <span class="c1"># User roles</span>
            <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>  <span class="c1"># Unique token ID (for revocation)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_refresh_token</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">expires_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a long-lived refresh token.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
            <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">expires_days</span><span class="p">),</span>
            <span class="s2">&quot;iss&quot;</span><span class="p">:</span> <span class="s2">&quot;myapp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;refresh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">verify_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expected_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;access&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify and decode a JWT token.</span>
<span class="sd">        Raises jwt.InvalidTokenError on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                <span class="n">token</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span>
                <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">],</span>  <span class="c1"># IMPORTANT: always specify!</span>
                <span class="n">issuer</span><span class="o">=</span><span class="s2">&quot;myapp&quot;</span><span class="p">,</span>
                <span class="n">audience</span><span class="o">=</span><span class="s2">&quot;myapp-api&quot;</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;require&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="s2">&quot;iat&quot;</span><span class="p">,</span> <span class="s2">&quot;sub&quot;</span><span class="p">,</span> <span class="s2">&quot;iss&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;verify_exp&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;verify_iat&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;verify_iss&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># Verify token type</span>
            <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">expected_type</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">expected_type</span><span class="si">}</span><span class="s2"> token, got </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">payload</span>

        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">ExpiredSignatureError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">(</span><span class="s2">&quot;Token has expired&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidAudienceError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">(</span><span class="s2">&quot;Invalid audience&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidIssuerError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">(</span><span class="s2">&quot;Invalid issuer&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">DecodeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">(</span><span class="s2">&quot;Token decode failed&quot;</span><span class="p">)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Asymmetric (RS256) - For microservices</span>
<span class="c1"># ==============================================================</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric</span><span class="w"> </span><span class="kn">import</span> <span class="n">rsa</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">serialization</span>


<span class="k">class</span><span class="w"> </span><span class="nc">JWTManagerAsymmetric</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;JWT manager using RSA-SHA256 (asymmetric keys).&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key_pem</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">public_key_pem</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">private_key_pem</span> <span class="ow">and</span> <span class="n">public_key_pem</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span>
                <span class="n">private_key_pem</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_public_key</span><span class="p">(</span>
                <span class="n">public_key_pem</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Generate key pair for demo</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span>
                <span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span>
                <span class="n">key_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="s2">&quot;RS256&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sign a token with the private key.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">verify_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify a token with the public key.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="n">token</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="p">,</span>
            <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_public_key_pem</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export public key (share with other services).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">PEM</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">PublicFormat</span><span class="o">.</span><span class="n">SubjectPublicKeyInfo</span>
        <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Token Refresh Pattern</span>
<span class="c1"># ==============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TokenService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Complete token service with refresh flow.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span> <span class="o">=</span> <span class="n">JWTManagerSymmetric</span><span class="p">()</span>
        <span class="c1"># In production, use Redis or a database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revoked_tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">roles</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Issue access and refresh tokens upon login.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span>
                <span class="n">user_id</span><span class="p">,</span> <span class="n">roles</span><span class="p">,</span> <span class="n">expires_minutes</span><span class="o">=</span><span class="mi">15</span>
            <span class="p">),</span>
            <span class="s2">&quot;refresh_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span><span class="o">.</span><span class="n">create_refresh_token</span><span class="p">(</span>
                <span class="n">user_id</span><span class="p">,</span> <span class="n">expires_days</span><span class="o">=</span><span class="mi">30</span>
            <span class="p">),</span>
            <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;expires_in&quot;</span><span class="p">:</span> <span class="mi">900</span><span class="p">,</span>  <span class="c1"># 15 minutes in seconds</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use refresh token to get a new access token.&quot;&quot;&quot;</span>
        <span class="c1"># Verify refresh token</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span><span class="o">.</span><span class="n">verify_token</span><span class="p">(</span>
            <span class="n">refresh_token</span><span class="p">,</span> <span class="n">expected_type</span><span class="o">=</span><span class="s2">&quot;refresh&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Check if token has been revoked</span>
        <span class="n">jti</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jti&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jti</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">revoked_tokens</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">(</span><span class="s2">&quot;Token has been revoked&quot;</span><span class="p">)</span>

        <span class="c1"># Revoke old refresh token (rotation)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revoked_tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">jti</span><span class="p">)</span>

        <span class="c1"># Issue new token pair</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="p">[])</span>  <span class="c1"># Re-fetch roles from DB</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">revoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Revoke a token (logout).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                <span class="n">token</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span>
                <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">],</span>
                <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;verify_exp&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>  <span class="c1"># Allow revoking expired tokens</span>
            <span class="p">)</span>
            <span class="n">jti</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jti&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">jti</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">revoked_tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">jti</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">DecodeError</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Invalid token, nothing to revoke</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Demo</span>
<span class="c1"># ==============================================================</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Symmetric JWT (HS256) ===&quot;</span><span class="p">)</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">JWTManagerSymmetric</span><span class="p">()</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;editor&quot;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token: </span><span class="si">{</span><span class="n">token</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payload: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Token Service ===&quot;</span><span class="p">)</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">TokenService</span><span class="p">()</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Access:  </span><span class="si">{</span><span class="n">tokens</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">][:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Refresh: </span><span class="si">{</span><span class="n">tokens</span><span class="p">[</span><span class="s1">&#39;refresh_token&#39;</span><span class="p">][:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="c1"># Refresh</span>
    <span class="n">new_tokens</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New access: </span><span class="si">{</span><span class="n">new_tokens</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">][:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Asymmetric JWT (RS256) ===&quot;</span><span class="p">)</span>
    <span class="n">asym_manager</span> <span class="o">=</span> <span class="n">JWTManagerAsymmetric</span><span class="p">()</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">asym_manager</span><span class="o">.</span><span class="n">create_token</span><span class="p">({</span>
        <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="s2">&quot;user123&quot;</span><span class="p">,</span>
        <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">})</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token: </span><span class="si">{</span><span class="n">token</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">asym_manager</span><span class="o">.</span><span class="n">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payload: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Public key (share with other services):&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">asym_manager</span><span class="o">.</span><span class="n">get_public_key_pem</span><span class="p">()[:</span><span class="mi">100</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="54-common-jwt-pitfalls">5.4 Common JWT Pitfalls<a class="header-link" href="#54-common-jwt-pitfalls" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="n">JWT</span><span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="n">Pitfalls</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">Algorithm</span><span class="w"> </span><span class="s2">&quot;none&quot;</span><span class="w"> </span><span class="n">Attack</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Attacker</span><span class="w"> </span><span class="n">changes</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;none&quot;</span><span class="p">}</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">removes</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">signature</span><span class="o">.</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">accepts</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">token</span><span class="o">.</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">FIX</span><span class="p">:</span><span class="w"> </span><span class="n">Always</span><span class="w"> </span><span class="n">specify</span><span class="w"> </span><span class="n">allowed</span><span class="w"> </span><span class="n">algorithms</span><span class="p">:</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">])</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">NEVER</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">accept</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">algorithm</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">Algorithm</span><span class="w"> </span><span class="n">Confusion</span><span class="w"> </span><span class="p">(</span><span class="n">RS256</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">HS256</span><span class="p">)</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Server</span><span class="w"> </span><span class="n">uses</span><span class="w"> </span><span class="n">RS256</span><span class="w"> </span><span class="p">(</span><span class="n">asymmetric</span><span class="p">)</span><span class="o">.</span><span class="w"> </span><span class="n">Attacker</span><span class="w"> </span><span class="n">changes</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">HS256</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="ow">and</span><span class="w"> </span><span class="n">signs</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">PUBLIC</span><span class="w"> </span><span class="n">key</span><span class="o">.</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">verifies</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">the</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">same</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">HMAC</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">valid</span><span class="o">!</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">FIX</span><span class="p">:</span><span class="w"> </span><span class="n">Explicitly</span><span class="w"> </span><span class="n">specify</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="n">algorithm</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="s2">&quot;any&quot;</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Use</span><span class="w"> </span><span class="n">separate</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">symmetric</span><span class="o">/</span><span class="n">asymmetric</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">Expiration</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Token</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="s2">&quot;exp&quot;</span><span class="w"> </span><span class="n">claim</span><span class="w"> </span><span class="n">lives</span><span class="w"> </span><span class="n">forever</span><span class="o">.</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">FIX</span><span class="p">:</span><span class="w"> </span><span class="n">Always</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="nb">exp</span><span class="o">.</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">short</span><span class="o">-</span><span class="n">lived</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="p">(</span><span class="mi">15</span><span class="w"> </span><span class="nb">min</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">with</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="n">refresh</span><span class="w"> </span><span class="n">tokens</span><span class="o">.</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">4.</span><span class="w"> </span><span class="n">Sensitive</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">Payload</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">JWT</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">Base64</span><span class="o">-</span><span class="n">encoded</span><span class="p">,</span><span class="w"> </span><span class="n">NOT</span><span class="w"> </span><span class="n">encrypted</span><span class="o">.</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Anyone</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">decode</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">it</span><span class="o">.</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">FIX</span><span class="p">:</span><span class="w"> </span><span class="n">Never</span><span class="w"> </span><span class="n">put</span><span class="w"> </span><span class="n">passwords</span><span class="p">,</span><span class="w"> </span><span class="n">PII</span><span class="p">,</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">secrets</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">JWT</span><span class="w"> </span><span class="n">payload</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Use</span><span class="w"> </span><span class="n">JWE</span><span class="w"> </span><span class="p">(</span><span class="n">JSON</span><span class="w"> </span><span class="n">Web</span><span class="w"> </span><span class="n">Encryption</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">private</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">5.</span><span class="w"> </span><span class="n">Token</span><span class="w"> </span><span class="n">Not</span><span class="w"> </span><span class="n">Revocable</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">JWTs</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">stateless</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">once</span><span class="w"> </span><span class="n">issued</span><span class="p">,</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">remain</span><span class="w"> </span><span class="n">valid</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">until</span><span class="w"> </span><span class="n">expiration</span><span class="o">.</span><span class="w"> </span><span class="n">Logout</span><span class="w"> </span><span class="n">doesn</span><span class="s1">&#39;t invalidate the token.       â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">FIX</span><span class="p">:</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">short</span><span class="w"> </span><span class="n">expiry</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="n">blocklist</span><span class="w"> </span><span class="p">(</span><span class="n">Redis</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">logout</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Or</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="s2">&quot;jti&quot;</span><span class="w"> </span><span class="n">claim</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">track</span><span class="w"> </span><span class="n">revoked</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="n">IDs</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">6.</span><span class="w"> </span><span class="n">Storing</span><span class="w"> </span><span class="n">JWT</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">localStorage</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">localStorage</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">accessible</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">JavaScript</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">page</span><span class="p">,</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">making</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">vulnerable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">XSS</span><span class="o">.</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">FIX</span><span class="p">:</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">HttpOnly</span><span class="w"> </span><span class="n">cookie</span><span class="w"> </span><span class="p">(</span><span class="n">immune</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">XSS</span><span class="p">)</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Or</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="ow">in</span><span class="o">-</span><span class="n">memory</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">refresh</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">HttpOnly</span><span class="w"> </span><span class="n">cookie</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">7.</span><span class="w"> </span><span class="n">Weak</span><span class="w"> </span><span class="n">Secret</span><span class="w"> </span><span class="n">Key</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Using</span><span class="w"> </span><span class="n">short</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">guessable</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">HMAC</span><span class="w"> </span><span class="n">signing</span><span class="o">.</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Attackers</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">brute</span><span class="o">-</span><span class="n">force</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">key</span><span class="o">.</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">FIX</span><span class="p">:</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">least</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">entropy</span><span class="p">:</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w">  </span><span class="c1"># 256 bits                   â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="6-password-reset-flows">6. Password Reset Flows<a class="header-link" href="#6-password-reset-flows" title="Permanent link">&para;</a></h2>
<h3 id="61-secure-password-reset-design">6.1 Secure Password Reset Design<a class="header-link" href="#61-secure-password-reset-design" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">              </span><span class="nv">Secure</span><span class="w"> </span><span class="nv">Password</span><span class="w"> </span><span class="nv">Reset</span><span class="w"> </span><span class="nv">Flow</span><span class="w">                           </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="nv">User</span><span class="w">                      </span><span class="nv">Server</span><span class="w">                     </span><span class="nv">Email</span><span class="w">      </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                          </span>â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w"> </span><span class="mi">1</span>.<span class="w"> </span><span class="s2">&quot;Forgot password&quot;</span><span class="w">     </span>â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">  </span><span class="ss">(</span><span class="nv">enter</span><span class="w"> </span><span class="nv">email</span><span class="ss">)</span><span class="w">           </span>â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                          </span>â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”<span class="w">                   </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="nv">Generate</span><span class="w">  </span>â”‚<span class="w">                    </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="k">random</span><span class="w">    </span>â”‚<span class="w">                    </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="nv">token</span><span class="w">     </span>â”‚<span class="w">                    </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="nv">Store</span><span class="w">     </span>â”‚<span class="w">                    </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="nv">hash</span><span class="ss">(</span><span class="nv">tkn</span><span class="ss">)</span><span class="w"> </span>â”‚<span class="w">                    </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">expiry</span><span class="w">  </span>â”‚<span class="w">                    </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜<span class="w">                   </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                          </span>â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w"> </span><span class="mi">2</span>.<span class="w"> </span><span class="s2">&quot;Check your email&quot;</span><span class="w">    </span>â”‚<span class="w">  </span><span class="mi">3</span>.<span class="w"> </span><span class="k">Send</span><span class="w"> </span><span class="nv">reset</span><span class="w"> </span><span class="nv">link</span><span class="w">     </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">  </span><span class="ss">(</span><span class="nv">SAME</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="nv">whether</span><span class="w">  </span>â”‚<span class="w">  </span><span class="nv">with</span><span class="w"> </span><span class="nv">token</span><span class="w">             </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">   </span><span class="nv">email</span><span class="w"> </span><span class="nv">exists</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">not</span><span class="o">!</span><span class="ss">)</span><span class="w">  </span>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚<span class="w">       </span>â”‚
â”‚<span class="w">   </span>â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                          </span>â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w"> </span><span class="mi">4</span>.<span class="w"> </span><span class="nv">Click</span><span class="w"> </span><span class="nv">link</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">email</span><span class="w">   </span>â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">  </span><span class="o">/</span><span class="nv">reset</span>?<span class="nv">token</span><span class="o">=</span><span class="nv">abc123</span><span class="w">     </span>â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                          </span>â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w"> </span><span class="mi">5</span>.<span class="w"> </span><span class="nv">New</span><span class="w"> </span><span class="nv">password</span><span class="w"> </span><span class="nv">form</span><span class="w">     </span>â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                          </span>â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w"> </span><span class="mi">6</span>.<span class="w"> </span><span class="nv">Submit</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">password</span><span class="w">   </span>â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”<span class="w">                   </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="nv">Verify</span><span class="w">    </span>â”‚<span class="w">                    </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="nv">token</span><span class="w">     </span>â”‚<span class="w">                    </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="nv">Update</span><span class="w">    </span>â”‚<span class="w">                    </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="nv">password</span><span class="w">  </span>â”‚<span class="w">                    </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="nv">Invalidate</span>â”‚<span class="w">                    </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="nv">token</span><span class="w">     </span>â”‚<span class="w">                    </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="nv">Invalidate</span>â”‚<span class="w">                    </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â”‚<span class="w"> </span><span class="nv">sessions</span><span class="w">  </span>â”‚<span class="w">                    </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                    </span>â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜<span class="w">                   </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w">                          </span>â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚<span class="w"> </span><span class="mi">7</span>.<span class="w"> </span><span class="s2">&quot;Password updated&quot;</span><span class="w">    </span>â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">   </span>â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<span class="w">                          </span>â”‚<span class="w">        </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="62-implementation">6.2 Implementation<a class="header-link" href="#62-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">password_reset.py - Secure password reset implementation</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ResetToken</span><span class="p">:</span>
    <span class="n">token_hash</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">expires_at</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">used</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span><span class="w"> </span><span class="nc">PasswordResetService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Secure password reset token management.&quot;&quot;&quot;</span>

    <span class="n">TOKEN_EXPIRY_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">MAX_REQUESTS_PER_HOUR</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># In production, use a database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># token_hash -&gt; ResetToken</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># email -&gt; [timestamps]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">request_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a password reset token.</span>
<span class="sd">        Returns the token (to be emailed) or None if rate limited.</span>

<span class="sd">        SECURITY: Always return the same response to the user,</span>
<span class="sd">        regardless of whether the email exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Rate limiting</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">email</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">:</span>
            <span class="n">recent</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">[</span><span class="n">email</span><span class="p">]</span> <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">3600</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_REQUESTS_PER_HOUR</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Rate limited</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">[</span><span class="n">email</span><span class="p">]</span> <span class="o">=</span> <span class="n">recent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">[</span><span class="n">email</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">[</span><span class="n">email</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>

        <span class="c1"># If user doesn&#39;t exist, return None silently</span>
        <span class="c1"># (caller should still show &quot;check your email&quot; message)</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Generate cryptographically secure token</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>  <span class="c1"># 256 bits of entropy</span>

        <span class="c1"># Store HASH of token (not the token itself!)</span>
        <span class="c1"># If database is breached, attacker can&#39;t use the hashes</span>
        <span class="n">token_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="c1"># Invalidate any existing tokens for this user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">h</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">user_id</span> <span class="o">!=</span> <span class="n">user_id</span>
        <span class="p">}</span>

        <span class="c1"># Store new token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">token_hash</span><span class="p">]</span> <span class="o">=</span> <span class="n">ResetToken</span><span class="p">(</span>
            <span class="n">token_hash</span><span class="o">=</span><span class="n">token_hash</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
            <span class="n">expires_at</span><span class="o">=</span><span class="n">now</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TOKEN_EXPIRY_MINUTES</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">token</span>  <span class="c1"># Send this in the email link</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">verify_and_consume_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify a reset token and return the user_id.</span>
<span class="sd">        Token is consumed (single-use).</span>
<span class="sd">        Returns None if token is invalid/expired/used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">token_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="n">reset_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token_hash</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reset_token</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Check expiration</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">reset_token</span><span class="o">.</span><span class="n">expires_at</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">token_hash</span><span class="p">]</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Check if already used</span>
        <span class="k">if</span> <span class="n">reset_token</span><span class="o">.</span><span class="n">used</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Mark as used</span>
        <span class="n">reset_token</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Clean up</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">token_hash</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">reset_token</span><span class="o">.</span><span class="n">user_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove expired tokens (run periodically).&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">h</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">&gt;</span> <span class="n">now</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">used</span>
        <span class="p">}</span>


<span class="c1"># Flask route example</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">reset_service</span> <span class="o">=</span> <span class="n">PasswordResetService</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/forgot-password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">forgot_password</span><span class="p">():</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Email required&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Look up user (may return None if not found)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_user_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>  <span class="c1"># Your DB lookup</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">user</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">reset_service</span><span class="o">.</span><span class="n">request_reset</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">token</span> <span class="ow">and</span> <span class="n">user</span><span class="p">:</span>
        <span class="c1"># Send email with reset link</span>
        <span class="n">reset_link</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://myapp.com/reset-password?token=</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">send_reset_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">reset_link</span><span class="p">)</span>  <span class="c1"># Your email function</span>

    <span class="c1"># ALWAYS return the same response (prevent email enumeration)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;If that email is registered, you will receive a reset link.&quot;</span>
    <span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/reset-password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reset_password</span><span class="p">():</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
    <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new_password&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">new_password</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Token and new password required&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Validate new password</span>
    <span class="c1"># (use password_policy.check_password_strength here)</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">reset_service</span><span class="o">.</span><span class="n">verify_and_consume_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid or expired token&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Update password</span>
    <span class="n">update_user_password</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">new_password</span><span class="p">)</span>  <span class="c1"># Hash and store</span>

    <span class="c1"># Invalidate all existing sessions for this user</span>
    <span class="n">invalidate_all_sessions</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Password updated successfully&quot;</span><span class="p">})</span>
</code></pre></div>

<p><strong>Key Security Properties:</strong></p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Token entropy</td>
<td><code>secrets.token_urlsafe(32)</code> - 256 bits</td>
</tr>
<tr>
<td>Token storage</td>
<td>Store hash only, never plaintext</td>
</tr>
<tr>
<td>Single use</td>
<td>Token consumed on first use</td>
</tr>
<tr>
<td>Time-limited</td>
<td>30-minute expiration</td>
</tr>
<tr>
<td>Rate limiting</td>
<td>Max 3 requests per hour per email</td>
</tr>
<tr>
<td>No enumeration</td>
<td>Same response whether email exists or not</td>
</tr>
<tr>
<td>Session invalidation</td>
<td>All sessions cleared after reset</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7-biometric-authentication">7. Biometric Authentication<a class="header-link" href="#7-biometric-authentication" title="Permanent link">&para;</a></h2>
<h3 id="71-overview">7.1 Overview<a class="header-link" href="#71-overview" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="nt">Biometric</span><span class="w"> </span><span class="nt">Authentication</span><span class="w"> </span><span class="nt">Types</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">Physiological</span><span class="o">:</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Fingerprint</span><span class="w">   </span><span class="nt">-</span><span class="w"> </span><span class="nt">Most</span><span class="w"> </span><span class="nt">common</span><span class="o">,</span><span class="w"> </span><span class="nt">mature</span><span class="w"> </span><span class="nt">technology</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Face</span><span class="w">          </span><span class="nt">-</span><span class="w"> </span><span class="nt">Widespread</span><span class="w"> </span><span class="nt">on</span><span class="w"> </span><span class="nt">mobile</span><span class="w"> </span><span class="o">(</span><span class="nt">Face</span><span class="w"> </span><span class="nt">ID</span><span class="o">)</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Iris</span><span class="w">          </span><span class="nt">-</span><span class="w"> </span><span class="nt">High</span><span class="w"> </span><span class="nt">accuracy</span><span class="o">,</span><span class="w"> </span><span class="nt">expensive</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Retina</span><span class="w">        </span><span class="nt">-</span><span class="w"> </span><span class="nt">Very</span><span class="w"> </span><span class="nt">high</span><span class="w"> </span><span class="nt">accuracy</span><span class="o">,</span><span class="w"> </span><span class="nt">intrusive</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nt">Palm</span><span class="o">/</span><span class="nt">Vein</span><span class="w">     </span><span class="nt">-</span><span class="w"> </span><span class="nt">Contactless</span><span class="o">,</span><span class="w"> </span><span class="nt">increasingly</span><span class="w"> </span><span class="nt">popular</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">Behavioral</span><span class="o">:</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Voice</span><span class="w">         </span><span class="nt">-</span><span class="w"> </span><span class="nt">Convenient</span><span class="w"> </span><span class="nt">for</span><span class="w"> </span><span class="nt">phone</span><span class="w"> </span><span class="nt">systems</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Typing</span><span class="w"> </span><span class="nt">rhythm</span><span class="w"> </span><span class="nt">-</span><span class="w"> </span><span class="nt">Continuous</span><span class="w"> </span><span class="nt">authentication</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Gait</span><span class="w">          </span><span class="nt">-</span><span class="w"> </span><span class="nt">Walking</span><span class="w"> </span><span class="nt">pattern</span><span class="w"> </span><span class="nt">recognition</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nt">Signature</span><span class="w">     </span><span class="nt">-</span><span class="w"> </span><span class="nt">Dynamic</span><span class="w"> </span><span class="nt">analysis</span><span class="w"> </span><span class="o">(</span><span class="nt">pressure</span><span class="o">,</span><span class="w"> </span><span class="nt">speed</span><span class="o">)</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">Key</span><span class="w"> </span><span class="nt">Metrics</span><span class="o">:</span><span class="w">                                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">FAR</span><span class="w">         </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">False</span><span class="w"> </span><span class="nt">Acceptance</span><span class="w"> </span><span class="nt">Rate</span><span class="w">                     </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">             </span><span class="err">â”‚</span><span class="w"> </span><span class="o">(</span><span class="nt">impostor</span><span class="w"> </span><span class="nt">accepted</span><span class="w"> </span><span class="nt">as</span><span class="w"> </span><span class="nt">genuine</span><span class="o">)</span><span class="w">            </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">FRR</span><span class="w">         </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">False</span><span class="w"> </span><span class="nt">Rejection</span><span class="w"> </span><span class="nt">Rate</span><span class="w">                      </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">             </span><span class="err">â”‚</span><span class="w"> </span><span class="o">(</span><span class="nt">genuine</span><span class="w"> </span><span class="nt">user</span><span class="w"> </span><span class="nt">rejected</span><span class="o">)</span><span class="w">                   </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">EER</span><span class="w">         </span><span class="err">â”‚</span><span class="w"> </span><span class="nt">Equal</span><span class="w"> </span><span class="nt">Error</span><span class="w"> </span><span class="nt">Rate</span><span class="w">                          </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">             </span><span class="err">â”‚</span><span class="w"> </span><span class="o">(</span><span class="nt">where</span><span class="w"> </span><span class="nt">FAR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">FRR</span><span class="o">;</span><span class="w"> </span><span class="nt">lower</span><span class="w"> </span><span class="nt">is</span><span class="w"> </span><span class="nt">better</span><span class="o">)</span><span class="w">       </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="72-biometric-template-security">7.2 Biometric Template Security<a class="header-link" href="#72-biometric-template-security" title="Permanent link">&para;</a></h3>
<p>Biometric data requires special handling because, unlike passwords, biometric traits <strong>cannot be changed</strong> if compromised.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">           </span><span class="nv">Biometric</span><span class="w"> </span><span class="nv">Template</span><span class="w"> </span><span class="nv">Protection</span><span class="w">                           </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="nv">WRONG</span>:<span class="w"> </span><span class="nv">Store</span><span class="w"> </span><span class="nv">raw</span><span class="w"> </span><span class="nv">biometric</span><span class="w"> </span><span class="nv">data</span><span class="w">                                 </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">    </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">                               </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">Raw</span><span class="w"> </span><span class="nv">scan</span><span class="w"> </span>â”‚â”€â”€â”€â–¶â”‚<span class="w"> </span><span class="nv">Store</span><span class="w"> </span><span class="nv">image</span><span class="w">  </span>â”‚<span class="w">  </span>â†<span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="nv">breached</span>,<span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="nv">over</span><span class="w">    </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">    </span>â”‚<span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">database</span><span class="w">  </span>â”‚<span class="w">    </span><span class="ss">(</span><span class="nv">can</span><span class="err">&#39;t change fingerprint) â”‚</span>
<span class="err">â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚</span>
<span class="err">â”‚                                                                  â”‚</span>
<span class="err">â”‚  CORRECT: Cancelable biometrics / template protection            â”‚</span>
<span class="err">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚</span>
<span class="err">â”‚  â”‚ Raw scan â”‚â”€â”€â”€â–¶â”‚ Extract      â”‚â”€â”€â”€â–¶â”‚ Transform   â”‚           â”‚</span>
<span class="err">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ features     â”‚    â”‚ (one-way,   â”‚           â”‚</span>
<span class="err">â”‚                  â”‚ (minutiae)   â”‚    â”‚  cancelable)â”‚            â”‚</span>
<span class="err">â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚</span>
<span class="err">â”‚                                             â”‚                    â”‚</span>
<span class="err">â”‚                                      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”           â”‚</span>
<span class="err">â”‚                                      â”‚ Store       â”‚            â”‚</span>
<span class="err">â”‚                                      â”‚ template    â”‚            â”‚</span>
<span class="err">â”‚                                      â”‚ (revocable) â”‚            â”‚</span>
<span class="err">â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚</span>
<span class="err">â”‚                                                                  â”‚</span>
<span class="err">â”‚  On-Device Processing (preferred):                               â”‚</span>
<span class="err">â”‚  - Biometric matching happens on the device (Secure Enclave)    â”‚</span>
<span class="err">â”‚  - Server never sees biometric data                              â”‚</span>
<span class="err">â”‚  - Device releases a cryptographic key upon match                â”‚</span>
<span class="err">â”‚  - This is how Apple Face ID and Touch ID work                   â”‚</span>
<span class="err">â”‚                                                                  â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="73-biometric-tradeoffs">7.3 Biometric Tradeoffs<a class="header-link" href="#73-biometric-tradeoffs" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Factor</th>
<th>Passwords</th>
<th>TOTP</th>
<th>Biometrics</th>
<th>FIDO2</th>
</tr>
</thead>
<tbody>
<tr>
<td>Can be changed</td>
<td>Yes</td>
<td>Yes (re-enroll)</td>
<td><strong>No</strong></td>
<td>Yes (re-register)</td>
</tr>
<tr>
<td>Can be shared</td>
<td>Yes (bad)</td>
<td>Yes (bad)</td>
<td>Difficult</td>
<td>No</td>
</tr>
<tr>
<td>Can be forgotten</td>
<td>Yes</td>
<td>N/A</td>
<td>No</td>
<td>N/A</td>
</tr>
<tr>
<td>Spoofing risk</td>
<td>Phishing</td>
<td>Phishing</td>
<td>Presentation attack</td>
<td>Very low</td>
</tr>
<tr>
<td>Privacy concern</td>
<td>Low</td>
<td>Low</td>
<td><strong>High</strong></td>
<td>Low</td>
</tr>
<tr>
<td>Best used as</td>
<td>Primary factor</td>
<td>2nd factor</td>
<td>2nd factor (local)</td>
<td>2nd factor or passwordless</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8-authentication-architecture-patterns">8. Authentication Architecture Patterns<a class="header-link" href="#8-authentication-architecture-patterns" title="Permanent link">&para;</a></h2>
<h3 id="81-choosing-the-right-pattern">8.1 Choosing the Right Pattern<a class="header-link" href="#81-choosing-the-right-pattern" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">          </span><span class="nx">Authentication</span><span class="w"> </span><span class="nx">Pattern</span><span class="w"> </span><span class="nx">Decision</span><span class="w"> </span><span class="nx">Tree</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">What</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">application</span><span class="p">?</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Traditional</span><span class="w"> </span><span class="nx">web</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="p">(</span><span class="nx">server</span><span class="o">-</span><span class="nx">rendered</span><span class="p">)</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">Use</span><span class="p">:</span><span class="w"> </span><span class="nx">Server</span><span class="o">-</span><span class="nx">side</span><span class="w"> </span><span class="nx">sessions</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">HttpOnly</span><span class="w"> </span><span class="nx">cookies</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">SPA</span><span class="w"> </span><span class="p">(</span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="nx">Vue</span><span class="p">,</span><span class="w"> </span><span class="nx">etc</span><span class="p">.)</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">Use</span><span class="p">:</span><span class="w"> </span><span class="nx">OAuth</span><span class="w"> </span><span class="m m-Double">2.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">PKCE</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">       </span><span class="nx">Store</span><span class="w"> </span><span class="nx">access</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">memory</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">       </span><span class="nx">Store</span><span class="w"> </span><span class="nx">refresh</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">HttpOnly</span><span class="w"> </span><span class="nx">cookie</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Mobile</span><span class="w"> </span><span class="nx">app</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">Use</span><span class="p">:</span><span class="w"> </span><span class="nx">OAuth</span><span class="w"> </span><span class="m m-Double">2.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">PKCE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">Secure</span><span class="w"> </span><span class="nx">storage</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">       </span><span class="p">(</span><span class="nx">iOS</span><span class="w"> </span><span class="nx">Keychain</span><span class="p">,</span><span class="w"> </span><span class="nx">Android</span><span class="w"> </span><span class="nx">Keystore</span><span class="p">)</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">API</span><span class="o">-</span><span class="nx">to</span><span class="o">-</span><span class="nx">API</span><span class="w"> </span><span class="p">(</span><span class="nx">service</span><span class="w"> </span><span class="nx">mesh</span><span class="p">)</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">Use</span><span class="p">:</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="nx">Credentials</span><span class="w"> </span><span class="nx">flow</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">mTLS</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">       </span><span class="nx">Or</span><span class="p">:</span><span class="w"> </span><span class="nx">Service</span><span class="w"> </span><span class="nx">mesh</span><span class="w"> </span><span class="p">(</span><span class="nx">Istio</span><span class="p">)</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">automatic</span><span class="w"> </span><span class="nx">mTLS</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">Microservices</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">Use</span><span class="p">:</span><span class="w"> </span><span class="nx">JWT</span><span class="w"> </span><span class="p">(</span><span class="nx">RS256</span><span class="p">)</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">centralized</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="nx">service</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">          </span><span class="nx">Auth</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="nx">issues</span><span class="w"> </span><span class="nx">tokens</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">          </span><span class="nx">Each</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="nx">verifies</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">public</span><span class="w"> </span><span class="nx">key</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="82-centralized-authentication-auth-service-pattern">8.2 Centralized Authentication (Auth Service Pattern)<a class="header-link" href="#82-centralized-authentication-auth-service-pattern" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Microservices Authentication Architecture                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                    â”‚   API        â”‚                              â”‚
â”‚                    â”‚   Gateway    â”‚                              â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                           â”‚                                      â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚            â”‚              â”‚              â”‚                        â”‚
â”‚            â–¼              â–¼              â–¼                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚     â”‚ Service  â”‚  â”‚ Service  â”‚  â”‚ Service  â”‚                    â”‚
â”‚     â”‚    A     â”‚  â”‚    B     â”‚  â”‚    C     â”‚                    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚            â”‚              â”‚              â”‚                        â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                           â”‚                                      â”‚
â”‚                           â–¼                                      â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                    â”‚  Auth        â”‚                              â”‚
â”‚                    â”‚  Service     â”‚                              â”‚
â”‚                    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                              â”‚
â”‚                    â”‚  - Login     â”‚                              â”‚
â”‚                    â”‚  - Token     â”‚                              â”‚
â”‚                    â”‚    issuance  â”‚                              â”‚
â”‚                    â”‚  - User      â”‚                              â”‚
â”‚                    â”‚    managementâ”‚                              â”‚
â”‚                    â”‚  - JWKS      â”‚                              â”‚
â”‚                    â”‚    endpoint  â”‚                              â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                  â”‚
â”‚  Flow:                                                           â”‚
â”‚  1. Client authenticates with Auth Service â†’ gets JWT            â”‚
â”‚  2. Client sends JWT to API Gateway                              â”‚
â”‚  3. Gateway validates JWT signature (using public key from JWKS) â”‚
â”‚  4. Gateway forwards request + JWT claims to services            â”‚
â”‚  5. Services trust validated claims without re-validating        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="9-exercises">9. Exercises<a class="header-link" href="#9-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-implement-secure-password-storage">Exercise 1: Implement Secure Password Storage<a class="header-link" href="#exercise-1-implement-secure-password-storage" title="Permanent link">&para;</a></h3>
<p>Build a complete user registration and login system:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: Implement the following UserService class.</span>
<span class="sd">Use argon2 for password hashing.</span>
<span class="sd">Include input validation and proper error handling.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a new user.</span>
<span class="sd">        - Validate password strength (min 12 chars, not common)</span>
<span class="sd">        - Check username/email uniqueness</span>
<span class="sd">        - Hash password with argon2id</span>
<span class="sd">        - Return user info (without password hash)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authenticate a user.</span>
<span class="sd">        - Verify credentials</span>
<span class="sd">        - Implement account lockout after 5 failed attempts</span>
<span class="sd">        - Regenerate session on successful login</span>
<span class="sd">        - Return access + refresh tokens</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">change_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">old_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">new_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change user&#39;s password.</span>
<span class="sd">        - Verify old password</span>
<span class="sd">        - Validate new password</span>
<span class="sd">        - Invalidate all existing sessions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="exercise-2-totp-integration">Exercise 2: TOTP Integration<a class="header-link" href="#exercise-2-totp-integration" title="Permanent link">&para;</a></h3>
<p>Add TOTP-based 2FA to the UserService:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: Add these methods to UserService.</span>
<span class="sd">Use the pyotp library.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="c1"># ... (from Exercise 1)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">enable_2fa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enable TOTP 2FA for a user.</span>
<span class="sd">        Returns: {&quot;secret&quot;: ..., &quot;qr_uri&quot;: ..., &quot;backup_codes&quot;: [...]}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">verify_2fa_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify initial TOTP code to confirm setup.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">login_2fa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">totp_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Login with 2FA.</span>
<span class="sd">        - First verify password</span>
<span class="sd">        - Then verify TOTP code</span>
<span class="sd">        - Support backup codes as fallback</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="exercise-3-jwt-security-audit">Exercise 3: JWT Security Audit<a class="header-link" href="#exercise-3-jwt-security-audit" title="Permanent link">&para;</a></h3>
<p>Identify and fix the security issues in this code:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: Find and fix ALL security issues in this JWT implementation.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="n">SECRET</span> <span class="o">=</span> <span class="s2">&quot;mysecret&quot;</span>  <span class="c1"># Issue 1: ???</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">get_user_password</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span>  <span class="c1"># Issue 2: ???</span>
        <span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">SECRET</span><span class="p">)</span>  <span class="c1"># Issue 3: ???</span>

<span class="k">def</span><span class="w"> </span><span class="nf">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">])</span>  <span class="c1"># Issue 4: ???</span>
        <span class="k">return</span> <span class="n">payload</span>
    <span class="k">except</span><span class="p">:</span>  <span class="c1"># Issue 5: ???</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">protected_route</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">):</span>  <span class="c1"># Issue 6: ???</span>
            <span class="k">return</span> <span class="n">admin_dashboard</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">user_dashboard</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="s2">&quot;Unauthorized&quot;</span>
</code></pre></div>

<h3 id="exercise-4-oauth-20-flow-implementation">Exercise 4: OAuth 2.0 Flow Implementation<a class="header-link" href="#exercise-4-oauth-20-flow-implementation" title="Permanent link">&para;</a></h3>
<p>Implement a complete OAuth 2.0 client with PKCE:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: Complete this OAuth 2.0 client implementation.</span>
<span class="sd">Include PKCE, state validation, and secure token storage.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">OAuthClient</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">auth_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">token_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start_auth_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the authorization URL.</span>
<span class="sd">        Include PKCE code_challenge and state parameter.</span>
<span class="sd">        Returns the URL to redirect the user to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle the OAuth callback.</span>
<span class="sd">        - Verify state parameter</span>
<span class="sd">        - Exchange code for tokens using code_verifier</span>
<span class="sd">        - Return tokens</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Refresh an expired access token.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="exercise-5-password-reset-security-review">Exercise 5: Password Reset Security Review<a class="header-link" href="#exercise-5-password-reset-security-review" title="Permanent link">&para;</a></h3>
<p>Review this password reset flow and list all security issues:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: Identify ALL security vulnerabilities in this code.</span>
<span class="sd">Write a corrected version.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">string</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">reset_codes</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># email -&gt; code</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/forgot&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">forgot_password</span><span class="p">():</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">find_user</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Email not found&quot;</span><span class="p">,</span> <span class="mi">404</span>  <span class="c1"># Issue: ???</span>

    <span class="c1"># Generate 4-digit reset code</span>
    <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>  <span class="c1"># Issue: ???</span>
    <span class="n">reset_codes</span><span class="p">[</span><span class="n">email</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>  <span class="c1"># Issue: ???</span>

    <span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Your reset code is: </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;Code sent&quot;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/reset&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reset_password</span><span class="p">():</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
    <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">reset_codes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">email</span><span class="p">)</span> <span class="o">==</span> <span class="n">code</span><span class="p">:</span>  <span class="c1"># Issue: ???</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">find_user</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">new_password</span>  <span class="c1"># Issue: ???</span>
        <span class="n">db</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;Password updated&quot;</span>

    <span class="k">return</span> <span class="s2">&quot;Invalid code&quot;</span><span class="p">,</span> <span class="mi">400</span>
</code></pre></div>

<hr />
<h2 id="10-summary">10. Summary<a class="header-link" href="#10-summary" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">Authentication</span><span class="w"> </span><span class="n">Systems</span><span class="w"> </span><span class="n">Summary</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Password</span><span class="w"> </span><span class="n">Storage</span><span class="p">:</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">Argon2id</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">bcrypt</span><span class="w"> </span><span class="p">(</span><span class="n">NEVER</span><span class="w"> </span><span class="n">MD5</span><span class="o">/</span><span class="n">SHA1</span><span class="o">/</span><span class="n">SHA256</span><span class="w"> </span><span class="n">alone</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Automatic</span><span class="w"> </span><span class="n">salting</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">stretching</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Follow</span><span class="w"> </span><span class="n">NIST</span><span class="w"> </span><span class="n">SP</span><span class="w"> </span><span class="mi">800</span><span class="o">-</span><span class="mi">63</span><span class="n">B</span><span class="w"> </span><span class="n">guidelines</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Multi</span><span class="o">-</span><span class="n">Factor</span><span class="w"> </span><span class="n">Auth</span><span class="p">:</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">TOTP</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">minimum</span><span class="w"> </span><span class="n">recommended</span><span class="w"> </span><span class="mi">2</span><span class="n">nd</span><span class="w"> </span><span class="n">factor</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">FIDO2</span><span class="o">/</span><span class="n">WebAuthn</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">gold</span><span class="w"> </span><span class="n">standard</span><span class="w"> </span><span class="p">(</span><span class="n">phishing</span><span class="o">-</span><span class="n">resistant</span><span class="p">)</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">SMS</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">weakest</span><span class="w"> </span><span class="mi">2</span><span class="n">nd</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="p">(</span><span class="n">SIM</span><span class="w"> </span><span class="n">swapping</span><span class="p">)</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Always</span><span class="w"> </span><span class="n">provide</span><span class="w"> </span><span class="n">backup</span><span class="w"> </span><span class="n">codes</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">recovery</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">OAuth</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">OIDC</span><span class="p">:</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">Authorization</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="n">flow</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">PKCE</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Always</span><span class="w"> </span><span class="n">validate</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="p">(</span><span class="n">CSRF</span><span class="p">)</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">OIDC</span><span class="w"> </span><span class="n">adds</span><span class="w"> </span><span class="n">identity</span><span class="w"> </span><span class="n">layer</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="n">tokens</span><span class="p">)</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">OAuth</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Sessions</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">JWT</span><span class="p">:</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">HttpOnly</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Secure</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SameSite</span><span class="w"> </span><span class="n">cookies</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Regenerate</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">login</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">JWT</span><span class="p">:</span><span class="w"> </span><span class="n">short</span><span class="o">-</span><span class="n">lived</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">long</span><span class="o">-</span><span class="n">lived</span><span class="w"> </span><span class="n">refresh</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Always</span><span class="w"> </span><span class="n">specify</span><span class="w"> </span><span class="n">allowed</span><span class="w"> </span><span class="n">algorithms</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">JWT</span><span class="w"> </span><span class="n">verification</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Never</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="n">sensitive</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">JWT</span><span class="w"> </span><span class="n">payload</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Password</span><span class="w"> </span><span class="n">Reset</span><span class="p">:</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Cryptographically</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="p">(</span><span class="mi">256</span><span class="o">+</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="nb">hash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="n">itself</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Single</span><span class="o">-</span><span class="n">use</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="o">-</span><span class="n">limited</span><span class="w"> </span><span class="p">(</span><span class="mi">30</span><span class="w"> </span><span class="nb">min</span><span class="p">)</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Same</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="n">regardless</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="n">existence</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<p><strong>Previous</strong>: <a href="./04_TLS_and_PKI.md">04. TLS/SSL and Public Key Infrastructure</a> | <strong>Next</strong>: <a href="06_Authorization.md">06. Authorization and Access Control</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/04_TLS_and_PKI.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">TLS/SSL and Public Key Infrastructure</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/06_Authorization.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">06. Authorization and Access Control</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}