{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>06. Authorization and Access Control - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Security/">Security</a>
    <span class="separator">/</span>
    <span class="current">06. Authorization and Access Control</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>06. Authorization and Access Control</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/05_Authentication.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">05. Authentication Systems</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/07_OWASP_Top10.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">07. OWASP Top 10 (2021)</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#1-authentication-vs-authorization">1. Authentication vs Authorization</a></li>
<li><a href="#2-role-based-access-control-rbac">2. Role-Based Access Control (RBAC)</a><ul>
<li><a href="#21-rbac-concepts">2.1 RBAC Concepts</a></li>
<li><a href="#22-rbac-implementation-in-python">2.2 RBAC Implementation in Python</a></li>
<li><a href="#23-flask-rbac-middleware">2.3 Flask RBAC Middleware</a></li>
</ul>
</li>
<li><a href="#3-attribute-based-access-control-abac">3. Attribute-Based Access Control (ABAC)</a><ul>
<li><a href="#31-abac-concepts">3.1 ABAC Concepts</a></li>
<li><a href="#32-when-to-use-rbac-vs-abac">3.2 When to Use RBAC vs ABAC</a></li>
<li><a href="#33-abac-implementation">3.3 ABAC Implementation</a></li>
</ul>
</li>
<li><a href="#4-access-control-lists-acl">4. Access Control Lists (ACL)</a><ul>
<li><a href="#41-acl-concepts">4.1 ACL Concepts</a></li>
<li><a href="#42-acl-implementation">4.2 ACL Implementation</a></li>
</ul>
</li>
<li><a href="#5-policy-engines-opa-open-policy-agent">5. Policy Engines: OPA (Open Policy Agent)</a><ul>
<li><a href="#51-what-is-opa">5.1 What is OPA?</a></li>
<li><a href="#52-rego-policy-language">5.2 Rego Policy Language</a></li>
<li><a href="#53-integrating-opa-with-python">5.3 Integrating OPA with Python</a></li>
</ul>
</li>
<li><a href="#6-jwt-claims-for-authorization">6. JWT Claims for Authorization</a><ul>
<li><a href="#61-standard-and-custom-claims">6.1 Standard and Custom Claims</a></li>
<li><a href="#62-claim-based-authorization-middleware">6.2 Claim-Based Authorization Middleware</a></li>
</ul>
</li>
<li><a href="#7-oauth-20-scopes">7. OAuth 2.0 Scopes</a><ul>
<li><a href="#71-understanding-scopes">7.1 Understanding Scopes</a></li>
<li><a href="#72-scope-enforcement">7.2 Scope Enforcement</a></li>
</ul>
</li>
<li><a href="#8-resource-level-permissions">8. Resource-Level Permissions</a><ul>
<li><a href="#81-beyond-role-based-resource-ownership">8.1 Beyond Role-Based: Resource Ownership</a></li>
<li><a href="#82-implementation-multi-layer-authorization">8.2 Implementation: Multi-Layer Authorization</a></li>
</ul>
</li>
<li><a href="#9-common-authorization-vulnerabilities">9. Common Authorization Vulnerabilities</a><ul>
<li><a href="#91-idor-insecure-direct-object-reference">9.1 IDOR (Insecure Direct Object Reference)</a></li>
<li><a href="#92-privilege-escalation">9.2 Privilege Escalation</a></li>
<li><a href="#93-authorization-vulnerability-checklist">9.3 Authorization Vulnerability Checklist</a></li>
</ul>
</li>
<li><a href="#10-exercises">10. Exercises</a><ul>
<li><a href="#exercise-1-implement-rbac-system">Exercise 1: Implement RBAC System</a></li>
<li><a href="#exercise-2-build-abac-policy-engine">Exercise 2: Build ABAC Policy Engine</a></li>
<li><a href="#exercise-3-fix-authorization-vulnerabilities">Exercise 3: Fix Authorization Vulnerabilities</a></li>
<li><a href="#exercise-4-multi-tenant-authorization">Exercise 4: Multi-Tenant Authorization</a></li>
<li><a href="#exercise-5-opa-policy-writing">Exercise 5: OPA Policy Writing</a></li>
</ul>
</li>
<li><a href="#11-summary">11. Summary</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="06-authorization-and-access-control">06. Authorization and Access Control<a class="header-link" href="#06-authorization-and-access-control" title="Permanent link">&para;</a></h1>
<p><strong>Previous</strong>: <a href="05_Authentication.md">05. Authentication Systems</a> | <strong>Next</strong>: <a href="07_OWASP_Top10.md">07. OWASP Top 10 (2021)</a></p>
<hr />
<p>Authorization determines what an authenticated user is allowed to do. While authentication answers "Who are you?", authorization answers "What can you do?" A robust authorization system enforces the principle of least privilege, ensuring that users and services have only the minimum permissions necessary. This lesson covers the major access control models (RBAC, ABAC, ACL), policy engines, token-based authorization with JWT and OAuth scopes, practical implementation patterns in Python/Flask, and common authorization vulnerabilities.</p>
<h2 id="learning-objectives">Learning Objectives<a class="header-link" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<ul>
<li>Distinguish between authentication and authorization</li>
<li>Implement Role-Based Access Control (RBAC) systems</li>
<li>Understand Attribute-Based Access Control (ABAC) and when to use it</li>
<li>Work with Access Control Lists (ACLs) for resource-level permissions</li>
<li>Use policy engines like OPA (Open Policy Agent) for externalized authorization</li>
<li>Leverage JWT claims and OAuth 2.0 scopes for API authorization</li>
<li>Build authorization middleware and decorators in Flask</li>
<li>Identify and prevent common authorization vulnerabilities (IDOR, privilege escalation)</li>
</ul>
<hr />
<h2 id="1-authentication-vs-authorization">1. Authentication vs Authorization<a class="header-link" href="#1-authentication-vs-authorization" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">          </span><span class="nv">Authentication</span><span class="w"> </span><span class="nv">vs</span><span class="w"> </span><span class="nv">Authorization</span><span class="w">                         </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="nv">Authentication</span><span class="w"> </span><span class="ss">(</span><span class="nv">AuthN</span><span class="ss">)</span><span class="w">         </span><span class="nv">Authorization</span><span class="w"> </span><span class="ss">(</span><span class="nv">AuthZ</span><span class="ss">)</span><span class="w">            </span>â”‚
â”‚<span class="w">  </span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<span class="w">         </span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<span class="w">            </span>â”‚
â”‚<span class="w">  </span><span class="s2">&quot;Who are you?&quot;</span><span class="w">                </span><span class="s2">&quot;What can you do?&quot;</span><span class="w">                </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="nv">Verifies</span><span class="w"> </span><span class="nv">identity</span><span class="w">             </span><span class="nv">Verifies</span><span class="w"> </span><span class="nv">permissions</span><span class="w">              </span>â”‚
â”‚<span class="w">  </span><span class="nv">Happens</span><span class="w"> </span><span class="nv">FIRST</span><span class="w">                 </span><span class="nv">Happens</span><span class="w"> </span><span class="nv">AFTER</span><span class="w"> </span><span class="nv">authentication</span><span class="w">      </span>â”‚
â”‚<span class="w">  </span><span class="mi">401</span><span class="w"> </span><span class="nv">Unauthorized</span><span class="w">              </span><span class="mi">403</span><span class="w"> </span><span class="nv">Forbidden</span><span class="w">                     </span>â”‚
â”‚<span class="w">  </span><span class="ss">(</span><span class="nv">not</span><span class="w"> </span><span class="nv">authenticated</span><span class="ss">)</span><span class="w">           </span><span class="ss">(</span><span class="nv">authenticated</span><span class="w"> </span><span class="nv">but</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">allowed</span><span class="ss">)</span><span class="w">   </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="nv">Request</span><span class="w"> </span><span class="nv">Flow</span>:<span class="w">                                                   </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">    </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">    </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">           </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">Request</span><span class="w">  </span>â”‚â”€â”€â”€â–¶â”‚<span class="w"> </span><span class="nv">Authentication</span>â”‚â”€â”€â”€â–¶â”‚<span class="nv">Authorization</span>â”‚<span class="w">           </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">          </span>â”‚<span class="w">    </span>â”‚<span class="w"> </span><span class="s2">&quot;Who is this?&quot;</span>â”‚<span class="w">    </span>â”‚<span class="w"> </span><span class="err">&quot;Can they   â”‚           â”‚</span>
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">    </span>â”‚<span class="w">              </span>â”‚<span class="w">    </span>â”‚<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="nv">this</span>?<span class="err">&quot;  â”‚            â”‚</span>
<span class="err">â”‚                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚</span>
<span class="err">â”‚                         â”‚                   â”‚                    â”‚</span>
<span class="err">â”‚                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”               â”‚</span>
<span class="err">â”‚                    â”‚        â”‚          â”‚        â”‚                â”‚</span>
<span class="err">â”‚                  Valid   Invalid     Allowed  Denied             â”‚</span>
<span class="err">â”‚                    â”‚        â”‚          â”‚        â”‚                â”‚</span>
<span class="err">â”‚                    â”‚    401 Error      â”‚    403 Error            â”‚</span>
<span class="err">â”‚                    â”‚                   â”‚                          â”‚</span>
<span class="err">â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚</span>
<span class="err">â”‚                            â”‚                                     â”‚</span>
<span class="err">â”‚                            â–¼                                     â”‚</span>
<span class="err">â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚</span>
<span class="err">â”‚                     â”‚ Resource â”‚                                 â”‚</span>
<span class="err">â”‚                     â”‚  Access  â”‚                                 â”‚</span>
<span class="err">â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚</span>
<span class="err">â”‚                                                                  â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="2-role-based-access-control-rbac">2. Role-Based Access Control (RBAC)<a class="header-link" href="#2-role-based-access-control-rbac" title="Permanent link">&para;</a></h2>
<h3 id="21-rbac-concepts">2.1 RBAC Concepts<a class="header-link" href="#21-rbac-concepts" title="Permanent link">&para;</a></h3>
<p>RBAC assigns permissions to <strong>roles</strong>, and users are assigned to roles. This simplifies management because you manage role-permission mappings rather than individual user permissions.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RBAC Model                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Users              Roles              Permissions               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Alice  â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Admin   â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ create_user      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚          â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ delete_user      â”‚     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚          â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ view_reports     â”‚     â”‚
â”‚  â”‚  Bob   â”‚â”€â”€â”€â”    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â–¶â”‚ manage_settings  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚               â””â”€â”€â”€â–¶â”‚  Editor  â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚          â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ create_post      â”‚     â”‚
â”‚  â”‚ Carol  â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚          â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ edit_post        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â–¶â”‚ delete_own_post  â”‚     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”‚  Dan   â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Viewer  â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚          â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ view_post        â”‚     â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â–¶â”‚ view_reports     â”‚     â”‚
â”‚                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                  â”‚
â”‚  Hierarchy (optional):                                           â”‚
â”‚  Admin â”€â”€â–¶ Editor â”€â”€â–¶ Viewer                                    â”‚
â”‚  (Admin inherits all Editor and Viewer permissions)              â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="22-rbac-implementation-in-python">2.2 RBAC Implementation in Python<a class="header-link" href="#22-rbac-implementation-in-python" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">rbac.py - Role-Based Access Control implementation</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Core RBAC Model</span>
<span class="c1"># ==============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Permission</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define all permissions in the system.&quot;&quot;&quot;</span>
    <span class="c1"># User management</span>
    <span class="n">CREATE_USER</span> <span class="o">=</span> <span class="s2">&quot;user:create&quot;</span>
    <span class="n">READ_USER</span> <span class="o">=</span> <span class="s2">&quot;user:read&quot;</span>
    <span class="n">UPDATE_USER</span> <span class="o">=</span> <span class="s2">&quot;user:update&quot;</span>
    <span class="n">DELETE_USER</span> <span class="o">=</span> <span class="s2">&quot;user:delete&quot;</span>

    <span class="c1"># Post management</span>
    <span class="n">CREATE_POST</span> <span class="o">=</span> <span class="s2">&quot;post:create&quot;</span>
    <span class="n">READ_POST</span> <span class="o">=</span> <span class="s2">&quot;post:read&quot;</span>
    <span class="n">UPDATE_POST</span> <span class="o">=</span> <span class="s2">&quot;post:update&quot;</span>
    <span class="n">DELETE_POST</span> <span class="o">=</span> <span class="s2">&quot;post:delete&quot;</span>
    <span class="n">PUBLISH_POST</span> <span class="o">=</span> <span class="s2">&quot;post:publish&quot;</span>

    <span class="c1"># Report management</span>
    <span class="n">VIEW_REPORTS</span> <span class="o">=</span> <span class="s2">&quot;report:view&quot;</span>
    <span class="n">EXPORT_REPORTS</span> <span class="o">=</span> <span class="s2">&quot;report:export&quot;</span>

    <span class="c1"># System</span>
    <span class="n">MANAGE_SETTINGS</span> <span class="o">=</span> <span class="s2">&quot;system:settings&quot;</span>
    <span class="n">VIEW_AUDIT_LOG</span> <span class="o">=</span> <span class="s2">&quot;system:audit&quot;</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Role</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A role is a named collection of permissions.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">permissions</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Permission</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">set</span><span class="p">)</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;Role&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># For role hierarchy</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">Permission</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all permissions including inherited ones.&quot;&quot;&quot;</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="n">perms</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_all_permissions</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">perms</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="n">Permission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this role has a specific permission.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">permission</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_permissions</span><span class="p">()</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A user with one or more roles.&quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">roles</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Role</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">set</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="n">Permission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if user has a specific permission through any role.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">role</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">permission</span><span class="p">)</span> <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if user has a specific role.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">role</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">role_name</span> <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">Permission</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all permissions from all roles.&quot;&quot;&quot;</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
            <span class="n">perms</span> <span class="o">|=</span> <span class="n">role</span><span class="o">.</span><span class="n">get_all_permissions</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">perms</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Role Definitions</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_default_roles</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Role</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the default role hierarchy.&quot;&quot;&quot;</span>

    <span class="c1"># Base role - everyone gets these</span>
    <span class="n">viewer</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;viewer&quot;</span><span class="p">,</span>
        <span class="n">permissions</span><span class="o">=</span><span class="p">{</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">READ_POST</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">READ_USER</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">VIEW_REPORTS</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Editor inherits from Viewer</span>
    <span class="n">editor</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;editor&quot;</span><span class="p">,</span>
        <span class="n">permissions</span><span class="o">=</span><span class="p">{</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">CREATE_POST</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">UPDATE_POST</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">DELETE_POST</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">PUBLISH_POST</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">EXPORT_REPORTS</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">viewer</span>
    <span class="p">)</span>

    <span class="c1"># Admin inherits from Editor</span>
    <span class="n">admin</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span>
        <span class="n">permissions</span><span class="o">=</span><span class="p">{</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">CREATE_USER</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">UPDATE_USER</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">DELETE_USER</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">MANAGE_SETTINGS</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">VIEW_AUDIT_LOG</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">editor</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;viewer&quot;</span><span class="p">:</span> <span class="n">viewer</span><span class="p">,</span>
        <span class="s2">&quot;editor&quot;</span><span class="p">:</span> <span class="n">editor</span><span class="p">,</span>
        <span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="n">admin</span><span class="p">,</span>
    <span class="p">}</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># RBAC Manager</span>
<span class="c1"># ==============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RBACManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Centralized RBAC management.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">create_default_roles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">User</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">role_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">User</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a user with specified roles.&quot;&quot;&quot;</span>
        <span class="n">roles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">role_names</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;viewer&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
                <span class="n">roles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown role: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="n">roles</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">assign_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">role_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign a role to a user.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">role_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Role </span><span class="si">{</span><span class="n">role_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">[</span><span class="n">role_name</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">revoke_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">role_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a role from a user.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">roles</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">role_name</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="n">Permission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a user has a specific permission.&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">permission</span><span class="p">)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Demo</span>
<span class="c1"># ==============================================================</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">rbac</span> <span class="o">=</span> <span class="n">RBACManager</span><span class="p">()</span>

    <span class="c1"># Create users</span>
    <span class="n">alice</span> <span class="o">=</span> <span class="n">rbac</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">])</span>
    <span class="n">bob</span> <span class="o">=</span> <span class="n">rbac</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;editor&quot;</span><span class="p">])</span>
    <span class="n">carol</span> <span class="o">=</span> <span class="n">rbac</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;carol&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;viewer&quot;</span><span class="p">])</span>

    <span class="c1"># Check permissions</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Permission Checks ===&quot;</span><span class="p">)</span>
    <span class="n">checks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">alice</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">DELETE_USER</span><span class="p">,</span> <span class="s2">&quot;Alice can delete users&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">alice</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">READ_POST</span><span class="p">,</span> <span class="s2">&quot;Alice can read posts (inherited)&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">bob</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">CREATE_POST</span><span class="p">,</span> <span class="s2">&quot;Bob can create posts&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">bob</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">DELETE_USER</span><span class="p">,</span> <span class="s2">&quot;Bob can delete users&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">carol</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">READ_POST</span><span class="p">,</span> <span class="s2">&quot;Carol can read posts&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">carol</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">CREATE_POST</span><span class="p">,</span> <span class="s2">&quot;Carol can create posts&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;ALLOWED&quot;</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="s2">&quot;DENIED&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># List all permissions</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Alice&#39;s permissions: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">alice</span><span class="o">.</span><span class="n">get_all_permissions</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">alice</span><span class="o">.</span><span class="n">get_all_permissions</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="23-flask-rbac-middleware">2.3 Flask RBAC Middleware<a class="header-link" href="#23-flask-rbac-middleware" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">flask_rbac.py - RBAC authorization middleware for Flask</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;your-secret-key&#39;</span>  <span class="c1"># Use env var in production</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Authorization Decorators</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">require_auth</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator: Require authenticated user.&quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Authentication required&quot;</span><span class="p">}),</span> <span class="mi">401</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                <span class="n">token</span><span class="p">,</span>
                <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">],</span>
                <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HS256&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">],</span>
                <span class="s1">&#39;roles&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="s1">&#39;permissions&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;permissions&#39;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Invalid token: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}),</span> <span class="mi">401</span>

        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">decorated</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_role</span><span class="p">(</span><span class="o">*</span><span class="n">allowed_roles</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator: Require user to have one of the specified roles.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="nd">@require_auth</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">user_roles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_roles</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">allowed_roles</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Forbidden&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Required roles: </span><span class="si">{</span><span class="n">allowed_roles</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">}),</span> <span class="mi">403</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_permission</span><span class="p">(</span><span class="o">*</span><span class="n">required_permissions</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator: Require user to have all specified permissions.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="nd">@require_auth</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">user_perms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;permissions&#39;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_permissions</span><span class="p">)</span> <span class="o">-</span> <span class="n">user_perms</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Forbidden&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Missing permissions: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">}),</span> <span class="mi">403</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Protected Routes</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_posts</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Any authenticated user can list posts.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;posts&quot;</span><span class="p">:</span> <span class="p">[]})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_permission</span><span class="p">(</span><span class="s1">&#39;post:create&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_post</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Only users with post:create permission.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="c1"># Create post logic...</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Post created&quot;</span><span class="p">}),</span> <span class="mi">201</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts/&lt;int:post_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@require_permission</span><span class="p">(</span><span class="s1">&#39;post:delete&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Only users with post:delete permission.&quot;&quot;&quot;</span>
    <span class="c1"># Additional check: can only delete own posts unless admin</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>  <span class="c1"># Your DB lookup</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span>
    <span class="n">is_admin</span> <span class="o">=</span> <span class="s1">&#39;admin&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">is_owner</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;author_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_admin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_owner</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Can only delete your own posts&quot;</span><span class="p">}),</span> <span class="mi">403</span>

    <span class="c1"># Delete post logic...</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Post deleted&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@require_role</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_users</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Admin-only endpoint.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[]})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/settings&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="nd">@require_role</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_settings</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Admin-only: modify system settings.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="c1"># Update settings logic...</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Settings updated&quot;</span><span class="p">})</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Dynamic Permission Check (for resource-level auth)</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">check_resource_access</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">resource_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a user can perform an action on a specific resource.</span>
<span class="sd">    This goes beyond role-based checks to resource-level authorization.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Example: Check if user owns the resource or has admin role</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">get_resource</span><span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Admin can do anything</span>
    <span class="k">if</span> <span class="s1">&#39;admin&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># Owner can read/update their own resources</span>
    <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># Check shared access</span>
    <span class="n">shared_with</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shared_with&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">for</span> <span class="n">share</span> <span class="ow">in</span> <span class="n">shared_with</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">share</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">share</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allowed_actions&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>

<hr />
<h2 id="3-attribute-based-access-control-abac">3. Attribute-Based Access Control (ABAC)<a class="header-link" href="#3-attribute-based-access-control-abac" title="Permanent link">&para;</a></h2>
<h3 id="31-abac-concepts">3.1 ABAC Concepts<a class="header-link" href="#31-abac-concepts" title="Permanent link">&para;</a></h3>
<p>ABAC makes access decisions based on <strong>attributes</strong> of the subject (user), resource, action, and environment. It is more flexible than RBAC but also more complex.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="nx">ABAC</span><span class="w"> </span><span class="nx">Model</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Access</span><span class="w"> </span><span class="nx">Decision</span><span class="w"> </span><span class="p">=</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="nx">f</span><span class="p">(</span><span class="nx">Subject</span><span class="w"> </span><span class="nx">Attributes</span><span class="p">,</span><span class="w"> </span><span class="nx">Resource</span><span class="w"> </span><span class="nx">Attributes</span><span class="p">,</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="nx">Action</span><span class="w"> </span><span class="nx">Attributes</span><span class="p">,</span><span class="w"> </span><span class="nx">Environment</span><span class="w"> </span><span class="nx">Attributes</span><span class="p">)</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Subject</span><span class="w"> </span><span class="nx">Attributes</span><span class="p">:</span><span class="w">     </span><span class="nx">Resource</span><span class="w"> </span><span class="nx">Attributes</span><span class="p">:</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">role</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;doctor&quot;</span><span class="w">      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;medical_record&quot;</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">department</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ER&quot;</span><span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">department</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ER&quot;</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">clearance</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;L3&quot;</span><span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">sensitivity</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;L2&quot;</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">certification</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">owner</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;patient_123&quot;</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Action</span><span class="w"> </span><span class="nx">Attributes</span><span class="p">:</span><span class="w">      </span><span class="nx">Environment</span><span class="w"> </span><span class="nx">Attributes</span><span class="p">:</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;read&quot;</span><span class="w">        </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">time</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;14:30 UTC&quot;</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">purpose</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;treatment&quot;</span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">ip_address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.0.1.50&quot;</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                          </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">location</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;hospital_network&quot;</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                          </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">device_trust</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;managed&quot;</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Policy</span><span class="w"> </span><span class="nx">Example</span><span class="p">:</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="s">&quot;A doctor in the ER department can read medical records          â”‚</span>
<span class="s">â”‚   in the ER department during work hours from hospital            â”‚</span>
<span class="s">â”‚   network on a managed device.&quot;</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Subject</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;doctor&quot;</span><span class="w"> </span><span class="nx">AND</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Subject</span><span class="p">.</span><span class="nx">department</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">Resource</span><span class="p">.</span><span class="nx">department</span><span class="w"> </span><span class="nx">AND</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Action</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;read&quot;</span><span class="w"> </span><span class="nx">AND</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Environment</span><span class="p">.</span><span class="nx">time</span><span class="w"> </span><span class="nx">BETWEEN</span><span class="w"> </span><span class="s">&quot;07:00&quot;</span><span class="w"> </span><span class="nx">AND</span><span class="w"> </span><span class="s">&quot;19:00&quot;</span><span class="w"> </span><span class="nx">AND</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Environment</span><span class="p">.</span><span class="nx">location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;hospital_network&quot;</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="nx">ALLOW</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="32-when-to-use-rbac-vs-abac">3.2 When to Use RBAC vs ABAC<a class="header-link" href="#32-when-to-use-rbac-vs-abac" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Criteria</th>
<th>RBAC</th>
<th>ABAC</th>
</tr>
</thead>
<tbody>
<tr>
<td>Number of roles</td>
<td>Small, well-defined</td>
<td>Many or dynamic</td>
</tr>
<tr>
<td>Access decisions</td>
<td>Role membership</td>
<td>Multiple attributes</td>
</tr>
<tr>
<td>Complexity</td>
<td>Simple to implement</td>
<td>Complex but flexible</td>
</tr>
<tr>
<td>"Role explosion"</td>
<td>Risk (too many roles)</td>
<td>Not an issue</td>
</tr>
<tr>
<td>Context-aware</td>
<td>No (static roles)</td>
<td>Yes (time, location, etc.)</td>
</tr>
<tr>
<td>Compliance</td>
<td>Basic needs</td>
<td>Regulatory requirements</td>
</tr>
<tr>
<td>Best for</td>
<td>Most web apps, APIs</td>
<td>Healthcare, finance, government</td>
</tr>
<tr>
<td>Performance</td>
<td>Fast (role lookup)</td>
<td>Slower (policy evaluation)</td>
</tr>
</tbody>
</table>
<h3 id="33-abac-implementation">3.3 ABAC Implementation<a class="header-link" href="#33-abac-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">abac.py - Attribute-Based Access Control implementation</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Decision</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">ALLOW</span> <span class="o">=</span> <span class="s2">&quot;allow&quot;</span>
    <span class="n">DENY</span> <span class="o">=</span> <span class="s2">&quot;deny&quot;</span>
    <span class="n">NOT_APPLICABLE</span> <span class="o">=</span> <span class="s2">&quot;not_applicable&quot;</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AccessRequest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a request for access to a resource.&quot;&quot;&quot;</span>
    <span class="c1"># Subject attributes (who)</span>
    <span class="n">subject</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

    <span class="c1"># Resource attributes (what)</span>
    <span class="n">resource</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

    <span class="c1"># Action attributes (how)</span>
    <span class="n">action</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

    <span class="c1"># Environment attributes (context)</span>
    <span class="n">environment</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Policy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single ABAC policy.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># Lower = higher priority</span>
    <span class="n">effect</span><span class="p">:</span> <span class="n">Decision</span>  <span class="c1"># ALLOW or DENY</span>
    <span class="n">condition</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">AccessRequest</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">AccessRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decision</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate this policy against a request.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect</span>
            <span class="k">return</span> <span class="n">Decision</span><span class="o">.</span><span class="n">NOT_APPLICABLE</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Decision</span><span class="o">.</span><span class="n">NOT_APPLICABLE</span>


<span class="k">class</span><span class="w"> </span><span class="nc">PolicyEngine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluates access requests against a set of policies.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_decision</span><span class="p">:</span> <span class="n">Decision</span> <span class="o">=</span> <span class="n">Decision</span><span class="o">.</span><span class="n">DENY</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Policy</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_decision</span> <span class="o">=</span> <span class="n">default_decision</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">Policy</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a policy to the engine.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
        <span class="c1"># Keep sorted by priority</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">AccessRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decision</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate all policies. Uses deny-overrides combining algorithm:</span>
<span class="sd">        - If any policy says DENY, result is DENY</span>
<span class="sd">        - If at least one says ALLOW and none say DENY, result is ALLOW</span>
<span class="sd">        - Otherwise, use default decision</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">has_allow</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
            <span class="n">decision</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">decision</span> <span class="o">==</span> <span class="n">Decision</span><span class="o">.</span><span class="n">DENY</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Decision</span><span class="o">.</span><span class="n">DENY</span>  <span class="c1"># Deny overrides</span>

            <span class="k">if</span> <span class="n">decision</span> <span class="o">==</span> <span class="n">Decision</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">:</span>
                <span class="n">has_allow</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">Decision</span><span class="o">.</span><span class="n">ALLOW</span> <span class="k">if</span> <span class="n">has_allow</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_decision</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Example Policies</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_medical_policies</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PolicyEngine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create policies for a healthcare system.&quot;&quot;&quot;</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">PolicyEngine</span><span class="p">(</span><span class="n">default_decision</span><span class="o">=</span><span class="n">Decision</span><span class="o">.</span><span class="n">DENY</span><span class="p">)</span>

    <span class="c1"># Policy 1: Doctors can read patient records in their department</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="n">Policy</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;doctor_read_department_records&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Doctors can read records in their department&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">effect</span><span class="o">=</span><span class="n">Decision</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">,</span>
        <span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">req</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;doctor&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;read&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;medical_record&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;department&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;department&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">))</span>

    <span class="c1"># Policy 2: Doctors can write records for their patients</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="n">Policy</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;doctor_write_own_patients&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Doctors can update records of patients assigned to them&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">effect</span><span class="o">=</span><span class="n">Decision</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">,</span>
        <span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">req</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;doctor&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;write&quot;</span><span class="p">,</span> <span class="s2">&quot;update&quot;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;medical_record&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assigned_doctors&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="p">)</span>
    <span class="p">))</span>

    <span class="c1"># Policy 3: Nurses can read records in their department during shifts</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="n">Policy</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;nurse_read_during_shift&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Nurses can read records during their shift hours&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">effect</span><span class="o">=</span><span class="n">Decision</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">,</span>
        <span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">req</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;nurse&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;read&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;medical_record&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;department&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;department&quot;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">_is_during_shift</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">),</span>
                            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shift_start&quot;</span><span class="p">),</span>
                            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shift_end&quot;</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="p">))</span>

    <span class="c1"># Policy 4: No access from untrusted devices</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="n">Policy</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;deny_untrusted_devices&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Deny access from non-managed devices&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># High priority - evaluated first</span>
        <span class="n">effect</span><span class="o">=</span><span class="n">Decision</span><span class="o">.</span><span class="n">DENY</span><span class="p">,</span>
        <span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">req</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">req</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;high&quot;</span><span class="p">,</span> <span class="s2">&quot;critical&quot;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_trust&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;managed&quot;</span>
        <span class="p">)</span>
    <span class="p">))</span>

    <span class="c1"># Policy 5: Emergency override - on-duty doctors in ER</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="n">Policy</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;emergency_override&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ER doctors can access any record during emergency&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">effect</span><span class="o">=</span><span class="n">Decision</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">,</span>
        <span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">req</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;doctor&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;department&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;emergency&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;read&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;emergency_mode&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="p">)</span>
    <span class="p">))</span>

    <span class="k">return</span> <span class="n">engine</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_is_during_shift</span><span class="p">(</span><span class="n">current_time</span><span class="p">,</span> <span class="n">shift_start</span><span class="p">,</span> <span class="n">shift_end</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if current time is within shift hours.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">current_time</span><span class="p">,</span> <span class="n">shift_start</span><span class="p">,</span> <span class="n">shift_end</span><span class="p">]):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_time</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">shift_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">shift_start</span><span class="p">)</span>
    <span class="n">shift_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">shift_end</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shift_start</span> <span class="o">&lt;=</span> <span class="n">shift_end</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">shift_start</span> <span class="o">&lt;=</span> <span class="n">current_time</span> <span class="o">&lt;=</span> <span class="n">shift_end</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Overnight shift</span>
        <span class="k">return</span> <span class="n">current_time</span> <span class="o">&gt;=</span> <span class="n">shift_start</span> <span class="ow">or</span> <span class="n">current_time</span> <span class="o">&lt;=</span> <span class="n">shift_end</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Demo</span>
<span class="c1"># ==============================================================</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_medical_policies</span><span class="p">()</span>

    <span class="c1"># Test Case 1: Doctor reading records in their department</span>
    <span class="n">request1</span> <span class="o">=</span> <span class="n">AccessRequest</span><span class="p">(</span>
        <span class="n">subject</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dr_smith&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;doctor&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;cardiology&quot;</span><span class="p">},</span>
        <span class="n">resource</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;medical_record&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;cardiology&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;sensitivity&quot;</span><span class="p">:</span> <span class="s2">&quot;high&quot;</span><span class="p">},</span>
        <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;read&quot;</span><span class="p">},</span>
        <span class="n">environment</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;device_trust&quot;</span><span class="p">:</span> <span class="s2">&quot;managed&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-01-15T10:30:00&quot;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Doctor reads own dept: </span><span class="si">{</span><span class="n">engine</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">request1</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Test Case 2: Doctor reading records in different department</span>
    <span class="n">request2</span> <span class="o">=</span> <span class="n">AccessRequest</span><span class="p">(</span>
        <span class="n">subject</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dr_smith&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;doctor&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;cardiology&quot;</span><span class="p">},</span>
        <span class="n">resource</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;medical_record&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;neurology&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;sensitivity&quot;</span><span class="p">:</span> <span class="s2">&quot;high&quot;</span><span class="p">},</span>
        <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;read&quot;</span><span class="p">},</span>
        <span class="n">environment</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;device_trust&quot;</span><span class="p">:</span> <span class="s2">&quot;managed&quot;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Doctor reads other dept: </span><span class="si">{</span><span class="n">engine</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">request2</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Test Case 3: Access from untrusted device (denied regardless)</span>
    <span class="n">request3</span> <span class="o">=</span> <span class="n">AccessRequest</span><span class="p">(</span>
        <span class="n">subject</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dr_smith&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;doctor&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;cardiology&quot;</span><span class="p">},</span>
        <span class="n">resource</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;medical_record&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;cardiology&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;sensitivity&quot;</span><span class="p">:</span> <span class="s2">&quot;high&quot;</span><span class="p">},</span>
        <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;read&quot;</span><span class="p">},</span>
        <span class="n">environment</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;device_trust&quot;</span><span class="p">:</span> <span class="s2">&quot;personal&quot;</span><span class="p">}</span>  <span class="c1"># Not managed!</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Untrusted device: </span><span class="si">{</span><span class="n">engine</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">request3</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Test Case 4: Emergency override</span>
    <span class="n">request4</span> <span class="o">=</span> <span class="n">AccessRequest</span><span class="p">(</span>
        <span class="n">subject</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dr_jones&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;doctor&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;emergency&quot;</span><span class="p">},</span>
        <span class="n">resource</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;medical_record&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;cardiology&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;sensitivity&quot;</span><span class="p">:</span> <span class="s2">&quot;critical&quot;</span><span class="p">},</span>
        <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;read&quot;</span><span class="p">},</span>
        <span class="n">environment</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;device_trust&quot;</span><span class="p">:</span> <span class="s2">&quot;managed&quot;</span><span class="p">,</span> <span class="s2">&quot;emergency_mode&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Emergency override: </span><span class="si">{</span><span class="n">engine</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">request4</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="4-access-control-lists-acl">4. Access Control Lists (ACL)<a class="header-link" href="#4-access-control-lists-acl" title="Permanent link">&para;</a></h2>
<h3 id="41-acl-concepts">4.1 ACL Concepts<a class="header-link" href="#41-acl-concepts" title="Permanent link">&para;</a></h3>
<p>ACLs define permissions at the <strong>individual resource level</strong>. Each resource has a list of entries specifying which subjects (users, groups) can perform which actions.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="nx">ACL</span><span class="w"> </span><span class="nx">Model</span><span class="w">                                     </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Project Plan.docx&quot;</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">ACL</span><span class="w"> </span><span class="nx">Entry</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Permissions</span><span class="w">                      </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">alice</span><span class="w"> </span><span class="p">(</span><span class="nx">owner</span><span class="p">)</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">read</span><span class="p">,</span><span class="w"> </span><span class="nx">write</span><span class="p">,</span><span class="w"> </span><span class="nx">delete</span><span class="p">,</span><span class="w"> </span><span class="nx">share</span><span class="w">      </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">bob</span><span class="w">                 </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">read</span><span class="p">,</span><span class="w"> </span><span class="nx">write</span><span class="w">                     </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">carol</span><span class="w">               </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">read</span><span class="w">                            </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">engineering</span><span class="w"> </span><span class="p">(</span><span class="nx">group</span><span class="p">)</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">read</span><span class="p">,</span><span class="w"> </span><span class="nx">comment</span><span class="w">                   </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">everyone</span><span class="p">)</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="nx">no</span><span class="w"> </span><span class="nx">access</span><span class="p">)</span><span class="w">                     </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Company Financials.xlsx&quot;</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">ACL</span><span class="w"> </span><span class="nx">Entry</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Permissions</span><span class="w">                      </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">alice</span><span class="w"> </span><span class="p">(</span><span class="nx">owner</span><span class="p">)</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">read</span><span class="p">,</span><span class="w"> </span><span class="nx">write</span><span class="p">,</span><span class="w"> </span><span class="nx">delete</span><span class="p">,</span><span class="w"> </span><span class="nx">share</span><span class="w">      </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">finance</span><span class="w"> </span><span class="p">(</span><span class="nx">group</span><span class="p">)</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">read</span><span class="p">,</span><span class="w"> </span><span class="nx">write</span><span class="w">                     </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">ceo</span><span class="w">                 </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">read</span><span class="w">                            </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">everyone</span><span class="p">)</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="nx">no</span><span class="w"> </span><span class="nx">access</span><span class="p">)</span><span class="w">                     </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Unix</span><span class="w"> </span><span class="nx">File</span><span class="w"> </span><span class="nx">Permissions</span><span class="w"> </span><span class="p">(</span><span class="nx">simplified</span><span class="w"> </span><span class="nx">ACL</span><span class="p">):</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="nx">rwxr</span><span class="o">-</span><span class="nx">xr</span><span class="o">--</span><span class="w">  </span><span class="nx">owner</span><span class="w">  </span><span class="nx">group</span><span class="w">  </span><span class="nx">file</span><span class="p">.</span><span class="nx">txt</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚â”‚â”‚</span><span class="w"> </span><span class="err">â”‚â”‚â”‚</span><span class="w"> </span><span class="err">â”‚â”‚â”‚</span><span class="w">                                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚â”‚â”‚</span><span class="w"> </span><span class="err">â”‚â”‚â”‚</span><span class="w"> </span><span class="err">â””â”´â”´â”€â”€</span><span class="w"> </span><span class="nx">Others</span><span class="p">:</span><span class="w"> </span><span class="nx">read</span><span class="w"> </span><span class="nx">only</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚â”‚â”‚</span><span class="w"> </span><span class="err">â””â”´â”´â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="nx">Group</span><span class="p">:</span><span class="w"> </span><span class="nx">read</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">execute</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”´â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="nx">Owner</span><span class="p">:</span><span class="w"> </span><span class="nx">read</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">write</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">execute</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="42-acl-implementation">4.2 ACL Implementation<a class="header-link" href="#42-acl-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">acl.py - Access Control List implementation for resource-level permissions</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flag</span><span class="p">,</span> <span class="n">auto</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ACLPermission</span><span class="p">(</span><span class="n">Flag</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Permission flags (combinable with bitwise OR).&quot;&quot;&quot;</span>
    <span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">READ</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">WRITE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">DELETE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">SHARE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">ADMIN</span> <span class="o">=</span> <span class="n">READ</span> <span class="o">|</span> <span class="n">WRITE</span> <span class="o">|</span> <span class="n">DELETE</span> <span class="o">|</span> <span class="n">SHARE</span>  <span class="c1"># All permissions combined</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ACLEntry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single ACL entry mapping a principal to permissions.&quot;&quot;&quot;</span>
    <span class="n">principal_type</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &quot;user&quot; or &quot;group&quot;</span>
    <span class="n">principal_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">permissions</span><span class="p">:</span> <span class="n">ACLPermission</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Resource</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A resource with an access control list.&quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">owner_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">acl</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ACLEntry</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">grant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">principal_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">principal_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">permissions</span><span class="p">:</span> <span class="n">ACLPermission</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Grant permissions to a principal.&quot;&quot;&quot;</span>
        <span class="c1"># Check if entry already exists</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">principal_type</span> <span class="o">==</span> <span class="n">principal_type</span> <span class="ow">and</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">principal_id</span> <span class="o">==</span> <span class="n">principal_id</span><span class="p">):</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">permissions</span> <span class="o">|=</span> <span class="n">permissions</span>  <span class="c1"># Add permissions</span>
                <span class="k">return</span>

        <span class="c1"># Create new entry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ACLEntry</span><span class="p">(</span>
            <span class="n">principal_type</span><span class="o">=</span><span class="n">principal_type</span><span class="p">,</span>
            <span class="n">principal_id</span><span class="o">=</span><span class="n">principal_id</span><span class="p">,</span>
            <span class="n">permissions</span><span class="o">=</span><span class="n">permissions</span><span class="p">,</span>
        <span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">revoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">principal_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">principal_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">permissions</span><span class="p">:</span> <span class="n">ACLPermission</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Revoke permissions (or all access) from a principal.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">permissions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Remove entire entry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acl</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">principal_type</span> <span class="o">==</span> <span class="n">principal_type</span> <span class="ow">and</span>
                       <span class="n">e</span><span class="o">.</span><span class="n">principal_id</span> <span class="o">==</span> <span class="n">principal_id</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">principal_type</span> <span class="o">==</span> <span class="n">principal_type</span> <span class="ow">and</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">principal_id</span> <span class="o">==</span> <span class="n">principal_id</span><span class="p">):</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">permissions</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">permissions</span>  <span class="c1"># Remove specific perms</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_groups</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                     <span class="n">required</span><span class="p">:</span> <span class="n">ACLPermission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a user has the required permissions.&quot;&quot;&quot;</span>
        <span class="c1"># Owner always has full access</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">effective_perms</span> <span class="o">=</span> <span class="n">ACLPermission</span><span class="o">.</span><span class="n">NONE</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">principal_type</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">principal_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
                <span class="n">effective_perms</span> <span class="o">|=</span> <span class="n">entry</span><span class="o">.</span><span class="n">permissions</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">principal_type</span> <span class="o">==</span> <span class="s2">&quot;group&quot;</span> <span class="ow">and</span>
                  <span class="n">entry</span><span class="o">.</span><span class="n">principal_id</span> <span class="ow">in</span> <span class="n">user_groups</span><span class="p">):</span>
                <span class="n">effective_perms</span> <span class="o">|=</span> <span class="n">entry</span><span class="o">.</span><span class="n">permissions</span>

        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">effective_perms</span> <span class="o">&amp;</span> <span class="n">required</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_effective_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">user_groups</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ACLPermission</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all effective permissions for a user.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ACLPermission</span><span class="o">.</span><span class="n">ADMIN</span>

        <span class="n">effective</span> <span class="o">=</span> <span class="n">ACLPermission</span><span class="o">.</span><span class="n">NONE</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">principal_type</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">principal_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
                <span class="n">effective</span> <span class="o">|=</span> <span class="n">entry</span><span class="o">.</span><span class="n">permissions</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">principal_type</span> <span class="o">==</span> <span class="s2">&quot;group&quot;</span> <span class="ow">and</span>
                  <span class="n">entry</span><span class="o">.</span><span class="n">principal_id</span> <span class="ow">in</span> <span class="n">user_groups</span><span class="p">):</span>
                <span class="n">effective</span> <span class="o">|=</span> <span class="n">entry</span><span class="o">.</span><span class="n">permissions</span>

        <span class="k">return</span> <span class="n">effective</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># ACL Manager with Database Backend (simplified)</span>
<span class="c1"># ==============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ACLManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manage ACLs across multiple resources.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Resource</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">owner_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Resource</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new resource.&quot;&quot;&quot;</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">resource_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="n">owner_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">resource_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span>
        <span class="k">return</span> <span class="n">resource</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_groups</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
              <span class="n">resource_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="n">ACLPermission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check access to a resource.&quot;&quot;&quot;</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">resource</span><span class="o">.</span><span class="n">check_access</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_groups</span><span class="p">,</span> <span class="n">permission</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">share</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">requesting_user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">target_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">permissions</span><span class="p">:</span> <span class="n">ACLPermission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Share a resource (only owner or users with SHARE can do this).&quot;&quot;&quot;</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check if requesting user can share</span>
        <span class="k">if</span> <span class="n">requesting_user_id</span> <span class="o">!=</span> <span class="n">resource</span><span class="o">.</span><span class="n">owner_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="o">.</span><span class="n">check_access</span><span class="p">(</span>
                <span class="n">requesting_user_id</span><span class="p">,</span> <span class="nb">set</span><span class="p">(),</span> <span class="n">ACLPermission</span><span class="o">.</span><span class="n">SHARE</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">resource</span><span class="o">.</span><span class="n">grant</span><span class="p">(</span><span class="n">target_type</span><span class="p">,</span> <span class="n">target_id</span><span class="p">,</span> <span class="n">permissions</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Demo</span>
<span class="c1"># ==============================================================</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ACLManager</span><span class="p">()</span>

    <span class="c1"># Create a document</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">create_resource</span><span class="p">(</span><span class="s2">&quot;doc1&quot;</span><span class="p">,</span> <span class="s2">&quot;Project Plan.docx&quot;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>

    <span class="c1"># Share with bob (read + write)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">share</span><span class="p">(</span><span class="s2">&quot;doc1&quot;</span><span class="p">,</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;bob&quot;</span><span class="p">,</span>
                  <span class="n">ACLPermission</span><span class="o">.</span><span class="n">READ</span> <span class="o">|</span> <span class="n">ACLPermission</span><span class="o">.</span><span class="n">WRITE</span><span class="p">)</span>

    <span class="c1"># Share with engineering group (read only)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">share</span><span class="p">(</span><span class="s2">&quot;doc1&quot;</span><span class="p">,</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="s2">&quot;engineering&quot;</span><span class="p">,</span> <span class="n">ACLPermission</span><span class="o">.</span><span class="n">READ</span><span class="p">)</span>

    <span class="c1"># Check access</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== ACL Checks ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alice (owner) read:  </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">set</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">READ</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alice (owner) delete: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">set</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">DELETE</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bob read:   </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">set</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">READ</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bob write:  </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">set</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">WRITE</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bob delete: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">set</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">DELETE</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Carol is in engineering group</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Carol (eng) read:  </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;carol&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;engineering&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">READ</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Carol (eng) write: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;carol&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;engineering&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">WRITE</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Dan has no access</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dan read: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;dan&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">set</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">READ</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="5-policy-engines-opa-open-policy-agent">5. Policy Engines: OPA (Open Policy Agent)<a class="header-link" href="#5-policy-engines-opa-open-policy-agent" title="Permanent link">&para;</a></h2>
<h3 id="51-what-is-opa">5.1 What is OPA?<a class="header-link" href="#51-what-is-opa" title="Permanent link">&para;</a></h3>
<p>Open Policy Agent (OPA) is a general-purpose policy engine that decouples policy decision-making from application logic. Policies are written in <strong>Rego</strong>, a declarative query language.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">OPA</span><span class="w"> </span><span class="n">Architecture</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">       </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Application</span><span class="w">  </span><span class="err">â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚</span><span class="w">     </span><span class="n">OPA</span><span class="w">      </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="p">(</span><span class="n">Python</span><span class="p">,</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="n">Java</span><span class="p">,</span><span class="w">     </span><span class="err">â”‚â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â–¶â”‚</span><span class="w"> </span><span class="n">Rego</span><span class="w"> </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="k">Go</span><span class="p">...)</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="n">Policy</span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚â—€â”€â”€â”€â”€â”€â”€â”‚</span><span class="w">   </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span><span class="n">Decision</span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">       </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="k">Data</span><span class="w"> </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                         </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="p">(</span><span class="n">JSON</span><span class="p">)</span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                         </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                         </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Deployment</span><span class="w"> </span><span class="nl">Options</span><span class="p">:</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">Library</span><span class="w"> </span><span class="p">(</span><span class="n">embedded</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">app</span><span class="p">)</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">Sidecar</span><span class="w"> </span><span class="p">(</span><span class="n">daemon</span><span class="w"> </span><span class="n">alongside</span><span class="w"> </span><span class="n">app</span><span class="p">)</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="n">Standalone</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="p">(</span><span class="n">centralized</span><span class="p">)</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="k">Key</span><span class="w"> </span><span class="nl">Benefits</span><span class="p">:</span><span class="w">                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Policy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="p">(</span><span class="n">version</span><span class="w"> </span><span class="n">controlled</span><span class="p">,</span><span class="w"> </span><span class="n">tested</span><span class="p">,</span><span class="w"> </span><span class="n">audited</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="k">Language</span><span class="o">-</span><span class="n">agnostic</span><span class="w"> </span><span class="p">(</span><span class="ow">any</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">OPA</span><span class="p">)</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Separation</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">concerns</span><span class="w"> </span><span class="p">(</span><span class="n">dev</span><span class="w"> </span><span class="n">writes</span><span class="w"> </span><span class="n">logic</span><span class="p">,</span><span class="w"> </span><span class="n">security</span><span class="w"> </span><span class="n">writes</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="n">policy</span><span class="p">)</span><span class="w">                                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="52-rego-policy-language">5.2 Rego Policy Language<a class="header-link" href="#52-rego-policy-language" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># authz.rego - Example OPA policy for API authorization</span>

<span class="k">package</span><span class="w"> </span><span class="n">authz</span>

<span class="k">import</span><span class="w"> </span><span class="n">rego</span><span class="p">.</span><span class="n">v1</span>

<span class="c1"># Default deny all requests</span>
<span class="k">default</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">false</span>

<span class="c1"># Admin users can do anything</span>
<span class="n">allow</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">roles</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;admin&quot;</span>
<span class="p">}</span>

<span class="c1"># Users can read their own profile</span>
<span class="n">allow</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">action</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;read&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;profile&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">id</span>
<span class="p">}</span>

<span class="c1"># Editors can create and update posts</span>
<span class="n">allow</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">roles</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;editor&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">action</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;create&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;update&quot;</span><span class="p">}</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;post&quot;</span>
<span class="p">}</span>

<span class="c1"># Users can delete their own posts</span>
<span class="n">allow</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">action</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;delete&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;post&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">id</span>
<span class="p">}</span>

<span class="c1"># Time-based access: deny outside business hours for sensitive data</span>
<span class="n">deny</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">sensitivity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;high&quot;</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">is_business_hours</span>
<span class="p">}</span>

<span class="n">is_business_hours</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">hour</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">time</span><span class="p">.</span><span class="n">clock</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">now_ns</span><span class="p">())[</span><span class="m">0</span><span class="p">]</span>
<span class="w">    </span><span class="n">hour</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">8</span>
<span class="w">    </span><span class="n">hour</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">18</span>
<span class="p">}</span>

<span class="c1"># Final decision (deny overrides allow)</span>
<span class="n">decision</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;allow&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">allow</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">deny</span>
<span class="p">}</span>

<span class="n">decision</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;deny&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">allow</span>
<span class="p">}</span>

<span class="n">decision</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;deny&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">deny</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="53-integrating-opa-with-python">5.3 Integrating OPA with Python<a class="header-link" href="#53-integrating-opa-with-python" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">opa_integration.py - Integrating OPA with a Python/Flask application</span>
<span class="sd">pip install requests</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># OPA runs as a sidecar or standalone service</span>
<span class="n">OPA_URL</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8181/v1/data/authz/decision&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_opa_policy</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Query OPA for an authorization decision.&quot;&quot;&quot;</span>
    <span class="n">opa_input</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
            <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="n">resource</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">OPA_URL</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="n">opa_input</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Fail fast</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;allow&quot;</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OPA query failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Fail closed (deny on error)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_opa</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator that checks OPA policy before allowing access.</span>
<span class="sd">    resource_fn: function that builds resource dict from request context</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_user&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not authenticated&quot;</span><span class="p">}),</span> <span class="mi">401</span>

            <span class="c1"># Build resource context</span>
            <span class="k">if</span> <span class="n">resource_fn</span><span class="p">:</span>
                <span class="n">resource</span> <span class="o">=</span> <span class="n">resource_fn</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resource</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">}</span>

            <span class="c1"># Query OPA</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_opa_policy</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Access denied by policy&quot;</span><span class="p">}),</span> <span class="mi">403</span>

            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="c1"># Example resource builders</span>
<span class="k">def</span><span class="w"> </span><span class="nf">post_resource</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">post_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build resource dict for post endpoints.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">post_id</span><span class="p">:</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">get_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>  <span class="c1"># Your DB lookup</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">post_id</span><span class="p">,</span>
            <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author_id&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">post</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;sensitivity&quot;</span><span class="p">:</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;post&quot;</span><span class="p">}</span>


<span class="c1"># Protected routes using OPA</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_opa</span><span class="p">(</span><span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">req</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;post&quot;</span><span class="p">})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_post</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Post created&quot;</span><span class="p">}),</span> <span class="mi">201</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts/&lt;int:post_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@require_opa</span><span class="p">(</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">post_resource</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Post deleted&quot;</span><span class="p">})</span>
</code></pre></div>

<hr />
<h2 id="6-jwt-claims-for-authorization">6. JWT Claims for Authorization<a class="header-link" href="#6-jwt-claims-for-authorization" title="Permanent link">&para;</a></h2>
<h3 id="61-standard-and-custom-claims">6.1 Standard and Custom Claims<a class="header-link" href="#61-standard-and-custom-claims" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">JWT</span><span class="w"> </span><span class="n">Claims</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Authorization</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Standard</span><span class="w"> </span><span class="p">(</span><span class="n">Registered</span><span class="p">)</span><span class="w"> </span><span class="n">Claims</span><span class="p">:</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Claim</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Purpose</span><span class="w">                                   </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">sub</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Subject</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="n">ID</span><span class="p">)</span><span class="w">                         </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">iss</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Issuer</span><span class="w"> </span><span class="p">(</span><span class="n">who</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w">            </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">aud</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Audience</span><span class="w"> </span><span class="p">(</span><span class="n">who</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">accept</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w">    </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nb">exp</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Expiration</span><span class="w"> </span><span class="n">time</span><span class="w">                           </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">iat</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Issued</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">time</span><span class="w">                            </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">nbf</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Not</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">time</span><span class="w">                           </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">jti</span><span class="w">        </span><span class="err">â”‚</span><span class="w"> </span><span class="n">JWT</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="p">(</span><span class="n">unique</span><span class="w"> </span><span class="n">identifier</span><span class="p">)</span><span class="w">                </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Custom</span><span class="w"> </span><span class="n">Authorization</span><span class="w"> </span><span class="n">Claims</span><span class="p">:</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">{</span><span class="w">                                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user_123&quot;</span><span class="p">,</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;roles&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;editor&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;reviewer&quot;</span><span class="p">],</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;permissions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;post:create&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;post:update&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;post:read&quot;</span><span class="p">],</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;org_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;org_456&quot;</span><span class="p">,</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;department&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;engineering&quot;</span><span class="p">,</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;tier&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;premium&quot;</span><span class="p">,</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;scope&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;read write&quot;</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">}</span><span class="w">                                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">WARNING</span><span class="p">:</span><span class="w"> </span><span class="n">Keep</span><span class="w"> </span><span class="n">JWT</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="n">small</span><span class="o">!</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">JWT</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">every</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="p">(</span><span class="ow">in</span><span class="w"> </span><span class="n">Authorization</span><span class="w"> </span><span class="n">header</span><span class="p">)</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Large</span><span class="w"> </span><span class="n">payloads</span><span class="w"> </span><span class="n">increase</span><span class="w"> </span><span class="n">bandwidth</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">latency</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Put</span><span class="w"> </span><span class="n">minimal</span><span class="w"> </span><span class="n">auth</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">JWT</span><span class="p">,</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">details</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">DB</span><span class="o">/</span><span class="n">cache</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="62-claim-based-authorization-middleware">6.2 Claim-Based Authorization Middleware<a class="header-link" href="#62-claim-based-authorization-middleware" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">jwt_authz.py - JWT claim-based authorization</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">JWT_SECRET</span> <span class="o">=</span> <span class="s2">&quot;your-256-bit-secret&quot;</span>  <span class="c1"># Use env var in production</span>


<span class="k">def</span><span class="w"> </span><span class="nf">decode_jwt</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decode and validate JWT.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
        <span class="n">token</span><span class="p">,</span>
        <span class="n">JWT_SECRET</span><span class="p">,</span>
        <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">],</span>
        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;require&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="s2">&quot;sub&quot;</span><span class="p">,</span> <span class="s2">&quot;iss&quot;</span><span class="p">]}</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_claims</span><span class="p">(</span><span class="o">**</span><span class="n">required_claims</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator that checks JWT claims match requirements.</span>

<span class="sd">    Usage:</span>
<span class="sd">        @require_claims(roles=[&quot;admin&quot;], tier=&quot;premium&quot;)</span>
<span class="sd">        @require_claims(permissions=[&quot;post:create&quot;])</span>
<span class="sd">        @require_claims(org_id=lambda v: v == g.resource_org_id)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Extract token</span>
            <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Missing token&quot;</span><span class="p">}),</span> <span class="mi">401</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">claims</span> <span class="o">=</span> <span class="n">decode_jwt</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">claims</span> <span class="o">=</span> <span class="n">claims</span>
            <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">401</span>

            <span class="c1"># Check each required claim</span>
            <span class="k">for</span> <span class="n">claim_name</span><span class="p">,</span> <span class="n">expected</span> <span class="ow">in</span> <span class="n">required_claims</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">actual</span> <span class="o">=</span> <span class="n">claims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">claim_name</span><span class="p">)</span>

                <span class="c1"># Callable check (custom validation function)</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">expected</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">expected</span><span class="p">(</span><span class="n">actual</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Claim &#39;</span><span class="si">{</span><span class="n">claim_name</span><span class="si">}</span><span class="s2">&#39; validation failed&quot;</span>
                        <span class="p">}),</span> <span class="mi">403</span>

                <span class="c1"># List check (user must have at least one matching value)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">user_values</span> <span class="o">=</span> <span class="n">actual</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">actual</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">user_values</span><span class="p">)):</span>
                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Required claim &#39;</span><span class="si">{</span><span class="n">claim_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">}),</span> <span class="mi">403</span>

                <span class="c1"># Direct value check</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">actual</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Claim &#39;</span><span class="si">{</span><span class="n">claim_name</span><span class="si">}</span><span class="s2">&#39; mismatch&quot;</span>
                        <span class="p">}),</span> <span class="mi">403</span>

            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="c1"># Route examples</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/dashboard&#39;</span><span class="p">)</span>
<span class="nd">@require_claims</span><span class="p">(</span><span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">admin_dashboard</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Welcome, admin&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/premium/features&#39;</span><span class="p">)</span>
<span class="nd">@require_claims</span><span class="p">(</span><span class="n">tier</span><span class="o">=</span><span class="s2">&quot;premium&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">premium_features</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;advanced_analytics&quot;</span><span class="p">,</span> <span class="s2">&quot;api_access&quot;</span><span class="p">]})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_claims</span><span class="p">(</span><span class="n">permissions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;post:create&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_post</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Post created&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/org/&lt;org_id&gt;/data&#39;</span><span class="p">)</span>
<span class="nd">@require_claims</span><span class="p">(</span><span class="n">org_id</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">view_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;org_id&#39;</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">org_data</span><span class="p">(</span><span class="n">org_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Only users belonging to this org can access.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;org_id&quot;</span><span class="p">:</span> <span class="n">org_id</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[]})</span>
</code></pre></div>

<hr />
<h2 id="7-oauth-20-scopes">7. OAuth 2.0 Scopes<a class="header-link" href="#7-oauth-20-scopes" title="Permanent link">&para;</a></h2>
<h3 id="71-understanding-scopes">7.1 Understanding Scopes<a class="header-link" href="#71-understanding-scopes" title="Permanent link">&para;</a></h3>
<p>OAuth 2.0 scopes limit what an access token can do. They represent the <strong>permissions granted by the user</strong> to the client application.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  <span class="n">OAuth</span> <span class="mf">2.0</span> <span class="n">Scopes</span>                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  <span class="n">Consent</span> <span class="n">Screen:</span>                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  <span class="s">&quot;MyApp&quot;</span> <span class="n">wants</span> <span class="nb">to</span> <span class="n">access</span> <span class="n">your</span> <span class="n">account:</span>          â”‚            â”‚
â”‚  â”‚                                                  â”‚            â”‚
â”‚  â”‚  [<span class="nb">x</span>] <span class="n">Read</span> <span class="n">your</span> <span class="n">profile</span> (<span class="n">scope:</span> <span class="n">profile:read</span>)    â”‚            â”‚
â”‚  â”‚  [<span class="nb">x</span>] <span class="n">Read</span> <span class="n">your</span> <span class="n">emails</span> (<span class="n">scope:</span> <span class="n">email:read</span>)       â”‚            â”‚
â”‚  â”‚  [ ] <span class="n">Send</span> <span class="n">emails</span> <span class="n">on</span> <span class="n">your</span> <span class="n">behalf</span> (<span class="n">email:send</span>)    â”‚            â”‚
â”‚  â”‚  [ ] <span class="n">Delete</span> <span class="n">your</span> <span class="n">data</span> (<span class="n">data:delete</span>)             â”‚            â”‚
â”‚  â”‚                                                  â”‚            â”‚
â”‚  â”‚         [<span class="n">Allow</span>]    [<span class="n">Deny</span>]                        â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                  â”‚
â”‚  <span class="n">Resulting</span> <span class="n">token:</span>                                                â”‚
â”‚  {                                                               â”‚
â”‚    <span class="s">&quot;scope&quot;</span>: <span class="s">&quot;profile:read email:read&quot;</span>,                           â”‚
â”‚    <span class="s">&quot;client_id&quot;</span>: <span class="s">&quot;myapp&quot;</span>,                                         â”‚
â”‚    <span class="s">&quot;sub&quot;</span>: <span class="s">&quot;user_123&quot;</span>                                             â”‚
â”‚  }                                                               â”‚
â”‚                                                                  â”‚
â”‚  <span class="n">Common</span> <span class="n">Scope</span> <span class="n">Patterns:</span>                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ <span class="n">Pattern</span>          â”‚ <span class="n">Example</span>                       â”‚           â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
â”‚  â”‚ <span class="n">resource:action</span>   â”‚ <span class="n">posts:read</span>, <span class="n">posts:write</span>       â”‚           â”‚
â”‚  â”‚ <span class="n">resource</span>.<span class="nb">action</span>   â”‚ <span class="n">user</span>.<span class="n">email</span>, <span class="n">user</span>.<span class="n">profile</span>      â”‚           â”‚
â”‚  â”‚ <span class="n">hierarchical</span>      â”‚ <span class="n">admin</span> (<span class="n">implies</span> <span class="nb">all</span>)            â”‚           â”‚
â”‚  â”‚ <span class="n">OIDC</span> <span class="n">standard</span>     â”‚ <span class="n">openid</span>, <span class="n">profile</span>, <span class="n">email</span>         â”‚           â”‚
â”‚  â”‚ <span class="n">GitHub</span> <span class="n">style</span>      â”‚ <span class="n">repo</span>, <span class="n">user</span>, <span class="nb">gist</span>              â”‚           â”‚
â”‚  â”‚ <span class="n">Google</span> <span class="n">style</span>      â”‚ <span class="n">drive</span>.<span class="nb">readonly</span>, <span class="n">calendar</span>       â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="72-scope-enforcement">7.2 Scope Enforcement<a class="header-link" href="#72-scope-enforcement" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">scope_enforcement.py - OAuth scope checking for APIs</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_scope</span><span class="p">(</span><span class="o">*</span><span class="n">required_scopes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator to enforce OAuth 2.0 scopes.</span>
<span class="sd">    Token must contain ALL required scopes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Token scopes are typically space-separated</span>
            <span class="n">token_scopes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">claims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scope&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="n">required</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_scopes</span><span class="p">)</span>

            <span class="n">missing</span> <span class="o">=</span> <span class="n">required</span> <span class="o">-</span> <span class="n">token_scopes</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;insufficient_scope&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error_description&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Missing scopes: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;required_scopes&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">required</span><span class="p">),</span>
                    <span class="s2">&quot;granted_scopes&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">token_scopes</span><span class="p">),</span>
                <span class="p">}),</span> <span class="mi">403</span>

            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/profile&#39;</span><span class="p">)</span>
<span class="nd">@require_scope</span><span class="p">(</span><span class="s1">&#39;profile:read&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_profile</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/profile&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="nd">@require_scope</span><span class="p">(</span><span class="s1">&#39;profile:read&#39;</span><span class="p">,</span> <span class="s1">&#39;profile:write&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_profile</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Profile updated&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/data/export&#39;</span><span class="p">)</span>
<span class="nd">@require_scope</span><span class="p">(</span><span class="s1">&#39;data:export&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">export_data</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;download_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://...&quot;</span><span class="p">})</span>
</code></pre></div>

<hr />
<h2 id="8-resource-level-permissions">8. Resource-Level Permissions<a class="header-link" href="#8-resource-level-permissions" title="Permanent link">&para;</a></h2>
<h3 id="81-beyond-role-based-resource-ownership">8.1 Beyond Role-Based: Resource Ownership<a class="header-link" href="#81-beyond-role-based-resource-ownership" title="Permanent link">&para;</a></h3>
<p>Many applications need to check not just "does the user have the right role" but "does the user have access to this specific resource?"</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">          </span><span class="n">Resource</span><span class="o">-</span><span class="n">Level</span><span class="w"> </span><span class="n">Permission</span><span class="w"> </span><span class="n">Checks</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Level</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="n">Role</span><span class="w"> </span><span class="n">Check</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="s2">&quot;Is the user an editor?&quot;</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Yes</span><span class="o">/</span><span class="n">No</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Level</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="n">Resource</span><span class="w"> </span><span class="n">Ownership</span><span class="w">                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="s2">&quot;Is the user the owner of this post?&quot;</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Yes</span><span class="o">/</span><span class="n">No</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Level</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="n">Shared</span><span class="w"> </span><span class="n">Access</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="s2">&quot;Has the post been shared with this user?&quot;</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Yes</span><span class="o">/</span><span class="n">No</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Level</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="n">Organizational</span><span class="w"> </span><span class="n">Scope</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="s2">&quot;Does the user belong to the same org?&quot;</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Yes</span><span class="o">/</span><span class="n">No</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Combined</span><span class="p">:</span><span class="w">                                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Role</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="err">â”‚â”€â”€â”€â–¶â”‚</span><span class="w"> </span><span class="n">Resource</span><span class="w">   </span><span class="err">â”‚â”€â”€â”€â–¶â”‚</span><span class="w"> </span><span class="n">Additional</span><span class="w">   </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">editor</span><span class="err">?</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">ownership</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">constraints</span><span class="w">  </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">owner</span><span class="err">?</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="n">same</span><span class="w"> </span><span class="n">org</span><span class="err">?</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="82-implementation-multi-layer-authorization">8.2 Implementation: Multi-Layer Authorization<a class="header-link" href="#82-implementation-multi-layer-authorization" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">resource_auth.py - Multi-layer authorization for resources</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Resource Authorization Framework</span>
<span class="c1"># ==============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ResourceAuthorizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multi-layer authorization for resources.</span>
<span class="sd">    Checks are performed in order: role â†’ ownership â†’ sharing â†’ custom.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_checks</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">check_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a custom authorization check for a resource type.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">resource_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_checks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">custom_checks</span><span class="p">[</span><span class="n">resource_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_checks</span><span class="p">[</span><span class="n">resource_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">check_fn</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">authorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                  <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if user can perform action on resource.</span>
<span class="sd">        Returns True if authorized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resource_type</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>

        <span class="c1"># Layer 1: Super admin bypass</span>
        <span class="k">if</span> <span class="s1">&#39;super_admin&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Layer 2: Resource ownership</span>
        <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Layer 3: Role-based for the resource type</span>
        <span class="n">role_permissions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_role_permissions</span><span class="p">(</span>
            <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">resource_type</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">role_permissions</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Layer 4: Shared access</span>
        <span class="n">shares</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shares&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">share</span> <span class="ow">in</span> <span class="n">shares</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">share</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">share</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;permissions&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">share</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group_id&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">share</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;permissions&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Layer 5: Custom checks</span>
        <span class="k">for</span> <span class="n">check_fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_checks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">check_fn</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_role_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">roles</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                               <span class="n">resource_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get permissions for roles on a resource type.&quot;&quot;&quot;</span>
        <span class="c1"># In production, this comes from a database</span>
        <span class="n">role_perms</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;admin&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;post&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;publish&#39;</span><span class="p">},</span>
                <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">},</span>
                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">},</span>
            <span class="p">},</span>
            <span class="s1">&#39;editor&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;post&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">},</span>
                <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">},</span>
            <span class="p">},</span>
            <span class="s1">&#39;viewer&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;post&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">},</span>
                <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="n">perms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">roles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">role_perms</span> <span class="ow">and</span> <span class="n">resource_type</span> <span class="ow">in</span> <span class="n">role_perms</span><span class="p">[</span><span class="n">role</span><span class="p">]:</span>
                <span class="n">perms</span> <span class="o">|=</span> <span class="n">role_perms</span><span class="p">[</span><span class="n">role</span><span class="p">][</span><span class="n">resource_type</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">perms</span>


<span class="c1"># Global authorizer instance</span>
<span class="n">authorizer</span> <span class="o">=</span> <span class="n">ResourceAuthorizer</span><span class="p">()</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Authorization Decorator</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">authorize_resource</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource_loader</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator for resource-level authorization.</span>
<span class="sd">    resource_loader: function that returns the resource dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_user&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not authenticated&quot;</span><span class="p">}),</span> <span class="mi">401</span>

            <span class="n">resource</span> <span class="o">=</span> <span class="n">resource_loader</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Resource not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">authorizer</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Forbidden&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;You don&#39;t have &#39;</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&#39; access to this resource&quot;</span>
                <span class="p">}),</span> <span class="mi">403</span>

            <span class="n">g</span><span class="o">.</span><span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="c1"># Resource loaders</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a post from the database.&quot;&quot;&quot;</span>
    <span class="c1"># Simulated DB lookup</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;owner_id&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;org_id&quot;</span><span class="p">:</span> <span class="s2">&quot;org1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shares&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">]}]},</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;owner_id&quot;</span><span class="p">:</span> <span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="s2">&quot;org_id&quot;</span><span class="p">:</span> <span class="s2">&quot;org1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shares&quot;</span><span class="p">:</span> <span class="p">[]},</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">posts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>


<span class="c1"># Routes</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts/&lt;int:post_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authorize_resource</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">load_post</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">resource</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts/&lt;int:post_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="nd">@authorize_resource</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="n">load_post</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Updated&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts/&lt;int:post_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@authorize_resource</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">load_post</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Deleted&quot;</span><span class="p">})</span>
</code></pre></div>

<hr />
<h2 id="9-common-authorization-vulnerabilities">9. Common Authorization Vulnerabilities<a class="header-link" href="#9-common-authorization-vulnerabilities" title="Permanent link">&para;</a></h2>
<h3 id="91-idor-insecure-direct-object-reference">9.1 IDOR (Insecure Direct Object Reference)<a class="header-link" href="#91-idor-insecure-direct-object-reference" title="Permanent link">&para;</a></h3>
<p>IDOR occurs when an application exposes internal object references (like database IDs) without verifying that the requesting user is authorized to access them.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                    </span><span class="nv">IDOR</span><span class="w"> </span><span class="nv">Vulnerability</span><span class="w">                             </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="nv">Vulnerable</span>:<span class="w">                                                     </span>â”‚
â”‚<span class="w">  </span><span class="nv">GET</span><span class="w"> </span><span class="o">/</span><span class="nv">api</span><span class="o">/</span><span class="nv">invoices</span><span class="o">/</span><span class="mi">12345</span><span class="w">                                         </span>â”‚
â”‚<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Returns</span><span class="w"> </span><span class="nv">invoice</span><span class="w"> </span><span class="mi">12345</span><span class="w"> </span><span class="ss">(</span><span class="nv">no</span><span class="w"> </span><span class="nv">ownership</span><span class="w"> </span><span class="nv">check</span><span class="o">!</span><span class="ss">)</span><span class="w">                   </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span><span class="nv">Attacker</span><span class="w"> </span><span class="nv">changes</span><span class="w"> </span><span class="nv">ID</span>:<span class="w">                                            </span>â”‚
â”‚<span class="w">  </span><span class="nv">GET</span><span class="w"> </span><span class="o">/</span><span class="nv">api</span><span class="o">/</span><span class="nv">invoices</span><span class="o">/</span><span class="mi">12346</span><span class="w">                                         </span>â”‚
â”‚<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Returns</span><span class="w"> </span><span class="nv">someone</span><span class="w"> </span><span class="k">else</span><span class="err">&#39;s invoice! ğŸš¨                            â”‚</span>
<span class="err">â”‚                                                                  â”‚</span>
â”‚<span class="w">  </span><span class="nv">GET</span><span class="w"> </span><span class="o">/</span><span class="nv">api</span><span class="o">/</span><span class="nv">users</span><span class="o">/</span><span class="mi">100</span><span class="o">/</span><span class="nv">profile</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">Attacker</span><span class="err">&#39;s profile                â”‚</span>
â”‚<span class="w">  </span><span class="nv">GET</span><span class="w"> </span><span class="o">/</span><span class="nv">api</span><span class="o">/</span><span class="nv">users</span><span class="o">/</span><span class="mi">101</span><span class="o">/</span><span class="nv">profile</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">Another</span><span class="w"> </span><span class="nv">user</span><span class="err">&#39;s profile!           â”‚</span>
<span class="err">â”‚  GET /api/users/102/profile â†’ Yet another!                      â”‚</span>
<span class="err">â”‚                                                                  â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">idor_example.py - IDOR vulnerability and fix</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># ============================================================</span>
<span class="c1"># VULNERABLE: No authorization check on resource access</span>
<span class="c1"># ============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/invoices/&lt;int:invoice_id&gt;&#39;</span><span class="p">)</span>
<span class="nd">@require_auth</span>  <span class="c1"># Only checks authentication, NOT authorization!</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_invoice_vulnerable</span><span class="p">(</span><span class="n">invoice_id</span><span class="p">):</span>
    <span class="c1"># Any authenticated user can access ANY invoice by ID</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_invoice</span><span class="p">(</span><span class="n">invoice_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">invoice</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">invoice</span><span class="p">)</span>  <span class="c1"># IDOR: No ownership check!</span>


<span class="c1"># ============================================================</span>
<span class="c1"># FIXED: Verify resource ownership</span>
<span class="c1"># ============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/invoices/&lt;int:invoice_id&gt;&#39;</span><span class="p">)</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_invoice_secure</span><span class="p">(</span><span class="n">invoice_id</span><span class="p">):</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_invoice</span><span class="p">(</span><span class="n">invoice_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">invoice</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="c1"># Check: Does this invoice belong to the current user?</span>
    <span class="k">if</span> <span class="n">invoice</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span>
        <span class="c1"># Return 404 (not 403) to avoid information disclosure</span>
        <span class="c1"># A 403 tells attacker &quot;the resource exists but you can&#39;t access it&quot;</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">invoice</span><span class="p">)</span>


<span class="c1"># ============================================================</span>
<span class="c1"># BETTER: Use indirect references</span>
<span class="c1"># ============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/my/invoices&#39;</span><span class="p">)</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_my_invoices</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Only return the current user&#39;s invoices.&quot;&quot;&quot;</span>
    <span class="n">invoices</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_invoices_for_user</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;invoices&quot;</span><span class="p">:</span> <span class="n">invoices</span><span class="p">})</span>
</code></pre></div>

<h3 id="92-privilege-escalation">9.2 Privilege Escalation<a class="header-link" href="#92-privilege-escalation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Privilege Escalation Types                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Vertical Escalation (gaining higher privileges):                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚ Regular  â”‚ â”€â”€â”€â”€â”€â”€â–¶ â”‚  Admin   â”‚                              â”‚
â”‚  â”‚  User    â”‚ attacks â”‚   User   â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                  â”‚
â”‚  Example: Modifying JWT role claim                               â”‚
â”‚  Original:  {&quot;sub&quot;: &quot;user1&quot;, &quot;role&quot;: &quot;user&quot;}                    â”‚
â”‚  Tampered:  {&quot;sub&quot;: &quot;user1&quot;, &quot;role&quot;: &quot;admin&quot;}                   â”‚
â”‚                                                                  â”‚
â”‚  Horizontal Escalation (accessing other users&#39; data):            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚  User A  â”‚ â”€â”€â”€â”€â”€â”€â–¶ â”‚  User B  â”‚                              â”‚
â”‚  â”‚  (self)  â”‚ accessesâ”‚  (other) â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                  â”‚
â”‚  Example: Changing user_id parameter                             â”‚
â”‚  Own data:     GET /api/users/100/settings                      â”‚
â”‚  Other&#39;s data: GET /api/users/101/settings                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">privilege_escalation.py - Privilege escalation vulnerabilities and fixes</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># ============================================================</span>
<span class="c1"># VULNERABLE: Role in client-controlled input</span>
<span class="c1"># ============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/register&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">register_vulnerable</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="n">user</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span>
        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">),</span>  <span class="c1"># Attacker sends role=admin!</span>
    <span class="p">}</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="mi">201</span>

<span class="c1"># Attack:</span>
<span class="c1"># POST /api/register</span>
<span class="c1"># {&quot;username&quot;: &quot;attacker&quot;, &quot;email&quot;: &quot;a@b.com&quot;, &quot;role&quot;: &quot;admin&quot;}</span>


<span class="c1"># ============================================================</span>
<span class="c1"># FIXED: Never trust client-supplied role</span>
<span class="c1"># ============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/register&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">register_secure</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="n">user</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span>
        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>  <span class="c1"># Always set server-side!</span>
    <span class="p">}</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="mi">201</span>


<span class="c1"># ============================================================</span>
<span class="c1"># VULNERABLE: Mass assignment (updating fields not intended)</span>
<span class="c1"># ============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/users/&lt;int:user_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PATCH&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_user_vulnerable</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="c1"># Blindly update all provided fields</span>
    <span class="n">db</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Attacker sends {&quot;role&quot;: &quot;admin&quot;}!</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Updated&quot;</span><span class="p">})</span>


<span class="c1"># ============================================================</span>
<span class="c1"># FIXED: Whitelist allowed fields</span>
<span class="c1"># ============================================================</span>

<span class="n">ALLOWED_UPDATE_FIELDS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;bio&#39;</span><span class="p">,</span> <span class="s1">&#39;avatar_url&#39;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/users/&lt;int:user_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PATCH&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_user_secure</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="c1"># Ensure user can only update their own profile</span>
    <span class="k">if</span> <span class="n">user_id</span> <span class="o">!=</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Forbidden&quot;</span><span class="p">}),</span> <span class="mi">403</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>

    <span class="c1"># Only allow whitelisted fields</span>
    <span class="n">safe_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ALLOWED_UPDATE_FIELDS</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">safe_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No valid fields to update&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">db</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="o">**</span><span class="n">safe_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Updated&quot;</span><span class="p">})</span>


<span class="c1"># ============================================================</span>
<span class="c1"># VULNERABLE: Broken function-level access control</span>
<span class="c1"># ============================================================</span>

<span class="c1"># Admin endpoint with no authorization check</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/delete-user/&lt;int:user_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>  <span class="c1"># Only checks if user is logged in, not if they&#39;re admin!</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_user_vulnerable</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;User deleted&quot;</span><span class="p">})</span>


<span class="c1"># ============================================================</span>
<span class="c1"># FIXED: Proper role check on admin endpoints</span>
<span class="c1"># ============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/delete-user/&lt;int:user_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@require_role</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>  <span class="c1"># Checks both auth AND admin role</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_user_secure</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="c1"># Additional safety: prevent deleting self or other admins</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="k">if</span> <span class="n">target</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Cannot delete yourself&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">if</span> <span class="s1">&#39;admin&#39;</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Cannot delete other admins via API&quot;</span><span class="p">}),</span> <span class="mi">403</span>

    <span class="n">db</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;User deleted&quot;</span><span class="p">})</span>
</code></pre></div>

<h3 id="93-authorization-vulnerability-checklist">9.3 Authorization Vulnerability Checklist<a class="header-link" href="#93-authorization-vulnerability-checklist" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">          </span><span class="n">Authorization</span><span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="n">Checklist</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Every</span><span class="w"> </span><span class="n">endpoint</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">explicit</span><span class="w"> </span><span class="n">authorization</span><span class="w"> </span><span class="n">checks</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Authorization</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">enforced</span><span class="w"> </span><span class="n">server</span><span class="o">-</span><span class="n">side</span><span class="w"> </span><span class="p">(</span><span class="n">never</span><span class="w"> </span><span class="n">client</span><span class="o">-</span><span class="n">only</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Direct</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">references</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">validated</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ownership</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Admin</span><span class="w"> </span><span class="n">functions</span><span class="w"> </span><span class="n">require</span><span class="w"> </span><span class="n">admin</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="n">verification</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Role</span><span class="o">/</span><span class="n">permission</span><span class="w"> </span><span class="n">changes</span><span class="w"> </span><span class="n">require</span><span class="w"> </span><span class="n">admin</span><span class="w"> </span><span class="n">authorization</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="n">controls</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">permission</span><span class="w"> </span><span class="n">assignments</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">responses</span><span class="w"> </span><span class="n">don</span><span class="p">&#39;</span><span class="n">t</span><span class="w"> </span><span class="n">expose</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">users</span><span class="p">&#39;</span><span class="w"> </span><span class="n">data</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Failed</span><span class="w"> </span><span class="n">authorization</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="mh">403</span><span class="w"> </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="mh">404</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">IDOR</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Authorization</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">centralized</span><span class="w"> </span><span class="p">(</span><span class="k">not</span><span class="w"> </span><span class="n">duplicated</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Mass</span><span class="w"> </span><span class="n">assignment</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">prevented</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="n">whitelisting</span><span class="p">)</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Horizontal</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">checked</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">can</span><span class="p">&#39;</span><span class="n">t</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">B</span><span class="p">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Authorization</span><span class="w"> </span><span class="n">decisions</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">logged</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">audit</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Default</span><span class="o">-</span><span class="n">deny</span><span class="w"> </span><span class="n">policy</span><span class="w"> </span><span class="p">(</span><span class="n">deny</span><span class="w"> </span><span class="n">unless</span><span class="w"> </span><span class="n">explicitly</span><span class="w"> </span><span class="n">allowed</span><span class="p">)</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Token</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">auth</span><span class="w"> </span><span class="n">checks</span><span class="w"> </span><span class="n">scope</span><span class="o">/</span><span class="n">claims</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Multi</span><span class="o">-</span><span class="n">tenant</span><span class="w"> </span><span class="n">isolation</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">enforced</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">layer</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="10-exercises">10. Exercises<a class="header-link" href="#10-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-implement-rbac-system">Exercise 1: Implement RBAC System<a class="header-link" href="#exercise-1-implement-rbac-system" title="Permanent link">&para;</a></h3>
<p>Build a complete RBAC system with role hierarchy:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: Implement a complete RBAC system for a blogging platform.</span>

<span class="sd">Requirements:</span>
<span class="sd">- Roles: super_admin, admin, moderator, author, reader</span>
<span class="sd">- Role hierarchy: super_admin &gt; admin &gt; moderator &gt; author &gt; reader</span>
<span class="sd">- Permissions: user:*, post:*, comment:*, settings:*</span>
<span class="sd">- Users can have multiple roles</span>
<span class="sd">- Implement role assignment with authorization (only admin+ can assign)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BlogRBAC</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">permissions</span><span class="p">:</span> <span class="nb">set</span><span class="p">,</span>
                    <span class="n">parent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new role with optional parent.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">assign_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">admin_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">target_user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign role (only admins can do this).&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                         <span class="n">permission</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if user has permission (including inherited).&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_accessible_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                  <span class="n">resource_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all resources a user can access.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="exercise-2-build-abac-policy-engine">Exercise 2: Build ABAC Policy Engine<a class="header-link" href="#exercise-2-build-abac-policy-engine" title="Permanent link">&para;</a></h3>
<p>Create a healthcare ABAC system:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: Build an ABAC engine for a hospital system.</span>

<span class="sd">Policies to implement:</span>
<span class="sd">1. Doctors can read patient records in their department</span>
<span class="sd">2. Nurses can read records during their shift only</span>
<span class="sd">3. Emergency doctors can override department restrictions</span>
<span class="sd">4. No one can access records from non-hospital IP addresses</span>
<span class="sd">5. Psychiatry records require additional clearance level</span>
<span class="sd">6. Research access requires IRB approval attribute</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">HospitalABAC</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">condition</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>
                   <span class="n">effect</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                 <span class="n">action</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="exercise-3-fix-authorization-vulnerabilities">Exercise 3: Fix Authorization Vulnerabilities<a class="header-link" href="#exercise-3-fix-authorization-vulnerabilities" title="Permanent link">&para;</a></h3>
<p>Find and fix all authorization issues in this code:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: This API has at least 7 authorization vulnerabilities.</span>
<span class="sd">Find and fix ALL of them.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_all_users</span><span class="p">():</span>
    <span class="c1"># Issue 1: ???</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_all_users</span><span class="p">())</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/users/&lt;int:id&gt;/password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">change_password</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="c1"># Issue 2: ???</span>
    <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
    <span class="n">db</span><span class="o">.</span><span class="n">update_password</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">new_password</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;updated&quot;</span><span class="p">})</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_post</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_post</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="c1"># Issue 3: ???</span>
    <span class="n">db</span><span class="o">.</span><span class="n">delete_post</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;deleted&quot;</span><span class="p">})</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/promote&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">promote_user</span><span class="p">():</span>
    <span class="c1"># Issue 4: ???</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span>  <span class="c1"># Issue 5: ???</span>
    <span class="n">db</span><span class="o">.</span><span class="n">set_role</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">role</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;promoted&quot;</span><span class="p">})</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/files/&lt;path:filepath&gt;&#39;</span><span class="p">)</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">download_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="c1"># Issue 6: ???</span>
    <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/uploads/</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/settings&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_settings</span><span class="p">():</span>
    <span class="c1"># Issue 7: ???</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="n">db</span><span class="o">.</span><span class="n">update_all_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;updated&quot;</span><span class="p">})</span>
</code></pre></div>

<h3 id="exercise-4-multi-tenant-authorization">Exercise 4: Multi-Tenant Authorization<a class="header-link" href="#exercise-4-multi-tenant-authorization" title="Permanent link">&para;</a></h3>
<p>Design and implement a multi-tenant authorization system:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: Build authorization for a multi-tenant SaaS application.</span>

<span class="sd">Requirements:</span>
<span class="sd">- Each tenant (organization) has isolated data</span>
<span class="sd">- Users belong to exactly one organization</span>
<span class="sd">- Roles are per-organization (admin in org A != admin in org B)</span>
<span class="sd">- Cross-tenant access is never allowed</span>
<span class="sd">- Super-admins (platform level) can access any tenant</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MultiTenantAuth</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_org</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">org_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">owner_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_tenant_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">org_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">resource_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ensure_tenant_isolation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                 <span class="n">user_org_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add tenant filter to database queries.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="exercise-5-opa-policy-writing">Exercise 5: OPA Policy Writing<a class="header-link" href="#exercise-5-opa-policy-writing" title="Permanent link">&para;</a></h3>
<p>Write Rego policies for these scenarios:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Exercise: Write Rego policies for:</span>
<span class="c1">#</span>
<span class="c1"># 1. Users can only access resources in their department</span>
<span class="c1"># 2. Managers can access resources in their department and</span>
<span class="c1">#    departments they manage</span>
<span class="c1"># 3. Financial reports require &quot;finance&quot; role AND &quot;senior&quot; level</span>
<span class="c1"># 4. API rate limiting: users with &quot;basic&quot; tier limited to 100 req/hour</span>
<span class="c1"># 5. Data classification: &quot;top_secret&quot; resources require MFA</span>
<span class="c1">#    authentication within the last 30 minutes</span>

<span class="k">package</span><span class="w"> </span><span class="n">exercise</span>

<span class="k">import</span><span class="w"> </span><span class="n">rego</span><span class="p">.</span><span class="n">v1</span>

<span class="c1"># Write your policies here:</span>

<span class="k">default</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">false</span>

<span class="c1"># Policy 1: Department access</span>
<span class="c1"># ...</span>

<span class="c1"># Policy 2: Manager cross-department access</span>
<span class="c1"># ...</span>

<span class="c1"># Policy 3: Financial reports</span>
<span class="c1"># ...</span>

<span class="c1"># Policy 4: Rate limiting</span>
<span class="c1"># ...</span>

<span class="c1"># Policy 5: MFA requirement for classified data</span>
<span class="c1"># ...</span>
</code></pre></div>

<hr />
<h2 id="11-summary">11. Summary<a class="header-link" href="#11-summary" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">          </span><span class="nx">Authorization</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">Access</span><span class="w"> </span><span class="nx">Control</span><span class="w"> </span><span class="nx">Summary</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Models</span><span class="p">:</span><span class="w">                                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">RBAC</span><span class="p">:</span><span class="w"> </span><span class="nx">Roles</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">Permissions</span><span class="p">.</span><span class="w"> </span><span class="nx">Simple</span><span class="p">,</span><span class="w"> </span><span class="nx">widely</span><span class="w"> </span><span class="nx">used</span><span class="p">.</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">ABAC</span><span class="p">:</span><span class="w"> </span><span class="nx">Attributes</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">Policy</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">Decision</span><span class="p">.</span><span class="w"> </span><span class="nx">Flexible</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="o">-</span><span class="nx">aware</span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">ACL</span><span class="p">:</span><span class="w"> </span><span class="nx">Per</span><span class="o">-</span><span class="nx">resource</span><span class="w"> </span><span class="nx">permission</span><span class="w"> </span><span class="nx">lists</span><span class="p">.</span><span class="w"> </span><span class="nx">Fine</span><span class="o">-</span><span class="nx">grained</span><span class="p">.</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Combine</span><span class="w"> </span><span class="nx">models</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nx">needed</span><span class="w"> </span><span class="p">(</span><span class="nx">RBAC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">resource</span><span class="w"> </span><span class="nx">ownership</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">common</span><span class="p">)</span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Key</span><span class="w"> </span><span class="nx">Principles</span><span class="p">:</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Least</span><span class="w"> </span><span class="nx">Privilege</span><span class="p">:</span><span class="w"> </span><span class="nx">Grant</span><span class="w"> </span><span class="nx">minimum</span><span class="w"> </span><span class="nx">necessary</span><span class="w"> </span><span class="nx">permissions</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Default</span><span class="w"> </span><span class="nx">Deny</span><span class="p">:</span><span class="w"> </span><span class="nx">Block</span><span class="w"> </span><span class="nx">everything</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">explicitly</span><span class="w"> </span><span class="nx">allowed</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Separation</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">Duties</span><span class="p">:</span><span class="w"> </span><span class="nx">No</span><span class="w"> </span><span class="nx">single</span><span class="w"> </span><span class="nx">role</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">do</span><span class="w"> </span><span class="nx">everything</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Defense</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">Depth</span><span class="p">:</span><span class="w"> </span><span class="nx">Check</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">multiple</span><span class="w"> </span><span class="nx">layers</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Centralize</span><span class="p">:</span><span class="w"> </span><span class="nx">Authorization</span><span class="w"> </span><span class="nx">logic</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">one</span><span class="w"> </span><span class="nx">place</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Implementation</span><span class="p">:</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Server</span><span class="o">-</span><span class="nx">side</span><span class="w"> </span><span class="nx">enforcement</span><span class="w"> </span><span class="p">(</span><span class="nx">never</span><span class="w"> </span><span class="nx">trust</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">JWT</span><span class="w"> </span><span class="nx">claims</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">stateless</span><span class="w"> </span><span class="nx">API</span><span class="w"> </span><span class="nx">authorization</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">OAuth</span><span class="w"> </span><span class="nx">scopes</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">third</span><span class="o">-</span><span class="nx">party</span><span class="w"> </span><span class="nx">access</span><span class="w"> </span><span class="nx">delegation</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Policy</span><span class="w"> </span><span class="nx">engines</span><span class="w"> </span><span class="p">(</span><span class="nx">OPA</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">complex</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">externalized</span><span class="w"> </span><span class="nx">policies</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Decorators</span><span class="o">/</span><span class="nx">middleware</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">DRY</span><span class="w"> </span><span class="nx">authorization</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">Flask</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Common</span><span class="w"> </span><span class="nx">Vulnerabilities</span><span class="p">:</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">IDOR</span><span class="p">:</span><span class="w"> </span><span class="nx">Always</span><span class="w"> </span><span class="nx">validate</span><span class="w"> </span><span class="nx">resource</span><span class="w"> </span><span class="nx">ownership</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Privilege</span><span class="w"> </span><span class="nx">escalation</span><span class="p">:</span><span class="w"> </span><span class="nx">Never</span><span class="w"> </span><span class="nx">trust</span><span class="w"> </span><span class="nx">client</span><span class="o">-</span><span class="nx">supplied</span><span class="w"> </span><span class="nx">roles</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Mass</span><span class="w"> </span><span class="nx">assignment</span><span class="p">:</span><span class="w"> </span><span class="nx">Whitelist</span><span class="w"> </span><span class="nx">updateable</span><span class="w"> </span><span class="nx">fields</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Missing</span><span class="w"> </span><span class="nx">function</span><span class="o">-</span><span class="nx">level</span><span class="w"> </span><span class="nx">checks</span><span class="p">:</span><span class="w"> </span><span class="nx">Every</span><span class="w"> </span><span class="nx">endpoint</span><span class="w"> </span><span class="nx">needs</span><span class="w"> </span><span class="nx">auth</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<p><strong>Previous</strong>: <a href="05_Authentication.md">05. Authentication Systems</a> | <strong>Next</strong>: <a href="07_OWASP_Top10.md">07. OWASP Top 10 (2021)</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/05_Authentication.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">05. Authentication Systems</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/07_OWASP_Top10.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">07. OWASP Top 10 (2021)</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}