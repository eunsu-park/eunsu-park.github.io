{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Security - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Security/">Security</a>
    <span class="separator">/</span>
    <span class="current">API Security</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>API Security</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/09_Web_Security_Headers.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Web Security Headers and CSP</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/11_Secrets_Management.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Secrets Management and Environment Configuration</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#1-api-threat-landscape">1. API Threat Landscape</a><ul>
<li><a href="#11-owasp-api-security-top-10-2023">1.1 OWASP API Security Top 10 (2023)</a></li>
<li><a href="#12-api-attack-surface">1.2 API Attack Surface</a></li>
</ul>
</li>
<li><a href="#2-api-authentication-patterns">2. API Authentication Patterns</a><ul>
<li><a href="#21-api-keys">2.1 API Keys</a></li>
<li><a href="#22-oauth-20">2.2 OAuth 2.0</a></li>
<li><a href="#23-jwt-json-web-tokens">2.3 JWT (JSON Web Tokens)</a></li>
<li><a href="#24-jwt-security-best-practices">2.4 JWT Security Best Practices</a></li>
</ul>
</li>
<li><a href="#3-rate-limiting">3. Rate Limiting</a><ul>
<li><a href="#31-rate-limiting-algorithms">3.1 Rate Limiting Algorithms</a></li>
<li><a href="#32-flask-rate-limiting-with-flask-limiter">3.2 Flask Rate Limiting with Flask-Limiter</a></li>
<li><a href="#33-custom-token-bucket-implementation">3.3 Custom Token Bucket Implementation</a></li>
</ul>
</li>
<li><a href="#4-input-validation-and-sanitization">4. Input Validation and Sanitization</a><ul>
<li><a href="#41-validation-architecture">4.1 Validation Architecture</a></li>
<li><a href="#42-schema-validation-with-marshmallow">4.2 Schema Validation with Marshmallow</a></li>
<li><a href="#43-pydantic-validation-alternative">4.3 Pydantic Validation (Alternative)</a></li>
</ul>
</li>
<li><a href="#5-cors-cross-origin-resource-sharing">5. CORS (Cross-Origin Resource Sharing)</a><ul>
<li><a href="#51-how-cors-works">5.1 How CORS Works</a></li>
<li><a href="#52-flask-cors-configuration">5.2 Flask CORS Configuration</a></li>
</ul>
</li>
<li><a href="#6-graphql-security">6. GraphQL Security</a><ul>
<li><a href="#61-graphql-specific-threats">6.1 GraphQL-Specific Threats</a></li>
<li><a href="#62-graphql-security-mitigations">6.2 GraphQL Security Mitigations</a></li>
</ul>
</li>
<li><a href="#7-api-gateway-security">7. API Gateway Security</a><ul>
<li><a href="#71-gateway-architecture">7.1 Gateway Architecture</a></li>
<li><a href="#72-requestresponse-filtering">7.2 Request/Response Filtering</a></li>
</ul>
</li>
<li><a href="#8-openapi-security-definitions">8. OpenAPI Security Definitions</a><ul>
<li><a href="#81-security-schemes-in-openapi-30">8.1 Security Schemes in OpenAPI 3.0</a></li>
<li><a href="#82-api-versioning-security">8.2 API Versioning Security</a></li>
</ul>
</li>
<li><a href="#9-requestresponse-encryption">9. Request/Response Encryption</a><ul>
<li><a href="#91-transport-layer-security">9.1 Transport Layer Security</a></li>
</ul>
</li>
<li><a href="#10-exercises">10. Exercises</a><ul>
<li><a href="#exercise-1-secure-jwt-authentication-service">Exercise 1: Secure JWT Authentication Service</a></li>
<li><a href="#exercise-2-cors-security-audit">Exercise 2: CORS Security Audit</a></li>
<li><a href="#exercise-3-graphql-security-middleware">Exercise 3: GraphQL Security Middleware</a></li>
<li><a href="#exercise-4-rate-limiter-with-sliding-window">Exercise 4: Rate Limiter with Sliding Window</a></li>
<li><a href="#exercise-5-api-input-validation-framework">Exercise 5: API Input Validation Framework</a></li>
<li><a href="#exercise-6-api-security-scanner">Exercise 6: API Security Scanner</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a><ul>
<li><a href="#api-security-checklist">API Security Checklist</a></li>
<li><a href="#key-takeaways">Key Takeaways</a></li>
</ul>
</li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="api-security">API Security<a class="header-link" href="#api-security" title="Permanent link">&para;</a></h1>
<p><strong>Previous</strong>: <a href="./09_Web_Security_Headers.md">09_Web_Security_Headers.md</a> | <strong>Next</strong>: <a href="./11_Secrets_Management.md">11_Secrets_Management.md</a></p>
<hr />
<p>APIs are the backbone of modern software systems. They connect microservices, power mobile applications, and enable third-party integrations. Because APIs expose application logic and data directly, they are a prime target for attackers. A single misconfigured endpoint can expose millions of records. This lesson covers the essential security practices for building, deploying, and maintaining secure APIs â€” from authentication and rate limiting to input validation and CORS configuration.</p>
<h2 id="learning-objectives">Learning Objectives<a class="header-link" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<ul>
<li>Implement robust API authentication using API keys, OAuth 2.0, and JWT</li>
<li>Design and deploy rate limiting strategies to prevent abuse</li>
<li>Validate and sanitize all API inputs to prevent injection attacks</li>
<li>Configure CORS correctly to control cross-origin access</li>
<li>Secure GraphQL endpoints against common attack patterns</li>
<li>Define security schemes in OpenAPI/Swagger specifications</li>
<li>Apply API gateway security patterns for production environments</li>
</ul>
<hr />
<h2 id="1-api-threat-landscape">1. API Threat Landscape<a class="header-link" href="#1-api-threat-landscape" title="Permanent link">&para;</a></h2>
<h3 id="11-owasp-api-security-top-10-2023">1.1 OWASP API Security Top 10 (2023)<a class="header-link" href="#11-owasp-api-security-top-10-2023" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                 </span><span class="n">OWASP</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="n">Top</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="mi">2023</span><span class="p">)</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">API1</span><span class="w">  </span><span class="n">Broken</span><span class="w"> </span><span class="nb nb-Type">Object</span><span class="w"> </span><span class="n">Level</span><span class="w"> </span><span class="n">Authorization</span><span class="w"> </span><span class="p">(</span><span class="n">BOLA</span><span class="p">)</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">        </span><span class="n">Accessing</span><span class="w"> </span><span class="n">resources</span><span class="w"> </span><span class="n">belonging</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">users</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">        </span><span class="n">GET</span><span class="w"> </span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">OTHER_USER_ID</span><span class="o">/</span><span class="n">orders</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">API2</span><span class="w">  </span><span class="n">Broken</span><span class="w"> </span><span class="n">Authentication</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">        </span><span class="n">Weak</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="n">mechanisms</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="n">leakage</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">API3</span><span class="w">  </span><span class="n">Broken</span><span class="w"> </span><span class="nb nb-Type">Object</span><span class="w"> </span><span class="n">Property</span><span class="w"> </span><span class="n">Level</span><span class="w"> </span><span class="n">Authorization</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">        </span><span class="n">Mass</span><span class="w"> </span><span class="n">assignment</span><span class="p">,</span><span class="w"> </span><span class="n">exposing</span><span class="w"> </span><span class="n">sensitive</span><span class="w"> </span><span class="n">properties</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">API4</span><span class="w">  </span><span class="n">Unrestricted</span><span class="w"> </span><span class="n">Resource</span><span class="w"> </span><span class="n">Consumption</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">        </span><span class="n">No</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="n">limiting</span><span class="p">,</span><span class="w"> </span><span class="n">large</span><span class="w"> </span><span class="n">payloads</span><span class="p">,</span><span class="w"> </span><span class="n">expensive</span><span class="w"> </span><span class="n">queries</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">API5</span><span class="w">  </span><span class="n">Broken</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="n">Level</span><span class="w"> </span><span class="n">Authorization</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">        </span><span class="n">Accessing</span><span class="w"> </span><span class="n">admin</span><span class="w"> </span><span class="n">functions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">regular</span><span class="w"> </span><span class="n">user</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">        </span><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">admin</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">delete</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">API6</span><span class="w">  </span><span class="n">Unrestricted</span><span class="w"> </span><span class="n">Access</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Sensitive</span><span class="w"> </span><span class="n">Business</span><span class="w"> </span><span class="n">Flows</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">        </span><span class="n">Automated</span><span class="w"> </span><span class="n">abuse</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">business</span><span class="w"> </span><span class="n">features</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">API7</span><span class="w">  </span><span class="n">Server</span><span class="o">-</span><span class="n">Side</span><span class="w"> </span><span class="n">Request</span><span class="w"> </span><span class="n">Forgery</span><span class="w"> </span><span class="p">(</span><span class="n">SSRF</span><span class="p">)</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">        </span><span class="n">Fetching</span><span class="w"> </span><span class="n">URLs</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="n">validation</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">API8</span><span class="w">  </span><span class="n">Security</span><span class="w"> </span><span class="n">Misconfiguration</span><span class="w">                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">        </span><span class="n">Missing</span><span class="w"> </span><span class="n">headers</span><span class="p">,</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="n">errors</span><span class="p">,</span><span class="w"> </span><span class="n">default</span><span class="w"> </span><span class="n">creds</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">API9</span><span class="w">  </span><span class="n">Improper</span><span class="w"> </span><span class="n">Inventory</span><span class="w"> </span><span class="n">Management</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">        </span><span class="n">Unmanaged</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">versions</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="w"> </span><span class="n">APIs</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">API10</span><span class="w"> </span><span class="n">Unsafe</span><span class="w"> </span><span class="n">Consumption</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">APIs</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">        </span><span class="n">Trusting</span><span class="w"> </span><span class="n">third</span><span class="o">-</span><span class="n">party</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">responses</span><span class="w"> </span><span class="n">blindly</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="12-api-attack-surface">1.2 API Attack Surface<a class="header-link" href="#12-api-attack-surface" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="n">API</span><span class="w"> </span><span class="n">Attack</span><span class="w"> </span><span class="n">Surface</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Client</span><span class="w">  </span><span class="err">â”‚â”€â”€â”€â–¶â”‚</span><span class="w"> </span><span class="n">Network</span><span class="w">  </span><span class="err">â”‚â”€â”€â”€â–¶â”‚</span><span class="w"> </span><span class="n">API</span><span class="w">      </span><span class="err">â”‚â”€â”€â”€â–¶â”‚</span><span class="w"> </span><span class="n">Database</span><span class="w"> </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Server</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Attack</span><span class="w"> </span><span class="n">vectors</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="nl">layer:</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nl">Client:</span><span class="w">     </span><span class="n">Tampered</span><span class="w"> </span><span class="n">requests</span><span class="p">,</span><span class="w"> </span><span class="n">stolen</span><span class="w"> </span><span class="n">tokens</span><span class="p">,</span><span class="w"> </span><span class="n">replay</span><span class="w"> </span><span class="n">attacks</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nl">Network:</span><span class="w">    </span><span class="n">Man</span><span class="o">-</span><span class="n">in</span><span class="o">-</span><span class="n">the</span><span class="o">-</span><span class="n">middle</span><span class="p">,</span><span class="w"> </span><span class="n">eavesdropping</span><span class="p">,</span><span class="w"> </span><span class="n">DNS</span><span class="w"> </span><span class="n">hijacking</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">API</span><span class="w"> </span><span class="nl">Server:</span><span class="w"> </span><span class="n">Injection</span><span class="p">,</span><span class="w"> </span><span class="n">broken</span><span class="w"> </span><span class="n">auth</span><span class="p">,</span><span class="w"> </span><span class="n">BOLA</span><span class="p">,</span><span class="w"> </span><span class="n">mass</span><span class="w"> </span><span class="n">assignment</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nl">Database:</span><span class="w">   </span><span class="n">SQL</span><span class="w"> </span><span class="n">injection</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">exfiltration</span><span class="p">,</span><span class="w"> </span><span class="n">unauthorized</span><span class="w"> </span><span class="n">access</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Cross</span><span class="o">-</span><span class="n">cutting</span><span class="w"> </span><span class="nl">concerns:</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Authentication</span><span class="w">    </span><span class="p">(</span><span class="n">Who</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">you</span><span class="o">?</span><span class="p">)</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Authorization</span><span class="w">     </span><span class="p">(</span><span class="n">What</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">access</span><span class="o">?</span><span class="p">)</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="n">validation</span><span class="w">  </span><span class="p">(</span><span class="n">Is</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">safe</span><span class="o">?</span><span class="p">)</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Rate</span><span class="w"> </span><span class="n">limiting</span><span class="w">     </span><span class="p">(</span><span class="n">Are</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">abusing</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">API</span><span class="o">?</span><span class="p">)</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Encryption</span><span class="w">        </span><span class="p">(</span><span class="n">Is</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">protected</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">transit</span><span class="o">?</span><span class="p">)</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Logging</span><span class="o">/</span><span class="n">Monitoring</span><span class="w"> </span><span class="p">(</span><span class="n">Can</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">detect</span><span class="w"> </span><span class="n">attacks</span><span class="o">?</span><span class="p">)</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="2-api-authentication-patterns">2. API Authentication Patterns<a class="header-link" href="#2-api-authentication-patterns" title="Permanent link">&para;</a></h2>
<h3 id="21-api-keys">2.1 API Keys<a class="header-link" href="#21-api-keys" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">API Key authentication â€” simple but limited.</span>
<span class="sd">Suitable for server-to-server communication and public APIs</span>
<span class="sd">with usage tracking.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># â”€â”€ API Key Generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_api_key</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate an API key and its hash for storage.&quot;&quot;&quot;</span>
    <span class="c1"># Generate a cryptographically secure key</span>
    <span class="c1"># Prefix helps identify the key type and version</span>
    <span class="n">raw_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sk_live_</span><span class="si">{</span><span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Store only the hash â€” never store the raw key</span>
    <span class="n">key_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">raw_key</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">raw_key</span><span class="p">,</span> <span class="n">key_hash</span>

<span class="c1"># raw_key: sk_live_Abc123...  (sent to client once, never stored)</span>
<span class="c1"># key_hash: e3b0c4...         (stored in database)</span>


<span class="c1"># â”€â”€ Simulated key storage (use a real database in production) â”€â”€â”€â”€</span>
<span class="n">API_KEYS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># hash -&gt; metadata</span>
    <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;sk_live_test_key_12345&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">():</span> <span class="p">{</span>
        <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="s2">&quot;client_001&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Test Client&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rate_limit&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>       <span class="c1"># requests per minute</span>
        <span class="s2">&quot;scopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="s2">&quot;write&quot;</span><span class="p">],</span>
        <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2025-01-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;last_used&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_api_key</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to require a valid API key.&quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Check multiple locations for the API key</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-API-Key&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;api_key&#39;</span><span class="p">)</span>  <span class="c1"># Less secure, avoid if possible</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;missing_api_key&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;API key is required. &quot;</span>
                           <span class="s2">&quot;Pass it in the X-API-Key header.&quot;</span>
            <span class="p">}),</span> <span class="mi">401</span>

        <span class="c1"># Hash the provided key and look it up</span>
        <span class="n">key_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">api_key</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">key_data</span> <span class="o">=</span> <span class="n">API_KEYS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key_hash</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">key_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid_api_key&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;The provided API key is not valid.&quot;</span>
            <span class="p">}),</span> <span class="mi">401</span>

        <span class="c1"># Update last used timestamp</span>
        <span class="n">key_data</span><span class="p">[</span><span class="s2">&quot;last_used&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

        <span class="c1"># Store key metadata in request context</span>
        <span class="n">request</span><span class="o">.</span><span class="n">api_client</span> <span class="o">=</span> <span class="n">key_data</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decorated</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/data&#39;</span><span class="p">)</span>
<span class="nd">@require_api_key</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Protected endpoint requiring API key.&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">api_client</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;client&quot;</span><span class="p">:</span> <span class="n">client</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="p">})</span>


<span class="c1"># â”€â”€ API Key Security Best Practices â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">1. Transmission:</span>
<span class="sd">   - Always use HTTPS</span>
<span class="sd">   - Prefer headers over query parameters (query params appear in logs)</span>
<span class="sd">   - Use X-API-Key header or Authorization: Bearer &lt;key&gt;</span>

<span class="sd">2. Storage:</span>
<span class="sd">   - Hash keys before storing (SHA-256 minimum)</span>
<span class="sd">   - Never log full API keys</span>
<span class="sd">   - Show only last 4 characters in UI: sk_live_****5678</span>

<span class="sd">3. Rotation:</span>
<span class="sd">   - Support multiple active keys per client</span>
<span class="sd">   - Allow key rotation without downtime</span>
<span class="sd">   - Set expiration dates on keys</span>

<span class="sd">4. Scoping:</span>
<span class="sd">   - Assign scopes/permissions to each key</span>
<span class="sd">   - Use separate keys for read vs write operations</span>
<span class="sd">   - Use separate keys for test vs production</span>

<span class="sd">5. Limitations:</span>
<span class="sd">   - API keys identify applications, not users</span>
<span class="sd">   - They lack built-in expiration (unlike tokens)</span>
<span class="sd">   - They cannot be easily scoped per-request</span>
<span class="sd">   - Use OAuth 2.0 for user-context authorization</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>

<h3 id="22-oauth-20">2.2 OAuth 2.0<a class="header-link" href="#22-oauth-20" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="nx">OAuth</span><span class="w"> </span><span class="m m-Double">2.0</span><span class="w"> </span><span class="nx">Authorization</span><span class="w"> </span><span class="nx">Code</span><span class="w"> </span><span class="nx">Flow</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="nx">clicks</span><span class="w"> </span><span class="s">&quot;Login with Provider&quot;</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Client</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">Auth</span><span class="w"> </span><span class="nx">Server</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">authorize</span><span class="p">?</span><span class="nx">response_type</span><span class="p">=</span><span class="nx">code</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">client_id</span><span class="p">=</span><span class="nx">CLIENT_ID</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">redirect_uri</span><span class="p">=</span><span class="nx">CALLBACK_URL</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">scope</span><span class="p">=</span><span class="nx">read</span><span class="o">+</span><span class="nx">write</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">state</span><span class="p">=</span><span class="nx">RANDOM_STATE</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="nx">authenticates</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">approves</span><span class="w"> </span><span class="nx">scopes</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Auth</span><span class="w"> </span><span class="nx">Server</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="nx">Callback</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">callback</span><span class="p">?</span><span class="nx">code</span><span class="p">=</span><span class="nx">AUTH_CODE</span><span class="o">&amp;</span><span class="nx">state</span><span class="p">=</span><span class="nx">RANDOM_STATE</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="nx">exchanges</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">tokens</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Client</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">Auth</span><span class="w"> </span><span class="nx">Server</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">token</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="nx">grant_type</span><span class="p">=</span><span class="nx">authorization_code</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">code</span><span class="p">=</span><span class="nx">AUTH_CODE</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">client_id</span><span class="p">=</span><span class="nx">CLIENT_ID</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">client_secret</span><span class="p">=</span><span class="nx">CLIENT_SECRET</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">redirect_uri</span><span class="p">=</span><span class="nx">CALLBACK_URL</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="nx">Auth</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="nx">tokens</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Auth</span><span class="w"> </span><span class="nx">Server</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">Client</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;access_token&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;...&quot;</span><span class="p">,</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="s">&quot;refresh_token&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;...&quot;</span><span class="p">,</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="s">&quot;token_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Bearer&quot;</span><span class="p">,</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="s">&quot;expires_in&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span><span class="w"> </span><span class="p">}</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="nx">uses</span><span class="w"> </span><span class="nx">access</span><span class="w"> </span><span class="nx">token</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Client</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">Resource</span><span class="w"> </span><span class="nx">Server</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Authorization</span><span class="p">:</span><span class="w"> </span><span class="nx">Bearer</span><span class="w"> </span><span class="nx">ACCESS_TOKEN</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">OAuth 2.0 implementation with Flask (server-side).</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlencode</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="c1"># OAuth 2.0 configuration (example: GitHub)</span>
<span class="n">OAUTH_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="s2">&quot;your_client_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;client_secret&quot;</span><span class="p">:</span> <span class="s2">&quot;your_client_secret&quot;</span><span class="p">,</span>
    <span class="s2">&quot;authorize_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://github.com/login/oauth/authorize&quot;</span><span class="p">,</span>
    <span class="s2">&quot;token_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://github.com/login/oauth/access_token&quot;</span><span class="p">,</span>
    <span class="s2">&quot;api_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.github.com/user&quot;</span><span class="p">,</span>
    <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="s2">&quot;http://localhost:5000/callback&quot;</span><span class="p">,</span>
    <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot;read:user user:email&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initiate OAuth 2.0 Authorization Code flow.&quot;&quot;&quot;</span>
    <span class="c1"># Generate state parameter to prevent CSRF</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;oauth_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>

    <span class="c1"># Build authorization URL</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">],</span>
        <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;redirect_uri&quot;</span><span class="p">],</span>
        <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">],</span>
        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
        <span class="s2">&quot;response_type&quot;</span><span class="p">:</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">auth_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s1">&#39;authorize_url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">auth_url</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/callback&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle OAuth 2.0 callback.&quot;&quot;&quot;</span>
    <span class="c1"># â”€â”€ Verify state parameter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;oauth_state&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid state parameter&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># â”€â”€ Check for error response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error_description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># â”€â”€ Exchange authorization code for tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span>
    <span class="n">token_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;token_url&quot;</span><span class="p">],</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;client_secret&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;client_secret&quot;</span><span class="p">],</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
            <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;redirect_uri&quot;</span><span class="p">],</span>
            <span class="s2">&quot;grant_type&quot;</span><span class="p">:</span> <span class="s2">&quot;authorization_code&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">token_data</span> <span class="o">=</span> <span class="n">token_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">token_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">token_data</span><span class="p">),</span> <span class="mi">400</span>

    <span class="n">access_token</span> <span class="o">=</span> <span class="n">token_data</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>

    <span class="c1"># â”€â”€ Fetch user information â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="n">user_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;api_url&quot;</span><span class="p">],</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">user_data</span> <span class="o">=</span> <span class="n">user_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="c1"># Store in session (or create/update user in database)</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/dashboard&#39;</span><span class="p">)</span>


<span class="c1"># â”€â”€ OAuth 2.0 Security Checklist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">1. Always use the state parameter (prevents CSRF)</span>
<span class="sd">2. Validate redirect_uri exactly (no open redirect)</span>
<span class="sd">3. Use Authorization Code flow (not Implicit for server apps)</span>
<span class="sd">4. Store tokens securely (encrypted, server-side)</span>
<span class="sd">5. Use PKCE for public clients (SPAs, mobile apps)</span>
<span class="sd">6. Validate token scopes on every request</span>
<span class="sd">7. Use short-lived access tokens + refresh tokens</span>
<span class="sd">8. Revoke tokens on logout</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>

<h3 id="23-jwt-json-web-tokens">2.3 JWT (JSON Web Tokens)<a class="header-link" href="#23-jwt-json-web-tokens" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="n">JWT</span><span class="w"> </span><span class="n">Structure</span><span class="w">                                     </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">eyJhbGci</span><span class="o">...</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">eyJzdWIi</span><span class="o">...</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">SflKxwRJ</span><span class="o">...</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">     </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">     </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="n">Header</span><span class="w">        </span><span class="n">Payload</span><span class="w">       </span><span class="n">Signature</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Header</span><span class="w"> </span><span class="p">(</span><span class="n">base64url</span><span class="p">):</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">{</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;RS256&quot;</span><span class="p">,</span><span class="w">                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT&quot;</span><span class="p">,</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;kid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;key-id-123&quot;</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">}</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Payload</span><span class="w"> </span><span class="p">(</span><span class="n">base64url</span><span class="p">):</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">{</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user_123&quot;</span><span class="p">,</span><span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Subject</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="n">ID</span><span class="p">)</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;api.example.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Issuer</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;app.example.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Audience</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1700000000</span><span class="p">,</span><span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Expiration</span><span class="w"> </span><span class="n">time</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1699996400</span><span class="p">,</span><span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Issued</span><span class="w"> </span><span class="n">at</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;nbf&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1699996400</span><span class="p">,</span><span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Not</span><span class="w"> </span><span class="n">before</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;unique-token-id&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">JWT</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="n">revocation</span><span class="p">)</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;scope&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;read write&quot;</span><span class="p">,</span><span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Custom</span><span class="w"> </span><span class="n">claims</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;admin&quot;</span><span class="w">                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">}</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Signature</span><span class="p">:</span><span class="w">                                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">RSASHA256</span><span class="p">(</span><span class="n">base64url</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;.&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">base64url</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">IMPORTANT</span><span class="p">:</span><span class="w"> </span><span class="n">Payload</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">NOT</span><span class="w"> </span><span class="n">encrypted</span><span class="w"> </span><span class="err">â€”</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">base64url</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">encoded</span><span class="o">.</span><span class="w"> </span><span class="n">Anyone</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">it</span><span class="o">.</span><span class="w"> </span><span class="n">Never</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="n">secrets</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">JWT</span><span class="o">.</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">JWT authentication with PyJWT â€” secure implementation.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># â”€â”€ Key configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Use RS256 (asymmetric) for production</span>
<span class="c1"># Private key signs tokens; public key verifies them</span>
<span class="c1"># This allows microservices to verify without the private key</span>

<span class="c1"># For this example, we use HS256 (symmetric) for simplicity</span>
<span class="n">JWT_SECRET</span> <span class="o">=</span> <span class="s2">&quot;your-256-bit-secret-change-this&quot;</span>  <span class="c1"># Use env var in production</span>
<span class="n">JWT_ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
<span class="n">JWT_ACCESS_TOKEN_EXPIRES</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">JWT_REFRESH_TOKEN_EXPIRES</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>


<span class="c1"># â”€â”€ Token blacklist (use Redis in production) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">revoked_tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                        <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a short-lived access token.&quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="s2">&quot;iss&quot;</span><span class="p">:</span> <span class="s2">&quot;api.example.com&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aud&quot;</span><span class="p">:</span> <span class="s2">&quot;app.example.com&quot;</span><span class="p">,</span>
        <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
        <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">JWT_ACCESS_TOKEN_EXPIRES</span><span class="p">,</span>
        <span class="s2">&quot;nbf&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
        <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>        <span class="c1"># Unique ID for revocation</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;access&quot;</span><span class="p">,</span>
        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
        <span class="s2">&quot;scopes&quot;</span><span class="p">:</span> <span class="n">scopes</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">JWT_SECRET</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">JWT_ALGORITHM</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_refresh_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a long-lived refresh token.&quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="s2">&quot;iss&quot;</span><span class="p">:</span> <span class="s2">&quot;api.example.com&quot;</span><span class="p">,</span>
        <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
        <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">JWT_REFRESH_TOKEN_EXPIRES</span><span class="p">,</span>
        <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;refresh&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">JWT_SECRET</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">JWT_ALGORITHM</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">decode_token</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decode and validate a JWT token.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="n">token</span><span class="p">,</span>
            <span class="n">JWT_SECRET</span><span class="p">,</span>
            <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">JWT_ALGORITHM</span><span class="p">],</span>
            <span class="n">issuer</span><span class="o">=</span><span class="s2">&quot;api.example.com&quot;</span><span class="p">,</span>
            <span class="n">audience</span><span class="o">=</span><span class="s2">&quot;app.example.com&quot;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;require&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="s2">&quot;iat&quot;</span><span class="p">,</span> <span class="s2">&quot;sub&quot;</span><span class="p">,</span> <span class="s2">&quot;iss&quot;</span><span class="p">,</span> <span class="s2">&quot;aud&quot;</span><span class="p">,</span> <span class="s2">&quot;jti&quot;</span><span class="p">],</span>
                <span class="s2">&quot;verify_exp&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;verify_iss&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;verify_aud&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;verify_nbf&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Check if token has been revoked</span>
        <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;jti&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">revoked_tokens</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">(</span><span class="s2">&quot;Token has been revoked&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">payload</span>

    <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">ExpiredSignatureError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Token has expired&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidAudienceError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid token audience&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidIssuerError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid token issuer&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid token: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_auth</span><span class="p">(</span><span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to require JWT authentication with optional scope check.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Extract token from Authorization header</span>
            <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;missing_token&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Authorization header with Bearer token required&quot;</span>
                <span class="p">}),</span> <span class="mi">401</span>

            <span class="n">token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid_token&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">}),</span> <span class="mi">401</span>

            <span class="c1"># Verify token type</span>
            <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;access&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;wrong_token_type&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Access token required&quot;</span>
                <span class="p">}),</span> <span class="mi">401</span>

            <span class="c1"># Check scopes</span>
            <span class="k">if</span> <span class="n">scopes</span><span class="p">:</span>
                <span class="n">token_scopes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scopes&quot;</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="n">required_scopes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">scopes</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">required_scopes</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">token_scopes</span><span class="p">):</span>
                    <span class="n">missing</span> <span class="o">=</span> <span class="n">required_scopes</span> <span class="o">-</span> <span class="n">token_scopes</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;insufficient_scope&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Missing scopes: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">}),</span> <span class="mi">403</span>

            <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">payload</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="c1"># â”€â”€ Routes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Authenticate and return JWT tokens.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>

    <span class="c1"># Validate credentials (use bcrypt/argon2 hash comparison)</span>
    <span class="c1"># This is simplified â€” see Authentication lesson for details</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="c1"># Use consistent timing to prevent user enumeration</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid_credentials&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid username or password&quot;</span>
        <span class="p">}),</span> <span class="mi">401</span>

    <span class="c1"># Generate token pair</span>
    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">role</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">],</span>
        <span class="n">scopes</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">create_refresh_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
        <span class="s2">&quot;refresh_token&quot;</span><span class="p">:</span> <span class="n">refresh_token</span><span class="p">,</span>
        <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;expires_in&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">JWT_ACCESS_TOKEN_EXPIRES</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()),</span>
    <span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/refresh&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">refresh</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exchange a refresh token for a new access token.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refresh_token&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh_token</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;missing_refresh_token&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Decode without audience check (refresh tokens may differ)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="n">refresh_token</span><span class="p">,</span>
            <span class="n">JWT_SECRET</span><span class="p">,</span>
            <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">JWT_ALGORITHM</span><span class="p">],</span>
            <span class="n">issuer</span><span class="o">=</span><span class="s2">&quot;api.example.com&quot;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;require&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="s2">&quot;sub&quot;</span><span class="p">,</span> <span class="s2">&quot;jti&quot;</span><span class="p">,</span> <span class="s2">&quot;iss&quot;</span><span class="p">]}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;refresh&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not a refresh token&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;jti&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">revoked_tokens</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Refresh token has been revoked&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid_refresh_token&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">401</span>

    <span class="c1"># Revoke old refresh token (rotation)</span>
    <span class="n">revoked_tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;jti&quot;</span><span class="p">])</span>

    <span class="c1"># Issue new token pair</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">]</span>
    <span class="c1"># Look up current user roles/scopes from database</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="n">new_access</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">role</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">],</span>
        <span class="n">scopes</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">new_refresh</span> <span class="o">=</span> <span class="n">create_refresh_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">new_access</span><span class="p">,</span>
        <span class="s2">&quot;refresh_token&quot;</span><span class="p">:</span> <span class="n">new_refresh</span><span class="p">,</span>
        <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;expires_in&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">JWT_ACCESS_TOKEN_EXPIRES</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()),</span>
    <span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/logout&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Revoke the current access token.&quot;&quot;&quot;</span>
    <span class="n">revoked_tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;jti&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Successfully logged out&quot;</span><span class="p">}),</span> <span class="mi">200</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/protected&#39;</span><span class="p">)</span>
<span class="nd">@require_auth</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">protected_resource</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Protected endpoint requiring &#39;read&#39; scope.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">],</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;You have access to this protected resource&quot;</span>
    <span class="p">})</span>


<span class="c1"># Placeholder functions for completeness</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Placeholder â€” implement with proper password hashing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_user_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Placeholder â€” implement with database lookup.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;scopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">]}</span>
</code></pre></div>

<h3 id="24-jwt-security-best-practices">2.4 JWT Security Best Practices<a class="header-link" href="#24-jwt-security-best-practices" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">JWT security best practices and common pitfalls.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># â”€â”€ PITFALL 1: Using &#39;none&#39; algorithm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Attack: Change header to {&quot;alg&quot;: &quot;none&quot;} and remove signature</span>
<span class="c1"># Defense: Always specify allowed algorithms explicitly</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
    <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RS256&quot;</span><span class="p">],</span>  <span class="c1"># NEVER include &quot;none&quot; or allow all</span>
<span class="p">)</span>

<span class="c1"># â”€â”€ PITFALL 2: Confusing HS256 and RS256 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Attack: If server uses RS256, attacker might:</span>
<span class="c1">#   1. Get the public key (it is public)</span>
<span class="c1">#   2. Sign a new token with HS256 using the public key as secret</span>
<span class="c1">#   3. Server treats public key as HMAC secret</span>
<span class="c1"># Defense: Strictly validate algorithm in header</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">rsa_public_key</span><span class="p">,</span>
    <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RS256&quot;</span><span class="p">],</span>  <span class="c1"># Only allow expected algorithm</span>
<span class="p">)</span>

<span class="c1"># â”€â”€ PITFALL 3: Missing expiration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Tokens without exp claim live forever</span>
<span class="c1"># Defense: Always set short expiration</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="s2">&quot;user_123&quot;</span><span class="p">,</span>
    <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1"># â”€â”€ PITFALL 4: Storing sensitive data in payload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># JWT payload is base64url-encoded, NOT encrypted</span>
<span class="c1"># Anyone can decode it without the key</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="n">header</span><span class="p">,</span> <span class="n">payload_b64</span><span class="p">,</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">decoded</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">payload_b64</span> <span class="o">+</span> <span class="s1">&#39;==&#39;</span><span class="p">)</span>
<span class="c1"># Entire payload is now readable!</span>

<span class="c1"># NEVER include: passwords, SSNs, credit cards, PII in JWT</span>
<span class="c1"># Only include: user ID, role, scopes, expiration</span>

<span class="c1"># â”€â”€ PITFALL 5: No token revocation mechanism â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># JWTs are self-contained â€” the server cannot invalidate them</span>
<span class="c1"># Solutions:</span>
<span class="c1"># 1. Short-lived access tokens (15 min) + refresh token rotation</span>
<span class="c1"># 2. Token blacklist (Redis with TTL = token exp)</span>
<span class="c1"># 3. Token versioning (store token version in DB, check on each request)</span>
<span class="c1"># 4. Change signing key (invalidates ALL tokens â€” nuclear option)</span>

<span class="c1"># â”€â”€ RS256 Setup (Production Recommended) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># Generate RSA key pair</span>
<span class="sd">openssl genrsa -out private.pem 2048</span>
<span class="sd">openssl rsa -in private.pem -pubout -out public.pem</span>

<span class="sd"># Private key: Used by auth server to SIGN tokens</span>
<span class="sd"># Public key:  Used by all services to VERIFY tokens</span>
<span class="sd"># Share public key freely; guard private key</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">serialization</span>

<span class="c1"># Load keys</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;private.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">private_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;public.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">public_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_public_key</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="c1"># Sign with private key</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;RS256&quot;</span><span class="p">)</span>

<span class="c1"># Verify with public key (any service can do this)</span>
<span class="n">decoded</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">public_key</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RS256&quot;</span><span class="p">])</span>
</code></pre></div>

<hr />
<h2 id="3-rate-limiting">3. Rate Limiting<a class="header-link" href="#3-rate-limiting" title="Permanent link">&para;</a></h2>
<h3 id="31-rate-limiting-algorithms">3.1 Rate Limiting Algorithms<a class="header-link" href="#31-rate-limiting-algorithms" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="nx">Rate</span><span class="w"> </span><span class="nx">Limiting</span><span class="w"> </span><span class="nx">Algorithms</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="nx">Fixed</span><span class="w"> </span><span class="nx">Window</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Window</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">â”‚â”‚</span><span class="w"> </span><span class="nx">Window</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">â”‚â”‚</span><span class="w"> </span><span class="nx">Window</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="err">â”‚</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â– â– â– â– â– </span><span class="w">    </span><span class="err">â”‚â”‚</span><span class="w"> </span><span class="err">â– â– â– </span><span class="w">      </span><span class="err">â”‚â”‚</span><span class="w"> </span><span class="err">â– â– â– â– â– â– â– </span><span class="w">  </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="mi">5</span><span class="o">/</span><span class="mi">10</span><span class="w">     </span><span class="err">â”‚â”‚</span><span class="w"> </span><span class="mi">3</span><span class="o">/</span><span class="mi">10</span><span class="w">     </span><span class="err">â”‚â”‚</span><span class="w"> </span><span class="mi">7</span><span class="o">/</span><span class="mi">10</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="nx">limit</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nx">per</span><span class="w"> </span><span class="nx">window</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Pro</span><span class="p">:</span><span class="w"> </span><span class="nx">Simple</span><span class="p">.</span><span class="w">  </span><span class="nx">Con</span><span class="p">:</span><span class="w"> </span><span class="nx">Burst</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">window</span><span class="w"> </span><span class="nx">boundary</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="nx">x</span><span class="w"> </span><span class="nx">limit</span><span class="p">)</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="nx">Sliding</span><span class="w"> </span><span class="nx">Window</span><span class="w"> </span><span class="nx">Log</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Time</span><span class="p">:</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="p">[</span><span class="o">====</span><span class="nx">current</span><span class="w"> </span><span class="nx">window</span><span class="o">====</span><span class="p">]</span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Track</span><span class="w"> </span><span class="nx">exact</span><span class="w"> </span><span class="nx">timestamp</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">each</span><span class="w"> </span><span class="nx">request</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Count</span><span class="w"> </span><span class="nx">requests</span><span class="w"> </span><span class="nx">within</span><span class="w"> </span><span class="nx">sliding</span><span class="w"> </span><span class="nx">window</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Pro</span><span class="p">:</span><span class="w"> </span><span class="nx">Accurate</span><span class="p">.</span><span class="w">  </span><span class="nx">Con</span><span class="p">:</span><span class="w"> </span><span class="nx">Memory</span><span class="o">-</span><span class="nx">intensive</span><span class="w"> </span><span class="p">(</span><span class="nx">stores</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nx">timestamps</span><span class="p">)</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="nx">Sliding</span><span class="w"> </span><span class="nx">Window</span><span class="w"> </span><span class="nx">Counter</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Combine</span><span class="w"> </span><span class="nx">fixed</span><span class="w"> </span><span class="nx">window</span><span class="w"> </span><span class="nx">counts</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">weighted</span><span class="w"> </span><span class="nx">overlap</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">weight</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="nx">window_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">elapsed</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">window_size</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">count</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">prev_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">weight</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">current_count</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Pro</span><span class="p">:</span><span class="w"> </span><span class="nx">Memory</span><span class="o">-</span><span class="nx">efficient</span><span class="p">.</span><span class="w">  </span><span class="nx">Con</span><span class="p">:</span><span class="w"> </span><span class="nx">Approximate</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="nx">Token</span><span class="w"> </span><span class="nx">Bucket</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â—</span><span class="w"> </span><span class="err">â—</span><span class="w"> </span><span class="err">â—</span><span class="w"> </span><span class="err">â—</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â†</span><span class="w"> </span><span class="nx">Bucket</span><span class="w"> </span><span class="p">(</span><span class="nx">capacity</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nx">tokens</span><span class="p">)</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â—</span><span class="w"> </span><span class="err">â—</span><span class="w"> </span><span class="err">â—</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="err">â†‘</span><span class="w">                                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Refill</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nx">token</span><span class="o">/</span><span class="nx">second</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Each</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="nx">consumes</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nx">token</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Pro</span><span class="p">:</span><span class="w"> </span><span class="nx">Allows</span><span class="w"> </span><span class="nx">bursts</span><span class="p">.</span><span class="w">  </span><span class="nx">Con</span><span class="p">:</span><span class="w"> </span><span class="nx">More</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">manage</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="nx">Leaky</span><span class="w"> </span><span class="nx">Bucket</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Requests</span><span class="w"> </span><span class="nx">enter</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">queue</span><span class="w"> </span><span class="p">(</span><span class="nx">bucket</span><span class="p">)</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Processed</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">fixed</span><span class="w"> </span><span class="nx">rate</span><span class="w"> </span><span class="p">(</span><span class="nx">leak</span><span class="w"> </span><span class="nx">rate</span><span class="p">)</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Overflow</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">rejected</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Pro</span><span class="p">:</span><span class="w"> </span><span class="nx">Smooth</span><span class="w"> </span><span class="nx">output</span><span class="w"> </span><span class="nx">rate</span><span class="p">.</span><span class="w">  </span><span class="nx">Con</span><span class="p">:</span><span class="w"> </span><span class="nx">Delays</span><span class="w"> </span><span class="nx">even</span><span class="w"> </span><span class="nx">when</span><span class="w"> </span><span class="nx">capacity</span><span class="w"> </span><span class="nx">exists</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="32-flask-rate-limiting-with-flask-limiter">3.2 Flask Rate Limiting with Flask-Limiter<a class="header-link" href="#32-flask-rate-limiting-with-flask-limiter" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Rate limiting implementation with Flask-Limiter.</span>
<span class="sd">pip install Flask-Limiter</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_limiter</span><span class="w"> </span><span class="kn">import</span> <span class="n">Limiter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_limiter.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_remote_address</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># â”€â”€ Basic setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">limiter</span> <span class="o">=</span> <span class="n">Limiter</span><span class="p">(</span>
    <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span>
    <span class="n">key_func</span><span class="o">=</span><span class="n">get_remote_address</span><span class="p">,</span>       <span class="c1"># Rate limit by IP address</span>
    <span class="n">default_limits</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;200 per day&quot;</span><span class="p">,</span> <span class="s2">&quot;50 per hour&quot;</span><span class="p">],</span>
    <span class="n">storage_uri</span><span class="o">=</span><span class="s2">&quot;redis://localhost:6379&quot;</span><span class="p">,</span>  <span class="c1"># Use Redis for distributed</span>
    <span class="c1"># storage_uri=&quot;memory://&quot;,           # In-memory for development</span>
    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;fixed-window-elastic-expiry&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="c1"># â”€â”€ Global rate limit (applies to all routes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Already set via default_limits above</span>

<span class="c1"># â”€â”€ Per-route rate limits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/search&#39;</span><span class="p">)</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="s2">&quot;10 per minute&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Search endpoint â€” stricter limit to prevent scraping.&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[]})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="s2">&quot;5 per minute&quot;</span><span class="p">)</span>         <span class="c1"># Prevent brute force</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Login endpoint with aggressive rate limiting.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;login&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/data&#39;</span><span class="p">)</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="s2">&quot;100 per hour&quot;</span><span class="p">)</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="s2">&quot;10 per minute&quot;</span><span class="p">)</span>        <span class="c1"># Multiple limits</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Data endpoint with tiered rate limits.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[]})</span>


<span class="c1"># â”€â”€ Dynamic rate limit based on API key tier â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_rate_limit_by_tier</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return rate limit string based on the client&#39;s API tier.&quot;&quot;&quot;</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-API-Key&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># Look up tier from database (simplified)</span>
    <span class="n">tiers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;free&quot;</span><span class="p">:</span> <span class="s2">&quot;100 per hour&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pro&quot;</span><span class="p">:</span> <span class="s2">&quot;1000 per hour&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enterprise&quot;</span><span class="p">:</span> <span class="s2">&quot;10000 per hour&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">tier</span> <span class="o">=</span> <span class="n">get_tier_for_key</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tier</span><span class="p">,</span> <span class="s2">&quot;50 per hour&quot;</span><span class="p">)</span>  <span class="c1"># Default to free</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/premium&#39;</span><span class="p">)</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">get_rate_limit_by_tier</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">premium_endpoint</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Endpoint with tier-based rate limiting.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;premium&quot;</span><span class="p">})</span>


<span class="c1"># â”€â”€ Rate limit headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Flask-Limiter automatically adds these headers:</span>
<span class="c1"># X-RateLimit-Limit: 100</span>
<span class="c1"># X-RateLimit-Remaining: 95</span>
<span class="c1"># X-RateLimit-Reset: 1699999999</span>
<span class="c1"># Retry-After: 60 (when limit exceeded)</span>

<span class="c1"># â”€â”€ Custom error handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">429</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ratelimit_handler</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom response when rate limit is exceeded.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;rate_limit_exceeded&quot;</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Too many requests. Please try again later.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;retry_after&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
    <span class="p">}),</span> <span class="mi">429</span>


<span class="c1"># Placeholder</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_tier_for_key</span><span class="p">(</span><span class="n">api_key</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;free&quot;</span>
</code></pre></div>

<h3 id="33-custom-token-bucket-implementation">3.3 Custom Token Bucket Implementation<a class="header-link" href="#33-custom-token-bucket-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Token bucket rate limiter implementation from scratch.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TokenBucket</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Token bucket rate limiter.</span>

<span class="sd">    Args:</span>
<span class="sd">        capacity: Maximum number of tokens in the bucket</span>
<span class="sd">        refill_rate: Tokens added per second</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">capacity</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">refill_rate</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">tokens</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">last_refill</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lock</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_refill</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_refill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add tokens based on elapsed time.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_refill</span>
        <span class="n">new_tokens</span> <span class="o">=</span> <span class="n">elapsed</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">refill_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">+</span> <span class="n">new_tokens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_refill</span> <span class="o">=</span> <span class="n">now</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to consume tokens. Returns True if allowed.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_refill</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">&gt;=</span> <span class="n">tokens</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">-=</span> <span class="n">tokens</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">wait_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns seconds until at least 1 token is available.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_refill</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">refill_rate</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RateLimiterStore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manage rate limiters per client key.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">refill_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refill_rate</span> <span class="o">=</span> <span class="n">refill_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buckets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TokenBucket</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenBucket</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or create a token bucket for the given key.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buckets</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buckets</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_buckets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">TokenBucket</span><span class="p">(</span>
                        <span class="n">capacity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span>
                        <span class="n">refill_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refill_rate</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buckets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a request is allowed for the given key.&quot;&quot;&quot;</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bucket</span><span class="o">.</span><span class="n">consume</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>


<span class="c1"># â”€â”€ Usage with Flask â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiterStore</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">refill_rate</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rate_limit</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">refill_rate</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom rate limit decorator.&quot;&quot;&quot;</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">RateLimiterStore</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="n">capacity</span><span class="p">,</span> <span class="n">refill_rate</span><span class="o">=</span><span class="n">refill_rate</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Use IP + endpoint as the rate limit key</span>
            <span class="n">client_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">bucket</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket</span><span class="o">.</span><span class="n">consume</span><span class="p">():</span>
                <span class="n">wait</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">wait_time</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;rate_limit_exceeded&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;retry_after&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">}),</span> <span class="mi">429</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/resource&#39;</span><span class="p">)</span>
<span class="nd">@rate_limit</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">refill_rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># 10 burst, 1/sec sustained</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_resource</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;resource&quot;</span><span class="p">})</span>
</code></pre></div>

<hr />
<h2 id="4-input-validation-and-sanitization">4. Input Validation and Sanitization<a class="header-link" href="#4-input-validation-and-sanitization" title="Permanent link">&para;</a></h2>
<h3 id="41-validation-architecture">4.1 Validation Architecture<a class="header-link" href="#41-validation-architecture" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="nx">Input</span><span class="w"> </span><span class="nx">Validation</span><span class="w"> </span><span class="nx">Layers</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Request</span><span class="w"> </span><span class="err">â”€â”¬â”€â”€</span><span class="w"> </span><span class="nx">Layer</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nx">Schema</span><span class="w"> </span><span class="nx">Validation</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">   </span><span class="p">(</span><span class="nx">structure</span><span class="p">,</span><span class="w"> </span><span class="nx">types</span><span class="p">,</span><span class="w"> </span><span class="nx">required</span><span class="w"> </span><span class="nx">fields</span><span class="p">)</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">                                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Layer</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nx">Business</span><span class="w"> </span><span class="nx">Validation</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">   </span><span class="p">(</span><span class="nx">ranges</span><span class="p">,</span><span class="w"> </span><span class="nx">formats</span><span class="p">,</span><span class="w"> </span><span class="nx">consistency</span><span class="p">)</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">                                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Layer</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="nx">Sanitization</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">   </span><span class="p">(</span><span class="nx">trim</span><span class="w"> </span><span class="nx">whitespace</span><span class="p">,</span><span class="w"> </span><span class="nx">normalize</span><span class="p">,</span><span class="w"> </span><span class="nx">encode</span><span class="p">)</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">                                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">Layer</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="nx">Parameterized</span><span class="w"> </span><span class="nx">Operations</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">               </span><span class="p">(</span><span class="nx">SQL</span><span class="w"> </span><span class="nx">parameterization</span><span class="p">,</span><span class="w"> </span><span class="nx">template</span><span class="w"> </span><span class="nx">escaping</span><span class="p">)</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Principle</span><span class="p">:</span><span class="w"> </span><span class="nx">Validate</span><span class="w"> </span><span class="nx">early</span><span class="p">,</span><span class="w"> </span><span class="nx">fail</span><span class="w"> </span><span class="nx">fast</span><span class="p">,</span><span class="w"> </span><span class="nx">never</span><span class="w"> </span><span class="nx">trust</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="42-schema-validation-with-marshmallow">4.2 Schema Validation with Marshmallow<a class="header-link" href="#42-schema-validation-with-marshmallow" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">API input validation using Marshmallow schemas.</span>
<span class="sd">pip install marshmallow</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">marshmallow</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Schema</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">validate</span><span class="p">,</span> <span class="n">validates</span><span class="p">,</span> <span class="n">validates_schema</span><span class="p">,</span>
    <span class="n">ValidationError</span><span class="p">,</span> <span class="n">pre_load</span><span class="p">,</span> <span class="n">RAISE</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># â”€â”€ Schema Definition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserCreateSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Schema for creating a new user.&quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="c1"># Raise error on unknown fields (prevents mass assignment)</span>
        <span class="n">unknown</span> <span class="o">=</span> <span class="n">RAISE</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="p">[</span>
            <span class="n">validate</span><span class="o">.</span><span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>
            <span class="n">validate</span><span class="o">.</span><span class="n">Regexp</span><span class="p">(</span>
                <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_]+$&#39;</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Username must contain only letters, numbers, underscores&quot;</span>
            <span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Email</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">load_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Never include in serialized output</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">128</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">150</span><span class="p">),</span>
        <span class="n">load_default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">OneOf</span><span class="p">([</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;moderator&quot;</span><span class="p">]),</span>
        <span class="n">load_default</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="c1"># Note: &quot;admin&quot; is not allowed via API â€” only via database</span>
    <span class="p">)</span>

    <span class="nd">@validates</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_password_complexity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enforce password complexity requirements.&quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Must contain at least one uppercase letter&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Must contain at least one lowercase letter&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Must contain at least one digit&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="s1">&#39;!@#$%^&amp;*()_+-=[]</span><span class="si">{}</span><span class="s1">|;:,.&lt;&gt;?&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Must contain at least one special character&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

    <span class="nd">@pre_load</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize input data before validation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;email&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;username&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SearchQuerySchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Schema for search queries.&quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">unknown</span> <span class="o">=</span> <span class="n">RAISE</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">200</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1000</span><span class="p">),</span>
        <span class="n">load_default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">per_page</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">100</span><span class="p">),</span>
        <span class="n">load_default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">sort</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">OneOf</span><span class="p">([</span><span class="s2">&quot;relevance&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]),</span>
        <span class="n">load_default</span><span class="o">=</span><span class="s2">&quot;relevance&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">OneOf</span><span class="p">([</span><span class="s2">&quot;asc&quot;</span><span class="p">,</span> <span class="s2">&quot;desc&quot;</span><span class="p">]),</span>
        <span class="n">load_default</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="c1"># â”€â”€ Validation decorator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_input</span><span class="p">(</span><span class="n">schema_class</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to validate request input against a schema.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">schema_class</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid_request&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Request body must be valid JSON&quot;</span>
                    <span class="p">}),</span> <span class="mi">400</span>
            <span class="k">elif</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;args&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;form&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown location: </span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">validated</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;validation_error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">err</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span>
                <span class="p">}),</span> <span class="mi">422</span>

            <span class="n">request</span><span class="o">.</span><span class="n">validated_data</span> <span class="o">=</span> <span class="n">validated</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="c1"># â”€â”€ Using the validation decorator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@validate_input</span><span class="p">(</span><span class="n">UserCreateSchema</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new user with validated input.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">validated_data</span>
    <span class="c1"># data is guaranteed to be valid at this point</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;User created&quot;</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
    <span class="p">}),</span> <span class="mi">201</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/search&#39;</span><span class="p">)</span>
<span class="nd">@validate_input</span><span class="p">(</span><span class="n">SearchQuerySchema</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;args&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Search with validated query parameters.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">validated_data</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">],</span>
        <span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;page&quot;</span><span class="p">],</span>
        <span class="s2">&quot;per_page&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;per_page&quot;</span><span class="p">],</span>
    <span class="p">})</span>
</code></pre></div>

<h3 id="43-pydantic-validation-alternative">4.3 Pydantic Validation (Alternative)<a class="header-link" href="#43-pydantic-validation-alternative" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">API validation using Pydantic v2.</span>
<span class="sd">pip install pydantic</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">field_validator</span><span class="p">,</span> <span class="n">model_validator</span><span class="p">,</span>
    <span class="n">EmailStr</span><span class="p">,</span> <span class="n">ConfigDict</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserCreate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pydantic model for user creation.&quot;&quot;&quot;</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span>
        <span class="n">str_strip_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">extra</span><span class="o">=</span><span class="s1">&#39;forbid&#39;</span><span class="p">,</span>  <span class="c1"># Reject unknown fields</span>
    <span class="p">)</span>

    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">min_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_]+$&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">age</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^(user|moderator)$&#39;</span><span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_password</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[A-Z]&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must contain uppercase letter&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[a-z]&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must contain lowercase letter&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must contain digit&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[!@#$%^&amp;*()_+\-=\[\]</span><span class="si">{}</span><span class="s1">|;:,.&lt;&gt;?]&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must contain special character&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_email</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>


<span class="c1"># â”€â”€ Usage in Flask â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">PydanticValidationError</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">UserCreate</span><span class="p">(</span><span class="o">**</span><span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">())</span>
    <span class="k">except</span> <span class="n">PydanticValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;validation_error&quot;</span><span class="p">,</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">(),</span>
        <span class="p">}),</span> <span class="mi">422</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">}),</span> <span class="mi">201</span>
</code></pre></div>

<hr />
<h2 id="5-cors-cross-origin-resource-sharing">5. CORS (Cross-Origin Resource Sharing)<a class="header-link" href="#5-cors-cross-origin-resource-sharing" title="Permanent link">&para;</a></h2>
<h3 id="51-how-cors-works">5.1 How CORS Works<a class="header-link" href="#51-how-cors-works" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="nx">CORS</span><span class="w"> </span><span class="nx">Flow</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Simple</span><span class="w"> </span><span class="nx">Request</span><span class="w"> </span><span class="p">(</span><span class="nx">GET</span><span class="p">,</span><span class="w"> </span><span class="nx">HEAD</span><span class="p">,</span><span class="w"> </span><span class="nx">POST</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">simple</span><span class="w"> </span><span class="nx">headers</span><span class="p">):</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Browser</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="kn">api</span><span class="o">/</span><span class="nx">data</span><span class="err">â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">Server</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="nx">origin</span><span class="p">:</span><span class="w"> </span><span class="nx">https</span><span class="p">:</span><span class="c1">//app.com)                                          â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Server</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="nx">Response</span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">Browser</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Access</span><span class="o">-</span><span class="nx">Control</span><span class="o">-</span><span class="nx">Allow</span><span class="o">-</span><span class="nx">Origin</span><span class="p">:</span><span class="w"> </span><span class="nx">https</span><span class="p">:</span><span class="c1">//app.com                        â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”€â”€â”€</span><span class="w"> </span><span class="nx">Browser</span><span class="w"> </span><span class="nx">allows</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="err">âœ“</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Preflight</span><span class="w"> </span><span class="nx">Request</span><span class="w"> </span><span class="p">(</span><span class="nx">PUT</span><span class="p">,</span><span class="w"> </span><span class="nx">DELETE</span><span class="p">,</span><span class="w"> </span><span class="nx">custom</span><span class="w"> </span><span class="nx">headers</span><span class="p">,</span><span class="w"> </span><span class="nx">JSON</span><span class="p">):</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Step</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nx">Browser</span><span class="w"> </span><span class="nx">sends</span><span class="w"> </span><span class="nx">OPTIONS</span><span class="w"> </span><span class="nx">preflight</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Browser</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="nx">OPTIONS</span><span class="w"> </span><span class="o">/</span><span class="kn">api</span><span class="o">/</span><span class="nx">data</span><span class="err">â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">Server</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Origin</span><span class="p">:</span><span class="w"> </span><span class="nx">https</span><span class="p">:</span><span class="c1">//app.com                                             â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Access</span><span class="o">-</span><span class="nx">Control</span><span class="o">-</span><span class="nx">Request</span><span class="o">-</span><span class="nx">Method</span><span class="p">:</span><span class="w"> </span><span class="nx">PUT</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Access</span><span class="o">-</span><span class="nx">Control</span><span class="o">-</span><span class="nx">Request</span><span class="o">-</span><span class="nx">Headers</span><span class="p">:</span><span class="w"> </span><span class="nx">Content</span><span class="o">-</span><span class="nx">Type</span><span class="p">,</span><span class="w"> </span><span class="nx">Authorization</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Step</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nx">Server</span><span class="w"> </span><span class="nx">responds</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">allowed</span><span class="w"> </span><span class="nx">methods</span><span class="o">/</span><span class="nx">headers</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Server</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="mi">204</span><span class="w"> </span><span class="nx">No</span><span class="w"> </span><span class="nx">Content</span><span class="err">â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">Browser</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Access</span><span class="o">-</span><span class="nx">Control</span><span class="o">-</span><span class="nx">Allow</span><span class="o">-</span><span class="nx">Origin</span><span class="p">:</span><span class="w"> </span><span class="nx">https</span><span class="p">:</span><span class="c1">//app.com                        â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Access</span><span class="o">-</span><span class="nx">Control</span><span class="o">-</span><span class="nx">Allow</span><span class="o">-</span><span class="nx">Methods</span><span class="p">:</span><span class="w"> </span><span class="nx">GET</span><span class="p">,</span><span class="w"> </span><span class="nx">POST</span><span class="p">,</span><span class="w"> </span><span class="nx">PUT</span><span class="p">,</span><span class="w"> </span><span class="nx">DELETE</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Access</span><span class="o">-</span><span class="nx">Control</span><span class="o">-</span><span class="nx">Allow</span><span class="o">-</span><span class="nx">Headers</span><span class="p">:</span><span class="w"> </span><span class="nx">Content</span><span class="o">-</span><span class="nx">Type</span><span class="p">,</span><span class="w"> </span><span class="nx">Authorization</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Access</span><span class="o">-</span><span class="nx">Control</span><span class="o">-</span><span class="nx">Max</span><span class="o">-</span><span class="nx">Age</span><span class="p">:</span><span class="w"> </span><span class="mi">86400</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Step</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="nx">Browser</span><span class="w"> </span><span class="nx">sends</span><span class="w"> </span><span class="nx">actual</span><span class="w"> </span><span class="nx">request</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Browser</span><span class="w"> </span><span class="err">â”€â”€â”€â”€</span><span class="nx">PUT</span><span class="w"> </span><span class="o">/</span><span class="kn">api</span><span class="o">/</span><span class="nx">data</span><span class="err">â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">Server</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="52-flask-cors-configuration">5.2 Flask CORS Configuration<a class="header-link" href="#52-flask-cors-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">CORS configuration in Flask.</span>
<span class="sd">pip install flask-cors</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORS</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># â”€â”€ Option 1: Allow specific origins (RECOMMENDED) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="p">{</span>
    <span class="sa">r</span><span class="s2">&quot;/api/*&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;origins&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;https://app.example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;https://admin.example.com&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">],</span>
        <span class="s2">&quot;allow_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Authorization&quot;</span><span class="p">],</span>
        <span class="s2">&quot;expose_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;X-Request-Id&quot;</span><span class="p">,</span> <span class="s2">&quot;X-RateLimit-Remaining&quot;</span><span class="p">],</span>
        <span class="s2">&quot;supports_credentials&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;max_age&quot;</span><span class="p">:</span> <span class="mi">86400</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="c1"># â”€â”€ Option 2: Different CORS for different routes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">app2</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Public API: allow any origin (no credentials)</span>
<span class="n">CORS</span><span class="p">(</span><span class="n">app2</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="p">{</span>
    <span class="sa">r</span><span class="s2">&quot;/api/public/*&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;origins&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span>
        <span class="s2">&quot;allow_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">],</span>
        <span class="s2">&quot;supports_credentials&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># MUST be False with origin: *</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="c1"># Private API: specific origins with credentials</span>
<span class="n">CORS</span><span class="p">(</span><span class="n">app2</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="p">{</span>
    <span class="sa">r</span><span class="s2">&quot;/api/private/*&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;origins&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;https://app.example.com&quot;</span><span class="p">],</span>
        <span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">],</span>
        <span class="s2">&quot;allow_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Authorization&quot;</span><span class="p">],</span>
        <span class="s2">&quot;supports_credentials&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;max_age&quot;</span><span class="p">:</span> <span class="mi">86400</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="c1"># â”€â”€ Option 3: Manual CORS implementation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">make_response</span>

<span class="n">app3</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">ALLOWED_ORIGINS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;https://app.example.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://admin.example.com&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="nd">@app3</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_cors_headers</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Origin&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">ALLOWED_ORIGINS</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Credentials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;GET, POST, PUT, DELETE, OPTIONS&#39;</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;Content-Type, Authorization, X-Requested-With&#39;</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Expose-Headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;X-Request-Id, X-RateLimit-Remaining&#39;</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Max-Age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;86400&#39;</span>
        <span class="c1"># Vary: Origin tells caches that response varies by origin</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Vary&#39;</span><span class="p">,</span> <span class="s1">&#39;Origin&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>

<span class="nd">@app3</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/data&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">preflight</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle CORS preflight requests.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">204</span><span class="p">)</span>


<span class="c1"># â”€â”€ CORS Security Rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">1. NEVER use Access-Control-Allow-Origin: * with credentials</span>
<span class="sd">   - This is actually blocked by browsers</span>
<span class="sd">   - If you need credentials, list specific origins</span>

<span class="sd">2. NEVER reflect the Origin header as Allow-Origin without checking</span>
<span class="sd">   - This is equivalent to allowing all origins</span>
<span class="sd">   - BAD:  response.headers[&#39;ACAO&#39;] = request.headers[&#39;Origin&#39;]</span>
<span class="sd">   - GOOD: Check against an allowlist first</span>

<span class="sd">3. Limit Access-Control-Allow-Methods to what is actually needed</span>
<span class="sd">   - Don&#39;t allow DELETE if the route doesn&#39;t support it</span>

<span class="sd">4. Set Access-Control-Max-Age to reduce preflight requests</span>
<span class="sd">   - 86400 (24 hours) is reasonable</span>

<span class="sd">5. Use Access-Control-Expose-Headers for custom headers</span>
<span class="sd">   - By default, only simple headers are readable by JavaScript</span>

<span class="sd">6. Always add Vary: Origin when ACAO changes per request</span>
<span class="sd">   - Prevents cache poisoning</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>

<hr />
<h2 id="6-graphql-security">6. GraphQL Security<a class="header-link" href="#6-graphql-security" title="Permanent link">&para;</a></h2>
<h3 id="61-graphql-specific-threats">6.1 GraphQL-Specific Threats<a class="header-link" href="#61-graphql-specific-threats" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="n">GraphQL</span><span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="n">Threats</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="n">Depth</span><span class="w"> </span><span class="n">Attack</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">posts</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">comments</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">posts</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">Deeply</span><span class="w"> </span><span class="n">nested</span><span class="w"> </span><span class="n">queries</span><span class="w"> </span><span class="n">cause</span><span class="w"> </span><span class="n">exponential</span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="nb">load</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="n">Breadth</span><span class="w"> </span><span class="n">Attack</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">user1</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p">(</span><span class="n">id</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="o">...</span><span class="p">}</span><span class="w"> </span><span class="n">user2</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p">(</span><span class="n">id</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="o">...</span><span class="p">}</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="p">}</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">Many</span><span class="w"> </span><span class="n">aliases</span><span class="w"> </span><span class="n">multiplies</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">cost</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="n">Introspection</span><span class="w"> </span><span class="n">Abuse</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">__schema</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">Exposes</span><span class="w"> </span><span class="n">entire</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">schema</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">attackers</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">4.</span><span class="w"> </span><span class="n">Batching</span><span class="w"> </span><span class="n">Attack</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="p">[{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">},</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">1000</span><span class="p">]</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">Multiple</span><span class="w"> </span><span class="n">queries</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">single</span><span class="w"> </span><span class="n">request</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">5.</span><span class="w"> </span><span class="n">Injection</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">Variables</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">query</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">String</span><span class="o">!</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">user</span><span class="p">(</span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">variables</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1 OR 1=1&quot;</span><span class="w"> </span><span class="p">}</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">injection</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">unvalidated</span><span class="w"> </span><span class="n">variables</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">6.</span><span class="w"> </span><span class="n">Information</span><span class="w"> </span><span class="n">Disclosure</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Verbose</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="n">revealing</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="n">details</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Field</span><span class="w"> </span><span class="n">suggestions</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Did you mean &#39;secretAdminField&#39;?&quot;</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="62-graphql-security-mitigations">6.2 GraphQL Security Mitigations<a class="header-link" href="#62-graphql-security-mitigations" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">GraphQL security measures with graphene (Python).</span>
<span class="sd">pip install graphene flask-graphql</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># â”€â”€ 1. Query Depth Limiting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DepthAnalyzer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze and limit GraphQL query depth.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_ast</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the maximum depth of a query.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Query depth </span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s2"> exceeds maximum allowed (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="n">max_child_depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">query_ast</span><span class="p">,</span> <span class="s1">&#39;selection_set&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">query_ast</span><span class="o">.</span><span class="n">selection_set</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">selection</span> <span class="ow">in</span> <span class="n">query_ast</span><span class="o">.</span><span class="n">selection_set</span><span class="o">.</span><span class="n">selections</span><span class="p">:</span>
                <span class="n">child_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">max_child_depth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_child_depth</span><span class="p">,</span> <span class="n">child_depth</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">max_child_depth</span>


<span class="c1"># â”€â”€ 2. Query Cost Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="k">class</span><span class="w"> </span><span class="nc">QueryCostAnalyzer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimate the cost of a GraphQL query.&quot;&quot;&quot;</span>

    <span class="c1"># Define cost per field type</span>
    <span class="n">FIELD_COSTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;posts&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>       <span class="c1"># List field, potentially expensive</span>
        <span class="s2">&quot;comments&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;search&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>     <span class="c1"># Full-text search is expensive</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_cost</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_cost</span> <span class="o">=</span> <span class="n">max_cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_ast</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate estimated query cost.&quot;&quot;&quot;</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">query_ast</span><span class="p">,</span> <span class="s1">&#39;selection_set&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">query_ast</span><span class="o">.</span><span class="n">selection_set</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">selection</span> <span class="ow">in</span> <span class="n">query_ast</span><span class="o">.</span><span class="n">selection_set</span><span class="o">.</span><span class="n">selections</span><span class="p">:</span>
                <span class="n">field_name</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">value</span>
                <span class="n">field_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELD_COSTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Check for pagination arguments that multiply cost</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

                <span class="n">cost</span> <span class="o">=</span> <span class="n">field_cost</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>

                <span class="c1"># Recurse into child selections</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_cost</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">total_cost</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cost</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Query cost </span><span class="si">{</span><span class="n">total_cost</span><span class="si">}</span><span class="s2"> exceeds maximum (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cost</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">total_cost</span>


<span class="c1"># â”€â”€ 3. Disable Introspection in Production â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Introspection reveals your entire API schema.</span>
<span class="sd">Disable it in production.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">graphql</span><span class="w"> </span><span class="kn">import</span> <span class="n">GraphQLError</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DisableIntrospection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Middleware to disable introspection queries in production.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">next</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Block __schema and __type queries</span>
        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">field_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;__schema&#39;</span><span class="p">,</span> <span class="s1">&#39;__type&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">GraphQLError</span><span class="p">(</span><span class="s2">&quot;Introspection is disabled&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="c1"># â”€â”€ 4. Rate Limit + Batch Limiting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">MAX_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Maximum queries per batch request</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">limit_batch_queries</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Limit the number of queries in a batch request.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_json</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_BATCH_SIZE</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;batch_limit_exceeded&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Maximum </span><span class="si">{</span><span class="n">MAX_BATCH_SIZE</span><span class="si">}</span><span class="s2"> queries per batch&quot;</span>
                <span class="p">}),</span> <span class="mi">400</span>


<span class="c1"># â”€â”€ 5. Persisted Queries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Instead of accepting arbitrary queries, only accept pre-registered</span>
<span class="sd">query hashes. This prevents injection and query manipulation.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>

<span class="c1"># Pre-registered queries (build-time generated)</span>
<span class="n">PERSISTED_QUERIES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;abc123&quot;</span><span class="p">:</span> <span class="s2">&quot;query { users { id name } }&quot;</span><span class="p">,</span>
    <span class="s2">&quot;def456&quot;</span><span class="p">:</span> <span class="s2">&quot;query GetUser($id: ID!) { user(id: $id) { id name email } }&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/graphql&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">graphql_endpoint</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

    <span class="c1"># Only accept persisted queries in production</span>
    <span class="n">query_hash</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extensions&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;persistedQuery&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sha256Hash&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">query_hash</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">PERSISTED_QUERIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_hash</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;query_not_found&quot;</span><span class="p">}),</span> <span class="mi">404</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># In development, allow arbitrary queries</span>
        <span class="c1"># In production, reject:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;persisted_queries_only&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Only persisted queries are accepted&quot;</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Execute the query...</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}})</span>
</code></pre></div>

<hr />
<h2 id="7-api-gateway-security">7. API Gateway Security<a class="header-link" href="#7-api-gateway-security" title="Permanent link">&para;</a></h2>
<h3 id="71-gateway-architecture">7.1 Gateway Architecture<a class="header-link" href="#71-gateway-architecture" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="nx">API</span><span class="w"> </span><span class="nx">Gateway</span><span class="w"> </span><span class="nx">Security</span><span class="w"> </span><span class="nx">Architecture</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Client</span><span class="w">                                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="err">â–¼</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">              </span><span class="nx">API</span><span class="w"> </span><span class="nx">Gateway</span><span class="w">                        </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                 </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">       </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="nx">TLS</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w">   </span><span class="nx">Auth</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Rate</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="nx">Termination</span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="nx">Validation</span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Limiting</span><span class="w"> </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">       </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                 </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">       </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Input</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Request</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">CORS</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="nx">Validation</span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Logging</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Handling</span><span class="w"> </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">       </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                 </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">       </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">WAF</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">Allow</span><span class="o">/</span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Response</span><span class="w"> </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">Rules</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Blocklist</span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Filtering</span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">       </span><span class="err">â”‚</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â–¼</span><span class="w">              </span><span class="err">â–¼</span><span class="w">              </span><span class="err">â–¼</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">   </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">   </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Service</span><span class="w"> </span><span class="nx">A</span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Service</span><span class="w"> </span><span class="nx">B</span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Service</span><span class="w"> </span><span class="nx">C</span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="nx">Users</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="nx">Orders</span><span class="p">)</span><span class="w"> </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="nx">Search</span><span class="p">)</span><span class="w"> </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">   </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">   </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Security</span><span class="w"> </span><span class="nx">benefits</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">centralized</span><span class="w"> </span><span class="nx">gateway</span><span class="p">:</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">Single</span><span class="w"> </span><span class="nx">point</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="nx">enforcement</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">Consistent</span><span class="w"> </span><span class="nx">rate</span><span class="w"> </span><span class="nx">limiting</span><span class="w"> </span><span class="nx">across</span><span class="w"> </span><span class="nx">services</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">Centralized</span><span class="w"> </span><span class="nx">logging</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">monitoring</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">Backend</span><span class="w"> </span><span class="nx">services</span><span class="w"> </span><span class="nx">don</span><span class="err">&#39;</span><span class="nx">t</span><span class="w"> </span><span class="nx">handle</span><span class="w"> </span><span class="nx">TLS</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">Simplified</span><span class="w"> </span><span class="nx">security</span><span class="w"> </span><span class="nx">policy</span><span class="w"> </span><span class="nx">management</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="72-requestresponse-filtering">7.2 Request/Response Filtering<a class="header-link" href="#72-requestresponse-filtering" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">API gateway request/response filtering middleware.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;api_gateway&#39;</span><span class="p">)</span>


<span class="c1"># â”€â”€ Request ID tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_request_id</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a unique request ID for tracing.&quot;&quot;&quot;</span>
    <span class="n">g</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;X-Request-Id&#39;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">request_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_response_headers</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add security and tracking headers to response.&quot;&quot;&quot;</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Request-Id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">request_id</span>
    <span class="c1"># Add timing</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">g</span><span class="o">.</span><span class="n">request_start</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Response-Time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="c1"># â”€â”€ Request size limiting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">MAX_CONTENT_LENGTH</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 1 MB</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MAX_CONTENT_LENGTH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX_CONTENT_LENGTH</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">check_content_length</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reject oversized requests.&quot;&quot;&quot;</span>
    <span class="n">content_length</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">content_length</span>
    <span class="k">if</span> <span class="n">content_length</span> <span class="ow">and</span> <span class="n">content_length</span> <span class="o">&gt;</span> <span class="n">MAX_CONTENT_LENGTH</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;payload_too_large&quot;</span><span class="p">,</span>
            <span class="s2">&quot;max_bytes&quot;</span><span class="p">:</span> <span class="n">MAX_CONTENT_LENGTH</span><span class="p">,</span>
        <span class="p">}),</span> <span class="mi">413</span>


<span class="c1"># â”€â”€ IP allowlist/blocklist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">BLOCKED_IPS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;192.168.1.100&quot;</span><span class="p">,</span> <span class="s2">&quot;10.0.0.50&quot;</span><span class="p">}</span>
<span class="n">ADMIN_ALLOWED_IPS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;10.0.0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;10.0.0.2&quot;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">check_ip</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Block requests from banned IPs.&quot;&quot;&quot;</span>
    <span class="n">client_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span>

    <span class="k">if</span> <span class="n">client_ip</span> <span class="ow">in</span> <span class="n">BLOCKED_IPS</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Blocked request from banned IP: </span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;forbidden&quot;</span><span class="p">}),</span> <span class="mi">403</span>

    <span class="c1"># Admin routes require specific IPs</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/admin/&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">client_ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ADMIN_ALLOWED_IPS</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;forbidden&quot;</span><span class="p">}),</span> <span class="mi">403</span>


<span class="c1"># â”€â”€ Response data filtering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">SENSITIVE_FIELDS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;ssn&#39;</span><span class="p">,</span> <span class="s1">&#39;credit_card&#39;</span><span class="p">,</span> <span class="s1">&#39;secret_key&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="s1">&#39;api_key&#39;</span><span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">filter_sensitive_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Recursively remove sensitive fields from response data.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">filter_sensitive_data</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SENSITIVE_FIELDS</span>
        <span class="p">}</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">filter_sensitive_data</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="c1"># â”€â”€ Audit logging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">audit_log</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log every API request for audit trail.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;API Request: method=</span><span class="si">%s</span><span class="s2"> path=</span><span class="si">%s</span><span class="s2"> status=</span><span class="si">%s</span><span class="s2"> &quot;</span>
        <span class="s2">&quot;ip=</span><span class="si">%s</span><span class="s2"> user_agent=</span><span class="si">%s</span><span class="s2"> request_id=</span><span class="si">%s</span><span class="s2"> duration=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">user_agent</span><span class="o">.</span><span class="n">string</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span>
        <span class="n">g</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-Response-Time&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<hr />
<h2 id="8-openapi-security-definitions">8. OpenAPI Security Definitions<a class="header-link" href="#8-openapi-security-definitions" title="Permanent link">&para;</a></h2>
<h3 id="81-security-schemes-in-openapi-30">8.1 Security Schemes in OpenAPI 3.0<a class="header-link" href="#81-security-schemes-in-openapi-30" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># openapi.yaml - Security scheme definitions</span>
<span class="nt">openapi</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.0.3</span>
<span class="nt">info</span><span class="p">:</span>
<span class="w">  </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secure API</span>
<span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0.0</span>

<span class="c1"># â”€â”€ Security Scheme Definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nt">components</span><span class="p">:</span>
<span class="w">  </span><span class="nt">securitySchemes</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># API Key authentication</span>
<span class="w">    </span><span class="nt">ApiKeyAuth</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apiKey</span>
<span class="w">      </span><span class="nt">in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">header</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">X-API-Key</span>
<span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">API key for server-to-server communication</span>

<span class="w">    </span><span class="c1"># JWT Bearer token</span>
<span class="w">    </span><span class="nt">BearerAuth</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="w">      </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bearer</span>
<span class="w">      </span><span class="nt">bearerFormat</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">JWT</span>
<span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">JWT access token</span>

<span class="w">    </span><span class="c1"># OAuth 2.0</span>
<span class="w">    </span><span class="nt">OAuth2</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">oauth2</span>
<span class="w">      </span><span class="nt">flows</span><span class="p">:</span>
<span class="w">        </span><span class="nt">authorizationCode</span><span class="p">:</span>
<span class="w">          </span><span class="nt">authorizationUrl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://auth.example.com/authorize</span>
<span class="w">          </span><span class="nt">tokenUrl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://auth.example.com/token</span>
<span class="w">          </span><span class="nt">refreshUrl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://auth.example.com/refresh</span>
<span class="w">          </span><span class="nt">scopes</span><span class="p">:</span>
<span class="w">            </span><span class="nt">read</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Read access to resources</span>
<span class="w">            </span><span class="nt">write</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Write access to resources</span>
<span class="w">            </span><span class="nt">admin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Administrative access</span>

<span class="w">    </span><span class="c1"># OpenID Connect</span>
<span class="w">    </span><span class="nt">OpenIdConnect</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openIdConnect</span>
<span class="w">      </span><span class="nt">openIdConnectUrl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://auth.example.com/.well-known/openid-configuration</span>

<span class="c1"># â”€â”€ Global security (applies to all endpoints) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nt">security</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">BearerAuth</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>

<span class="c1"># â”€â”€ Per-endpoint security â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nt">paths</span><span class="p">:</span>
<span class="w">  </span><span class="nt">/api/public/status</span><span class="p">:</span>
<span class="w">    </span><span class="nt">get</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Health check (no auth required)</span>
<span class="w">      </span><span class="nt">security</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w">  </span><span class="c1"># Override: no authentication</span>
<span class="w">      </span><span class="nt">responses</span><span class="p">:</span>
<span class="w">        </span><span class="s">&#39;200&#39;</span><span class="p p-Indicator">:</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OK</span>

<span class="w">  </span><span class="nt">/api/users</span><span class="p">:</span>
<span class="w">    </span><span class="nt">get</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">List users</span>
<span class="w">      </span><span class="nt">security</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">BearerAuth</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ApiKeyAuth</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w">  </span><span class="c1"># Alternative auth (OR)</span>
<span class="w">      </span><span class="nt">responses</span><span class="p">:</span>
<span class="w">        </span><span class="s">&#39;200&#39;</span><span class="p p-Indicator">:</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">User list</span>

<span class="w">  </span><span class="nt">/api/admin/settings</span><span class="p">:</span>
<span class="w">    </span><span class="nt">put</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Update settings (admin only)</span>
<span class="w">      </span><span class="nt">security</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">OAuth2</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">admin</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># Requires &#39;admin&#39; scope</span>
<span class="w">      </span><span class="nt">responses</span><span class="p">:</span>
<span class="w">        </span><span class="s">&#39;200&#39;</span><span class="p p-Indicator">:</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Settings updated</span>

<span class="w">  </span><span class="nt">/api/data</span><span class="p">:</span>
<span class="w">    </span><span class="nt">post</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create data (requires read + write)</span>
<span class="w">      </span><span class="nt">security</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">OAuth2</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">read</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">write</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># Requires BOTH scopes</span>
<span class="w">      </span><span class="nt">responses</span><span class="p">:</span>
<span class="w">        </span><span class="s">&#39;201&#39;</span><span class="p p-Indicator">:</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Data created</span>
</code></pre></div>

<h3 id="82-api-versioning-security">8.2 API Versioning Security<a class="header-link" href="#82-api-versioning-security" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">API versioning considerations for security.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># â”€â”€ URL path versioning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># /api/v1/users  (old, may have known vulnerabilities)</span>
<span class="c1"># /api/v2/users  (current, patched)</span>

<span class="c1"># â”€â”€ Header versioning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Accept: application/vnd.example.v2+json</span>

<span class="c1"># â”€â”€ Security concerns with versioning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">1. Old API versions may have known vulnerabilities</span>
<span class="sd">   - Set deprecation dates and enforce them</span>
<span class="sd">   - Return Deprecation and Sunset headers</span>

<span class="sd">2. Don&#39;t maintain security patches for deprecated versions</span>
<span class="sd">   - Force migration to latest version</span>

<span class="sd">3. Monitor usage of deprecated versions</span>
<span class="sd">   - Alert when old versions are still in use</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">API_VERSIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;v1&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;deprecated&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sunset&quot;</span><span class="p">:</span> <span class="s2">&quot;2025-06-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;successor&quot;</span><span class="p">:</span> <span class="s2">&quot;v2&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;v2&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;current&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sunset&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;successor&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">check_api_version</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Warn or block deprecated API versions.&quot;&quot;&quot;</span>
    <span class="c1"># Extract version from URL path</span>
    <span class="n">path_parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">path_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;api&#39;</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">path_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">version_info</span> <span class="o">=</span> <span class="n">API_VERSIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">version_info</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid_version&quot;</span><span class="p">,</span>
                <span class="s2">&quot;supported&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">API_VERSIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="p">}),</span> <span class="mi">400</span>

        <span class="k">if</span> <span class="n">version_info</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;deprecated&quot;</span><span class="p">:</span>
            <span class="n">sunset_date</span> <span class="o">=</span> <span class="n">version_info</span><span class="p">[</span><span class="s2">&quot;sunset&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sunset_date</span><span class="p">:</span>
                <span class="c1"># Check if past sunset date</span>
                <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">sunset_date</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;version_retired&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;API </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2"> was retired on </span><span class="si">{</span><span class="n">sunset_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;upgrade_to&quot;</span><span class="p">:</span> <span class="n">version_info</span><span class="p">[</span><span class="s2">&quot;successor&quot;</span><span class="p">],</span>
                    <span class="p">}),</span> <span class="mi">410</span>  <span class="c1"># 410 Gone</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_deprecation_headers</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add deprecation warnings to response headers.&quot;&quot;&quot;</span>
    <span class="n">path_parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">path_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;api&#39;</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">path_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">version_info</span> <span class="o">=</span> <span class="n">API_VERSIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="n">version_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;deprecated&quot;</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Deprecation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
            <span class="k">if</span> <span class="n">version_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sunset&quot;</span><span class="p">):</span>
                <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Sunset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version_info</span><span class="p">[</span><span class="s2">&quot;sunset&quot;</span><span class="p">]</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;/api/</span><span class="si">{</span><span class="n">version_info</span><span class="p">[</span><span class="s2">&quot;successor&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&gt;; rel=&quot;successor-version&quot;&#39;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<hr />
<h2 id="9-requestresponse-encryption">9. Request/Response Encryption<a class="header-link" href="#9-requestresponse-encryption" title="Permanent link">&para;</a></h2>
<h3 id="91-transport-layer-security">9.1 Transport Layer Security<a class="header-link" href="#91-transport-layer-security" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">TLS configuration and certificate pinning.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># â”€â”€ Flask with TLS (development) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Generate self-signed cert for development:</span>
<span class="c1"># openssl req -x509 -newkey rsa:4096 -nodes \</span>
<span class="c1">#   -out cert.pem -keyout key.pem -days 365</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Run with TLS (development only)</span>
<span class="c1"># In production, TLS is handled by reverse proxy (nginx, load balancer)</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">ssl_context</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;cert.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;key.pem&#39;</span><span class="p">),</span>
        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="mi">443</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># â”€â”€ Certificate Pinning (for API clients) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>

<span class="k">def</span><span class="w"> </span><span class="nf">verify_certificate_pin</span><span class="p">(</span><span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expected_pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify server certificate matches expected pin.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">host</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssock</span><span class="p">:</span>
            <span class="n">cert_der</span> <span class="o">=</span> <span class="n">ssock</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cert_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">cert_der</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">cert_hash</span> <span class="o">==</span> <span class="n">expected_pin</span>


<span class="c1"># â”€â”€ Payload-level encryption (for sensitive fields) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.fernet</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fernet</span>

<span class="c1"># Generate key (store securely, not in code)</span>
<span class="n">encryption_key</span> <span class="o">=</span> <span class="n">Fernet</span><span class="o">.</span><span class="n">generate_key</span><span class="p">()</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">encryption_key</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">encrypt_sensitive_fields</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Encrypt specific fields in a response payload.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span><span class="w"> </span><span class="nf">decrypt_sensitive_fields</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decrypt specific fields in a request payload.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<hr />
<h2 id="10-exercises">10. Exercises<a class="header-link" href="#10-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-secure-jwt-authentication-service">Exercise 1: Secure JWT Authentication Service<a class="header-link" href="#exercise-1-secure-jwt-authentication-service" title="Permanent link">&para;</a></h3>
<p>Build a complete JWT authentication service with Flask that includes:</p>
<ol>
<li>User registration with password hashing (argon2 or bcrypt)</li>
<li>Login endpoint that returns access + refresh tokens</li>
<li>Token refresh endpoint with refresh token rotation</li>
<li>Logout endpoint with token blacklisting (use Redis or in-memory set)</li>
<li>A protected endpoint that requires the "admin" scope</li>
<li>Proper error handling for expired, malformed, and revoked tokens</li>
<li>Rate limiting on the login endpoint (5 attempts per minute per IP)</li>
</ol>
<h3 id="exercise-2-cors-security-audit">Exercise 2: CORS Security Audit<a class="header-link" href="#exercise-2-cors-security-audit" title="Permanent link">&para;</a></h3>
<p>Write a Python script that:</p>
<ol>
<li>Takes a list of API URLs</li>
<li>Sends requests with various Origin headers</li>
<li>Tests if the API reflects arbitrary origins (vulnerability)</li>
<li>Checks if credentials are allowed with wildcard origins</li>
<li>Tests preflight handling for common methods and headers</li>
<li>Generates a security report for each endpoint</li>
</ol>
<h3 id="exercise-3-graphql-security-middleware">Exercise 3: GraphQL Security Middleware<a class="header-link" href="#exercise-3-graphql-security-middleware" title="Permanent link">&para;</a></h3>
<p>Implement a GraphQL security middleware that:</p>
<ol>
<li>Limits query depth to a configurable maximum (default: 10)</li>
<li>Calculates query cost and rejects expensive queries</li>
<li>Disables introspection in production</li>
<li>Limits batch query size</li>
<li>Logs all queries with their cost and execution time</li>
<li>Implements persisted queries with a hash allowlist</li>
</ol>
<h3 id="exercise-4-rate-limiter-with-sliding-window">Exercise 4: Rate Limiter with Sliding Window<a class="header-link" href="#exercise-4-rate-limiter-with-sliding-window" title="Permanent link">&para;</a></h3>
<p>Implement a sliding window log rate limiter that:</p>
<ol>
<li>Uses Redis as the backing store (or an in-memory simulation)</li>
<li>Tracks exact timestamps of each request</li>
<li>Supports configurable windows (per second, minute, hour)</li>
<li>Supports different limits for different API key tiers</li>
<li>Returns proper rate limit headers (X-RateLimit-Limit, Remaining, Reset)</li>
<li>Handles distributed deployment (multiple server instances)</li>
</ol>
<h3 id="exercise-5-api-input-validation-framework">Exercise 5: API Input Validation Framework<a class="header-link" href="#exercise-5-api-input-validation-framework" title="Permanent link">&para;</a></h3>
<p>Build a reusable validation framework that:</p>
<ol>
<li>Validates JSON request bodies against schemas</li>
<li>Validates query parameters with type coercion</li>
<li>Validates path parameters</li>
<li>Supports nested object validation</li>
<li>Returns consistent error response format (RFC 7807)</li>
<li>Protects against mass assignment (reject unknown fields)</li>
<li>Sanitizes string inputs (trim, normalize Unicode)</li>
</ol>
<h3 id="exercise-6-api-security-scanner">Exercise 6: API Security Scanner<a class="header-link" href="#exercise-6-api-security-scanner" title="Permanent link">&para;</a></h3>
<p>Create a security scanning tool that tests an API for:</p>
<ol>
<li>Missing authentication on endpoints</li>
<li>Broken object-level authorization (BOLA/IDOR)</li>
<li>Missing rate limiting</li>
<li>Verbose error messages revealing internal details</li>
<li>Missing security headers</li>
<li>CORS misconfiguration</li>
<li>Generate a report with severity ratings</li>
</ol>
<hr />
<h2 id="summary">Summary<a class="header-link" href="#summary" title="Permanent link">&para;</a></h2>
<h3 id="api-security-checklist">API Security Checklist<a class="header-link" href="#api-security-checklist" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Category</th>
<th>Item</th>
<th>Priority</th>
</tr>
</thead>
<tbody>
<tr>
<td>Authentication</td>
<td>Use OAuth 2.0 or JWT (not API keys alone for users)</td>
<td>Critical</td>
</tr>
<tr>
<td>Authentication</td>
<td>Short-lived access tokens (15 min)</td>
<td>Critical</td>
</tr>
<tr>
<td>Authentication</td>
<td>Refresh token rotation</td>
<td>High</td>
</tr>
<tr>
<td>Authorization</td>
<td>Check object-level permissions (prevent BOLA)</td>
<td>Critical</td>
</tr>
<tr>
<td>Authorization</td>
<td>Validate scopes on every request</td>
<td>Critical</td>
</tr>
<tr>
<td>Rate Limiting</td>
<td>Per-IP and per-user rate limits</td>
<td>High</td>
</tr>
<tr>
<td>Rate Limiting</td>
<td>Stricter limits on auth endpoints</td>
<td>High</td>
</tr>
<tr>
<td>Input Validation</td>
<td>Schema validation on all inputs</td>
<td>Critical</td>
</tr>
<tr>
<td>Input Validation</td>
<td>Reject unknown fields</td>
<td>High</td>
</tr>
<tr>
<td>CORS</td>
<td>Specific origin allowlist (no wildcard with credentials)</td>
<td>Critical</td>
</tr>
<tr>
<td>CORS</td>
<td>Vary: Origin header</td>
<td>Medium</td>
</tr>
<tr>
<td>Encryption</td>
<td>TLS everywhere (HTTPS only)</td>
<td>Critical</td>
</tr>
<tr>
<td>Logging</td>
<td>Log all requests with unique request IDs</td>
<td>High</td>
</tr>
<tr>
<td>Versioning</td>
<td>Deprecate old versions with sunset dates</td>
<td>Medium</td>
</tr>
<tr>
<td>Gateway</td>
<td>Centralized auth and rate limiting</td>
<td>Recommended</td>
</tr>
</tbody>
</table>
<h3 id="key-takeaways">Key Takeaways<a class="header-link" href="#key-takeaways" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Defense in depth</strong> â€” apply security at every layer (network, gateway, application, database)</li>
<li><strong>Never trust client input</strong> â€” validate everything, on the server, every time</li>
<li><strong>Use established libraries</strong> â€” do not roll your own authentication or encryption</li>
<li><strong>Monitor and alert</strong> â€” security without monitoring is incomplete</li>
<li><strong>Document your API security</strong> â€” use OpenAPI security schemes for clarity</li>
</ol>
<hr />
<p><strong>Previous</strong>: <a href="./09_Web_Security_Headers.md">09_Web_Security_Headers.md</a> | <strong>Next</strong>: <a href="./11_Secrets_Management.md">11_Secrets_Management.md</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/09_Web_Security_Headers.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Web Security Headers and CSP</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/11_Secrets_Management.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Secrets Management and Environment Configuration</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}