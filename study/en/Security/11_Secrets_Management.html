{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secrets Management and Environment Configuration - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Security/">Security</a>
    <span class="separator">/</span>
    <span class="current">Secrets Management and Environment Configuration</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Secrets Management and Environment Configuration</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/10_API_Security.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">API Security</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/12_Container_Security.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Container and Cloud Security</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#1-secrets-fundamentals">1. Secrets Fundamentals</a><ul>
<li><a href="#11-what-counts-as-a-secret">1.1 What Counts as a Secret?</a></li>
<li><a href="#12-the-secret-lifecycle">1.2 The Secret Lifecycle</a></li>
</ul>
</li>
<li><a href="#2-environment-variables-and-env-files">2. Environment Variables and .env Files</a><ul>
<li><a href="#21-the-12-factor-app-approach">2.1 The 12-Factor App Approach</a></li>
<li><a href="#22-using-python-dotenv">2.2 Using python-dotenv</a></li>
<li><a href="#23-the-env-file">2.3 The .env File</a></li>
<li><a href="#24-gitignore-configuration">2.4 .gitignore Configuration</a></li>
<li><a href="#25-pydantic-settings-type-safe-configuration">2.5 Pydantic Settings (Type-Safe Configuration)</a></li>
</ul>
</li>
<li><a href="#3-secret-rotation-strategies">3. Secret Rotation Strategies</a><ul>
<li><a href="#31-why-rotate-secrets">3.1 Why Rotate Secrets?</a></li>
<li><a href="#32-zero-downtime-rotation-pattern">3.2 Zero-Downtime Rotation Pattern</a></li>
<li><a href="#33-database-password-rotation">3.3 Database Password Rotation</a></li>
</ul>
</li>
<li><a href="#4-hashicorp-vault">4. HashiCorp Vault</a><ul>
<li><a href="#41-vault-architecture">4.1 Vault Architecture</a></li>
<li><a href="#42-vault-quick-start">4.2 Vault Quick Start</a></li>
<li><a href="#43-vault-with-python-hvac">4.3 Vault with Python (hvac)</a></li>
<li><a href="#44-vault-approle-authentication">4.4 Vault AppRole Authentication</a></li>
</ul>
</li>
<li><a href="#5-cloud-secret-managers">5. Cloud Secret Managers</a><ul>
<li><a href="#51-aws-secrets-manager">5.1 AWS Secrets Manager</a></li>
<li><a href="#52-gcp-secret-manager">5.2 GCP Secret Manager</a></li>
</ul>
</li>
<li><a href="#6-git-secrets-scanning">6. Git Secrets Scanning</a><ul>
<li><a href="#61-the-problem">6.1 The Problem</a></li>
<li><a href="#62-pre-commit-hooks">6.2 Pre-Commit Hooks</a></li>
<li><a href="#63-scanning-tools">6.3 Scanning Tools</a></li>
<li><a href="#64-custom-gitleaks-configuration">6.4 Custom gitleaks Configuration</a></li>
<li><a href="#65-removing-secrets-from-git-history">6.5 Removing Secrets from Git History</a></li>
</ul>
</li>
<li><a href="#7-cicd-secrets">7. CI/CD Secrets</a><ul>
<li><a href="#71-github-actions-secrets">7.1 GitHub Actions Secrets</a></li>
<li><a href="#72-gitlab-ci-variables">7.2 GitLab CI Variables</a></li>
</ul>
</li>
<li><a href="#8-encryption-at-rest">8. Encryption at Rest</a><ul>
<li><a href="#81-encrypting-configuration-files">8.1 Encrypting Configuration Files</a></li>
<li><a href="#82-sops-secrets-operations">8.2 SOPS (Secrets OPerationS)</a></li>
</ul>
</li>
<li><a href="#9-common-mistakes">9. Common Mistakes</a><ul>
<li><a href="#91-anti-patterns">9.1 Anti-Patterns</a></li>
<li><a href="#92-secret-detection-checklist">9.2 Secret Detection Checklist</a></li>
</ul>
</li>
<li><a href="#10-exercises">10. Exercises</a><ul>
<li><a href="#exercise-1-environment-configuration-system">Exercise 1: Environment Configuration System</a></li>
<li><a href="#exercise-2-secret-rotation-service">Exercise 2: Secret Rotation Service</a></li>
<li><a href="#exercise-3-git-secret-scanner">Exercise 3: Git Secret Scanner</a></li>
<li><a href="#exercise-4-vault-integration-library">Exercise 4: Vault Integration Library</a></li>
<li><a href="#exercise-5-sops-workflow-automation">Exercise 5: SOPS Workflow Automation</a></li>
<li><a href="#exercise-6-cicd-secrets-audit">Exercise 6: CI/CD Secrets Audit</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a><ul>
<li><a href="#secrets-management-maturity-model">Secrets Management Maturity Model</a></li>
<li><a href="#key-takeaways">Key Takeaways</a></li>
</ul>
</li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="secrets-management-and-environment-configuration">Secrets Management and Environment Configuration<a class="header-link" href="#secrets-management-and-environment-configuration" title="Permanent link">&para;</a></h1>
<p><strong>Previous</strong>: <a href="./10_API_Security.md">10_API_Security.md</a> | <strong>Next</strong>: <a href="./12_Container_Security.md">12_Container_Security.md</a></p>
<hr />
<p>Secrets â€” API keys, database passwords, encryption keys, OAuth client secrets â€” are the crown jewels of any application. A single leaked secret can compromise an entire system. Despite this, secrets management remains one of the most commonly mishandled areas in software development. This lesson covers the full lifecycle of secrets: how to store them, rotate them, inject them at runtime, scan for accidental leaks, and manage them across CI/CD pipelines and cloud environments.</p>
<h2 id="learning-objectives">Learning Objectives<a class="header-link" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<ul>
<li>Understand the 12-factor app approach to configuration and secrets</li>
<li>Use environment variables and .env files safely with python-dotenv</li>
<li>Implement secret rotation strategies without downtime</li>
<li>Configure HashiCorp Vault for centralized secrets management</li>
<li>Use cloud-native secret stores (AWS Secrets Manager, GCP Secret Manager)</li>
<li>Detect leaked secrets in git history using scanning tools</li>
<li>Manage secrets in CI/CD pipelines (GitHub Actions, GitLab CI)</li>
<li>Encrypt configuration at rest</li>
<li>Avoid common mistakes that lead to secret exposure</li>
</ul>
<hr />
<h2 id="1-secrets-fundamentals">1. Secrets Fundamentals<a class="header-link" href="#1-secrets-fundamentals" title="Permanent link">&para;</a></h2>
<h3 id="11-what-counts-as-a-secret">1.1 What Counts as a Secret?<a class="header-link" href="#11-what-counts-as-a-secret" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="n">Types</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Secrets</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Credentials</span><span class="w">                                                </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Database</span><span class="w"> </span><span class="n">passwords</span><span class="w"> </span><span class="p">(</span><span class="n">PostgreSQL</span><span class="p">,</span><span class="w"> </span><span class="n">MySQL</span><span class="p">,</span><span class="w"> </span><span class="n">Redis</span><span class="p">)</span><span class="w">          </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">passwords</span><span class="w">                              </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">SMTP</span><span class="o">/</span><span class="n">email</span><span class="w"> </span><span class="n">credentials</span><span class="w">                                 </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">SSH</span><span class="w"> </span><span class="n">passwords</span><span class="w">                                          </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">API</span><span class="w"> </span><span class="n">Keys</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">Tokens</span><span class="w">                                        </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Third</span><span class="o">-</span><span class="n">party</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="p">(</span><span class="n">Stripe</span><span class="p">,</span><span class="w"> </span><span class="n">Twilio</span><span class="p">,</span><span class="w"> </span><span class="n">AWS</span><span class="p">)</span><span class="w">             </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">OAuth</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="n">secrets</span><span class="w">                                   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">JWT</span><span class="w"> </span><span class="n">signing</span><span class="w"> </span><span class="n">keys</span><span class="w">                                       </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Personal</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">tokens</span><span class="w">                                 </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Cryptographic</span><span class="w"> </span><span class="n">Material</span><span class="w">                                     </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">keys</span><span class="w">                                       </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Encryption</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="p">(</span><span class="n">AES</span><span class="p">,</span><span class="w"> </span><span class="n">RSA</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">keys</span><span class="p">)</span><span class="w">                </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">SSH</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">keys</span><span class="w">                                       </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="n">signing</span><span class="w"> </span><span class="n">keys</span><span class="w">                                      </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Infrastructure</span><span class="w"> </span><span class="n">Secrets</span><span class="w">                                     </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Cloud</span><span class="w"> </span><span class="n">provider</span><span class="w"> </span><span class="n">credentials</span><span class="w"> </span><span class="p">(</span><span class="n">AWS</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">keys</span><span class="p">)</span><span class="w">           </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Container</span><span class="w"> </span><span class="n">registry</span><span class="w"> </span><span class="n">credentials</span><span class="w">                         </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Kubernetes</span><span class="w"> </span><span class="n">secrets</span><span class="w">                                     </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Terraform</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">encryption</span><span class="w"> </span><span class="n">keys</span><span class="w">                        </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Rule</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="nl">thumb:</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">exposing</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">would</span><span class="w"> </span><span class="n">cause</span><span class="w"> </span><span class="n">harm</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">secret</span><span class="p">.</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="12-the-secret-lifecycle">1.2 The Secret Lifecycle<a class="header-link" href="#12-the-secret-lifecycle" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                    </span><span class="nv">Secret</span><span class="w"> </span><span class="nv">Lifecycle</span><span class="w">                                   </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">1</span>.<span class="w"> </span><span class="nv">Generation</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="mi">2</span>.<span class="w"> </span><span class="nv">Storage</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="mi">3</span>.<span class="w"> </span><span class="nv">Distribution</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="mi">4</span>.<span class="w"> </span><span class="nv">Usage</span><span class="w">      </span>â”‚
â”‚<span class="w">       </span>â”‚<span class="w">                </span>â”‚<span class="w">               </span>â”‚<span class="w">                  </span>â”‚<span class="w">          </span>â”‚
â”‚<span class="w">       </span>â”‚<span class="w">                </span>â”‚<span class="w">               </span>â”‚<span class="w">                  </span>â”‚<span class="w">          </span>â”‚
â”‚<span class="w">       </span>â–¼<span class="w">                </span>â–¼<span class="w">               </span>â–¼<span class="w">                  </span>â–¼<span class="w">          </span>â”‚
â”‚<span class="w">  </span><span class="nv">Strong</span><span class="w"> </span><span class="k">random</span><span class="w">     </span><span class="nv">Encrypted</span><span class="w">       </span><span class="nv">Secure</span><span class="w"> </span><span class="nv">channel</span><span class="w">    </span><span class="nv">Minimal</span><span class="w">        </span>â”‚
â”‚<span class="w">  </span><span class="nv">generation</span><span class="w">        </span><span class="nv">at</span><span class="w"> </span><span class="nv">rest</span><span class="w">         </span><span class="ss">(</span><span class="nv">TLS</span>,<span class="w"> </span><span class="nv">IAM</span><span class="ss">)</span><span class="w">       </span><span class="nv">exposure</span><span class="w">       </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">5</span>.<span class="w"> </span><span class="nv">Rotation</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="mi">6</span>.<span class="w"> </span><span class="nv">Revocation</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="mi">7</span>.<span class="w"> </span><span class="nv">Audit</span><span class="w">                        </span>â”‚
â”‚<span class="w">       </span>â”‚<span class="w">                </span>â”‚<span class="w">                </span>â”‚<span class="w">                            </span>â”‚
â”‚<span class="w">       </span>â–¼<span class="w">                </span>â–¼<span class="w">                </span>â–¼<span class="w">                            </span>â”‚
â”‚<span class="w">  </span><span class="nv">Automated</span><span class="w">         </span><span class="nv">Immediate</span><span class="w">        </span><span class="nv">Log</span><span class="w"> </span><span class="nv">access</span><span class="w">                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">periodic</span><span class="w">          </span><span class="nv">on</span><span class="w"> </span><span class="nv">compromise</span><span class="w">    </span><span class="nv">and</span><span class="w"> </span><span class="nv">changes</span><span class="w">                     </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Key</span><span class="w"> </span><span class="nv">principles</span>:<span class="w">                                                     </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Least</span><span class="w"> </span><span class="nv">privilege</span>:<span class="w"> </span><span class="nv">only</span><span class="w"> </span><span class="nv">give</span><span class="w"> </span><span class="nv">access</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">who</span><span class="w"> </span><span class="nv">needs</span><span class="w"> </span><span class="nv">it</span><span class="w">                </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Short</span><span class="o">-</span><span class="nv">lived</span>:<span class="w"> </span><span class="nv">prefer</span><span class="w"> </span><span class="nv">temporary</span><span class="w"> </span><span class="nv">credentials</span><span class="w"> </span><span class="nv">over</span><span class="w"> </span><span class="nv">permanent</span><span class="w"> </span><span class="nv">ones</span><span class="w">    </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Encrypted</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">rest</span>:<span class="w"> </span><span class="nv">never</span><span class="w"> </span><span class="nv">store</span><span class="w"> </span><span class="nv">secrets</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">plaintext</span><span class="w">              </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Auditable</span>:<span class="w"> </span><span class="nv">log</span><span class="w"> </span><span class="nv">who</span><span class="w"> </span><span class="nv">accessed</span><span class="w"> </span><span class="nv">what</span><span class="w"> </span><span class="nv">secret</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">when</span><span class="w">                 </span>â”‚
â”‚<span class="w">  </span>â€¢<span class="w"> </span><span class="nv">Rotatable</span>:<span class="w"> </span><span class="nv">design</span><span class="w"> </span><span class="nv">systems</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">handle</span><span class="w"> </span><span class="nv">secret</span><span class="w"> </span><span class="nv">rotation</span><span class="w">              </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="2-environment-variables-and-env-files">2. Environment Variables and .env Files<a class="header-link" href="#2-environment-variables-and-env-files" title="Permanent link">&para;</a></h2>
<h3 id="21-the-12-factor-app-approach">2.1 The 12-Factor App Approach<a class="header-link" href="#21-the-12-factor-app-approach" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="mi">12</span><span class="o">-</span><span class="n">Factor</span><span class="w"> </span><span class="n">App</span><span class="p">:</span><span class="w"> </span><span class="n">Config</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Factor</span><span class="w"> </span><span class="n">III</span><span class="p">:</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">environment</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Application</span><span class="w">     </span><span class="err">â”‚</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Code</span><span class="w">            </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â†</span><span class="w"> </span><span class="n">Same</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">deploys</span><span class="w"> </span><span class="n">everywhere</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">                                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â–¼</span><span class="w">                                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Development</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Staging</span><span class="w">         </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Production</span><span class="w">      </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">DB</span><span class="o">=</span><span class="n">localhost</span><span class="w">    </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">DB</span><span class="o">=</span><span class="n">staging</span><span class="o">.</span><span class="n">db</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">DB</span><span class="o">=</span><span class="n">prod</span><span class="o">.</span><span class="n">db</span><span class="w">      </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">DEBUG</span><span class="o">=</span><span class="bp">true</span><span class="w">      </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">DEBUG</span><span class="o">=</span><span class="bp">false</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">DEBUG</span><span class="o">=</span><span class="bp">false</span><span class="w">     </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">KEY</span><span class="o">=</span><span class="n">dev_key</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">KEY</span><span class="o">=</span><span class="n">stage_key</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">KEY</span><span class="o">=</span><span class="n">prod_key</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Config</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">varies</span><span class="w"> </span><span class="n">between</span><span class="w"> </span><span class="n">deploys</span><span class="p">:</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">âœ“</span><span class="w"> </span><span class="n">Database</span><span class="w"> </span><span class="n">URLs</span><span class="p">,</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">keys</span><span class="p">,</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="n">flags</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Config</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">NOT</span><span class="w"> </span><span class="n">vary</span><span class="p">:</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">âœ—</span><span class="w"> </span><span class="n">Framework</span><span class="w"> </span><span class="n">settings</span><span class="p">,</span><span class="w"> </span><span class="n">logging</span><span class="w"> </span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="n">routes</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="n">These</span><span class="w"> </span><span class="n">belong</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">code</span><span class="o">/</span><span class="n">config</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">environment</span><span class="p">)</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="22-using-python-dotenv">2.2 Using python-dotenv<a class="header-link" href="#22-using-python-dotenv" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Loading configuration from .env files with python-dotenv.</span>
<span class="sd">pip install python-dotenv</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="c1"># â”€â”€ Basic usage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Load .env file from the current directory</span>
<span class="n">load_dotenv</span><span class="p">()</span>

<span class="c1"># Access environment variables</span>
<span class="n">database_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DATABASE_URL&#39;</span><span class="p">)</span>
<span class="n">secret_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">)</span>
<span class="n">debug</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>

<span class="c1"># â”€â”€ Load from specific path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">env_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;.env.production&#39;</span>
<span class="n">load_dotenv</span><span class="p">(</span><span class="n">dotenv_path</span><span class="o">=</span><span class="n">env_path</span><span class="p">)</span>

<span class="c1"># â”€â”€ Override existing environment variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># By default, dotenv does NOT override existing env vars</span>
<span class="c1"># This is safe: system env vars take precedence</span>
<span class="n">load_dotenv</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Default behavior</span>

<span class="c1"># To force override (rarely needed):</span>
<span class="n">load_dotenv</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># â”€â”€ Structured configuration class â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AppConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Application configuration loaded from environment.&quot;&quot;&quot;</span>

    <span class="c1"># Database</span>
    <span class="n">database_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">database_pool_size</span><span class="p">:</span> <span class="nb">int</span>

    <span class="c1"># Security</span>
    <span class="n">secret_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">jwt_secret</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">jwt_expiry_minutes</span><span class="p">:</span> <span class="nb">int</span>

    <span class="c1"># External services</span>
    <span class="n">stripe_api_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">sendgrid_api_key</span><span class="p">:</span> <span class="nb">str</span>

    <span class="c1"># Application</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_env</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;AppConfig&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load configuration from environment variables.&quot;&quot;&quot;</span>
        <span class="n">load_dotenv</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">require_env</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Get a required environment variable or raise error.&quot;&quot;&quot;</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Required environment variable &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; is not set. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Check your .env file or environment configuration.&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">database_url</span><span class="o">=</span><span class="n">require_env</span><span class="p">(</span><span class="s1">&#39;DATABASE_URL&#39;</span><span class="p">),</span>
            <span class="n">database_pool_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DATABASE_POOL_SIZE&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">)),</span>
            <span class="n">secret_key</span><span class="o">=</span><span class="n">require_env</span><span class="p">(</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">),</span>
            <span class="n">jwt_secret</span><span class="o">=</span><span class="n">require_env</span><span class="p">(</span><span class="s1">&#39;JWT_SECRET&#39;</span><span class="p">),</span>
            <span class="n">jwt_expiry_minutes</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;JWT_EXPIRY_MINUTES&#39;</span><span class="p">,</span> <span class="s1">&#39;15&#39;</span><span class="p">)),</span>
            <span class="n">stripe_api_key</span><span class="o">=</span><span class="n">require_env</span><span class="p">(</span><span class="s1">&#39;STRIPE_API_KEY&#39;</span><span class="p">),</span>
            <span class="n">sendgrid_api_key</span><span class="o">=</span><span class="n">require_env</span><span class="p">(</span><span class="s1">&#39;SENDGRID_API_KEY&#39;</span><span class="p">),</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
            <span class="n">log_level</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;LOG_LEVEL&#39;</span><span class="p">,</span> <span class="s1">&#39;INFO&#39;</span><span class="p">),</span>
        <span class="p">)</span>


<span class="c1"># â”€â”€ Usage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">AppConfig</span><span class="o">.</span><span class="n">from_env</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Debug mode: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">debug</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">database_url</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>  <span class="c1"># Don&#39;t log full URL</span>
</code></pre></div>

<h3 id="23-the-env-file">2.3 The .env File<a class="header-link" href="#23-the-env-file" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ .env file (NEVER commit this to git) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>

<span class="c1"># Database</span>
<span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://user:password@localhost:5432/mydb
<span class="nv">DATABASE_POOL_SIZE</span><span class="o">=</span><span class="m">5</span>

<span class="c1"># Security</span>
<span class="nv">SECRET_KEY</span><span class="o">=</span>your-256-bit-secret-key-here-change-me
<span class="nv">JWT_SECRET</span><span class="o">=</span>another-different-secret-key-for-jwt

<span class="c1"># External APIs</span>
<span class="nv">STRIPE_API_KEY</span><span class="o">=</span>sk_test_EXAMPLE_KEY_REPLACE_ME
<span class="nv">SENDGRID_API_KEY</span><span class="o">=</span>SG.xxxxxxxxxxxxx

<span class="c1"># Application</span>
<span class="nv">DEBUG</span><span class="o">=</span><span class="nb">false</span>
<span class="nv">LOG_LEVEL</span><span class="o">=</span>INFO
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ .env.example file (DO commit this to git) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Copy this file to .env and fill in the values</span>
<span class="c1"># cp .env.example .env</span>

<span class="c1"># Database</span>
<span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://user:password@localhost:5432/mydb
<span class="nv">DATABASE_POOL_SIZE</span><span class="o">=</span><span class="m">5</span>

<span class="c1"># Security (generate with: python -c &quot;import secrets; print(secrets.token_hex(32))&quot;)</span>
<span class="nv">SECRET_KEY</span><span class="o">=</span>change-me-generate-a-real-secret
<span class="nv">JWT_SECRET</span><span class="o">=</span>change-me-use-a-different-secret

<span class="c1"># External APIs</span>
<span class="nv">STRIPE_API_KEY</span><span class="o">=</span>sk_test_your_test_key_here
<span class="nv">SENDGRID_API_KEY</span><span class="o">=</span>SG.your_api_key_here

<span class="c1"># Application</span>
<span class="nv">DEBUG</span><span class="o">=</span><span class="nb">true</span>
<span class="nv">LOG_LEVEL</span><span class="o">=</span>DEBUG
</code></pre></div>

<h3 id="24-gitignore-configuration">2.4 .gitignore Configuration<a class="header-link" href="#24-gitignore-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Secrets and environment files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="na">.env</span>
<span class="na">.env.local</span>
<span class="na">.env.production</span>
<span class="na">.env.staging</span>
<span class="na">.env.</span><span class="p">*.</span><span class="no">local</span>

<span class="c1"># Keep the example file</span>
<span class="err">!</span><span class="na">.env.example</span>
<span class="err">!</span><span class="na">.env.template</span>

<span class="c1"># Private keys</span>
<span class="err">*</span><span class="na">.pem</span>
<span class="err">*</span><span class="na">.key</span>
<span class="err">*</span><span class="na">.p12</span>
<span class="err">*</span><span class="na">.pfx</span>

<span class="c1"># Cloud credentials</span>
<span class="nf">credentials.json</span>
<span class="nf">service-account</span><span class="p">*.</span><span class="no">json</span>
<span class="na">.gcloud</span><span class="err">/</span>
<span class="na">.aws</span><span class="err">/</span><span class="no">credentials</span>

<span class="c1"># IDE secrets</span>
<span class="na">.idea</span><span class="err">/</span><span class="no">dataSources</span><span class="err">/</span>
<span class="na">.vscode</span><span class="err">/</span><span class="no">settings.json</span>
</code></pre></div>

<h3 id="25-pydantic-settings-type-safe-configuration">2.5 Pydantic Settings (Type-Safe Configuration)<a class="header-link" href="#25-pydantic-settings-type-safe-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Type-safe configuration with Pydantic Settings.</span>
<span class="sd">pip install pydantic-settings</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic_settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseSettings</span><span class="p">,</span> <span class="n">SettingsConfigDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">Field</span><span class="p">,</span> <span class="n">SecretStr</span><span class="p">,</span> <span class="n">PostgresDsn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Application settings with validation and type coercion.&quot;&quot;&quot;</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">SettingsConfigDict</span><span class="p">(</span>
        <span class="n">env_file</span><span class="o">=</span><span class="s1">&#39;.env&#39;</span><span class="p">,</span>
        <span class="n">env_file_encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span>
        <span class="n">case_sensitive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="c1"># Prefix all env vars with APP_ to avoid collisions</span>
        <span class="n">env_prefix</span><span class="o">=</span><span class="s1">&#39;APP_&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Database</span>
    <span class="n">database_url</span><span class="p">:</span> <span class="n">PostgresDsn</span>
    <span class="n">database_pool_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="c1"># Security â€” SecretStr hides values in logs and repr</span>
    <span class="n">secret_key</span><span class="p">:</span> <span class="n">SecretStr</span>
    <span class="n">jwt_secret</span><span class="p">:</span> <span class="n">SecretStr</span>
    <span class="n">jwt_expiry_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">1440</span><span class="p">)</span>

    <span class="c1"># External APIs</span>
    <span class="n">stripe_api_key</span><span class="p">:</span> <span class="n">SecretStr</span>
    <span class="n">sendgrid_api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SecretStr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Application</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^(DEBUG|INFO|WARNING|ERROR|CRITICAL)$&#39;</span><span class="p">)</span>

    <span class="c1"># Server</span>
    <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;0.0.0.0&quot;</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">65535</span><span class="p">)</span>


<span class="c1"># â”€â”€ Usage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>

<span class="c1"># SecretStr prevents accidental logging</span>
<span class="nb">print</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">secret_key</span><span class="p">)</span>
<span class="c1"># Output: SecretStr(&#39;**********&#39;)</span>

<span class="c1"># Access the actual value when needed</span>
<span class="n">actual_key</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">secret_key</span><span class="o">.</span><span class="n">get_secret_value</span><span class="p">()</span>

<span class="c1"># Safe to print non-secret settings</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Debug: </span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">debug</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Port: </span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># This will NOT reveal secret values</span>
<span class="nb">print</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
<span class="c1"># {&#39;database_url&#39;: ..., &#39;secret_key&#39;: SecretStr(&#39;**********&#39;), ...}</span>
</code></pre></div>

<hr />
<h2 id="3-secret-rotation-strategies">3. Secret Rotation Strategies<a class="header-link" href="#3-secret-rotation-strategies" title="Permanent link">&para;</a></h2>
<h3 id="31-why-rotate-secrets">3.1 Why Rotate Secrets?<a class="header-link" href="#31-why-rotate-secrets" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                    </span><span class="nv">Secret</span><span class="w"> </span><span class="nv">Rotation</span><span class="w"> </span><span class="nv">Reasons</span><span class="w">                            </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">1</span>.<span class="w"> </span><span class="nv">Limit</span><span class="w"> </span><span class="nv">blast</span><span class="w"> </span><span class="nv">radius</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">compromise</span><span class="w">                                 </span>â”‚
â”‚<span class="w">     </span><span class="nv">Old</span><span class="w"> </span><span class="nv">secret</span><span class="w"> </span><span class="nv">compromised</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="nv">Only</span><span class="w"> </span><span class="nv">valid</span><span class="w"> </span><span class="k">until</span><span class="w"> </span><span class="k">next</span><span class="w"> </span><span class="nv">rotation</span><span class="w">        </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">2</span>.<span class="w"> </span><span class="nv">Compliance</span><span class="w"> </span><span class="nv">requirements</span><span class="w">                                          </span>â”‚
â”‚<span class="w">     </span><span class="nv">PCI</span><span class="w"> </span><span class="nv">DSS</span>,<span class="w"> </span><span class="nv">SOC</span><span class="w"> </span><span class="mi">2</span>,<span class="w"> </span><span class="nv">HIPAA</span><span class="w"> </span><span class="nv">require</span><span class="w"> </span><span class="nv">periodic</span><span class="w"> </span><span class="nv">rotation</span><span class="w">                  </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">3</span>.<span class="w"> </span><span class="nv">Personnel</span><span class="w"> </span><span class="nv">changes</span><span class="w">                                                </span>â”‚
â”‚<span class="w">     </span><span class="nv">Employee</span><span class="w"> </span><span class="nv">leaves</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="nv">Rotate</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">secrets</span><span class="w"> </span><span class="nv">they</span><span class="w"> </span><span class="nv">had</span><span class="w"> </span><span class="nv">access</span><span class="w"> </span><span class="nv">to</span><span class="w">        </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="mi">4</span>.<span class="w"> </span><span class="nv">Reduce</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">stolen</span><span class="w"> </span><span class="nv">secrets</span><span class="w">                                   </span>â”‚
â”‚<span class="w">     </span><span class="nv">Short</span><span class="o">-</span><span class="nv">lived</span><span class="w"> </span><span class="nv">secrets</span><span class="w"> </span><span class="nv">are</span><span class="w"> </span><span class="nv">less</span><span class="w"> </span><span class="nv">useful</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">attackers</span><span class="w">                  </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Rotation</span><span class="w"> </span><span class="nv">frequency</span><span class="w"> </span><span class="nv">recommendations</span>:<span class="w">                                 </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">API</span><span class="w"> </span><span class="nv">keys</span>:<span class="w">         </span><span class="nv">Every</span><span class="w"> </span><span class="mi">90</span><span class="w"> </span><span class="nv">days</span><span class="w">                                </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Database</span><span class="w"> </span><span class="nv">passwords</span>:<span class="w"> </span><span class="nv">Every</span><span class="w"> </span><span class="mi">30</span><span class="o">-</span><span class="mi">90</span><span class="w"> </span><span class="nv">days</span><span class="w">                           </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">TLS</span><span class="w"> </span><span class="nv">certificates</span>:<span class="w">  </span><span class="nv">Before</span><span class="w"> </span><span class="nv">expiry</span><span class="w"> </span><span class="ss">(</span><span class="nv">automated</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">ACME</span><span class="o">/</span><span class="nv">Let</span><span class="err">&#39;s Encrypt) â”‚</span>
<span class="err">â”‚  â”œâ”€â”€ JWT signing keys:  Every 30 days                               â”‚</span>
<span class="err">â”‚  â””â”€â”€ Encryption keys:   Every 365 days (with re-encryption plan)    â”‚</span>
<span class="err">â”‚                                                                      â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="32-zero-downtime-rotation-pattern">3.2 Zero-Downtime Rotation Pattern<a class="header-link" href="#32-zero-downtime-rotation-pattern" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">               </span><span class="nv">Zero</span><span class="o">-</span><span class="nv">Downtime</span><span class="w"> </span><span class="nv">Secret</span><span class="w"> </span><span class="nv">Rotation</span><span class="w">                          </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Step</span><span class="w"> </span><span class="mi">1</span>:<span class="w"> </span><span class="nv">Generate</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">secret</span><span class="w"> </span><span class="ss">(</span><span class="nv">keep</span><span class="w"> </span><span class="nv">old</span><span class="w"> </span><span class="nv">one</span><span class="w"> </span><span class="nv">active</span><span class="ss">)</span><span class="w">                   </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">                                                       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">Secret</span><span class="w"> </span><span class="nv">A</span><span class="w"> </span>â”‚<span class="w"> </span>â†<span class="w"> </span><span class="nv">current</span><span class="w"> </span><span class="ss">(</span><span class="nv">active</span><span class="ss">)</span><span class="w">                                    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">Secret</span><span class="w"> </span><span class="nv">B</span><span class="w"> </span>â”‚<span class="w"> </span>â†<span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="ss">(</span><span class="nv">active</span><span class="ss">)</span><span class="w">                                        </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">                                                       </span>â”‚
â”‚<span class="w">  </span><span class="nv">Both</span><span class="w"> </span><span class="nv">secrets</span><span class="w"> </span><span class="nv">are</span><span class="w"> </span><span class="nv">valid</span><span class="w"> </span><span class="nv">simultaneously</span><span class="w">                               </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Step</span><span class="w"> </span><span class="mi">2</span>:<span class="w"> </span><span class="nv">Update</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">consumers</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">use</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">secret</span><span class="w">                      </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">                                                       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">Secret</span><span class="w"> </span><span class="nv">A</span><span class="w"> </span>â”‚<span class="w"> </span>â†<span class="w"> </span><span class="nv">old</span><span class="w"> </span><span class="ss">(</span><span class="nv">still</span><span class="w"> </span><span class="nv">active</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">grace</span><span class="w"> </span><span class="nv">period</span><span class="ss">)</span><span class="w">                 </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">Secret</span><span class="w"> </span><span class="nv">B</span><span class="w"> </span>â”‚<span class="w"> </span>â†<span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">services</span><span class="w"> </span><span class="nv">now</span><span class="w"> </span><span class="nv">using</span><span class="w"> </span><span class="nv">this</span><span class="w">                         </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">                                                       </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Step</span><span class="w"> </span><span class="mi">3</span>:<span class="w"> </span><span class="nv">Revoke</span><span class="w"> </span><span class="nv">old</span><span class="w"> </span><span class="nv">secret</span><span class="w"> </span><span class="nv">after</span><span class="w"> </span><span class="nv">grace</span><span class="w"> </span><span class="nv">period</span><span class="w">                        </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">                                                       </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">Secret</span><span class="w"> </span><span class="nv">A</span><span class="w"> </span>â”‚<span class="w"> </span>â†<span class="w"> </span><span class="nv">revoked</span><span class="w">                                             </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w"> </span><span class="nv">Secret</span><span class="w"> </span><span class="nv">B</span><span class="w"> </span>â”‚<span class="w"> </span>â†<span class="w"> </span><span class="nv">sole</span><span class="w"> </span><span class="nv">active</span><span class="w"> </span><span class="nv">secret</span><span class="w">                                  </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">                                                       </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">This</span><span class="w"> </span><span class="nv">dual</span><span class="o">-</span><span class="nv">secret</span><span class="w"> </span><span class="nv">window</span><span class="w"> </span><span class="nv">prevents</span><span class="w"> </span><span class="nv">downtime</span><span class="w"> </span><span class="nv">during</span><span class="w"> </span><span class="nv">rotation</span>.<span class="w">          </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Implementing zero-downtime secret rotation for JWT signing keys.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SigningKey</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A JWT signing key with metadata.&quot;&quot;&quot;</span>
    <span class="n">key_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">secret</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">expires_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">revoked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span><span class="w"> </span><span class="nc">KeyRotationManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages JWT signing key rotation with zero downtime.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rotation_interval_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                 <span class="n">grace_period_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_interval</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">rotation_interval_days</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grace_period</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">grace_period_days</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">SigningKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_new_key</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_new_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SigningKey</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a new signing key.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">SigningKey</span><span class="p">(</span>
            <span class="n">key_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;key_</span><span class="si">{</span><span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">secret</span><span class="o">=</span><span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
            <span class="n">expires_at</span><span class="o">=</span><span class="n">now</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_interval</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grace_period</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SigningKey</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current (newest) non-revoked signing key.&quot;&quot;&quot;</span>
        <span class="n">active_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">revoked</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">active_keys</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_new_key</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">active_keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Most recently created</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">valid_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SigningKey</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all valid (non-revoked, non-expired) keys.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">revoked</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">expires_at</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SigningKey</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rotate to a new signing key.&quot;&quot;&quot;</span>
        <span class="c1"># Generate new key</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_new_key</span><span class="p">()</span>

        <span class="c1"># Old keys remain valid until they expire (grace period)</span>
        <span class="c1"># This allows existing tokens signed with old key to remain valid</span>

        <span class="c1"># Clean up expired and revoked keys</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">revoked</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">expires_at</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">new_key</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sign_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sign a JWT with the current key.&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_key</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;kid&quot;</span><span class="p">:</span> <span class="n">key</span><span class="o">.</span><span class="n">key_id</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;HS256&quot;</span><span class="p">,</span>
                         <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">verify_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify a JWT, trying all valid keys.&quot;&quot;&quot;</span>
        <span class="c1"># First, try to get kid from header</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">unverified_header</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">get_unverified_header</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">kid</span> <span class="o">=</span> <span class="n">unverified_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kid&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">DecodeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid token format&quot;</span><span class="p">)</span>

        <span class="c1"># If kid is present, find the specific key</span>
        <span class="k">if</span> <span class="n">kid</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">key_id</span> <span class="o">==</span> <span class="n">kid</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span>
                                     <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown key ID: </span><span class="si">{</span><span class="n">kid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Fallback: try all valid keys (for tokens without kid)</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_keys</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span>
                                 <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidSignatureError</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key </span><span class="si">{</span><span class="n">key</span><span class="o">.</span><span class="n">key_id</span><span class="si">}</span><span class="s2">: signature mismatch&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token verification failed with all keys&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">should_rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the current key should be rotated.&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_key</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">-</span> <span class="n">key</span><span class="o">.</span><span class="n">created_at</span>
        <span class="k">return</span> <span class="n">age</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_interval</span>


<span class="c1"># â”€â”€ Usage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">KeyRotationManager</span><span class="p">(</span>
    <span class="n">rotation_interval_days</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">grace_period_days</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Sign a token</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">sign_token</span><span class="p">({</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="s2">&quot;user_123&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">})</span>

<span class="c1"># Later, verify the token (works even after rotation)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<span class="c1"># Periodic rotation (call from a scheduled task)</span>
<span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">should_rotate</span><span class="p">():</span>
    <span class="n">new_key</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">rotate</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rotated to new key: </span><span class="si">{</span><span class="n">new_key</span><span class="o">.</span><span class="n">key_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="33-database-password-rotation">3.3 Database Password Rotation<a class="header-link" href="#33-database-password-rotation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Database password rotation strategy.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">psycopg2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;secret_rotation&#39;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DatabasePasswordRotator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rotate database passwords with zero downtime.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">admin_conn_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">admin_conn_string</span> <span class="o">=</span> <span class="n">admin_conn_string</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rotate_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rotate the password for a database user.</span>

<span class="sd">        Strategy:</span>
<span class="sd">        1. Generate new password</span>
<span class="sd">        2. Update password in database</span>
<span class="sd">        3. Update application config</span>
<span class="sd">        4. Verify connectivity with new password</span>
<span class="sd">        5. If verification fails, roll back</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_password</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">admin_conn_string</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">autocommit</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
                <span class="c1"># Step 1: Change password</span>
                <span class="c1"># Use format() carefully â€” this is a DDL command</span>
                <span class="c1"># that cannot use parameterized queries</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ALTER USER </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2"> WITH PASSWORD %s&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">new_password</span><span class="p">,)</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Password rotated for user: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Step 2: Verify the new password works</span>
            <span class="n">test_conn_string</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;postgresql://</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">new_password</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;@localhost:5432/mydb&quot;</span>
            <span class="p">)</span>
            <span class="n">test_conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">test_conn_string</span><span class="p">)</span>
            <span class="n">test_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New password verified for user: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">new_password</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Password rotation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="c1"># â”€â”€ Automated rotation with scheduler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># Using APScheduler</span>
<span class="sd">from apscheduler.schedulers.blocking import BlockingScheduler</span>

<span class="sd">scheduler = BlockingScheduler()</span>

<span class="sd">@scheduler.scheduled_job(&#39;cron&#39;, day=&#39;1&#39;, hour=&#39;3&#39;)  # 1st of each month, 3 AM</span>
<span class="sd">def rotate_db_passwords():</span>
<span class="sd">    rotator = DatabasePasswordRotator(admin_conn_string=ADMIN_DB_URL)</span>
<span class="sd">    new_password = rotator.rotate_password(&#39;app_user&#39;)</span>

<span class="sd">    # Update secret store (Vault, AWS Secrets Manager, etc.)</span>
<span class="sd">    update_secret_store(&#39;db_password&#39;, new_password)</span>

<span class="sd">    # Notify application to reload config</span>
<span class="sd">    notify_config_reload()</span>

<span class="sd">scheduler.start()</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>

<hr />
<h2 id="4-hashicorp-vault">4. HashiCorp Vault<a class="header-link" href="#4-hashicorp-vault" title="Permanent link">&para;</a></h2>
<h3 id="41-vault-architecture">4.1 Vault Architecture<a class="header-link" href="#41-vault-architecture" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HashiCorp Vault Architecture                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                     â”‚   Vault Server   â”‚                             â”‚
â”‚                     â”‚                  â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Client   â”‚â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”‚  Auth      â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”‚  Backend â”‚        â”‚
â”‚  â”‚  (App)    â”‚      â”‚  â”‚  Methods   â”‚  â”‚       â”‚  Storage â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚       â”‚  (Consul,â”‚        â”‚
â”‚                     â”‚  â”‚  Token     â”‚  â”‚       â”‚   Raft,  â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚  AppRole   â”‚  â”‚       â”‚   File)  â”‚        â”‚
â”‚  â”‚  Client   â”‚â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”‚  LDAP      â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”‚  (CI/CD)  â”‚      â”‚  â”‚  K8s       â”‚  â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚  AWS IAM   â”‚  â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚  Audit   â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”‚  Log     â”‚        â”‚
â”‚  â”‚  Client   â”‚â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”‚  (Admin)  â”‚      â”‚  â”‚  Secret    â”‚  â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚  Engines   â”‚  â”‚                           â”‚
â”‚                     â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚                           â”‚
â”‚                     â”‚  â”‚  KV v2     â”‚  â”‚  (static key-value)       â”‚
â”‚                     â”‚  â”‚  Database  â”‚  â”‚  (dynamic credentials)    â”‚
â”‚                     â”‚  â”‚  PKI       â”‚  â”‚  (certificate authority)  â”‚
â”‚                     â”‚  â”‚  Transit   â”‚  â”‚  (encryption as service)  â”‚
â”‚                     â”‚  â”‚  AWS       â”‚  â”‚  (dynamic IAM creds)      â”‚
â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                           â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                                                      â”‚
â”‚  Key features:                                                       â”‚
â”‚  â€¢ Dynamic secrets: generate credentials on-demand                   â”‚
â”‚  â€¢ Leasing: secrets have TTL, auto-expire                           â”‚
â”‚  â€¢ Revocation: revoke any secret or tree of secrets instantly       â”‚
â”‚  â€¢ Encryption as a service: encrypt/decrypt without seeing keys     â”‚
â”‚  â€¢ Audit logging: every access is logged                            â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="42-vault-quick-start">4.2 Vault Quick Start<a class="header-link" href="#42-vault-quick-start" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Install Vault â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># macOS</span>
brew<span class="w"> </span>install<span class="w"> </span>vault

<span class="c1"># Linux</span>
wget<span class="w"> </span>https://releases.hashicorp.com/vault/1.15.0/vault_1.15.0_linux_amd64.zip
unzip<span class="w"> </span>vault_1.15.0_linux_amd64.zip
sudo<span class="w"> </span>mv<span class="w"> </span>vault<span class="w"> </span>/usr/local/bin/

<span class="c1"># â”€â”€ Start development server (NOT for production) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
vault<span class="w"> </span>server<span class="w"> </span>-dev
<span class="c1"># Root token will be printed â€” save it</span>
<span class="c1"># export VAULT_ADDR=&#39;http://127.0.0.1:8200&#39;</span>
<span class="c1"># export VAULT_TOKEN=&#39;hvs.xxxxxxxxxxxxx&#39;</span>

<span class="c1"># â”€â”€ Enable KV secrets engine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
vault<span class="w"> </span>secrets<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>-path<span class="o">=</span>secret<span class="w"> </span>kv-v2

<span class="c1"># â”€â”€ Store a secret â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
vault<span class="w"> </span>kv<span class="w"> </span>put<span class="w"> </span>secret/myapp/database<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nv">username</span><span class="o">=</span><span class="s2">&quot;dbuser&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nv">password</span><span class="o">=</span><span class="s2">&quot;supersecretpassword&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;db.example.com&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nv">port</span><span class="o">=</span><span class="s2">&quot;5432&quot;</span>

<span class="c1"># â”€â”€ Read a secret â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
vault<span class="w"> </span>kv<span class="w"> </span>get<span class="w"> </span>secret/myapp/database
vault<span class="w"> </span>kv<span class="w"> </span>get<span class="w"> </span>-format<span class="o">=</span>json<span class="w"> </span>secret/myapp/database

<span class="c1"># â”€â”€ Read specific field â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
vault<span class="w"> </span>kv<span class="w"> </span>get<span class="w"> </span>-field<span class="o">=</span>password<span class="w"> </span>secret/myapp/database

<span class="c1"># â”€â”€ List secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
vault<span class="w"> </span>kv<span class="w"> </span>list<span class="w"> </span>secret/myapp/

<span class="c1"># â”€â”€ Delete a secret â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
vault<span class="w"> </span>kv<span class="w"> </span>delete<span class="w"> </span>secret/myapp/database

<span class="c1"># â”€â”€ Version history (KV v2) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
vault<span class="w"> </span>kv<span class="w"> </span>get<span class="w"> </span>-version<span class="o">=</span><span class="m">1</span><span class="w"> </span>secret/myapp/database
</code></pre></div>

<h3 id="43-vault-with-python-hvac">4.3 Vault with Python (hvac)<a class="header-link" href="#43-vault-with-python-hvac" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">HashiCorp Vault client for Python.</span>
<span class="sd">pip install hvac</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hvac</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>


<span class="k">class</span><span class="w"> </span><span class="nc">VaultClient</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper for HashiCorp Vault operations.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">hvac</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;VAULT_ADDR&#39;</span><span class="p">,</span> <span class="s1">&#39;http://127.0.0.1:8200&#39;</span><span class="p">),</span>
            <span class="n">token</span><span class="o">=</span><span class="n">token</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;VAULT_TOKEN&#39;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Vault authentication failed&quot;</span><span class="p">)</span>

    <span class="c1"># â”€â”€ KV Secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mount_point</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;secret&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read a secret from KV v2.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">secrets</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">read_secret_version</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">mount_point</span><span class="o">=</span><span class="n">mount_point</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                   <span class="n">mount_point</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;secret&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write a secret to KV v2.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">secrets</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">create_or_update_secret</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">secret</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">mount_point</span><span class="o">=</span><span class="n">mount_point</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">mount_point</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;secret&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a secret.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">secrets</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">delete_metadata_and_all_versions</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">mount_point</span><span class="o">=</span><span class="n">mount_point</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># â”€â”€ Dynamic Database Credentials â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_database_creds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get dynamic database credentials.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">secrets</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">generate_credentials</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
            <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">],</span>
            <span class="s1">&#39;lease_id&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;lease_id&#39;</span><span class="p">],</span>
            <span class="s1">&#39;lease_duration&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;lease_duration&#39;</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">revoke_lease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lease_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Revoke a dynamic secret lease.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">revoke_lease</span><span class="p">(</span><span class="n">lease_id</span><span class="p">)</span>

    <span class="c1"># â”€â”€ Transit Encryption â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Encrypt data using Vault Transit engine.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
        <span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">plaintext</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">secrets</span><span class="o">.</span><span class="n">transit</span><span class="o">.</span><span class="n">encrypt_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">key_name</span><span class="p">,</span>
            <span class="n">plaintext</span><span class="o">=</span><span class="n">b64</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;ciphertext&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decrypt data using Vault Transit engine.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">secrets</span><span class="o">.</span><span class="n">transit</span><span class="o">.</span><span class="n">decrypt_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">key_name</span><span class="p">,</span>
            <span class="n">ciphertext</span><span class="o">=</span><span class="n">ciphertext</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;plaintext&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>


<span class="c1"># â”€â”€ Usage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">vault</span> <span class="o">=</span> <span class="n">VaultClient</span><span class="p">()</span>

<span class="c1"># Store a secret</span>
<span class="n">vault</span><span class="o">.</span><span class="n">set_secret</span><span class="p">(</span><span class="s1">&#39;myapp/database&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;dbuser&#39;</span><span class="p">,</span>
    <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;supersecret&#39;</span><span class="p">,</span>
    <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;db.example.com&#39;</span><span class="p">,</span>
<span class="p">})</span>

<span class="c1"># Read a secret</span>
<span class="n">db_config</span> <span class="o">=</span> <span class="n">vault</span><span class="o">.</span><span class="n">get_secret</span><span class="p">(</span><span class="s1">&#39;myapp/database&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connecting to </span><span class="si">{</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Get dynamic database credentials (auto-expire)</span>
<span class="n">creds</span> <span class="o">=</span> <span class="n">vault</span><span class="o">.</span><span class="n">get_database_creds</span><span class="p">(</span><span class="s1">&#39;readonly&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temporary user: </span><span class="si">{</span><span class="n">creds</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expires in: </span><span class="si">{</span><span class="n">creds</span><span class="p">[</span><span class="s1">&#39;lease_duration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

<span class="c1"># Encrypt sensitive data</span>
<span class="n">ciphertext</span> <span class="o">=</span> <span class="n">vault</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="s1">&#39;my-key&#39;</span><span class="p">,</span> <span class="s1">&#39;Social Security: 123-45-6789&#39;</span><span class="p">)</span>
<span class="c1"># ciphertext: vault:v1:8SDd3WHDOjf7mq69CyCqYjBXAiQQAVZRkFM13ok481zVCKqkLQ==</span>

<span class="c1"># Decrypt</span>
<span class="n">plaintext</span> <span class="o">=</span> <span class="n">vault</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="s1">&#39;my-key&#39;</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">)</span>
<span class="c1"># plaintext: Social Security: 123-45-6789</span>
</code></pre></div>

<h3 id="44-vault-approle-authentication">4.4 Vault AppRole Authentication<a class="header-link" href="#44-vault-approle-authentication" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Vault AppRole authentication for applications (not humans).</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hvac</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>


<span class="k">def</span><span class="w"> </span><span class="nf">authenticate_with_approle</span><span class="p">(</span><span class="n">vault_addr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">role_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="n">secret_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">hvac</span><span class="o">.</span><span class="n">Client</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Authenticate to Vault using AppRole method.</span>

<span class="sd">    AppRole is designed for machine-to-machine authentication.</span>
<span class="sd">    role_id = like a username (stable, configured in Vault)</span>
<span class="sd">    secret_id = like a password (rotatable, short-lived)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">hvac</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">vault_addr</span><span class="p">)</span>

    <span class="c1"># Login with AppRole</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">approle</span><span class="o">.</span><span class="n">login</span><span class="p">(</span>
        <span class="n">role_id</span><span class="o">=</span><span class="n">role_id</span><span class="p">,</span>
        <span class="n">secret_id</span><span class="o">=</span><span class="n">secret_id</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Client is now authenticated</span>
    <span class="n">client</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;client_token&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authenticated. Token TTL: </span><span class="si">{</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;lease_duration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">client</span>


<span class="c1"># â”€â”€ In production, secret_id is injected by the orchestrator â”€â”€â”€â”€</span>
<span class="c1"># Kubernetes: mounted as a file</span>
<span class="c1"># Docker: passed as environment variable</span>
<span class="c1"># CI/CD: stored in pipeline secrets</span>

<span class="n">vault</span> <span class="o">=</span> <span class="n">authenticate_with_approle</span><span class="p">(</span>
    <span class="n">vault_addr</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;VAULT_ADDR&#39;</span><span class="p">),</span>
    <span class="n">role_id</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;VAULT_ROLE_ID&#39;</span><span class="p">),</span>
    <span class="n">secret_id</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;VAULT_SECRET_ID&#39;</span><span class="p">),</span>  <span class="c1"># Short-lived</span>
<span class="p">)</span>

<span class="c1"># Now use vault to fetch application secrets</span>
<span class="n">secrets</span> <span class="o">=</span> <span class="n">vault</span><span class="o">.</span><span class="n">secrets</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">read_secret_version</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;myapp/config&#39;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="5-cloud-secret-managers">5. Cloud Secret Managers<a class="header-link" href="#5-cloud-secret-managers" title="Permanent link">&para;</a></h2>
<h3 id="51-aws-secrets-manager">5.1 AWS Secrets Manager<a class="header-link" href="#51-aws-secrets-manager" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">AWS Secrets Manager client.</span>
<span class="sd">pip install boto3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">botocore.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClientError</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AWSSecretsManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface to AWS Secrets Manager.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;us-east-1&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
            <span class="s1">&#39;secretsmanager&#39;</span><span class="p">,</span>
            <span class="n">region_name</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a secret value.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_secret_value</span><span class="p">(</span>
                <span class="n">SecretId</span><span class="o">=</span><span class="n">secret_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Secrets can be string or binary</span>
            <span class="k">if</span> <span class="s1">&#39;SecretString&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;SecretString&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                    <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;SecretBinary&#39;</span><span class="p">])</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Code&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">error_code</span> <span class="o">==</span> <span class="s1">&#39;ResourceNotFoundException&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Secret not found: </span><span class="si">{</span><span class="n">secret_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">error_code</span> <span class="o">==</span> <span class="s1">&#39;AccessDeniedException&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Access denied to: </span><span class="si">{</span><span class="n">secret_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                      <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new secret.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">create_secret</span><span class="p">(</span>
            <span class="n">Name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">Description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">SecretString</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;ARN&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update an existing secret.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">update_secret</span><span class="p">(</span>
            <span class="n">SecretId</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">SecretString</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rotate_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rotation_lambda_arn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">rotation_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable automatic rotation for a secret.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">rotate_secret</span><span class="p">(</span>
            <span class="n">SecretId</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">RotationLambdaARN</span><span class="o">=</span><span class="n">rotation_lambda_arn</span><span class="p">,</span>
            <span class="n">RotationRules</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;AutomaticallyAfterDays&#39;</span><span class="p">:</span> <span class="n">rotation_days</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">recovery_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a secret with a recovery window.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">delete_secret</span><span class="p">(</span>
            <span class="n">SecretId</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">RecoveryWindowInDays</span><span class="o">=</span><span class="n">recovery_days</span><span class="p">,</span>
        <span class="p">)</span>


<span class="c1"># â”€â”€ Usage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">AWSSecretsManager</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>

<span class="c1"># Store database credentials</span>
<span class="n">sm</span><span class="o">.</span><span class="n">create_secret</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;prod/myapp/database&#39;</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;engine&#39;</span><span class="p">:</span> <span class="s1">&#39;postgresql&#39;</span><span class="p">,</span>
        <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;db.example.com&#39;</span><span class="p">,</span>
        <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;app_user&#39;</span><span class="p">,</span>
        <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;strong_password_here&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="s1">&#39;production&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Production database credentials&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Retrieve and use</span>
<span class="n">db_config</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">get_secret</span><span class="p">(</span><span class="s1">&#39;prod/myapp/database&#39;</span><span class="p">)</span>
<span class="n">connection_string</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;postgresql://</span><span class="si">{</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">db_config</span><span class="p">[</span><span class="s1">&#39;dbname&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="52-gcp-secret-manager">5.2 GCP Secret Manager<a class="header-link" href="#52-gcp-secret-manager" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Google Cloud Secret Manager client.</span>
<span class="sd">pip install google-cloud-secret-manager</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.cloud</span><span class="w"> </span><span class="kn">import</span> <span class="n">secretmanager</span>


<span class="k">class</span><span class="w"> </span><span class="nc">GCPSecretManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface to GCP Secret Manager.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">secretmanager</span><span class="o">.</span><span class="n">SecretManagerServiceClient</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="n">project_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_secret_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;latest&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build the full resource path.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;projects/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="si">}</span><span class="s2">/secrets/</span><span class="si">{</span><span class="n">secret_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;/versions/</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;latest&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a secret value.&quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_secret_path</span><span class="p">(</span><span class="n">secret_id</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">access_secret_version</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new secret with an initial version.&quot;&quot;&quot;</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;projects/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Create the secret</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">create_secret</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="n">parent</span><span class="p">,</span>
                <span class="s2">&quot;secret_id&quot;</span><span class="p">:</span> <span class="n">secret_id</span><span class="p">,</span>
                <span class="s2">&quot;secret&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;replication&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;automatic&quot;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="p">},</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Add a version with the actual value</span>
        <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">add_secret_version</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="n">secret</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">version</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new version to an existing secret.&quot;&quot;&quot;</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;projects/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="si">}</span><span class="s2">/secrets/</span><span class="si">{</span><span class="n">secret_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">add_secret_version</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="n">parent</span><span class="p">,</span>
                <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">version</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">disable_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Disable a secret version (soft delete).&quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_secret_path</span><span class="p">(</span><span class="n">secret_id</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">disable_secret_version</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a secret and all its versions.&quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;projects/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="si">}</span><span class="s2">/secrets/</span><span class="si">{</span><span class="n">secret_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">delete_secret</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>


<span class="c1"># â”€â”€ Usage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">GCPSecretManager</span><span class="p">(</span><span class="n">project_id</span><span class="o">=</span><span class="s1">&#39;my-project-123&#39;</span><span class="p">)</span>

<span class="c1"># Create a secret</span>
<span class="n">sm</span><span class="o">.</span><span class="n">create_secret</span><span class="p">(</span><span class="s1">&#39;database-password&#39;</span><span class="p">,</span> <span class="s1">&#39;my_secret_password&#39;</span><span class="p">)</span>

<span class="c1"># Read the latest version</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">get_secret</span><span class="p">(</span><span class="s1">&#39;database-password&#39;</span><span class="p">)</span>

<span class="c1"># Rotate: add a new version</span>
<span class="n">sm</span><span class="o">.</span><span class="n">add_version</span><span class="p">(</span><span class="s1">&#39;database-password&#39;</span><span class="p">,</span> <span class="s1">&#39;new_rotated_password&#39;</span><span class="p">)</span>

<span class="c1"># The old version is still accessible by version number</span>
<span class="n">old_password</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">get_secret</span><span class="p">(</span><span class="s1">&#39;database-password&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="6-git-secrets-scanning">6. Git Secrets Scanning<a class="header-link" href="#6-git-secrets-scanning" title="Permanent link">&para;</a></h2>
<h3 id="61-the-problem">6.1 The Problem<a class="header-link" href="#61-the-problem" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Secrets in Git â€” The Problem                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Common scenarios for secret leakage:                                â”‚
â”‚                                                                      â”‚
â”‚  1. Accidental commit of .env file                                   â”‚
â”‚     $ git add .                                                      â”‚
â”‚     $ git commit -m &quot;initial commit&quot;                                 â”‚
â”‚     # .env with real passwords is now in git history FOREVER         â”‚
â”‚                                                                      â”‚
â”‚  2. Hardcoded API key in source code                                 â”‚
â”‚     api_key = &quot;sk_live_EXAMPLE_KEY_REPLACE_ME&quot;                   â”‚
â”‚     # Even if deleted later, it exists in git history                â”‚
â”‚                                                                      â”‚
â”‚  3. Configuration file with credentials                              â”‚
â”‚     database:                                                        â”‚
â”‚       password: &quot;production_password_123&quot;                            â”‚
â”‚                                                                      â”‚
â”‚  4. Test fixtures with real credentials                              â”‚
â”‚     STRIPE_KEY = &quot;sk_live_...&quot; # &quot;test&quot; key is actually live         â”‚
â”‚                                                                      â”‚
â”‚  IMPORTANT: git rm does NOT remove from history!                     â”‚
â”‚  The secret remains accessible via: git log --all --full-history     â”‚
â”‚  Removing requires: git filter-branch or BFG Repo-Cleaner           â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="62-pre-commit-hooks">6.2 Pre-Commit Hooks<a class="header-link" href="#62-pre-commit-hooks" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ git-secrets (AWS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Install</span>
brew<span class="w"> </span>install<span class="w"> </span>git-secrets<span class="w">  </span><span class="c1"># macOS</span>
<span class="c1"># or: git clone https://github.com/awslabs/git-secrets.git &amp;&amp; make install</span>

<span class="c1"># Set up for a repository</span>
<span class="nb">cd</span><span class="w"> </span>/path/to/repo
git<span class="w"> </span>secrets<span class="w"> </span>--install<span class="w">        </span><span class="c1"># Install hooks</span>
git<span class="w"> </span>secrets<span class="w"> </span>--register-aws<span class="w">   </span><span class="c1"># Register AWS patterns</span>

<span class="c1"># Add custom patterns</span>
git<span class="w"> </span>secrets<span class="w"> </span>--add<span class="w"> </span><span class="s1">&#39;PRIVATE_KEY&#39;</span>
git<span class="w"> </span>secrets<span class="w"> </span>--add<span class="w"> </span><span class="s1">&#39;password\s*=\s*.+&#39;</span>
git<span class="w"> </span>secrets<span class="w"> </span>--add<span class="w"> </span>--allowed<span class="w"> </span><span class="s1">&#39;password\s*=\s*os\.getenv&#39;</span><span class="w">  </span><span class="c1"># Allow env lookups</span>

<span class="c1"># Test scanning</span>
git<span class="w"> </span>secrets<span class="w"> </span>--scan<span class="w">           </span><span class="c1"># Scan staged changes</span>
git<span class="w"> </span>secrets<span class="w"> </span>--scan-history<span class="w">   </span><span class="c1"># Scan entire history</span>

<span class="c1"># â”€â”€ pre-commit framework â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># pip install pre-commit</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># .pre-commit-config.yaml</span>
<span class="nt">repos</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># Detect secrets before they are committed</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/Yelp/detect-secrets</span>
<span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.4.0</span>
<span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">detect-secrets</span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;--baseline&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;.secrets.baseline&#39;</span><span class="p p-Indicator">]</span>

<span class="w">  </span><span class="c1"># gitleaks â€” comprehensive secret scanner</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/gitleaks/gitleaks</span>
<span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v8.18.0</span>
<span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gitleaks</span>

<span class="w">  </span><span class="c1"># Check for private keys</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/pre-commit/pre-commit-hooks</span>
<span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v4.5.0</span>
<span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">detect-private-key</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-added-large-files</span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;--maxkb=100&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Install the pre-commit hooks</span>
pre-commit<span class="w"> </span>install

<span class="c1"># Run manually on all files</span>
pre-commit<span class="w"> </span>run<span class="w"> </span>--all-files

<span class="c1"># Run specific hook</span>
pre-commit<span class="w"> </span>run<span class="w"> </span>detect-secrets<span class="w"> </span>--all-files
</code></pre></div>

<h3 id="63-scanning-tools">6.3 Scanning Tools<a class="header-link" href="#63-scanning-tools" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ gitleaks â€” Fast, comprehensive scanner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Install</span>
brew<span class="w"> </span>install<span class="w"> </span>gitleaks<span class="w">  </span><span class="c1"># macOS</span>
<span class="c1"># or: go install github.com/gitleaks/gitleaks/v8@latest</span>

<span class="c1"># Scan current repository</span>
gitleaks<span class="w"> </span>detect<span class="w"> </span>--source<span class="w"> </span>.<span class="w"> </span>--verbose

<span class="c1"># Scan specific commit range</span>
gitleaks<span class="w"> </span>detect<span class="w"> </span>--source<span class="w"> </span>.<span class="w"> </span>--log-opts<span class="o">=</span><span class="s2">&quot;HEAD~10..HEAD&quot;</span>

<span class="c1"># Scan entire history</span>
gitleaks<span class="w"> </span>detect<span class="w"> </span>--source<span class="w"> </span>.<span class="w"> </span>--log-opts<span class="o">=</span><span class="s2">&quot;--all&quot;</span>

<span class="c1"># Generate report</span>
gitleaks<span class="w"> </span>detect<span class="w"> </span>--source<span class="w"> </span>.<span class="w"> </span>--report-format<span class="w"> </span>json<span class="w"> </span>--report-path<span class="w"> </span>report.json

<span class="c1"># Use custom rules</span>
gitleaks<span class="w"> </span>detect<span class="w"> </span>--source<span class="w"> </span>.<span class="w"> </span>--config<span class="w"> </span>gitleaks.toml

<span class="c1"># â”€â”€ trufflehog â€” High-accuracy scanner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Install</span>
pip<span class="w"> </span>install<span class="w"> </span>trufflehog

<span class="c1"># or use Docker</span>
docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PWD</span><span class="s2">:/repo&quot;</span><span class="w"> </span>trufflesecurity/trufflehog:latest<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>git<span class="w"> </span>file:///repo<span class="w"> </span>--only-verified

<span class="c1"># Scan a repo</span>
trufflehog<span class="w"> </span>git<span class="w"> </span>file:///path/to/repo<span class="w"> </span>--only-verified

<span class="c1"># Scan a GitHub repo directly</span>
trufflehog<span class="w"> </span>github<span class="w"> </span>--org<span class="w"> </span>your-org<span class="w"> </span>--only-verified

<span class="c1"># â”€â”€ detect-secrets (Yelp) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Install</span>
pip<span class="w"> </span>install<span class="w"> </span>detect-secrets

<span class="c1"># Create a baseline (marks existing findings as accepted)</span>
detect-secrets<span class="w"> </span>scan<span class="w"> </span>&gt;<span class="w"> </span>.secrets.baseline

<span class="c1"># Audit the baseline interactively</span>
detect-secrets<span class="w"> </span>audit<span class="w"> </span>.secrets.baseline

<span class="c1"># Scan for new secrets (compared to baseline)</span>
detect-secrets<span class="w"> </span>scan<span class="w"> </span>--baseline<span class="w"> </span>.secrets.baseline
</code></pre></div>

<h3 id="64-custom-gitleaks-configuration">6.4 Custom gitleaks Configuration<a class="header-link" href="#64-custom-gitleaks-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># gitleaks.toml â€” Custom rules for secret detection</span>
<span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Custom Gitleaks Config&quot;</span>

<span class="c1"># Extend the default rules</span>
<span class="k">[extend]</span>
<span class="n">useDefault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>

<span class="c1"># Custom rules</span>
<span class="k">[[rules]]</span>
<span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;custom-api-key&quot;</span>
<span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Custom API Key Pattern&quot;</span>
<span class="n">regex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;&#39;(?i)(api[_-]?key|apikey)\s*[=:]\s*[&#39;&quot;]?([a-zA-Z0-9_\-]{20,})[&#39;&quot;]?&#39;&#39;&#39;</span>
<span class="n">secretGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>

<span class="k">[[rules]]</span>
<span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;slack-webhook&quot;</span>
<span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Slack Webhook URL&quot;</span>
<span class="n">regex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;&#39;https://hooks\.slack\.com/services/T[a-zA-Z0-9_]{8,}/B[a-zA-Z0-9_]{8,}/[a-zA-Z0-9_]{24,}&#39;&#39;&#39;</span>

<span class="k">[[rules]]</span>
<span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;internal-password&quot;</span>
<span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Hardcoded Password&quot;</span>
<span class="n">regex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;&#39;(?i)(password|passwd|pwd)\s*[=:]\s*[&#39;&quot;]([^&#39;&quot;]{8,})[&#39;&quot;]&#39;&#39;&#39;</span>
<span class="n">secretGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>

<span class="c1"># Allowlist (false positive suppression)</span>
<span class="k">[allowlist]</span>
<span class="n">paths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;&#39;&#39;\.env\.example&#39;&#39;&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;&#39;&#39;\.env\.template&#39;&#39;&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;&#39;&#39;test_.*\.py&#39;&#39;&#39;</span><span class="p">,</span><span class="w">        </span><span class="c1"># Be careful with this</span>
<span class="w">    </span><span class="s1">&#39;&#39;&#39;docs/.*\.md&#39;&#39;&#39;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">regexes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;&#39;&#39;password\s*=\s*os\.getenv&#39;&#39;&#39;</span><span class="p">,</span><span class="w">    </span><span class="c1"># Reading from env is OK</span>
<span class="w">    </span><span class="s1">&#39;&#39;&#39;password\s*=\s*[&quot;&#39;]changeme[&quot;&#39;]&#39;&#39;&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1"># Placeholder values</span>
<span class="w">    </span><span class="s1">&#39;&#39;&#39;EXAMPLE_KEY_DO_NOT_USE&#39;&#39;&#39;</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>

<h3 id="65-removing-secrets-from-git-history">6.5 Removing Secrets from Git History<a class="header-link" href="#65-removing-secrets-from-git-history" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ BFG Repo-Cleaner (recommended) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Install: brew install bfg</span>

<span class="c1"># Remove a file from all history</span>
bfg<span class="w"> </span>--delete-files<span class="w"> </span><span class="s1">&#39;.env&#39;</span><span class="w"> </span>my-repo.git

<span class="c1"># Replace text in all files across history</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;sk_live_EXAMPLE_KEY_REPLACE_ME&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>passwords.txt
bfg<span class="w"> </span>--replace-text<span class="w"> </span>passwords.txt<span class="w"> </span>my-repo.git

<span class="c1"># After BFG, clean up</span>
<span class="nb">cd</span><span class="w"> </span>my-repo.git
git<span class="w"> </span>reflog<span class="w"> </span>expire<span class="w"> </span>--expire<span class="o">=</span>now<span class="w"> </span>--all
git<span class="w"> </span>gc<span class="w"> </span>--prune<span class="o">=</span>now<span class="w"> </span>--aggressive

<span class="c1"># Force push (WARNING: rewriting history)</span>
git<span class="w"> </span>push<span class="w"> </span>--force

<span class="c1"># â”€â”€ git filter-repo (alternative) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># pip install git-filter-repo</span>

<span class="c1"># Remove a file from history</span>
git<span class="w"> </span>filter-repo<span class="w"> </span>--path<span class="w"> </span>.env<span class="w"> </span>--invert-paths

<span class="c1"># Replace a string in all files</span>
git<span class="w"> </span>filter-repo<span class="w"> </span>--replace-text<span class="w"> </span>&lt;<span class="o">(</span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;literal:sk_live_EXAMPLE_KEY_REPLACE_ME==&gt;REDACTED&#39;</span><span class="o">)</span>

<span class="c1"># â”€â”€ IMPORTANT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># After removing secrets from history:</span>
<span class="c1"># 1. Force push to remote (all collaborators must re-clone)</span>
<span class="c1"># 2. IMMEDIATELY rotate the compromised secret</span>
<span class="c1"># 3. The secret was already exposed â€” removing from git is damage control</span>
<span class="c1"># 4. GitHub caches may still have the data temporarily</span>
<span class="c1"># 5. Any fork may still contain the secret</span>
</code></pre></div>

<hr />
<h2 id="7-cicd-secrets">7. CI/CD Secrets<a class="header-link" href="#7-cicd-secrets" title="Permanent link">&para;</a></h2>
<h3 id="71-github-actions-secrets">7.1 GitHub Actions Secrets<a class="header-link" href="#71-github-actions-secrets" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># .github/workflows/deploy.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>

<span class="c1"># â”€â”€ Accessing secrets in GitHub Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>

<span class="w">    </span><span class="c1"># Use environment-level secrets for different stages</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="c1"># Secrets are available as environment variables</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure AWS</span>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<span class="w">          </span><span class="nt">AWS_ACCESS_KEY_ID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.AWS_ACCESS_KEY_ID }}</span>
<span class="w">          </span><span class="nt">AWS_SECRET_ACCESS_KEY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.AWS_SECRET_ACCESS_KEY }}</span>
<span class="w">          </span><span class="nt">AWS_REGION</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">us-east-1</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID</span>
<span class="w">          </span><span class="no">aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY</span>
<span class="w">          </span><span class="no">aws configure set region $AWS_REGION</span>

<span class="w">      </span><span class="c1"># Use secrets directly (masked in logs)</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">echo &quot;Deploying to production...&quot;</span>
<span class="w">          </span><span class="no"># ${{ secrets.DEPLOY_KEY }} is masked as *** in logs</span>
<span class="w">          </span><span class="no">./deploy.sh --key &quot;${{ secrets.DEPLOY_KEY }}&quot;</span>

<span class="w">      </span><span class="c1"># Docker login with secrets</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Login to Docker Hub</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker/login-action@v3</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.DOCKER_USERNAME }}</span>
<span class="w">          </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.DOCKER_PASSWORD }}</span>

<span class="w">      </span><span class="c1"># OIDC authentication (preferred over static credentials)</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure AWS with OIDC</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws-actions/configure-aws-credentials@v4</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">role-to-assume</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:iam::123456789:role/github-actions</span>
<span class="w">          </span><span class="nt">aws-region</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">us-east-1</span>
<span class="w">          </span><span class="c1"># No static credentials needed!</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Security best practices for GitHub Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># 1. Use environment-level secrets with required reviewers</span>
<span class="c1"># 2. Use OIDC instead of static credentials where possible</span>
<span class="c1"># 3. Pin actions to specific SHA, not tags</span>
<span class="c1"># 4. Limit secret access to specific environments</span>
<span class="c1"># 5. Use GITHUB_TOKEN&#39;s automatic permissions (not PATs)</span>

<span class="c1"># .github/workflows/secure.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secure Workflow</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>

<span class="nt">permissions</span><span class="p">:</span>
<span class="w">  </span><span class="nt">contents</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span><span class="w">  </span><span class="c1"># Minimal permissions</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># Pin actions to SHA (not tag) to prevent supply chain attacks</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11</span><span class="w">  </span><span class="c1"># v4.1.1</span>

<span class="w">      </span><span class="c1"># Use GITHUB_TOKEN for repository access (auto-scoped)</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create Release</span>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<span class="w">          </span><span class="nt">GH_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ github.token }}</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gh release create v1.0 --generate-notes</span>

<span class="w">      </span><span class="c1"># Never echo secrets (even accidentally)</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Safe Logging</span>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<span class="w">          </span><span class="nt">API_KEY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.API_KEY }}</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no"># BAD: echo &quot;Key is: $API_KEY&quot;</span>
<span class="w">          </span><span class="no"># GOOD: Test the key works without printing it</span>
<span class="w">          </span><span class="no">curl -sf -H &quot;Authorization: Bearer $API_KEY&quot; \</span>
<span class="w">               </span><span class="no">https://api.example.com/health || exit 1</span>
</code></pre></div>

<h3 id="72-gitlab-ci-variables">7.2 GitLab CI Variables<a class="header-link" href="#72-gitlab-ci-variables" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># .gitlab-ci.yml</span>
<span class="c1"># Variables are set in GitLab UI:</span>
<span class="c1"># Settings â†’ CI/CD â†’ Variables</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>

<span class="nt">test</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Non-sensitive can be set here</span>
<span class="w">    </span><span class="nt">NODE_ENV</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Protected variables only available on protected branches</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;Running tests...&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest --cov</span>
<span class="w">    </span><span class="c1"># Masked variables are hidden in job logs</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;DB URL is $DATABASE_URL&quot;</span><span class="w">  </span><span class="c1"># Shows as [MASKED]</span>

<span class="nt">deploy</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="c1"># Restrict to protected branches only</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Use file-type variables for multi-line secrets (like certificates)</span>
<span class="w">    </span><span class="c1"># GitLab writes the value to a file and sets the variable to the path</span>
<span class="w">    </span><span class="nt">KUBE_CONFIG</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$KUBE_CONFIG_FILE</span><span class="w">  </span><span class="c1"># This is a file path</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl --kubeconfig=&quot;$KUBE_CONFIG&quot; apply -f deployment.yaml</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>

<span class="c1"># â”€â”€ GitLab CI Secret Best Practices â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># 1. Mark sensitive variables as &quot;Masked&quot; (hidden in logs)</span>
<span class="c1"># 2. Mark deployment secrets as &quot;Protected&quot; (only on protected branches)</span>
<span class="c1"># 3. Use &quot;File&quot; type for multi-line secrets (certs, keys)</span>
<span class="c1"># 4. Scope variables to specific environments</span>
<span class="c1"># 5. Use GitLab&#39;s external secrets integration (Vault, AWS, GCP)</span>
</code></pre></div>

<hr />
<h2 id="8-encryption-at-rest">8. Encryption at Rest<a class="header-link" href="#8-encryption-at-rest" title="Permanent link">&para;</a></h2>
<h3 id="81-encrypting-configuration-files">8.1 Encrypting Configuration Files<a class="header-link" href="#81-encrypting-configuration-files" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Encrypting configuration files with Fernet (symmetric encryption).</span>
<span class="sd">pip install cryptography</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.fernet</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fernet</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ConfigEncryptor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Encrypt and decrypt configuration files.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Load key from environment</span>
            <span class="n">key_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;CONFIG_ENCRYPTION_KEY&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;CONFIG_ENCRYPTION_KEY environment variable not set&quot;</span>
                <span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key_str</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_key</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a new encryption key.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Fernet</span><span class="o">.</span><span class="n">generate_key</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">encrypt_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Encrypt a configuration dictionary and write to file.&quot;&quot;&quot;</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">encrypted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decrypt_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read and decrypt a configuration file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">encrypted</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">decrypted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">decrypted</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">encrypt_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Encrypt a single value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decrypt_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encrypted_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decrypt a single value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted_value</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>


<span class="c1"># â”€â”€ Usage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># First time: generate a key</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">ConfigEncryptor</span><span class="o">.</span><span class="n">generate_key</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Store this key securely: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># Store in: environment variable, Vault, cloud KMS</span>

<span class="c1"># Encrypt config</span>
<span class="n">encryptor</span> <span class="o">=</span> <span class="n">ConfigEncryptor</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="n">encryptor</span><span class="o">.</span><span class="n">encrypt_config</span><span class="p">(</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;database_url&#39;</span><span class="p">:</span> <span class="s1">&#39;postgresql://user:pass@host/db&#39;</span><span class="p">,</span>
        <span class="s1">&#39;api_key&#39;</span><span class="p">:</span> <span class="s1">&#39;sk_live_xxxxx&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jwt_secret&#39;</span><span class="p">:</span> <span class="s1">&#39;supersecret&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">output_path</span><span class="o">=</span><span class="s1">&#39;config.enc&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Decrypt config (at application startup)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">decrypt_config</span><span class="p">(</span><span class="s1">&#39;config.enc&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;database_url&#39;</span><span class="p">])</span>
</code></pre></div>

<h3 id="82-sops-secrets-operations">8.2 SOPS (Secrets OPerationS)<a class="header-link" href="#82-sops-secrets-operations" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ SOPS: Encrypted file management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># SOPS encrypts values in YAML/JSON/ENV files while keeping keys visible</span>
<span class="c1"># This means you can diff, review, and commit encrypted files</span>

<span class="c1"># Install</span>
brew<span class="w"> </span>install<span class="w"> </span>sops

<span class="c1"># â”€â”€ Using SOPS with age encryption â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Generate an age key</span>
age-keygen<span class="w"> </span>-o<span class="w"> </span>keys.txt
<span class="c1"># Public key: age1xxxxxxx...</span>
<span class="c1"># Store private key securely</span>

<span class="c1"># Create .sops.yaml configuration</span>
cat<span class="w"> </span>&gt;<span class="w"> </span>.sops.yaml<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s">creation_rules:</span>
<span class="s">  - path_regex: \.enc\.yaml$</span>
<span class="s">    age: age1xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
<span class="s">  - path_regex: \.enc\.json$</span>
<span class="s">    age: age1xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
<span class="s">EOF</span>

<span class="c1"># Encrypt a file</span>
sops<span class="w"> </span>--encrypt<span class="w"> </span>secrets.yaml<span class="w"> </span>&gt;<span class="w"> </span>secrets.enc.yaml

<span class="c1"># Decrypt a file</span>
sops<span class="w"> </span>--decrypt<span class="w"> </span>secrets.enc.yaml<span class="w"> </span>&gt;<span class="w"> </span>secrets.yaml

<span class="c1"># Edit encrypted file in place (decrypts, opens editor, re-encrypts)</span>
sops<span class="w"> </span>secrets.enc.yaml
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># secrets.enc.yaml â€” Values are encrypted, keys are readable</span>
<span class="nt">database</span><span class="p">:</span>
<span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ENC[AES256_GCM,data:kDf5...,iv:abc...,tag:def...,type:str]</span>
<span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ENC[AES256_GCM,data:NTQzMg==,iv:ghi...,tag:jkl...,type:int]</span>
<span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ENC[AES256_GCM,data:mno...,iv:pqr...,tag:stu...,type:str]</span>
<span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ENC[AES256_GCM,data:vwx...,iv:yza...,tag:bcd...,type:str]</span>
<span class="nt">api_keys</span><span class="p">:</span>
<span class="w">    </span><span class="nt">stripe</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ENC[AES256_GCM,data:efg...,iv:hij...,tag:klm...,type:str]</span>
<span class="w">    </span><span class="nt">sendgrid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ENC[AES256_GCM,data:nop...,iv:qrs...,tag:tuv...,type:str]</span>
<span class="nt">sops</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kms</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">    </span><span class="nt">age</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">recipient</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">age1xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
<span class="w">          </span><span class="nt">enc</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">            </span><span class="no">-----BEGIN AGE ENCRYPTED FILE-----</span>
<span class="w">            </span><span class="no">...</span>
<span class="w">            </span><span class="no">-----END AGE ENCRYPTED FILE-----</span>
<span class="w">    </span><span class="nt">lastmodified</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2025-01-15T10:30:00Z&quot;</span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.8.0</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Loading SOPS-encrypted config in Python.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_sops_config</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decrypt a SOPS file and return as dictionary.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;sops&#39;</span><span class="p">,</span> <span class="s1">&#39;--decrypt&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">],</span>
        <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.yaml&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.yml&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file format: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># Usage</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">load_sops_config</span><span class="p">(</span><span class="s1">&#39;secrets.enc.yaml&#39;</span><span class="p">)</span>
<span class="n">db_password</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
</code></pre></div>

<hr />
<h2 id="9-common-mistakes">9. Common Mistakes<a class="header-link" href="#9-common-mistakes" title="Permanent link">&para;</a></h2>
<h3 id="91-anti-patterns">9.1 Anti-Patterns<a class="header-link" href="#91-anti-patterns" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Common secrets management mistakes â€” DO NOT DO THESE.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># â”€â”€ MISTAKE 1: Hardcoded secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># BAD</span>
<span class="n">API_KEY</span> <span class="o">=</span> <span class="s2">&quot;sk_live_EXAMPLE_KEY_REPLACE_ME&quot;</span>
<span class="n">DB_PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;production_password_123&quot;</span>

<span class="c1"># GOOD</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;API_KEY&quot;</span><span class="p">)</span>
<span class="n">DB_PASSWORD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DB_PASSWORD&quot;</span><span class="p">)</span>


<span class="c1"># â”€â”€ MISTAKE 2: Secrets in logs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># BAD</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connecting to database with password: </span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># May contain auth headers</span>

<span class="c1"># GOOD</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connecting to database as user: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;API response status: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>


<span class="c1"># â”€â”€ MISTAKE 3: Secrets in URLs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># BAD â€” Password appears in server logs, browser history, Referer headers</span>
<span class="n">DATABASE_URL</span> <span class="o">=</span> <span class="s2">&quot;postgresql://admin:P@ssw0rd@db.example.com/prod&quot;</span>

<span class="c1"># GOOD â€” Use separate variables</span>
<span class="n">DATABASE_HOST</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DB_HOST&quot;</span><span class="p">)</span>
<span class="n">DATABASE_USER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DB_USER&quot;</span><span class="p">)</span>
<span class="n">DATABASE_PASS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DB_PASS&quot;</span><span class="p">)</span>


<span class="c1"># â”€â”€ MISTAKE 4: Secrets in error messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># BAD</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">secret_password</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to connect with password </span><span class="si">{</span><span class="n">secret_password</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># GOOD</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">secret_password</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database connection failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># â”€â”€ MISTAKE 5: Committing .env to git â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># BAD: Forgetting .env in .gitignore</span>
<span class="c1"># Even worse: Adding .env then removing it (still in history)</span>

<span class="c1"># GOOD: Add to .gitignore BEFORE creating the file</span>
<span class="c1"># And use pre-commit hooks to prevent accidental commits</span>


<span class="c1"># â”€â”€ MISTAKE 6: Same secret for all environments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># BAD: Using production keys in development</span>
<span class="c1"># This increases the blast radius of a development machine compromise</span>

<span class="c1"># GOOD: Different secrets for dev, staging, production</span>
<span class="c1"># Development uses test/sandbox API keys</span>
<span class="c1"># Production keys are only on production servers</span>


<span class="c1"># â”€â”€ MISTAKE 7: Never rotating secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># BAD: API key created in 2019, never changed</span>
<span class="c1"># If compromised, attacker has had access for years</span>

<span class="c1"># GOOD: Automated rotation with zero-downtime strategy</span>


<span class="c1"># â”€â”€ MISTAKE 8: Shared secrets among team members â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># BAD: &quot;Hey, can you Slack me the production DB password?&quot;</span>

<span class="c1"># GOOD:</span>
<span class="c1"># - Use a secret manager (Vault, AWS SM, 1Password)</span>
<span class="c1"># - Each person gets their own credentials</span>
<span class="c1"># - Use SSO/OIDC where possible (no shared secrets)</span>
<span class="c1"># - Secrets are accessed programmatically, not by humans</span>


<span class="c1"># â”€â”€ MISTAKE 9: Secrets in Docker images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># BAD</span>
<span class="c1"># Dockerfile:</span>
<span class="c1"># ENV API_KEY=sk_live_xxxxx</span>
<span class="c1"># COPY .env /app/.env</span>

<span class="c1"># GOOD: Inject at runtime</span>
<span class="c1"># docker run -e API_KEY=$API_KEY myimage</span>
<span class="c1"># Or use Docker secrets / Kubernetes secrets</span>


<span class="c1"># â”€â”€ MISTAKE 10: Client-side secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># BAD: Embedding API keys in JavaScript/mobile apps</span>
<span class="c1"># &lt;script&gt;</span>
<span class="c1">#   const API_KEY = &quot;sk_live_xxxxx&quot;;  // Visible to anyone</span>
<span class="c1"># &lt;/script&gt;</span>

<span class="c1"># GOOD: Use a backend proxy</span>
<span class="c1"># Client â†’ Your Backend (has the secret) â†’ Third-party API</span>
</code></pre></div>

<h3 id="92-secret-detection-checklist">9.2 Secret Detection Checklist<a class="header-link" href="#92-secret-detection-checklist" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Automated check for common secret patterns in code.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SecretFinding</span><span class="p">:</span>
    <span class="n">file</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">line_number</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">pattern_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">matched_text</span><span class="p">:</span> <span class="nb">str</span>

<span class="c1"># Patterns that indicate potential secrets</span>
<span class="n">SECRET_PATTERNS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;aws_access_key&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;(?:A3T[A-Z0-9]|AKIA|AGPA|AIDA|AROA|AIPA|ANPA|ANVA|ASIA)&#39;</span>
        <span class="sa">r</span><span class="s1">&#39;[A-Z0-9]</span><span class="si">{16}</span><span class="s1">&#39;</span>
    <span class="p">),</span>
    <span class="s2">&quot;aws_secret_key&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;(?i)aws_secret_access_key\s*[=:]\s*[&quot;</span><span class="se">\&#39;</span><span class="s1">]?[A-Za-z0-9/+=]</span><span class="si">{40}</span><span class="s1">&#39;</span>
    <span class="p">),</span>
    <span class="s2">&quot;generic_password&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;(?i)(password|passwd|pwd)\s*[=:]\s*[&quot;</span><span class="se">\&#39;</span><span class="s1">][^&quot;</span><span class="se">\&#39;</span><span class="s1">]{8,}[&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span>
    <span class="p">),</span>
    <span class="s2">&quot;generic_api_key&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;(?i)(api[_-]?key|apikey)\s*[=:]\s*[&quot;</span><span class="se">\&#39;</span><span class="s1">][A-Za-z0-9_\-]{20,}[&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span>
    <span class="p">),</span>
    <span class="s2">&quot;private_key&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;-----BEGIN (?:RSA|EC|DSA|OPENSSH)? ?PRIVATE KEY-----&#39;</span>
    <span class="p">),</span>
    <span class="s2">&quot;jwt_token&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;eyJ[A-Za-z0-9_-]{10,}\.eyJ[A-Za-z0-9_-]{10,}\.[A-Za-z0-9_-]+&#39;</span>
    <span class="p">),</span>
    <span class="s2">&quot;github_token&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;gh[pousr]_[A-Za-z0-9_]{36,}&#39;</span>
    <span class="p">),</span>
    <span class="s2">&quot;slack_webhook&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;https://hooks\.slack\.com/services/T[a-zA-Z0-9_]+/B[a-zA-Z0-9_]+/[a-zA-Z0-9_]+&#39;</span>
    <span class="p">),</span>
    <span class="s2">&quot;stripe_key&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;[sr]k_(live|test)_[A-Za-z0-9]{20,}&#39;</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># Patterns that indicate false positives</span>
<span class="n">FALSE_POSITIVE_PATTERNS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?i)password\s*=\s*os\.getenv&#39;</span><span class="p">),</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?i)password\s*=\s*[&quot;</span><span class="se">\&#39;</span><span class="s1">]changeme[&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="p">),</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?i)password\s*=\s*[&quot;</span><span class="se">\&#39;</span><span class="s1">]&lt;.*&gt;[&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="p">),</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?i)password\s*=\s*[&quot;</span><span class="se">\&#39;</span><span class="s1">]your_password_here[&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="p">),</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?i)password\s*=\s*[&quot;</span><span class="se">\&#39;</span><span class="s1">]placeholder[&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="p">),</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#.*password&#39;</span><span class="p">),</span>  <span class="c1"># Comments</span>
<span class="p">]</span>

<span class="n">SKIP_DIRS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;.git&#39;</span><span class="p">,</span> <span class="s1">&#39;node_modules&#39;</span><span class="p">,</span> <span class="s1">&#39;__pycache__&#39;</span><span class="p">,</span> <span class="s1">&#39;.venv&#39;</span><span class="p">,</span> <span class="s1">&#39;venv&#39;</span><span class="p">}</span>
<span class="n">SKIP_EXTENSIONS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;.pyc&#39;</span><span class="p">,</span> <span class="s1">&#39;.pyo&#39;</span><span class="p">,</span> <span class="s1">&#39;.so&#39;</span><span class="p">,</span> <span class="s1">&#39;.dylib&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.gif&#39;</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">scan_directory</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SecretFinding</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Scan a directory for potential secrets.&quot;&quot;&quot;</span>
    <span class="n">findings</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
        <span class="c1"># Skip directories</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">part</span> <span class="ow">in</span> <span class="n">SKIP_DIRS</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">parts</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="n">SKIP_EXTENSIONS</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">PermissionError</span><span class="p">,</span> <span class="ne">UnicodeDecodeError</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pattern_name</span><span class="p">,</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">SECRET_PATTERNS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="c1"># Check for false positives</span>
                    <span class="n">is_false_positive</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="n">fp</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">FALSE_POSITIVE_PATTERNS</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_false_positive</span><span class="p">:</span>
                        <span class="n">findings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SecretFinding</span><span class="p">(</span>
                            <span class="n">file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                            <span class="n">line_number</span><span class="o">=</span><span class="n">line_num</span><span class="p">,</span>
                            <span class="n">pattern_name</span><span class="o">=</span><span class="n">pattern_name</span><span class="p">,</span>
                            <span class="n">matched_text</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="mi">100</span><span class="p">],</span>
                        <span class="p">))</span>

    <span class="k">return</span> <span class="n">findings</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;.&#39;</span>
    <span class="n">findings</span> <span class="o">=</span> <span class="n">scan_directory</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">findings</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">findings</span><span class="p">)</span><span class="si">}</span><span class="s2"> potential secrets:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">findings</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">pattern_name</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">line_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">matched_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No secrets detected.&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="10-exercises">10. Exercises<a class="header-link" href="#10-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-environment-configuration-system">Exercise 1: Environment Configuration System<a class="header-link" href="#exercise-1-environment-configuration-system" title="Permanent link">&para;</a></h3>
<p>Build a configuration management system that:</p>
<ol>
<li>Loads settings from multiple sources with priority order:</li>
<li>Environment variables (highest priority)</li>
<li><code>.env.local</code> file</li>
<li><code>.env</code> file</li>
<li>Default values (lowest priority)</li>
<li>Validates all required settings at startup (fail fast)</li>
<li>Uses Pydantic <code>SecretStr</code> to prevent accidental logging of secrets</li>
<li>Provides a <code>config.dump_safe()</code> method that shows all settings with secrets masked</li>
<li>Supports type coercion (string to int, bool, list)</li>
<li>Write tests to verify the priority order and validation</li>
</ol>
<h3 id="exercise-2-secret-rotation-service">Exercise 2: Secret Rotation Service<a class="header-link" href="#exercise-2-secret-rotation-service" title="Permanent link">&para;</a></h3>
<p>Implement an automated secret rotation service that:</p>
<ol>
<li>Manages a set of secrets with configurable rotation intervals</li>
<li>Supports zero-downtime rotation (dual-secret window)</li>
<li>Notifies registered consumers when secrets are rotated</li>
<li>Logs all rotation events for audit</li>
<li>Supports rollback if the new secret fails verification</li>
<li>Can be integrated with a scheduler (run rotation checks every hour)</li>
<li>Stores rotation history for compliance</li>
</ol>
<h3 id="exercise-3-git-secret-scanner">Exercise 3: Git Secret Scanner<a class="header-link" href="#exercise-3-git-secret-scanner" title="Permanent link">&para;</a></h3>
<p>Build a comprehensive git secret scanner that:</p>
<ol>
<li>Scans staged files (pre-commit hook)</li>
<li>Scans entire git history for past leaks</li>
<li>Supports configurable patterns (regex-based)</li>
<li>Has a baseline/allowlist for known false positives</li>
<li>Generates reports in JSON and human-readable format</li>
<li>Can be run as a pre-commit hook or CI/CD step</li>
<li>Supports incremental scanning (only new commits)</li>
</ol>
<h3 id="exercise-4-vault-integration-library">Exercise 4: Vault Integration Library<a class="header-link" href="#exercise-4-vault-integration-library" title="Permanent link">&para;</a></h3>
<p>Create a Python library that:</p>
<ol>
<li>Authenticates to Vault using AppRole or Token</li>
<li>Caches secrets locally with TTL (avoid repeated Vault calls)</li>
<li>Automatically refreshes secrets before they expire</li>
<li>Falls back to environment variables if Vault is unavailable</li>
<li>Provides a Django/Flask settings integration</li>
<li>Handles Vault token renewal transparently</li>
<li>Logs access patterns without revealing secret values</li>
</ol>
<h3 id="exercise-5-sops-workflow-automation">Exercise 5: SOPS Workflow Automation<a class="header-link" href="#exercise-5-sops-workflow-automation" title="Permanent link">&para;</a></h3>
<p>Build a command-line tool that:</p>
<ol>
<li>Creates encrypted config files for multiple environments (dev, staging, prod)</li>
<li>Validates that encrypted files contain all required keys</li>
<li>Diffs two encrypted files without decrypting (compare structure)</li>
<li>Rotates encryption keys (re-encrypt all files with new key)</li>
<li>Integrates with git hooks to prevent committing unencrypted files</li>
<li>Generates a <code>.env</code> file from an encrypted config for local development</li>
</ol>
<h3 id="exercise-6-cicd-secrets-audit">Exercise 6: CI/CD Secrets Audit<a class="header-link" href="#exercise-6-cicd-secrets-audit" title="Permanent link">&para;</a></h3>
<p>Write an audit tool that:</p>
<ol>
<li>Scans GitHub Actions workflow files for secret usage patterns</li>
<li>Identifies secrets that are passed insecurely (e.g., in command arguments visible in logs)</li>
<li>Checks if actions are pinned to SHA (not mutable tags)</li>
<li>Verifies that secrets are scoped to the correct environment</li>
<li>Detects if <code>GITHUB_TOKEN</code> permissions are overly broad</li>
<li>Generates a compliance report</li>
</ol>
<hr />
<h2 id="summary">Summary<a class="header-link" href="#summary" title="Permanent link">&para;</a></h2>
<h3 id="secrets-management-maturity-model">Secrets Management Maturity Model<a class="header-link" href="#secrets-management-maturity-model" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Level</th>
<th>Description</th>
<th>Practices</th>
</tr>
</thead>
<tbody>
<tr>
<td>Level 0</td>
<td>No management</td>
<td>Hardcoded secrets, committed to git</td>
</tr>
<tr>
<td>Level 1</td>
<td>Basic</td>
<td>.env files, .gitignore, manual rotation</td>
</tr>
<tr>
<td>Level 2</td>
<td>Intermediate</td>
<td>Secret manager (Vault/cloud), pre-commit hooks</td>
</tr>
<tr>
<td>Level 3</td>
<td>Advanced</td>
<td>Automated rotation, dynamic secrets, audit logging</td>
</tr>
<tr>
<td>Level 4</td>
<td>Optimal</td>
<td>Zero-trust, OIDC everywhere, continuous scanning</td>
</tr>
</tbody>
</table>
<h3 id="key-takeaways">Key Takeaways<a class="header-link" href="#key-takeaways" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Never hardcode secrets</strong> â€” use environment variables or a secret manager</li>
<li><strong>Scan continuously</strong> â€” use pre-commit hooks and CI/CD scanning</li>
<li><strong>Rotate regularly</strong> â€” automate rotation with zero-downtime patterns</li>
<li><strong>Encrypt at rest</strong> â€” use SOPS, Vault Transit, or cloud KMS</li>
<li><strong>Audit access</strong> â€” log who accessed what secret and when</li>
<li><strong>Minimize exposure</strong> â€” use short-lived credentials and least privilege</li>
<li><strong>Plan for compromise</strong> â€” have a runbook for when (not if) a secret leaks</li>
</ol>
<hr />
<p><strong>Previous</strong>: <a href="./10_API_Security.md">10_API_Security.md</a> | <strong>Next</strong>: <a href="./12_Container_Security.md">12_Container_Security.md</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/10_API_Security.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">API Security</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/12_Container_Security.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Container and Cloud Security</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}