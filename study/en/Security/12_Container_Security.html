{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Container and Cloud Security - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Security/">Security</a>
    <span class="separator">/</span>
    <span class="current">Container and Cloud Security</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Container and Cloud Security</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/11_Secrets_Management.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Secrets Management and Environment Configuration</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/13_Security_Testing.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Security Testing</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#1-docker-security-fundamentals">1. Docker Security Fundamentals</a><ul>
<li><a href="#11-container-threat-model">1.1 Container Threat Model</a></li>
<li><a href="#12-docker-security-principles">1.2 Docker Security Principles</a></li>
</ul>
</li>
<li><a href="#2-secure-dockerfiles">2. Secure Dockerfiles</a><ul>
<li><a href="#21-insecure-vs-secure-dockerfile">2.1 Insecure vs Secure Dockerfile</a></li>
<li><a href="#22-dockerignore">2.2 .dockerignore</a></li>
<li><a href="#23-multi-stage-build-patterns">2.3 Multi-Stage Build Patterns</a></li>
<li><a href="#24-base-image-comparison">2.4 Base Image Comparison</a></li>
</ul>
</li>
<li><a href="#3-image-scanning">3. Image Scanning</a><ul>
<li><a href="#31-trivy-comprehensive-scanner">3.1 Trivy (Comprehensive Scanner)</a></li>
<li><a href="#32-hadolint-dockerfile-linter">3.2 Hadolint (Dockerfile Linter)</a></li>
<li><a href="#33-snyk-container-scanning">3.3 Snyk Container Scanning</a></li>
</ul>
</li>
<li><a href="#4-image-signing-and-verification">4. Image Signing and Verification</a><ul>
<li><a href="#41-why-sign-images">4.1 Why Sign Images?</a></li>
<li><a href="#42-cosign-sigstore">4.2 Cosign (Sigstore)</a></li>
</ul>
</li>
<li><a href="#5-kubernetes-security">5. Kubernetes Security</a><ul>
<li><a href="#51-kubernetes-security-layers">5.1 Kubernetes Security Layers</a></li>
<li><a href="#52-rbac-role-based-access-control">5.2 RBAC (Role-Based Access Control)</a></li>
<li><a href="#53-network-policies">5.3 Network Policies</a></li>
<li><a href="#54-pod-security-standards">5.4 Pod Security Standards</a></li>
<li><a href="#55-kubernetes-security-checklist">5.5 Kubernetes Security Checklist</a></li>
</ul>
</li>
<li><a href="#6-service-mesh-security">6. Service Mesh Security</a><ul>
<li><a href="#61-mtls-with-istio">6.1 mTLS with Istio</a></li>
</ul>
</li>
<li><a href="#7-cloud-iam-best-practices">7. Cloud IAM Best Practices</a><ul>
<li><a href="#71-iam-principles">7.1 IAM Principles</a></li>
<li><a href="#72-aws-iam-policies">7.2 AWS IAM Policies</a></li>
</ul>
</li>
<li><a href="#8-infrastructure-as-code-security">8. Infrastructure as Code Security</a><ul>
<li><a href="#81-terraform-security">8.1 Terraform Security</a></li>
<li><a href="#82-scanning-iac-with-tfseccheckov">8.2 Scanning IaC with tfsec/Checkov</a></li>
</ul>
</li>
<li><a href="#9-runtime-security-monitoring">9. Runtime Security Monitoring</a><ul>
<li><a href="#91-falco-runtime-threat-detection">9.1 Falco (Runtime Threat Detection)</a></li>
</ul>
</li>
<li><a href="#10-supply-chain-security">10. Supply Chain Security</a><ul>
<li><a href="#101-software-bill-of-materials-sbom">10.1 Software Bill of Materials (SBOM)</a></li>
<li><a href="#102-slsa-supply-chain-levels-for-software-artifacts">10.2 SLSA (Supply Chain Levels for Software Artifacts)</a></li>
</ul>
</li>
<li><a href="#11-exercises">11. Exercises</a><ul>
<li><a href="#exercise-1-secure-dockerfile-challenge">Exercise 1: Secure Dockerfile Challenge</a></li>
<li><a href="#exercise-2-kubernetes-security-hardening">Exercise 2: Kubernetes Security Hardening</a></li>
<li><a href="#exercise-3-container-image-scanner">Exercise 3: Container Image Scanner</a></li>
<li><a href="#exercise-4-cloud-iam-audit-tool">Exercise 4: Cloud IAM Audit Tool</a></li>
<li><a href="#exercise-5-terraform-security-scanner">Exercise 5: Terraform Security Scanner</a></li>
<li><a href="#exercise-6-supply-chain-security-pipeline">Exercise 6: Supply Chain Security Pipeline</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a><ul>
<li><a href="#container-security-checklist">Container Security Checklist</a></li>
<li><a href="#key-takeaways">Key Takeaways</a></li>
</ul>
</li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="container-and-cloud-security">Container and Cloud Security<a class="header-link" href="#container-and-cloud-security" title="Permanent link">&para;</a></h1>
<p><strong>Previous</strong>: <a href="./11_Secrets_Management.md">11_Secrets_Management.md</a> | <strong>Next</strong>: <a href="./13_Security_Testing.md">13. Security Testing</a></p>
<hr />
<p>Containers revolutionized software deployment, but they also introduced a new attack surface. A vulnerable base image, an overly permissive Dockerfile, or a misconfigured Kubernetes cluster can expose your entire infrastructure. Cloud environments add further complexity with IAM policies, network configurations, and shared responsibility models. This lesson covers security best practices across the container and cloud stack â€” from building minimal, hardened images to implementing Kubernetes security policies and cloud IAM governance.</p>
<h2 id="learning-objectives">Learning Objectives<a class="header-link" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<ul>
<li>Write secure Dockerfiles that minimize attack surface</li>
<li>Choose and audit minimal base images (distroless, Alpine, scratch)</li>
<li>Scan container images for vulnerabilities using Trivy, Snyk, and Hadolint</li>
<li>Sign and verify container images with cosign and Sigstore</li>
<li>Implement Kubernetes security controls (RBAC, NetworkPolicy, Pod Security Standards)</li>
<li>Configure service mesh security with mTLS</li>
<li>Apply cloud IAM best practices across AWS, GCP, and Azure</li>
<li>Secure Infrastructure as Code (Terraform, CloudFormation)</li>
<li>Monitor container runtime security</li>
<li>Understand supply chain security with SBOM and SLSA</li>
</ul>
<hr />
<h2 id="1-docker-security-fundamentals">1. Docker Security Fundamentals<a class="header-link" href="#1-docker-security-fundamentals" title="Permanent link">&para;</a></h2>
<h3 id="11-container-threat-model">1.1 Container Threat Model<a class="header-link" href="#11-container-threat-model" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="nx">Container</span><span class="w"> </span><span class="nx">Threat</span><span class="w"> </span><span class="nx">Model</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                    </span><span class="nx">Host</span><span class="w"> </span><span class="nx">OS</span><span class="w">                            </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                       </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">              </span><span class="nx">Container</span><span class="w"> </span><span class="nx">Runtime</span><span class="w">                </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                               </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">         </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="nx">Container</span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="nx">Container</span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="nx">Container</span><span class="err">â”‚</span><span class="w">        </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="nx">A</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="nx">B</span><span class="w">     </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="nx">C</span><span class="w">     </span><span class="err">â”‚</span><span class="w">        </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”Œâ”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”Œâ”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”Œâ”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="nx">App</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="nx">App</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="nx">App</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â””â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â””â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â””â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">         </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Attack</span><span class="w"> </span><span class="nx">vectors</span><span class="p">:</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="nx">Vulnerable</span><span class="w"> </span><span class="kd">base</span><span class="w"> </span><span class="nx">images</span><span class="w"> </span><span class="p">(</span><span class="nx">CVEs</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">OS</span><span class="w"> </span><span class="nx">packages</span><span class="p">)</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="nx">Application</span><span class="w"> </span><span class="nx">vulnerabilities</span><span class="w"> </span><span class="p">(</span><span class="nx">dependency</span><span class="w"> </span><span class="nx">CVEs</span><span class="p">)</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="nx">Misconfured</span><span class="w"> </span><span class="nx">containers</span><span class="w"> </span><span class="p">(</span><span class="nx">running</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nx">root</span><span class="p">,</span><span class="w"> </span><span class="nx">excessive</span><span class="w"> </span><span class="nx">caps</span><span class="p">)</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="nx">Container</span><span class="w"> </span><span class="nx">escape</span><span class="w"> </span><span class="p">(</span><span class="nx">kernel</span><span class="w"> </span><span class="nx">exploits</span><span class="p">,</span><span class="w"> </span><span class="nx">mount</span><span class="w"> </span><span class="nx">escapes</span><span class="p">)</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="nx">Image</span><span class="w"> </span><span class="nx">tampering</span><span class="w"> </span><span class="p">(</span><span class="nx">supply</span><span class="w"> </span><span class="nx">chain</span><span class="w"> </span><span class="nx">attacks</span><span class="p">)</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">6</span><span class="p">.</span><span class="w"> </span><span class="nx">Secrets</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">images</span><span class="w"> </span><span class="p">(</span><span class="nx">embedded</span><span class="w"> </span><span class="nx">credentials</span><span class="p">)</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">7</span><span class="p">.</span><span class="w"> </span><span class="nx">Excessive</span><span class="w"> </span><span class="nx">network</span><span class="w"> </span><span class="nx">access</span><span class="w"> </span><span class="p">(</span><span class="nx">no</span><span class="w"> </span><span class="nx">network</span><span class="w"> </span><span class="nx">isolation</span><span class="p">)</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">8</span><span class="p">.</span><span class="w"> </span><span class="nx">Resource</span><span class="w"> </span><span class="nx">exhaustion</span><span class="w"> </span><span class="p">(</span><span class="nx">no</span><span class="w"> </span><span class="nx">limits</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">noisy</span><span class="w"> </span><span class="nx">neighbor</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">DoS</span><span class="p">)</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Containers</span><span class="w"> </span><span class="nx">share</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="nx">kernel</span><span class="w"> </span><span class="err">â€”</span><span class="w"> </span><span class="nx">they</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">NOT</span><span class="w"> </span><span class="nx">VMs</span><span class="p">.</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">A</span><span class="w"> </span><span class="nx">kernel</span><span class="w"> </span><span class="nx">exploit</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">compromise</span><span class="w"> </span><span class="nx">ALL</span><span class="w"> </span><span class="nx">containers</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">host</span><span class="p">.</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="12-docker-security-principles">1.2 Docker Security Principles<a class="header-link" href="#12-docker-security-principles" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="n">Container</span><span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="n">Principles</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">Minimal</span><span class="w"> </span><span class="n">Attack</span><span class="w"> </span><span class="n">Surface</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">smallest</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">image</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Install</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="n">packages</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Remove</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="n">tools</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">final</span><span class="w"> </span><span class="n">image</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">Least</span><span class="w"> </span><span class="n">Privilege</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Run</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">root</span><span class="w"> </span><span class="n">user</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Drop</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">capabilities</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">needed</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Use</span><span class="w"> </span><span class="n">read</span><span class="o">-</span><span class="n">only</span><span class="w"> </span><span class="n">filesystem</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">possible</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="n">Immutability</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Images</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">built</span><span class="w"> </span><span class="n">once</span><span class="p">,</span><span class="w"> </span><span class="n">deployed</span><span class="w"> </span><span class="n">many</span><span class="w"> </span><span class="n">times</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Never</span><span class="w"> </span><span class="n">patch</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="err">â€”</span><span class="w"> </span><span class="n">rebuild</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">redeploy</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Tag</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">digests</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="n">tags</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">4.</span><span class="w"> </span><span class="n">Defense</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">Depth</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Scan</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">build</span><span class="p">,</span><span class="w"> </span><span class="n">push</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">deploy</span><span class="w"> </span><span class="n">time</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Network</span><span class="w"> </span><span class="n">policies</span><span class="w"> </span><span class="n">between</span><span class="w"> </span><span class="n">containers</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Runtime</span><span class="w"> </span><span class="n">monitoring</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">anomalous</span><span class="w"> </span><span class="n">behavior</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">5.</span><span class="w"> </span><span class="n">Verifiable</span><span class="w">                                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Sign</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">verify</span><span class="w"> </span><span class="n">signatures</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">deployment</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Generate</span><span class="w"> </span><span class="n">SBOM</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">every</span><span class="w"> </span><span class="n">image</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Pin</span><span class="w"> </span><span class="n">dependencies</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">exact</span><span class="w"> </span><span class="n">versions</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="2-secure-dockerfiles">2. Secure Dockerfiles<a class="header-link" href="#2-secure-dockerfiles" title="Permanent link">&para;</a></h2>
<h3 id="21-insecure-vs-secure-dockerfile">2.1 Insecure vs Secure Dockerfile<a class="header-link" href="#21-insecure-vs-secure-dockerfile" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c"># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="c"># BAD: Insecure Dockerfile (common mistakes)</span>
<span class="c"># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.12</span><span class="w">                    </span><span class="c"># Full image (900MB+), many packages</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.<span class="w">                             </span>#<span class="w"> </span>Copies<span class="w"> </span>everything<span class="w"> </span>including<span class="w"> </span>.env,<span class="w"> </span>.git
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt<span class="w">  </span>#<span class="w"> </span>Runs<span class="w"> </span>as<span class="w"> </span>root
<span class="k">ENV</span><span class="w"> </span><span class="nv">API_KEY</span><span class="o">=</span>sk_live_xxxxx<span class="w">            </span><span class="c"># Secret baked into image</span>
<span class="k">EXPOSE</span><span class="w"> </span><span class="s">8000</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;app.py&quot;</span><span class="p">]</span><span class="w">             </span>#<span class="w"> </span>Runs<span class="w"> </span>as<span class="w"> </span>root
<span class="c"># Problems:</span>
<span class="c"># - Runs as root</span>
<span class="c"># - Large attack surface (full OS)</span>
<span class="c"># - Secrets in environment/image layers</span>
<span class="c"># - Copies unnecessary files</span>
<span class="c"># - No health check</span>
<span class="c"># - No resource limits defined</span>


<span class="c"># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="c"># GOOD: Secure Dockerfile (best practices)</span>
<span class="c"># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="c"># Stage 1: Build</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.12-slim</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">builder</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/build</span>

<span class="c"># Install dependencies first (layer caching)</span>
<span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span>.
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>--user<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="c"># Copy application code</span>
<span class="k">COPY</span><span class="w"> </span>src/<span class="w"> </span>./src/

<span class="c"># Stage 2: Production</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.12-slim</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">production</span>

<span class="c"># Security: Create non-root user</span>
<span class="k">RUN</span><span class="w"> </span>groupadd<span class="w"> </span>-r<span class="w"> </span>appuser<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>useradd<span class="w"> </span>-r<span class="w"> </span>-g<span class="w"> </span>appuser<span class="w"> </span>-d<span class="w"> </span>/app<span class="w"> </span>-s<span class="w"> </span>/sbin/nologin<span class="w"> </span>appuser

<span class="c"># Install only runtime dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--no-install-recommends<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>tini<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="c"># Copy only what we need from builder</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/root/.local<span class="w"> </span>/home/appuser/.local
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/build/src<span class="w"> </span>./src/

<span class="c"># Set PATH for user-installed packages</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>/home/appuser/.local/bin:<span class="nv">$PATH</span>

<span class="c"># Security: Set ownership and switch to non-root</span>
<span class="k">RUN</span><span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span>appuser:appuser<span class="w"> </span>/app
<span class="k">USER</span><span class="w"> </span><span class="s">appuser</span>

<span class="c"># Security: Read-only filesystem friendly</span>
<span class="k">VOLUME</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/tmp&quot;</span><span class="p">]</span>

<span class="c"># Health check</span>
<span class="k">HEALTHCHECK</span><span class="w"> </span>--interval<span class="o">=</span>30s<span class="w"> </span>--timeout<span class="o">=</span>5s<span class="w"> </span>--start-period<span class="o">=</span>10s<span class="w"> </span>--retries<span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>CMD<span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import urllib.request; urllib.request.urlopen(&#39;http://localhost:8000/health&#39;)&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>

<span class="k">EXPOSE</span><span class="w"> </span><span class="s">8000</span>

<span class="c"># Use tini as init process (proper signal handling)</span>
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;tini&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--&quot;</span><span class="p">]</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;uvicorn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;src.app:app&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--host&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--port&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;8000&quot;</span><span class="p">]</span>
</code></pre></div>

<h3 id="22-dockerignore">2.2 .dockerignore<a class="header-link" href="#22-dockerignore" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># .dockerignore â€” Exclude files from Docker build context</span>
<span class="c1"># This is critical for security AND build performance</span>

<span class="c1"># Version control</span>
<span class="na">.git</span>
<span class="na">.gitignore</span>

<span class="c1"># Environment and secrets</span>
<span class="na">.env</span>
<span class="na">.env.</span><span class="p">*</span>
<span class="err">*</span><span class="na">.pem</span>
<span class="err">*</span><span class="na">.key</span>
<span class="nf">credentials.json</span>

<span class="c1"># Python</span>
<span class="nf">__pycache__</span>
<span class="err">*</span><span class="na">.pyc</span>
<span class="err">*</span><span class="na">.pyo</span>
<span class="na">.venv</span>
<span class="nf">venv</span>
<span class="na">.pytest_cache</span>
<span class="na">.mypy_cache</span>
<span class="na">.coverage</span>
<span class="nf">htmlcov</span>

<span class="c1"># IDE</span>
<span class="na">.vscode</span>
<span class="na">.idea</span>
<span class="err">*</span><span class="na">.swp</span>
<span class="err">*</span><span class="na">.swo</span>

<span class="c1"># Docker</span>
<span class="nf">Dockerfile</span><span class="p">*</span>
<span class="nf">docker-compose</span><span class="p">*.</span><span class="no">yml</span>

<span class="c1"># Documentation</span>
<span class="nf">README.md</span>
<span class="nf">docs</span><span class="err">/</span>
<span class="err">*</span><span class="na">.md</span>

<span class="c1"># CI/CD</span>
<span class="na">.github</span>
<span class="na">.gitlab-ci.yml</span>

<span class="c1"># OS files</span>
<span class="na">.DS_Store</span>
<span class="nf">Thumbs.db</span>
</code></pre></div>

<h3 id="23-multi-stage-build-patterns">2.3 Multi-Stage Build Patterns<a class="header-link" href="#23-multi-stage-build-patterns" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c"># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="c"># Pattern 1: Go application â€” build from scratch</span>
<span class="c"># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">golang:1.22</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">builder</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/build</span>
<span class="k">COPY</span><span class="w"> </span>go.mod<span class="w"> </span>go.sum<span class="w"> </span>./
<span class="k">RUN</span><span class="w"> </span>go<span class="w"> </span>mod<span class="w"> </span>download

<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.
<span class="c"># Build static binary (no external dependencies)</span>
<span class="k">RUN</span><span class="w"> </span><span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">GOOS</span><span class="o">=</span>linux<span class="w"> </span><span class="nv">GOARCH</span><span class="o">=</span>amd64<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>go<span class="w"> </span>build<span class="w"> </span>-ldflags<span class="o">=</span><span class="s2">&quot;-w -s&quot;</span><span class="w"> </span>-o<span class="w"> </span>/app/server<span class="w"> </span>./cmd/server

<span class="c"># Final image: scratch (literally empty â€” ~0 MB base)</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">scratch</span>

<span class="c"># Import CA certificates for HTTPS</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/etc/ssl/certs/ca-certificates.crt<span class="w"> </span>/etc/ssl/certs/
<span class="c"># Import timezone data</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/usr/share/zoneinfo<span class="w"> </span>/usr/share/zoneinfo

<span class="c"># Copy the binary</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/app/server<span class="w"> </span>/server

<span class="c"># Non-root user (numeric UID since scratch has no /etc/passwd)</span>
<span class="k">USER</span><span class="w"> </span><span class="s">65534</span>

<span class="k">EXPOSE</span><span class="w"> </span><span class="s">8080</span>
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/server&quot;</span><span class="p">]</span>


<span class="c"># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="c"># Pattern 2: Node.js â€” distroless image</span>
<span class="c"># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">node:20-slim</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">builder</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/build</span>
<span class="k">COPY</span><span class="w"> </span>package.json<span class="w"> </span>package-lock.json<span class="w"> </span>./
<span class="k">RUN</span><span class="w"> </span>npm<span class="w"> </span>ci<span class="w"> </span>--only<span class="o">=</span>production

<span class="k">COPY</span><span class="w"> </span>src/<span class="w"> </span>./src/

<span class="c"># Final image: distroless (no shell, no package manager)</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">gcr.io/distroless/nodejs20-debian12</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/build/node_modules<span class="w"> </span>./node_modules
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/build/src<span class="w"> </span>./src

<span class="c"># Distroless runs as nonroot by default</span>
<span class="k">USER</span><span class="w"> </span><span class="s">nonroot</span>

<span class="k">EXPOSE</span><span class="w"> </span><span class="s">3000</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;src/index.js&quot;</span><span class="p">]</span>


<span class="c"># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="c"># Pattern 3: Python â€” Alpine (small but has shell)</span>
<span class="c"># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.12-alpine</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">builder</span>

<span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>--no-cache<span class="w"> </span>build-base

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/build</span>
<span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span>.
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>--prefix<span class="o">=</span>/install<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.12-alpine</span>

<span class="c"># Security hardening</span>
<span class="k">RUN</span><span class="w"> </span>addgroup<span class="w"> </span>-S<span class="w"> </span>appuser<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>adduser<span class="w"> </span>-S<span class="w"> </span>-G<span class="w"> </span>appuser<span class="w"> </span>appuser<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>apk<span class="w"> </span>add<span class="w"> </span>--no-cache<span class="w"> </span>tini

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/install<span class="w"> </span>/usr/local
<span class="k">COPY</span><span class="w"> </span>src/<span class="w"> </span>./src/

<span class="k">RUN</span><span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span>appuser:appuser<span class="w"> </span>/app
<span class="k">USER</span><span class="w"> </span><span class="s">appuser</span>

<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;tini&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--&quot;</span><span class="p">]</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;src.app&quot;</span><span class="p">]</span>
</code></pre></div>

<h3 id="24-base-image-comparison">2.4 Base Image Comparison<a class="header-link" href="#24-base-image-comparison" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Base Image</th>
<th>Size</th>
<th>Shell</th>
<th>Package Mgr</th>
<th>CVEs</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ubuntu:24.04</code></td>
<td>~75 MB</td>
<td>Yes</td>
<td>apt</td>
<td>Medium</td>
<td>Full OS needed</td>
</tr>
<tr>
<td><code>debian:bookworm-slim</code></td>
<td>~80 MB</td>
<td>Yes</td>
<td>apt</td>
<td>Medium</td>
<td>General purpose</td>
</tr>
<tr>
<td><code>alpine:3.19</code></td>
<td>~7 MB</td>
<td>Yes</td>
<td>apk</td>
<td>Low</td>
<td>Small with shell</td>
</tr>
<tr>
<td><code>python:3.12-slim</code></td>
<td>~150 MB</td>
<td>Yes</td>
<td>apt + pip</td>
<td>Medium</td>
<td>Python apps</td>
</tr>
<tr>
<td><code>python:3.12-alpine</code></td>
<td>~55 MB</td>
<td>Yes</td>
<td>apk + pip</td>
<td>Low</td>
<td>Python (small)</td>
</tr>
<tr>
<td><code>gcr.io/distroless/python3</code></td>
<td>~50 MB</td>
<td>No</td>
<td>None</td>
<td>Very Low</td>
<td>Python (hardened)</td>
</tr>
<tr>
<td><code>gcr.io/distroless/static</code></td>
<td>~2 MB</td>
<td>No</td>
<td>None</td>
<td>Minimal</td>
<td>Static binaries</td>
</tr>
<tr>
<td><code>scratch</code></td>
<td>0 MB</td>
<td>No</td>
<td>None</td>
<td>None</td>
<td>Go/Rust static</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="nx">Base</span><span class="w"> </span><span class="nx">Image</span><span class="w"> </span><span class="nx">Decision</span><span class="w"> </span><span class="nx">Tree</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Need</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">debugging</span><span class="p">?</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Yes</span><span class="p">:</span><span class="w"> </span><span class="nx">Alpine</span><span class="w"> </span><span class="p">(</span><span class="nx">small</span><span class="p">)</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">Debian</span><span class="o">-</span><span class="nx">slim</span><span class="w"> </span><span class="p">(</span><span class="nx">compatible</span><span class="p">)</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">No</span><span class="p">:</span><span class="w">                                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">Static</span><span class="w"> </span><span class="nx">binary</span><span class="w"> </span><span class="p">(</span><span class="nx">Go</span><span class="p">,</span><span class="w"> </span><span class="nx">Rust</span><span class="p">)?</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">            </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Yes</span><span class="p">:</span><span class="w"> </span><span class="nx">scratch</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">distroless</span><span class="o">/</span><span class="nx">static</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">            </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">No</span><span class="p">:</span><span class="w">  </span><span class="nx">distroless</span><span class="o">/</span><span class="p">&lt;</span><span class="nx">language</span><span class="p">&gt;</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">General</span><span class="w"> </span><span class="nx">recommendations</span><span class="p">:</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">Development</span><span class="p">:</span><span class="w"> </span><span class="nx">language</span><span class="o">-</span><span class="nx">slim</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">g</span><span class="p">.,</span><span class="w"> </span><span class="nx">python</span><span class="p">:</span><span class="m m-Double">3.12</span><span class="o">-</span><span class="nx">slim</span><span class="p">)</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">Production</span><span class="p">:</span><span class="w">  </span><span class="nx">distroless</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">Alpine</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">Maximum</span><span class="w"> </span><span class="nx">security</span><span class="p">:</span><span class="w"> </span><span class="nx">scratch</span><span class="w"> </span><span class="p">(</span><span class="nx">requires</span><span class="w"> </span><span class="nx">static</span><span class="w"> </span><span class="nx">binary</span><span class="p">)</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Alpine</span><span class="w"> </span><span class="nx">caveats</span><span class="p">:</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">Uses</span><span class="w"> </span><span class="nx">musl</span><span class="w"> </span><span class="nx">libc</span><span class="w"> </span><span class="p">(</span><span class="k">not</span><span class="w"> </span><span class="nx">glibc</span><span class="p">)</span><span class="w"> </span><span class="err">â€”</span><span class="w"> </span><span class="nx">some</span><span class="w"> </span><span class="nx">packages</span><span class="w"> </span><span class="nx">may</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">work</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">Python</span><span class="w"> </span><span class="nx">wheels</span><span class="w"> </span><span class="nx">may</span><span class="w"> </span><span class="nx">need</span><span class="w"> </span><span class="nx">compilation</span><span class="w"> </span><span class="p">(</span><span class="nx">slower</span><span class="w"> </span><span class="nx">builds</span><span class="p">)</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â€¢</span><span class="w"> </span><span class="nx">DNS</span><span class="w"> </span><span class="nx">resolution</span><span class="w"> </span><span class="nx">differs</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">glibc</span><span class="o">-</span><span class="nx">based</span><span class="w"> </span><span class="nx">images</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<h2 id="3-image-scanning">3. Image Scanning<a class="header-link" href="#3-image-scanning" title="Permanent link">&para;</a></h2>
<h3 id="31-trivy-comprehensive-scanner">3.1 Trivy (Comprehensive Scanner)<a class="header-link" href="#31-trivy-comprehensive-scanner" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Install Trivy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
brew<span class="w"> </span>install<span class="w"> </span>trivy<span class="w">          </span><span class="c1"># macOS</span>
apt-get<span class="w"> </span>install<span class="w"> </span>trivy<span class="w">       </span><span class="c1"># Debian/Ubuntu (add aquasecurity repo first)</span>

<span class="c1"># â”€â”€ Scan a Docker image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
trivy<span class="w"> </span>image<span class="w"> </span>python:3.12-slim

<span class="c1"># â”€â”€ Scan with severity filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
trivy<span class="w"> </span>image<span class="w"> </span>--severity<span class="w"> </span>CRITICAL,HIGH<span class="w"> </span>python:3.12-slim

<span class="c1"># â”€â”€ Fail if vulnerabilities found (for CI/CD) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
trivy<span class="w"> </span>image<span class="w"> </span>--exit-code<span class="w"> </span><span class="m">1</span><span class="w"> </span>--severity<span class="w"> </span>CRITICAL<span class="w"> </span>myapp:latest

<span class="c1"># â”€â”€ Scan a Dockerfile (misconfiguration) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
trivy<span class="w"> </span>config<span class="w"> </span>Dockerfile

<span class="c1"># â”€â”€ Scan a filesystem (application dependencies) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
trivy<span class="w"> </span>fs<span class="w"> </span>--scanners<span class="w"> </span>vuln,secret,misconfig<span class="w"> </span>/path/to/project

<span class="c1"># â”€â”€ Generate SBOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
trivy<span class="w"> </span>image<span class="w"> </span>--format<span class="w"> </span>spdx-json<span class="w"> </span>--output<span class="w"> </span>sbom.json<span class="w"> </span>myapp:latest

<span class="c1"># â”€â”€ Scan Kubernetes manifests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
trivy<span class="w"> </span>config<span class="w"> </span>k8s-manifests/

<span class="c1"># â”€â”€ JSON output for programmatic processing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
trivy<span class="w"> </span>image<span class="w"> </span>--format<span class="w"> </span>json<span class="w"> </span>--output<span class="w"> </span>results.json<span class="w"> </span>myapp:latest

<span class="c1"># â”€â”€ Ignore unfixed vulnerabilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
trivy<span class="w"> </span>image<span class="w"> </span>--ignore-unfixed<span class="w"> </span>myapp:latest
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Trivy in GitHub Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># .github/workflows/security.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Security Scan</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">trivy-scan</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Build image</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker build -t myapp:${{ github.sha }} .</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run Trivy vulnerability scanner</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aquasecurity/trivy-action@master</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">image-ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;myapp:${{</span><span class="nv"> </span><span class="s">github.sha</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">          </span><span class="nt">format</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;sarif&#39;</span>
<span class="w">          </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;trivy-results.sarif&#39;</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;CRITICAL,HIGH&#39;</span>
<span class="w">          </span><span class="nt">exit-code</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1&#39;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload Trivy scan results</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">github/codeql-action/upload-sarif@v3</span>
<span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always()</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">sarif_file</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;trivy-results.sarif&#39;</span>
</code></pre></div>

<h3 id="32-hadolint-dockerfile-linter">3.2 Hadolint (Dockerfile Linter)<a class="header-link" href="#32-hadolint-dockerfile-linter" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Install Hadolint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
brew<span class="w"> </span>install<span class="w"> </span>hadolint<span class="w">        </span><span class="c1"># macOS</span>
<span class="c1"># Or use Docker:</span>
docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>-i<span class="w"> </span>hadolint/hadolint<span class="w"> </span>&lt;<span class="w"> </span>Dockerfile

<span class="c1"># â”€â”€ Lint a Dockerfile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
hadolint<span class="w"> </span>Dockerfile

<span class="c1"># â”€â”€ Example output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Dockerfile:3 DL3006 warning: Always tag the version of an image explicitly</span>
<span class="c1"># Dockerfile:7 DL3008 warning: Pin versions in apt-get install</span>
<span class="c1"># Dockerfile:7 DL3009 info: Delete apt-get lists after installing</span>
<span class="c1"># Dockerfile:12 DL3025 warning: Use arguments JSON notation for CMD</span>
<span class="c1"># Dockerfile:5 DL3045 warning: COPY to a relative destination without WORKDIR</span>

<span class="c1"># â”€â”€ Ignore specific rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
hadolint<span class="w"> </span>--ignore<span class="w"> </span>DL3008<span class="w"> </span>--ignore<span class="w"> </span>DL3013<span class="w"> </span>Dockerfile

<span class="c1"># â”€â”€ Configuration file â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># .hadolint.yaml</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># .hadolint.yaml</span>
<span class="nt">ignored</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DL3008</span><span class="w">   </span><span class="c1"># Pin versions in apt-get (sometimes impractical)</span>

<span class="nt">trustedRegistries</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker.io</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gcr.io</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io</span>

<span class="nt">override</span><span class="p">:</span>
<span class="w">  </span><span class="nt">error</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DL3001</span><span class="w">  </span><span class="c1"># Pipe to install with no version</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DL3002</span><span class="w">  </span><span class="c1"># Last user should not be root</span>
<span class="w">  </span><span class="nt">warning</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DL3003</span><span class="w">  </span><span class="c1"># Use WORKDIR</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DL3006</span><span class="w">  </span><span class="c1"># Always tag image version</span>
<span class="w">  </span><span class="nt">info</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DL3007</span><span class="w">  </span><span class="c1"># Using latest tag</span>
</code></pre></div>

<h3 id="33-snyk-container-scanning">3.3 Snyk Container Scanning<a class="header-link" href="#33-snyk-container-scanning" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Install Snyk CLI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
npm<span class="w"> </span>install<span class="w"> </span>-g<span class="w"> </span>snyk
snyk<span class="w"> </span>auth<span class="w">  </span><span class="c1"># Authenticate</span>

<span class="c1"># â”€â”€ Scan a Docker image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
snyk<span class="w"> </span>container<span class="w"> </span><span class="nb">test</span><span class="w"> </span>myapp:latest

<span class="c1"># â”€â”€ Scan with Dockerfile for better remediation advice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
snyk<span class="w"> </span>container<span class="w"> </span><span class="nb">test</span><span class="w"> </span>myapp:latest<span class="w"> </span>--file<span class="o">=</span>Dockerfile

<span class="c1"># â”€â”€ Monitor (continuous scanning) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
snyk<span class="w"> </span>container<span class="w"> </span>monitor<span class="w"> </span>myapp:latest

<span class="c1"># â”€â”€ Generate SBOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
snyk<span class="w"> </span>container<span class="w"> </span>sbom<span class="w"> </span>myapp:latest<span class="w"> </span>--format<span class="o">=</span>spdx-json<span class="w"> </span>&gt;<span class="w"> </span>sbom.json
</code></pre></div>

<hr />
<h2 id="4-image-signing-and-verification">4. Image Signing and Verification<a class="header-link" href="#4-image-signing-and-verification" title="Permanent link">&para;</a></h2>
<h3 id="41-why-sign-images">4.1 Why Sign Images?<a class="header-link" href="#41-why-sign-images" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                    </span><span class="nv">Image</span><span class="w"> </span><span class="nv">Supply</span><span class="w"> </span><span class="nv">Chain</span><span class="w"> </span><span class="nv">Attack</span><span class="w">                          </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Without</span><span class="w"> </span><span class="nv">signing</span>:<span class="w">                                                    </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Developer</span><span class="w"> </span>â”€â”€<span class="nv">push</span>â”€â”€â–¶<span class="w"> </span><span class="nv">Registry</span><span class="w"> </span>â”€â”€<span class="nv">pull</span>â”€â”€â–¶<span class="w"> </span><span class="nv">Production</span><span class="w">                  </span>â”‚
â”‚<span class="w">                          </span>â†‘<span class="w">                                           </span>â”‚
â”‚<span class="w">                      </span><span class="nv">Attacker</span><span class="w"> </span><span class="nv">replaces</span><span class="w">                                </span>â”‚
â”‚<span class="w">                      </span><span class="nv">image</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">malicious</span><span class="w">                             </span>â”‚
â”‚<span class="w">                      </span><span class="nv">version</span><span class="w"> </span><span class="ss">(</span><span class="nv">same</span><span class="w"> </span><span class="nv">tag</span><span class="ss">)</span><span class="w">                               </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">With</span><span class="w"> </span><span class="nv">signing</span><span class="w"> </span><span class="ss">(</span><span class="nv">cosign</span><span class="ss">)</span>:<span class="w">                                              </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Developer</span><span class="w"> </span>â”€â”€<span class="nv">push</span>â”€â”€â–¶<span class="w"> </span><span class="nv">Registry</span><span class="w"> </span>â”€â”€<span class="nv">pull</span>â”€â”€â–¶<span class="w"> </span><span class="nv">Verify</span><span class="w"> </span><span class="nv">Signature</span><span class="w"> </span>â”€â”€â–¶<span class="w"> </span><span class="nv">Deploy</span><span class="w"> </span>â”‚
â”‚<span class="w">       </span>â”‚<span class="w">                  </span>â”‚<span class="w">                     </span>â†‘<span class="w">                     </span>â”‚
â”‚<span class="w">       </span>â””â”€â”€<span class="nv">sign</span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">                     </span>â”‚<span class="w">                     </span>â”‚
â”‚<span class="w">                                           </span><span class="nv">Reject</span><span class="w"> </span><span class="k">if</span><span class="w">                  </span>â”‚
â”‚<span class="w">                                           </span><span class="nv">signature</span><span class="w">                  </span>â”‚
â”‚<span class="w">                                           </span><span class="nv">invalid</span><span class="w">                    </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Signing</span><span class="w"> </span><span class="nv">guarantees</span>:<span class="w">                                                 </span>â”‚
â”‚<span class="w">  </span><span class="mi">1</span>.<span class="w"> </span><span class="nv">Integrity</span>:<span class="w"> </span><span class="nv">image</span><span class="w"> </span><span class="nv">has</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">been</span><span class="w"> </span><span class="nv">modified</span><span class="w">                           </span>â”‚
â”‚<span class="w">  </span><span class="mi">2</span>.<span class="w"> </span><span class="nv">Authenticity</span>:<span class="w"> </span><span class="nv">image</span><span class="w"> </span><span class="nv">was</span><span class="w"> </span><span class="nv">built</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">trusted</span><span class="w"> </span><span class="nv">entity</span><span class="w">                </span>â”‚
â”‚<span class="w">  </span><span class="mi">3</span>.<span class="w"> </span><span class="nv">Non</span><span class="o">-</span><span class="nv">repudiation</span>:<span class="w"> </span><span class="nv">signer</span><span class="w"> </span><span class="nv">cannot</span><span class="w"> </span><span class="nv">deny</span><span class="w"> </span><span class="nv">signing</span><span class="w">                     </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="42-cosign-sigstore">4.2 Cosign (Sigstore)<a class="header-link" href="#42-cosign-sigstore" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Install cosign â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
brew<span class="w"> </span>install<span class="w"> </span>cosign

<span class="c1"># â”€â”€ Keyless signing (recommended â€” uses OIDC identity) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Sign an image (opens browser for OIDC auth)</span>
cosign<span class="w"> </span>sign<span class="w"> </span>myregistry.io/myapp:v1.0.0

<span class="c1"># Verify the signature</span>
cosign<span class="w"> </span>verify<span class="w"> </span>myregistry.io/myapp:v1.0.0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--certificate-identity<span class="w"> </span>user@example.com<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--certificate-oidc-issuer<span class="w"> </span>https://accounts.google.com

<span class="c1"># â”€â”€ Key-based signing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Generate a key pair</span>
cosign<span class="w"> </span>generate-key-pair

<span class="c1"># Sign with the private key</span>
cosign<span class="w"> </span>sign<span class="w"> </span>--key<span class="w"> </span>cosign.key<span class="w"> </span>myregistry.io/myapp:v1.0.0

<span class="c1"># Verify with the public key</span>
cosign<span class="w"> </span>verify<span class="w"> </span>--key<span class="w"> </span>cosign.pub<span class="w"> </span>myregistry.io/myapp:v1.0.0

<span class="c1"># â”€â”€ Sign with digest (more secure than tag) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Tags are mutable; digests are immutable</span>
<span class="nv">IMAGE_DIGEST</span><span class="o">=</span><span class="k">$(</span>docker<span class="w"> </span>inspect<span class="w"> </span>--format<span class="o">=</span><span class="s1">&#39;{{index .RepoDigests 0}}&#39;</span><span class="w"> </span>myapp:v1.0.0<span class="k">)</span>
cosign<span class="w"> </span>sign<span class="w"> </span>--key<span class="w"> </span>cosign.key<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$IMAGE_DIGEST</span><span class="s2">&quot;</span>

<span class="c1"># â”€â”€ Attach SBOM to image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
cosign<span class="w"> </span>attach<span class="w"> </span>sbom<span class="w"> </span>--sbom<span class="w"> </span>sbom.json<span class="w"> </span>myregistry.io/myapp:v1.0.0

<span class="c1"># â”€â”€ Verify in CI/CD before deployment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
cosign<span class="w"> </span>verify<span class="w"> </span>--key<span class="w"> </span>cosign.pub<span class="w"> </span>myregistry.io/myapp@sha256:abc123...<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Cosign in GitHub Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># .github/workflows/build-sign.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Build and Sign</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;v*&#39;</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build-and-sign</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">permissions</span><span class="p">:</span>
<span class="w">      </span><span class="nt">contents</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">      </span><span class="nt">id-token</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">write</span><span class="w">   </span><span class="c1"># Required for keyless signing</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sigstore/cosign-installer@v3</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Login to registry</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker/login-action@v3</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">registry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io</span>
<span class="w">          </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ github.actor }}</span>
<span class="w">          </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.GITHUB_TOKEN }}</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Build and push</span>
<span class="w">        </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker/build-push-action@v5</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">push</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/${{ github.repository }}:${{ github.ref_name }}</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Sign the image (keyless)</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cosign sign --yes ghcr.io/${{ github.repository }}@${{ steps.build.outputs.digest }}</span>
</code></pre></div>

<hr />
<h2 id="5-kubernetes-security">5. Kubernetes Security<a class="header-link" href="#5-kubernetes-security" title="Permanent link">&para;</a></h2>
<h3 id="51-kubernetes-security-layers">5.1 Kubernetes Security Layers<a class="header-link" href="#51-kubernetes-security-layers" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Kubernetes Security Layers                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Layer 1: Cluster Infrastructure                                     â”‚
â”‚  â”œâ”€â”€ API server authentication and encryption                        â”‚
â”‚  â”œâ”€â”€ etcd encryption at rest                                         â”‚
â”‚  â”œâ”€â”€ Node security (OS hardening, kubelet config)                    â”‚
â”‚  â””â”€â”€ Network encryption (TLS everywhere)                             â”‚
â”‚                                                                      â”‚
â”‚  Layer 2: Cluster Configuration                                      â”‚
â”‚  â”œâ”€â”€ RBAC (Role-Based Access Control)                                â”‚
â”‚  â”œâ”€â”€ Admission controllers (OPA/Gatekeeper, Kyverno)                â”‚
â”‚  â”œâ”€â”€ Pod Security Standards (Restricted/Baseline/Privileged)         â”‚
â”‚  â””â”€â”€ Network Policies                                                â”‚
â”‚                                                                      â”‚
â”‚  Layer 3: Application Security                                       â”‚
â”‚  â”œâ”€â”€ Image scanning and signing                                      â”‚
â”‚  â”œâ”€â”€ Secret management (External Secrets Operator)                   â”‚
â”‚  â”œâ”€â”€ Service mesh (mTLS with Istio/Linkerd)                         â”‚
â”‚  â””â”€â”€ Runtime security (Falco, Tetragon)                              â”‚
â”‚                                                                      â”‚
â”‚  Layer 4: Data Security                                              â”‚
â”‚  â”œâ”€â”€ Encryption at rest (StorageClass encryption)                    â”‚
â”‚  â”œâ”€â”€ Encryption in transit (mTLS)                                    â”‚
â”‚  â””â”€â”€ Backup and disaster recovery                                    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="52-rbac-role-based-access-control">5.2 RBAC (Role-Based Access Control)<a class="header-link" href="#52-rbac-role-based-access-control" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Principle: Grant minimum required permissions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>

<span class="c1"># Role: defines permissions within a namespace</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Role</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-reader</span>
<span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># Can read pods and their logs</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;pods&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;pods/log&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="c1"># Can read configmaps</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;configmaps&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="c1"># Cannot read secrets (intentionally excluded)</span>

<span class="nn">---</span>
<span class="c1"># RoleBinding: assigns role to a user/group/service account</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RoleBinding</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">developer-read-access</span>
<span class="nt">subjects</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Group</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">developers</span>
<span class="w">    </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring-sa</span>
<span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">roleRef</span><span class="p">:</span>
<span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Role</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-reader</span>
<span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>

<span class="nn">---</span>
<span class="c1"># ClusterRole: cluster-wide permissions</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">namespace-admin</span>
<span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;namespaces&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;apps&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;deployments&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;replicasets&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;watch&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;update&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;patch&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="c1"># Explicitly deny delete on namespaces</span>
<span class="w">  </span><span class="c1"># (by not including &quot;delete&quot; in verbs)</span>

<span class="nn">---</span>
<span class="c1"># ClusterRoleBinding</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">team-leads-namespace-admin</span>
<span class="nt">subjects</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Group</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">team-leads</span>
<span class="w">    </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<span class="nt">roleRef</span><span class="p">:</span>
<span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">namespace-admin</span>
<span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ RBAC Audit Commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>

<span class="c1"># List all roles and bindings</span>
kubectl<span class="w"> </span>get<span class="w"> </span>roles,rolebindings<span class="w"> </span>-A
kubectl<span class="w"> </span>get<span class="w"> </span>clusterroles,clusterrolebindings

<span class="c1"># Check what a user can do</span>
kubectl<span class="w"> </span>auth<span class="w"> </span>can-i<span class="w"> </span>--list<span class="w"> </span>--as<span class="w"> </span>developer@example.com

<span class="c1"># Check specific permission</span>
kubectl<span class="w"> </span>auth<span class="w"> </span>can-i<span class="w"> </span>create<span class="w"> </span>pods<span class="w"> </span>--namespace<span class="w"> </span>production<span class="w"> </span>--as<span class="w"> </span>developer@example.com

<span class="c1"># Find overly permissive bindings</span>
kubectl<span class="w"> </span>get<span class="w"> </span>clusterrolebindings<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>jq<span class="w"> </span><span class="s1">&#39;.items[] | select(.roleRef.name == &quot;cluster-admin&quot;) | .subjects&#39;</span>
</code></pre></div>

<h3 id="53-network-policies">5.3 Network Policies<a class="header-link" href="#53-network-policies" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Default: Deny all ingress and egress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-deny-all</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span><span class="w">  </span><span class="c1"># Applies to ALL pods in namespace</span>
<span class="w">  </span><span class="nt">policyTypes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Egress</span>
<span class="w">  </span><span class="c1"># No ingress or egress rules = deny all</span>

<span class="nn">---</span>
<span class="c1"># â”€â”€ Allow specific traffic patterns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Allow web pods to receive traffic from ingress controller</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allow-web-ingress</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<span class="w">  </span><span class="nt">policyTypes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="w">  </span><span class="nt">ingress</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">from</span><span class="p">:</span>
<span class="w">        </span><span class="c1"># Allow from ingress controller namespace</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">namespaceSelector</span><span class="p">:</span>
<span class="w">            </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
<span class="w">          </span><span class="nt">podSelector</span><span class="p">:</span>
<span class="w">            </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">              </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
<span class="w">      </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>

<span class="nn">---</span>
<span class="c1"># Allow web pods to connect to API pods</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allow-web-to-api</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api</span>
<span class="w">  </span><span class="nt">policyTypes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="w">  </span><span class="nt">ingress</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">from</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">podSelector</span><span class="p">:</span>
<span class="w">            </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">              </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<span class="w">      </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span>

<span class="nn">---</span>
<span class="c1"># Allow API pods to connect to database</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allow-api-to-db</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">database</span>
<span class="w">  </span><span class="nt">policyTypes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="w">  </span><span class="nt">ingress</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">from</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">podSelector</span><span class="p">:</span>
<span class="w">            </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">              </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api</span>
<span class="w">      </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span>

<span class="nn">---</span>
<span class="c1"># Allow DNS resolution for all pods</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allow-dns</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="w">  </span><span class="nt">policyTypes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Egress</span>
<span class="w">  </span><span class="nt">egress</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">to</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">namespaceSelector</span><span class="p">:</span>
<span class="w">            </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="w">      </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">UDP</span>
<span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">53</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">53</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Network Policy Visualization                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Internet                                                            â”‚
â”‚      â”‚                                                               â”‚
â”‚      â–¼                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ Ingress  â”‚â”€â”€â”€â–¶â”‚   Web    â”‚â”€â”€â”€â–¶â”‚   API    â”‚                       â”‚
â”‚  â”‚Controllerâ”‚    â”‚  :8080   â”‚    â”‚  :3000   â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                       â”‚                              â”‚
â”‚                                       â–¼                              â”‚
â”‚                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                                  â”‚ Database â”‚                        â”‚
â”‚                                  â”‚  :5432   â”‚                        â”‚
â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                      â”‚
â”‚  Blocked paths (by NetworkPolicy):                                   â”‚
â”‚  âœ— Internet â†’ API directly                                          â”‚
â”‚  âœ— Internet â†’ Database directly                                     â”‚
â”‚  âœ— Web â†’ Database directly                                          â”‚
â”‚  âœ— Any pod â†’ Internet (except DNS)                                  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="54-pod-security-standards">5.4 Pod Security Standards<a class="header-link" href="#54-pod-security-standards" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Pod Security Standards (PSS) â€” Restricted Level â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Applied via namespace labels (Kubernetes 1.25+)</span>

<span class="c1"># Label the namespace to enforce restricted security</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Enforce: reject pods that violate</span>
<span class="w">    </span><span class="nt">pod-security.kubernetes.io/enforce</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restricted</span>
<span class="w">    </span><span class="nt">pod-security.kubernetes.io/enforce-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latest</span>
<span class="w">    </span><span class="c1"># Warn: log a warning (but allow)</span>
<span class="w">    </span><span class="nt">pod-security.kubernetes.io/warn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restricted</span>
<span class="w">    </span><span class="nt">pod-security.kubernetes.io/warn-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latest</span>
<span class="w">    </span><span class="c1"># Audit: record in audit log</span>
<span class="w">    </span><span class="nt">pod-security.kubernetes.io/audit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restricted</span>
<span class="w">    </span><span class="nt">pod-security.kubernetes.io/audit-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latest</span>

<span class="nn">---</span>
<span class="c1"># Pod that meets restricted security standard</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secure-pod</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># Security: Don&#39;t use host namespaces</span>
<span class="w">  </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">hostPID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">hostIPC</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="w">  </span><span class="c1"># Security: Use non-root</span>
<span class="w">  </span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="w">    </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="w">    </span><span class="nt">fsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="w">    </span><span class="nt">seccompProfile</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RuntimeDefault</span>

<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myregistry.io/myapp@sha256:abc123...</span><span class="w">  </span><span class="c1"># Pin to digest</span>
<span class="w">      </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>

<span class="w">      </span><span class="c1"># Security context (container level)</span>
<span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">        </span><span class="nt">allowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">        </span><span class="nt">readOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">runAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="w">        </span><span class="nt">capabilities</span><span class="p">:</span>
<span class="w">          </span><span class="nt">drop</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ALL</span>
<span class="w">          </span><span class="c1"># Only add capabilities that are truly needed</span>
<span class="w">          </span><span class="c1"># add:</span>
<span class="w">          </span><span class="c1">#   - NET_BIND_SERVICE  # If binding to port &lt; 1024</span>

<span class="w">      </span><span class="c1"># Resource limits (prevent DoS)</span>
<span class="w">      </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">        </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;128Mi&quot;</span>
<span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;100m&quot;</span>
<span class="w">        </span><span class="nt">limits</span><span class="p">:</span>
<span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;512Mi&quot;</span>
<span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;500m&quot;</span>

<span class="w">      </span><span class="c1"># Writable directories via emptyDir</span>
<span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tmp</span>
<span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache</span>
<span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/app/cache</span>

<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tmp</span>
<span class="w">      </span><span class="nt">emptyDir</span><span class="p">:</span>
<span class="w">        </span><span class="nt">sizeLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100Mi</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache</span>
<span class="w">      </span><span class="nt">emptyDir</span><span class="p">:</span>
<span class="w">        </span><span class="nt">sizeLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200Mi</span>

<span class="w">  </span><span class="c1"># Security: Service account</span>
<span class="w">  </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-sa</span>
<span class="w">  </span><span class="nt">automountServiceAccountToken</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">  </span><span class="c1"># Disable unless needed</span>
</code></pre></div>

<h3 id="55-kubernetes-security-checklist">5.5 Kubernetes Security Checklist<a class="header-link" href="#55-kubernetes-security-checklist" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Kubernetes security audit script.</span>
<span class="sd">Checks common misconfigurations.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_kubectl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run kubectl command and return JSON output.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;kubectl </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2"> -o json&quot;</span><span class="p">,</span>
        <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span> <span class="k">else</span> <span class="p">{}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">audit_cluster_security</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Audit Kubernetes cluster for security issues.&quot;&quot;&quot;</span>
    <span class="n">findings</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># â”€â”€ Check 1: Pods running as root â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="n">pods</span> <span class="o">=</span> <span class="n">run_kubectl</span><span class="p">(</span><span class="s2">&quot;get pods -A&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pod</span> <span class="ow">in</span> <span class="n">pods</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;containers&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">sc</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;securityContext&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;runAsNonRoot&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">pod_name</span> <span class="o">=</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">ns</span> <span class="o">=</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;namespace&quot;</span><span class="p">]</span>
                <span class="n">findings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[HIGH] Pod </span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pod_name</span><span class="si">}</span><span class="s2"> container &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">container</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; may run as root&quot;</span>
                <span class="p">)</span>

    <span class="c1"># â”€â”€ Check 2: Privileged containers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="k">for</span> <span class="n">pod</span> <span class="ow">in</span> <span class="n">pods</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;containers&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">sc</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;securityContext&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;privileged&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">pod_name</span> <span class="o">=</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">ns</span> <span class="o">=</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;namespace&quot;</span><span class="p">]</span>
                <span class="n">findings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[CRITICAL] Pod </span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pod_name</span><span class="si">}</span><span class="s2"> container &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">container</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; is PRIVILEGED&quot;</span>
                <span class="p">)</span>

    <span class="c1"># â”€â”€ Check 3: No resource limits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="k">for</span> <span class="n">pod</span> <span class="ow">in</span> <span class="n">pods</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;containers&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">resources</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limits&quot;</span><span class="p">):</span>
                <span class="n">pod_name</span> <span class="o">=</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">ns</span> <span class="o">=</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;namespace&quot;</span><span class="p">]</span>
                <span class="n">findings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[MEDIUM] Pod </span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pod_name</span><span class="si">}</span><span class="s2"> container &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">container</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; has no resource limits&quot;</span>
                <span class="p">)</span>

    <span class="c1"># â”€â”€ Check 4: Default service account usage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="k">for</span> <span class="n">pod</span> <span class="ow">in</span> <span class="n">pods</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">sa</span> <span class="o">=</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;serviceAccountName&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sa</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
            <span class="n">pod_name</span> <span class="o">=</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;namespace&quot;</span><span class="p">]</span>
            <span class="n">auto_mount</span> <span class="o">=</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;automountServiceAccountToken&quot;</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">auto_mount</span><span class="p">:</span>
                <span class="n">findings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[HIGH] Pod </span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pod_name</span><span class="si">}</span><span class="s2"> uses default SA &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;with token auto-mounted&quot;</span>
                <span class="p">)</span>

    <span class="c1"># â”€â”€ Check 5: Images without digest â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="k">for</span> <span class="n">pod</span> <span class="ow">in</span> <span class="n">pods</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;containers&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;@sha256:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">image</span> <span class="ow">and</span> <span class="s2">&quot;:latest&quot;</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
                <span class="n">pod_name</span> <span class="o">=</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">ns</span> <span class="o">=</span> <span class="n">pod</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;namespace&quot;</span><span class="p">]</span>
                <span class="n">findings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[MEDIUM] Pod </span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pod_name</span><span class="si">}</span><span class="s2"> uses :latest &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;tag for &#39;</span><span class="si">{</span><span class="n">container</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>

    <span class="c1"># â”€â”€ Check 6: Namespaces without network policies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="n">namespaces</span> <span class="o">=</span> <span class="n">run_kubectl</span><span class="p">(</span><span class="s2">&quot;get namespaces&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">namespaces</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">ns_name</span> <span class="o">=</span> <span class="n">ns</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ns_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;kube-system&quot;</span><span class="p">,</span> <span class="s2">&quot;kube-public&quot;</span><span class="p">,</span> <span class="s2">&quot;kube-node-lease&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">netpols</span> <span class="o">=</span> <span class="n">run_kubectl</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get networkpolicies -n </span><span class="si">{</span><span class="n">ns_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">netpols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">):</span>
            <span class="n">findings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[HIGH] Namespace &#39;</span><span class="si">{</span><span class="n">ns_name</span><span class="si">}</span><span class="s2">&#39; has no NetworkPolicies&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">findings</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kubernetes Security Audit&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">findings</span> <span class="o">=</span> <span class="n">audit_cluster_security</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">findings</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">findings</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total findings: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">findings</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No security issues found.&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="6-service-mesh-security">6. Service Mesh Security<a class="header-link" href="#6-service-mesh-security" title="Permanent link">&para;</a></h2>
<h3 id="61-mtls-with-istio">6.1 mTLS with Istio<a class="header-link" href="#61-mtls-with-istio" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Mutual TLS (mTLS) with Service Mesh               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Without mTLS:                                                       â”‚
â”‚  Pod A â”€â”€â”€â”€â”€â”€ plaintext â”€â”€â”€â”€â”€â”€â–¶ Pod B                                â”‚
â”‚  (anyone on the network can intercept)                               â”‚
â”‚                                                                      â”‚
â”‚  With mTLS (Istio sidecar proxy):                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Pod A             â”‚         â”‚  Pod B             â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ TLS     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”  â”‚              â”‚
â”‚  â”‚  â”‚ App â”‚â†’â”‚Envoy â”‚â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”‚Envoy â”‚â†’â”‚ App â”‚  â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ mTLS    â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ mutual  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                         auth                                         â”‚
â”‚                                                                      â”‚
â”‚  mTLS provides:                                                      â”‚
â”‚  1. Encryption:      All traffic encrypted in transit                â”‚
â”‚  2. Authentication:  Both sides verify identity (certificates)       â”‚
â”‚  3. Authorization:   Only allowed services can communicate           â”‚
â”‚  4. Automatic:       Certificate rotation handled by mesh            â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Istio PeerAuthentication: Enforce mTLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security.istio.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PeerAuthentication</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">mtls</span><span class="p">:</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">STRICT</span><span class="w">  </span><span class="c1"># Reject non-mTLS connections</span>

<span class="nn">---</span>
<span class="c1"># â”€â”€ Istio AuthorizationPolicy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Only allow specific service-to-service communication</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security.istio.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AuthorizationPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api-access</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api-service</span>
<span class="w">  </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ALLOW</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Allow web-frontend to call api-service</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">from</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source</span><span class="p">:</span>
<span class="w">            </span><span class="nt">principals</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;cluster.local/ns/production/sa/web-frontend-sa&quot;</span>
<span class="w">      </span><span class="nt">to</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">operation</span><span class="p">:</span>
<span class="w">            </span><span class="nt">methods</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;GET&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;POST&quot;</span><span class="p p-Indicator">]</span>
<span class="w">            </span><span class="nt">paths</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/api/*&quot;</span><span class="p p-Indicator">]</span>

<span class="w">    </span><span class="c1"># Allow monitoring to call health endpoint</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">from</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source</span><span class="p">:</span>
<span class="w">            </span><span class="nt">principals</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;cluster.local/ns/monitoring/sa/prometheus-sa&quot;</span>
<span class="w">      </span><span class="nt">to</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">operation</span><span class="p">:</span>
<span class="w">            </span><span class="nt">methods</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;GET&quot;</span><span class="p p-Indicator">]</span>
<span class="w">            </span><span class="nt">paths</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/health&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;/metrics&quot;</span><span class="p p-Indicator">]</span>

<span class="nn">---</span>
<span class="c1"># Deny all other traffic to api-service</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security.istio.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AuthorizationPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deny-all</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api-service</span>
<span class="w">  </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DENY</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{}</span>
</code></pre></div>

<hr />
<h2 id="7-cloud-iam-best-practices">7. Cloud IAM Best Practices<a class="header-link" href="#7-cloud-iam-best-practices" title="Permanent link">&para;</a></h2>
<h3 id="71-iam-principles">7.1 IAM Principles<a class="header-link" href="#71-iam-principles" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="n">Cloud</span><span class="w"> </span><span class="n">IAM</span><span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="n">Principles</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">Least</span><span class="w"> </span><span class="n">Privilege</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Grant</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">permissions</span><span class="w"> </span><span class="n">needed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">task</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">fine</span><span class="o">-</span><span class="n">grained</span><span class="w"> </span><span class="n">policies</span><span class="w"> </span><span class="p">(</span><span class="k">not</span><span class="w"> </span><span class="n">AdministratorAccess</span><span class="p">)</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Review</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">reduce</span><span class="w"> </span><span class="n">permissions</span><span class="w"> </span><span class="n">regularly</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">Long</span><span class="o">-</span><span class="n">Lived</span><span class="w"> </span><span class="n">Credentials</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">IAM</span><span class="w"> </span><span class="n">roles</span><span class="w"> </span><span class="n">instead</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">keys</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">OIDC</span><span class="w"> </span><span class="n">federation</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">CI</span><span class="o">/</span><span class="n">CD</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">necessary</span><span class="p">,</span><span class="w"> </span><span class="n">rotate</span><span class="w"> </span><span class="n">every</span><span class="w"> </span><span class="mh">90</span><span class="w"> </span><span class="n">days</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="n">MFA</span><span class="w"> </span><span class="n">Everywhere</span><span class="w">                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Require</span><span class="w"> </span><span class="n">MFA</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">console</span><span class="w"> </span><span class="n">access</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Require</span><span class="w"> </span><span class="n">MFA</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">sensitive</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">calls</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">hardware</span><span class="w"> </span><span class="n">security</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">privileged</span><span class="w"> </span><span class="n">accounts</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">4.</span><span class="w"> </span><span class="n">Separation</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Duties</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Different</span><span class="w"> </span><span class="n">accounts</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">dev</span><span class="o">/</span><span class="n">staging</span><span class="o">/</span><span class="n">prod</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Break</span><span class="w"> </span><span class="n">glass</span><span class="w"> </span><span class="n">procedures</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">emergency</span><span class="w"> </span><span class="n">access</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">single</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">deploy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">approve</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">5.</span><span class="w"> </span><span class="n">Audit</span><span class="w"> </span><span class="n">Everything</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Enable</span><span class="w"> </span><span class="n">CloudTrail</span><span class="o">/</span><span class="n">Cloud</span><span class="w"> </span><span class="n">Audit</span><span class="w"> </span><span class="n">Logs</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Alert</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">unusual</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">patterns</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Regular</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">reviews</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="72-aws-iam-policies">7.2 AWS IAM Policies<a class="header-link" href="#72-aws-iam-policies" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;Version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;Statement&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;Sid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AllowS3ReadOnly&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;s3:GetObject&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;s3:ListBucket&quot;</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;arn:aws:s3:::my-app-bucket&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;arn:aws:s3:::my-app-bucket/*&quot;</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;Condition&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;StringEquals&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;aws:RequestedRegion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;us-east-1&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;Bool&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;aws:SecureTransport&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;true&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;Sid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;DenyDeleteBucket&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Deny&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;s3:DeleteBucket&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;s3:DeleteObject&quot;</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">AWS IAM security audit script.</span>
<span class="sd">pip install boto3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">timedelta</span>


<span class="k">def</span><span class="w"> </span><span class="nf">audit_iam_security</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Audit AWS IAM configuration for security issues.&quot;&quot;&quot;</span>
    <span class="n">iam</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;iam&#39;</span><span class="p">)</span>
    <span class="n">findings</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># â”€â”€ Check 1: Root account access keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">get_account_summary</span><span class="p">()[</span><span class="s1">&#39;SummaryMap&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AccountAccessKeysPresent&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">findings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;[CRITICAL] Root account has active access keys. &quot;</span>
            <span class="s2">&quot;Delete them immediately.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># â”€â”€ Check 2: MFA not enabled â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="k">if</span> <span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AccountMFAEnabled&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">findings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;[CRITICAL] Root account does not have MFA enabled.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># â”€â”€ Check 3: Users without MFA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">list_users</span><span class="p">()[</span><span class="s1">&#39;Users&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
        <span class="n">mfa_devices</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">list_mfa_devices</span><span class="p">(</span>
            <span class="n">UserName</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span>
        <span class="p">)[</span><span class="s1">&#39;MFADevices&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mfa_devices</span><span class="p">:</span>
            <span class="n">findings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[HIGH] User &#39;</span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; does not have MFA enabled.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># â”€â”€ Check 4: Old access keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">list_access_keys</span><span class="p">(</span>
            <span class="n">UserName</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span>
        <span class="p">)[</span><span class="s1">&#39;AccessKeyMetadata&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">age</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">-</span> <span class="n">key</span><span class="p">[</span><span class="s1">&#39;CreateDate&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">90</span><span class="p">):</span>
                <span class="n">findings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[HIGH] User &#39;</span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; has access key &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;AccessKeyId&#39;</span><span class="p">][:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; that is </span><span class="si">{</span><span class="n">age</span><span class="o">.</span><span class="n">days</span><span class="si">}</span><span class="s2"> days old. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Rotate immediately.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="s1">&#39;Status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Inactive&#39;</span><span class="p">:</span>
                <span class="n">findings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[MEDIUM] User &#39;</span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; has inactive &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;access key &#39;</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;AccessKeyId&#39;</span><span class="p">][:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39;. Delete it.&quot;</span>
                <span class="p">)</span>

    <span class="c1"># â”€â”€ Check 5: Unused users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
        <span class="n">last_used</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PasswordLastUsed&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_used</span><span class="p">:</span>
            <span class="n">age</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">-</span> <span class="n">last_used</span>
            <span class="k">if</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">90</span><span class="p">):</span>
                <span class="n">findings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[MEDIUM] User &#39;</span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; has not logged &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;in for </span><span class="si">{</span><span class="n">age</span><span class="o">.</span><span class="n">days</span><span class="si">}</span><span class="s2"> days. Consider disabling.&quot;</span>
                <span class="p">)</span>

    <span class="c1"># â”€â”€ Check 6: Overly permissive policies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
        <span class="n">attached</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">list_attached_user_policies</span><span class="p">(</span>
            <span class="n">UserName</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span>
        <span class="p">)[</span><span class="s1">&#39;AttachedPolicies&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">attached</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">policy</span><span class="p">[</span><span class="s1">&#39;PolicyName&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;AdministratorAccess&#39;</span><span class="p">:</span>
                <span class="n">findings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[HIGH] User &#39;</span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; has &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;AdministratorAccess attached directly. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Use groups and least-privilege policies.&quot;</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">findings</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AWS IAM Security Audit&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">finding</span> <span class="ow">in</span> <span class="n">audit_iam_security</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">finding</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="8-infrastructure-as-code-security">8. Infrastructure as Code Security<a class="header-link" href="#8-infrastructure-as-code-security" title="Permanent link">&para;</a></h2>
<h3 id="81-terraform-security">8.1 Terraform Security<a class="header-link" href="#81-terraform-security" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Secure Terraform Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>

<span class="c1"># Provider configuration â€” never hardcode credentials</span>
<span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;aws&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.region</span>
<span class="c1">  # Credentials from environment or IAM role</span>
<span class="c1">  # NEVER: access_key = &quot;AKIA...&quot;</span>
<span class="c1">  # NEVER: secret_key = &quot;wJal...&quot;</span>
<span class="p">}</span>

<span class="c1"># Remote state with encryption</span>
<span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">backend</span><span class="w"> </span><span class="nv">&quot;s3&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">bucket</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;terraform-state-mycompany&quot;</span>
<span class="w">    </span><span class="na">key</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;production/terraform.tfstate&quot;</span>
<span class="w">    </span><span class="na">region</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;us-east-1&quot;</span>
<span class="w">    </span><span class="na">encrypt</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="na">dynamodb_table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;terraform-locks&quot;</span>
<span class="c1">    # State may contain secrets â€” always encrypt</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Security group â€” restrictive by default</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_security_group&quot;</span><span class="w"> </span><span class="nv">&quot;web&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;web-sg-&quot;</span>
<span class="w">  </span><span class="na">vpc_id</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">var.vpc_id</span>

<span class="c1">  # Only allow HTTPS from anywhere</span>
<span class="w">  </span><span class="nb">ingress</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;HTTPS from internet&quot;</span>
<span class="w">    </span><span class="na">from_port</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">443</span>
<span class="w">    </span><span class="na">to_port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">443</span>
<span class="w">    </span><span class="na">protocol</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tcp&quot;</span>
<span class="w">    </span><span class="na">cidr_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">  # BAD: Don&#39;t do this</span>
<span class="c1">  # ingress {</span>
<span class="c1">  #   from_port   = 0</span>
<span class="c1">  #   to_port     = 0</span>
<span class="c1">  #   protocol    = &quot;-1&quot;</span>
<span class="c1">  #   cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
<span class="c1">  # }</span>

<span class="c1">  # Restrict egress too</span>
<span class="w">  </span><span class="nb">egress</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;HTTPS outbound&quot;</span>
<span class="w">    </span><span class="na">from_port</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">443</span>
<span class="w">    </span><span class="na">to_port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">443</span>
<span class="w">    </span><span class="na">protocol</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tcp&quot;</span>
<span class="w">    </span><span class="na">cidr_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span>
<span class="w">    </span><span class="na">ManagedBy</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;terraform&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># S3 bucket with security controls</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_s3_bucket&quot;</span><span class="w"> </span><span class="nv">&quot;data&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mycompany-data-${var.environment}&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_s3_bucket_versioning&quot;</span><span class="w"> </span><span class="nv">&quot;data&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_s3_bucket.data.id</span>
<span class="w">  </span><span class="nb">versioning_configuration</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Enabled&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_s3_bucket_server_side_encryption_configuration&quot;</span><span class="w"> </span><span class="nv">&quot;data&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_s3_bucket.data.id</span>
<span class="w">  </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">apply_server_side_encryption_by_default</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">sse_algorithm</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;aws:kms&quot;</span>
<span class="w">      </span><span class="na">kms_master_key_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_kms_key.data.arn</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="na">bucket_key_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_s3_bucket_public_access_block&quot;</span><span class="w"> </span><span class="nv">&quot;data&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_s3_bucket.data.id</span>
<span class="w">  </span><span class="na">block_public_acls</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">block_public_policy</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">ignore_public_acls</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">restrict_public_buckets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="82-scanning-iac-with-tfseccheckov">8.2 Scanning IaC with tfsec/Checkov<a class="header-link" href="#82-scanning-iac-with-tfseccheckov" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ tfsec â€” Terraform security scanner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
brew<span class="w"> </span>install<span class="w"> </span>tfsec

<span class="c1"># Scan Terraform files</span>
tfsec<span class="w"> </span>/path/to/terraform

<span class="c1"># Scan with minimum severity</span>
tfsec<span class="w"> </span>--minimum-severity<span class="w"> </span>HIGH<span class="w"> </span>/path/to/terraform

<span class="c1"># Generate SARIF output for CI</span>
tfsec<span class="w"> </span>--format<span class="w"> </span>sarif<span class="w"> </span>--out<span class="w"> </span>results.sarif<span class="w"> </span>/path/to/terraform

<span class="c1"># â”€â”€ Checkov â€” Multi-framework IaC scanner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
pip<span class="w"> </span>install<span class="w"> </span>checkov

<span class="c1"># Scan Terraform</span>
checkov<span class="w"> </span>-d<span class="w"> </span>/path/to/terraform

<span class="c1"># Scan Kubernetes manifests</span>
checkov<span class="w"> </span>-d<span class="w"> </span>/path/to/k8s-manifests

<span class="c1"># Scan Dockerfiles</span>
checkov<span class="w"> </span>--framework<span class="w"> </span>dockerfile<span class="w"> </span>-f<span class="w"> </span>Dockerfile

<span class="c1"># Scan CloudFormation</span>
checkov<span class="w"> </span>-d<span class="w"> </span>/path/to/cfn-templates

<span class="c1"># Compact output with only failures</span>
checkov<span class="w"> </span>-d<span class="w"> </span>/path/to/terraform<span class="w"> </span>--compact<span class="w"> </span>--quiet
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Checkov in CI/CD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># .github/workflows/iac-security.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IaC Security</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;terraform/**&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;k8s/**&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;Dockerfile*&#39;</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">checkov</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run Checkov</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bridgecrewio/checkov-action@v12</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">terraform/</span>
<span class="w">          </span><span class="nt">framework</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">terraform</span>
<span class="w">          </span><span class="nt">output_format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sarif</span>
<span class="w">          </span><span class="nt">output_file_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">results.sarif</span>
<span class="w">          </span><span class="nt">soft_fail</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">  </span><span class="c1"># Fail the build on issues</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload results</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">github/codeql-action/upload-sarif@v3</span>
<span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always()</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">sarif_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">results.sarif</span>
</code></pre></div>

<hr />
<h2 id="9-runtime-security-monitoring">9. Runtime Security Monitoring<a class="header-link" href="#9-runtime-security-monitoring" title="Permanent link">&para;</a></h2>
<h3 id="91-falco-runtime-threat-detection">9.1 Falco (Runtime Threat Detection)<a class="header-link" href="#91-falco-runtime-threat-detection" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Falco rules for container runtime security â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Falco monitors system calls and detects anomalous behavior</span>

<span class="c1"># Detect shell spawned in container</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Terminal shell in container</span>
<span class="w">  </span><span class="nt">desc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">A shell was started inside a container</span>
<span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">    </span><span class="no">spawned_process and container and</span>
<span class="w">    </span><span class="no">proc.name in (bash, sh, zsh, ksh, csh, dash) and</span>
<span class="w">    </span><span class="no">not proc.pname in (cron, crond, supervisord)</span>
<span class="w">  </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">    </span><span class="no">Shell spawned in container</span>
<span class="w">    </span><span class="no">(user=%user.name container=%container.name</span>
<span class="w">     </span><span class="no">shell=%proc.name parent=%proc.pname</span>
<span class="w">     </span><span class="no">cmdline=%proc.cmdline image=%container.image.repository)</span>
<span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WARNING</span>

<span class="c1"># Detect sensitive file access</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Read sensitive file in container</span>
<span class="w">  </span><span class="nt">desc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Sensitive file was read inside a container</span>
<span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">    </span><span class="no">open_read and container and</span>
<span class="w">    </span><span class="no">fd.name in (/etc/shadow, /etc/passwd, /etc/sudoers) and</span>
<span class="w">    </span><span class="no">not proc.name in (sshd, login)</span>
<span class="w">  </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">    </span><span class="no">Sensitive file read in container</span>
<span class="w">    </span><span class="no">(user=%user.name file=%fd.name container=%container.name</span>
<span class="w">     </span><span class="no">image=%container.image.repository)</span>
<span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WARNING</span>

<span class="c1"># Detect outbound connection to unexpected port</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Unexpected outbound connection</span>
<span class="w">  </span><span class="nt">desc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Container making outbound connection on unexpected port</span>
<span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">    </span><span class="no">outbound and container and</span>
<span class="w">    </span><span class="no">not fd.sport in (80, 443, 53, 8080, 8443) and</span>
<span class="w">    </span><span class="no">not proc.name in (curl, wget, python, node)</span>
<span class="w">  </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">    </span><span class="no">Unexpected outbound connection</span>
<span class="w">    </span><span class="no">(command=%proc.cmdline connection=%fd.name</span>
<span class="w">     </span><span class="no">container=%container.name image=%container.image.repository)</span>
<span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NOTICE</span>

<span class="c1"># Detect privilege escalation attempt</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Privilege escalation in container</span>
<span class="w">  </span><span class="nt">desc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Detected privilege escalation inside a container</span>
<span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">    </span><span class="no">spawned_process and container and</span>
<span class="w">    </span><span class="no">(proc.name in (sudo, su) or</span>
<span class="w">     </span><span class="no">proc.name = setuid or</span>
<span class="w">     </span><span class="no">proc.args contains &quot;--privileged&quot;)</span>
<span class="w">  </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">    </span><span class="no">Privilege escalation attempt in container</span>
<span class="w">    </span><span class="no">(user=%user.name command=%proc.cmdline</span>
<span class="w">     </span><span class="no">container=%container.name image=%container.image.repository)</span>
<span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CRITICAL</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Install Falco on Kubernetes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>falcosecurity<span class="w"> </span>https://falcosecurity.github.io/charts
helm<span class="w"> </span>install<span class="w"> </span>falco<span class="w"> </span>falcosecurity/falco<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--namespace<span class="w"> </span>falco<span class="w"> </span>--create-namespace<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--set<span class="w"> </span><span class="nv">tty</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--set<span class="w"> </span>falcosidekick.enabled<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--set<span class="w"> </span>falcosidekick.config.slack.webhookurl<span class="o">=</span><span class="s2">&quot;https://hooks.slack.com/...&quot;</span>

<span class="c1"># â”€â”€ View Falco alerts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
kubectl<span class="w"> </span>logs<span class="w"> </span>-l<span class="w"> </span>app.kubernetes.io/name<span class="o">=</span>falco<span class="w"> </span>-n<span class="w"> </span>falco<span class="w"> </span>-f
</code></pre></div>

<hr />
<h2 id="10-supply-chain-security">10. Supply Chain Security<a class="header-link" href="#10-supply-chain-security" title="Permanent link">&para;</a></h2>
<h3 id="101-software-bill-of-materials-sbom">10.1 Software Bill of Materials (SBOM)<a class="header-link" href="#101-software-bill-of-materials-sbom" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="nx">Software</span><span class="w"> </span><span class="nx">Supply</span><span class="w"> </span><span class="nx">Chain</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Source</span><span class="w"> </span><span class="nx">Code</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="nx">Dependencies</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="nx">Build</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="nx">Image</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="nx">Deploy</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">               </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w">          </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â–¼</span><span class="w">               </span><span class="err">â–¼</span><span class="w">            </span><span class="err">â–¼</span><span class="w">          </span><span class="err">â–¼</span><span class="w">          </span><span class="err">â–¼</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Code</span><span class="w"> </span><span class="nx">Review</span><span class="w">     </span><span class="nx">Lock</span><span class="w"> </span><span class="nx">files</span><span class="w">    </span><span class="nx">Hermetic</span><span class="w">    </span><span class="nx">Sign</span><span class="w"> </span><span class="o">&amp;</span><span class="w">     </span><span class="nx">Verify</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">SAST</span><span class="w"> </span><span class="nx">scanning</span><span class="w">   </span><span class="nx">Audit</span><span class="w"> </span><span class="nx">deps</span><span class="w">    </span><span class="nx">builds</span><span class="w">      </span><span class="nx">SBOM</span><span class="w">      </span><span class="nx">signatures</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Secret</span><span class="w"> </span><span class="nx">scan</span><span class="w">     </span><span class="nx">Vuln</span><span class="w"> </span><span class="nx">scan</span><span class="w">     </span><span class="nx">Reproduce</span><span class="w">   </span><span class="nx">Store</span><span class="w">      </span><span class="nx">Admit</span><span class="w"> </span><span class="nx">only</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                            </span><span class="nx">digest</span><span class="w">     </span><span class="nx">signed</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">SBOM</span><span class="w"> </span><span class="p">(</span><span class="nx">Software</span><span class="w"> </span><span class="nx">Bill</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">Materials</span><span class="p">):</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">A</span><span class="w"> </span><span class="nx">complete</span><span class="w"> </span><span class="nx">inventory</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nx">components</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">your</span><span class="w"> </span><span class="nx">software</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Direct</span><span class="w"> </span><span class="nx">dependencies</span><span class="w"> </span><span class="p">(</span><span class="nx">your</span><span class="w"> </span><span class="nx">requirements</span><span class="p">.</span><span class="nx">txt</span><span class="p">)</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">Transitive</span><span class="w"> </span><span class="nx">dependencies</span><span class="w"> </span><span class="p">(</span><span class="nx">deps</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">deps</span><span class="p">)</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">OS</span><span class="w"> </span><span class="nx">packages</span><span class="w"> </span><span class="p">(</span><span class="nx">from</span><span class="w"> </span><span class="kd">base</span><span class="w"> </span><span class="nx">image</span><span class="p">)</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">Licenses</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">each</span><span class="w"> </span><span class="nx">component</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Formats</span><span class="p">:</span><span class="w">                                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">SPDX</span><span class="w"> </span><span class="p">(</span><span class="nx">ISO</span><span class="w"> </span><span class="nx">standard</span><span class="p">)</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">CycloneDX</span><span class="w"> </span><span class="p">(</span><span class="nx">OWASP</span><span class="p">)</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">Syft</span><span class="w"> </span><span class="p">(</span><span class="nx">native</span><span class="p">)</span><span class="w">                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ Generate SBOM with Syft â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Install</span>
brew<span class="w"> </span>install<span class="w"> </span>syft

<span class="c1"># Generate SBOM for a Docker image</span>
syft<span class="w"> </span>myapp:latest<span class="w"> </span>-o<span class="w"> </span>spdx-json<span class="w"> </span>&gt;<span class="w"> </span>sbom.spdx.json
syft<span class="w"> </span>myapp:latest<span class="w"> </span>-o<span class="w"> </span>cyclonedx-json<span class="w"> </span>&gt;<span class="w"> </span>sbom.cdx.json

<span class="c1"># Generate SBOM for a directory (source code)</span>
syft<span class="w"> </span>dir:/path/to/project<span class="w"> </span>-o<span class="w"> </span>spdx-json

<span class="c1"># â”€â”€ Scan SBOM for vulnerabilities with Grype â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
brew<span class="w"> </span>install<span class="w"> </span>grype

<span class="c1"># Scan from SBOM</span>
grype<span class="w"> </span>sbom:sbom.spdx.json

<span class="c1"># Scan image directly</span>
grype<span class="w"> </span>myapp:latest

<span class="c1"># Fail on high/critical</span>
grype<span class="w"> </span>myapp:latest<span class="w"> </span>--fail-on<span class="w"> </span>high
</code></pre></div>

<h3 id="102-slsa-supply-chain-levels-for-software-artifacts">10.2 SLSA (Supply Chain Levels for Software Artifacts)<a class="header-link" href="#102-slsa-supply-chain-levels-for-software-artifacts" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                    </span><span class="nv">SLSA</span><span class="w"> </span><span class="nv">Levels</span><span class="w">                                       </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Level</span><span class="w"> </span><span class="mi">0</span>:<span class="w"> </span><span class="nv">No</span><span class="w"> </span><span class="nv">guarantees</span><span class="w">                                              </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€<span class="w"> </span><span class="nv">Anyone</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="nv">build</span><span class="w"> </span><span class="nv">anything</span>,<span class="w"> </span><span class="nv">no</span><span class="w"> </span><span class="nv">provenance</span><span class="w">                        </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Level</span><span class="w"> </span><span class="mi">1</span>:<span class="w"> </span><span class="nv">Documentation</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">build</span><span class="w"> </span><span class="nv">process</span><span class="w">                         </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Provenance</span><span class="w"> </span><span class="nv">exists</span><span class="w"> </span><span class="ss">(</span><span class="nv">who</span><span class="w"> </span><span class="nv">built</span><span class="w"> </span><span class="nv">it</span>,<span class="w"> </span><span class="nv">how</span><span class="ss">)</span><span class="w">                          </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€<span class="w"> </span><span class="nv">Build</span><span class="w"> </span><span class="nv">process</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">documented</span><span class="w">                                     </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Level</span><span class="w"> </span><span class="mi">2</span>:<span class="w"> </span><span class="nv">Tamper</span><span class="w"> </span><span class="nv">resistance</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">build</span><span class="w"> </span><span class="nv">service</span><span class="w">                     </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Provenance</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">signed</span><span class="w">                                            </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Build</span><span class="w"> </span><span class="nv">service</span><span class="w"> </span><span class="nv">generates</span><span class="w"> </span><span class="nv">provenance</span><span class="w"> </span><span class="nv">automatically</span><span class="w">                </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€<span class="w"> </span><span class="nv">Build</span><span class="w"> </span><span class="nv">service</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">version</span><span class="o">-</span><span class="nv">controlled</span><span class="w">                             </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="nv">Level</span><span class="w"> </span><span class="mi">3</span>:<span class="w"> </span><span class="nv">Extra</span><span class="w"> </span><span class="nv">resistance</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">specific</span><span class="w"> </span><span class="nv">threats</span><span class="w">                       </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Provenance</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">non</span><span class="o">-</span><span class="nv">forgeable</span><span class="w">                                     </span>â”‚
â”‚<span class="w">  </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Isolated</span>,<span class="w"> </span><span class="nv">ephemeral</span><span class="w"> </span><span class="nv">build</span><span class="w"> </span><span class="nv">environments</span><span class="w">                          </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€<span class="w"> </span><span class="nv">Source</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">version</span><span class="o">-</span><span class="nv">controlled</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">verified</span><span class="w"> </span><span class="nv">history</span><span class="w">              </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â”‚<span class="w">  </span><span class="k">For</span><span class="w"> </span><span class="nv">most</span><span class="w"> </span><span class="nv">projects</span>,<span class="w"> </span><span class="nv">aim</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">SLSA</span><span class="w"> </span><span class="nv">Level</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">minimum</span>.<span class="w">                    </span>â”‚
â”‚<span class="w">                                                                      </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># â”€â”€ GitHub Actions SLSA provenance generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># .github/workflows/slsa-build.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SLSA Build</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;v*&#39;</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">outputs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">digest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ steps.build.outputs.digest }}</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Build image</span>
<span class="w">        </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">docker build -t myapp:${{ github.ref_name }} .</span>
<span class="w">          </span><span class="no">DIGEST=$(docker inspect --format=&#39;{{index .RepoDigests 0}}&#39; myapp:${{ github.ref_name }} | cut -d@ -f2)</span>
<span class="w">          </span><span class="no">echo &quot;digest=$DIGEST&quot; &gt;&gt; &quot;$GITHUB_OUTPUT&quot;</span>

<span class="w">  </span><span class="nt">provenance</span><span class="p">:</span>
<span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">    </span><span class="nt">permissions</span><span class="p">:</span>
<span class="w">      </span><span class="nt">actions</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">      </span><span class="nt">id-token</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">write</span>
<span class="w">      </span><span class="nt">packages</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">write</span>
<span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.0.0</span>
<span class="w">    </span><span class="nt">with</span><span class="p">:</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/${{ github.repository }}</span>
<span class="w">      </span><span class="nt">digest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ needs.build.outputs.digest }}</span>
</code></pre></div>

<hr />
<h2 id="11-exercises">11. Exercises<a class="header-link" href="#11-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-secure-dockerfile-challenge">Exercise 1: Secure Dockerfile Challenge<a class="header-link" href="#exercise-1-secure-dockerfile-challenge" title="Permanent link">&para;</a></h3>
<p>Take the following insecure Dockerfile and fix all security issues:</p>
<div class="highlight"><pre><span></span><code><span class="k">FROM</span><span class="w"> </span><span class="s">ubuntu:latest</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>python3<span class="w"> </span>python3-pip
<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>/app
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<span class="k">RUN</span><span class="w"> </span>pip3<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt
<span class="k">ENV</span><span class="w"> </span><span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://admin:password123@db.prod.example.com/mydb
<span class="k">ENV</span><span class="w"> </span><span class="nv">API_SECRET</span><span class="o">=</span>sk_live_supersecret
<span class="k">EXPOSE</span><span class="w"> </span><span class="s">22 80 443 5432 8080</span>
<span class="k">CMD</span><span class="w"> </span>python3<span class="w"> </span>app.py
</code></pre></div>

<p>Requirements:
1. Use a minimal base image
2. Multi-stage build
3. Non-root user
4. No secrets in the image
5. Proper .dockerignore
6. Health check
7. Read-only filesystem
8. Pinned versions</p>
<h3 id="exercise-2-kubernetes-security-hardening">Exercise 2: Kubernetes Security Hardening<a class="header-link" href="#exercise-2-kubernetes-security-hardening" title="Permanent link">&para;</a></h3>
<p>Write complete Kubernetes manifests for a web application with:</p>
<ol>
<li>A Deployment with security-hardened pod spec</li>
<li>A Service with appropriate type</li>
<li>A NetworkPolicy that allows only ingress from the ingress controller and egress to the API service and DNS</li>
<li>A ServiceAccount with no default token mounting</li>
<li>A Role and RoleBinding for a "developer" group with read-only access</li>
<li>Pod Security Standards enforcement on the namespace</li>
</ol>
<h3 id="exercise-3-container-image-scanner">Exercise 3: Container Image Scanner<a class="header-link" href="#exercise-3-container-image-scanner" title="Permanent link">&para;</a></h3>
<p>Build a Python tool that:</p>
<ol>
<li>Pulls a Docker image</li>
<li>Runs Trivy scan (or parses Trivy JSON output)</li>
<li>Checks for critical/high vulnerabilities</li>
<li>Verifies the image is signed (cosign)</li>
<li>Generates a compliance report (pass/fail with reasons)</li>
<li>Can be used as a CI/CD gate (exit code 1 on failure)</li>
</ol>
<h3 id="exercise-4-cloud-iam-audit-tool">Exercise 4: Cloud IAM Audit Tool<a class="header-link" href="#exercise-4-cloud-iam-audit-tool" title="Permanent link">&para;</a></h3>
<p>Create an AWS IAM audit tool that:</p>
<ol>
<li>Lists all IAM users and their attached policies</li>
<li>Identifies users without MFA</li>
<li>Finds access keys older than 90 days</li>
<li>Detects users with AdministratorAccess</li>
<li>Identifies unused roles (not assumed in 90 days)</li>
<li>Checks for overly permissive S3 bucket policies</li>
<li>Generates a CSV report with findings and remediation steps</li>
</ol>
<h3 id="exercise-5-terraform-security-scanner">Exercise 5: Terraform Security Scanner<a class="header-link" href="#exercise-5-terraform-security-scanner" title="Permanent link">&para;</a></h3>
<p>Write a tool that scans Terraform configuration for:</p>
<ol>
<li>Security groups with 0.0.0.0/0 on sensitive ports (22, 3389, 5432)</li>
<li>S3 buckets without encryption</li>
<li>S3 buckets without public access block</li>
<li>RDS instances without encryption</li>
<li>Resources without required tags (Environment, Owner, ManagedBy)</li>
<li>Hardcoded credentials in .tf files</li>
<li>Output results in a format suitable for CI/CD gating</li>
</ol>
<h3 id="exercise-6-supply-chain-security-pipeline">Exercise 6: Supply Chain Security Pipeline<a class="header-link" href="#exercise-6-supply-chain-security-pipeline" title="Permanent link">&para;</a></h3>
<p>Design and implement a CI/CD pipeline that:</p>
<ol>
<li>Scans source code for vulnerabilities (SAST)</li>
<li>Scans dependencies for known CVEs</li>
<li>Builds the container image with multi-stage Dockerfile</li>
<li>Scans the built image with Trivy</li>
<li>Signs the image with cosign</li>
<li>Generates SBOM (SPDX format)</li>
<li>Attaches SBOM to the image</li>
<li>Only deploys if all checks pass</li>
</ol>
<hr />
<h2 id="summary">Summary<a class="header-link" href="#summary" title="Permanent link">&para;</a></h2>
<h3 id="container-security-checklist">Container Security Checklist<a class="header-link" href="#container-security-checklist" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Category</th>
<th>Control</th>
<th>Priority</th>
</tr>
</thead>
<tbody>
<tr>
<td>Image</td>
<td>Use minimal base images (distroless/Alpine)</td>
<td>Critical</td>
</tr>
<tr>
<td>Image</td>
<td>Scan for vulnerabilities (Trivy/Snyk)</td>
<td>Critical</td>
</tr>
<tr>
<td>Image</td>
<td>No secrets in images</td>
<td>Critical</td>
</tr>
<tr>
<td>Image</td>
<td>Pin base image digests</td>
<td>High</td>
</tr>
<tr>
<td>Image</td>
<td>Sign images (cosign)</td>
<td>High</td>
</tr>
<tr>
<td>Dockerfile</td>
<td>Run as non-root</td>
<td>Critical</td>
</tr>
<tr>
<td>Dockerfile</td>
<td>Multi-stage builds</td>
<td>High</td>
</tr>
<tr>
<td>Dockerfile</td>
<td>Drop all capabilities</td>
<td>High</td>
</tr>
<tr>
<td>Dockerfile</td>
<td>Read-only filesystem</td>
<td>Medium</td>
</tr>
<tr>
<td>Kubernetes</td>
<td>RBAC with least privilege</td>
<td>Critical</td>
</tr>
<tr>
<td>Kubernetes</td>
<td>Network Policies</td>
<td>Critical</td>
</tr>
<tr>
<td>Kubernetes</td>
<td>Pod Security Standards</td>
<td>High</td>
</tr>
<tr>
<td>Kubernetes</td>
<td>No default service account tokens</td>
<td>High</td>
</tr>
<tr>
<td>Cloud</td>
<td>Least-privilege IAM</td>
<td>Critical</td>
</tr>
<tr>
<td>Cloud</td>
<td>No long-lived credentials</td>
<td>High</td>
</tr>
<tr>
<td>Cloud</td>
<td>MFA on all accounts</td>
<td>Critical</td>
</tr>
<tr>
<td>Cloud</td>
<td>Encrypt state files</td>
<td>High</td>
</tr>
<tr>
<td>Supply Chain</td>
<td>Generate SBOM</td>
<td>High</td>
</tr>
<tr>
<td>Supply Chain</td>
<td>Dependency scanning</td>
<td>High</td>
</tr>
<tr>
<td>Runtime</td>
<td>Monitor with Falco/Tetragon</td>
<td>Medium</td>
</tr>
</tbody>
</table>
<h3 id="key-takeaways">Key Takeaways<a class="header-link" href="#key-takeaways" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Minimal images reduce attack surface</strong> â€” every package is a potential vulnerability; use distroless or scratch when possible</li>
<li><strong>Never run as root</strong> â€” create a dedicated user in every Dockerfile</li>
<li><strong>Sign and verify</strong> â€” use cosign to sign images and verify before deployment</li>
<li><strong>Network isolation is critical</strong> â€” default-deny NetworkPolicies prevent lateral movement</li>
<li><strong>Shift left</strong> â€” scan images, IaC, and dependencies in CI/CD, not just in production</li>
<li><strong>Cloud IAM is the new perimeter</strong> â€” treat IAM policies with the same rigor as firewall rules</li>
<li><strong>Automate everything</strong> â€” manual security checks do not scale; integrate into pipelines</li>
</ol>
<hr />
<p><strong>Previous</strong>: <a href="./11_Secrets_Management.md">11_Secrets_Management.md</a> | <strong>Next</strong>: <a href="./13_Security_Testing.md">13. Security Testing</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/11_Secrets_Management.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Secrets Management and Environment Configuration</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/13_Security_Testing.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Security Testing</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}