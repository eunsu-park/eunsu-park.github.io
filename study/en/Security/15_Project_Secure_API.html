{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project: Building a Secure REST API - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Security/">Security</a>
    <span class="separator">/</span>
    <span class="current">Project: Building a Secure REST API</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Project: Building a Secure REST API</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/14_Incident_Response.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Incident Response and Forensics</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/16_Project_Vulnerability_Scanner.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Project: Building a Vulnerability Scanner</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#1-project-overview-and-architecture">1. Project Overview and Architecture</a><ul>
<li><a href="#11-what-we-are-building">1.1 What We Are Building</a></li>
<li><a href="#12-project-structure">1.2 Project Structure</a></li>
<li><a href="#13-dependencies">1.3 Dependencies</a></li>
</ul>
</li>
<li><a href="#2-configuration-management">2. Configuration Management</a><ul>
<li><a href="#21-secure-configuration">2.1 Secure Configuration</a></li>
<li><a href="#22-environment-file">2.2 Environment File</a></li>
</ul>
</li>
<li><a href="#3-password-hashing-with-argon2">3. Password Hashing with Argon2</a><ul>
<li><a href="#31-why-argon2">3.1 Why Argon2?</a></li>
<li><a href="#32-password-hashing-implementation">3.2 Password Hashing Implementation</a></li>
</ul>
</li>
<li><a href="#4-jwt-authentication-with-refresh-tokens">4. JWT Authentication with Refresh Tokens</a><ul>
<li><a href="#41-token-architecture">4.1 Token Architecture</a></li>
<li><a href="#42-token-service-implementation">4.2 Token Service Implementation</a></li>
</ul>
</li>
<li><a href="#5-role-based-access-control-rbac">5. Role-Based Access Control (RBAC)</a><ul>
<li><a href="#51-rbac-design">5.1 RBAC Design</a></li>
<li><a href="#52-rbac-implementation">5.2 RBAC Implementation</a></li>
</ul>
</li>
<li><a href="#6-input-validation-with-pydantic">6. Input Validation with Pydantic</a><ul>
<li><a href="#61-user-schemas">6.1 User Schemas</a></li>
<li><a href="#62-auth-schemas">6.2 Auth Schemas</a></li>
</ul>
</li>
<li><a href="#7-middleware-rate-limiting">7. Middleware: Rate Limiting</a><ul>
<li><a href="#71-rate-limiter">7.1 Rate Limiter</a></li>
</ul>
</li>
<li><a href="#8-middleware-security-headers">8. Middleware: Security Headers</a><ul>
<li><a href="#81-security-headers-middleware">8.1 Security Headers Middleware</a></li>
</ul>
</li>
<li><a href="#9-middleware-request-logging">9. Middleware: Request Logging</a><ul>
<li><a href="#91-structured-security-logging">9.1 Structured Security Logging</a></li>
<li><a href="#92-request-logging-middleware">9.2 Request Logging Middleware</a></li>
</ul>
</li>
<li><a href="#10-error-handling-without-information-leakage">10. Error Handling Without Information Leakage</a><ul>
<li><a href="#101-safe-error-handling">10.1 Safe Error Handling</a></li>
</ul>
</li>
<li><a href="#11-authentication-endpoints">11. Authentication Endpoints</a><ul>
<li><a href="#111-auth-router">11.1 Auth Router</a></li>
</ul>
</li>
<li><a href="#12-user-endpoints">12. User Endpoints</a><ul>
<li><a href="#121-user-router">12.1 User Router</a></li>
</ul>
</li>
<li><a href="#13-security-tests">13. Security Tests</a><ul>
<li><a href="#131-test-configuration">13.1 Test Configuration</a></li>
<li><a href="#132-security-specific-tests">13.2 Security-Specific Tests</a></li>
</ul>
</li>
<li><a href="#14-deployment-considerations">14. Deployment Considerations</a><ul>
<li><a href="#141-production-deployment-checklist">14.1 Production Deployment Checklist</a></li>
<li><a href="#142-nginx-reverse-proxy-configuration">14.2 Nginx Reverse Proxy Configuration</a></li>
<li><a href="#143-docker-deployment">14.3 Docker Deployment</a></li>
</ul>
</li>
<li><a href="#15-exercises">15. Exercises</a><ul>
<li><a href="#exercise-1-implement-the-auth-service">Exercise 1: Implement the Auth Service</a></li>
<li><a href="#exercise-2-add-two-factor-authentication">Exercise 2: Add Two-Factor Authentication</a></li>
<li><a href="#exercise-3-api-key-authentication">Exercise 3: API Key Authentication</a></li>
<li><a href="#exercise-4-complete-test-suite">Exercise 4: Complete Test Suite</a></li>
<li><a href="#exercise-5-security-audit">Exercise 5: Security Audit</a></li>
<li><a href="#exercise-6-production-deployment">Exercise 6: Production Deployment</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="project-building-a-secure-rest-api">Project: Building a Secure REST API<a class="header-link" href="#project-building-a-secure-rest-api" title="Permanent link">&para;</a></h1>
<p><strong>Previous</strong>: <a href="14_Incident_Response.md">14. Incident Response and Forensics</a> | <strong>Next</strong>: <a href="16_Project_Vulnerability_Scanner.md">16. Project: Building a Vulnerability Scanner</a></p>
<hr />
<p>This project lesson walks through building a production-ready secure REST API from scratch using FastAPI. We will implement every security layer -- from proper password hashing with Argon2, to JWT authentication with refresh tokens, role-based access control, input validation, rate limiting, security headers, CORS configuration, structured logging, and safe error handling. By the end, you will have a complete, deployable API that follows security best practices.</p>
<h2 id="learning-objectives">Learning Objectives<a class="header-link" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<ul>
<li>Build a REST API with security as a first-class concern</li>
<li>Implement Argon2 password hashing with proper configuration</li>
<li>Create JWT authentication with access and refresh token rotation</li>
<li>Design and implement role-based access control (RBAC)</li>
<li>Validate all input using Pydantic models</li>
<li>Add rate limiting, security headers, and CORS</li>
<li>Implement structured security logging</li>
<li>Handle errors without leaking sensitive information</li>
<li>Write security-focused tests</li>
<li>Prepare for production deployment</li>
</ul>
<hr />
<h2 id="1-project-overview-and-architecture">1. Project Overview and Architecture<a class="header-link" href="#1-project-overview-and-architecture" title="Permanent link">&para;</a></h2>
<h3 id="11-what-we-are-building">1.1 What We Are Building<a class="header-link" href="#11-what-we-are-building" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Secure REST API Architecture                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Client Request                                                  â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Rate Limiter     â”‚  â† Prevent brute force / DoS             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Security Headers â”‚  â† HSTS, CSP, X-Frame-Options           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  CORS Middleware  â”‚  â† Cross-origin request control          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Authentication   â”‚  â† JWT verification                      â”‚
â”‚  â”‚  Middleware       â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Authorization    â”‚  â† RBAC permission check                 â”‚
â”‚  â”‚  (RBAC)          â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Input Validation â”‚  â† Pydantic schema validation            â”‚
â”‚  â”‚  (Pydantic)      â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Business Logic   â”‚  â† Route handlers                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Database Layer   â”‚  â† Parameterized queries only            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Security Logger  â”‚  â† Audit trail (no PII in logs)          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="12-project-structure">1.2 Project Structure<a class="header-link" href="#12-project-structure" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>secure_api/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py              # FastAPI application entry point
â”‚   â”œâ”€â”€ config.py            # Configuration management
â”‚   â”œâ”€â”€ database.py          # Database setup (SQLAlchemy)
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py          # User database model
â”‚   â”‚   â””â”€â”€ token.py         # Refresh token model
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py          # Pydantic user schemas
â”‚   â”‚   â”œâ”€â”€ auth.py          # Auth request/response schemas
â”‚   â”‚   â””â”€â”€ common.py        # Shared schemas
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth.py          # Authentication endpoints
â”‚   â”‚   â”œâ”€â”€ users.py         # User management endpoints
â”‚   â”‚   â””â”€â”€ admin.py         # Admin-only endpoints
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ security_headers.py
â”‚   â”‚   â”œâ”€â”€ rate_limiter.py
â”‚   â”‚   â””â”€â”€ request_logging.py
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth_service.py  # Authentication logic
â”‚   â”‚   â”œâ”€â”€ user_service.py  # User CRUD operations
â”‚   â”‚   â””â”€â”€ token_service.py # JWT creation/validation
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ password.py      # Argon2 hashing
â”‚       â”œâ”€â”€ security.py      # Security helpers
â”‚       â””â”€â”€ logging.py       # Structured logging
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py          # Test fixtures
â”‚   â”œâ”€â”€ test_auth.py         # Auth endpoint tests
â”‚   â”œâ”€â”€ test_users.py        # User endpoint tests
â”‚   â””â”€â”€ test_security.py     # Security-specific tests
â”œâ”€â”€ alembic/                 # Database migrations
â”‚   â””â”€â”€ ...
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ .env.example
â”œâ”€â”€ Dockerfile
â””â”€â”€ docker-compose.yml
</code></pre></div>

<h3 id="13-dependencies">1.3 Dependencies<a class="header-link" href="#13-dependencies" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">requirements</span><span class="p">.</span><span class="n">txt</span>
<span class="n">fastapi</span><span class="o">==</span><span class="mf">0.109.2</span>
<span class="n">uvicorn</span><span class="o">[</span><span class="n">standard</span><span class="o">]==</span><span class="mf">0.27.1</span>
<span class="n">sqlalchemy</span><span class="o">==</span><span class="mf">2.0.27</span>
<span class="n">alembic</span><span class="o">==</span><span class="mf">1.13.1</span>
<span class="n">asyncpg</span><span class="o">==</span><span class="mf">0.29.0</span>
<span class="n">python</span><span class="o">-</span><span class="n">jose</span><span class="o">[</span><span class="n">cryptography</span><span class="o">]==</span><span class="mf">3.3.0</span>
<span class="n">argon2</span><span class="o">-</span><span class="n">cffi</span><span class="o">==</span><span class="mf">23.1.0</span>
<span class="n">pydantic</span><span class="o">[</span><span class="n">email</span><span class="o">]==</span><span class="mf">2.6.1</span>
<span class="n">pydantic</span><span class="o">-</span><span class="n">settings</span><span class="o">==</span><span class="mf">2.1.0</span>
<span class="n">python</span><span class="o">-</span><span class="n">multipart</span><span class="o">==</span><span class="mf">0.0.9</span>
<span class="n">slowapi</span><span class="o">==</span><span class="mf">0.1.9</span>
<span class="n">structlog</span><span class="o">==</span><span class="mf">24.1.0</span>
<span class="n">httpx</span><span class="o">==</span><span class="mf">0.27.0</span>
<span class="n">pytest</span><span class="o">==</span><span class="mf">8.0.1</span>
<span class="n">pytest</span><span class="o">-</span><span class="n">asyncio</span><span class="o">==</span><span class="mf">0.23.5</span>
</code></pre></div>

<hr />
<h2 id="2-configuration-management">2. Configuration Management<a class="header-link" href="#2-configuration-management" title="Permanent link">&para;</a></h2>
<h3 id="21-secure-configuration">2.1 Secure Configuration<a class="header-link" href="#21-secure-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/config.py - Application configuration.</span>
<span class="sd">All secrets come from environment variables, never hardcoded.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic_settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseSettings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Application settings loaded from environment variables.</span>
<span class="sd">    Never hardcode secrets - use .env file for development,</span>
<span class="sd">    environment variables or secret manager for production.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Application</span>
    <span class="n">APP_NAME</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Secure API&quot;</span>
    <span class="n">APP_VERSION</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.0.0&quot;</span>
    <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ENVIRONMENT</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;production&quot;</span>  <span class="c1"># development, staging, production</span>

    <span class="c1"># Database</span>
    <span class="n">DATABASE_URL</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span>  <span class="c1"># Required - must be provided</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;PostgreSQL connection string&quot;</span>
    <span class="p">)</span>

    <span class="c1"># JWT Configuration</span>
    <span class="n">JWT_SECRET_KEY</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span>  <span class="c1"># Required</span>
        <span class="n">min_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Secret key for JWT signing (min 32 chars)&quot;</span>
    <span class="p">)</span>
    <span class="n">JWT_ALGORITHM</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
    <span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span>      <span class="c1"># Short-lived</span>
    <span class="n">REFRESH_TOKEN_EXPIRE_DAYS</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span>         <span class="c1"># Longer-lived</span>

    <span class="c1"># Password Hashing (Argon2)</span>
    <span class="n">ARGON2_TIME_COST</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>          <span class="c1"># Number of iterations</span>
    <span class="n">ARGON2_MEMORY_COST</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span>    <span class="c1"># Memory in KiB (64 MB)</span>
    <span class="n">ARGON2_PARALLELISM</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>        <span class="c1"># Number of threads</span>
    <span class="n">ARGON2_HASH_LENGTH</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>       <span class="c1"># Hash output length</span>
    <span class="n">ARGON2_SALT_LENGTH</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span>       <span class="c1"># Salt length</span>

    <span class="c1"># Rate Limiting</span>
    <span class="n">RATE_LIMIT_PER_MINUTE</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="n">LOGIN_RATE_LIMIT</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;5/minute&quot;</span>     <span class="c1"># Stricter for login</span>
    <span class="n">REGISTER_RATE_LIMIT</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;3/minute&quot;</span>  <span class="c1"># Stricter for registration</span>

    <span class="c1"># CORS</span>
    <span class="n">CORS_ORIGINS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;http://localhost:3000&quot;</span><span class="p">]</span>
    <span class="n">CORS_ALLOW_CREDENTIALS</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">CORS_ALLOW_METHODS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">]</span>
    <span class="n">CORS_ALLOW_HEADERS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span>

    <span class="c1"># Logging</span>
    <span class="n">LOG_LEVEL</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span>
    <span class="n">LOG_FORMAT</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span>  <span class="c1"># json or console</span>

    <span class="c1"># Security</span>
    <span class="n">ALLOWED_HOSTS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">]</span>
    <span class="n">SECURE_COOKIES</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">MAX_LOGIN_ATTEMPTS</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">ACCOUNT_LOCKOUT_MINUTES</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;env_file&quot;</span><span class="p">:</span> <span class="s2">&quot;.env&quot;</span><span class="p">,</span>
        <span class="s2">&quot;env_file_encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;case_sensitive&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>


<span class="nd">@lru_cache</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_settings</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Settings</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get cached settings instance.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Settings</span><span class="p">()</span>
</code></pre></div>

<h3 id="22-environment-file">2.2 Environment File<a class="header-link" href="#22-environment-file" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># .env.example - Copy to .env and fill in values</span>
<span class="c1"># NEVER commit .env to version control!</span>

<span class="c1"># Application</span>
<span class="nv">APP_NAME</span><span class="o">=</span><span class="s2">&quot;Secure API&quot;</span>
<span class="nv">DEBUG</span><span class="o">=</span><span class="nb">false</span>
<span class="nv">ENVIRONMENT</span><span class="o">=</span>development

<span class="c1"># Database (use a strong password)</span>
<span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql+asyncpg://user:strong_password_here@localhost:5432/secure_api

<span class="c1"># JWT (generate with: python -c &quot;import secrets; print(secrets.token_hex(32))&quot;)</span>
<span class="nv">JWT_SECRET_KEY</span><span class="o">=</span>your-secret-key-at-least-32-characters-long-change-this

<span class="c1"># CORS</span>
<span class="nv">CORS_ORIGINS</span><span class="o">=[</span><span class="s2">&quot;http://localhost:3000&quot;</span>,<span class="s2">&quot;http://localhost:8080&quot;</span><span class="o">]</span>

<span class="c1"># Logging</span>
<span class="nv">LOG_LEVEL</span><span class="o">=</span>INFO
</code></pre></div>

<hr />
<h2 id="3-password-hashing-with-argon2">3. Password Hashing with Argon2<a class="header-link" href="#3-password-hashing-with-argon2" title="Permanent link">&para;</a></h2>
<h3 id="31-why-argon2">3.1 Why Argon2?<a class="header-link" href="#31-why-argon2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">Password</span><span class="w"> </span><span class="n">Hashing</span><span class="w"> </span><span class="n">Algorithm</span><span class="w"> </span><span class="n">Comparison</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Algorithm</span><span class="w">      </span><span class="n">Memory</span><span class="w">   </span><span class="n">GPU</span><span class="w">       </span><span class="n">Status</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                 </span><span class="n">Hard</span><span class="err">?</span><span class="w">    </span><span class="n">Resistant</span><span class="err">?</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">  </span><span class="err">â”€â”€â”€â”€â”€â”€â”€</span><span class="w">  </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">  </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">MD5</span><span class="w">            </span><span class="n">No</span><span class="w">       </span><span class="n">No</span><span class="w">        </span><span class="n">BROKEN</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="n">use</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="w">        </span><span class="n">No</span><span class="w">       </span><span class="n">No</span><span class="w">        </span><span class="n">NOT</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">passwords</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">bcrypt</span><span class="w">         </span><span class="n">No</span><span class="w">       </span><span class="n">Partial</span><span class="w">   </span><span class="n">Good</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">aging</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">scrypt</span><span class="w">         </span><span class="n">Yes</span><span class="w">      </span><span class="n">Yes</span><span class="w">       </span><span class="n">Good</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Argon2id</span><span class="w">       </span><span class="n">Yes</span><span class="w">      </span><span class="n">Yes</span><span class="w">       </span><span class="n">RECOMMENDED</span><span class="w"> </span><span class="p">(</span><span class="n">PHC</span><span class="w"> </span><span class="n">winner</span><span class="p">)</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Argon2</span><span class="w"> </span><span class="n">variants</span><span class="p">:</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Argon2d</span><span class="p">:</span><span class="w">  </span><span class="n">Data</span><span class="o">-</span><span class="n">dependent</span><span class="w"> </span><span class="p">(</span><span class="n">GPU</span><span class="w"> </span><span class="n">resistant</span><span class="p">,</span><span class="w"> </span><span class="n">side</span><span class="o">-</span><span class="n">channel</span><span class="w"> </span><span class="n">risk</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Argon2i</span><span class="p">:</span><span class="w">  </span><span class="n">Data</span><span class="o">-</span><span class="n">independent</span><span class="w"> </span><span class="p">(</span><span class="n">side</span><span class="o">-</span><span class="n">channel</span><span class="w"> </span><span class="n">safe</span><span class="p">,</span><span class="w"> </span><span class="n">less</span><span class="w"> </span><span class="n">GPU</span><span class="o">-</span><span class="n">R</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Argon2id</span><span class="p">:</span><span class="w"> </span><span class="n">Hybrid</span><span class="w"> </span><span class="p">(</span><span class="n">RECOMMENDED</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">best</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">both</span><span class="p">)</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Argon2id</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">winner</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Password</span><span class="w"> </span><span class="n">Hashing</span><span class="w"> </span><span class="n">Competition</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="n">PHC</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">recommended</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">OWASP</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="n">storage</span><span class="o">.</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="32-password-hashing-implementation">3.2 Password Hashing Implementation<a class="header-link" href="#32-password-hashing-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/utils/password.py - Secure password hashing with Argon2id.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">argon2</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHasher</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">argon2.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">VerifyMismatchError</span><span class="p">,</span>
    <span class="n">VerificationError</span><span class="p">,</span>
    <span class="n">InvalidHashError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_settings</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">()</span>

<span class="c1"># Configure Argon2id hasher with secure parameters</span>
<span class="c1"># OWASP recommends: time_cost=2, memory_cost=19456 (19 MiB) minimum</span>
<span class="c1"># We use stronger parameters for better security</span>
<span class="n">_hasher</span> <span class="o">=</span> <span class="n">PasswordHasher</span><span class="p">(</span>
    <span class="n">time_cost</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ARGON2_TIME_COST</span><span class="p">,</span>       <span class="c1"># iterations</span>
    <span class="n">memory_cost</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ARGON2_MEMORY_COST</span><span class="p">,</span>   <span class="c1"># KiB (64 MB)</span>
    <span class="n">parallelism</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ARGON2_PARALLELISM</span><span class="p">,</span>   <span class="c1"># threads</span>
    <span class="n">hash_len</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ARGON2_HASH_LENGTH</span><span class="p">,</span>      <span class="c1"># output length</span>
    <span class="n">salt_len</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ARGON2_SALT_LENGTH</span><span class="p">,</span>       <span class="c1"># salt length</span>
    <span class="nb">type</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>                                     <span class="c1"># 2 = Argon2id</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">hash_password</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hash a password using Argon2id.</span>

<span class="sd">    Args:</span>
<span class="sd">        password: The plaintext password to hash.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Argon2id hash string including algorithm parameters and salt.</span>

<span class="sd">    Example output:</span>
<span class="sd">        $argon2id$v=19$m=65536,t=3,p=4$c2FsdHNhbHQ$hash...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_hasher</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="nb">hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify a password against an Argon2id hash.</span>

<span class="sd">    This function is constant-time to prevent timing attacks.</span>

<span class="sd">    Args:</span>
<span class="sd">        hash: The stored Argon2id hash string.</span>
<span class="sd">        password: The plaintext password to verify.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if password matches, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_hasher</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">VerifyMismatchError</span><span class="p">,</span> <span class="n">VerificationError</span><span class="p">,</span> <span class="n">InvalidHashError</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_needs_rehash</span><span class="p">(</span><span class="nb">hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a hash needs to be re-computed with updated parameters.</span>

<span class="sd">    Call this after successful password verification. If parameters</span>
<span class="sd">    have been updated (stronger settings), rehash the password.</span>

<span class="sd">    Args:</span>
<span class="sd">        hash: The stored Argon2id hash string.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if the hash should be recomputed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_hasher</span><span class="o">.</span><span class="n">check_needs_rehash</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>


<span class="c1"># â”€â”€â”€ Password Strength Validation â”€â”€â”€</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PasswordStrengthError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when password does not meet strength requirements.&quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="k">def</span><span class="w"> </span><span class="nf">validate_password_strength</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate password meets minimum strength requirements.</span>

<span class="sd">    Requirements:</span>
<span class="sd">    - Minimum 8 characters (NIST recommends allowing up to 64)</span>
<span class="sd">    - At least one uppercase letter</span>
<span class="sd">    - At least one lowercase letter</span>
<span class="sd">    - At least one digit</span>
<span class="sd">    - At least one special character</span>
<span class="sd">    - Not a commonly breached password</span>

<span class="sd">    Raises:</span>
<span class="sd">        PasswordStrengthError if password is too weak.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PasswordStrengthError</span><span class="p">(</span>
            <span class="s2">&quot;Password must be at least 8 characters long&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PasswordStrengthError</span><span class="p">(</span>
            <span class="s2">&quot;Password must not exceed 128 characters&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[A-Z]&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PasswordStrengthError</span><span class="p">(</span>
            <span class="s2">&quot;Password must contain at least one uppercase letter&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[a-z]&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PasswordStrengthError</span><span class="p">(</span>
            <span class="s2">&quot;Password must contain at least one lowercase letter&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PasswordStrengthError</span><span class="p">(</span>
            <span class="s2">&quot;Password must contain at least one digit&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[!@#$%^&amp;*()_+\-=\[\]</span><span class="si">{}</span><span class="s1">;:</span><span class="se">\&#39;</span><span class="s1">&quot;,.&lt;&gt;?/</span><span class="se">\\</span><span class="s1">|`~]&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PasswordStrengthError</span><span class="p">(</span>
            <span class="s2">&quot;Password must contain at least one special character&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Check against common passwords (simplified list)</span>
    <span class="c1"># In production, use a larger list (e.g., Have I Been Pwned API)</span>
    <span class="n">COMMON_PASSWORDS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;password1&#39;</span><span class="p">,</span> <span class="s1">&#39;12345678&#39;</span><span class="p">,</span> <span class="s1">&#39;qwerty123&#39;</span><span class="p">,</span>
        <span class="s1">&#39;admin123&#39;</span><span class="p">,</span> <span class="s1">&#39;letmein1&#39;</span><span class="p">,</span> <span class="s1">&#39;welcome1&#39;</span><span class="p">,</span> <span class="s1">&#39;monkey123&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dragon12&#39;</span><span class="p">,</span> <span class="s1">&#39;master12&#39;</span><span class="p">,</span> <span class="s1">&#39;password123&#39;</span><span class="p">,</span> <span class="s1">&#39;abc12345&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">password</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">COMMON_PASSWORDS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PasswordStrengthError</span><span class="p">(</span>
            <span class="s2">&quot;This password is too common. Please choose a stronger password.&quot;</span>
        <span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="4-jwt-authentication-with-refresh-tokens">4. JWT Authentication with Refresh Tokens<a class="header-link" href="#4-jwt-authentication-with-refresh-tokens" title="Permanent link">&para;</a></h2>
<h3 id="41-token-architecture">4.1 Token Architecture<a class="header-link" href="#41-token-architecture" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                </span><span class="n">JWT</span><span class="w"> </span><span class="n">Token</span><span class="w"> </span><span class="n">Architecture</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Access</span><span class="w"> </span><span class="n">Token</span><span class="w"> </span><span class="p">(</span><span class="n">short</span><span class="o">-</span><span class="n">lived</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="nb">min</span><span class="p">)</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Header</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;HS256&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT&quot;</span><span class="p">}</span><span class="w">        </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Payload</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">                                      </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user-uuid&quot;</span><span class="p">,</span><span class="w">                           </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="w">                               </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;access&quot;</span><span class="p">,</span><span class="w">                             </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1706000000</span><span class="p">,</span><span class="w">     </span><span class="err">â†</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="nb">min</span><span class="w"> </span><span class="n">expiry</span><span class="w">       </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1706000000</span><span class="p">,</span><span class="w">                            </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;unique-token-id&quot;</span><span class="w">                      </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="p">}</span><span class="w">                                               </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Signature</span><span class="p">:</span><span class="w"> </span><span class="n">HMAC</span><span class="o">-</span><span class="n">SHA256</span><span class="p">(</span><span class="n">header</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">)</span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Refresh</span><span class="w"> </span><span class="n">Token</span><span class="w"> </span><span class="p">(</span><span class="n">long</span><span class="o">-</span><span class="n">lived</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">days</span><span class="p">)</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Stored</span><span class="w"> </span><span class="ow">in</span><span class="p">:</span><span class="w"> </span><span class="n">HTTP</span><span class="o">-</span><span class="n">only</span><span class="w"> </span><span class="n">secure</span><span class="w"> </span><span class="n">cookie</span><span class="w">              </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Payload</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">                                      </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user-uuid&quot;</span><span class="p">,</span><span class="w">                           </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;refresh&quot;</span><span class="p">,</span><span class="w">                            </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1706600000</span><span class="p">,</span><span class="w">     </span><span class="err">â†</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">day</span><span class="w"> </span><span class="n">expiry</span><span class="w">        </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;unique-token-id&quot;</span><span class="w">                      </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="p">}</span><span class="w">                                               </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Also</span><span class="w"> </span><span class="n">tracked</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">revocation</span><span class="w">               </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Token</span><span class="w"> </span><span class="n">Flow</span><span class="p">:</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">Login</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">access_token</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">refresh_token</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">calls</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">access_token</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">Authorization</span><span class="w"> </span><span class="n">header</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="n">access_token</span><span class="w"> </span><span class="n">expires</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">refresh_token</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">pair</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">4.</span><span class="w"> </span><span class="n">refresh_token</span><span class="w"> </span><span class="n">expires</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Must</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="n">again</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">5.</span><span class="w"> </span><span class="n">Logout</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Revoke</span><span class="w"> </span><span class="n">refresh_token</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">DB</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="42-token-service-implementation">4.2 Token Service Implementation<a class="header-link" href="#42-token-service-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/services/token_service.py - JWT token creation and validation.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">jose</span><span class="w"> </span><span class="kn">import</span> <span class="n">jwt</span><span class="p">,</span> <span class="n">JWTError</span><span class="p">,</span> <span class="n">ExpiredSignatureError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_settings</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TokenPayload</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decoded token payload.&quot;&quot;&quot;</span>
    <span class="n">sub</span><span class="p">:</span> <span class="nb">str</span>                <span class="c1"># Subject (user ID)</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>      <span class="c1"># User role</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;access&quot;</span>    <span class="c1"># Token type: access or refresh</span>
    <span class="n">exp</span><span class="p">:</span> <span class="n">datetime</span>           <span class="c1"># Expiration time</span>
    <span class="n">iat</span><span class="p">:</span> <span class="n">datetime</span>           <span class="c1"># Issued at</span>
    <span class="n">jti</span><span class="p">:</span> <span class="nb">str</span>                <span class="c1"># JWT ID (unique identifier)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TokenPair</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Access + refresh token pair.&quot;&quot;&quot;</span>
    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">refresh_token</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bearer&quot;</span>
    <span class="n">expires_in</span><span class="p">:</span> <span class="nb">int</span>         <span class="c1"># Access token expiry in seconds</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a short-lived access token.</span>

<span class="sd">    Args:</span>
<span class="sd">        user_id: The user&#39;s unique identifier.</span>
<span class="sd">        role: The user&#39;s role for RBAC.</span>
<span class="sd">        expires_delta: Optional custom expiration time.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Encoded JWT string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">expire</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="p">(</span><span class="n">expires_delta</span> <span class="ow">or</span> <span class="n">timedelta</span><span class="p">(</span>
        <span class="n">minutes</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span>
    <span class="p">))</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;access&quot;</span><span class="p">,</span>
        <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">,</span>
        <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
        <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
        <span class="n">payload</span><span class="p">,</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">JWT_SECRET_KEY</span><span class="p">,</span>
        <span class="n">algorithm</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">JWT_ALGORITHM</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_refresh_token</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a long-lived refresh token.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (encoded JWT string, token JTI for DB storage).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">expire</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="p">(</span><span class="n">expires_delta</span> <span class="ow">or</span> <span class="n">timedelta</span><span class="p">(</span>
        <span class="n">days</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REFRESH_TOKEN_EXPIRE_DAYS</span>
    <span class="p">))</span>

    <span class="n">jti</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;refresh&quot;</span><span class="p">,</span>
        <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">,</span>
        <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
        <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="n">jti</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
        <span class="n">payload</span><span class="p">,</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">JWT_SECRET_KEY</span><span class="p">,</span>
        <span class="n">algorithm</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">JWT_ALGORITHM</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">token</span><span class="p">,</span> <span class="n">jti</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_token_pair</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenPair</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create both access and refresh tokens.&quot;&quot;&quot;</span>
    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">role</span><span class="p">)</span>
    <span class="n">refresh_token</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_refresh_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">TokenPair</span><span class="p">(</span>
        <span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span>
        <span class="n">refresh_token</span><span class="o">=</span><span class="n">refresh_token</span><span class="p">,</span>
        <span class="n">expires_in</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">decode_token</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expected_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;access&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenPayload</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decode and validate a JWT token.</span>

<span class="sd">    Args:</span>
<span class="sd">        token: The JWT string to decode.</span>
<span class="sd">        expected_type: Expected token type (&quot;access&quot; or &quot;refresh&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Decoded token payload.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If token is invalid, expired, or wrong type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="n">token</span><span class="p">,</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">JWT_SECRET_KEY</span><span class="p">,</span>
            <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">JWT_ALGORITHM</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">ExpiredSignatureError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Token has expired&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">JWTError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid token: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Validate token type</span>
    <span class="n">token_type</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">token_type</span> <span class="o">!=</span> <span class="n">expected_type</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid token type: expected </span><span class="si">{</span><span class="n">expected_type</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">token_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Validate required fields</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Token missing subject claim&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">TokenPayload</span><span class="p">(</span>
        <span class="n">sub</span><span class="o">=</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">],</span>
        <span class="n">role</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
        <span class="n">exp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">],</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
        <span class="n">iat</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;iat&quot;</span><span class="p">],</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
        <span class="n">jti</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jti&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="5-role-based-access-control-rbac">5. Role-Based Access Control (RBAC)<a class="header-link" href="#5-role-based-access-control-rbac" title="Permanent link">&para;</a></h2>
<h3 id="51-rbac-design">5.1 RBAC Design<a class="header-link" href="#51-rbac-design" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RBAC Permission Matrix                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Role         Permissions                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚  admin        users:read, users:write, users:delete,            â”‚
â”‚               admin:read, admin:write, system:manage             â”‚
â”‚                                                                  â”‚
â”‚  moderator    users:read, users:write,                           â”‚
â”‚               content:read, content:write, content:delete        â”‚
â”‚                                                                  â”‚
â”‚  user         self:read, self:write,                             â”‚
â”‚               content:read, content:write                        â”‚
â”‚                                                                  â”‚
â”‚  viewer       self:read, content:read                            â”‚
â”‚                                                                  â”‚
â”‚                                                                  â”‚
â”‚  Endpoint              Required Permission     Roles Allowed     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  GET  /users           users:read              admin, moderator  â”‚
â”‚  POST /users           users:write             admin             â”‚
â”‚  GET  /users/me        self:read               all               â”‚
â”‚  PUT  /users/me        self:write              all               â”‚
â”‚  DEL  /users/{id}      users:delete            admin             â”‚
â”‚  GET  /admin/stats     admin:read              admin             â”‚
â”‚  POST /admin/config    admin:write             admin             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="52-rbac-implementation">5.2 RBAC Implementation<a class="header-link" href="#52-rbac-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/utils/security.py - RBAC and authentication dependencies.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">Request</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPBearer</span><span class="p">,</span> <span class="n">HTTPAuthorizationCredentials</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.services.token_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">decode_token</span><span class="p">,</span> <span class="n">TokenPayload</span>


<span class="c1"># â”€â”€â”€ Role and Permission Definitions â”€â”€â”€</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Role</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;User roles in order of privilege.&quot;&quot;&quot;</span>
    <span class="n">ADMIN</span> <span class="o">=</span> <span class="s2">&quot;admin&quot;</span>
    <span class="n">MODERATOR</span> <span class="o">=</span> <span class="s2">&quot;moderator&quot;</span>
    <span class="n">USER</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
    <span class="n">VIEWER</span> <span class="o">=</span> <span class="s2">&quot;viewer&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Permission</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fine-grained permissions.&quot;&quot;&quot;</span>
    <span class="n">USERS_READ</span> <span class="o">=</span> <span class="s2">&quot;users:read&quot;</span>
    <span class="n">USERS_WRITE</span> <span class="o">=</span> <span class="s2">&quot;users:write&quot;</span>
    <span class="n">USERS_DELETE</span> <span class="o">=</span> <span class="s2">&quot;users:delete&quot;</span>
    <span class="n">SELF_READ</span> <span class="o">=</span> <span class="s2">&quot;self:read&quot;</span>
    <span class="n">SELF_WRITE</span> <span class="o">=</span> <span class="s2">&quot;self:write&quot;</span>
    <span class="n">CONTENT_READ</span> <span class="o">=</span> <span class="s2">&quot;content:read&quot;</span>
    <span class="n">CONTENT_WRITE</span> <span class="o">=</span> <span class="s2">&quot;content:write&quot;</span>
    <span class="n">CONTENT_DELETE</span> <span class="o">=</span> <span class="s2">&quot;content:delete&quot;</span>
    <span class="n">ADMIN_READ</span> <span class="o">=</span> <span class="s2">&quot;admin:read&quot;</span>
    <span class="n">ADMIN_WRITE</span> <span class="o">=</span> <span class="s2">&quot;admin:write&quot;</span>
    <span class="n">SYSTEM_MANAGE</span> <span class="o">=</span> <span class="s2">&quot;system:manage&quot;</span>


<span class="c1"># Role â†’ Permissions mapping</span>
<span class="n">ROLE_PERMISSIONS</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Role</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="n">Permission</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Role</span><span class="o">.</span><span class="n">ADMIN</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">USERS_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">USERS_WRITE</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">USERS_DELETE</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">SELF_READ</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">SELF_WRITE</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_READ</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_WRITE</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_DELETE</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">ADMIN_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">ADMIN_WRITE</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">SYSTEM_MANAGE</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">Role</span><span class="o">.</span><span class="n">MODERATOR</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">USERS_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">USERS_WRITE</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">SELF_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">SELF_WRITE</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_WRITE</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_DELETE</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">Role</span><span class="o">.</span><span class="n">USER</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">SELF_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">SELF_WRITE</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_WRITE</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">Role</span><span class="o">.</span><span class="n">VIEWER</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">SELF_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_READ</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">has_permission</span><span class="p">(</span><span class="n">role</span><span class="p">:</span> <span class="n">Role</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="n">Permission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a role has a specific permission.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">permission</span> <span class="ow">in</span> <span class="n">ROLE_PERMISSIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>


<span class="c1"># â”€â”€â”€ FastAPI Dependencies â”€â”€â”€</span>

<span class="n">security_scheme</span> <span class="o">=</span> <span class="n">HTTPBearer</span><span class="p">(</span>
    <span class="n">scheme_name</span><span class="o">=</span><span class="s2">&quot;JWT&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enter your JWT access token&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
    <span class="n">credentials</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
        <span class="n">HTTPAuthorizationCredentials</span><span class="p">,</span>
        <span class="n">Depends</span><span class="p">(</span><span class="n">security_scheme</span><span class="p">)</span>
    <span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenPayload</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dependency: Extract and validate JWT from Authorization header.</span>
<span class="sd">    Returns the decoded token payload.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">credentials</span><span class="p">,</span> <span class="n">expected_type</span><span class="o">=</span><span class="s2">&quot;access&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid or expired token&quot;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">},</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">payload</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_role</span><span class="p">(</span><span class="o">*</span><span class="n">allowed_roles</span><span class="p">:</span> <span class="n">Role</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dependency factory: Require user to have one of the specified roles.</span>

<span class="sd">    Usage:</span>
<span class="sd">        @router.get(&quot;/admin&quot;, dependencies=[Depends(require_role(Role.ADMIN))])</span>
<span class="sd">        async def admin_endpoint():</span>
<span class="sd">            ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">role_checker</span><span class="p">(</span>
        <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">TokenPayload</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenPayload</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_role</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">role</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid role&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">user_role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_roles</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Insufficient permissions&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">current_user</span>

    <span class="k">return</span> <span class="n">role_checker</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_permission</span><span class="p">(</span><span class="n">permission</span><span class="p">:</span> <span class="n">Permission</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dependency factory: Require user to have a specific permission.</span>

<span class="sd">    Usage:</span>
<span class="sd">        @router.delete(&quot;/users/{id}&quot;,</span>
<span class="sd">                       dependencies=[Depends(require_permission(Permission.USERS_DELETE))])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">permission_checker</span><span class="p">(</span>
        <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">TokenPayload</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenPayload</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_role</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">role</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid role&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_permission</span><span class="p">(</span><span class="n">user_role</span><span class="p">,</span> <span class="n">permission</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Insufficient permissions&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">current_user</span>

    <span class="k">return</span> <span class="n">permission_checker</span>


<span class="c1"># Type alias for convenience</span>
<span class="n">CurrentUser</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">TokenPayload</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]</span>
</code></pre></div>

<hr />
<h2 id="6-input-validation-with-pydantic">6. Input Validation with Pydantic<a class="header-link" href="#6-input-validation-with-pydantic" title="Permanent link">&para;</a></h2>
<h3 id="61-user-schemas">6.1 User Schemas<a class="header-link" href="#61-user-schemas" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/schemas/user.py - Pydantic schemas for user data validation.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseModel</span><span class="p">,</span>
    <span class="n">EmailStr</span><span class="p">,</span>
    <span class="n">Field</span><span class="p">,</span>
    <span class="n">field_validator</span><span class="p">,</span>
    <span class="n">model_validator</span><span class="p">,</span>
    <span class="n">ConfigDict</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserCreate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Schema for user registration.&quot;&quot;&quot;</span>

    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span>
        <span class="n">min_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_-]+$&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Username (alphanumeric, underscores, hyphens only)&quot;</span><span class="p">,</span>
        <span class="n">examples</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;john_doe&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Valid email address&quot;</span><span class="p">,</span>
        <span class="n">examples</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span>
        <span class="n">min_length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Password (min 8 chars, must include upper, lower, digit, special)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">full_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Full name (optional)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">username_not_reserved</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure username is not a reserved name.&quot;&quot;&quot;</span>
        <span class="n">reserved</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;administrator&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span>
            <span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="s1">&#39;www&#39;</span><span class="p">,</span> <span class="s1">&#39;mail&#39;</span><span class="p">,</span> <span class="s1">&#39;support&#39;</span><span class="p">,</span> <span class="s1">&#39;help&#39;</span><span class="p">,</span>
            <span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="s1">&#39;undefined&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">reserved</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Username &#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39; is reserved&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">email_normalize</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize email to lowercase.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s1">&#39;full_name&#39;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sanitize_full_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sanitize full name to prevent injection.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
        <span class="c1"># Remove any HTML tags</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;[^&gt;]*&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="c1"># Remove control characters</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\x00-\x1f\x7f-\x9f]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserUpdate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Schema for updating user profile.&quot;&quot;&quot;</span>

    <span class="n">full_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span>
    <span class="p">)</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EmailStr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s1">&#39;full_name&#39;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sanitize_full_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;[^&gt;]*&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\x00-\x1f\x7f-\x9f]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Schema for user data in responses. Never include password hash.&quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">full_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">from_attributes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># IMPORTANT: No password_hash field! Never expose hashes.</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserListResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Paginated user list response.&quot;&quot;&quot;</span>
    <span class="n">users</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">UserResponse</span><span class="p">]</span>
    <span class="n">total</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">page</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">per_page</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">pages</span><span class="p">:</span> <span class="nb">int</span>


<span class="k">class</span><span class="w"> </span><span class="nc">PasswordChange</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Schema for password change request.&quot;&quot;&quot;</span>

    <span class="n">current_password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">new_password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;after&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">passwords_different</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure new password differs from current.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_password</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_password</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;New password must be different from current password&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>

<h3 id="62-auth-schemas">6.2 Auth Schemas<a class="header-link" href="#62-auth-schemas" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/schemas/auth.py - Authentication request/response schemas.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span><span class="p">,</span> <span class="n">Field</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LoginRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Login request schema.&quot;&quot;&quot;</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TokenResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Token response after successful authentication.&quot;&quot;&quot;</span>
    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bearer&quot;</span>
    <span class="n">expires_in</span><span class="p">:</span> <span class="nb">int</span>
    <span class="c1"># refresh_token is sent as HTTP-only cookie, not in body</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RefreshRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Token refresh request.&quot;&quot;&quot;</span>
    <span class="n">refresh_token</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MessageResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generic message response.&quot;&quot;&quot;</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</code></pre></div>

<hr />
<h2 id="7-middleware-rate-limiting">7. Middleware: Rate Limiting<a class="header-link" href="#7-middleware-rate-limiting" title="Permanent link">&para;</a></h2>
<h3 id="71-rate-limiter">7.1 Rate Limiter<a class="header-link" href="#71-rate-limiter" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/middleware/rate_limiter.py - Rate limiting middleware.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">slowapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Limiter</span><span class="p">,</span> <span class="n">_rate_limit_exceeded_handler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">slowapi.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_remote_address</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">slowapi.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">RateLimitExceeded</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_client_ip</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the real client IP, considering proxy headers.</span>

<span class="sd">    IMPORTANT: Only trust X-Forwarded-For if behind a trusted proxy.</span>
<span class="sd">    In production, configure this based on your infrastructure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If behind a trusted reverse proxy (nginx, AWS ALB, etc.)</span>
    <span class="n">forwarded_for</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Forwarded-For&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">forwarded_for</span><span class="p">:</span>
        <span class="c1"># Take the first IP (client&#39;s real IP)</span>
        <span class="k">return</span> <span class="n">forwarded_for</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># Direct connection</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span>

    <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>


<span class="c1"># Create limiter instance</span>
<span class="n">limiter</span> <span class="o">=</span> <span class="n">Limiter</span><span class="p">(</span>
    <span class="n">key_func</span><span class="o">=</span><span class="n">get_client_ip</span><span class="p">,</span>
    <span class="n">default_limits</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;60/minute&quot;</span><span class="p">],</span>  <span class="c1"># Global default</span>
    <span class="n">storage_uri</span><span class="o">=</span><span class="s2">&quot;memory://&quot;</span><span class="p">,</span>       <span class="c1"># Use Redis in production:</span>
    <span class="c1"># storage_uri=&quot;redis://localhost:6379/0&quot;</span>
<span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="8-middleware-security-headers">8. Middleware: Security Headers<a class="header-link" href="#8-middleware-security-headers" title="Permanent link">&para;</a></h2>
<h3 id="81-security-headers-middleware">8.1 Security Headers Middleware<a class="header-link" href="#81-security-headers-middleware" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/middleware/security_headers.py - Add security headers to all responses.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">starlette.middleware.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseHTTPMiddleware</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SecurityHeadersMiddleware</span><span class="p">(</span><span class="n">BaseHTTPMiddleware</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add security headers to every response.</span>
<span class="sd">    These headers protect against common web attacks.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># Prevent clickjacking</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Frame-Options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DENY&quot;</span>

        <span class="c1"># Prevent MIME type sniffing</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Content-Type-Options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;nosniff&quot;</span>

        <span class="c1"># Control referrer information</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Referrer-Policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;strict-origin-when-cross-origin&quot;</span>

        <span class="c1"># Content Security Policy</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Security-Policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;default-src &#39;none&#39;; &quot;</span>
            <span class="s2">&quot;frame-ancestors &#39;none&#39;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Permissions Policy (disable unnecessary browser features)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Permissions-Policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;camera=(), &quot;</span>
            <span class="s2">&quot;microphone=(), &quot;</span>
            <span class="s2">&quot;geolocation=(), &quot;</span>
            <span class="s2">&quot;payment=()&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Strict Transport Security (HTTPS only)</span>
        <span class="c1"># Only enable in production with HTTPS</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Strict-Transport-Security&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;max-age=31536000; includeSubDomains&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Prevent caching of authenticated responses</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Authorization&quot;</span><span class="p">):</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Cache-Control&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;no-store, no-cache, must-revalidate, private&quot;</span>
            <span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Pragma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;no-cache&quot;</span>

        <span class="c1"># Remove server identification header</span>
        <span class="k">if</span> <span class="s2">&quot;server&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<hr />
<h2 id="9-middleware-request-logging">9. Middleware: Request Logging<a class="header-link" href="#9-middleware-request-logging" title="Permanent link">&para;</a></h2>
<h3 id="91-structured-security-logging">9.1 Structured Security Logging<a class="header-link" href="#91-structured-security-logging" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/utils/logging.py - Structured security logging.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">structlog</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_settings</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">setup_logging</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure structured logging.&quot;&quot;&quot;</span>
    <span class="n">structlog</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="n">processors</span><span class="o">=</span><span class="p">[</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">contextvars</span><span class="o">.</span><span class="n">merge_contextvars</span><span class="p">,</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">filter_by_level</span><span class="p">,</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">add_logger_name</span><span class="p">,</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">add_log_level</span><span class="p">,</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">PositionalArgumentsFormatter</span><span class="p">(),</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">processors</span><span class="o">.</span><span class="n">TimeStamper</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;iso&quot;</span><span class="p">),</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">processors</span><span class="o">.</span><span class="n">StackInfoRenderer</span><span class="p">(),</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">processors</span><span class="o">.</span><span class="n">UnicodeDecoder</span><span class="p">(),</span>
            <span class="c1"># JSON output for production, console for development</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">processors</span><span class="o">.</span><span class="n">JSONRenderer</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">LOG_FORMAT</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span>
            <span class="k">else</span> <span class="n">structlog</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">ConsoleRenderer</span><span class="p">(),</span>
        <span class="p">],</span>
        <span class="n">wrapper_class</span><span class="o">=</span><span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">BoundLogger</span><span class="p">,</span>
        <span class="n">context_class</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
        <span class="n">logger_factory</span><span class="o">=</span><span class="n">structlog</span><span class="o">.</span><span class="n">PrintLoggerFactory</span><span class="p">(),</span>
        <span class="n">cache_logger_on_first_use</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_security_logger</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">structlog</span><span class="o">.</span><span class="n">BoundLogger</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a logger configured for security events.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;security&quot;</span><span class="p">)</span>


<span class="c1"># â”€â”€â”€ Specific Security Event Loggers â”€â”€â”€</span>

<span class="k">def</span><span class="w"> </span><span class="nf">log_authentication_event</span><span class="p">(</span>
    <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log authentication events (login, logout, token refresh).</span>

<span class="sd">    IMPORTANT: Never log passwords or tokens.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
    <span class="n">log_func</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="n">logger</span><span class="o">.</span><span class="n">warning</span>

    <span class="n">log_func</span><span class="p">(</span>
        <span class="s2">&quot;authentication_event&quot;</span><span class="p">,</span>
        <span class="n">event_type</span><span class="o">=</span><span class="n">event_type</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="n">_mask_email</span><span class="p">(</span><span class="n">email</span><span class="p">),</span>
        <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
        <span class="n">user_agent</span><span class="o">=</span><span class="n">user_agent</span><span class="p">[:</span><span class="mi">200</span><span class="p">],</span>  <span class="c1"># Truncate long user agents</span>
        <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">log_authorization_event</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">granted</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log authorization decisions.&quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
    <span class="n">log_func</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="k">if</span> <span class="n">granted</span> <span class="k">else</span> <span class="n">logger</span><span class="o">.</span><span class="n">warning</span>

    <span class="n">log_func</span><span class="p">(</span>
        <span class="s2">&quot;authorization_event&quot;</span><span class="p">,</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
        <span class="n">granted</span><span class="o">=</span><span class="n">granted</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">log_security_violation</span><span class="p">(</span>
    <span class="n">violation_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">details</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">severity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;HIGH&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log security violations (rate limiting, invalid tokens, etc.).&quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="s2">&quot;security_violation&quot;</span><span class="p">,</span>
        <span class="n">violation_type</span><span class="o">=</span><span class="n">violation_type</span><span class="p">,</span>
        <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">severity</span><span class="o">=</span><span class="n">severity</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">log_data_access</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">resource_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">resource_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log data access for audit trail.&quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;data_access&quot;</span><span class="p">,</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">resource_type</span><span class="o">=</span><span class="n">resource_type</span><span class="p">,</span>
        <span class="n">resource_id</span><span class="o">=</span><span class="n">resource_id</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_mask_email</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mask email for logging (show first char and domain only).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;@&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">email</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;***&#39;</span>
    <span class="n">local</span><span class="p">,</span> <span class="n">domain</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">masked_local</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">masked_local</span> <span class="o">=</span> <span class="n">local</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">masked_local</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<h3 id="92-request-logging-middleware">9.2 Request Logging Middleware<a class="header-link" href="#92-request-logging-middleware" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/middleware/request_logging.py - Log all HTTP requests.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">starlette.middleware.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseHTTPMiddleware</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_security_logger</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RequestLoggingMiddleware</span><span class="p">(</span><span class="n">BaseHTTPMiddleware</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log every HTTP request with timing and security-relevant info.&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
        <span class="c1"># Generate unique request ID</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Add request ID to response headers</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Request-ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_id</span>

        <span class="c1"># Calculate duration</span>
        <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>

        <span class="c1"># Log the request</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
        <span class="n">log_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="n">request_id</span><span class="p">,</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">)</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="s2">&quot;duration_ms&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
            <span class="s2">&quot;user_agent&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user-agent&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)[:</span><span class="mi">200</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;http_request&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">log_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;http_request&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">log_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;http_request&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">log_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<hr />
<h2 id="10-error-handling-without-information-leakage">10. Error Handling Without Information Leakage<a class="header-link" href="#10-error-handling-without-information-leakage" title="Permanent link">&para;</a></h2>
<h3 id="101-safe-error-handling">10.1 Safe Error Handling<a class="header-link" href="#101-safe-error-handling" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/main.py - Application setup with safe error handling.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestValidationError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">slowapi.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">RateLimitExceeded</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.middleware.security_headers</span><span class="w"> </span><span class="kn">import</span> <span class="n">SecurityHeadersMiddleware</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.middleware.rate_limiter</span><span class="w"> </span><span class="kn">import</span> <span class="n">limiter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.middleware.request_logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestLoggingMiddleware</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.routers</span><span class="w"> </span><span class="kn">import</span> <span class="n">auth</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">admin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_logging</span><span class="p">,</span> <span class="n">get_security_logger</span><span class="p">,</span> <span class="n">log_security_violation</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">()</span>


<span class="nd">@asynccontextmanager</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Application startup/shutdown events.&quot;&quot;&quot;</span>
    <span class="n">setup_logging</span><span class="p">()</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;application_start&quot;</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ENVIRONMENT</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;application_shutdown&quot;</span><span class="p">)</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">APP_NAME</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">APP_VERSION</span><span class="p">,</span>
    <span class="c1"># Disable docs in production</span>
    <span class="n">docs_url</span><span class="o">=</span><span class="s2">&quot;/docs&quot;</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">redoc_url</span><span class="o">=</span><span class="s2">&quot;/redoc&quot;</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">openapi_url</span><span class="o">=</span><span class="s2">&quot;/openapi.json&quot;</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lifespan</span><span class="o">=</span><span class="n">lifespan</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># â”€â”€â”€ Middleware (order matters: last added = first executed) â”€â”€â”€</span>

<span class="c1"># 1. Request logging (outermost)</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">RequestLoggingMiddleware</span><span class="p">)</span>

<span class="c1"># 2. Security headers</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">SecurityHeadersMiddleware</span><span class="p">)</span>

<span class="c1"># 3. CORS</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
    <span class="n">CORSMiddleware</span><span class="p">,</span>
    <span class="n">allow_origins</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CORS_ORIGINS</span><span class="p">,</span>
    <span class="n">allow_credentials</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CORS_ALLOW_CREDENTIALS</span><span class="p">,</span>
    <span class="n">allow_methods</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CORS_ALLOW_METHODS</span><span class="p">,</span>
    <span class="n">allow_headers</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CORS_ALLOW_HEADERS</span><span class="p">,</span>
    <span class="n">expose_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X-Request-ID&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># 4. Rate limiter</span>
<span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">limiter</span> <span class="o">=</span> <span class="n">limiter</span>


<span class="c1"># â”€â”€â”€ Error Handlers â”€â”€â”€</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">RateLimitExceeded</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rate_limit_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">RateLimitExceeded</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle rate limit exceeded errors.&quot;&quot;&quot;</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">log_security_violation</span><span class="p">(</span>
        <span class="n">violation_type</span><span class="o">=</span><span class="s2">&quot;RATE_LIMIT_EXCEEDED&quot;</span><span class="p">,</span>
        <span class="n">details</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Rate limit exceeded on </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;rate_limit_exceeded&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Too many requests. Please try again later.&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Retry-After&quot;</span><span class="p">:</span> <span class="s2">&quot;60&quot;</span><span class="p">},</span>
    <span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">RequestValidationError</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validation_error_handler</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">RequestValidationError</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle validation errors.</span>

<span class="sd">    IMPORTANT: Return generic message. Do not expose internal</span>
<span class="sd">    validation details that could help an attacker craft payloads.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Log full details internally</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
        <span class="s2">&quot;validation_error&quot;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
        <span class="n">errors</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">errors</span><span class="p">())[:</span><span class="mi">500</span><span class="p">],</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Return sanitized error to client</span>
    <span class="c1"># In production: generic message</span>
    <span class="c1"># In development: include field-level details</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="c1"># Development: helpful error messages</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_422_UNPROCESSABLE_ENTITY</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;validation_error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Request validation failed&quot;</span><span class="p">,</span>
                <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">err</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">]),</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">err</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">exc</span><span class="o">.</span><span class="n">errors</span><span class="p">()</span>
                <span class="p">],</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Production: minimal information</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_422_UNPROCESSABLE_ENTITY</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;validation_error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid request data&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">general_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Catch-all error handler.</span>

<span class="sd">    CRITICAL: Never expose stack traces, internal paths,</span>
<span class="sd">    database details, or any implementation details to clients.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Log full error internally</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="s2">&quot;unhandled_exception&quot;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
        <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="n">error_message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)[:</span><span class="mi">500</span><span class="p">],</span>
        <span class="n">traceback</span><span class="o">=</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()[:</span><span class="mi">2000</span><span class="p">],</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Return generic error to client</span>
    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;internal_server_error&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;An unexpected error occurred. Please try again later.&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>


<span class="c1"># â”€â”€â”€ Routers â”€â”€â”€</span>

<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1/auth&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Authentication&quot;</span><span class="p">])</span>
<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1/users&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Users&quot;</span><span class="p">])</span>
<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1/admin&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Admin&quot;</span><span class="p">])</span>


<span class="c1"># â”€â”€â”€ Health Check â”€â”€â”€</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Health&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Public health check endpoint (no auth required).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">APP_VERSION</span><span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="11-authentication-endpoints">11. Authentication Endpoints<a class="header-link" href="#11-authentication-endpoints" title="Permanent link">&para;</a></h2>
<h3 id="111-auth-router">11.1 Auth Router<a class="header-link" href="#111-auth-router" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/routers/auth.py - Authentication endpoints.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSession</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_db</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.middleware.rate_limiter</span><span class="w"> </span><span class="kn">import</span> <span class="n">limiter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.schemas.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoginRequest</span><span class="p">,</span> <span class="n">TokenResponse</span><span class="p">,</span> <span class="n">MessageResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.schemas.user</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserCreate</span><span class="p">,</span> <span class="n">UserResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.services.auth_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">AuthService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_authentication_event</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils.password</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_password_strength</span><span class="p">,</span> <span class="n">PasswordStrengthError</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">()</span>
<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s2">&quot;/register&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">UserResponse</span><span class="p">,</span>
    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">REGISTER_RATE_LIMIT</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">user_data</span><span class="p">:</span> <span class="n">UserCreate</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register a new user account.</span>

<span class="sd">    Rate limited to prevent abuse.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate password strength</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">validate_password_strength</span><span class="p">(</span><span class="n">user_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">PasswordStrengthError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="n">auth_service</span> <span class="o">=</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1"># Check if user already exists</span>
    <span class="n">existing</span> <span class="o">=</span> <span class="k">await</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">get_user_by_email</span><span class="p">(</span><span class="n">user_data</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
        <span class="c1"># IMPORTANT: Don&#39;t reveal if email exists</span>
        <span class="c1"># Use a generic message for both &quot;exists&quot; and &quot;created&quot;</span>
        <span class="c1"># to prevent user enumeration</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Unable to create account with provided information&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Create user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">log_authentication_event</span><span class="p">(</span>
        <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;registration&quot;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="n">user_data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
        <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
        <span class="n">user_agent</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user-agent&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">user</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">TokenResponse</span><span class="p">)</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOGIN_RATE_LIMIT</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">login_data</span><span class="p">:</span> <span class="n">LoginRequest</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Authenticate user and return JWT tokens.</span>

<span class="sd">    Access token in response body, refresh token as HTTP-only cookie.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">user_agent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user-agent&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">auth_service</span> <span class="o">=</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span>
        <span class="n">login_data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">login_data</span><span class="o">.</span><span class="n">password</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">log_authentication_event</span><span class="p">(</span>
            <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;login&quot;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="n">login_data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
            <span class="n">user_agent</span><span class="o">=</span><span class="n">user_agent</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;invalid_credentials&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># IMPORTANT: Generic error message - don&#39;t reveal</span>
        <span class="c1"># whether email exists or password is wrong</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid email or password&quot;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">},</span>
        <span class="p">)</span>

    <span class="n">user</span><span class="p">,</span> <span class="n">token_pair</span> <span class="o">=</span> <span class="n">result</span>

    <span class="c1"># Set refresh token as HTTP-only secure cookie</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">token_pair</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">,</span>
        <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>             <span class="c1"># JavaScript cannot access</span>
        <span class="n">secure</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SECURE_COOKIES</span><span class="p">,</span>  <span class="c1"># HTTPS only in production</span>
        <span class="n">samesite</span><span class="o">=</span><span class="s2">&quot;lax&quot;</span><span class="p">,</span>           <span class="c1"># CSRF protection</span>
        <span class="n">max_age</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REFRESH_TOKEN_EXPIRE_DAYS</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/v1/auth&quot;</span><span class="p">,</span>      <span class="c1"># Only sent to auth endpoints</span>
    <span class="p">)</span>

    <span class="n">log_authentication_event</span><span class="p">(</span>
        <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;login&quot;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="n">login_data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
        <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
        <span class="n">user_agent</span><span class="o">=</span><span class="n">user_agent</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">TokenResponse</span><span class="p">(</span>
        <span class="n">access_token</span><span class="o">=</span><span class="n">token_pair</span><span class="o">.</span><span class="n">access_token</span><span class="p">,</span>
        <span class="n">expires_in</span><span class="o">=</span><span class="n">token_pair</span><span class="o">.</span><span class="n">expires_in</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/refresh&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">TokenResponse</span><span class="p">)</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="s2">&quot;10/minute&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">refresh_token</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Refresh access token using refresh token from cookie.</span>

<span class="sd">    Implements token rotation: old refresh token is invalidated,</span>
<span class="sd">    new refresh token is issued.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh_token</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Refresh token not found&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">auth_service</span> <span class="o">=</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">refresh_tokens</span><span class="p">(</span><span class="n">refresh_token</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="c1"># Clear the invalid cookie</span>
        <span class="n">response</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/v1/auth&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid or expired refresh token&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">new_token_pair</span> <span class="o">=</span> <span class="n">result</span>

    <span class="c1"># Rotate refresh token (set new cookie)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">new_token_pair</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">,</span>
        <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">secure</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SECURE_COOKIES</span><span class="p">,</span>
        <span class="n">samesite</span><span class="o">=</span><span class="s2">&quot;lax&quot;</span><span class="p">,</span>
        <span class="n">max_age</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REFRESH_TOKEN_EXPIRE_DAYS</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/v1/auth&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">TokenResponse</span><span class="p">(</span>
        <span class="n">access_token</span><span class="o">=</span><span class="n">new_token_pair</span><span class="o">.</span><span class="n">access_token</span><span class="p">,</span>
        <span class="n">expires_in</span><span class="o">=</span><span class="n">new_token_pair</span><span class="o">.</span><span class="n">expires_in</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/logout&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">MessageResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Logout: revoke refresh token and clear cookie.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_token</span><span class="p">:</span>
        <span class="n">auth_service</span> <span class="o">=</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">revoke_refresh_token</span><span class="p">(</span><span class="n">refresh_token</span><span class="p">)</span>

    <span class="c1"># Clear the refresh token cookie</span>
    <span class="n">response</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/v1/auth&quot;</span><span class="p">)</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">log_authentication_event</span><span class="p">(</span>
        <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;logout&quot;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
        <span class="n">user_agent</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user-agent&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">MessageResponse</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Successfully logged out&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="12-user-endpoints">12. User Endpoints<a class="header-link" href="#12-user-endpoints" title="Permanent link">&para;</a></h2>
<h3 id="121-user-router">12.1 User Router<a class="header-link" href="#121-user-router" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/routers/users.py - User management endpoints.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSession</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_db</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.schemas.user</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">UserResponse</span><span class="p">,</span> <span class="n">UserUpdate</span><span class="p">,</span> <span class="n">UserListResponse</span><span class="p">,</span> <span class="n">PasswordChange</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.services.user_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CurrentUser</span><span class="p">,</span> <span class="n">require_role</span><span class="p">,</span> <span class="n">require_permission</span><span class="p">,</span>
    <span class="n">Role</span><span class="p">,</span> <span class="n">Permission</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils.password</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_password_strength</span><span class="p">,</span> <span class="n">PasswordStrengthError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_data_access</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="c1"># â”€â”€â”€ Self-Service Endpoints (any authenticated user) â”€â”€â”€</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/me&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">UserResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user_profile</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">CurrentUser</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get current user&#39;s profile.&quot;&quot;&quot;</span>
    <span class="n">user_service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User not found&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">user</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;/me&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">UserResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_current_user_profile</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">update_data</span><span class="p">:</span> <span class="n">UserUpdate</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">CurrentUser</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update current user&#39;s profile.&quot;&quot;&quot;</span>
    <span class="n">user_service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_service</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span> <span class="n">update_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User not found&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">log_data_access</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
        <span class="n">resource_type</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="n">resource_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;update_profile&quot;</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">user</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/me/change-password&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">change_password</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">password_data</span><span class="p">:</span> <span class="n">PasswordChange</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">CurrentUser</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Change current user&#39;s password.&quot;&quot;&quot;</span>
    <span class="c1"># Validate new password strength</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">validate_password_strength</span><span class="p">(</span><span class="n">password_data</span><span class="o">.</span><span class="n">new_password</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">PasswordStrengthError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="n">user_service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_service</span><span class="o">.</span><span class="n">change_password</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
        <span class="n">current_password</span><span class="o">=</span><span class="n">password_data</span><span class="o">.</span><span class="n">current_password</span><span class="p">,</span>
        <span class="n">new_password</span><span class="o">=</span><span class="n">password_data</span><span class="o">.</span><span class="n">new_password</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Current password is incorrect&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">log_data_access</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
        <span class="n">resource_type</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="n">resource_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;change_password&quot;</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Password changed successfully&quot;</span><span class="p">}</span>


<span class="c1"># â”€â”€â”€ Admin Endpoints â”€â”€â”€</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s2">&quot;/&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">UserListResponse</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">require_permission</span><span class="p">(</span><span class="n">Permission</span><span class="o">.</span><span class="n">USERS_READ</span><span class="p">))],</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_users</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">per_page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">CurrentUser</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all users (admin/moderator only).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">per_page</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">per_page</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Cap maximum page size</span>

    <span class="n">user_service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">users</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_service</span><span class="o">.</span><span class="n">list_users</span><span class="p">(</span>
        <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">per_page</span>
    <span class="p">)</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">log_data_access</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
        <span class="n">resource_type</span><span class="o">=</span><span class="s2">&quot;user_list&quot;</span><span class="p">,</span>
        <span class="n">resource_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;page=</span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;list&quot;</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">UserListResponse</span><span class="p">(</span>
        <span class="n">users</span><span class="o">=</span><span class="n">users</span><span class="p">,</span>
        <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span>
        <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
        <span class="n">per_page</span><span class="o">=</span><span class="n">per_page</span><span class="p">,</span>
        <span class="n">pages</span><span class="o">=</span><span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">per_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">per_page</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s2">&quot;/</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">UserResponse</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">require_permission</span><span class="p">(</span><span class="n">Permission</span><span class="o">.</span><span class="n">USERS_READ</span><span class="p">))],</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">CurrentUser</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a specific user (admin/moderator only).&quot;&quot;&quot;</span>
    <span class="n">user_service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User not found&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">user</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
    <span class="s2">&quot;/</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">require_permission</span><span class="p">(</span><span class="n">Permission</span><span class="o">.</span><span class="n">USERS_DELETE</span><span class="p">))],</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_user</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">CurrentUser</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete a user (admin only).&quot;&quot;&quot;</span>
    <span class="c1"># Prevent self-deletion</span>
    <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Cannot delete your own account via this endpoint&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">user_service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User not found&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">log_data_access</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
        <span class="n">resource_type</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="n">resource_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;User deleted successfully&quot;</span><span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="13-security-tests">13. Security Tests<a class="header-link" href="#13-security-tests" title="Permanent link">&para;</a></h2>
<h3 id="131-test-configuration">13.1 Test Configuration<a class="header-link" href="#131-test-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">tests/conftest.py - Test fixtures and configuration.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncGenerator</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest_asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">httpx</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncClient</span><span class="p">,</span> <span class="n">ASGITransport</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">create_async_engine</span><span class="p">,</span>
    <span class="n">async_sessionmaker</span><span class="p">,</span>
    <span class="n">AsyncSession</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_db</span><span class="p">,</span> <span class="n">Base</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_settings</span>

<span class="c1"># Use SQLite for testing</span>
<span class="n">TEST_DATABASE_URL</span> <span class="o">=</span> <span class="s2">&quot;sqlite+aiosqlite:///./test.db&quot;</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">event_loop</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create event loop for async tests.&quot;&quot;&quot;</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">loop</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="nd">@pytest_asyncio</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">db_session</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">AsyncSession</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a test database session.&quot;&quot;&quot;</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span><span class="n">TEST_DATABASE_URL</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">)</span>

    <span class="n">session_factory</span> <span class="o">=</span> <span class="n">async_sessionmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">session_factory</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">session</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>


<span class="nd">@pytest_asyncio</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="n">db_session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">AsyncClient</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create test HTTP client with dependency overrides.&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">override_get_db</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">db_session</span>

    <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">get_db</span><span class="p">]</span> <span class="o">=</span> <span class="n">override_get_db</span>

    <span class="n">transport</span> <span class="o">=</span> <span class="n">ASGITransport</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncClient</span><span class="p">(</span><span class="n">transport</span><span class="o">=</span><span class="n">transport</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;http://test&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">c</span>

    <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<span class="nd">@pytest_asyncio</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">registered_user</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a registered user and return credentials.&quot;&quot;&quot;</span>
    <span class="n">user_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser&quot;</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;TestPass123!&quot;</span><span class="p">,</span>
        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Test User&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/register&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">user_data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="k">return</span> <span class="n">user_data</span>


<span class="nd">@pytest_asyncio</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">auth_headers</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">,</span> <span class="n">registered_user</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get authentication headers for a registered user.&quot;&quot;&quot;</span>
    <span class="n">login_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">registered_user</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
        <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">registered_user</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/login&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">login_data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
</code></pre></div>

<h3 id="132-security-specific-tests">13.2 Security-Specific Tests<a class="header-link" href="#132-security-specific-tests" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">tests/test_security.py - Security-focused tests.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">httpx</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncClient</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestAuthenticationSecurity</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test authentication security measures.&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_login_wrong_password_generic_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">,</span>
                                                       <span class="n">registered_user</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Login with wrong password should return generic error.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/login&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">registered_user</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;WrongPassword123!&quot;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>
        <span class="c1"># Should NOT say &quot;wrong password&quot; - just generic message</span>
        <span class="k">assert</span> <span class="s2">&quot;Invalid email or password&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;detail&quot;</span><span class="p">]</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_login_nonexistent_email_generic_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Login with non-existent email should return same error.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/login&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;nonexistent@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;SomePassword123!&quot;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>
        <span class="c1"># Same message as wrong password (prevents user enumeration)</span>
        <span class="k">assert</span> <span class="s2">&quot;Invalid email or password&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;detail&quot;</span><span class="p">]</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_registration_duplicate_email_generic_error</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">,</span> <span class="n">registered_user</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Duplicate registration should not reveal email exists.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/register&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;different_user&quot;</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">registered_user</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;NewPassword123!&quot;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
        <span class="c1"># Should NOT say &quot;email already exists&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;Unable to create account&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;detail&quot;</span><span class="p">]</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_weak_password_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Weak passwords should be rejected.&quot;&quot;&quot;</span>
        <span class="n">weak_passwords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;short1!&quot;</span><span class="p">,</span>          <span class="c1"># Too short</span>
            <span class="s2">&quot;alllowercase1!&quot;</span><span class="p">,</span>   <span class="c1"># No uppercase</span>
            <span class="s2">&quot;ALLUPPERCASE1!&quot;</span><span class="p">,</span>   <span class="c1"># No lowercase</span>
            <span class="s2">&quot;NoDigitsHere!&quot;</span><span class="p">,</span>    <span class="c1"># No digit</span>
            <span class="s2">&quot;NoSpecial123&quot;</span><span class="p">,</span>     <span class="c1"># No special char</span>
            <span class="s2">&quot;password123!&quot;</span><span class="p">,</span>     <span class="c1"># Common password</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">password</span> <span class="ow">in</span> <span class="n">weak_passwords</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/register&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test2@example.com&quot;</span><span class="p">,</span>
                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span><span class="p">,</span> \
                <span class="sa">f</span><span class="s2">&quot;Weak password accepted: </span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestAuthorizationSecurity</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test authorization and access control.&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_unauthenticated_access_denied</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Protected endpoints should reject unauthenticated requests.&quot;&quot;&quot;</span>
        <span class="n">protected_endpoints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/api/v1/users/me&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;/api/v1/users/me&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/api/v1/users/&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/api/v1/admin/stats&quot;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">protected_endpoints</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="mi">403</span><span class="p">),</span> \
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> accessible without auth&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_expired_token_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Expired tokens should be rejected.&quot;&quot;&quot;</span>
        <span class="c1"># Create a token with 0 second expiry</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">app.services.token_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_access_token</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>

        <span class="n">expired_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
            <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;test-id&quot;</span><span class="p">,</span>
            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
            <span class="n">expires_delta</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># Already expired</span>
        <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;/api/v1/users/me&quot;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">expired_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_malformed_token_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Malformed tokens should be rejected.&quot;&quot;&quot;</span>
        <span class="n">malformed_tokens</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;not-a-jwt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eyJ.eyJ.invalid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Bearer &quot;</span><span class="p">,</span>
            <span class="s2">&quot;null&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">malformed_tokens</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;/api/v1/users/me&quot;</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestInputValidation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test input validation and sanitization.&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_sql_injection_in_login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;SQL injection payloads should be handled safely.&quot;&quot;&quot;</span>
        <span class="n">payloads</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;&#39; OR &#39;1&#39;=&#39;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&#39;; DROP TABLE users; --&quot;</span><span class="p">,</span>
            <span class="s2">&quot;admin&#39;--&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">payload</span> <span class="ow">in</span> <span class="n">payloads</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/login&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">,</span>
                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="c1"># Should return 401 or 422, NOT 500</span>
            <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="mi">422</span><span class="p">),</span> \
                <span class="sa">f</span><span class="s2">&quot;SQLi payload caused error: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_xss_in_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;XSS payloads in username should be rejected.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/register&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;xss@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;SafePassword123!&quot;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="c1"># Should fail validation (username pattern: alphanumeric only)</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_oversized_input_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extremely large inputs should be rejected.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/register&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;big@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;BigPassword123!&quot;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestSecurityHeaders</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test security headers are present.&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_security_headers_present</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;All security headers should be set.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Frame-Options&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;DENY&quot;</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Content-Type-Options&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;nosniff&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;strict-origin&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Referrer-Policy&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Security-Policy&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_no_server_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Server header should not reveal implementation details.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;server&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># Should not reveal uvicorn, gunicorn, etc.</span>
        <span class="k">assert</span> <span class="s2">&quot;uvicorn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s2">&quot;python&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestErrorHandling</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test error handling doesn&#39;t leak information.&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_404_no_info_leak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">,</span> <span class="n">auth_headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;404 errors should not reveal internal paths.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;/api/v1/nonexistent&quot;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">auth_headers</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="c1"># Should not contain file paths or stack traces</span>
        <span class="k">assert</span> <span class="s2">&quot;/app/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s2">&quot;traceback&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s2">&quot;Traceback&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_500_no_stack_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;500 errors should not expose stack traces.&quot;&quot;&quot;</span>
        <span class="c1"># This tests the global exception handler</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>
        <span class="c1"># Health should work, but verify error format</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">assert</span> <span class="s2">&quot;traceback&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">assert</span> <span class="s2">&quot;File &quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="14-deployment-considerations">14. Deployment Considerations<a class="header-link" href="#14-deployment-considerations" title="Permanent link">&para;</a></h2>
<h3 id="141-production-deployment-checklist">14.1 Production Deployment Checklist<a class="header-link" href="#141-production-deployment-checklist" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">Production</span><span class="w"> </span><span class="n">Deployment</span><span class="w"> </span><span class="n">Checklist</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">HTTPS</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">TLS</span><span class="p">:</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="mf">1.2</span><span class="o">+</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="p">(</span><span class="n">disable</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.1</span><span class="p">)</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Strong</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="n">suites</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Valid</span><span class="w"> </span><span class="n">SSL</span><span class="w"> </span><span class="n">certificate</span><span class="w"> </span><span class="p">(</span><span class="n">Let</span><span class="s1">&#39;s Encrypt or CA-signed)         â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">HSTS</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="n">enabled</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">HTTP</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">HTTPS</span><span class="w"> </span><span class="n">redirect</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Reverse</span><span class="w"> </span><span class="n">Proxy</span><span class="w"> </span><span class="p">(</span><span class="n">nginx</span><span class="p">):</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Hide</span><span class="w"> </span><span class="n">backend</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">headers</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Rate</span><span class="w"> </span><span class="n">limiting</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">proxy</span><span class="w"> </span><span class="n">level</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Request</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">limits</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Timeout</span><span class="w"> </span><span class="n">configurations</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Access</span><span class="w"> </span><span class="n">logging</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Application</span><span class="p">:</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">False</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">docs</span><span class="w"> </span><span class="n">disabled</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">production</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Secrets</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="n">manager</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">All</span><span class="w"> </span><span class="n">dependencies</span><span class="w"> </span><span class="n">pinned</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">audited</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="n">handling</span><span class="p">:</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">traces</span><span class="w"> </span><span class="n">exposed</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Logging</span><span class="p">:</span><span class="w"> </span><span class="n">structured</span><span class="p">,</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">PII</span><span class="o">/</span><span class="n">secrets</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">logs</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Database</span><span class="p">:</span><span class="w">                                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Strong</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="n">user</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Minimal</span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="n">privileges</span><span class="w"> </span><span class="p">(</span><span class="n">no</span><span class="w"> </span><span class="n">admin</span><span class="o">/</span><span class="n">superuser</span><span class="p">)</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Encrypted</span><span class="w"> </span><span class="n">connections</span><span class="w"> </span><span class="p">(</span><span class="n">SSL</span><span class="o">/</span><span class="n">TLS</span><span class="p">)</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Regular</span><span class="w"> </span><span class="n">backups</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Connection</span><span class="w"> </span><span class="n">pooling</span><span class="w"> </span><span class="n">configured</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Infrastructure</span><span class="p">:</span><span class="w">                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Firewall</span><span class="p">:</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">necessary</span><span class="w"> </span><span class="n">ports</span><span class="w"> </span><span class="n">open</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">SSH</span><span class="w"> </span><span class="n">key</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">auth</span><span class="w"> </span><span class="n">only</span><span class="w">                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Regular</span><span class="w"> </span><span class="n">OS</span><span class="w"> </span><span class="n">patching</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Monitoring</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">alerting</span><span class="w"> </span><span class="n">configured</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">Log</span><span class="w"> </span><span class="n">aggregation</span><span class="w"> </span><span class="p">(</span><span class="n">ELK</span><span class="p">,</span><span class="w"> </span><span class="n">Datadog</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="o">.</span><span class="p">)</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="142-nginx-reverse-proxy-configuration">14.2 Nginx Reverse Proxy Configuration<a class="header-link" href="#142-nginx-reverse-proxy-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># /etc/nginx/sites-available/secure-api</span>

<span class="c1"># Redirect HTTP to HTTPS</span>
<span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">api.example.com</span><span class="p">;</span>
<span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="s">https://</span><span class="nv">$server_name$request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1"># HTTPS server</span>
<span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="w"> </span><span class="s">http2</span><span class="p">;</span>
<span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">api.example.com</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># SSL Configuration</span>
<span class="w">    </span><span class="kn">ssl_certificate</span><span class="w"> </span><span class="s">/etc/letsencrypt/live/api.example.com/fullchain.pem</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_certificate_key</span><span class="w"> </span><span class="s">/etc/letsencrypt/live/api.example.com/privkey.pem</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_protocols</span><span class="w"> </span><span class="s">TLSv1.2</span><span class="w"> </span><span class="s">TLSv1.3</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_ciphers</span><span class="w"> </span><span class="s">ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_prefer_server_ciphers</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_session_cache</span><span class="w"> </span><span class="s">shared:SSL:10m</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_session_timeout</span><span class="w"> </span><span class="mi">10m</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Security Headers (additional to app-level headers)</span>
<span class="w">    </span><span class="kn">add_header</span><span class="w"> </span><span class="s">X-Frame-Options</span><span class="w"> </span><span class="s">&quot;DENY&quot;</span><span class="w"> </span><span class="s">always</span><span class="p">;</span>
<span class="w">    </span><span class="kn">add_header</span><span class="w"> </span><span class="s">X-Content-Type-Options</span><span class="w"> </span><span class="s">&quot;nosniff&quot;</span><span class="w"> </span><span class="s">always</span><span class="p">;</span>
<span class="w">    </span><span class="kn">add_header</span><span class="w"> </span><span class="s">Strict-Transport-Security</span><span class="w"> </span><span class="s">&quot;max-age=31536000</span><span class="p">;</span><span class="w"> </span><span class="kn">includeSubDomains&quot;</span><span class="w"> </span><span class="s">always</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Hide nginx version</span>
<span class="w">    </span><span class="kn">server_tokens</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Request limits</span>
<span class="w">    </span><span class="kn">client_max_body_size</span><span class="w"> </span><span class="mi">10m</span><span class="p">;</span><span class="w">          </span><span class="c1"># Max request body size</span>
<span class="w">    </span><span class="kn">client_body_timeout</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span><span class="w">             </span><span class="c1"># Body read timeout</span>
<span class="w">    </span><span class="kn">client_header_timeout</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span><span class="w">           </span><span class="c1"># Header read timeout</span>

<span class="w">    </span><span class="c1"># Rate limiting zone</span>
<span class="w">    </span><span class="kn">limit_req_zone</span><span class="w"> </span><span class="nv">$binary_remote_addr</span><span class="w"> </span><span class="s">zone=api:10m</span><span class="w"> </span><span class="s">rate=60r/m</span><span class="p">;</span>

<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1"># Apply rate limiting</span>
<span class="w">        </span><span class="kn">limit_req</span><span class="w"> </span><span class="s">zone=api</span><span class="w"> </span><span class="s">burst=20</span><span class="w"> </span><span class="s">nodelay</span><span class="p">;</span>

<span class="w">        </span><span class="c1"># Proxy to FastAPI</span>
<span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://127.0.0.1:8000</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w"> </span><span class="nv">$remote_addr</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-Proto</span><span class="w"> </span><span class="nv">$scheme</span><span class="p">;</span>

<span class="w">        </span><span class="c1"># Proxy timeouts</span>
<span class="w">        </span><span class="kn">proxy_connect_timeout</span><span class="w"> </span><span class="s">5s</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_read_timeout</span><span class="w"> </span><span class="s">30s</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_send_timeout</span><span class="w"> </span><span class="s">30s</span><span class="p">;</span>

<span class="w">        </span><span class="c1"># Hide proxy headers</span>
<span class="w">        </span><span class="kn">proxy_hide_header</span><span class="w"> </span><span class="s">X-Powered-By</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1"># Block common attack paths</span>
<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">/\.(git|svn|env|htaccess)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kn">deny</span><span class="w"> </span><span class="s">all</span><span class="p">;</span>
<span class="w">        </span><span class="kn">return</span><span class="w"> </span><span class="mi">404</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1"># Access logging</span>
<span class="w">    </span><span class="kn">access_log</span><span class="w"> </span><span class="s">/var/log/nginx/api_access.log</span><span class="p">;</span>
<span class="w">    </span><span class="kn">error_log</span><span class="w"> </span><span class="s">/var/log/nginx/api_error.log</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="143-docker-deployment">14.3 Docker Deployment<a class="header-link" href="#143-docker-deployment" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c"># Dockerfile - Multi-stage build for smaller image</span>

<span class="c"># Stage 1: Build dependencies</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.12-slim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">builder</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/build</span>
<span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span>.
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>--prefix<span class="o">=</span>/install<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="c"># Stage 2: Production image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.12-slim</span>

<span class="c"># Security: Run as non-root user</span>
<span class="k">RUN</span><span class="w"> </span>groupadd<span class="w"> </span>-r<span class="w"> </span>appuser<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>useradd<span class="w"> </span>-r<span class="w"> </span>-g<span class="w"> </span>appuser<span class="w"> </span>-d<span class="w"> </span>/app<span class="w"> </span>-s<span class="w"> </span>/sbin/nologin<span class="w"> </span>appuser

<span class="c"># Copy dependencies from builder</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/install<span class="w"> </span>/usr/local

<span class="c"># Copy application</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<span class="k">COPY</span><span class="w"> </span>app/<span class="w"> </span>./app/
<span class="k">COPY</span><span class="w"> </span>alembic/<span class="w"> </span>./alembic/
<span class="k">COPY</span><span class="w"> </span>alembic.ini<span class="w"> </span>.

<span class="c"># Set ownership</span>
<span class="k">RUN</span><span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span>appuser:appuser<span class="w"> </span>/app

<span class="c"># Switch to non-root user</span>
<span class="k">USER</span><span class="w"> </span><span class="s">appuser</span>

<span class="c"># Environment</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">PYTHONUNBUFFERED</span><span class="o">=</span><span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">PYTHONDONTWRITEBYTECODE</span><span class="o">=</span><span class="m">1</span>

<span class="c"># Health check</span>
<span class="k">HEALTHCHECK</span><span class="w"> </span>--interval<span class="o">=</span>30s<span class="w"> </span>--timeout<span class="o">=</span>5s<span class="w"> </span>--retries<span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="k">CMD</span><span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import urllib.request; urllib.request.urlopen(&#39;http://localhost:8000/health&#39;)&quot;</span>

<span class="c"># Run with uvicorn</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;uvicorn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;app.main:app&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--host&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--port&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;8000&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--workers&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;4&quot;</span><span class="p">]</span>

<span class="c"># Do NOT expose port 8000 directly - use reverse proxy</span>
</code></pre></div>

<hr />
<h2 id="15-exercises">15. Exercises<a class="header-link" href="#15-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-implement-the-auth-service">Exercise 1: Implement the Auth Service<a class="header-link" href="#exercise-1-implement-the-auth-service" title="Permanent link">&para;</a></h3>
<p>Complete the <code>AuthService</code> class that handles:
1. User creation with Argon2 password hashing
2. Authentication (email + password verification)
3. Token pair creation and refresh token storage in DB
4. Refresh token rotation and revocation
5. Account lockout after N failed attempts</p>
<h3 id="exercise-2-add-two-factor-authentication">Exercise 2: Add Two-Factor Authentication<a class="header-link" href="#exercise-2-add-two-factor-authentication" title="Permanent link">&para;</a></h3>
<p>Extend the authentication system to support TOTP-based 2FA:
1. Add a <code>/auth/2fa/setup</code> endpoint that returns a QR code URL
2. Add a <code>/auth/2fa/verify</code> endpoint to confirm setup
3. Modify login to require TOTP code when 2FA is enabled
4. Add backup codes for account recovery</p>
<h3 id="exercise-3-api-key-authentication">Exercise 3: API Key Authentication<a class="header-link" href="#exercise-3-api-key-authentication" title="Permanent link">&para;</a></h3>
<p>Add support for API key authentication alongside JWT:
1. Create an endpoint to generate API keys
2. Support API key authentication via <code>X-API-Key</code> header
3. Implement per-key rate limiting
4. Add API key rotation support
5. Log all API key usage</p>
<h3 id="exercise-4-complete-test-suite">Exercise 4: Complete Test Suite<a class="header-link" href="#exercise-4-complete-test-suite" title="Permanent link">&para;</a></h3>
<p>Write additional tests covering:
1. Token refresh flow (including rotation)
2. Account lockout after failed attempts
3. RBAC: verify each role can only access permitted endpoints
4. Rate limiting: verify limits are enforced
5. CORS: verify only allowed origins can access the API</p>
<h3 id="exercise-5-security-audit">Exercise 5: Security Audit<a class="header-link" href="#exercise-5-security-audit" title="Permanent link">&para;</a></h3>
<p>Conduct a security audit of the complete project:
1. Run Bandit against all source files
2. Run pip-audit against requirements.txt
3. Check for hardcoded secrets
4. Review all error responses for information leakage
5. Verify all input validation is comprehensive
6. Document any findings and create fixes</p>
<h3 id="exercise-6-production-deployment">Exercise 6: Production Deployment<a class="header-link" href="#exercise-6-production-deployment" title="Permanent link">&para;</a></h3>
<p>Deploy the API to a cloud provider (or local Docker):
1. Set up PostgreSQL with SSL
2. Configure nginx as reverse proxy with TLS
3. Set up structured log aggregation
4. Configure monitoring and alerting
5. Run a security scan (ZAP baseline) against the deployed API
6. Document the deployment architecture</p>
<hr />
<h2 id="summary">Summary<a class="header-link" href="#summary" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">            </span><span class="n">Secure</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">Key</span><span class="w"> </span><span class="n">Takeaways</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">Defense</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nl">depth:</span><span class="w"> </span><span class="n">Multiple</span><span class="w"> </span><span class="n">security</span><span class="w"> </span><span class="n">layers</span><span class="p">,</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">one</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="nl">Argon2id:</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">proper</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="n">hashing</span><span class="p">,</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">SHA</span><span class="o">/</span><span class="n">MD5</span><span class="o">/</span><span class="n">bcrypt</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="nl">JWT:</span><span class="w"> </span><span class="n">Short</span><span class="o">-</span><span class="n">lived</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rotated</span><span class="w"> </span><span class="n">refresh</span><span class="w"> </span><span class="n">tokens</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">4.</span><span class="w"> </span><span class="nl">RBAC:</span><span class="w"> </span><span class="n">Fine</span><span class="o">-</span><span class="n">grained</span><span class="w"> </span><span class="n">permissions</span><span class="p">,</span><span class="w"> </span><span class="n">principle</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">least</span><span class="w"> </span><span class="n">privilege</span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">5.</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="nl">validation:</span><span class="w"> </span><span class="n">Validate</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sanitize</span><span class="w"> </span><span class="n">ALL</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="k">input</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">6.</span><span class="w"> </span><span class="n">Rate</span><span class="w"> </span><span class="nl">limiting:</span><span class="w"> </span><span class="n">Protect</span><span class="w"> </span><span class="n">login</span><span class="p">,</span><span class="w"> </span><span class="n">registration</span><span class="p">,</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">APIs</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">7.</span><span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="nl">headers:</span><span class="w"> </span><span class="n">HSTS</span><span class="p">,</span><span class="w"> </span><span class="n">CSP</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Frame</span><span class="o">-</span><span class="n">Options</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">every</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">response</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">8.</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="nl">handling:</span><span class="w"> </span><span class="n">Generic</span><span class="w"> </span><span class="n">errors</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">users</span><span class="p">,</span><span class="w"> </span><span class="n">detailed</span><span class="w"> </span><span class="n">logs</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">internally</span><span class="w">                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">9.</span><span class="w"> </span><span class="nl">Logging:</span><span class="w"> </span><span class="n">Structured</span><span class="w"> </span><span class="n">audit</span><span class="w"> </span><span class="n">logs</span><span class="p">,</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="n">secrets</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">PII</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mf">10.</span><span class="w"> </span><span class="nl">Testing:</span><span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="n">tests</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">important</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">functional</span><span class="w"> </span><span class="n">tests</span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="mf">11.</span><span class="w"> </span><span class="nl">Deployment:</span><span class="w"> </span><span class="n">HTTPS</span><span class="p">,</span><span class="w"> </span><span class="n">reverse</span><span class="w"> </span><span class="n">proxy</span><span class="p">,</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">root</span><span class="w"> </span><span class="n">containers</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<hr />
<p><strong>Previous</strong>: <a href="14_Incident_Response.md">14. Incident Response and Forensics</a> | <strong>Next</strong>: <a href="16_Project_Vulnerability_Scanner.md">16. Project: Building a Vulnerability Scanner</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Security/14_Incident_Response.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Incident Response and Forensics</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Security/16_Project_Vulnerability_Scanner.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Project: Building a Vulnerability Scanner</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}