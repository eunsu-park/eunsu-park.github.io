{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project: Deployment Automation - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">üíª</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        ÌïúÍµ≠Ïñ¥
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">‚òÄÔ∏è</span>
                    <span class="theme-icon dark">üåô</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Shell_Script/">Shell Script</a>
    <span class="separator">/</span>
    <span class="current">Project: Deployment Automation</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Project: Deployment Automation</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Shell_Script/14_Project_Task_Runner.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Project: Task Runner</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Shell_Script/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Shell_Script/16_Project_Monitor.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Project: System Monitoring Tool</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#1-overview">1. Overview</a><ul>
<li><a href="#what-is-deployment-automation">What is Deployment Automation?</a></li>
<li><a href="#why-pure-bash">Why Pure Bash?</a></li>
<li><a href="#what-were-building">What We're Building</a></li>
</ul>
</li>
<li><a href="#2-design">2. Design</a><ul>
<li><a href="#architecture-overview">Architecture Overview</a></li>
<li><a href="#deployment-strategies">Deployment Strategies</a></li>
<li><a href="#target-directory-structure">Target Directory Structure</a></li>
</ul>
</li>
<li><a href="#3-ssh-based-deployment">3. SSH-Based Deployment</a><ul>
<li><a href="#ssh-connection-basics">SSH Connection Basics</a></li>
<li><a href="#reusable-ssh-functions">Reusable SSH Functions</a></li>
<li><a href="#file-synchronization-with-rsync">File Synchronization with rsync</a></li>
<li><a href="#advanced-excluding-files">Advanced: Excluding Files</a></li>
<li><a href="#ssh-connection-pooling-controlmaster">SSH Connection Pooling (ControlMaster)</a></li>
</ul>
</li>
<li><a href="#4-rolling-deployment">4. Rolling Deployment</a><ul>
<li><a href="#rolling-deployment-strategy">Rolling Deployment Strategy</a></li>
<li><a href="#implementation">Implementation</a></li>
</ul>
</li>
<li><a href="#5-docker-entrypoint-scripts">5. Docker Entrypoint Scripts</a><ul>
<li><a href="#why-proper-entrypoint-scripts-matter">Why Proper Entrypoint Scripts Matter</a></li>
<li><a href="#basic-entrypoint-structure">Basic Entrypoint Structure</a></li>
<li><a href="#advanced-template-processing-with-envsubst">Advanced: Template Processing with envsubst</a></li>
<li><a href="#wait-for-it-pattern">Wait-for-it Pattern</a></li>
<li><a href="#running-as-non-root-user">Running as Non-Root User</a></li>
</ul>
</li>
<li><a href="#6-environment-configuration">6. Environment Configuration</a><ul>
<li><a href="#loading-env-files">Loading .env Files</a></li>
<li><a href="#environment-variable-validation">Environment Variable Validation</a></li>
<li><a href="#secrets-management">Secrets Management</a></li>
</ul>
</li>
<li><a href="#7-complete-deploy-script">7. Complete Deploy Script</a></li>
<li><a href="#8-usage-examples">8. Usage Examples</a><ul>
<li><a href="#deploy-to-production">Deploy to Production</a></li>
<li><a href="#hosts-file">Hosts File</a></li>
<li><a href="#environment-file">Environment File</a></li>
<li><a href="#docker-entrypoint">Docker Entrypoint</a></li>
</ul>
</li>
<li><a href="#9-extensions">9. Extensions</a><ul>
<li><a href="#1-blue-green-deployment">1. Blue-Green Deployment</a></li>
<li><a href="#2-canary-deployment">2. Canary Deployment</a></li>
<li><a href="#3-slack-notifications">3. Slack Notifications</a></li>
<li><a href="#4-deployment-locking">4. Deployment Locking</a></li>
</ul>
</li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="project-deployment-automation">Project: Deployment Automation<a class="header-link" href="#project-deployment-automation" title="Permanent link">&para;</a></h1>
<p><strong>Difficulty</strong>: ‚≠ê‚≠ê‚≠ê‚≠ê</p>
<p><strong>Previous</strong>: <a href="./14_Project_Task_Runner.md">14_Project_Task_Runner.md</a> | <strong>Next</strong>: <a href="./16_Project_Monitor.md">16_Project_Monitor.md</a></p>
<hr />
<h2 id="1-overview">1. Overview<a class="header-link" href="#1-overview" title="Permanent link">&para;</a></h2>
<h3 id="what-is-deployment-automation">What is Deployment Automation?<a class="header-link" href="#what-is-deployment-automation" title="Permanent link">&para;</a></h3>
<p>Deployment automation is the process of automatically moving code from source control to production servers. It eliminates manual steps, reduces errors, and enables faster, more reliable releases.</p>
<p>Key components include:</p>
<ul>
<li><strong>Remote execution</strong>: Running commands on target servers via SSH</li>
<li><strong>File synchronization</strong>: Copying code and assets to servers</li>
<li><strong>Health checks</strong>: Verifying the deployment succeeded</li>
<li><strong>Rollback capability</strong>: Reverting to the previous version on failure</li>
<li><strong>Multi-server orchestration</strong>: Deploying to multiple hosts sequentially or in parallel</li>
</ul>
<h3 id="why-pure-bash">Why Pure Bash?<a class="header-link" href="#why-pure-bash" title="Permanent link">&para;</a></h3>
<p>While tools like Ansible, Terraform, and Kubernetes exist, bash deployment scripts offer:</p>
<ol>
<li><strong>Zero dependencies</strong>: No agents or orchestration tools required</li>
<li><strong>Transparency</strong>: Exactly what runs on each server is visible</li>
<li><strong>Simplicity</strong>: Perfect for small-to-medium deployments</li>
<li><strong>SSH-native</strong>: Leverage existing SSH infrastructure</li>
<li><strong>Customization</strong>: Easy to adapt for specific needs</li>
</ol>
<h3 id="what-were-building">What We're Building<a class="header-link" href="#what-were-building" title="Permanent link">&para;</a></h3>
<p>This lesson covers three deployment tools:</p>
<ol>
<li><strong>SSH-based deployment</strong>: Deploy to remote servers using rsync and SSH</li>
<li><strong>Rolling deployment</strong>: Gradually deploy to a fleet of servers with health checks</li>
<li><strong>Docker entrypoint scripts</strong>: Proper container initialization with signal handling</li>
</ol>
<hr />
<h2 id="2-design">2. Design<a class="header-link" href="#2-design" title="Permanent link">&para;</a></h2>
<h3 id="architecture-overview">Architecture Overview<a class="header-link" href="#architecture-overview" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Deployment</span><span class="w"> </span><span class="n">System</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">Configuration</span><span class="w"> </span><span class="n">Management</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">Environment</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="p">(</span><span class="o">.</span><span class="n">env</span><span class="w"> </span><span class="n">files</span><span class="p">)</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="n">hosts</span><span class="w"> </span><span class="p">(</span><span class="n">inventory</span><span class="p">)</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">Deployment</span><span class="w"> </span><span class="n">strategy</span><span class="w"> </span><span class="p">(</span><span class="n">rolling</span><span class="p">,</span><span class="w"> </span><span class="n">blue</span><span class="o">-</span><span class="n">green</span><span class="p">)</span>
<span class="err">‚îÇ</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">Remote</span><span class="w"> </span><span class="n">Execution</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">SSH</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">management</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">Command</span><span class="w"> </span><span class="n">execution</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="k">remote</span><span class="w"> </span><span class="n">hosts</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">synchronization</span><span class="w"> </span><span class="p">(</span><span class="n">rsync</span><span class="p">)</span>
<span class="err">‚îÇ</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">Health</span><span class="w"> </span><span class="n">Checks</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="n">health</span><span class="w"> </span><span class="n">endpoints</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">Process</span><span class="w"> </span><span class="n">verification</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">Log</span><span class="w"> </span><span class="n">inspection</span>
<span class="err">‚îÇ</span>
<span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">Rollback</span><span class="w"> </span><span class="n">Strategy</span>
<span class="w">    </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="n">tracking</span>
<span class="w">    </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">Symlink</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">releases</span>
<span class="w">    </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">Automatic</span><span class="w"> </span><span class="n">rollback</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">failure</span>
</code></pre></div>

<h3 id="deployment-strategies">Deployment Strategies<a class="header-link" href="#deployment-strategies" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Strategy</th>
<th>Description</th>
<th>Use Case</th>
<th>Risk</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>All-at-once</strong></td>
<td>Deploy to all servers simultaneously</td>
<td>Low-traffic apps, staging</td>
<td>High</td>
</tr>
<tr>
<td><strong>Rolling</strong></td>
<td>Deploy to servers one-by-one or in batches</td>
<td>Production, gradual rollout</td>
<td>Medium</td>
</tr>
<tr>
<td><strong>Blue-Green</strong></td>
<td>Maintain two environments, switch traffic</td>
<td>Zero-downtime deploys</td>
<td>Low</td>
</tr>
<tr>
<td><strong>Canary</strong></td>
<td>Deploy to a subset, monitor, then full rollout</td>
<td>High-risk changes</td>
<td>Low</td>
</tr>
</tbody>
</table>
<p>We'll implement rolling deployment in this lesson.</p>
<h3 id="target-directory-structure">Target Directory Structure<a class="header-link" href="#target-directory-structure" title="Permanent link">&para;</a></h3>
<p>On remote servers:</p>
<div class="highlight"><pre><span></span><code><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">myapp</span><span class="o">/</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">releases</span><span class="o">/</span><span class="mi">20240215</span><span class="n">_143022</span><span class="o">/</span><span class="w">   </span><span class="c1"># Symlink to active version</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">releases</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="mi">20240215</span><span class="n">_143022</span><span class="o">/</span><span class="w">                   </span><span class="c1"># Current deployment</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="mi">20240215</span><span class="n">_120000</span><span class="o">/</span><span class="w">                   </span><span class="c1"># Previous deployment</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="mi">20240214</span><span class="n">_093000</span><span class="o">/</span><span class="w">                   </span><span class="c1"># Older deployment</span>
<span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">shared</span><span class="o">/</span>
<span class="w">    </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">logs</span><span class="o">/</span>
<span class="w">    </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">uploads</span><span class="o">/</span>
<span class="w">    </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="o">.</span><span class="n">env</span><span class="w">                                </span><span class="c1"># Shared environment config</span>
</code></pre></div>

<p>This structure enables:
- <strong>Quick rollback</strong>: Just change the symlink
- <strong>Keep old versions</strong>: Retain N previous releases
- <strong>Shared state</strong>: Logs and uploads persist across deploys</p>
<hr />
<h2 id="3-ssh-based-deployment">3. SSH-Based Deployment<a class="header-link" href="#3-ssh-based-deployment" title="Permanent link">&para;</a></h2>
<h3 id="ssh-connection-basics">SSH Connection Basics<a class="header-link" href="#ssh-connection-basics" title="Permanent link">&para;</a></h3>
<p>Establish passwordless SSH with key-based authentication:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Generate SSH key (if not already done)</span>
ssh-keygen<span class="w"> </span>-t<span class="w"> </span>ed25519<span class="w"> </span>-f<span class="w"> </span>~/.ssh/deploy_key<span class="w"> </span>-N<span class="w"> </span><span class="s2">&quot;&quot;</span>

<span class="c1"># Copy public key to remote server</span>
ssh-copy-id<span class="w"> </span>-i<span class="w"> </span>~/.ssh/deploy_key.pub<span class="w"> </span>user@server.example.com

<span class="c1"># Test connection</span>
ssh<span class="w"> </span>-i<span class="w"> </span>~/.ssh/deploy_key<span class="w"> </span>user@server.example.com<span class="w"> </span><span class="s2">&quot;echo &#39;Connected successfully&#39;&quot;</span>
</code></pre></div>

<h3 id="reusable-ssh-functions">Reusable SSH Functions<a class="header-link" href="#reusable-ssh-functions" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env bash</span>
<span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail

<span class="c1"># SSH configuration</span>
<span class="nv">SSH_KEY</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="k">:-</span><span class="nv">$HOME</span><span class="p">/.ssh/deploy_key</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">SSH_USER</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_USER</span><span class="k">:-</span><span class="nv">deploy</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">SSH_OPTS</span><span class="o">=</span><span class="s2">&quot;-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR&quot;</span>

<span class="c1"># Execute command on remote host</span>
remote_exec<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">shift</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$*</span><span class="s2">&quot;</span>

<span class="w">    </span>ssh<span class="w"> </span><span class="si">${</span><span class="nv">SSH_OPTS</span><span class="si">}</span><span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_USER</span><span class="si">}</span><span class="s2">@</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># Example usage</span>
remote_exec<span class="w"> </span><span class="s2">&quot;web01.example.com&quot;</span><span class="w"> </span><span class="s2">&quot;uptime&quot;</span>
remote_exec<span class="w"> </span><span class="s2">&quot;web01.example.com&quot;</span><span class="w"> </span><span class="s2">&quot;df -h&quot;</span>
</code></pre></div>

<h3 id="file-synchronization-with-rsync">File Synchronization with rsync<a class="header-link" href="#file-synchronization-with-rsync" title="Permanent link">&para;</a></h3>
<p>rsync is more efficient than <code>scp</code> for repeated deployments:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Sync local directory to remote server</span>
sync_files<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">source</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">destination</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>

<span class="w">    </span>rsync<span class="w"> </span>-avz<span class="w"> </span>--delete<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-e<span class="w"> </span><span class="s2">&quot;ssh </span><span class="si">${</span><span class="nv">SSH_OPTS</span><span class="si">}</span><span class="s2"> -i </span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">source</span><span class="si">}</span><span class="s2">/&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_USER</span><span class="si">}</span><span class="s2">@</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">destination</span><span class="si">}</span><span class="s2">/&quot;</span>
<span class="o">}</span>

<span class="c1"># Example: Deploy application code</span>
sync_files<span class="w"> </span><span class="s2">&quot;web01.example.com&quot;</span><span class="w"> </span><span class="s2">&quot;./build&quot;</span><span class="w"> </span><span class="s2">&quot;/opt/myapp/releases/</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m%d_%H%M%S<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div>

<p><strong>rsync flags explained</strong>:
- <code>-a</code>: Archive mode (preserves permissions, timestamps, etc.)
- <code>-v</code>: Verbose
- <code>-z</code>: Compress during transfer
- <code>--delete</code>: Remove files on destination that don't exist in source
- <code>-e</code>: Specify remote shell command</p>
<h3 id="advanced-excluding-files">Advanced: Excluding Files<a class="header-link" href="#advanced-excluding-files" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>sync_files_with_exclusions<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">source</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">destination</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>

<span class="w">    </span>rsync<span class="w"> </span>-avz<span class="w"> </span>--delete<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--exclude<span class="o">=</span><span class="s1">&#39;.git&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--exclude<span class="o">=</span><span class="s1">&#39;node_modules&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--exclude<span class="o">=</span><span class="s1">&#39;*.log&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--exclude<span class="o">=</span><span class="s1">&#39;.env&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-e<span class="w"> </span><span class="s2">&quot;ssh </span><span class="si">${</span><span class="nv">SSH_OPTS</span><span class="si">}</span><span class="s2"> -i </span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">source</span><span class="si">}</span><span class="s2">/&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_USER</span><span class="si">}</span><span class="s2">@</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">destination</span><span class="si">}</span><span class="s2">/&quot;</span>
<span class="o">}</span>
</code></pre></div>

<h3 id="ssh-connection-pooling-controlmaster">SSH Connection Pooling (ControlMaster)<a class="header-link" href="#ssh-connection-pooling-controlmaster" title="Permanent link">&para;</a></h3>
<p>Reuse SSH connections for faster repeated commands:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Enable connection multiplexing</span>
<span class="nv">SSH_CONTROL_PATH</span><span class="o">=</span><span class="s2">&quot;/tmp/ssh-control-%r@%h:%p&quot;</span>
<span class="nv">SSH_OPTS</span><span class="o">+=</span><span class="s2">&quot; -o ControlMaster=auto -o ControlPath=</span><span class="si">${</span><span class="nv">SSH_CONTROL_PATH</span><span class="si">}</span><span class="s2"> -o ControlPersist=10m&quot;</span>

<span class="c1"># First command opens connection and keeps it alive for 10 minutes</span>
remote_exec<span class="w"> </span><span class="s2">&quot;web01.example.com&quot;</span><span class="w"> </span><span class="s2">&quot;echo &#39;First command&#39;&quot;</span>

<span class="c1"># Subsequent commands reuse the connection (much faster)</span>
remote_exec<span class="w"> </span><span class="s2">&quot;web01.example.com&quot;</span><span class="w"> </span><span class="s2">&quot;echo &#39;Second command&#39;&quot;</span>
remote_exec<span class="w"> </span><span class="s2">&quot;web01.example.com&quot;</span><span class="w"> </span><span class="s2">&quot;echo &#39;Third command&#39;&quot;</span>

<span class="c1"># Cleanup control socket when done</span>
cleanup_ssh<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span>ssh<span class="w"> </span><span class="si">${</span><span class="nv">SSH_OPTS</span><span class="si">}</span><span class="w"> </span>-O<span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_USER</span><span class="si">}</span><span class="s2">@</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="o">}</span>
</code></pre></div>

<hr />
<h2 id="4-rolling-deployment">4. Rolling Deployment<a class="header-link" href="#4-rolling-deployment" title="Permanent link">&para;</a></h2>
<h3 id="rolling-deployment-strategy">Rolling Deployment Strategy<a class="header-link" href="#rolling-deployment-strategy" title="Permanent link">&para;</a></h3>
<p>Deploy to servers sequentially, verifying each succeeds before proceeding:</p>
<ol>
<li>Deploy to server 1</li>
<li>Run health check on server 1</li>
<li>If healthy, continue to server 2; otherwise rollback and abort</li>
<li>Repeat for all servers</li>
</ol>
<h3 id="implementation">Implementation<a class="header-link" href="#implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env bash</span>
<span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail

<span class="c1"># ============================================================================</span>
<span class="c1"># Rolling Deployment Script</span>
<span class="c1"># ============================================================================</span>

<span class="c1"># Configuration</span>
<span class="nv">APP_NAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">APP_NAME</span><span class="k">:-</span><span class="nv">myapp</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">APP_DIR</span><span class="o">=</span><span class="s2">&quot;/opt/</span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">RELEASES_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">APP_DIR</span><span class="si">}</span><span class="s2">/releases&quot;</span>
<span class="nv">CURRENT_LINK</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">APP_DIR</span><span class="si">}</span><span class="s2">/current&quot;</span>
<span class="nv">SHARED_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">APP_DIR</span><span class="si">}</span><span class="s2">/shared&quot;</span>
<span class="nv">KEEP_RELEASES</span><span class="o">=</span><span class="m">5</span>

<span class="c1"># Health check settings</span>
<span class="nv">HEALTH_CHECK_URL</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HEALTH_CHECK_URL</span><span class="k">:-</span><span class="nv">http</span><span class="p">://localhost:</span><span class="nv">8080</span><span class="p">/health</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">HEALTH_CHECK_RETRIES</span><span class="o">=</span><span class="m">5</span>
<span class="nv">HEALTH_CHECK_DELAY</span><span class="o">=</span><span class="m">2</span>

<span class="c1"># Colors</span>
<span class="nv">RED</span><span class="o">=</span><span class="s1">&#39;\033[0;31m&#39;</span>
<span class="nv">GREEN</span><span class="o">=</span><span class="s1">&#39;\033[0;32m&#39;</span>
<span class="nv">YELLOW</span><span class="o">=</span><span class="s1">&#39;\033[1;33m&#39;</span>
<span class="nv">BLUE</span><span class="o">=</span><span class="s1">&#39;\033[0;34m&#39;</span>
<span class="nv">RESET</span><span class="o">=</span><span class="s1">&#39;\033[0m&#39;</span>

log_info<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BLUE</span><span class="si">}</span><span class="s2">[</span><span class="k">$(</span>date<span class="w"> </span>+<span class="s1">&#39;%H:%M:%S&#39;</span><span class="k">)</span><span class="s2">]</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2"> </span><span class="nv">$*</span><span class="s2">&quot;</span>
<span class="o">}</span>

log_success<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">GREEN</span><span class="si">}</span><span class="s2">[</span><span class="k">$(</span>date<span class="w"> </span>+<span class="s1">&#39;%H:%M:%S&#39;</span><span class="k">)</span><span class="s2">] ‚úì</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2"> </span><span class="nv">$*</span><span class="s2">&quot;</span>
<span class="o">}</span>

log_error<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">[</span><span class="k">$(</span>date<span class="w"> </span>+<span class="s1">&#39;%H:%M:%S&#39;</span><span class="k">)</span><span class="s2">] ‚úó</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2"> </span><span class="nv">$*</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="o">}</span>

log_warn<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">YELLOW</span><span class="si">}</span><span class="s2">[</span><span class="k">$(</span>date<span class="w"> </span>+<span class="s1">&#39;%H:%M:%S&#39;</span><span class="k">)</span><span class="s2">] !</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2"> </span><span class="nv">$*</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Remote Operations</span>
<span class="c1"># ============================================================================</span>

remote_exec<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">shift</span>
<span class="w">    </span>ssh<span class="w"> </span><span class="si">${</span><span class="nv">SSH_OPTS</span><span class="si">}</span><span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_USER</span><span class="si">}</span><span class="s2">@</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Deployment Functions</span>
<span class="c1"># ============================================================================</span>

<span class="c1"># Create directory structure on remote server</span>
setup_remote_directories<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>

<span class="w">    </span>log_info<span class="w"> </span><span class="s2">&quot;Setting up directories on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">...&quot;</span>

<span class="w">    </span>remote_exec<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;mkdir -p </span><span class="si">${</span><span class="nv">RELEASES_DIR</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">SHARED_DIR</span><span class="si">}</span><span class="s2">/logs&quot;</span>

<span class="w">    </span>log_success<span class="w"> </span><span class="s2">&quot;Directories ready on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># Deploy application code to remote server</span>
deploy_release<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">release_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m%d_%H%M%S<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">release_path</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">RELEASES_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">release_name</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span>log_info<span class="w"> </span><span class="s2">&quot;Deploying release </span><span class="si">${</span><span class="nv">release_name</span><span class="si">}</span><span class="s2"> to </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">...&quot;</span>

<span class="w">    </span><span class="c1"># Create release directory</span>
<span class="w">    </span>remote_exec<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;mkdir -p </span><span class="si">${</span><span class="nv">release_path</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Sync application code</span>
<span class="w">    </span>rsync<span class="w"> </span>-avz<span class="w"> </span>--delete<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--exclude<span class="o">=</span><span class="s1">&#39;.git&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--exclude<span class="o">=</span><span class="s1">&#39;*.log&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--exclude<span class="o">=</span><span class="s1">&#39;.env&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-e<span class="w"> </span><span class="s2">&quot;ssh </span><span class="si">${</span><span class="nv">SSH_OPTS</span><span class="si">}</span><span class="s2"> -i </span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>./build/<span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_USER</span><span class="si">}</span><span class="s2">@</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">release_path</span><span class="si">}</span><span class="s2">/&quot;</span>

<span class="w">    </span><span class="c1"># Link shared resources</span>
<span class="w">    </span>remote_exec<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;ln -snf </span><span class="si">${</span><span class="nv">SHARED_DIR</span><span class="si">}</span><span class="s2">/logs </span><span class="si">${</span><span class="nv">release_path</span><span class="si">}</span><span class="s2">/logs&quot;</span>
<span class="w">    </span>remote_exec<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;ln -snf </span><span class="si">${</span><span class="nv">SHARED_DIR</span><span class="si">}</span><span class="s2">/.env </span><span class="si">${</span><span class="nv">release_path</span><span class="si">}</span><span class="s2">/.env&quot;</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">release_name</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># Activate a release by updating the &#39;current&#39; symlink</span>
activate_release<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">release_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">release_path</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">RELEASES_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">release_name</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span>log_info<span class="w"> </span><span class="s2">&quot;Activating release </span><span class="si">${</span><span class="nv">release_name</span><span class="si">}</span><span class="s2"> on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">...&quot;</span>

<span class="w">    </span><span class="c1"># Update symlink atomically</span>
<span class="w">    </span>remote_exec<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;ln -snf </span><span class="si">${</span><span class="nv">release_path</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">CURRENT_LINK</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Restart application</span>
<span class="w">    </span>restart_application<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span>log_success<span class="w"> </span><span class="s2">&quot;Activated </span><span class="si">${</span><span class="nv">release_name</span><span class="si">}</span><span class="s2"> on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># Restart the application</span>
restart_application<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>

<span class="w">    </span>log_info<span class="w"> </span><span class="s2">&quot;Restarting application on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">...&quot;</span>

<span class="w">    </span><span class="c1"># Systemd service restart</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>remote_exec<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;systemctl is-active --quiet </span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>remote_exec<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;sudo systemctl restart </span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span>log_warn<span class="w"> </span><span class="s2">&quot;Service </span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span><span class="s2"> not running on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">, starting...&quot;</span>
<span class="w">        </span>remote_exec<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;sudo systemctl start </span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span>sleep<span class="w"> </span><span class="m">2</span>
<span class="o">}</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Health Checks</span>
<span class="c1"># ============================================================================</span>

check_health<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">retries</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HEALTH_CHECK_RETRIES</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span>log_info<span class="w"> </span><span class="s2">&quot;Running health check on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">...&quot;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">retries</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span>remote_exec<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;curl -sf </span><span class="si">${</span><span class="nv">HEALTH_CHECK_URL</span><span class="si">}</span><span class="s2"> &gt; /dev/null&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span>log_success<span class="w"> </span><span class="s2">&quot;Health check passed on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="nv">retries</span><span class="o">=</span><span class="k">$((</span><span class="nv">retries</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="k">))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">retries</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span>log_warn<span class="w"> </span><span class="s2">&quot;Health check failed, retrying in </span><span class="si">${</span><span class="nv">HEALTH_CHECK_DELAY</span><span class="si">}</span><span class="s2">s... (</span><span class="si">${</span><span class="nv">retries</span><span class="si">}</span><span class="s2"> attempts left)&quot;</span>
<span class="w">            </span>sleep<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HEALTH_CHECK_DELAY</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span>log_error<span class="w"> </span><span class="s2">&quot;Health check failed on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> after </span><span class="si">${</span><span class="nv">HEALTH_CHECK_RETRIES</span><span class="si">}</span><span class="s2"> attempts&quot;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="o">}</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Rollback</span>
<span class="c1"># ============================================================================</span>

rollback<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>

<span class="w">    </span>log_warn<span class="w"> </span><span class="s2">&quot;Rolling back deployment on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">...&quot;</span>

<span class="w">    </span><span class="c1"># Get previous release</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">previous_release</span><span class="o">=</span><span class="k">$(</span>remote_exec<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s2">&quot;ls -t </span><span class="si">${</span><span class="nv">RELEASES_DIR</span><span class="si">}</span><span class="s2"> | sed -n &#39;2p&#39;&quot;</span><span class="k">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">previous_release</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>log_error<span class="w"> </span><span class="s2">&quot;No previous release found for rollback on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span>log_info<span class="w"> </span><span class="s2">&quot;Rolling back to </span><span class="si">${</span><span class="nv">previous_release</span><span class="si">}</span><span class="s2"> on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Reactivate previous release</span>
<span class="w">    </span>activate_release<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">previous_release</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span>check_health<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>log_success<span class="w"> </span><span class="s2">&quot;Rollback successful on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span>log_error<span class="w"> </span><span class="s2">&quot;Rollback failed on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Cleanup</span>
<span class="c1"># ============================================================================</span>

cleanup_old_releases<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>

<span class="w">    </span>log_info<span class="w"> </span><span class="s2">&quot;Cleaning up old releases on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">...&quot;</span>

<span class="w">    </span>remote_exec<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s2">&quot;ls -t </span><span class="si">${</span><span class="nv">RELEASES_DIR</span><span class="si">}</span><span class="s2"> | tail -n +</span><span class="k">$((</span><span class="nv">KEEP_RELEASES</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="k">))</span><span class="s2"> | xargs -I {} rm -rf </span><span class="si">${</span><span class="nv">RELEASES_DIR</span><span class="si">}</span><span class="s2">/{}&quot;</span>

<span class="w">    </span>log_success<span class="w"> </span><span class="s2">&quot;Cleanup complete on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Rolling Deploy to Fleet</span>
<span class="c1"># ============================================================================</span>

rolling_deploy<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">hosts</span><span class="o">=(</span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="o">)</span>

<span class="w">    </span>log_info<span class="w"> </span><span class="s2">&quot;Starting rolling deployment to </span><span class="si">${#</span><span class="nv">hosts</span><span class="p">[@]</span><span class="si">}</span><span class="s2"> servers...&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">start_time</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+%s<span class="k">)</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">failed_hosts</span><span class="o">=()</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span>host<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">hosts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span>log_info<span class="w"> </span><span class="s2">&quot;Deploying to </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">...&quot;</span>

<span class="w">        </span><span class="c1"># Setup</span>
<span class="w">        </span>setup_remote_directories<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="c1"># Deploy</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">release_name</span><span class="o">=</span><span class="k">$(</span>deploy_release<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span>

<span class="w">        </span><span class="c1"># Activate</span>
<span class="w">        </span>activate_release<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">release_name</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="c1"># Health check</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span>check_health<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span>log_success<span class="w"> </span><span class="s2">&quot;Deployment to </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> successful&quot;</span>
<span class="w">            </span>cleanup_old_releases<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span>log_error<span class="w"> </span><span class="s2">&quot;Deployment to </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> failed health check&quot;</span>

<span class="w">            </span><span class="c1"># Rollback</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span>rollback<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span>log_warn<span class="w"> </span><span class="s2">&quot;Rolled back </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> successfully&quot;</span>
<span class="w">            </span><span class="k">fi</span>

<span class="w">            </span><span class="nv">failed_hosts</span><span class="o">+=(</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">)</span>

<span class="w">            </span><span class="c1"># Abort on first failure</span>
<span class="w">            </span>log_error<span class="w"> </span><span class="s2">&quot;Aborting rolling deployment due to failure on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="k">break</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span>log_info<span class="w"> </span><span class="s2">&quot;Waiting 5 seconds before next deployment...&quot;</span>
<span class="w">        </span>sleep<span class="w"> </span><span class="m">5</span>
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">end_time</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+%s<span class="k">)</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">duration</span><span class="o">=</span><span class="k">$((</span><span class="nv">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">start_time</span><span class="k">))</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="si">${#</span><span class="nv">failed_hosts</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>log_success<span class="w"> </span><span class="s2">&quot;Rolling deployment completed successfully in </span><span class="si">${</span><span class="nv">duration</span><span class="si">}</span><span class="s2">s&quot;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span>log_error<span class="w"> </span><span class="s2">&quot;Rolling deployment failed on: </span><span class="si">${</span><span class="nv">failed_hosts</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Main</span>
<span class="c1"># ============================================================================</span>

main<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="c1"># Load environment</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span>.env.deploy<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">source</span><span class="w"> </span>.env.deploy
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># Validate configuration</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>log_error<span class="w"> </span><span class="s2">&quot;SSH_KEY not set&quot;</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>log_error<span class="w"> </span><span class="s2">&quot;SSH key not found: </span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># Read hosts from file or arguments</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">hosts</span><span class="o">=()</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;hosts.txt&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>mapfile<span class="w"> </span>-t<span class="w"> </span>hosts<span class="w"> </span>&lt;<span class="w"> </span>hosts.txt
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$#</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">hosts</span><span class="o">=(</span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="o">)</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span>log_error<span class="w"> </span><span class="s2">&quot;No hosts specified. Provide hosts.txt or pass as arguments.&quot;</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># Run rolling deployment</span>
<span class="w">    </span>rolling_deploy<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">hosts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">0</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>main<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="k">fi</span>
</code></pre></div>

<hr />
<h2 id="5-docker-entrypoint-scripts">5. Docker Entrypoint Scripts<a class="header-link" href="#5-docker-entrypoint-scripts" title="Permanent link">&para;</a></h2>
<h3 id="why-proper-entrypoint-scripts-matter">Why Proper Entrypoint Scripts Matter<a class="header-link" href="#why-proper-entrypoint-scripts-matter" title="Permanent link">&para;</a></h3>
<p>Docker containers should:
- Handle signals gracefully (SIGTERM for shutdown)
- Wait for dependencies (database, Redis, etc.)
- Configure themselves from environment variables
- Execute as the correct user (not root)</p>
<p>A proper entrypoint script orchestrates initialization.</p>
<h3 id="basic-entrypoint-structure">Basic Entrypoint Structure<a class="header-link" href="#basic-entrypoint-structure" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env bash</span>
<span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail

<span class="c1"># ============================================================================</span>
<span class="c1"># Docker Entrypoint Script</span>
<span class="c1"># ============================================================================</span>

<span class="c1"># Signal handling for graceful shutdown</span>
shutdown<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Received SIGTERM, shutting down gracefully...&quot;</span>
<span class="w">    </span><span class="c1"># Kill child processes</span>
<span class="w">    </span><span class="nb">kill</span><span class="w"> </span>-TERM<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$APP_PID</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="w">    </span><span class="nb">wait</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$APP_PID</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
<span class="o">}</span>

<span class="nb">trap</span><span class="w"> </span>shutdown<span class="w"> </span>SIGTERM<span class="w"> </span>SIGINT

<span class="c1"># ============================================================================</span>
<span class="c1"># Wait for Dependencies</span>
<span class="c1"># ============================================================================</span>

wait_for_service<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">port</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">max_attempts</span><span class="o">=</span><span class="m">30</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">attempt</span><span class="o">=</span><span class="m">1</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Waiting for </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">port</span><span class="si">}</span><span class="s2">...&quot;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$attempt</span><span class="w"> </span>-le<span class="w"> </span><span class="nv">$max_attempts</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span>nc<span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Service </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">port</span><span class="si">}</span><span class="s2"> is ready!&quot;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Attempt </span><span class="si">${</span><span class="nv">attempt</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">max_attempts</span><span class="si">}</span><span class="s2">: </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">port</span><span class="si">}</span><span class="s2"> not ready, waiting...&quot;</span>
<span class="w">        </span>sleep<span class="w"> </span><span class="m">2</span>
<span class="w">        </span><span class="nv">attempt</span><span class="o">=</span><span class="k">$((</span><span class="nv">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="k">))</span>
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Service </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">port</span><span class="si">}</span><span class="s2"> failed to become ready after </span><span class="si">${</span><span class="nv">max_attempts</span><span class="si">}</span><span class="s2"> attempts&quot;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="o">}</span>

<span class="c1"># Wait for PostgreSQL</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">POSTGRES_HOST</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>wait_for_service<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">POSTGRES_HOST</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">POSTGRES_PORT</span><span class="k">:-</span><span class="nv">5432</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">fi</span>

<span class="c1"># Wait for Redis</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">REDIS_HOST</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>wait_for_service<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">REDIS_HOST</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">REDIS_PORT</span><span class="k">:-</span><span class="nv">6379</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">fi</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Configuration from Environment</span>
<span class="c1"># ============================================================================</span>

<span class="c1"># Substitute environment variables in config template</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span>/app/config.template.yml<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>envsubst<span class="w"> </span>&lt;<span class="w"> </span>/app/config.template.yml<span class="w"> </span>&gt;<span class="w"> </span>/app/config.yml
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Generated config.yml from environment variables&quot;</span>
<span class="k">fi</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Run Migrations (if needed)</span>
<span class="c1"># ============================================================================</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">RUN_MIGRATIONS</span><span class="k">:-</span><span class="nv">false</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;true&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Running database migrations...&quot;</span>
<span class="w">    </span>python<span class="w"> </span>manage.py<span class="w"> </span>migrate
<span class="k">fi</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Start Application</span>
<span class="c1"># ============================================================================</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Starting application...&quot;</span>

<span class="c1"># Start app in background so we can handle signals</span>
<span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">&amp;</span>
<span class="nv">APP_PID</span><span class="o">=</span><span class="nv">$!</span>

<span class="c1"># Wait for application process</span>
<span class="nb">wait</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$APP_PID</span><span class="s2">&quot;</span>
</code></pre></div>

<h3 id="advanced-template-processing-with-envsubst">Advanced: Template Processing with envsubst<a class="header-link" href="#advanced-template-processing-with-envsubst" title="Permanent link">&para;</a></h3>
<p>Use <code>envsubst</code> to generate config files from environment variables:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># config.template.yml</span>
database:
<span class="w">  </span>host:<span class="w"> </span><span class="si">${</span><span class="nv">DB_HOST</span><span class="si">}</span>
<span class="w">  </span>port:<span class="w"> </span><span class="si">${</span><span class="nv">DB_PORT</span><span class="si">}</span>
<span class="w">  </span>user:<span class="w"> </span><span class="si">${</span><span class="nv">DB_USER</span><span class="si">}</span>
<span class="w">  </span>password:<span class="w"> </span><span class="si">${</span><span class="nv">DB_PASSWORD</span><span class="si">}</span>

redis:
<span class="w">  </span>host:<span class="w"> </span><span class="si">${</span><span class="nv">REDIS_HOST</span><span class="si">}</span>
<span class="w">  </span>port:<span class="w"> </span><span class="si">${</span><span class="nv">REDIS_PORT</span><span class="si">}</span>

app:
<span class="w">  </span>debug:<span class="w"> </span><span class="si">${</span><span class="nv">DEBUG</span><span class="si">}</span>
<span class="w">  </span>secret_key:<span class="w"> </span><span class="si">${</span><span class="nv">SECRET_KEY</span><span class="si">}</span>
</code></pre></div>

<p>In the entrypoint:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">DB_HOST</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DB_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">DB_PORT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DB_PORT</span><span class="k">:-</span><span class="nv">5432</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">REDIS_HOST</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">REDIS_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">DEBUG</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DEBUG</span><span class="k">:-</span><span class="nv">false</span><span class="si">}</span><span class="s2">&quot;</span>

envsubst<span class="w"> </span>&lt;<span class="w"> </span>config.template.yml<span class="w"> </span>&gt;<span class="w"> </span>config.yml
</code></pre></div>

<h3 id="wait-for-it-pattern">Wait-for-it Pattern<a class="header-link" href="#wait-for-it-pattern" title="Permanent link">&para;</a></h3>
<p>Reusable function for dependency waiting:</p>
<div class="highlight"><pre><span></span><code>wait_for_it<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">service</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">timeout</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">2</span><span class="k">:-</span><span class="nv">30</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">service</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span>^<span class="o">([</span>^:<span class="o">]</span>+<span class="o">)</span>:<span class="o">([</span><span class="m">0</span>-9<span class="o">]</span>+<span class="o">)</span>$<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASH_REMATCH</span><span class="p">[1]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">port</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASH_REMATCH</span><span class="p">[2]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Invalid service format: </span><span class="si">${</span><span class="nv">service</span><span class="si">}</span><span class="s2"> (expected host:port)&quot;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">start</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+%s<span class="k">)</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span>nc<span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;‚úì </span><span class="si">${</span><span class="nv">service</span><span class="si">}</span><span class="s2"> is ready&quot;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">now</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+%s<span class="k">)</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">elapsed</span><span class="o">=</span><span class="k">$((</span><span class="nv">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">start</span><span class="k">))</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$elapsed</span><span class="w"> </span>-ge<span class="w"> </span><span class="nv">$timeout</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;‚úó </span><span class="si">${</span><span class="nv">service</span><span class="si">}</span><span class="s2"> not ready after </span><span class="si">${</span><span class="nv">timeout</span><span class="si">}</span><span class="s2">s&quot;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Waiting for </span><span class="si">${</span><span class="nv">service</span><span class="si">}</span><span class="s2">... (</span><span class="si">${</span><span class="nv">elapsed</span><span class="si">}</span><span class="s2">s)&quot;</span>
<span class="w">        </span>sleep<span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">done</span>
<span class="o">}</span>

<span class="c1"># Usage</span>
wait_for_it<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DATABASE_HOST</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">DATABASE_PORT</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">60</span>
wait_for_it<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">REDIS_HOST</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">REDIS_PORT</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">30</span>
</code></pre></div>

<h3 id="running-as-non-root-user">Running as Non-Root User<a class="header-link" href="#running-as-non-root-user" title="Permanent link">&para;</a></h3>
<p>Security best practice: run application as non-root:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># In Dockerfile</span>
RUN<span class="w"> </span>groupadd<span class="w"> </span>-r<span class="w"> </span>appuser<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>useradd<span class="w"> </span>-r<span class="w"> </span>-g<span class="w"> </span>appuser<span class="w"> </span>appuser
USER<span class="w"> </span>appuser

<span class="c1"># Or in entrypoint (if you need root for initialization)</span>
<span class="c1">#!/bin/bash</span>

<span class="c1"># Do root-level setup</span>
chown<span class="w"> </span>-R<span class="w"> </span>appuser:appuser<span class="w"> </span>/app/logs

<span class="c1"># Drop privileges and execute app</span>
<span class="nb">exec</span><span class="w"> </span>gosu<span class="w"> </span>appuser<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</code></pre></div>

<hr />
<h2 id="6-environment-configuration">6. Environment Configuration<a class="header-link" href="#6-environment-configuration" title="Permanent link">&para;</a></h2>
<h3 id="loading-env-files">Loading .env Files<a class="header-link" href="#loading-env-files" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>load_env<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">env_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="p">.env</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">env_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Warning: </span><span class="si">${</span><span class="nv">env_file</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># Export all variables from .env</span>
<span class="w">    </span><span class="nb">set</span><span class="w"> </span>-a
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">env_file</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">set</span><span class="w"> </span>+a

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Loaded environment from </span><span class="si">${</span><span class="nv">env_file</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># Usage</span>
load_env<span class="w"> </span><span class="s2">&quot;.env.production&quot;</span>
</code></pre></div>

<h3 id="environment-variable-validation">Environment Variable Validation<a class="header-link" href="#environment-variable-validation" title="Permanent link">&para;</a></h3>
<p>Ensure required variables are set:</p>
<div class="highlight"><pre><span></span><code>validate_env<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">required_vars</span><span class="o">=(</span>
<span class="w">        </span><span class="s2">&quot;DATABASE_URL&quot;</span>
<span class="w">        </span><span class="s2">&quot;REDIS_URL&quot;</span>
<span class="w">        </span><span class="s2">&quot;SECRET_KEY&quot;</span>
<span class="w">        </span><span class="s2">&quot;API_KEY&quot;</span>
<span class="w">    </span><span class="o">)</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">missing_vars</span><span class="o">=()</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span>var<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">required_vars</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="p">!var</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nv">missing_vars</span><span class="o">+=(</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">var</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">)</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="si">${#</span><span class="nv">missing_vars</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Error: Missing required environment variables:&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="nb">printf</span><span class="w"> </span><span class="s1">&#39;  - %s\n&#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">missing_vars</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;‚úì All required environment variables are set&quot;</span>
<span class="o">}</span>

<span class="c1"># Usage in entrypoint</span>
load_env<span class="w"> </span><span class="s2">&quot;.env&quot;</span>
validate_env<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
</code></pre></div>

<h3 id="secrets-management">Secrets Management<a class="header-link" href="#secrets-management" title="Permanent link">&para;</a></h3>
<p>Never hardcode secrets. Use environment variables or secret managers:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Bad: Hardcoded secrets</span>
<span class="nv">DB_PASSWORD</span><span class="o">=</span><span class="s2">&quot;super_secret_123&quot;</span>

<span class="c1"># Good: From environment</span>
<span class="nv">DB_PASSWORD</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DB_PASSWORD</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># Better: From secret file (Docker secrets, Kubernetes secrets)</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span>/run/secrets/db_password<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">DB_PASSWORD</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span>/run/secrets/db_password<span class="k">)</span><span class="s2">&quot;</span>
<span class="k">fi</span>

<span class="c1"># Best: From secret manager (AWS Secrets Manager, Vault)</span>
<span class="nv">DB_PASSWORD</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>aws<span class="w"> </span>secretsmanager<span class="w"> </span>get-secret-value<span class="w"> </span>--secret-id<span class="w"> </span>prod/db/password<span class="w"> </span>--query<span class="w"> </span>SecretString<span class="w"> </span>--output<span class="w"> </span>text<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div>

<hr />
<h2 id="7-complete-deploy-script">7. Complete Deploy Script<a class="header-link" href="#7-complete-deploy-script" title="Permanent link">&para;</a></h2>
<p>Here's a full-featured deployment script combining all concepts:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env bash</span>
<span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail

<span class="c1"># ============================================================================</span>
<span class="c1"># Complete Deployment Automation Script</span>
<span class="c1"># ============================================================================</span>

<span class="nv">SCRIPT_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>dirname<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">pwd</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="nv">PROJECT_ROOT</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>dirname<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SCRIPT_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>

<span class="c1"># Configuration</span>
<span class="nv">APP_NAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">APP_NAME</span><span class="k">:-</span><span class="nv">myapp</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">DEPLOY_ENV</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DEPLOY_ENV</span><span class="k">:-</span><span class="nv">production</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">SSH_KEY</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="k">:-</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="p">/.ssh/deploy_key</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">SSH_USER</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_USER</span><span class="k">:-</span><span class="nv">deploy</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">BUILD_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROJECT_ROOT</span><span class="si">}</span><span class="s2">/build&quot;</span>

<span class="c1"># Colors</span>
<span class="nv">RED</span><span class="o">=</span><span class="s1">&#39;\033[0;31m&#39;</span>
<span class="nv">GREEN</span><span class="o">=</span><span class="s1">&#39;\033[0;32m&#39;</span>
<span class="nv">YELLOW</span><span class="o">=</span><span class="s1">&#39;\033[1;33m&#39;</span>
<span class="nv">BLUE</span><span class="o">=</span><span class="s1">&#39;\033[0;34m&#39;</span>
<span class="nv">RESET</span><span class="o">=</span><span class="s1">&#39;\033[0m&#39;</span>

log<span class="o">()</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BLUE</span><span class="si">}</span><span class="s2">[</span><span class="k">$(</span>date<span class="w"> </span>+<span class="s1">&#39;%H:%M:%S&#39;</span><span class="k">)</span><span class="s2">]</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2"> </span><span class="nv">$*</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>
success<span class="o">()</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">GREEN</span><span class="si">}</span><span class="s2">[</span><span class="k">$(</span>date<span class="w"> </span>+<span class="s1">&#39;%H:%M:%S&#39;</span><span class="k">)</span><span class="s2">] ‚úì</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2"> </span><span class="nv">$*</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>
error<span class="o">()</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">[</span><span class="k">$(</span>date<span class="w"> </span>+<span class="s1">&#39;%H:%M:%S&#39;</span><span class="k">)</span><span class="s2">] ‚úó</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2"> </span><span class="nv">$*</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>
warn<span class="o">()</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">YELLOW</span><span class="si">}</span><span class="s2">[</span><span class="k">$(</span>date<span class="w"> </span>+<span class="s1">&#39;%H:%M:%S&#39;</span><span class="k">)</span><span class="s2">] !</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2"> </span><span class="nv">$*</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Preflight Checks</span>
<span class="c1"># ============================================================================</span>

preflight_checks<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>log<span class="w"> </span><span class="s2">&quot;Running preflight checks...&quot;</span>

<span class="w">    </span><span class="c1"># Check SSH key</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>error<span class="w"> </span><span class="s2">&quot;SSH key not found: </span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># Check build directory</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUILD_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>error<span class="w"> </span><span class="s2">&quot;Build directory not found: </span><span class="si">${</span><span class="nv">BUILD_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># Check hosts file</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SCRIPT_DIR</span><span class="si">}</span><span class="s2">/hosts.</span><span class="si">${</span><span class="nv">DEPLOY_ENV</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>error<span class="w"> </span><span class="s2">&quot;Hosts file not found: hosts.</span><span class="si">${</span><span class="nv">DEPLOY_ENV</span><span class="si">}</span><span class="s2">.txt&quot;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># Verify build</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUILD_DIR</span><span class="si">}</span><span class="s2">/index.html&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>warn<span class="w"> </span><span class="s2">&quot;index.html not found in build directory&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span>success<span class="w"> </span><span class="s2">&quot;Preflight checks passed&quot;</span>
<span class="o">}</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Build</span>
<span class="c1"># ============================================================================</span>

build_application<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>log<span class="w"> </span><span class="s2">&quot;Building application...&quot;</span>

<span class="w">    </span><span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROJECT_ROOT</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Clean previous build</span>
<span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUILD_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUILD_DIR</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Run build command (customize for your project)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;package.json&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>npm<span class="w"> </span>run<span class="w"> </span>build
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;Makefile&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>make<span class="w"> </span>build
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span>error<span class="w"> </span><span class="s2">&quot;No build system detected&quot;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span>success<span class="w"> </span><span class="s2">&quot;Build completed&quot;</span>
<span class="o">}</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Deploy to Single Host</span>
<span class="c1"># ============================================================================</span>

deploy_to_host<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">release_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m%d_%H%M%S<span class="k">)</span><span class="s2">&quot;</span>

<span class="w">    </span>log<span class="w"> </span><span class="s2">&quot;Deploying </span><span class="si">${</span><span class="nv">release_name</span><span class="si">}</span><span class="s2"> to </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">...&quot;</span>

<span class="w">    </span><span class="c1"># Setup directories</span>
<span class="w">    </span>ssh<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_USER</span><span class="si">}</span><span class="s2">@</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s2">&quot;mkdir -p /opt/</span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span><span class="s2">/{releases,shared/logs}&quot;</span>

<span class="w">    </span><span class="c1"># Sync files</span>
<span class="w">    </span>rsync<span class="w"> </span>-avz<span class="w"> </span>--delete<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--exclude<span class="o">=</span><span class="s1">&#39;.git&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--exclude<span class="o">=</span><span class="s1">&#39;node_modules&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--exclude<span class="o">=</span><span class="s1">&#39;*.log&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-e<span class="w"> </span><span class="s2">&quot;ssh -i </span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUILD_DIR</span><span class="si">}</span><span class="s2">/&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_USER</span><span class="si">}</span><span class="s2">@</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">:/opt/</span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span><span class="s2">/releases/</span><span class="si">${</span><span class="nv">release_name</span><span class="si">}</span><span class="s2">/&quot;</span>

<span class="w">    </span><span class="c1"># Activate release</span>
<span class="w">    </span>ssh<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_USER</span><span class="si">}</span><span class="s2">@</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s2">&quot;ln -snf /opt/</span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span><span class="s2">/releases/</span><span class="si">${</span><span class="nv">release_name</span><span class="si">}</span><span class="s2"> /opt/</span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span><span class="s2">/current&quot;</span>

<span class="w">    </span><span class="c1"># Restart service</span>
<span class="w">    </span>ssh<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_USER</span><span class="si">}</span><span class="s2">@</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s2">&quot;sudo systemctl restart </span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span>sleep<span class="w"> </span><span class="m">3</span>

<span class="w">    </span><span class="c1"># Health check</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>ssh<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_USER</span><span class="si">}</span><span class="s2">@</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s2">&quot;curl -sf http://localhost:8080/health &gt;/dev/null&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>success<span class="w"> </span><span class="s2">&quot;Deployment to </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> successful&quot;</span>

<span class="w">        </span><span class="c1"># Cleanup old releases</span>
<span class="w">        </span>ssh<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_USER</span><span class="si">}</span><span class="s2">@</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">            </span><span class="s2">&quot;ls -t /opt/</span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span><span class="s2">/releases | tail -n +6 | xargs -I {} rm -rf /opt/</span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span><span class="s2">/releases/{}&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span>error<span class="w"> </span><span class="s2">&quot;Health check failed on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Rolling Deploy</span>
<span class="c1"># ============================================================================</span>

rolling_deploy<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">hosts_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SCRIPT_DIR</span><span class="si">}</span><span class="s2">/hosts.</span><span class="si">${</span><span class="nv">DEPLOY_ENV</span><span class="si">}</span><span class="s2">.txt&quot;</span>
<span class="w">    </span>mapfile<span class="w"> </span>-t<span class="w"> </span>hosts<span class="w"> </span>&lt;<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">hosts_file</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span>log<span class="w"> </span><span class="s2">&quot;Deploying to </span><span class="si">${#</span><span class="nv">hosts</span><span class="p">[@]</span><span class="si">}</span><span class="s2"> hosts in </span><span class="si">${</span><span class="nv">DEPLOY_ENV</span><span class="si">}</span><span class="s2">...&quot;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span>host<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">hosts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="c1"># Skip empty lines and comments</span>
<span class="w">        </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span>^#<span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">continue</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span>deploy_to_host<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span>log<span class="w"> </span><span class="s2">&quot;Waiting 10 seconds before next deployment...&quot;</span>
<span class="w">            </span>sleep<span class="w"> </span><span class="m">10</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span>error<span class="w"> </span><span class="s2">&quot;Deployment failed on </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">, aborting rollout&quot;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span>success<span class="w"> </span><span class="s2">&quot;Rolling deployment completed successfully&quot;</span>
<span class="o">}</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Main</span>
<span class="c1"># ============================================================================</span>

show_help<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s">Usage: $0 [OPTIONS] COMMAND</span>

<span class="s">Commands:</span>
<span class="s">  build              Build the application</span>
<span class="s">  deploy             Build and deploy to ${DEPLOY_ENV}</span>
<span class="s">  rollback HOST      Rollback to previous release on HOST</span>

<span class="s">Options:</span>
<span class="s">  -e, --env ENV      Deployment environment (default: production)</span>
<span class="s">  -h, --help         Show this help message</span>

<span class="s">Environment Variables:</span>
<span class="s">  APP_NAME           Application name (default: myapp)</span>
<span class="s">  DEPLOY_ENV         Deployment environment (default: production)</span>
<span class="s">  SSH_KEY            Path to SSH private key</span>
<span class="s">  SSH_USER           SSH username (default: deploy)</span>

<span class="s">Examples:</span>
<span class="s">  $0 build</span>
<span class="s">  $0 deploy</span>
<span class="s">  $0 -e staging deploy</span>
<span class="s">  $0 rollback web01.example.com</span>
<span class="s">EOF</span>
<span class="o">}</span>

main<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">command</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="w">    </span><span class="c1"># Parse arguments</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$#</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
<span class="w">            </span>-e<span class="p">|</span>--env<span class="o">)</span>
<span class="w">                </span><span class="nv">DEPLOY_ENV</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
<span class="w">                </span><span class="nb">shift</span><span class="w"> </span><span class="m">2</span>
<span class="w">                </span><span class="p">;;</span>
<span class="w">            </span>-h<span class="p">|</span>--help<span class="o">)</span>
<span class="w">                </span>show_help
<span class="w">                </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
<span class="w">                </span><span class="p">;;</span>
<span class="w">            </span>build<span class="p">|</span>deploy<span class="p">|</span>rollback<span class="o">)</span>
<span class="w">                </span><span class="nv">command</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">                </span><span class="nb">shift</span>
<span class="w">                </span><span class="k">break</span>
<span class="w">                </span><span class="p">;;</span>
<span class="w">            </span>*<span class="o">)</span>
<span class="w">                </span>error<span class="w"> </span><span class="s2">&quot;Unknown option: </span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">                </span>show_help
<span class="w">                </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">                </span><span class="p">;;</span>
<span class="w">        </span><span class="k">esac</span>
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span><span class="c1"># Execute command</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
<span class="w">        </span>build<span class="o">)</span>
<span class="w">            </span>build_application
<span class="w">            </span><span class="p">;;</span>
<span class="w">        </span>deploy<span class="o">)</span>
<span class="w">            </span>preflight_checks
<span class="w">            </span>build_application
<span class="w">            </span>rolling_deploy
<span class="w">            </span><span class="p">;;</span>
<span class="w">        </span>rollback<span class="o">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$#</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span>error<span class="w"> </span><span class="s2">&quot;Rollback requires a host argument&quot;</span>
<span class="w">                </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">            </span><span class="c1"># Rollback logic here</span>
<span class="w">            </span><span class="p">;;</span>
<span class="w">        </span>*<span class="o">)</span>
<span class="w">            </span>show_help
<span class="w">            </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">            </span><span class="p">;;</span>
<span class="w">    </span><span class="k">esac</span>
<span class="o">}</span>

main<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</code></pre></div>

<hr />
<h2 id="8-usage-examples">8. Usage Examples<a class="header-link" href="#8-usage-examples" title="Permanent link">&para;</a></h2>
<h3 id="deploy-to-production">Deploy to Production<a class="header-link" href="#deploy-to-production" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Build and deploy</span>
./deploy.sh<span class="w"> </span>deploy

<span class="c1"># Deploy to staging environment</span>
./deploy.sh<span class="w"> </span>-e<span class="w"> </span>staging<span class="w"> </span>deploy
</code></pre></div>

<h3 id="hosts-file">Hosts File<a class="header-link" href="#hosts-file" title="Permanent link">&para;</a></h3>
<p>Create <code>hosts.production.txt</code>:</p>
<div class="highlight"><pre><span></span><code>web01.example.com
web02.example.com
web03.example.com
</code></pre></div>

<h3 id="environment-file">Environment File<a class="header-link" href="#environment-file" title="Permanent link">&para;</a></h3>
<p>Create <code>.env.deploy</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nv">APP_NAME</span><span class="o">=</span>myapp
<span class="nv">DEPLOY_ENV</span><span class="o">=</span>production
<span class="nv">SSH_KEY</span><span class="o">=</span>/home/user/.ssh/deploy_key
<span class="nv">SSH_USER</span><span class="o">=</span>deploy
<span class="nv">HEALTH_CHECK_URL</span><span class="o">=</span>http://localhost:8080/health
<span class="nv">KEEP_RELEASES</span><span class="o">=</span><span class="m">5</span>
</code></pre></div>

<h3 id="docker-entrypoint">Docker Entrypoint<a class="header-link" href="#docker-entrypoint" title="Permanent link">&para;</a></h3>
<p>In <code>Dockerfile</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">FROM</span><span class="w"> </span><span class="s">node:18-alpine</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="k">COPY</span><span class="w"> </span>package*.json<span class="w"> </span>./
<span class="k">RUN</span><span class="w"> </span>npm<span class="w"> </span>ci<span class="w"> </span>--production

<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.

<span class="k">COPY</span><span class="w"> </span>entrypoint.sh<span class="w"> </span>/usr/local/bin/
<span class="k">RUN</span><span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>/usr/local/bin/entrypoint.sh

<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;entrypoint.sh&quot;</span><span class="p">]</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;server.js&quot;</span><span class="p">]</span>
</code></pre></div>

<p>Run the container:</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">DB_HOST</span><span class="o">=</span>postgres<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">DB_PORT</span><span class="o">=</span><span class="m">5432</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">REDIS_HOST</span><span class="o">=</span>redis<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>myapp:latest
</code></pre></div>

<hr />
<h2 id="9-extensions">9. Extensions<a class="header-link" href="#9-extensions" title="Permanent link">&para;</a></h2>
<h3 id="1-blue-green-deployment">1. Blue-Green Deployment<a class="header-link" href="#1-blue-green-deployment" title="Permanent link">&para;</a></h3>
<p>Maintain two identical environments (blue and green):</p>
<div class="highlight"><pre><span></span><code>blue_green_deploy<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">current_env</span><span class="o">=</span><span class="k">$(</span>get_active_environment<span class="k">)</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">target_env</span><span class="o">=</span><span class="k">$(</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">current_env</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;blue&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;green&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;blue&quot;</span><span class="w"> </span><span class="k">)</span>

<span class="w">    </span>log<span class="w"> </span><span class="s2">&quot;Current: </span><span class="si">${</span><span class="nv">current_env</span><span class="si">}</span><span class="s2">, deploying to: </span><span class="si">${</span><span class="nv">target_env</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Deploy to inactive environment</span>
<span class="w">    </span>deploy_to_environment<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">target_env</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Switch traffic</span>
<span class="w">    </span>switch_load_balancer_target<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">target_env</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span>success<span class="w"> </span><span class="s2">&quot;Traffic switched to </span><span class="si">${</span><span class="nv">target_env</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>
</code></pre></div>

<h3 id="2-canary-deployment">2. Canary Deployment<a class="header-link" href="#2-canary-deployment" title="Permanent link">&para;</a></h3>
<p>Deploy to a subset of servers first:</p>
<div class="highlight"><pre><span></span><code>canary_deploy<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">canary_hosts</span><span class="o">=(</span><span class="s2">&quot;web01.example.com&quot;</span><span class="o">)</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">production_hosts</span><span class="o">=(</span><span class="s2">&quot;web02.example.com&quot;</span><span class="w"> </span><span class="s2">&quot;web03.example.com&quot;</span><span class="o">)</span>

<span class="w">    </span><span class="c1"># Deploy to canary</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span>host<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">canary_hosts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span>deploy_to_host<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span><span class="c1"># Monitor metrics</span>
<span class="w">    </span>log<span class="w"> </span><span class="s2">&quot;Canary deployed. Monitor metrics for 10 minutes...&quot;</span>
<span class="w">    </span>sleep<span class="w"> </span><span class="m">600</span>

<span class="w">    </span><span class="c1"># If metrics are good, deploy to production</span>
<span class="w">    </span><span class="nb">read</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;Proceed with full rollout? (y/n) &quot;</span><span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>-r
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$REPLY</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span>^<span class="o">[</span>Yy<span class="o">]</span>$<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>rolling_deploy<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">production_hosts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>
</code></pre></div>

<h3 id="3-slack-notifications">3. Slack Notifications<a class="header-link" href="#3-slack-notifications" title="Permanent link">&para;</a></h3>
<p>Send deployment notifications:</p>
<div class="highlight"><pre><span></span><code>send_slack_notification<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">message</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">webhook_url</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SLACK_WEBHOOK_URL</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>-H<span class="w"> </span><span class="s1">&#39;Content-type: application/json&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--data<span class="w"> </span><span class="s2">&quot;{\&quot;text\&quot;:\&quot;</span><span class="si">${</span><span class="nv">message</span><span class="si">}</span><span class="s2">\&quot;}&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">webhook_url</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># Usage</span>
send_slack_notification<span class="w"> </span><span class="s2">&quot;Deployment started to production&quot;</span>
rolling_deploy
send_slack_notification<span class="w"> </span><span class="s2">&quot;Deployment to production completed successfully&quot;</span>
</code></pre></div>

<h3 id="4-deployment-locking">4. Deployment Locking<a class="header-link" href="#4-deployment-locking" title="Permanent link">&para;</a></h3>
<p>Prevent concurrent deployments:</p>
<div class="highlight"><pre><span></span><code>acquire_lock<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">lock_file</span><span class="o">=</span><span class="s2">&quot;/tmp/deploy.lock&quot;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">lock_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>error<span class="w"> </span><span class="s2">&quot;Another deployment is in progress&quot;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$$</span><span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">lock_file</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">trap</span><span class="w"> </span><span class="s2">&quot;rm -f </span><span class="si">${</span><span class="nv">lock_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>EXIT
<span class="o">}</span>

<span class="c1"># Usage</span>
acquire_lock<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
rolling_deploy
</code></pre></div>

<hr />
<p><strong>Previous</strong>: <a href="./14_Project_Task_Runner.md">14_Project_Task_Runner.md</a> | <strong>Next</strong>: <a href="./16_Project_Monitor.md">16_Project_Monitor.md</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Shell_Script/14_Project_Task_Runner.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Project: Task Runner</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">üîó</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Shell_Script/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">üìã</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Shell_Script/16_Project_Monitor.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Project: System Monitoring Tool</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">‚Üë</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}