{% raw %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multirate Signal Processing - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/en/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/en/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/en/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" selected>
                        English
                    </option>
                    
                    <option value="ko" >
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/en/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/en/Signal_Processing/">Signal Processing</a>
    <span class="separator">/</span>
    <span class="current">Multirate Signal Processing</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>Multirate Signal Processing</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Signal_Processing/10_IIR_Filter_Design.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">IIR Filter Design</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Signal_Processing/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Signal_Processing/12_Spectral_Analysis.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Spectral Analysis</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-introduction-to-multirate-systems">1. Introduction to Multirate Systems</a><ul>
<li><a href="#11-why-multirate-processing">1.1 Why Multirate Processing?</a></li>
<li><a href="#12-basic-operations">1.2 Basic Operations</a></li>
</ul>
</li>
<li><a href="#2-downsampling-decimation">2. Downsampling (Decimation)</a><ul>
<li><a href="#21-time-domain-operation">2.1 Time-Domain Operation</a></li>
<li><a href="#22-frequency-domain-analysis">2.2 Frequency-Domain Analysis</a></li>
<li><a href="#23-aliasing-demonstration">2.3 Aliasing Demonstration</a></li>
</ul>
</li>
<li><a href="#3-upsampling-interpolation">3. Upsampling (Interpolation)</a><ul>
<li><a href="#31-time-domain-operation">3.1 Time-Domain Operation</a></li>
<li><a href="#32-frequency-domain-analysis">3.2 Frequency-Domain Analysis</a></li>
<li><a href="#33-imaging-demonstration">3.3 Imaging Demonstration</a></li>
</ul>
</li>
<li><a href="#4-decimation-and-interpolation-filters">4. Decimation and Interpolation Filters</a><ul>
<li><a href="#41-decimation-filter-requirements">4.1 Decimation Filter Requirements</a></li>
<li><a href="#42-interpolation-filter-requirements">4.2 Interpolation Filter Requirements</a></li>
<li><a href="#43-filter-design-for-decimation">4.3 Filter Design for Decimation</a></li>
</ul>
</li>
<li><a href="#5-noble-identities">5. Noble Identities</a><ul>
<li><a href="#51-the-identities">5.1 The Identities</a></li>
<li><a href="#52-why-noble-identities-matter">5.2 Why Noble Identities Matter</a></li>
</ul>
</li>
<li><a href="#6-polyphase-decomposition">6. Polyphase Decomposition</a><ul>
<li><a href="#61-concept">6.1 Concept</a></li>
<li><a href="#62-polyphase-decimation">6.2 Polyphase Decimation</a></li>
<li><a href="#63-polyphase-interpolation">6.3 Polyphase Interpolation</a></li>
<li><a href="#64-implementation">6.4 Implementation</a></li>
</ul>
</li>
<li><a href="#7-rational-rate-conversion">7. Rational Rate Conversion</a><ul>
<li><a href="#71-rate-change-by-lm">7.1 Rate Change by L/M</a></li>
<li><a href="#72-example-441-khz-to-48-khz-conversion">7.2 Example: 44.1 kHz to 48 kHz Conversion</a></li>
<li><a href="#73-implementation">7.3 Implementation</a></li>
</ul>
</li>
<li><a href="#8-multistage-rate-conversion">8. Multistage Rate Conversion</a><ul>
<li><a href="#81-motivation">8.1 Motivation</a></li>
<li><a href="#82-optimal-stage-allocation">8.2 Optimal Stage Allocation</a></li>
<li><a href="#83-implementation-and-comparison">8.3 Implementation and Comparison</a></li>
</ul>
</li>
<li><a href="#9-filter-banks">9. Filter Banks</a><ul>
<li><a href="#91-analysis-synthesis-filter-bank">9.1 Analysis-Synthesis Filter Bank</a></li>
<li><a href="#92-two-channel-filter-bank">9.2 Two-Channel Filter Bank</a></li>
<li><a href="#93-quadrature-mirror-filters-qmf">9.3 Quadrature Mirror Filters (QMF)</a></li>
<li><a href="#94-conjugate-quadrature-filters-cqf">9.4 Conjugate Quadrature Filters (CQF)</a></li>
</ul>
</li>
<li><a href="#10-applications">10. Applications</a><ul>
<li><a href="#101-audio-sample-rate-conversion">10.1 Audio Sample Rate Conversion</a></li>
<li><a href="#102-sigma-delta-adc-concept">10.2 Sigma-Delta ADC Concept</a></li>
</ul>
</li>
<li><a href="#11-python-implementation">11. Python Implementation</a><ul>
<li><a href="#111-using-scipysignal-for-multirate-processing">11.1 Using scipy.signal for Multirate Processing</a></li>
<li><a href="#112-complete-multirate-processing-pipeline">11.2 Complete Multirate Processing Pipeline</a></li>
</ul>
</li>
<li><a href="#12-exercises">12. Exercises</a><ul>
<li><a href="#exercise-1-downsampling-analysis">Exercise 1: Downsampling Analysis</a></li>
<li><a href="#exercise-2-interpolation-quality">Exercise 2: Interpolation Quality</a></li>
<li><a href="#exercise-3-polyphase-implementation">Exercise 3: Polyphase Implementation</a></li>
<li><a href="#exercise-4-rational-rate-conversion">Exercise 4: Rational Rate Conversion</a></li>
<li><a href="#exercise-5-multistage-decimation-optimization">Exercise 5: Multistage Decimation Optimization</a></li>
<li><a href="#exercise-6-qmf-filter-bank">Exercise 6: QMF Filter Bank</a></li>
<li><a href="#exercise-7-cic-filter">Exercise 7: CIC Filter</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
<li><a href="#navigation">Navigation</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="multirate-signal-processing">Multirate Signal Processing<a class="header-link" href="#multirate-signal-processing" title="Permanent link">&para;</a></h1>
<h2 id="learning-objectives">Learning Objectives<a class="header-link" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<ul>
<li>Understand the fundamentals of decimation (downsampling) and interpolation (upsampling)</li>
<li>Analyze the spectral effects of sample rate changes</li>
<li>Master the Noble identities for efficient multirate implementations</li>
<li>Design anti-aliasing and anti-imaging filters for rate conversion</li>
<li>Implement polyphase decomposition for computationally efficient filtering</li>
<li>Apply rational rate conversion using cascaded interpolation and decimation</li>
<li>Understand filter bank structures including Quadrature Mirror Filters (QMF)</li>
<li>Implement multirate systems using Python's <code>scipy.signal</code> module</li>
</ul>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="header-link" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-introduction-to-multirate-systems">Introduction to Multirate Systems</a></li>
<li><a href="#2-downsampling-decimation">Downsampling (Decimation)</a></li>
<li><a href="#3-upsampling-interpolation">Upsampling (Interpolation)</a></li>
<li><a href="#4-decimation-and-interpolation-filters">Decimation and Interpolation Filters</a></li>
<li><a href="#5-noble-identities">Noble Identities</a></li>
<li><a href="#6-polyphase-decomposition">Polyphase Decomposition</a></li>
<li><a href="#7-rational-rate-conversion">Rational Rate Conversion</a></li>
<li><a href="#8-multistage-rate-conversion">Multistage Rate Conversion</a></li>
<li><a href="#9-filter-banks">Filter Banks</a></li>
<li><a href="#10-applications">Applications</a></li>
<li><a href="#11-python-implementation">Python Implementation</a></li>
<li><a href="#12-exercises">Exercises</a></li>
</ol>
<hr />
<h2 id="1-introduction-to-multirate-systems">1. Introduction to Multirate Systems<a class="header-link" href="#1-introduction-to-multirate-systems" title="Permanent link">&para;</a></h2>
<h3 id="11-why-multirate-processing">1.1 Why Multirate Processing?<a class="header-link" href="#11-why-multirate-processing" title="Permanent link">&para;</a></h3>
<p>Multirate signal processing involves systems that operate at more than one sampling rate. Common motivations include:</p>
<ul>
<li><strong>Sample rate conversion</strong>: Converting audio between 44.1 kHz (CD) and 48 kHz (professional audio)</li>
<li><strong>Computational efficiency</strong>: Processing at the lowest rate necessary for each stage</li>
<li><strong>Bandwidth reduction</strong>: Decimating narrowband signals to reduce data rates</li>
<li><strong>Subband coding</strong>: Splitting signals into frequency bands for efficient compression</li>
<li><strong>Sigma-delta ADC/DAC</strong>: Oversampled converters that trade speed for resolution</li>
</ul>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Multirate System Building Blocks                    â”‚
â”‚                                                                  â”‚
â”‚  Downsampler (â†“M):          Upsampler (â†‘L):                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚  â†“M   â”‚  Keep every      â”‚  â†‘L   â”‚  Insert (L-1)             â”‚
â”‚  â”‚       â”‚  M-th sample     â”‚       â”‚  zeros between             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”˜  samples                   â”‚
â”‚                                                                  â”‚
â”‚  Decimator:                 Interpolator:                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚Anti-   â”‚â†’ â”‚  â†“M   â”‚     â”‚  â†‘L   â”‚â†’ â”‚Anti-   â”‚               â”‚
â”‚  â”‚alias   â”‚  â”‚       â”‚     â”‚       â”‚  â”‚image   â”‚               â”‚
â”‚  â”‚filter  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚filter  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="12-basic-operations">1.2 Basic Operations<a class="header-link" href="#12-basic-operations" title="Permanent link">&para;</a></h3>
<p>The two fundamental operations in multirate processing:</p>
<p><strong>Downsampling by factor $M$</strong> (keep every $M$-th sample):</p>
<p>$$y[n] = x[nM]$$</p>
<p><strong>Upsampling by factor $L$</strong> (insert $L-1$ zeros between samples):</p>
<p>$$y[n] = \begin{cases} x[n/L], & n = 0, \pm L, \pm 2L, \ldots \\ 0, & \text{otherwise} \end{cases}$$</p>
<hr />
<h2 id="2-downsampling-decimation">2. Downsampling (Decimation)<a class="header-link" href="#2-downsampling-decimation" title="Permanent link">&para;</a></h2>
<h3 id="21-time-domain-operation">2.1 Time-Domain Operation<a class="header-link" href="#21-time-domain-operation" title="Permanent link">&para;</a></h3>
<p>Downsampling by integer factor $M$ retains every $M$-th sample:</p>
<p>$$x_d[n] = x[nM]$$</p>
<p>The output sampling rate is $f_s' = f_s / M$.</p>
<h3 id="22-frequency-domain-analysis">2.2 Frequency-Domain Analysis<a class="header-link" href="#22-frequency-domain-analysis" title="Permanent link">&para;</a></h3>
<p>The DTFT of the downsampled signal is:</p>
<p>$$X_d(e^{j\omega}) = \frac{1}{M} \sum_{k=0}^{M-1} X\left(e^{j(\omega - 2\pi k)/M}\right)$$</p>
<p>This formula reveals two effects:
1. <strong>Frequency scaling</strong>: The spectrum is stretched by factor $M$ (frequencies compressed into $[-\pi, \pi]$)
2. <strong>Aliasing</strong>: $M$ shifted copies of the spectrum are superimposed</p>
<div class="highlight"><pre><span></span><code><span class="n">Downsampling</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">M</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="n">Spectral</span><span class="w"> </span><span class="n">Effect</span>

<span class="n">Original</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="n">e</span><span class="o">^</span><span class="n">jÏ‰</span><span class="p">):</span>
<span class="w">         </span><span class="err">â•±â•²</span>
<span class="w">        </span><span class="err">â•±</span><span class="w">  </span><span class="err">â•²</span>
<span class="w">       </span><span class="err">â•±</span><span class="w">    </span><span class="err">â•²</span>
<span class="err">â”€â”€â”€â”€â”€â”€â•±â”€â”€â”€â”€â”€â”€â•²â”€â”€â”€â”€â”€â”€</span>
<span class="w">   </span><span class="o">-</span><span class="err">Ï€</span><span class="w">    </span><span class="mi">0</span><span class="w">    </span><span class="err">Ï€</span>

<span class="n">After</span><span class="w"> </span><span class="err">â†“</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">X_d</span><span class="p">(</span><span class="n">e</span><span class="o">^</span><span class="n">jÏ‰</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">X</span><span class="p">(</span><span class="n">e</span><span class="o">^</span><span class="p">(</span><span class="n">jÏ‰</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="n">e</span><span class="o">^</span><span class="p">(</span><span class="n">j</span><span class="p">(</span><span class="err">Ï‰</span><span class="o">-</span><span class="mi">2</span><span class="err">Ï€</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))]:</span>

<span class="w">              </span><span class="err">â•±â•²</span>
<span class="n">Stretched</span><span class="p">:</span><span class="w">   </span><span class="err">â•±</span><span class="w">  </span><span class="err">â•²</span>
<span class="w">            </span><span class="err">â•±</span><span class="w">    </span><span class="err">â•²</span>
<span class="w"> </span><span class="err">â•²</span><span class="w">         </span><span class="err">â•±</span><span class="w">      </span><span class="err">â•²</span><span class="w">         </span><span class="err">â•±</span><span class="w">  </span><span class="n">Aliased</span><span class="w"> </span><span class="n">copies</span><span class="w"> </span><span class="n">overlap</span><span class="o">!</span>
<span class="w">  </span><span class="err">â•²</span><span class="w">       </span><span class="err">â•±</span><span class="w">        </span><span class="err">â•²</span><span class="w">       </span><span class="err">â•±</span>
<span class="err">â”€â”€â”€â•²â”€â”€â”€â”€â”€â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²â”€â”€â”€â”€â”€â•±â”€â”€â”€</span>
<span class="w">   </span><span class="o">-</span><span class="err">Ï€</span><span class="w">    </span><span class="mi">0</span><span class="w">           </span><span class="err">Ï€</span>

<span class="n">If</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="k">signal</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">bandlimited</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">|</span><span class="err">Ï‰</span><span class="o">|</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="err">Ï€</span><span class="o">/</span><span class="n">M</span><span class="p">,</span>
<span class="n">no</span><span class="w"> </span><span class="n">aliasing</span><span class="w"> </span><span class="n">occurs</span><span class="o">.</span>
</code></pre></div>

<h3 id="23-aliasing-demonstration">2.3 Aliasing Demonstration<a class="header-link" href="#23-aliasing-demonstration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">signal</span>

<span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_downsampling</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate the spectral effects of downsampling.&quot;&quot;&quot;</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="mi">8000</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># Create signal with multiple tones</span>
    <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1500</span>  <span class="c1"># Hz</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">f1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">f2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">f3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># Downsample without anti-aliasing filter</span>
    <span class="n">x_down_nofilter</span> <span class="o">=</span> <span class="n">x</span><span class="p">[::</span><span class="n">M</span><span class="p">]</span>
    <span class="n">fs_down</span> <span class="o">=</span> <span class="n">fs</span> <span class="o">/</span> <span class="n">M</span>

    <span class="c1"># Downsample with anti-aliasing filter</span>
    <span class="c1"># Cutoff at fs/(2M) to prevent aliasing</span>
    <span class="n">sos</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">fs</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">M</span><span class="p">),</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;sos&#39;</span><span class="p">)</span>
    <span class="n">x_filtered</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">sosfilt</span><span class="p">(</span><span class="n">sos</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">x_down_filtered</span> <span class="o">=</span> <span class="n">x_filtered</span><span class="p">[::</span><span class="n">M</span><span class="p">]</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

    <span class="c1"># Original signal</span>
    <span class="n">freq_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">X_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">N</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">x</span><span class="p">[:</span><span class="mi">200</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Original Signal (fs = </span><span class="si">{</span><span class="n">fs</span><span class="si">}</span><span class="s1"> Hz)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (ms)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_orig</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">X_orig</span> <span class="o">+</span> <span class="mf">1e-15</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Spectrum&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Magnitude (dB)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fs</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Downsampled without filter (aliased)</span>
    <span class="n">N_down</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_down_nofilter</span><span class="p">)</span>
    <span class="n">freq_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">N_down</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs_down</span><span class="p">)</span>
    <span class="n">X_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">x_down_nofilter</span><span class="p">))</span> <span class="o">/</span> <span class="n">N_down</span>

    <span class="n">t_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N_down</span><span class="p">)</span> <span class="o">/</span> <span class="n">fs_down</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_down</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">x_down_nofilter</span><span class="p">[:</span><span class="mi">50</span><span class="p">],</span> <span class="s1">&#39;r-o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Downsampled â†“</span><span class="si">{</span><span class="n">M</span><span class="si">}</span><span class="s1"> (NO filter) fs = </span><span class="si">{</span><span class="n">fs_down</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> Hz&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (ms)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_down</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">X_down</span> <span class="o">+</span> <span class="mf">1e-15</span><span class="p">),</span> <span class="s1">&#39;r-&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spectrum (Aliased!)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Magnitude (dB)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fs_down</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">fs_down</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                         <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Nyquist = </span><span class="si">{</span><span class="n">fs_down</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> Hz&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Downsampled with anti-aliasing filter</span>
    <span class="n">N_down_f</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_down_filtered</span><span class="p">)</span>
    <span class="n">freq_down_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">N_down_f</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs_down</span><span class="p">)</span>
    <span class="n">X_down_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">x_down_filtered</span><span class="p">))</span> <span class="o">/</span> <span class="n">N_down_f</span>

    <span class="n">t_down_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N_down_f</span><span class="p">)</span> <span class="o">/</span> <span class="n">fs_down</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_down_f</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">x_down_filtered</span><span class="p">[:</span><span class="mi">50</span><span class="p">],</span> <span class="s1">&#39;g-o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Decimated â†“</span><span class="si">{</span><span class="n">M</span><span class="si">}</span><span class="s1"> (WITH anti-alias filter)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (ms)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_down_f</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">X_down_f</span> <span class="o">+</span> <span class="mf">1e-15</span><span class="p">),</span> <span class="s1">&#39;g-&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spectrum (No aliasing)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Magnitude (dB)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fs_down</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Downsampling by M = </span><span class="si">{</span><span class="n">M</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;downsampling_demo.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">demonstrate_downsampling</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="3-upsampling-interpolation">3. Upsampling (Interpolation)<a class="header-link" href="#3-upsampling-interpolation" title="Permanent link">&para;</a></h2>
<h3 id="31-time-domain-operation">3.1 Time-Domain Operation<a class="header-link" href="#31-time-domain-operation" title="Permanent link">&para;</a></h3>
<p>Upsampling by factor $L$ inserts $L-1$ zeros between consecutive samples:</p>
<p>$$x_u[n] = \begin{cases} x[n/L], & n = 0, \pm L, \pm 2L, \ldots \\ 0, & \text{otherwise} \end{cases}$$</p>
<p>The output sampling rate is $f_s' = L \cdot f_s$.</p>
<h3 id="32-frequency-domain-analysis">3.2 Frequency-Domain Analysis<a class="header-link" href="#32-frequency-domain-analysis" title="Permanent link">&para;</a></h3>
<p>The DTFT of the upsampled signal is:</p>
<p>$$X_u(e^{j\omega}) = X(e^{j\omega L})$$</p>
<p>This compresses the spectrum by factor $L$, creating $L-1$ spectral images (replicas) in the range $[0, 2\pi]$.</p>
<div class="highlight"><pre><span></span><code>Upsampling by L=3: Spectral Effect

Original X(e^jÏ‰):
         â•±â•²
        â•±  â•²
       â•±    â•²
â”€â”€â”€â”€â”€â”€â•±â”€â”€â”€â”€â”€â”€â•²â”€â”€â”€â”€â”€â”€
   -Ï€    0    Ï€

After â†‘3, X_u(e^jÏ‰) = X(e^(j3Ï‰)):

   â•±â•²    â•±â•²    â•±â•²       Images (unwanted copies)
  â•±  â•²  â•±  â•²  â•±  â•²
 â•±    â•²â•±    â•²â•±    â•²
â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²
-Ï€    -Ï€/3   0   Ï€/3    Ï€

Apply lowpass filter at Ï‰ = Ï€/3 to remove images!
</code></pre></div>

<h3 id="33-imaging-demonstration">3.3 Imaging Demonstration<a class="header-link" href="#33-imaging-demonstration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_upsampling</span><span class="p">(</span><span class="n">L</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate the spectral effects of upsampling.&quot;&quot;&quot;</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># Create a bandlimited signal</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># Hz</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">f1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># Upsample: insert zeros</span>
    <span class="n">x_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span><span class="p">)</span>
    <span class="n">x_up</span><span class="p">[::</span><span class="n">L</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">fs_up</span> <span class="o">=</span> <span class="n">fs</span> <span class="o">*</span> <span class="n">L</span>

    <span class="c1"># Apply anti-imaging (interpolation) filter</span>
    <span class="c1"># Lowpass at fs/2 with gain L</span>
    <span class="n">h_interp</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">firwin</span><span class="p">(</span><span class="mi">63</span><span class="p">,</span> <span class="n">fs</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs_up</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span>
    <span class="n">x_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x_up</span><span class="p">,</span> <span class="n">h_interp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

    <span class="c1"># Original</span>
    <span class="n">freq_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">X_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">N</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">x</span><span class="p">[:</span><span class="mi">30</span><span class="p">],</span> <span class="n">linefmt</span><span class="o">=</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">markerfmt</span><span class="o">=</span><span class="s1">&#39;bo&#39;</span><span class="p">,</span>
                     <span class="n">basefmt</span><span class="o">=</span><span class="s1">&#39;k-&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Original (fs = </span><span class="si">{</span><span class="n">fs</span><span class="si">}</span><span class="s1"> Hz)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (ms)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_orig</span><span class="p">,</span> <span class="n">X_orig</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Spectrum&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fs</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Upsampled (with zero-insertion, before filtering)</span>
    <span class="n">N_up</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_up</span><span class="p">)</span>
    <span class="n">freq_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">N_up</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs_up</span><span class="p">)</span>
    <span class="n">X_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">x_up</span><span class="p">))</span> <span class="o">/</span> <span class="n">N_up</span>

    <span class="n">t_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N_up</span><span class="p">)</span> <span class="o">/</span> <span class="n">fs_up</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">t_up</span><span class="p">[:</span><span class="mi">120</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">x_up</span><span class="p">[:</span><span class="mi">120</span><span class="p">],</span> <span class="n">linefmt</span><span class="o">=</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span>
                     <span class="n">markerfmt</span><span class="o">=</span><span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">basefmt</span><span class="o">=</span><span class="s1">&#39;k-&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Upsampled â†‘</span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1"> (zero-inserted)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (ms)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_up</span><span class="p">,</span> <span class="n">X_up</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spectrum (Imaging artifacts visible)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">fs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fs_up</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Interpolated (after anti-imaging filter)</span>
    <span class="n">X_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">x_interp</span><span class="p">))</span> <span class="o">/</span> <span class="n">N_up</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_up</span><span class="p">[:</span><span class="mi">120</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">x_interp</span><span class="p">[:</span><span class="mi">120</span><span class="p">],</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Interpolated (after LP filter, gain = </span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (ms)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_up</span><span class="p">,</span> <span class="n">X_interp</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spectrum (Images removed)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fs_up</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Upsampling by L = </span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;upsampling_demo.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">demonstrate_upsampling</span><span class="p">(</span><span class="n">L</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="4-decimation-and-interpolation-filters">4. Decimation and Interpolation Filters<a class="header-link" href="#4-decimation-and-interpolation-filters" title="Permanent link">&para;</a></h2>
<h3 id="41-decimation-filter-requirements">4.1 Decimation Filter Requirements<a class="header-link" href="#41-decimation-filter-requirements" title="Permanent link">&para;</a></h3>
<p>Before downsampling by $M$, an <strong>anti-aliasing filter</strong> must limit the signal bandwidth to prevent aliasing:</p>
<p>$$H_\text{dec}(e^{j\omega}) = \begin{cases} 1, & |\omega| < \pi/M \\ 0, & \pi/M \leq |\omega| \leq \pi \end{cases}$$</p>
<p>The complete decimator:</p>
<p>$$y[n] = \left[\sum_{k} h[k] \cdot x[nM - k]\right]$$</p>
<p>Note: We filter first, then downsample. The filter operates at the <strong>high</strong> sampling rate.</p>
<h3 id="42-interpolation-filter-requirements">4.2 Interpolation Filter Requirements<a class="header-link" href="#42-interpolation-filter-requirements" title="Permanent link">&para;</a></h3>
<p>After upsampling by $L$, an <strong>anti-imaging filter</strong> removes the spectral images:</p>
<p>$$H_\text{interp}(e^{j\omega}) = \begin{cases} L, & |\omega| < \pi/L \\ 0, & \pi/L \leq |\omega| \leq \pi \end{cases}$$</p>
<p>The gain of $L$ compensates for the amplitude reduction caused by zero insertion.</p>
<h3 id="43-filter-design-for-decimation">4.3 Filter Design for Decimation<a class="header-link" href="#43-filter-design-for-decimation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">design_decimation_filter</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">filter_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transition_width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Design anti-aliasing filter for decimation by factor M.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        M: decimation factor</span>
<span class="sd">        filter_order: FIR filter order (auto-computed if None)</span>
<span class="sd">        transition_width: normalized transition width (relative to pi/M)</span>

<span class="sd">    Returns:</span>
<span class="sd">        h: FIR filter coefficients</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Cutoff frequency: pi/M (with some transition)</span>
    <span class="n">cutoff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">transition_width</span><span class="p">)</span> <span class="o">/</span> <span class="n">M</span>

    <span class="k">if</span> <span class="n">filter_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Estimate order for 60 dB stopband attenuation</span>
        <span class="n">filter_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">60</span> <span class="o">/</span> <span class="p">(</span><span class="mi">22</span> <span class="o">*</span> <span class="n">transition_width</span> <span class="o">/</span> <span class="n">M</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">firwin</span><span class="p">(</span><span class="n">filter_order</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h</span>

<span class="c1"># Design filters for different decimation factors</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">M</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">]):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">design_decimation_filter</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">filter_order</span><span class="o">=</span><span class="mi">129</span><span class="p">)</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">freqz</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">worN</span><span class="o">=</span><span class="mi">4096</span><span class="p">)</span>
    <span class="n">H_dB</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-15</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">H_dB</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">M</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
               <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Ï€/</span><span class="si">{</span><span class="n">M</span><span class="si">}</span><span class="s1"> (cutoff)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Normalized Frequency (Ã—Ï€)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Magnitude (dB)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Anti-aliasing Filter for â†“</span><span class="si">{</span><span class="n">M</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Decimation Filter Design&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;decimation_filters.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="5-noble-identities">5. Noble Identities<a class="header-link" href="#5-noble-identities" title="Permanent link">&para;</a></h2>
<h3 id="51-the-identities">5.1 The Identities<a class="header-link" href="#51-the-identities" title="Permanent link">&para;</a></h3>
<p>The Noble identities allow moving filters across rate-changing operations, which is crucial for efficient implementations:</p>
<p><strong>Identity 1</strong> (downsampler):</p>
<p>$$\boxed{H(z^M) \rightarrow \downarrow M \equiv \downarrow M \rightarrow H(z)}$$</p>
<p>A filter $H(z^M)$ followed by a downsampler by $M$ is equivalent to first downsampling, then filtering with $H(z)$.</p>
<p><strong>Identity 2</strong> (upsampler):</p>
<p>$$\boxed{\uparrow L \rightarrow H(z^L) \equiv H(z) \rightarrow \uparrow L}$$</p>
<p>An upsampler by $L$ followed by a filter $H(z^L)$ is equivalent to first filtering with $H(z)$, then upsampling.</p>
<div class="highlight"><pre><span></span><code><span class="n">Noble</span><span class="w"> </span><span class="k">Identity</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">Downsampler</span><span class="p">)</span><span class="err">:</span>

<span class="w">  </span><span class="n">x</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">H</span><span class="p">(</span><span class="n">z</span><span class="o">^</span><span class="n">M</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="err">â†“</span><span class="n">M</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">y</span><span class="o">[</span><span class="n">n</span><span class="o">]</span>
<span class="w">                </span><span class="err">â‰¡</span>
<span class="w">  </span><span class="n">x</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="err">â†“</span><span class="n">M</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">H</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">y</span><span class="o">[</span><span class="n">n</span><span class="o">]</span>

<span class="n">Noble</span><span class="w"> </span><span class="k">Identity</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">Upsampler</span><span class="p">)</span><span class="err">:</span>

<span class="w">  </span><span class="n">x</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="err">â†‘</span><span class="n">L</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">H</span><span class="p">(</span><span class="n">z</span><span class="o">^</span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">y</span><span class="o">[</span><span class="n">n</span><span class="o">]</span>
<span class="w">                </span><span class="err">â‰¡</span>
<span class="w">  </span><span class="n">x</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">H</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="err">â†‘</span><span class="n">L</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">y</span><span class="o">[</span><span class="n">n</span><span class="o">]</span>
</code></pre></div>

<h3 id="52-why-noble-identities-matter">5.2 Why Noble Identities Matter<a class="header-link" href="#52-why-noble-identities-matter" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Computational savings</strong>: Moving the filter to the lower-rate side reduces the number of multiply-accumulate operations by a factor of $M$ (or $L$)</li>
<li><strong>Foundation for polyphase</strong>: The identities enable polyphase decomposition</li>
<li><strong>Caution</strong>: The identities only work for $H(z^M)$ or $H(z^L)$, not arbitrary $H(z)$</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">verify_noble_identity</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify Noble Identity 1 by comparing both implementations.&quot;&quot;&quot;</span>
    <span class="c1"># Design a filter H(z)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">firwin</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>  <span class="c1"># Original filter</span>

    <span class="c1"># Create H(z^M) by inserting M-1 zeros between coefficients</span>
    <span class="n">h_stretched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">M</span> <span class="o">-</span> <span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">h_stretched</span><span class="p">[::</span><span class="n">M</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>

    <span class="c1"># Input signal</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>

    <span class="c1"># Implementation 1: H(z^M) then â†“M</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">h_stretched</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
    <span class="n">y1_down</span> <span class="o">=</span> <span class="n">y1</span><span class="p">[::</span><span class="n">M</span><span class="p">]</span>

    <span class="c1"># Implementation 2: â†“M then H(z)</span>
    <span class="n">x_down</span> <span class="o">=</span> <span class="n">x</span><span class="p">[::</span><span class="n">M</span><span class="p">]</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x_down</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>

    <span class="c1"># Compare (trim to same length)</span>
    <span class="n">min_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y1_down</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y2</span><span class="p">))</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y1_down</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]</span> <span class="o">-</span> <span class="n">y2</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Noble Identity verification (M=</span><span class="si">{</span><span class="n">M</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max error: </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Operations saved: </span><span class="si">{</span><span class="n">M</span><span class="si">}</span><span class="s2">x fewer multiplies in low-rate version&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">y1_down</span><span class="p">[:</span><span class="n">min_len</span><span class="p">],</span> <span class="n">y2</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]</span>

<span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">verify_noble_identity</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="6-polyphase-decomposition">6. Polyphase Decomposition<a class="header-link" href="#6-polyphase-decomposition" title="Permanent link">&para;</a></h2>
<h3 id="61-concept">6.1 Concept<a class="header-link" href="#61-concept" title="Permanent link">&para;</a></h3>
<p>The <strong>polyphase decomposition</strong> splits a filter into $M$ (or $L$) subfilters, each operating at the lower sampling rate. This is the most efficient implementation of multirate filtering.</p>
<p>For a filter $H(z) = \sum_{n=0}^{N-1} h[n] z^{-n}$, the Type I polyphase decomposition is:</p>
<p>$$H(z) = \sum_{k=0}^{M-1} z^{-k} E_k(z^M)$$</p>
<p>where each polyphase component is:</p>
<p>$$E_k(z) = \sum_{n=0}^{\lfloor (N-1)/M \rfloor} h[nM + k] z^{-n}, \quad k = 0, 1, \ldots, M-1$$</p>
<h3 id="62-polyphase-decimation">6.2 Polyphase Decimation<a class="header-link" href="#62-polyphase-decimation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Standard</span><span class="w"> </span><span class="nl">Decimation</span><span class="p">:</span><span class="w">                  </span><span class="n">Polyphase</span><span class="w"> </span><span class="nl">Decimation</span><span class="p">:</span>
<span class="w">                                      </span><span class="p">(</span><span class="n">M</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">efficient</span><span class="err">!</span><span class="p">)</span>

<span class="n">x</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">H</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="err">â†“</span><span class="n">M</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">y</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w">         </span><span class="n">x</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w"> </span><span class="err">â”€â”¬â”€â–¶</span><span class="w"> </span><span class="err">â†“</span><span class="n">M</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">Eâ‚€</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â”¬</span>
<span class="w">                                            </span><span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="w">  </span><span class="n">Computes</span><span class="w"> </span><span class="n">M</span><span class="err">Â·</span><span class="n">N</span><span class="w">                              </span><span class="err">â”œâ”€â–¶</span><span class="w"> </span><span class="n">z</span><span class="err">â»</span><span class="n">Â¹</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="err">â†“</span><span class="n">M</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">Eâ‚</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â”¤</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">Î£</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">y</span><span class="o">[</span><span class="n">n</span><span class="o">]</span>
<span class="w">  </span><span class="n">multiplies</span><span class="w"> </span><span class="n">per</span><span class="w">                            </span><span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="n">sample</span><span class="w">                             </span><span class="err">â”œâ”€â–¶</span><span class="w"> </span><span class="n">z</span><span class="err">â»</span><span class="n">Â²</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="err">â†“</span><span class="n">M</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">Eâ‚‚</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â”¤</span>
<span class="w">                                            </span><span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="w">                                            </span><span class="err">â””â”€â–¶</span><span class="w"> </span><span class="n">z</span><span class="err">â»</span><span class="p">(</span><span class="n">M</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="err">â”€â–¶â†“</span><span class="n">M</span><span class="err">â”€â–¶</span><span class="n">E_</span><span class="err">{</span><span class="n">M</span><span class="o">-</span><span class="mi">1</span><span class="err">}</span><span class="w"> </span><span class="err">â”˜</span>

<span class="w">                                      </span><span class="n">Computes</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="n">multiplies</span><span class="w"> </span><span class="n">per</span>
<span class="w">                                      </span><span class="k">output</span><span class="w"> </span><span class="n">sample</span><span class="w"> </span><span class="p">(</span><span class="n">M</span><span class="err">Ã—</span><span class="w"> </span><span class="n">savings</span><span class="err">!</span><span class="p">)</span>
</code></pre></div>

<h3 id="63-polyphase-interpolation">6.3 Polyphase Interpolation<a class="header-link" href="#63-polyphase-interpolation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Standard</span><span class="w"> </span><span class="nl">Interpolation</span><span class="p">:</span><span class="w">               </span><span class="n">Polyphase</span><span class="w"> </span><span class="nl">Interpolation</span><span class="p">:</span>

<span class="n">x</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="err">â†‘</span><span class="n">L</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">H</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">y</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w">          </span><span class="n">x</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w"> </span><span class="err">â”€â”¬â”€â–¶</span><span class="w"> </span><span class="n">Râ‚€</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="err">â†‘</span><span class="n">L</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”¬</span>
<span class="w">                                             </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="w">  </span><span class="n">Computes</span><span class="w"> </span><span class="n">L</span><span class="err">Â·</span><span class="n">N</span><span class="w">                               </span><span class="err">â”œâ”€â–¶</span><span class="w"> </span><span class="n">Râ‚</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="err">â†‘</span><span class="n">L</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">z</span><span class="err">â»</span><span class="n">Â¹</span><span class="err">â”¤â”€â–¶</span><span class="w"> </span><span class="n">Î£</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">y</span><span class="o">[</span><span class="n">n</span><span class="o">]</span>
<span class="w">  </span><span class="n">multiplies</span><span class="w"> </span><span class="n">per</span><span class="w">                             </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">sample</span><span class="w">                               </span><span class="err">â”œâ”€â–¶</span><span class="w"> </span><span class="n">Râ‚‚</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="err">â†‘</span><span class="n">L</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">z</span><span class="err">â»</span><span class="n">Â²</span><span class="err">â”¤</span>
<span class="w">                                             </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="w">                                             </span><span class="err">â””â”€â–¶</span><span class="w"> </span><span class="n">R_</span><span class="err">{</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="err">}</span><span class="w"> </span><span class="err">â”€â–¶â†‘</span><span class="n">L</span><span class="err">â”€â–¶</span><span class="n">z</span><span class="err">â»</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="err">â”˜</span>
</code></pre></div>

<h3 id="64-implementation">6.4 Implementation<a class="header-link" href="#64-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PolyphaseDecimator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Efficient decimation using polyphase decomposition.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters:</span>
<span class="sd">            h: prototype lowpass filter coefficients</span>
<span class="sd">            M: decimation factor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">M</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

        <span class="c1"># Pad h to a multiple of M</span>
        <span class="n">pad_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">%</span> <span class="n">M</span><span class="p">)</span> <span class="o">%</span> <span class="n">M</span>
        <span class="n">h_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pad_len</span><span class="p">)])</span>

        <span class="c1"># Polyphase decomposition: E_k[n] = h[nM + k]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polyphase_filters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
            <span class="n">E_k</span> <span class="o">=</span> <span class="n">h_padded</span><span class="p">[</span><span class="n">k</span><span class="p">::</span><span class="n">M</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">polyphase_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_k</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subfilter_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polyphase_filters</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decimate input signal x.&quot;&quot;&quot;</span>
        <span class="n">N_out</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span>

        <span class="c1"># Create polyphase input components</span>
        <span class="c1"># Trim to multiple of M</span>
        <span class="n">x_trimmed</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="n">N_out</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">]</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_out</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">subfilter_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span>
            <span class="c1"># k-th polyphase input: x[nM + k] (already at low rate)</span>
            <span class="n">x_k</span> <span class="o">=</span> <span class="n">x_trimmed</span><span class="p">[</span><span class="n">k</span><span class="p">::</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">]</span>
            <span class="c1"># Filter with k-th polyphase component</span>
            <span class="n">y_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x_k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">polyphase_filters</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">y</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">y_k</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">y_k</span>

        <span class="k">return</span> <span class="n">y</span><span class="p">[:</span><span class="n">N_out</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print polyphase decomposition info.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decimation factor: M = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original filter length: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of polyphase filters: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subfilter length: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subfilter_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computational savings: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">PolyphaseInterpolator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Efficient interpolation using polyphase decomposition.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters:</span>
<span class="sd">            h: prototype lowpass filter coefficients (with gain L)</span>
<span class="sd">            L: interpolation factor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

        <span class="c1"># Pad h to a multiple of L</span>
        <span class="n">pad_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">%</span> <span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="n">L</span>
        <span class="n">h_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pad_len</span><span class="p">)])</span>

        <span class="c1"># Polyphase decomposition for interpolation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polyphase_filters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
            <span class="n">R_k</span> <span class="o">=</span> <span class="n">h_padded</span><span class="p">[</span><span class="n">k</span><span class="p">::</span><span class="n">L</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">polyphase_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R_k</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subfilter_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polyphase_filters</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Interpolate input signal x.&quot;&quot;&quot;</span>
        <span class="n">N_in</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">N_out</span> <span class="o">=</span> <span class="n">N_in</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_out</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subfilter_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">):</span>
            <span class="c1"># Filter with k-th polyphase component</span>
            <span class="n">y_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">polyphase_filters</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="c1"># Place at correct positions in output</span>
            <span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">::</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">y_k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">y_k</span>

        <span class="k">return</span> <span class="n">y</span><span class="p">[:</span><span class="n">N_out</span><span class="p">]</span>


<span class="c1"># Verify polyphase implementation</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">M</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">fs</span> <span class="o">=</span> <span class="mi">8000</span>

<span class="c1"># Design anti-aliasing filter</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">firwin</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span>

<span class="c1"># Input signal</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>

<span class="c1"># Standard decimation</span>
<span class="n">x_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
<span class="n">y_standard</span> <span class="o">=</span> <span class="n">x_filtered</span><span class="p">[::</span><span class="n">M</span><span class="p">]</span>

<span class="c1"># Polyphase decimation</span>
<span class="n">decimator</span> <span class="o">=</span> <span class="n">PolyphaseDecimator</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
<span class="n">decimator</span><span class="o">.</span><span class="n">get_info</span><span class="p">()</span>
<span class="n">y_polyphase</span> <span class="o">=</span> <span class="n">decimator</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># Compare</span>
<span class="n">min_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_standard</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_polyphase</span><span class="p">))</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_standard</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_polyphase</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Max error between standard and polyphase: </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Plot comparison</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_standard</span><span class="p">[:</span><span class="mi">200</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Standard&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_polyphase</span><span class="p">[:</span><span class="mi">200</span><span class="p">],</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Polyphase&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Decimation Output Comparison&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Sample&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_standard</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_polyphase</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]),</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Absolute Difference (max: </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Sample&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;polyphase_verification.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="7-rational-rate-conversion">7. Rational Rate Conversion<a class="header-link" href="#7-rational-rate-conversion" title="Permanent link">&para;</a></h2>
<h3 id="71-rate-change-by-lm">7.1 Rate Change by L/M<a class="header-link" href="#71-rate-change-by-lm" title="Permanent link">&para;</a></h3>
<p>To convert the sampling rate by a rational factor $L/M$:</p>
<ol>
<li><strong>Upsample</strong> by $L$ (insert $L-1$ zeros)</li>
<li><strong>Filter</strong> with a lowpass filter at cutoff $\omega_c = \min(\pi/L, \pi/M)$</li>
<li><strong>Downsample</strong> by $M$ (keep every $M$-th sample)</li>
</ol>
<p>The order of operations is critical: <strong>interpolate first, then decimate</strong>.</p>
<div class="highlight"><pre><span></span><code><span class="n">Rational</span><span class="w"> </span><span class="n">Rate</span><span class="w"> </span><span class="n">Conversion</span><span class="w"> </span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">M</span><span class="p">)</span><span class="err">:</span>

<span class="n">x</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="err">â†‘</span><span class="n">L</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">H</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="err">â†“</span><span class="n">M</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">y</span><span class="o">[</span><span class="n">n</span><span class="o">]</span>
<span class="w">  </span><span class="n">fs</span><span class="w">              </span><span class="n">cutoff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">Ï€</span><span class="o">/</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">Ï€</span><span class="o">/</span><span class="n">M</span><span class="p">)</span><span class="w">       </span><span class="n">fs</span><span class="err">&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="n">L</span><span class="o">/</span><span class="n">M</span>
</code></pre></div>

<h3 id="72-example-441-khz-to-48-khz-conversion">7.2 Example: 44.1 kHz to 48 kHz Conversion<a class="header-link" href="#72-example-441-khz-to-48-khz-conversion" title="Permanent link">&para;</a></h3>
<p>Converting CD audio (44.1 kHz) to professional audio (48 kHz):</p>
<p>$$\frac{48000}{44100} = \frac{480}{441} = \frac{160}{147}$$</p>
<p>So $L = 160$ and $M = 147$.</p>
<h3 id="73-implementation">7.3 Implementation<a class="header-link" href="#73-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rational_rate_convert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">filter_order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert sampling rate by rational factor L/M.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        x: input signal</span>
<span class="sd">        L: interpolation factor</span>
<span class="sd">        M: decimation factor</span>
<span class="sd">        filter_order: FIR filter order (auto if None)</span>

<span class="sd">    Returns:</span>
<span class="sd">        y: resampled signal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filter_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filter_order</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Design lowpass filter at min(pi/L, pi/M)</span>
    <span class="n">cutoff</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">L</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">firwin</span><span class="p">(</span><span class="n">filter_order</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span>  <span class="c1"># Gain of L for interpolation</span>

    <span class="c1"># Step 1: Upsample by L</span>
    <span class="n">x_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span><span class="p">)</span>
    <span class="n">x_up</span><span class="p">[::</span><span class="n">L</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>

    <span class="c1"># Step 2: Filter</span>
    <span class="n">x_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x_up</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

    <span class="c1"># Step 3: Downsample by M</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x_filtered</span><span class="p">[::</span><span class="n">M</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">y</span>

<span class="c1"># Example: 44100 to 48000 Hz (simplified to L=160, M=147)</span>
<span class="c1"># For demonstration, use smaller factors: 48/44.1 â‰ˆ 320/294 = 160/147</span>
<span class="c1"># Simplify further for demo: approximate as 8/7 â‰ˆ 1.143</span>
<span class="n">L</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">147</span>

<span class="c1"># Create test signal at 44100 Hz</span>
<span class="n">fs_in</span> <span class="o">=</span> <span class="mi">44100</span>
<span class="n">fs_out</span> <span class="o">=</span> <span class="n">fs_in</span> <span class="o">*</span> <span class="n">L</span> <span class="o">/</span> <span class="n">M</span>
<span class="n">t_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs_in</span><span class="p">)</span>

<span class="c1"># Test with 1 kHz sine</span>
<span class="n">f_test</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">f_test</span> <span class="o">*</span> <span class="n">t_in</span><span class="p">)</span>

<span class="c1"># Resample</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">rational_rate_convert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">filter_order</span><span class="o">=</span><span class="mi">2001</span><span class="p">)</span>

<span class="c1"># Also use scipy.signal.resample for comparison</span>
<span class="n">y_scipy</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span> <span class="o">/</span> <span class="n">M</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples at </span><span class="si">{</span><span class="n">fs_in</span><span class="si">}</span><span class="s2"> Hz&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples at </span><span class="si">{</span><span class="n">fs_out</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> Hz&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rate conversion factor: </span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">M</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">L</span><span class="o">/</span><span class="n">M</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected: </span><span class="si">{</span><span class="n">fs_out</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> Hz&quot;</span><span class="p">)</span>

<span class="c1"># Verify frequency preservation</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Time domain</span>
<span class="n">t_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">/</span> <span class="n">fs_out</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_in</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">x</span><span class="p">[:</span><span class="mi">200</span><span class="p">],</span> <span class="s1">&#39;b-o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
              <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Input (</span><span class="si">{</span><span class="n">fs_in</span><span class="si">}</span><span class="s1"> Hz)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_out</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="mi">200</span><span class="o">*</span><span class="n">L</span><span class="o">/</span><span class="n">M</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">y</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="mi">200</span><span class="o">*</span><span class="n">L</span><span class="o">/</span><span class="n">M</span><span class="p">)],</span> <span class="s1">&#39;r-o&#39;</span><span class="p">,</span>
              <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Output (</span><span class="si">{</span><span class="n">fs_out</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> Hz)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (ms)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Amplitude&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sample Rate Conversion: Time Domain&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Frequency domain</span>
<span class="n">N_in</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">N_out</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">freq_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">N_in</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs_in</span><span class="p">)</span>
<span class="n">freq_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">N_out</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs_out</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">N_in</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">/</span> <span class="n">N_out</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_in</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">X</span> <span class="o">+</span> <span class="mf">1e-15</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_out</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Y</span> <span class="o">+</span> <span class="mf">1e-15</span><span class="p">),</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Output&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Magnitude (dB)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Frequency Domain&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;rational_conversion.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="8-multistage-rate-conversion">8. Multistage Rate Conversion<a class="header-link" href="#8-multistage-rate-conversion" title="Permanent link">&para;</a></h2>
<h3 id="81-motivation">8.1 Motivation<a class="header-link" href="#81-motivation" title="Permanent link">&para;</a></h3>
<p>For large rate-change factors (e.g., $M = 100$), a single-stage decimator requires a very sharp (high-order) anti-aliasing filter. <strong>Multistage decimation</strong> cascades multiple smaller decimation stages, reducing the total computational cost.</p>
<p>If $M = M_1 \cdot M_2 \cdot \ldots \cdot M_K$, each stage uses a simpler filter.</p>
<div class="highlight"><pre><span></span><code>Single-stage: x â”€â”€â–¶ H(z) â”€â”€â–¶ â†“100 â”€â”€â–¶ y
              Very sharp filter, high order

Multistage:   x â”€â”€â–¶ Hâ‚(z) â”€â”€â–¶ â†“10 â”€â”€â–¶ Hâ‚‚(z) â”€â”€â–¶ â†“10 â”€â”€â–¶ y
              Two moderate filters, lower total order
</code></pre></div>

<h3 id="82-optimal-stage-allocation">8.2 Optimal Stage Allocation<a class="header-link" href="#82-optimal-stage-allocation" title="Permanent link">&para;</a></h3>
<p>The optimal factorization of $M$ depends on the specifications. A common heuristic is to distribute the factor as evenly as possible.</p>
<p>For $M = M_1 \cdot M_2$:
- Stage 1 filter: cutoff at $\pi / M$ at rate $f_s$
- Stage 2 filter: cutoff at $\pi / M_2$ at rate $f_s / M_1$</p>
<h3 id="83-implementation-and-comparison">8.3 Implementation and Comparison<a class="header-link" href="#83-implementation-and-comparison" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">multistage_decimation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">factors</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multistage decimation.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        x: input signal</span>
<span class="sd">        factors: list of decimation factors [M1, M2, ...]</span>
<span class="sd">        fs: input sampling frequency</span>

<span class="sd">    Returns:</span>
<span class="sd">        y: decimated signal</span>
<span class="sd">        total_ops: estimated total multiply operations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">current_fs</span> <span class="o">=</span> <span class="n">fs</span>
    <span class="n">total_filter_taps</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">M</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">factors</span><span class="p">):</span>
        <span class="c1"># Design filter for this stage</span>
        <span class="n">overall_M_remaining</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">factors</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">overall_M_remaining</span>

        <span class="c1"># Estimate filter order (60 dB attenuation)</span>
        <span class="n">transition</span> <span class="o">=</span> <span class="n">cutoff</span> <span class="o">*</span> <span class="mf">0.2</span>
        <span class="n">numtaps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">60</span> <span class="o">/</span> <span class="p">(</span><span class="mi">22</span> <span class="o">*</span> <span class="n">transition</span><span class="p">)))</span> <span class="o">|</span> <span class="mi">1</span>  <span class="c1"># Ensure odd</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">firwin</span><span class="p">(</span><span class="n">numtaps</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
        <span class="n">total_filter_taps</span> <span class="o">+=</span> <span class="n">numtaps</span>

        <span class="c1"># Filter and decimate</span>
        <span class="n">y_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y_filtered</span><span class="p">[::</span><span class="n">M</span><span class="p">]</span>
        <span class="n">current_fs</span> <span class="o">/=</span> <span class="n">M</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Stage </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: â†“</span><span class="si">{</span><span class="n">M</span><span class="si">}</span><span class="s2">, filter order=</span><span class="si">{</span><span class="n">numtaps</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;rate=</span><span class="si">{</span><span class="n">current_fs</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> Hz, output samples=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">total_filter_taps</span>

<span class="c1"># Compare single-stage vs multistage for M=16</span>
<span class="n">fs</span> <span class="o">=</span> <span class="mi">16000</span>
<span class="n">M_total</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">100</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">200</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Single-stage decimation (M=16):&quot;</span><span class="p">)</span>
<span class="n">h_single</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">firwin</span><span class="p">(</span><span class="mi">513</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">M_total</span><span class="p">)</span>
<span class="n">x_single</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">h_single</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)[::</span><span class="n">M_total</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Filter order: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">h_single</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">, output samples: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_single</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Two-stage decimation (4Ã—4):&quot;</span><span class="p">)</span>
<span class="n">y_2stage</span><span class="p">,</span> <span class="n">taps_2</span> <span class="o">=</span> <span class="n">multistage_decimation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">fs</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Three-stage decimation (2Ã—2Ã—4):&quot;</span><span class="p">)</span>
<span class="n">y_3stage</span><span class="p">,</span> <span class="n">taps_3</span> <span class="o">=</span> <span class="n">multistage_decimation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">fs</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Four-stage decimation (2Ã—2Ã—2Ã—2):&quot;</span><span class="p">)</span>
<span class="n">y_4stage</span><span class="p">,</span> <span class="n">taps_4</span> <span class="o">=</span> <span class="n">multistage_decimation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">fs</span><span class="p">)</span>

<span class="c1"># Compare spectra</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">fs_out</span> <span class="o">=</span> <span class="n">fs</span> <span class="o">/</span> <span class="n">M_total</span>

<span class="n">configs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;Single stage (â†“16)&#39;</span><span class="p">,</span> <span class="n">x_single</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Two stages (â†“4, â†“4)&#39;</span><span class="p">,</span> <span class="n">y_2stage</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Three stages (â†“2, â†“2, â†“4)&#39;</span><span class="p">,</span> <span class="n">y_3stage</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Four stages (â†“2, â†“2, â†“2, â†“2)&#39;</span><span class="p">,</span> <span class="n">y_4stage</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="n">configs</span><span class="p">):</span>
    <span class="n">N_y</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">N_y</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs_out</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">/</span> <span class="n">N_y</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Y</span> <span class="o">+</span> <span class="mf">1e-15</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Magnitude (dB)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fs_out</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Multistage Decimation Comparison (M=</span><span class="si">{</span><span class="n">M_total</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;multistage_decimation.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="9-filter-banks">9. Filter Banks<a class="header-link" href="#9-filter-banks" title="Permanent link">&para;</a></h2>
<h3 id="91-analysis-synthesis-filter-bank">9.1 Analysis-Synthesis Filter Bank<a class="header-link" href="#91-analysis-synthesis-filter-bank" title="Permanent link">&para;</a></h3>
<p>A <strong>filter bank</strong> splits a signal into multiple frequency subbands and can reconstruct it. This is the foundation of audio coding (MP3, AAC), image compression (JPEG2000), and many other applications.</p>
<div class="highlight"><pre><span></span><code><span class="n">Analysis</span><span class="w"> </span><span class="p">(</span><span class="n">Decomposition</span><span class="p">)</span><span class="err">:</span><span class="w">              </span><span class="n">Synthesis</span><span class="w"> </span><span class="p">(</span><span class="n">Reconstruction</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="err">â”Œâ”€</span><span class="w"> </span><span class="n">Hâ‚€</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="err">â†“</span><span class="n">M</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">vâ‚€</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="err">â†‘</span><span class="n">M</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">Gâ‚€</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â”</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="n">x</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w"> </span><span class="err">â”€â”€â”¤â”€</span><span class="w"> </span><span class="n">Hâ‚</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="err">â†“</span><span class="n">M</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">vâ‚</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="err">â†‘</span><span class="n">M</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">Gâ‚</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="err">â”€â”€â”¼â”€â”€â–¶</span><span class="w"> </span><span class="n">Î£</span><span class="w"> </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">x</span><span class="err">Ì‚</span><span class="o">[</span><span class="n">n</span><span class="o">]</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â””â”€</span><span class="w"> </span><span class="n">H_</span><span class="err">{</span><span class="n">M</span><span class="o">-</span><span class="mi">1</span><span class="err">}</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="err">â†“</span><span class="n">M</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">v_</span><span class="err">{</span><span class="n">M</span><span class="o">-</span><span class="mi">1</span><span class="err">}</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="err">â†‘</span><span class="n">M</span><span class="w"> </span><span class="err">â”€â–¶</span><span class="w"> </span><span class="n">G_</span><span class="err">{</span><span class="n">M</span><span class="o">-</span><span class="mi">1</span><span class="err">}â”˜</span>

<span class="n">Analysis</span><span class="w"> </span><span class="nl">filters</span><span class="p">:</span><span class="w"> </span><span class="n">Hâ‚€</span><span class="p">,</span><span class="w"> </span><span class="n">Hâ‚</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="n">H_</span><span class="err">{</span><span class="n">M</span><span class="o">-</span><span class="mi">1</span><span class="err">}</span>
<span class="n">Synthesis</span><span class="w"> </span><span class="nl">filters</span><span class="p">:</span><span class="w"> </span><span class="n">Gâ‚€</span><span class="p">,</span><span class="w"> </span><span class="n">Gâ‚</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="n">G_</span><span class="err">{</span><span class="n">M</span><span class="o">-</span><span class="mi">1</span><span class="err">}</span>
</code></pre></div>

<p>For <strong>perfect reconstruction</strong> (PR):</p>
<p>$$\hat{X}(z) = X(z) \quad \text{(with some delay)}$$</p>
<h3 id="92-two-channel-filter-bank">9.2 Two-Channel Filter Bank<a class="header-link" href="#92-two-channel-filter-bank" title="Permanent link">&para;</a></h3>
<p>The simplest case: $M = 2$ with lowpass ($H_0$) and highpass ($H_1$) filters.</p>
<p><strong>Conditions for perfect reconstruction (two-channel):</strong></p>
<ol>
<li><strong>No aliasing</strong>: $H_0(-z)G_0(z) + H_1(-z)G_1(z) = 0$</li>
<li><strong>No distortion</strong>: $H_0(z)G_0(z) + H_1(z)G_1(z) = 2z^{-d}$ (pure delay)</li>
</ol>
<h3 id="93-quadrature-mirror-filters-qmf">9.3 Quadrature Mirror Filters (QMF)<a class="header-link" href="#93-quadrature-mirror-filters-qmf" title="Permanent link">&para;</a></h3>
<p>In a QMF bank, the highpass filter is obtained by modulating the lowpass filter:</p>
<p>$$H_1(z) = H_0(-z) \quad \Rightarrow \quad h_1[n] = (-1)^n h_0[n]$$</p>
<p>This automatically satisfies the alias cancellation condition. For the synthesis filters:</p>
<p>$$G_0(z) = H_0(z), \quad G_1(z) = -H_1(z) = -H_0(-z)$$</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">qmf_filter_bank</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Two-channel QMF analysis-synthesis filter bank.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        h0: lowpass analysis filter</span>
<span class="sd">        x: input signal</span>

<span class="sd">    Returns:</span>
<span class="sd">        x_hat: reconstructed signal</span>
<span class="sd">        v0, v1: subband signals</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">h0</span><span class="p">)</span>

    <span class="c1"># Analysis filters</span>
    <span class="c1"># h0: lowpass (given)</span>
    <span class="c1"># h1: highpass (modulated version)</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h0</span><span class="p">)))</span>

    <span class="c1"># Synthesis filters (for QMF)</span>
    <span class="n">g0</span> <span class="o">=</span> <span class="n">h0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">g1</span> <span class="o">=</span> <span class="o">-</span><span class="n">h1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Analysis: filter then downsample</span>
    <span class="n">x_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
    <span class="n">x_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>

    <span class="c1"># Downsample by 2</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">x_low</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">x_high</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Synthesis: upsample then filter</span>
    <span class="n">u0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">u0</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">v0</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">u1</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span>

    <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">g0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>

    <span class="c1"># Sum</span>
    <span class="n">min_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y0</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y1</span><span class="p">))</span>
    <span class="n">x_hat</span> <span class="o">=</span> <span class="n">y0</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]</span> <span class="o">+</span> <span class="n">y1</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">x_hat</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span>

<span class="c1"># Design QMF lowpass filter</span>
<span class="n">h0</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">firwin</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s1">&#39;hamming&#39;</span><span class="p">)</span>

<span class="c1"># Test with a signal</span>
<span class="n">fs</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">200</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">3000</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

<span class="n">x_hat</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">qmf_filter_bank</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># Compare</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Original</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="mi">300</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Signal&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Subbands</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">v0</span><span class="p">[:</span><span class="mi">150</span><span class="p">],</span> <span class="s1">&#39;g-&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Lowpass Subband (v0)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">v1</span><span class="p">[:</span><span class="mi">150</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Highpass Subband (v1)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Reconstructed</span>
<span class="n">delay</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">h0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Account for filter delay</span>
<span class="n">x_hat_aligned</span> <span class="o">=</span> <span class="n">x_hat</span><span class="p">[</span><span class="n">delay</span><span class="p">:</span><span class="n">delay</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="mi">300</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_hat_aligned</span><span class="p">[:</span><span class="mi">300</span><span class="p">],</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reconstructed&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Reconstruction Comparison&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Reconstruction error</span>
<span class="n">recon_error</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_hat_aligned</span><span class="p">))]</span> <span class="o">-</span> <span class="n">x_hat_aligned</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_hat_aligned</span><span class="p">))]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">recon_error</span><span class="p">[:</span><span class="mi">300</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reconstruction Error (max: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">recon_error</span><span class="p">))</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Spectra</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">N</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">X</span> <span class="o">+</span> <span class="mf">1e-15</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Spectrum&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Two-Channel QMF Filter Bank&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;qmf_filter_bank.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<h3 id="94-conjugate-quadrature-filters-cqf">9.4 Conjugate Quadrature Filters (CQF)<a class="header-link" href="#94-conjugate-quadrature-filters-cqf" title="Permanent link">&para;</a></h3>
<p>For perfect reconstruction in two-channel systems, the <strong>CQF</strong> (also called Johnston filters) satisfy:</p>
<p>$$|H_0(e^{j\omega})|^2 + |H_0(e^{j(\omega - \pi)})|^2 = 1$$</p>
<p>This is the <strong>power complementary</strong> condition, which leads to exact perfect reconstruction.</p>
<hr />
<h2 id="10-applications">10. Applications<a class="header-link" href="#10-applications" title="Permanent link">&para;</a></h2>
<h3 id="101-audio-sample-rate-conversion">10.1 Audio Sample Rate Conversion<a class="header-link" href="#101-audio-sample-rate-conversion" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">audio_sample_rate_conversion</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate audio sample rate conversion.&quot;&quot;&quot;</span>
    <span class="c1"># Simulate a simple audio signal at 44100 Hz</span>
    <span class="n">fs_in</span> <span class="o">=</span> <span class="mi">44100</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs_in</span><span class="p">)</span>

    <span class="c1"># Chirp signal (frequency sweep)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">chirp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f0</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span> <span class="n">f1</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;logarithmic&#39;</span><span class="p">)</span>

    <span class="c1"># Convert to 48000 Hz using scipy.signal.resample_poly</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mi">160</span>  <span class="c1"># Upsample factor</span>
    <span class="n">M</span> <span class="o">=</span> <span class="mi">147</span>  <span class="c1"># Downsample factor (48000/44100 = 160/147)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">resample_poly</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
    <span class="n">fs_out</span> <span class="o">=</span> <span class="n">fs_in</span> <span class="o">*</span> <span class="n">L</span> <span class="o">/</span> <span class="n">M</span>

    <span class="c1"># Convert to 22050 Hz (downsample by 2)</span>
    <span class="n">y_half</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">resample_poly</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">fs_half</span> <span class="o">=</span> <span class="n">fs_in</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Spectrograms</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">fs_sig</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">fs_in</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Original (</span><span class="si">{</span><span class="n">fs_in</span><span class="si">}</span><span class="s1"> Hz)&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">fs_out</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Resampled to </span><span class="si">{</span><span class="n">fs_out</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> Hz&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">y_half</span><span class="p">,</span> <span class="n">fs_half</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Resampled to </span><span class="si">{</span><span class="n">fs_half</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> Hz&#39;</span><span class="p">),</span>
    <span class="p">]:</span>
        <span class="n">f_spec</span><span class="p">,</span> <span class="n">t_spec</span><span class="p">,</span> <span class="n">Sxx</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">fs_sig</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">t_spec</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">f_spec</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Sxx</span> <span class="o">+</span> <span class="mf">1e-15</span><span class="p">),</span>
                       <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;gouraud&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (ms)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Audio Sample Rate Conversion&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;audio_src.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">audio_sample_rate_conversion</span><span class="p">()</span>
</code></pre></div>

<h3 id="102-sigma-delta-adc-concept">10.2 Sigma-Delta ADC Concept<a class="header-link" href="#102-sigma-delta-adc-concept" title="Permanent link">&para;</a></h3>
<p>A sigma-delta ($\Sigma\Delta$) ADC uses oversampling and noise shaping:</p>
<ol>
<li><strong>Oversample</strong> at rate $f_s = R \cdot f_\text{Nyquist}$ (where $R$ is the oversampling ratio, e.g., 64 or 256)</li>
<li><strong>Noise shaping</strong> pushes quantization noise to high frequencies</li>
<li><strong>Decimate</strong> using a multirate chain to get the final output at the Nyquist rate</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sigma_delta_demo</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simplified sigma-delta ADC demonstration.&quot;&quot;&quot;</span>
    <span class="c1"># Analog-like signal (oversampled)</span>
    <span class="n">OSR</span> <span class="o">=</span> <span class="mi">64</span>  <span class="c1"># Oversampling ratio</span>
    <span class="n">fs_nyquist</span> <span class="o">=</span> <span class="mi">8000</span>
    <span class="n">fs_oversampled</span> <span class="o">=</span> <span class="n">fs_nyquist</span> <span class="o">*</span> <span class="n">OSR</span>

    <span class="n">duration</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs_oversampled</span><span class="p">)</span>

    <span class="c1"># Clean signal</span>
    <span class="n">f_sig</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">f_sig</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>

    <span class="c1"># First-order sigma-delta modulator</span>
    <span class="n">y_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">integrator</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        <span class="n">integrator</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_sd</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="n">y_sd</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">integrator</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="c1"># Decimate the 1-bit stream</span>
    <span class="c1"># Use a CIC-like filter (simple averaging)</span>
    <span class="n">h_dec</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">firwin</span><span class="p">(</span><span class="n">OSR</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">OSR</span><span class="p">)</span>
    <span class="n">y_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">y_sd</span><span class="p">,</span> <span class="n">h_dec</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="n">y_decimated</span> <span class="o">=</span> <span class="n">y_filtered</span><span class="p">[::</span><span class="n">OSR</span><span class="p">]</span>

    <span class="n">fs_out</span> <span class="o">=</span> <span class="n">fs_oversampled</span> <span class="o">/</span> <span class="n">OSR</span>
    <span class="n">t_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_decimated</span><span class="p">))</span> <span class="o">/</span> <span class="n">fs_out</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Original signal</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="mi">2000</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">x</span><span class="p">[:</span><span class="mi">2000</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Input Signal (</span><span class="si">{</span><span class="n">f_sig</span><span class="si">}</span><span class="s1"> Hz)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (ms)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Sigma-delta output (1-bit)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="mi">2000</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">y_sd</span><span class="p">[:</span><span class="mi">2000</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sigma-Delta 1-bit Output (fs = </span><span class="si">{</span><span class="n">fs_oversampled</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> kHz)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (ms)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Decimated output</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_out</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_out</span><span class="p">)</span><span class="o">*</span><span class="mf">0.8</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
                 <span class="n">y_decimated</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_decimated</span><span class="p">)</span><span class="o">*</span><span class="mf">0.8</span><span class="p">)],</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Decimated Output (fs = </span><span class="si">{</span><span class="n">fs_out</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> kHz)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (ms)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Sigma-Delta ADC: Oversampling + Decimation&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;sigma_delta.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">sigma_delta_demo</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="11-python-implementation">11. Python Implementation<a class="header-link" href="#11-python-implementation" title="Permanent link">&para;</a></h2>
<h3 id="111-using-scipysignal-for-multirate-processing">11.1 Using scipy.signal for Multirate Processing<a class="header-link" href="#111-using-scipysignal-for-multirate-processing" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># scipy.signal provides convenient functions for multirate processing</span>

<span class="c1"># 1. Simple decimation</span>
<span class="n">fs</span> <span class="o">=</span> <span class="mi">48000</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">5000</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

<span class="c1"># Decimate by 4 (includes anti-aliasing filter)</span>
<span class="n">y_dec</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;fir&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decimated: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y_dec</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>

<span class="c1"># 2. Resample to arbitrary rate</span>
<span class="n">y_resample</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mi">44100</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resampled 48k-&gt;44.1k: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y_resample</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>

<span class="c1"># 3. Polyphase resampling (most efficient)</span>
<span class="n">y_poly</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">resample_poly</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">441</span><span class="p">,</span> <span class="mi">480</span><span class="p">)</span>  <span class="c1"># 48000 * 441/480 = 44100</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Polyphase resample: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y_poly</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>

<span class="c1"># 4. Upfirdn: combined upsample-filter-downsample</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">firwin</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
<span class="n">y_upfirdn</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">upfirdn</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">up</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">down</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;upfirdn (up=3, down=4): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y_upfirdn</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="112-complete-multirate-processing-pipeline">11.2 Complete Multirate Processing Pipeline<a class="header-link" href="#112-complete-multirate-processing-pipeline" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">multirate_pipeline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fs_in</span><span class="p">,</span> <span class="n">fs_out</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete sample rate conversion pipeline.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        x: input signal</span>
<span class="sd">        fs_in: input sampling rate</span>
<span class="sd">        fs_out: output sampling rate</span>

<span class="sd">    Returns:</span>
<span class="sd">        y: resampled signal</span>
<span class="sd">        info: processing information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">gcd</span>

    <span class="c1"># Find rational approximation</span>
    <span class="c1"># Use exact ratio if both are integers</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fs_out</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">fs_in</span><span class="p">))</span>
    <span class="n">L</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fs_out</span><span class="p">)</span> <span class="o">//</span> <span class="n">g</span>
    <span class="n">M</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fs_in</span><span class="p">)</span> <span class="o">//</span> <span class="n">g</span>

    <span class="c1"># Simplify if factors are too large</span>
    <span class="n">max_factor</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="k">while</span> <span class="n">L</span> <span class="o">&gt;</span> <span class="n">max_factor</span> <span class="ow">or</span> <span class="n">M</span> <span class="o">&gt;</span> <span class="n">max_factor</span><span class="p">:</span>
        <span class="n">g2</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g2</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">L</span> <span class="o">//=</span> <span class="n">g2</span>
            <span class="n">M</span> <span class="o">//=</span> <span class="n">g2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Approximate</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">fs_out</span> <span class="o">/</span> <span class="n">fs_in</span>
            <span class="n">best_L</span><span class="p">,</span> <span class="n">best_M</span><span class="p">,</span> <span class="n">best_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">test_M</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_factor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">test_L</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ratio</span> <span class="o">*</span> <span class="n">test_M</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">test_L</span> <span class="o">&lt;=</span> <span class="n">max_factor</span><span class="p">:</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">test_L</span> <span class="o">/</span> <span class="n">test_M</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">best_error</span><span class="p">:</span>
                        <span class="n">best_L</span><span class="p">,</span> <span class="n">best_M</span><span class="p">,</span> <span class="n">best_error</span> <span class="o">=</span> <span class="n">test_L</span><span class="p">,</span> <span class="n">test_M</span><span class="p">,</span> <span class="n">error</span>
            <span class="n">L</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">best_L</span><span class="p">,</span> <span class="n">best_M</span>
            <span class="k">break</span>

    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="n">L</span><span class="p">,</span>
        <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span>
        <span class="s1">&#39;actual_ratio&#39;</span><span class="p">:</span> <span class="n">L</span> <span class="o">/</span> <span class="n">M</span><span class="p">,</span>
        <span class="s1">&#39;desired_ratio&#39;</span><span class="p">:</span> <span class="n">fs_out</span> <span class="o">/</span> <span class="n">fs_in</span><span class="p">,</span>
        <span class="s1">&#39;ratio_error&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">M</span> <span class="o">-</span> <span class="n">fs_out</span><span class="o">/</span><span class="n">fs_in</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rate conversion: </span><span class="si">{</span><span class="n">fs_in</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">fs_out</span><span class="si">}</span><span class="s2"> Hz&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  L/M = </span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">M</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">L</span><span class="o">/</span><span class="n">M</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Desired ratio: </span><span class="si">{</span><span class="n">fs_out</span><span class="o">/</span><span class="n">fs_in</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Error: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ratio_error&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Use scipy&#39;s efficient polyphase resampler</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">resample_poly</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;input_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;output_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">info</span>

<span class="c1"># Test various conversions</span>
<span class="n">test_rates</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">44100</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span> <span class="s1">&#39;CD to Pro Audio&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">48000</span><span class="p">,</span> <span class="mi">44100</span><span class="p">,</span> <span class="s1">&#39;Pro Audio to CD&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">44100</span><span class="p">,</span> <span class="mi">22050</span><span class="p">,</span> <span class="s1">&#39;CD to Half Rate&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">16000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="s1">&#39;Wideband to Narrowband&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">96000</span><span class="p">,</span> <span class="mi">44100</span><span class="p">,</span> <span class="s1">&#39;Hi-Res to CD&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">fs_source</span> <span class="o">=</span> <span class="mi">44100</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs_source</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">chirp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">15000</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_rates</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">test_rates</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">fs_in</span><span class="p">,</span> <span class="n">fs_out</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">test_rates</span><span class="p">):</span>
    <span class="c1"># Generate at source rate</span>
    <span class="n">t_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs_in</span><span class="p">)</span>
    <span class="n">x_in</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">chirp</span><span class="p">(</span><span class="n">t_in</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">15000</span><span class="p">,</span> <span class="n">fs_in</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1000</span><span class="p">))</span>

    <span class="n">y</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">multirate_pipeline</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span> <span class="n">fs_in</span><span class="p">,</span> <span class="n">fs_out</span><span class="p">)</span>

    <span class="c1"># Plot spectrum</span>
    <span class="n">freq_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs_out</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_out</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Y</span> <span class="o">+</span> <span class="mf">1e-15</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">fs_in</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">fs_out</span><span class="si">}</span><span class="s1"> Hz (L=</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, M=</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;dB&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fs_out</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;multirate_pipeline.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="12-exercises">12. Exercises<a class="header-link" href="#12-exercises" title="Permanent link">&para;</a></h2>
<h3 id="exercise-1-downsampling-analysis">Exercise 1: Downsampling Analysis<a class="header-link" href="#exercise-1-downsampling-analysis" title="Permanent link">&para;</a></h3>
<p>Consider the signal $x[n] = \cos(0.2\pi n) + \cos(0.7\pi n)$ sampled at $f_s = 10$ kHz.</p>
<p>(a) Sketch the DTFT of $x[n]$.</p>
<p>(b) Downsample by $M = 2$. Determine analytically which frequency components alias and what the resulting spectrum looks like.</p>
<p>(c) Downsample by $M = 4$. Does aliasing occur? Which components overlap?</p>
<p>(d) Implement in Python: plot the spectra of the original signal and both downsampled versions. Verify your analytical predictions.</p>
<p>(e) Design an anti-aliasing filter that allows $M = 4$ decimation without distorting the $0.2\pi$ component.</p>
<h3 id="exercise-2-interpolation-quality">Exercise 2: Interpolation Quality<a class="header-link" href="#exercise-2-interpolation-quality" title="Permanent link">&para;</a></h3>
<p>Starting with a 1 kHz sine wave sampled at 8 kHz:</p>
<p>(a) Upsample by $L = 4$ using zero-insertion only. Plot the spectrum and identify the imaging artifacts.</p>
<p>(b) Apply interpolation using three different methods:
   - Linear interpolation
   - FIR lowpass filter (32 taps)
   - FIR lowpass filter (128 taps)</p>
<p>(c) Compare the interpolation quality by computing the SNR of each method relative to a high-quality reference (e.g., <code>scipy.signal.resample</code>).</p>
<p>(d) Plot the time-domain waveforms of all methods overlaid on the ideal continuous sinusoid.</p>
<h3 id="exercise-3-polyphase-implementation">Exercise 3: Polyphase Implementation<a class="header-link" href="#exercise-3-polyphase-implementation" title="Permanent link">&para;</a></h3>
<p>Given a 128-tap FIR filter and decimation factor $M = 8$:</p>
<p>(a) Implement the polyphase decomposition manually. How many subfilters are there? What is the length of each?</p>
<p>(b) Implement a <code>PolyphaseDecimator</code> class that processes the signal block-by-block (simulate streaming).</p>
<p>(c) Verify the output matches <code>scipy.signal.decimate</code>.</p>
<p>(d) Benchmark the standard vs polyphase implementations. Measure the speedup factor.</p>
<h3 id="exercise-4-rational-rate-conversion">Exercise 4: Rational Rate Conversion<a class="header-link" href="#exercise-4-rational-rate-conversion" title="Permanent link">&para;</a></h3>
<p>Convert a signal from 11025 Hz to 8000 Hz.</p>
<p>(a) Find the simplest $L/M$ ratio. Hint: $8000/11025 = ?$</p>
<p>(b) Design the required anti-aliasing/anti-imaging filter.</p>
<p>(c) Implement the conversion using <code>signal.resample_poly</code>.</p>
<p>(d) Generate a test signal containing tones at 500, 1000, 2000, and 3500 Hz. After conversion, which tones should survive and which should be attenuated? Verify with spectral analysis.</p>
<h3 id="exercise-5-multistage-decimation-optimization">Exercise 5: Multistage Decimation Optimization<a class="header-link" href="#exercise-5-multistage-decimation-optimization" title="Permanent link">&para;</a></h3>
<p>You need to decimate by $M = 48$.</p>
<p>(a) List all possible factorizations of 48 into 2-4 stages (e.g., $48 = 2 \times 24$, $48 = 2 \times 4 \times 6$, etc.).</p>
<p>(b) For each factorization, estimate the total number of multiply-accumulate operations per output sample. Assume the filter order for each stage is $10 \times M_\text{stage}$.</p>
<p>(c) Which factorization is optimal? Implement it and verify the output quality.</p>
<p>(d) Compare with single-stage decimation in terms of computation time and output SNR.</p>
<h3 id="exercise-6-qmf-filter-bank">Exercise 6: QMF Filter Bank<a class="header-link" href="#exercise-6-qmf-filter-bank" title="Permanent link">&para;</a></h3>
<p>Design a two-channel QMF filter bank for audio processing:</p>
<p>(a) Design a 32-tap lowpass prototype filter suitable for QMF.</p>
<p>(b) Construct the highpass analysis filter and both synthesis filters.</p>
<p>(c) Process a music-like signal (sum of harmonics) and verify near-perfect reconstruction.</p>
<p>(d) Compute the reconstruction error as a function of the filter order (try 8, 16, 32, 64, 128 taps).</p>
<p>(e) Implement subband coding: quantize the lowpass subband to 16 bits and the highpass subband to 8 bits. Reconstruct and measure the SNR.</p>
<h3 id="exercise-7-cic-filter">Exercise 7: CIC Filter<a class="header-link" href="#exercise-7-cic-filter" title="Permanent link">&para;</a></h3>
<p>The <strong>Cascaded Integrator-Comb (CIC)</strong> filter is a computationally efficient decimation filter that requires no multipliers.</p>
<p>(a) Implement a single-stage CIC filter (integrator + comb) for decimation by $M$.</p>
<p>(b) Derive the frequency response of the CIC filter: $H(z) = \frac{1}{M}\frac{1 - z^{-M}}{1 - z^{-1}}$.</p>
<p>(c) Plot the magnitude response for $M = 8, 16, 32$ and compare with an ideal lowpass.</p>
<p>(d) Implement a multi-stage CIC filter ($K$ cascaded stages) and show how passband droop and stopband attenuation improve with $K$.</p>
<p>(e) Design a CIC-based decimation chain for a sigma-delta ADC: oversample at 64x, then CIC decimate to the final rate.</p>
<hr />
<h2 id="references">References<a class="header-link" href="#references" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>Vaidyanathan, P. P. (1993).</strong> <em>Multirate Systems and Filter Banks</em>. Prentice Hall. [The definitive reference]</li>
<li><strong>Oppenheim, A. V., &amp; Schafer, R. W. (2010).</strong> <em>Discrete-Time Signal Processing</em> (3rd ed.). Pearson. Chapter 4.</li>
<li><strong>Crochiere, R. E., &amp; Rabiner, L. R. (1983).</strong> <em>Multirate Digital Signal Processing</em>. Prentice Hall.</li>
<li><strong>Lyons, R. G. (2010).</strong> <em>Understanding Digital Signal Processing</em> (3rd ed.). Pearson. Chapter 10.</li>
<li><strong>Fliege, N. J. (1994).</strong> <em>Multirate Digital Signal Processing</em>. Wiley.</li>
<li><strong>SciPy Documentation</strong> -- <code>scipy.signal.resample_poly</code>, <code>scipy.signal.decimate</code>: https://docs.scipy.org/doc/scipy/reference/signal.html</li>
</ol>
<hr />
<h2 id="navigation">Navigation<a class="header-link" href="#navigation" title="Permanent link">&para;</a></h2>
<ul>
<li>Previous: <a href="10_IIR_Filter_Design.md">10. IIR Filter Design</a></li>
<li>Next: <a href="12_Spectral_Analysis.md">12. Spectral Analysis</a></li>
<li><a href="00_Overview.md">Back to Overview</a></li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/en/Signal_Processing/10_IIR_Filter_Design.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">IIR Filter Design</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/en/Signal_Processing/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/en/Signal_Processing/12_Spectral_Analysis.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Spectral Analysis</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'en';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}