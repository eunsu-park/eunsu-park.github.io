{% raw %}
<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë ˆìŠ¨ 11: ì½”ë“œ ìƒì„±(Code Generation) - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/ko/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/ko/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/ko/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" >
                        English
                    </option>
                    
                    <option value="ko" selected>
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/ko/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/ko/Compiler_Design/">Compiler Design</a>
    <span class="separator">/</span>
    <span class="current">ë ˆìŠ¨ 11: ì½”ë“œ ìƒì„±(Code Generation)</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>ë ˆìŠ¨ 11: ì½”ë“œ ìƒì„±(Code Generation)</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Compiler_Design/10_Runtime_Environments.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">ë ˆìŠ¨ 10: ëŸ°íƒ€ì„ í™˜ê²½(Runtime Environments)</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Compiler_Design/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Compiler_Design/12_Optimization_Local_and_Global.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">ë ˆìŠ¨ 12: ìµœì í™” -- ì§€ì—­ ìµœì í™”ì™€ ì „ì—­ ìµœì í™”</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#_1">í•™ìŠµ ëª©í‘œ</a></li>
<li><a href="#1-target-machine-model">1. ëª©í‘œ ê¸°ê³„ ëª¨ë¸(Target Machine Model)</a><ul>
<li><a href="#11">1.1 ê¸°ê³„ ëª¨ë¸ì´ í•„ìš”í•œ ì´ìœ </a></li>
<li><a href="#12">1.2 ê°„ë‹¨í•œ ëª©í‘œ ê¸°ê³„</a></li>
<li><a href="#13-addressing-modes">1.3 ì£¼ì†Œ ì§€ì • ëª¨ë“œ(Addressing Modes)</a></li>
<li><a href="#14-instruction-set">1.4 ëª…ë ¹ì–´ ì§‘í•©(Instruction Set)</a></li>
<li><a href="#15-instruction-costs">1.5 ëª…ë ¹ì–´ ë¹„ìš©(Instruction Costs)</a></li>
</ul>
</li>
<li><a href="#2-instruction-selection">2. ëª…ë ¹ì–´ ì„ íƒ(Instruction Selection)</a><ul>
<li><a href="#21">2.1 ë¬¸ì œ ì •ì˜</a></li>
<li><a href="#22-tree-pattern-matching">2.2 íŠ¸ë¦¬ íŒ¨í„´ ë§¤ì¹­(Tree Pattern Matching)</a></li>
<li><a href="#23-tiles">2.3 íƒ€ì¼(Tiles)</a></li>
<li><a href="#24-optimal-tiling-maximal-munch">2.4 ìµœì  íƒ€ì¼ë§(Optimal Tiling) ëŒ€ ìµœëŒ€ í•œì…(Maximal Munch)</a></li>
<li><a href="#25-maximal-munch-algorithm">2.5 ìµœëŒ€ í•œì… ì•Œê³ ë¦¬ì¦˜(Maximal Munch Algorithm)</a></li>
<li><a href="#26-python-maximal-munch">2.6 Python êµ¬í˜„: ìµœëŒ€ í•œì…(Maximal Munch)</a></li>
</ul>
</li>
<li><a href="#3-register-allocation">3. ë ˆì§€ìŠ¤í„° í• ë‹¹(Register Allocation)</a><ul>
<li><a href="#31">3.1 ë¬¸ì œ ì •ì˜</a></li>
<li><a href="#32">3.2 ë ˆì§€ìŠ¤í„° í• ë‹¹ì´ ì¤‘ìš”í•œ ì´ìœ </a></li>
<li><a href="#33-liveness-analysis">3.3 í™œì„± ë³€ìˆ˜ ë¶„ì„(Liveness Analysis)</a></li>
<li><a href="#34-interference-graph">3.4 ê°„ì„­ ê·¸ë˜í”„(Interference Graph)</a></li>
<li><a href="#35-graph-coloring-register-allocation">3.5 ê·¸ë˜í”„ ìƒ‰ì¹  ë ˆì§€ìŠ¤í„° í• ë‹¹(Graph Coloring Register Allocation)</a><ul>
<li><a href="#chaitin">Chaitin ì•Œê³ ë¦¬ì¦˜</a></li>
<li><a href="#_2">ì˜ˆì‹œ</a></li>
</ul>
</li>
<li><a href="#36-spilling">3.6 ìŠ¤í•„ë§(Spilling)</a></li>
<li><a href="#37-linear-scan-register-allocation">3.7 ì„ í˜• ìŠ¤ìº” ë ˆì§€ìŠ¤í„° í• ë‹¹(Linear Scan Register Allocation)</a></li>
<li><a href="#38-python-linear-scan">3.8 Python êµ¬í˜„: ì„ í˜• ìŠ¤ìº”(Linear Scan)</a></li>
</ul>
</li>
<li><a href="#4-instruction-scheduling">4. ëª…ë ¹ì–´ ìŠ¤ì¼€ì¤„ë§(Instruction Scheduling)</a><ul>
<li><a href="#41">4.1 ë¬¸ì œ ì •ì˜</a></li>
<li><a href="#42-list-scheduling">4.2 ë¦¬ìŠ¤íŠ¸ ìŠ¤ì¼€ì¤„ë§(List Scheduling)</a></li>
<li><a href="#43">4.3 ì˜ˆì‹œ: ë¦¬ìŠ¤íŠ¸ ìŠ¤ì¼€ì¤„ë§</a></li>
<li><a href="#44-software-pipelining">4.4 ì†Œí”„íŠ¸ì›¨ì–´ íŒŒì´í”„ë¼ì´ë‹(Software Pipelining) ê°œìš”</a></li>
</ul>
</li>
<li><a href="#5-peephole-optimization">5. í•í™€ ìµœì í™”(Peephole Optimization)</a><ul>
<li><a href="#51">5.1 í•í™€ ìµœì í™”ë€?</a></li>
<li><a href="#52">5.2 ì¼ë°˜ì ì¸ í•í™€ ìµœì í™”</a><ul>
<li><a href="#redundant-loadstore-elimination">ì¤‘ë³µ ë¡œë“œ/ìŠ¤í† ì–´ ì œê±°(Redundant Load/Store Elimination)</a></li>
<li><a href="#redundant-moves">ì¤‘ë³µ ì´ë™ ì œê±°(Redundant Moves)</a></li>
<li><a href="#strength-reduction">ê°•ë„ ê°ì†Œ(Strength Reduction)</a></li>
<li><a href="#algebraic-simplification">ëŒ€ìˆ˜ì  ë‹¨ìˆœí™”(Algebraic Simplification)</a></li>
<li><a href="#branch-optimization">ë¶„ê¸° ìµœì í™”(Branch Optimization)</a></li>
<li><a href="#unreachable-code-elimination">ë„ë‹¬ ë¶ˆê°€ ì½”ë“œ ì œê±°(Unreachable Code Elimination)</a></li>
</ul>
</li>
<li><a href="#53-python-peephole-optimizer">5.3 Python êµ¬í˜„: í•í™€ ìµœì í™”ê¸°(Peephole Optimizer)</a></li>
</ul>
</li>
<li><a href="#6-code-generation-for-language-constructs">6. ì–¸ì–´ êµ¬ì„±ìš”ì†Œë¥¼ ìœ„í•œ ì½”ë“œ ìƒì„±(Code Generation for Language Constructs)</a><ul>
<li><a href="#61-expressions">6.1 ì‹(Expressions)</a></li>
<li><a href="#62-control-flow">6.2 ì œì–´ íë¦„(Control Flow)</a><ul>
<li><a href="#if-else">If-Else</a></li>
<li><a href="#while">While ë£¨í”„</a></li>
<li><a href="#for">For ë£¨í”„</a></li>
<li><a href="#short-circuit">ë‹¨ë½(Short-Circuit) ë¶ˆë¦¬ì–¸ í‰ê°€</a></li>
</ul>
</li>
<li><a href="#63-function-calls">6.3 í•¨ìˆ˜ í˜¸ì¶œ(Function Calls)</a></li>
</ul>
</li>
<li><a href="#7-stack-machine-code-generator">7. ìŠ¤íƒ ê¸°ê³„ ì½”ë“œ ìƒì„±ê¸°(Stack Machine Code Generator)</a><ul>
<li><a href="#71">7.1 ìŠ¤íƒ ê¸°ê³„ë€?</a></li>
<li><a href="#72">7.2 ìŠ¤íƒ ê¸°ê³„ ëª…ë ¹ì–´ ì§‘í•©</a></li>
<li><a href="#73">7.3 ì™„ì „í•œ ìŠ¤íƒ ê¸°ê³„ êµ¬í˜„</a></li>
</ul>
</li>
<li><a href="#8-machine-dependent-optimization">8. ê¸°ê³„ ì˜ì¡´ ìµœì í™”(Machine-Dependent Optimization)</a><ul>
<li><a href="#81">8.1 íŠ¹ìˆ˜ ëª…ë ¹ì–´ í™œìš©</a></li>
<li><a href="#82-addressing-mode-selection">8.2 ì£¼ì†Œ ì§€ì • ëª¨ë“œ ì„ íƒ(Addressing Mode Selection)</a></li>
<li><a href="#83-arm-conditional-execution">8.3 ì¡°ê±´ë¶€ ì‹¤í–‰(ARM) (Conditional Execution)</a></li>
<li><a href="#84-branch-prediction-hints">8.4 ë¶„ê¸° ì˜ˆì¸¡ íŒíŠ¸(Branch Prediction Hints)</a></li>
</ul>
</li>
<li><a href="#9">9. ìš”ì•½</a></li>
<li><a href="#_3">ì—°ìŠµ ë¬¸ì œ</a><ul>
<li><a href="#1-maximal-munch">ì—°ìŠµ 1: ìµœëŒ€ í•œì…(Maximal Munch)</a></li>
<li><a href="#2-register-allocation">ì—°ìŠµ 2: ë ˆì§€ìŠ¤í„° í• ë‹¹(Register Allocation)</a></li>
<li><a href="#3-instruction-scheduling">ì—°ìŠµ 3: ëª…ë ¹ì–´ ìŠ¤ì¼€ì¤„ë§(Instruction Scheduling)</a></li>
<li><a href="#4-peephole-optimization">ì—°ìŠµ 4: í•í™€ ìµœì í™”(Peephole Optimization)</a></li>
<li><a href="#5-stack-machine">ì—°ìŠµ 5: ìŠ¤íƒ ê¸°ê³„(Stack Machine)</a></li>
<li><a href="#6">ì—°ìŠµ 6: êµ¬í˜„ ë„ì „</a></li>
</ul>
</li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="11-code-generation">ë ˆìŠ¨ 11: ì½”ë“œ ìƒì„±(Code Generation)<a class="header-link" href="#11-code-generation" title="Permanent link">&para;</a></h1>
<h2 id="_1">í•™ìŠµ ëª©í‘œ<a class="header-link" href="#_1" title="Permanent link">&para;</a></h2>
<p>ì´ ë ˆìŠ¨ì„ ì™„ë£Œí•˜ë©´ ë‹¤ìŒì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:</p>
<ol>
<li><strong>ì„¤ëª…í•˜ê¸°</strong>: ì½”ë“œ ìƒì„±ì— ì‚¬ìš©ë˜ëŠ” ëª©í‘œ ê¸°ê³„ ëª¨ë¸(target machine model)</li>
<li><strong>ì„¤ëª…í•˜ê¸°</strong>: íŠ¸ë¦¬ íŒ¨í„´ ë§¤ì¹­(tree pattern matching) ë° íƒ€ì¼ë§(tiling)ì„ í†µí•œ ëª…ë ¹ì–´ ì„ íƒ(instruction selection)</li>
<li><strong>êµ¬í˜„í•˜ê¸°</strong>: ëª…ë ¹ì–´ ì„ íƒì„ ìœ„í•œ ìµœëŒ€ í•œì… ì•Œê³ ë¦¬ì¦˜(Maximal Munch algorithm)</li>
<li><strong>ì ìš©í•˜ê¸°</strong>: ë ˆì§€ìŠ¤í„° í• ë‹¹(register allocation) ê¸°ë²•: ê·¸ë˜í”„ ìƒ‰ì¹ (graph coloring) ë° ì„ í˜• ìŠ¤ìº”(linear scan)</li>
<li><strong>ì´í•´í•˜ê¸°</strong>: ëª…ë ¹ì–´ ìŠ¤ì¼€ì¤„ë§(instruction scheduling): ë¦¬ìŠ¤íŠ¸ ìŠ¤ì¼€ì¤„ë§(list scheduling), ì†Œí”„íŠ¸ì›¨ì–´ íŒŒì´í”„ë¼ì´ë‹(software pipelining) ê°œìš”</li>
<li><strong>ìˆ˜í–‰í•˜ê¸°</strong>: ìƒì„±ëœ ì½”ë“œì— ëŒ€í•œ í•í™€ ìµœì í™”(peephole optimization)</li>
<li><strong>ìƒì„±í•˜ê¸°</strong>: ì‹, ì œì–´ íë¦„, í•¨ìˆ˜ í˜¸ì¶œì— ëŒ€í•œ ì½”ë“œ</li>
<li><strong>êµ¬í˜„í•˜ê¸°</strong>: Pythonìœ¼ë¡œ ìŠ¤íƒ ê¸°ê³„(stack machine)ìš© ì™„ì „í•œ ì½”ë“œ ìƒì„±ê¸°</li>
</ol>
<hr />
<h2 id="1-target-machine-model">1. ëª©í‘œ ê¸°ê³„ ëª¨ë¸(Target Machine Model)<a class="header-link" href="#1-target-machine-model" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 ê¸°ê³„ ëª¨ë¸ì´ í•„ìš”í•œ ì´ìœ <a class="header-link" href="#11" title="Permanent link">&para;</a></h3>
<p>ì½”ë“œ ìƒì„±ì€ ì¤‘ê°„ í‘œí˜„(IR, Intermediate Representation)ì„ íŠ¹ì • ëª©í‘œ ê¸°ê³„(target machine)ì˜ ëª…ë ¹ì–´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. ê¸°ê³„ì— ë…ë¦½ì ì¸ ë°©ì‹ìœ¼ë¡œ ì½”ë“œ ìƒì„± ê¸°ë²•ì„ ì—°êµ¬í•˜ê¸° ìœ„í•´, ì‹¤ì œ ì•„í‚¤í…ì²˜ì˜ í•µì‹¬ íŠ¹ì§•ì„ ë‹´ì€ ì¶”ìƒì ì¸ ëª©í‘œ ê¸°ê³„ ëª¨ë¸ì„ ì •ì˜í•©ë‹ˆë‹¤.</p>
<h3 id="12">1.2 ê°„ë‹¨í•œ ëª©í‘œ ê¸°ê³„<a class="header-link" href="#12" title="Permanent link">&para;</a></h3>
<p>ìš°ë¦¬ì˜ ëª¨ë¸ ê¸°ê³„ëŠ” ë‹¤ìŒê³¼ ê°™ì€ íŠ¹ì„±ì„ ê°€ì§‘ë‹ˆë‹¤:</p>
<table>
<thead>
<tr>
<th>íŠ¹ì„±</th>
<th>ì„¤ëª…</th>
</tr>
</thead>
<tbody>
<tr>
<td>ë ˆì§€ìŠ¤í„°(Registers)</td>
<td>$R_0, R_1, \ldots, R_{k-1}$ (ë²”ìš©)</td>
</tr>
<tr>
<td>ë©”ëª¨ë¦¬(Memory)</td>
<td>ë°”ì´íŠ¸ ì£¼ì†Œ ì§€ì •, ì›Œë“œ í¬ê¸° = 4ë°”ì´íŠ¸</td>
</tr>
<tr>
<td>ëª…ë ¹ì–´(Instructions)</td>
<td>3ì£¼ì†Œ í˜•ì‹: <code>op dst, src1, src2</code></td>
</tr>
<tr>
<td>ì£¼ì†Œ ì§€ì • ëª¨ë“œ(Addressing modes)</td>
<td>ë ˆì§€ìŠ¤í„°, ì¦‰ì‹œê°’, ë ˆì§€ìŠ¤í„° ê°„ì ‘, ì¸ë±ìŠ¤</td>
</tr>
<tr>
<td>ìŠ¤íƒ(Stack)</td>
<td>ì•„ë˜ ë°©í–¥ìœ¼ë¡œ ì¦ê°€, SP ë ˆì§€ìŠ¤í„°</td>
</tr>
</tbody>
</table>
<h3 id="13-addressing-modes">1.3 ì£¼ì†Œ ì§€ì • ëª¨ë“œ(Addressing Modes)<a class="header-link" href="#13-addressing-modes" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>ëª¨ë“œ</th>
<th>êµ¬ë¬¸</th>
<th>ì˜ë¯¸</th>
<th>ì‚¬ìš© ì‚¬ë¡€</th>
</tr>
</thead>
<tbody>
<tr>
<td>ë ˆì§€ìŠ¤í„°(Register)</td>
<td><code>R0</code></td>
<td>R0 ë ˆì§€ìŠ¤í„°ì˜ ê°’</td>
<td>ë ˆì§€ìŠ¤í„°ì˜ ì§€ì—­ ë³€ìˆ˜</td>
</tr>
<tr>
<td>ì¦‰ì‹œê°’(Immediate)</td>
<td><code>#42</code></td>
<td>ìƒìˆ˜ ê°’ 42</td>
<td>ìƒìˆ˜, ì˜¤í”„ì…‹</td>
</tr>
<tr>
<td>ë ˆì§€ìŠ¤í„° ê°„ì ‘(Register-indirect)</td>
<td><code>[R0]</code></td>
<td>R0ì— ì €ì¥ëœ ì£¼ì†Œì˜ ë©”ëª¨ë¦¬</td>
<td>í¬ì¸í„° ì—­ì°¸ì¡°</td>
</tr>
<tr>
<td>ì¸ë±ìŠ¤(Indexed)</td>
<td><code>[R0 + #8]</code></td>
<td>R0 + 8 ì£¼ì†Œì˜ ë©”ëª¨ë¦¬</td>
<td>ë°°ì—´ ì ‘ê·¼, êµ¬ì¡°ì²´ í•„ë“œ</td>
</tr>
<tr>
<td>ì§ì ‘(Direct)</td>
<td><code>[addr]</code></td>
<td>ì ˆëŒ€ ì£¼ì†Œì˜ ë©”ëª¨ë¦¬</td>
<td>ì „ì—­ ë³€ìˆ˜</td>
</tr>
</tbody>
</table>
<h3 id="14-instruction-set">1.4 ëª…ë ¹ì–´ ì§‘í•©(Instruction Set)<a class="header-link" href="#14-instruction-set" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Arithmetic</span><span class="p">:</span>
<span class="w">    </span><span class="n">ADD</span><span class="w">  </span><span class="n">Rd</span><span class="p">,</span><span class="w"> </span><span class="n">Rs1</span><span class="p">,</span><span class="w"> </span><span class="n">Rs2</span><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="n">Rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rs1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Rs2</span>
<span class="w">    </span><span class="n">SUB</span><span class="w">  </span><span class="n">Rd</span><span class="p">,</span><span class="w"> </span><span class="n">Rs1</span><span class="p">,</span><span class="w"> </span><span class="n">Rs2</span><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="n">Rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rs1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Rs2</span>
<span class="w">    </span><span class="n">MUL</span><span class="w">  </span><span class="n">Rd</span><span class="p">,</span><span class="w"> </span><span class="n">Rs1</span><span class="p">,</span><span class="w"> </span><span class="n">Rs2</span><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="n">Rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rs1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Rs2</span>
<span class="w">    </span><span class="n">DIV</span><span class="w">  </span><span class="n">Rd</span><span class="p">,</span><span class="w"> </span><span class="n">Rs1</span><span class="p">,</span><span class="w"> </span><span class="n">Rs2</span><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="n">Rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rs1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Rs2</span>
<span class="w">    </span><span class="n">ADDI</span><span class="w"> </span><span class="n">Rd</span><span class="p">,</span><span class="w"> </span><span class="n">Rs</span><span class="p">,</span><span class="w"> </span><span class="c1">#imm    ; Rd = Rs + imm</span>

<span class="n">Data</span><span class="w"> </span><span class="n">movement</span><span class="p">:</span>
<span class="w">    </span><span class="n">MOV</span><span class="w">  </span><span class="n">Rd</span><span class="p">,</span><span class="w"> </span><span class="n">Rs</span><span class="w">          </span><span class="p">;</span><span class="w"> </span><span class="n">Rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rs</span>
<span class="w">    </span><span class="n">MOVI</span><span class="w"> </span><span class="n">Rd</span><span class="p">,</span><span class="w"> </span><span class="c1">#imm        ; Rd = imm (load immediate)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">Rd</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">Rs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="c1">#off] ; Rd = Mem[Rs + off]</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">Rs</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">Rd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="c1">#off]; Mem[Rd + off] = Rs</span>

<span class="n">Control</span><span class="w"> </span><span class="n">flow</span><span class="p">:</span>
<span class="w">    </span><span class="n">CMP</span><span class="w">  </span><span class="n">Rs1</span><span class="p">,</span><span class="w"> </span><span class="n">Rs2</span><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">condition</span><span class="w"> </span><span class="n">flags</span>
<span class="w">    </span><span class="n">BEQ</span><span class="w">  </span><span class="n">label</span><span class="w">           </span><span class="p">;</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">equal</span>
<span class="w">    </span><span class="n">BNE</span><span class="w">  </span><span class="n">label</span><span class="w">           </span><span class="p">;</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">equal</span>
<span class="w">    </span><span class="n">BLT</span><span class="w">  </span><span class="n">label</span><span class="w">           </span><span class="p">;</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">less</span><span class="w"> </span><span class="n">than</span>
<span class="w">    </span><span class="n">BGT</span><span class="w">  </span><span class="n">label</span><span class="w">           </span><span class="p">;</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">greater</span><span class="w"> </span><span class="n">than</span>
<span class="w">    </span><span class="n">BLE</span><span class="w">  </span><span class="n">label</span><span class="w">           </span><span class="p">;</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">less</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">equal</span>
<span class="w">    </span><span class="n">BGE</span><span class="w">  </span><span class="n">label</span><span class="w">           </span><span class="p">;</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">greater</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">equal</span>
<span class="w">    </span><span class="n">JMP</span><span class="w">  </span><span class="n">label</span><span class="w">           </span><span class="p">;</span><span class="w"> </span><span class="n">Unconditional</span><span class="w"> </span><span class="n">jump</span>
<span class="w">    </span><span class="n">CALL</span><span class="w"> </span><span class="n">label</span><span class="w">           </span><span class="p">;</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="p">(</span><span class="n">push</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">jump</span><span class="p">)</span>
<span class="w">    </span><span class="n">RET</span><span class="w">                  </span><span class="p">;</span><span class="w"> </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="n">pop</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">jump</span><span class="p">)</span>

<span class="n">Stack</span><span class="p">:</span>
<span class="w">    </span><span class="n">PUSH</span><span class="w"> </span><span class="n">Rs</span><span class="w">              </span><span class="p">;</span><span class="w"> </span><span class="n">Push</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="n">onto</span><span class="w"> </span><span class="n">stack</span>
<span class="w">    </span><span class="n">POP</span><span class="w">  </span><span class="n">Rd</span><span class="w">              </span><span class="p">;</span><span class="w"> </span><span class="n">Pop</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">register</span>
</code></pre></div>

<h3 id="15-instruction-costs">1.5 ëª…ë ¹ì–´ ë¹„ìš©(Instruction Costs)<a class="header-link" href="#15-instruction-costs" title="Permanent link">&para;</a></h3>
<p>ëª…ë ¹ì–´ë§ˆë‹¤ ë¹„ìš©(ì‚¬ì´í´ ìˆ˜)ì´ ë‹¤ë¦…ë‹ˆë‹¤:</p>
<table>
<thead>
<tr>
<th>ëª…ë ¹ì–´</th>
<th>ë¹„ìš©</th>
<th>ì°¸ê³ </th>
</tr>
</thead>
<tbody>
<tr>
<td>ADD, SUB, MOV</td>
<td>1</td>
<td>ë ˆì§€ìŠ¤í„°-ë ˆì§€ìŠ¤í„° ì—°ì‚°</td>
</tr>
<tr>
<td>MUL</td>
<td>3</td>
<td>ê³±ì…ˆì€ ë” ëŠë¦¼</td>
</tr>
<tr>
<td>DIV</td>
<td>10-40</td>
<td>ë‚˜ëˆ—ì…ˆì€ ë§¤ìš° ë¹„ìŒˆ</td>
</tr>
<tr>
<td>LOAD</td>
<td>4 (L1 íˆíŠ¸)</td>
<td>ë©”ëª¨ë¦¬ ì ‘ê·¼ (ìºì‹œ ì˜ì¡´)</td>
</tr>
<tr>
<td>STORE</td>
<td>1 (ë²„í¼ë§)</td>
<td>ì“°ê¸° ë²„í¼ê°€ ì§€ì—°ì„ ìˆ¨ê¹€</td>
</tr>
<tr>
<td>Branch (taken)</td>
<td>2</td>
<td>íŒŒì´í”„ë¼ì¸ í”ŒëŸ¬ì‹œ íŒ¨ë„í‹°</td>
</tr>
<tr>
<td>Branch (not taken)</td>
<td>1</td>
<td>ì˜¬ë°”ë¥´ê²Œ ì˜ˆì¸¡ë¨</td>
</tr>
</tbody>
</table>
<p>ì½”ë“œ ìƒì„±ê¸°ëŠ” ê°€ëŠ¥í•œ ê²½ìš° ë” ì €ë ´í•œ ëª…ë ¹ì–´ë¥¼ ì„ í˜¸í•´ì•¼ í•©ë‹ˆë‹¤ (ì˜ˆ: 2ì˜ ê±°ë“­ì œê³± ê³±ì…ˆ ëŒ€ì‹  ì‹œí”„íŠ¸ ì‚¬ìš©).</p>
<hr />
<h2 id="2-instruction-selection">2. ëª…ë ¹ì–´ ì„ íƒ(Instruction Selection)<a class="header-link" href="#2-instruction-selection" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 ë¬¸ì œ ì •ì˜<a class="header-link" href="#21" title="Permanent link">&para;</a></h3>
<p>ëª…ë ¹ì–´ ì„ íƒì€ IR ì—°ì‚°ì„ ëª©í‘œ ê¸°ê³„ ëª…ë ¹ì–´ë¡œ ë§¤í•‘í•©ë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ë„ì „ì´ ìˆìŠµë‹ˆë‹¤:</p>
<ol>
<li>ë‹¨ì¼ IR ì—°ì‚°ì´ ì—¬ëŸ¬ ê¸°ê³„ ëª…ë ¹ì–´ì— ëŒ€ì‘ë  ìˆ˜ ìˆìŒ</li>
<li>ë‹¨ì¼ ê¸°ê³„ ëª…ë ¹ì–´ê°€ ì—¬ëŸ¬ IR ì—°ì‚°ì„ ì»¤ë²„í•  ìˆ˜ ìˆìŒ</li>
<li>ì„œë¡œ ë‹¤ë¥¸ ëª…ë ¹ì–´ ì‹œí€€ìŠ¤ê°€ ì„œë¡œ ë‹¤ë¥¸ ë¹„ìš©ìœ¼ë¡œ ë™ì¼í•œ ê²°ê³¼ë¥¼ ê³„ì‚°í•  ìˆ˜ ìˆìŒ</li>
<li>ìµœì ì˜ ì„ íƒì€ ë¬¸ë§¥(ë ˆì§€ìŠ¤í„° ê°€ìš©ì„±, ì£¼ë³€ ëª…ë ¹ì–´)ì— ë”°ë¼ ë‹¤ë¦„</li>
</ol>
<h3 id="22-tree-pattern-matching">2.2 íŠ¸ë¦¬ íŒ¨í„´ ë§¤ì¹­(Tree Pattern Matching)<a class="header-link" href="#22-tree-pattern-matching" title="Permanent link">&para;</a></h3>
<p>ë§ì€ ì•„í‚¤í…ì²˜ì—ëŠ” ë³µí•© ì—°ì‚°ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ëª…ë ¹ì–´ê°€ ìˆìŠµë‹ˆë‹¤ (ì˜ˆ: <code>LOAD R0, [R1 + R2*4 + #8]</code>ì€ ë§ì…ˆ, ê³±ì…ˆ, ë©”ëª¨ë¦¬ ë¡œë“œë¥¼ í•˜ë‚˜ì˜ ëª…ë ¹ì–´ë¡œ ìˆ˜í–‰).</p>
<p><strong>íŠ¸ë¦¬ íŒ¨í„´ ë§¤ì¹­(tree pattern matching)</strong>ì˜ ì•„ì´ë””ì–´ëŠ”:</p>
<ol>
<li>IRì„ ì‹ íŠ¸ë¦¬(expression tree)ë¡œ í‘œí˜„</li>
<li>ë‹¨ì¼ ê¸°ê³„ ëª…ë ¹ì–´ì— ëŒ€ì‘í•˜ëŠ” íŠ¸ë¦¬ íŒ¨í„´ì¸ <strong>íƒ€ì¼(tile)</strong> ì •ì˜</li>
<li>ì´ ë¹„ìš©ì„ ìµœì†Œí™”í•˜ëŠ” ë¹„ê²¹ì¹¨ íƒ€ì¼ë¡œ IR íŠ¸ë¦¬ë¥¼ <strong>ì»¤ë²„(cover)</strong></li>
</ol>
<h3 id="23-tiles">2.3 íƒ€ì¼(Tiles)<a class="header-link" href="#23-tiles" title="Permanent link">&para;</a></h3>
<p><strong>íƒ€ì¼(tile)</strong>ì€ ê¸°ê³„ ëª…ë ¹ì–´ì™€ ë¹„ìš©ì´ ìŒì„ ì´ë£¨ëŠ” íŠ¸ë¦¬ íŒ¨í„´ì…ë‹ˆë‹¤.</p>
<p>ìš°ë¦¬ì˜ ëª©í‘œ ê¸°ê³„ì— ëŒ€í•œ ì˜ˆì‹œ íƒ€ì¼:</p>
<div class="highlight"><pre><span></span><code><span class="n">Tile</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">register</span><span class="w">                    </span><span class="n">Tile</span><span class="w"> </span><span class="mi">2</span><span class="err">:</span><span class="w"> </span><span class="k">immediate</span>
<span class="nl">Pattern</span><span class="p">:</span><span class="w">   </span><span class="n">reg</span><span class="w">                      </span><span class="nl">Pattern</span><span class="p">:</span><span class="w">   </span><span class="n">#imm</span>
<span class="nl">Instr</span><span class="p">:</span><span class="w">     </span><span class="p">(</span><span class="k">none</span><span class="p">,</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">reg</span><span class="p">)</span><span class="w">   </span><span class="nl">Instr</span><span class="p">:</span><span class="w">     </span><span class="n">MOVI</span><span class="w"> </span><span class="n">Rd</span><span class="p">,</span><span class="w"> </span><span class="n">#imm</span>
<span class="nl">Cost</span><span class="p">:</span><span class="w">      </span><span class="mi">0</span><span class="w">                        </span><span class="nl">Cost</span><span class="p">:</span><span class="w">      </span><span class="mi">1</span>

<span class="n">Tile</span><span class="w"> </span><span class="mi">3</span><span class="err">:</span><span class="w"> </span><span class="k">add</span><span class="w">                         </span><span class="n">Tile</span><span class="w"> </span><span class="mi">4</span><span class="err">:</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">immediate</span>
<span class="nl">Pattern</span><span class="p">:</span><span class="w">     </span><span class="o">+</span><span class="w">                      </span><span class="nl">Pattern</span><span class="p">:</span><span class="w">     </span><span class="o">+</span>
<span class="w">            </span><span class="o">/</span><span class="w"> </span><span class="err">\</span><span class="w">                                 </span><span class="o">/</span><span class="w"> </span><span class="err">\</span>
<span class="w">          </span><span class="n">reg</span><span class="w">  </span><span class="n">reg</span><span class="w">                            </span><span class="n">reg</span><span class="w">  </span><span class="n">#imm</span>
<span class="nl">Instr</span><span class="p">:</span><span class="w">   </span><span class="k">ADD</span><span class="w"> </span><span class="n">Rd</span><span class="p">,</span><span class="w"> </span><span class="n">Rs1</span><span class="p">,</span><span class="w"> </span><span class="n">Rs2</span><span class="w">          </span><span class="nl">Instr</span><span class="p">:</span><span class="w">   </span><span class="n">ADDI</span><span class="w"> </span><span class="n">Rd</span><span class="p">,</span><span class="w"> </span><span class="n">Rs</span><span class="p">,</span><span class="w"> </span><span class="n">#imm</span>
<span class="nl">Cost</span><span class="p">:</span><span class="w">    </span><span class="mi">1</span><span class="w">                          </span><span class="nl">Cost</span><span class="p">:</span><span class="w">    </span><span class="mi">1</span>

<span class="n">Tile</span><span class="w"> </span><span class="mi">5</span><span class="err">:</span><span class="w"> </span><span class="k">load</span><span class="w">                        </span><span class="n">Tile</span><span class="w"> </span><span class="mi">6</span><span class="err">:</span><span class="w"> </span><span class="n">indexed</span><span class="w"> </span><span class="k">load</span>
<span class="nl">Pattern</span><span class="p">:</span><span class="w">   </span><span class="n">MEM</span><span class="w">                      </span><span class="nl">Pattern</span><span class="p">:</span><span class="w">   </span><span class="n">MEM</span>
<span class="w">            </span><span class="o">|</span><span class="w">                                   </span><span class="o">|</span>
<span class="w">           </span><span class="n">reg</span><span class="w">                                  </span><span class="o">+</span>
<span class="w">                                               </span><span class="o">/</span><span class="w"> </span><span class="err">\</span>
<span class="nl">Instr</span><span class="p">:</span><span class="w">   </span><span class="k">LOAD</span><span class="w"> </span><span class="n">Rd</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">Rs</span><span class="o">]</span><span class="w">                       </span><span class="n">reg</span><span class="w">  </span><span class="n">#imm</span>
<span class="nl">Cost</span><span class="p">:</span><span class="w">    </span><span class="mi">4</span><span class="w">                          </span><span class="nl">Instr</span><span class="p">:</span><span class="w">   </span><span class="k">LOAD</span><span class="w"> </span><span class="n">Rd</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">Rs + #imm</span><span class="o">]</span>
<span class="w">                                    </span><span class="nl">Cost</span><span class="p">:</span><span class="w">    </span><span class="mi">4</span>

<span class="n">Tile</span><span class="w"> </span><span class="mi">7</span><span class="err">:</span><span class="w"> </span><span class="n">store</span><span class="w">                       </span><span class="n">Tile</span><span class="w"> </span><span class="mi">8</span><span class="err">:</span><span class="w"> </span><span class="n">indexed</span><span class="w"> </span><span class="n">store</span>
<span class="nl">Pattern</span><span class="p">:</span><span class="w">  </span><span class="n">STORE</span><span class="w">                     </span><span class="nl">Pattern</span><span class="p">:</span><span class="w">  </span><span class="n">STORE</span>
<span class="w">          </span><span class="o">/</span><span class="w">   </span><span class="err">\</span><span class="w">                               </span><span class="o">/</span><span class="w">    </span><span class="err">\</span>
<span class="w">        </span><span class="n">addr</span><span class="w">   </span><span class="n">reg</span><span class="w">                           </span><span class="o">+</span><span class="w">      </span><span class="n">reg</span>
<span class="w">                                            </span><span class="o">/</span><span class="w"> </span><span class="err">\</span>
<span class="nl">Instr</span><span class="p">:</span><span class="w">  </span><span class="n">STORE</span><span class="w"> </span><span class="n">Rs</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">Rd</span><span class="o">]</span><span class="w">                    </span><span class="n">reg</span><span class="w">  </span><span class="n">#imm</span>
<span class="nl">Cost</span><span class="p">:</span><span class="w">   </span><span class="mi">1</span><span class="w">                           </span><span class="nl">Instr</span><span class="p">:</span><span class="w">  </span><span class="n">STORE</span><span class="w"> </span><span class="n">Rs</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">Rd + #imm</span><span class="o">]</span>
<span class="w">                                    </span><span class="nl">Cost</span><span class="p">:</span><span class="w">   </span><span class="mi">1</span>
</code></pre></div>

<h3 id="24-optimal-tiling-maximal-munch">2.4 ìµœì  íƒ€ì¼ë§(Optimal Tiling) ëŒ€ ìµœëŒ€ í•œì…(Maximal Munch)<a class="header-link" href="#24-optimal-tiling-maximal-munch" title="Permanent link">&para;</a></h3>
<p>íŠ¸ë¦¬ë¥¼ íƒ€ì¼ë¡œ ì»¤ë²„í•˜ëŠ” ë‘ ê°€ì§€ ì£¼ìš” ì „ëµì´ ìˆìŠµë‹ˆë‹¤:</p>
<p><strong>ìµœì  íƒ€ì¼ë§(Optimal Tiling)</strong>: ìµœì†Œ ì´ ë¹„ìš©ìœ¼ë¡œ ì „ì²´ íŠ¸ë¦¬ë¥¼ ì»¤ë²„í•˜ëŠ” íƒ€ì¼ ì§‘í•©ì„ ì°¾ìŠµë‹ˆë‹¤. íŠ¸ë¦¬ì—ì„œ í•˜í–¥ì‹ ë™ì  í”„ë¡œê·¸ë˜ë°ìœ¼ë¡œ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<p><strong>ìµœëŒ€ í•œì…(Maximal Munch)</strong> (íƒìš•ì ): ê° ë…¸ë“œì—ì„œ ë£¨íŠ¸ë¶€í„° ì‹œì‘í•˜ì—¬ ê°€ì¥ í°(ê°€ì¥ ë§ì´ ì»¤ë²„í•˜ëŠ”) íƒ€ì¼ì„ ì„ íƒí•©ë‹ˆë‹¤. ë” ë‹¨ìˆœí•˜ì§€ë§Œ ì „ì—­ì ìœ¼ë¡œ ìµœì ì¸ í•´ë¥¼ ì°¾ì§€ ëª»í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<p>ì‹¤ì œë¡œëŠ” ìµœëŒ€ í•œì…ì´ ìµœì ì— ê°€ê¹Œìš´ ê²°ê³¼ë¥¼ ìƒì„±í•˜ë©° ë„ë¦¬ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
<h3 id="25-maximal-munch-algorithm">2.5 ìµœëŒ€ í•œì… ì•Œê³ ë¦¬ì¦˜(Maximal Munch Algorithm)<a class="header-link" href="#25-maximal-munch-algorithm" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">function</span><span class="w"> </span><span class="nf">maximal_munch</span><span class="p">(</span>node<span class="p">):</span>
<span class="w">    </span><span class="n">Find</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">largest</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="nb">matches</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">node</span>
<span class="w">    </span><span class="p">(</span><span class="n">matching</span><span class="w"> </span><span class="n">means</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="nb">pattern</span><span class="w"> </span><span class="nb">matches</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">subtree</span><span class="w"> </span><span class="n">rooted</span><span class="w"> </span><span class="n">here</span><span class="p">)</span>

<span class="w">    </span><span class="n">For</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">leaf</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">selected</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">corresponds</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span>
<span class="w">    </span><span class="n">subtree</span><span class="w"> </span><span class="p">(</span><span class="n">not</span><span class="w"> </span><span class="n">yet</span><span class="w"> </span><span class="n">covered</span><span class="p">):</span>
<span class="w">        </span><span class="n">Recursively</span><span class="w"> </span><span class="n">apply</span><span class="w"> </span><span class="n">maximal_munch</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">subtree</span>

<span class="w">    </span><span class="n">Emit</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">associated</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">selected</span><span class="w"> </span><span class="n">tile</span>
</code></pre></div>

<p>ì´ ì•Œê³ ë¦¬ì¦˜ì€ <strong>í•˜í–¥ì‹(top-down)</strong>ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤: ë£¨íŠ¸ì—ì„œ ê°€ì¥ í° íŒ¨í„´ì„ ë§¤ì¹­í•œ í›„, ë‚˜ë¨¸ì§€ í•˜ìœ„ íŠ¸ë¦¬ë¥¼ ì¬ê·€ì ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.</p>
<p><strong>ì˜ˆì‹œ</strong>: <code>a[i] = b + 1</code>ì— ëŒ€í•œ ì½”ë“œ ìƒì„±</p>
<p>IR íŠ¸ë¦¬:</p>
<div class="highlight"><pre><span></span><code>        STORE
       /     \
      +       +
     / \     / \
    a   *   b   1
       / \
      i   4
</code></pre></div>

<p>ìµœëŒ€ í•œì…ì´ ë§¤ì¹­í•  ìˆ˜ ìˆëŠ” íŒ¨í„´:
1. ë£¨íŠ¸ì—ì„œ: <code>STORE(addr, value)</code>ë¥¼ ì»¤ë²„í•˜ëŠ” STORE íƒ€ì¼ -- STORE ëª…ë ¹ì–´ ë°©ì¶œ
2. ì™¼ìª½ ìì‹ <code>+</code>: <code>a + (i * 4)</code> ë˜ëŠ” ì¸ë±ìŠ¤ ì£¼ì†Œ ì§€ì •ì„ ìœ„í•œ ADD íƒ€ì¼
3. ì˜¤ë¥¸ìª½ ìì‹ <code>+</code>: <code>b + 1</code>ì„ ìœ„í•œ ADDI íƒ€ì¼</p>
<h3 id="26-python-maximal-munch">2.6 Python êµ¬í˜„: ìµœëŒ€ í•œì…(Maximal Munch)<a class="header-link" href="#26-python-maximal-munch" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Instruction selection via Maximal Munch algorithm.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>


<span class="c1"># ---------- IR Tree Nodes ----------</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">IRNode</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for IR tree nodes.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Const</span><span class="p">(</span><span class="n">IRNode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Integer constant.&quot;&quot;&quot;</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="n">IRNode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Virtual register reference.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BinOp</span><span class="p">(</span><span class="n">IRNode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Binary operation.&quot;&quot;&quot;</span>
    <span class="n">op</span><span class="p">:</span> <span class="nb">str</span>        <span class="c1"># &#39;+&#39;, &#39;-&#39;, &#39;*&#39;, &#39;/&#39;</span>
    <span class="n">left</span><span class="p">:</span> <span class="n">IRNode</span>
    <span class="n">right</span><span class="p">:</span> <span class="n">IRNode</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Mem</span><span class="p">(</span><span class="n">IRNode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Memory access (load).&quot;&quot;&quot;</span>
    <span class="n">address</span><span class="p">:</span> <span class="n">IRNode</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Store</span><span class="p">(</span><span class="n">IRNode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Memory store.&quot;&quot;&quot;</span>
    <span class="n">address</span><span class="p">:</span> <span class="n">IRNode</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">IRNode</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CJump</span><span class="p">(</span><span class="n">IRNode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Conditional jump.&quot;&quot;&quot;</span>
    <span class="n">op</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># &#39;&lt;&#39;, &#39;&gt;&#39;, &#39;==&#39;, &#39;!=&#39;, &#39;&lt;=&#39;, &#39;&gt;=&#39;</span>
    <span class="n">left</span><span class="p">:</span> <span class="n">IRNode</span>
    <span class="n">right</span><span class="p">:</span> <span class="n">IRNode</span>
    <span class="n">true_label</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">false_label</span><span class="p">:</span> <span class="nb">str</span>


<span class="c1"># ---------- Machine Instructions ----------</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MachineInstr</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A target machine instruction.&quot;&quot;&quot;</span>
    <span class="n">opcode</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">operands</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;  ; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comment</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">opcode</span><span class="si">:</span><span class="s2">6s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ops</span><span class="si">}{</span><span class="n">comment</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="c1"># ---------- Maximal Munch Code Generator ----------</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MaximalMunchCodeGen</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instruction selection using the Maximal Munch (greedy) algorithm.</span>
<span class="sd">    Generates code for a simple RISC-like target.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">MachineInstr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reg_counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">new_reg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Allocate a new virtual register.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reg_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;v</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_reg_counter</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opcode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">operands</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MachineInstr</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Emit a machine instruction.&quot;&quot;&quot;</span>
        <span class="n">instr</span> <span class="o">=</span> <span class="n">MachineInstr</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="n">operands</span> <span class="ow">or</span> <span class="p">[],</span> <span class="n">comment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instr</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">munch_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">IRNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for an expression node using Maximal Munch.</span>
<span class="sd">        Returns the register holding the result.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># --- Tile: Constant ---</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Const</span><span class="p">):</span>
            <span class="n">rd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_reg</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;MOVI&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">rd</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                      <span class="sa">f</span><span class="s2">&quot;load constant </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rd</span>

        <span class="c1"># --- Tile: Register ---</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Reg</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># --- Tile: Memory load with indexed addressing ---</span>
        <span class="c1"># Pattern: MEM(BinOp(+, e1, Const(n)))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Mem</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">BinOp</span><span class="p">)</span> \
           <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">Const</span><span class="p">):</span>
            <span class="n">base_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munch_expr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">value</span>
            <span class="n">rd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_reg</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;LOAD&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">rd</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">base_reg</span><span class="si">}</span><span class="s2"> + #</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">],</span>
                      <span class="sa">f</span><span class="s2">&quot;indexed load&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rd</span>

        <span class="c1"># --- Tile: Memory load with register addressing ---</span>
        <span class="c1"># Pattern: MEM(e)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Mem</span><span class="p">):</span>
            <span class="n">addr_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munch_expr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
            <span class="n">rd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_reg</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;LOAD&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">rd</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">addr_reg</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">],</span>
                      <span class="s2">&quot;register-indirect load&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rd</span>

        <span class="c1"># --- Tile: Add immediate ---</span>
        <span class="c1"># Pattern: BinOp(+, e, Const(n))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">BinOp</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> \
           <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">Const</span><span class="p">):</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munch_expr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
            <span class="n">rd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_reg</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;ADDI&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">rd</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                      <span class="sa">f</span><span class="s2">&quot;add immediate </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rd</span>

        <span class="c1"># --- Tile: Add immediate (commuted) ---</span>
        <span class="c1"># Pattern: BinOp(+, Const(n), e)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">BinOp</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> \
           <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">Const</span><span class="p">):</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munch_expr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
            <span class="n">rd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_reg</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;ADDI&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">rd</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                      <span class="sa">f</span><span class="s2">&quot;add immediate </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rd</span>

        <span class="c1"># --- Tile: Multiply by power of 2 â†’ shift ---</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">BinOp</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span> \
           <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">Const</span><span class="p">)</span> \
           <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span> \
           <span class="ow">and</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munch_expr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">rd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_reg</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;SHL&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">rd</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">shift</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                      <span class="sa">f</span><span class="s2">&quot;multiply by </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> via shift&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rd</span>

        <span class="c1"># --- Tile: General binary operation ---</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">BinOp</span><span class="p">):</span>
            <span class="n">rs1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munch_expr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
            <span class="n">rs2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munch_expr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
            <span class="n">rd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_reg</span><span class="p">()</span>
            <span class="n">op_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;+&#39;</span><span class="p">:</span> <span class="s1">&#39;ADD&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span> <span class="s1">&#39;SUB&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span> <span class="s1">&#39;MUL&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span> <span class="s1">&#39;DIV&#39;</span><span class="p">}</span>
            <span class="n">opcode</span> <span class="o">=</span> <span class="n">op_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="s1">&#39;BINOP&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="p">[</span><span class="n">rd</span><span class="p">,</span> <span class="n">rs1</span><span class="p">,</span> <span class="n">rs2</span><span class="p">],</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="si">}</span><span class="s2"> operation&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rd</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot generate code for: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">munch_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">IRNode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate code for a statement node.&quot;&quot;&quot;</span>

        <span class="c1"># --- Tile: Indexed store ---</span>
        <span class="c1"># Pattern: Store(BinOp(+, e1, Const(n)), e2)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Store</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">BinOp</span><span class="p">)</span> \
           <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> \
           <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">Const</span><span class="p">):</span>
            <span class="n">base_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munch_expr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
            <span class="n">val_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munch_expr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;STORE&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">val_reg</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">base_reg</span><span class="si">}</span><span class="s2"> + #</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">],</span>
                      <span class="s2">&quot;indexed store&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># --- Tile: General store ---</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Store</span><span class="p">):</span>
            <span class="n">addr_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munch_expr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
            <span class="n">val_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munch_expr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;STORE&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">val_reg</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">addr_reg</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">],</span>
                      <span class="s2">&quot;register-indirect store&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># --- Tile: Conditional jump ---</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">CJump</span><span class="p">):</span>
            <span class="n">rs1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munch_expr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
            <span class="n">rs2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munch_expr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;CMP&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">rs1</span><span class="p">,</span> <span class="n">rs2</span><span class="p">],</span>
                      <span class="sa">f</span><span class="s2">&quot;compare for </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">branch_map</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="s1">&#39;BLT&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;BGT&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="s1">&#39;BEQ&#39;</span><span class="p">,</span>
                <span class="s1">&#39;!=&#39;</span><span class="p">:</span> <span class="s1">&#39;BNE&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span> <span class="s1">&#39;BLE&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span> <span class="s1">&#39;BGE&#39;</span>
            <span class="p">}</span>
            <span class="n">opcode</span> <span class="o">=</span> <span class="n">branch_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="s1">&#39;BR&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">true_label</span><span class="p">],</span>
                      <span class="sa">f</span><span class="s2">&quot;branch to </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">true_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;JMP&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">false_label</span><span class="p">],</span>
                      <span class="sa">f</span><span class="s2">&quot;fall-through to </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">false_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Expression statement: just evaluate for side effects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">munch_expr</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print all generated instructions.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>


<span class="c1"># ---------- Examples ----------</span>

<span class="k">def</span><span class="w"> </span><span class="nf">demo_expression</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate code for: result = a[i*4 + 8] + 1&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Expression: a[i*4 + 8] + 1 ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># IR tree: BinOp(+, Mem(BinOp(+, BinOp(*, i, 4), 8)), 1)</span>
    <span class="c1"># Simplified: Mem(BinOp(+, BinOp(+, a, BinOp(*, i, 4)), 8))</span>
    <span class="n">ir</span> <span class="o">=</span> <span class="n">BinOp</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
        <span class="n">Mem</span><span class="p">(</span>
            <span class="n">BinOp</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
                <span class="n">BinOp</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
                    <span class="n">Reg</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span>
                    <span class="n">BinOp</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">Reg</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">),</span> <span class="n">Const</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                <span class="p">),</span>
                <span class="n">Const</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">Const</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">gen</span> <span class="o">=</span> <span class="n">MaximalMunchCodeGen</span><span class="p">()</span>
    <span class="n">result_reg</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">munch_expr</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result in register: </span><span class="si">{</span><span class="n">result_reg</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">gen</span><span class="o">.</span><span class="n">print_code</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">demo_array_store</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate code for: a[i] = b + c&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Statement: a[i] = b + c ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Store(BinOp(+, a, BinOp(*, i, 4)), BinOp(+, b, c))</span>
    <span class="n">ir</span> <span class="o">=</span> <span class="n">Store</span><span class="p">(</span>
        <span class="n">address</span><span class="o">=</span><span class="n">BinOp</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">Reg</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">BinOp</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">Reg</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">),</span> <span class="n">Const</span><span class="p">(</span><span class="mi">4</span><span class="p">))),</span>
        <span class="n">value</span><span class="o">=</span><span class="n">BinOp</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">Reg</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">Reg</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="n">gen</span> <span class="o">=</span> <span class="n">MaximalMunchCodeGen</span><span class="p">()</span>
    <span class="n">gen</span><span class="o">.</span><span class="n">munch_stmt</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span>
    <span class="n">gen</span><span class="o">.</span><span class="n">print_code</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">demo_conditional</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate code for: if (x &lt; y) goto L1 else goto L2&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Conditional: if (x &lt; y) goto L1 else goto L2 ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">ir</span> <span class="o">=</span> <span class="n">CJump</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">Reg</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">Reg</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">),</span> <span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="s2">&quot;L2&quot;</span><span class="p">)</span>

    <span class="n">gen</span> <span class="o">=</span> <span class="n">MaximalMunchCodeGen</span><span class="p">()</span>
    <span class="n">gen</span><span class="o">.</span><span class="n">munch_stmt</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span>
    <span class="n">gen</span><span class="o">.</span><span class="n">print_code</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">demo_expression</span><span class="p">()</span>
    <span class="n">demo_array_store</span><span class="p">()</span>
    <span class="n">demo_conditional</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="3-register-allocation">3. ë ˆì§€ìŠ¤í„° í• ë‹¹(Register Allocation)<a class="header-link" href="#3-register-allocation" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 ë¬¸ì œ ì •ì˜<a class="header-link" href="#31" title="Permanent link">&para;</a></h3>
<p>IRì€ ë¬´í•œí•œ ìˆ˜ì˜ ê°€ìƒ ë ˆì§€ìŠ¤í„°(virtual register) ë˜ëŠ” ì„ì‹œ ë³€ìˆ˜(temporary)ë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, ì‹¤ì œ ê¸°ê³„ëŠ” ì†Œìˆ˜ì˜ ë¬¼ë¦¬ ë ˆì§€ìŠ¤í„°($k$ê°œ)ë§Œ ê°€ì§‘ë‹ˆë‹¤. ë ˆì§€ìŠ¤í„° í• ë‹¹ì€ ê°€ìƒ ë ˆì§€ìŠ¤í„°ë¥¼ ë¬¼ë¦¬ ë ˆì§€ìŠ¤í„°ì— ë°°ì •í•˜ë©°, $k$ê°œì˜ ë ˆì§€ìŠ¤í„°ê°€ ë¶€ì¡±í•˜ë©´ ì¼ë¶€ë¥¼ ë©”ëª¨ë¦¬ì— <strong>ìŠ¤í•„(spill)</strong>í•©ë‹ˆë‹¤.</p>
<h3 id="32">3.2 ë ˆì§€ìŠ¤í„° í• ë‹¹ì´ ì¤‘ìš”í•œ ì´ìœ <a class="header-link" href="#32" title="Permanent link">&para;</a></h3>
<p>ë ˆì§€ìŠ¤í„° ì ‘ê·¼ì€ ë©”ëª¨ë¦¬ ì ‘ê·¼ë³´ë‹¤ ìˆ˜ì‹­~ìˆ˜ë°± ë°° ë¹ ë¦…ë‹ˆë‹¤:</p>
<table>
<thead>
<tr>
<th>ì ‘ê·¼</th>
<th>ì§€ì—° ì‹œê°„(ì‚¬ì´í´)</th>
</tr>
</thead>
<tbody>
<tr>
<td>ë ˆì§€ìŠ¤í„°(Register)</td>
<td>0-1</td>
</tr>
<tr>
<td>L1 ìºì‹œ(L1 cache)</td>
<td>3-5</td>
</tr>
<tr>
<td>L2 ìºì‹œ(L2 cache)</td>
<td>10-15</td>
</tr>
<tr>
<td>L3 ìºì‹œ(L3 cache)</td>
<td>30-50</td>
</tr>
<tr>
<td>ì£¼ ë©”ëª¨ë¦¬(Main memory)</td>
<td>100-300</td>
</tr>
</tbody>
</table>
<p>ì¢‹ì€ ë ˆì§€ìŠ¤í„° í• ë‹¹ì€ í”„ë¡œê·¸ë¨ ì„±ëŠ¥ì„ í¬ê²Œ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<h3 id="33-liveness-analysis">3.3 í™œì„± ë³€ìˆ˜ ë¶„ì„(Liveness Analysis)<a class="header-link" href="#33-liveness-analysis" title="Permanent link">&para;</a></h3>
<p>ë ˆì§€ìŠ¤í„°ë¥¼ í• ë‹¹í•˜ê¸° ì „ì— ê° í”„ë¡œê·¸ë¨ ì§€ì ì—ì„œ ì–´ë–¤ ë³€ìˆ˜ê°€ <strong>ì‚´ì•„ìˆëŠ”ì§€(live)</strong> íŒŒì•…í•´ì•¼ í•©ë‹ˆë‹¤. ë³€ìˆ˜ê°€ ì–´ë–¤ ì§€ì ì—ì„œ <strong>ì‚´ì•„ìˆë‹¤</strong>ëŠ” ê²ƒì€ í•´ë‹¹ ë³€ìˆ˜ê°€ ë¯¸ë˜ì— ì‚¬ìš©ë  ê°’ì„ ë³´ìœ í•˜ê³  ìˆë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.</p>
<p><strong>ì •ì˜</strong>:
- ì§€ì  $p$ì—ì„œ ë³€ìˆ˜ $v$ê°€ <strong>ì •ì˜ëœë‹¤(defined)</strong>: $p$ê°€ $v$ì— ê°’ì„ í• ë‹¹í•˜ëŠ” ê²½ìš°
- ì§€ì  $p$ì—ì„œ ë³€ìˆ˜ $v$ê°€ <strong>ì‚¬ìš©ëœë‹¤(used)</strong>: $p$ê°€ $v$ë¥¼ ì½ëŠ” ê²½ìš°
- ì§€ì  $p$ì—ì„œ ë³€ìˆ˜ $v$ê°€ <strong>ì‚´ì•„ìˆë‹¤(live)</strong>: $p$ì—ì„œ $v$ì˜ ì¬ì •ì˜ ì—†ì´ $v$ì˜ ì‚¬ìš©ìœ¼ë¡œ ê°€ëŠ” ê²½ë¡œê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°</p>
<p><strong>ë°ì´í„° íë¦„ ë°©ì •ì‹</strong> (ì—­ë°©í–¥ìœ¼ë¡œ ê³„ì‚°):</p>
<p>$$\text{LiveIn}(B) = \text{Use}(B) \cup (\text{LiveOut}(B) - \text{Def}(B))$$</p>
<p>$$\text{LiveOut}(B) = \bigcup_{S \in \text{succ}(B)} \text{LiveIn}(S)$$</p>
<h3 id="34-interference-graph">3.4 ê°„ì„­ ê·¸ë˜í”„(Interference Graph)<a class="header-link" href="#34-interference-graph" title="Permanent link">&para;</a></h3>
<p>ë‘ ë³€ìˆ˜ê°€ ì–´ë–¤ í”„ë¡œê·¸ë¨ ì§€ì ì—ì„œ ë™ì‹œì— ì‚´ì•„ìˆìœ¼ë©´ <strong>ê°„ì„­(interfere)</strong>í•©ë‹ˆë‹¤. <strong>ê°„ì„­ ê·¸ë˜í”„</strong> $G = (V, E)$ëŠ” ë‹¤ìŒì„ ê°€ì§‘ë‹ˆë‹¤:</p>
<ul>
<li>ê¼­ì§“ì  $V$: ë³€ìˆ˜(ê°€ìƒ ë ˆì§€ìŠ¤í„°)ë§ˆë‹¤ í•˜ë‚˜</li>
<li>ê°„ì„  $E$: $(u, v) \in E$ if $u$ì™€ $v$ê°€ ê°„ì„­í•˜ëŠ” ê²½ìš°</li>
</ul>
<p>ë ˆì§€ìŠ¤í„° í• ë‹¹ì€ <strong>ê·¸ë˜í”„ ìƒ‰ì¹ (graph coloring)</strong> ë¬¸ì œê°€ ë©ë‹ˆë‹¤: ì¸ì ‘í•œ ë‘ ê¼­ì§“ì ì´ ê°™ì€ ìƒ‰ì„ ê°–ì§€ ì•Šë„ë¡ ê¼­ì§“ì ì— $k$ê°œì˜ ìƒ‰(ë¬¼ë¦¬ ë ˆì§€ìŠ¤í„°)ì„ ë°°ì •í•©ë‹ˆë‹¤.</p>
<h3 id="35-graph-coloring-register-allocation">3.5 ê·¸ë˜í”„ ìƒ‰ì¹  ë ˆì§€ìŠ¤í„° í• ë‹¹(Graph Coloring Register Allocation)<a class="header-link" href="#35-graph-coloring-register-allocation" title="Permanent link">&para;</a></h3>
<p>ê·¸ë˜í”„ ìƒ‰ì¹  ë°©ì‹ì˜ ë ˆì§€ìŠ¤í„° í• ë‹¹ì€ Chaitin(1981)ì´ ë„ì…í–ˆìŠµë‹ˆë‹¤.</p>
<h4 id="chaitin">Chaitin ì•Œê³ ë¦¬ì¦˜<a class="header-link" href="#chaitin" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">repeat</span><span class="p">:</span>
<span class="w">    </span><span class="mf">1.</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">interference</span><span class="w"> </span><span class="n">graph</span>
<span class="w">    </span><span class="mf">2.</span><span class="w"> </span><span class="n">Simplify</span><span class="p">:</span><span class="w"> </span><span class="n">While</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">degree</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">k</span><span class="p">:</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">Remove</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">graph</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">stack</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">It</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">always</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">colored</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">fewer</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">neighbors</span><span class="p">)</span>
<span class="w">    </span><span class="mf">3.</span><span class="w"> </span><span class="n">Spill</span><span class="p">:</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">exists</span><span class="p">:</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">Select</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">spill</span><span class="w"> </span><span class="p">(</span><span class="n">heuristic</span><span class="p">:</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">degree</span><span class="p">,</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">frequency</span><span class="p">)</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">Insert</span><span class="w"> </span><span class="nb">load</span><span class="o">/</span><span class="n">store</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">spilled</span><span class="w"> </span><span class="n">variable</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">Go</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="mf">4.</span><span class="w"> </span><span class="n">Select</span><span class="p">:</span><span class="w"> </span><span class="n">Pop</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">assign</span><span class="w"> </span><span class="n">colors</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">Each</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">fewer</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">colored</span><span class="w"> </span><span class="n">neighbors</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">available</span>
</code></pre></div>

<h4 id="_2">ì˜ˆì‹œ<a class="header-link" href="#_2" title="Permanent link">&para;</a></h4>
<p>4ê°œì˜ ê°€ìƒ ë ˆì§€ìŠ¤í„° $\{a, b, c, d\}$ì™€ ê°„ì„­ ê·¸ë˜í”„ë¥¼ ê³ ë ¤í•©ë‹ˆë‹¤:</p>
<div class="highlight"><pre><span></span><code>a --- b
|  X  |     (a-b, a-c, b-c, b-d interfere)
c --- d
   |
   b
</code></pre></div>

<p>ì •í™•íˆ í‘œí˜„í•˜ë©´:
- $a$ëŠ” $b$, $c$ì™€ ê°„ì„­
- $b$ëŠ” $a$, $c$, $d$ì™€ ê°„ì„­
- $c$ëŠ” $a$, $b$ì™€ ê°„ì„­
- $d$ëŠ” $b$ì™€ ê°„ì„­</p>
<p>$k = 3$ê°œ ë ˆì§€ìŠ¤í„°ì¼ ë•Œ:</p>
<div class="highlight"><pre><span></span><code><span class="nx">Step</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nx">Simplify</span><span class="p">):</span>
<span class="w">  </span><span class="nx">d</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">degree</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">push</span><span class="w"> </span><span class="nx">d</span><span class="p">,</span><span class="w"> </span><span class="nx">remove</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">graph</span>
<span class="w">  </span><span class="nx">a</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">degree</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">push</span><span class="w"> </span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">remove</span>
<span class="w">  </span><span class="nx">c</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">degree</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">push</span><span class="w"> </span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="nx">remove</span>
<span class="w">  </span><span class="nx">b</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">degree</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">push</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">remove</span>

<span class="nx">Stack</span><span class="w"> </span><span class="p">(</span><span class="nx">top</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">bottom</span><span class="p">):</span><span class="w"> </span><span class="p">[</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">d</span><span class="p">]</span>

<span class="nx">Step</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="nx">Select</span><span class="p">):</span>
<span class="w">  </span><span class="nx">Pop</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">assign</span><span class="w"> </span><span class="nx">R0</span><span class="w"> </span><span class="p">(</span><span class="nx">no</span><span class="w"> </span><span class="nx">neighbors</span><span class="w"> </span><span class="nx">colored</span><span class="w"> </span><span class="nx">yet</span><span class="p">)</span>
<span class="w">  </span><span class="nx">Pop</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">neighbors</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nx">b</span><span class="p">=</span><span class="nx">R0</span><span class="p">}</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">assign</span><span class="w"> </span><span class="nx">R1</span>
<span class="w">  </span><span class="nx">Pop</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">neighbors</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nx">b</span><span class="p">=</span><span class="nx">R0</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">=</span><span class="nx">R1</span><span class="p">}</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">assign</span><span class="w"> </span><span class="nx">R2</span>
<span class="w">  </span><span class="nx">Pop</span><span class="w"> </span><span class="nx">d</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">neighbors</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nx">b</span><span class="p">=</span><span class="nx">R0</span><span class="p">}</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">assign</span><span class="w"> </span><span class="nx">R1</span><span class="w"> </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="nx">R2</span><span class="p">)</span>

<span class="nx">Result</span><span class="p">:</span><span class="w"> </span><span class="nx">a</span><span class="p">=</span><span class="nx">R2</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">=</span><span class="nx">R0</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">=</span><span class="nx">R1</span><span class="p">,</span><span class="w"> </span><span class="nx">d</span><span class="p">=</span><span class="nx">R1</span>
</code></pre></div>

<h3 id="36-spilling">3.6 ìŠ¤í•„ë§(Spilling)<a class="header-link" href="#36-spilling" title="Permanent link">&para;</a></h3>
<p>ê·¸ë˜í”„ê°€ $k$-ìƒ‰ì¹  ë¶ˆê°€ëŠ¥í•œ ê²½ìš°($k$ë³´ë‹¤ ë‚®ì€ ì°¨ìˆ˜ë¥¼ ê°€ì§„ ë…¸ë“œê°€ ì—†ì„ ë•Œ), ë³€ìˆ˜ë¥¼ ë©”ëª¨ë¦¬ì— <strong>ìŠ¤í•„(spill)</strong>í•´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” ë‹¤ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤:</p>
<ol>
<li>ìŠ¤í•„ëœ ë³€ìˆ˜ì˜ ê° ì‚¬ìš© ì „ì— ë©”ëª¨ë¦¬ì—ì„œ <code>LOAD</code> ëª…ë ¹ì–´ ì‚½ì…</li>
<li>ê° ì •ì˜ í›„ì— ë©”ëª¨ë¦¬ì— <code>STORE</code> ëª…ë ¹ì–´ ì‚½ì…</li>
<li>ìŠ¤í•„ëœ ë³€ìˆ˜ëŠ” ë” ì´ìƒ ë ˆì§€ìŠ¤í„°ê°€ í•„ìš” ì—†ìŒ (ë˜ëŠ” ì ê¹ë§Œ í•„ìš”)</li>
<li>ê°„ì„­ ê·¸ë˜í”„ë¥¼ ë‹¤ì‹œ ë¹Œë“œí•˜ê³  ì¬ì‹œë„</li>
</ol>
<p><strong>ìŠ¤í•„ íœ´ë¦¬ìŠ¤í‹±(Spill heuristics)</strong>:
- ì°¨ìˆ˜ê°€ ê°€ì¥ ë†’ì€ ë³€ìˆ˜ ìŠ¤í•„ (ê°„ì„­ì´ ê°€ì¥ ë§ìŒ)
- ì‚¬ìš© ë¹ˆë„ê°€ ê°€ì¥ ë‚®ì€ ë³€ìˆ˜ ìŠ¤í•„ (ì‚¬ìš© íšŸìˆ˜ê°€ ìµœì†Œ)
- ì°¨ìˆ˜/ì‚¬ìš© ë¹„ìœ¨ì´ ê°€ì¥ ë†’ì€ ë³€ìˆ˜ ìŠ¤í•„
- ë£¨í”„ ë‚´ë¶€ì˜ ë³€ìˆ˜ëŠ” ìŠ¤í•„ ë°©ì§€</p>
<h3 id="37-linear-scan-register-allocation">3.7 ì„ í˜• ìŠ¤ìº” ë ˆì§€ìŠ¤í„° í• ë‹¹(Linear Scan Register Allocation)<a class="header-link" href="#37-linear-scan-register-allocation" title="Permanent link">&para;</a></h3>
<p>ê·¸ë˜í”„ ìƒ‰ì¹ ì€ íš¨ê³¼ì ì´ì§€ë§Œ ëŒ€í˜• í”„ë¡œê·¸ë¨ì—ëŠ” ë¹„ìš©ì´ í½ë‹ˆë‹¤. <strong>ì„ í˜• ìŠ¤ìº”(linear scan)</strong>ì€ JIT ì»´íŒŒì¼ëŸ¬(ì˜ˆ: HotSpot JVM, V8)ì—ì„œ ì‚¬ìš©ë˜ëŠ” ë” ë¹ ë¥¸ ëŒ€ì•ˆì…ë‹ˆë‹¤.</p>
<p><strong>ì•„ì´ë””ì–´</strong>: ë³€ìˆ˜ì˜ <strong>í™œì„± êµ¬ê°„(live interval)</strong> (ì²« ì •ì˜ë¶€í„° ë§ˆì§€ë§‰ ì‚¬ìš©ê¹Œì§€ì˜ ë²”ìœ„) ìˆœì„œëŒ€ë¡œ ë³€ìˆ˜ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤. ë ˆì§€ìŠ¤í„°ë¥¼ íƒìš•ì ìœ¼ë¡œ í• ë‹¹í•©ë‹ˆë‹¤:</p>
<div class="highlight"><pre><span></span><code><span class="n">Algorithm</span><span class="o">:</span><span class="w"> </span><span class="n">Linear</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="n">Register</span><span class="w"> </span><span class="n">Allocation</span>

<span class="n">Input</span><span class="o">:</span><span class="w">  </span><span class="n">Live</span><span class="w"> </span><span class="n">intervals</span><span class="w"> </span><span class="n">sorted</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">point</span>
<span class="w">        </span><span class="n">k</span><span class="w"> </span><span class="n">available</span><span class="w"> </span><span class="n">registers</span>

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[]</span><span class="w">  </span><span class="o">(</span><span class="n">intervals</span><span class="w"> </span><span class="n">currently</span><span class="w"> </span><span class="n">occupying</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">register</span><span class="o">)</span>
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="n">free_regs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="n">R0</span><span class="o">,</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="o">...,</span><span class="w"> </span><span class="n">R</span><span class="o">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="o">)}</span>

<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="n">interval</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">increasing</span><span class="w"> </span><span class="n">start</span><span class="o">:</span>
<span class="w">    </span><span class="n">a</span><span class="o">.</span><span class="w"> </span><span class="n">Expire</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="n">intervals</span><span class="o">:</span>
<span class="w">       </span><span class="k">for</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="o">(</span><span class="n">sorted</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">point</span><span class="o">):</span>
<span class="w">           </span><span class="k">if</span><span class="w"> </span><span class="n">j</span><span class="o">.</span><span class="na">end</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">i</span><span class="o">.</span><span class="na">start</span><span class="o">:</span>
<span class="w">               </span><span class="n">remove</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">active</span>
<span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="n">j</span><span class="o">.</span><span class="na">register</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">free_regs</span>

<span class="w">    </span><span class="n">b</span><span class="o">.</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">free_regs</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">empty</span><span class="o">:</span>
<span class="w">       </span><span class="n">Spill</span><span class="o">:</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">interval</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">latest</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">point</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">i</span><span class="o">.</span><span class="na">end</span><span class="o">:</span>
<span class="w">                  </span><span class="n">spill</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">interval</span><span class="o">,</span><span class="w"> </span><span class="n">give</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">i</span>
<span class="w">              </span><span class="k">else</span><span class="o">:</span>
<span class="w">                  </span><span class="n">spill</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">(</span><span class="n">assign</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">location</span><span class="o">)</span>

<span class="w">    </span><span class="n">c</span><span class="o">.</span><span class="w"> </span><span class="k">else</span><span class="o">:</span>
<span class="w">       </span><span class="n">Allocate</span><span class="o">:</span><span class="w"> </span><span class="n">assign</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">free_regs</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">i</span>
<span class="w">       </span><span class="n">add</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">active</span>
</code></pre></div>

<p><strong>ì‹œê°„ ë³µì¡ë„</strong>: $O(n \log n)$ ($n$ì€ êµ¬ê°„ ìˆ˜ì´ë©°, ì •ë ¬ì´ ì§€ë°°ì ).</p>
<p><strong>ë¹„êµ</strong>:</p>
<table>
<thead>
<tr>
<th>ì¸¡ë©´</th>
<th>ê·¸ë˜í”„ ìƒ‰ì¹ (Graph Coloring)</th>
<th>ì„ í˜• ìŠ¤ìº”(Linear Scan)</th>
</tr>
</thead>
<tbody>
<tr>
<td>í’ˆì§ˆ</td>
<td>ë” ì¢‹ìŒ (ì „ì—­ì  ê´€ì )</td>
<td>ì¢‹ìŒ (ìµœì ì´ ì•„ë‹˜)</td>
</tr>
<tr>
<td>ì»´íŒŒì¼ ì‹œê°„</td>
<td>$O(n^2)$ ì´ìƒ</td>
<td>$O(n \log n)$</td>
</tr>
<tr>
<td>ì‚¬ìš© ì‚¬ë¡€</td>
<td>ì‚¬ì „ ì»´íŒŒì¼ëŸ¬(AOT)</td>
<td>JIT ì»´íŒŒì¼ëŸ¬</td>
</tr>
<tr>
<td>í†µí•©(coalescing) ì²˜ë¦¬</td>
<td>ìì—°ìŠ¤ëŸ½ê²Œ</td>
<td>ì¶”ê°€ íŒ¨ìŠ¤ í•„ìš”</td>
</tr>
</tbody>
</table>
<h3 id="38-python-linear-scan">3.8 Python êµ¬í˜„: ì„ í˜• ìŠ¤ìº”(Linear Scan)<a class="header-link" href="#38-python-linear-scan" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Linear Scan Register Allocation.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LiveInterval</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A live interval for a virtual register.&quot;&quot;&quot;</span>
    <span class="n">vreg</span><span class="p">:</span> <span class="nb">str</span>      <span class="c1"># Virtual register name</span>
    <span class="n">start</span><span class="p">:</span> <span class="nb">int</span>     <span class="c1"># First definition point</span>
    <span class="n">end</span><span class="p">:</span> <span class="nb">int</span>       <span class="c1"># Last use point</span>
    <span class="n">preg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Assigned physical register (or &quot;spill&quot;)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">alloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preg</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preg</span> <span class="k">else</span> <span class="s2">&quot;unallocated&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">vreg</span><span class="si">}</span><span class="s2">: [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="si">}</span><span class="s2">] -&gt; </span><span class="si">{</span><span class="n">alloc</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LinearScanAllocator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Linear scan register allocator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_physical_regs</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">num_physical_regs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">physical_regs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;R</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_physical_regs</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_regs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">physical_regs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">LiveInterval</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Sorted by end point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spilled</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">LiveInterval</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intervals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">LiveInterval</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform linear scan allocation.</span>
<span class="sd">        Modifies interval.preg in place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sort by start point</span>
        <span class="n">intervals</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">iv</span><span class="p">:</span> <span class="n">iv</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
            <span class="c1"># Expire old intervals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expire_old</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_regs</span><span class="p">:</span>
                <span class="c1"># Must spill</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spill_at</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Allocate a register</span>
                <span class="n">reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_regs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">iv</span><span class="o">.</span><span class="n">preg</span> <span class="o">=</span> <span class="n">reg</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_expire_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current</span><span class="p">:</span> <span class="n">LiveInterval</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove intervals that have ended before the current one starts.&quot;&quot;&quot;</span>
        <span class="n">still_active</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">iv</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">current</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
                <span class="c1"># This interval has expired</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">free_regs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iv</span><span class="o">.</span><span class="n">preg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">still_active</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">still_active</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_spill_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current</span><span class="p">:</span> <span class="n">LiveInterval</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Spill either the current interval or the one ending latest.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">current</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
            <span class="c1"># Spill the active interval ending latest</span>
            <span class="n">spill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">current</span><span class="o">.</span><span class="n">preg</span> <span class="o">=</span> <span class="n">spill</span><span class="o">.</span><span class="n">preg</span>
            <span class="n">spill</span><span class="o">.</span><span class="n">preg</span> <span class="o">=</span> <span class="s2">&quot;SPILL&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spilled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spill</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Spill the current interval</span>
            <span class="n">current</span><span class="o">.</span><span class="n">preg</span> <span class="o">=</span> <span class="s2">&quot;SPILL&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spilled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">demo_linear_scan</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate linear scan register allocation.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Linear Scan Register Allocation ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">intervals</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">LiveInterval</span><span class="p">(</span><span class="s2">&quot;t1&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="n">end</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
        <span class="n">LiveInterval</span><span class="p">(</span><span class="s2">&quot;t2&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="n">end</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
        <span class="n">LiveInterval</span><span class="p">(</span><span class="s2">&quot;t3&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>  <span class="n">end</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
        <span class="n">LiveInterval</span><span class="p">(</span><span class="s2">&quot;t4&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>  <span class="n">end</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
        <span class="n">LiveInterval</span><span class="p">(</span><span class="s2">&quot;t5&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>  <span class="n">end</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
        <span class="n">LiveInterval</span><span class="p">(</span><span class="s2">&quot;t6&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">18</span><span class="p">),</span>
        <span class="n">LiveInterval</span><span class="p">(</span><span class="s2">&quot;t7&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Live intervals:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">iv</span><span class="o">.</span><span class="n">vreg</span><span class="si">}</span><span class="s2">: [</span><span class="si">{</span><span class="n">iv</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">iv</span><span class="o">.</span><span class="n">end</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

    <span class="c1"># Allocate with 3 physical registers</span>
    <span class="n">allocator</span> <span class="o">=</span> <span class="n">LinearScanAllocator</span><span class="p">(</span><span class="n">num_physical_regs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">allocator</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Allocation with </span><span class="si">{</span><span class="n">allocator</span><span class="o">.</span><span class="n">k</span><span class="si">}</span><span class="s2"> registers:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">iv</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">iv</span><span class="o">.</span><span class="n">preg</span> <span class="o">==</span> <span class="s2">&quot;SPILL&quot;</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">+=</span> <span class="s2">&quot; (SPILLED)&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">allocator</span><span class="o">.</span><span class="n">spilled</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Spilled variables: &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">vreg</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">allocator</span><span class="o">.</span><span class="n">spilled</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Visualize</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeline visualization:&quot;</span><span class="p">)</span>
    <span class="n">max_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">iv</span><span class="o">.</span><span class="n">end</span> <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Time: &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iv</span><span class="o">.</span><span class="n">vreg</span><span class="si">:</span><span class="s2">4s</span><span class="si">}</span><span class="s2">: &quot;</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">iv</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">iv</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iv</span><span class="o">.</span><span class="n">preg</span> <span class="o">==</span> <span class="s2">&quot;SPILL&quot;</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot; S&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">iv</span><span class="o">.</span><span class="n">preg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># Just the number</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot; .&quot;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  (</span><span class="si">{</span><span class="n">iv</span><span class="o">.</span><span class="n">preg</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">demo_linear_scan</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="4-instruction-scheduling">4. ëª…ë ¹ì–´ ìŠ¤ì¼€ì¤„ë§(Instruction Scheduling)<a class="header-link" href="#4-instruction-scheduling" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 ë¬¸ì œ ì •ì˜<a class="header-link" href="#41" title="Permanent link">&para;</a></h3>
<p>í˜„ëŒ€ í”„ë¡œì„¸ì„œëŠ” <strong>íŒŒì´í”„ë¼ì¸(pipelined)</strong> êµ¬ì¡°ì…ë‹ˆë‹¤: ëª…ë ¹ì–´ ì‹¤í–‰ì˜ ì„œë¡œ ë‹¤ë¥¸ ë‹¨ê³„ê°€ ê²¹ì³ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ëª…ë ¹ì–´ê°€ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì€ ì´ì „ ëª…ë ¹ì–´ì˜ ê²°ê³¼ì— ì˜ì¡´í•  ë•Œ <strong>ë°ì´í„° í•´ì €ë“œ(data hazard)</strong>ê°€ ë°œìƒí•˜ì—¬ <strong>íŒŒì´í”„ë¼ì¸ ìŠ¤í†¨(pipeline stall)</strong>ì„ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<p><strong>ìŠ¤í†¨ ì˜ˆì‹œ</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="k">LOAD</span><span class="w"> </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">R2</span><span class="o">]</span><span class="w">     </span><span class="p">;</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">cycles</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">complete</span>
<span class="k">ADD</span><span class="w">  </span><span class="n">R3</span><span class="p">,</span><span class="w"> </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="n">R4</span><span class="w">   </span><span class="p">;</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">R1</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">pipeline</span><span class="w"> </span><span class="n">stall</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">wasted</span><span class="w"> </span><span class="n">cycles</span><span class="p">)</span>
</code></pre></div>

<p><strong>ìŠ¤ì¼€ì¤„ë§ í›„</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="k">LOAD</span><span class="w"> </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">R2</span><span class="o">]</span><span class="w">     </span><span class="p">;</span><span class="w"> </span><span class="n">issue</span><span class="w"> </span><span class="k">load</span>
<span class="k">ADD</span><span class="w">  </span><span class="n">R5</span><span class="p">,</span><span class="w"> </span><span class="n">R6</span><span class="p">,</span><span class="w"> </span><span class="n">R7</span><span class="w">   </span><span class="p">;</span><span class="w"> </span><span class="n">independent</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">fills</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">gap</span>
<span class="n">SUB</span><span class="w">  </span><span class="n">R8</span><span class="p">,</span><span class="w"> </span><span class="n">R9</span><span class="p">,</span><span class="w"> </span><span class="n">R10</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">another</span><span class="w"> </span><span class="n">independent</span><span class="w"> </span><span class="n">instruction</span>
<span class="n">MOV</span><span class="w">  </span><span class="n">R11</span><span class="p">,</span><span class="w"> </span><span class="n">R12</span><span class="w">     </span><span class="p">;</span><span class="w"> </span><span class="n">yet</span><span class="w"> </span><span class="n">another</span>
<span class="k">ADD</span><span class="w">  </span><span class="n">R3</span><span class="p">,</span><span class="w"> </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="n">R4</span><span class="w">   </span><span class="p">;</span><span class="w"> </span><span class="n">R1</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">ready</span><span class="p">,</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">stall</span>
</code></pre></div>

<h3 id="42-list-scheduling">4.2 ë¦¬ìŠ¤íŠ¸ ìŠ¤ì¼€ì¤„ë§(List Scheduling)<a class="header-link" href="#42-list-scheduling" title="Permanent link">&para;</a></h3>
<p><strong>ë¦¬ìŠ¤íŠ¸ ìŠ¤ì¼€ì¤„ë§(list scheduling)</strong>ì€ ê°€ì¥ ì¼ë°˜ì ì¸ ëª…ë ¹ì–´ ìŠ¤ì¼€ì¤„ë§ ì•Œê³ ë¦¬ì¦˜ì…ë‹ˆë‹¤. ë‹¨ì¼ ê¸°ë³¸ ë¸”ë¡(basic block)ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.</p>
<p><strong>ì…ë ¥</strong>: <strong>ì˜ì¡´ì„± DAG(dependency DAG)</strong>:
- ë…¸ë“œëŠ” ëª…ë ¹ì–´
- ê°„ì„ ì€ ë°ì´í„° ì˜ì¡´ì„± í‘œí˜„ (ì½ê¸° í›„ ì“°ê¸°, ì“°ê¸° í›„ ì½ê¸°, ì“°ê¸° í›„ ì“°ê¸°)
- ê°„ì„  ê°€ì¤‘ì¹˜ëŠ” ì†ŒìŠ¤ ëª…ë ¹ì–´ì˜ ì§€ì—° ì‹œê°„(latency)</p>
<p><strong>ì•Œê³ ë¦¬ì¦˜</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="k">function</span><span class="w"> </span><span class="nf">list_schedule</span><span class="p">(</span>DAG, num_functional_units<span class="p">):</span>
<span class="w">    </span><span class="n">ready</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="nb">predecessors</span>
<span class="w">    </span><span class="n">schedule</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="n">cycle</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="nb">empty</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">pending</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="nb">exist</span><span class="p">:</span>
<span class="w">        </span>#<span class="w"> </span><span class="n">Select</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="p">(</span><span class="n">priority</span><span class="o">-</span><span class="n">based</span><span class="p">)</span>
<span class="w">        </span><span class="n">available</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="n">whose</span><span class="w"> </span><span class="n">operands</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">available</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">functional</span><span class="w"> </span><span class="n">unit</span><span class="p">:</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">available</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="nb">empty</span><span class="p">:</span>
<span class="w">                </span><span class="n">instr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">highest</span><span class="o">-</span><span class="n">priority</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">available</span>
<span class="w">                </span><span class="n">issue</span><span class="w"> </span><span class="n">instr</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">cycle</span>
<span class="w">                </span><span class="n">schedule</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">instr</span>
<span class="w">                </span><span class="nb">remove</span><span class="w"> </span><span class="n">instr</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">ready</span>

<span class="w">        </span><span class="n">cycle</span><span class="w"> </span><span class="o">+</span><span class="p">=</span><span class="w"> </span><span class="mi">1</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="w"> </span><span class="n">pending</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">completed</span>
<span class="w">        </span>#<span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">their</span><span class="w"> </span><span class="nb">successors</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">all</span><span class="w"> </span><span class="nb">predecessors</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">done</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">schedule</span>
</code></pre></div>

<p><strong>ìš°ì„ ìˆœìœ„ íœ´ë¦¬ìŠ¤í‹±</strong> (ì–´ë–¤ ëª…ë ¹ì–´ë¥¼ ë¨¼ì € ìŠ¤ì¼€ì¤„í• ì§€):
- <strong>ì„ê³„ ê²½ë¡œ ê¸¸ì´(Critical path length)</strong>: ì„ì˜ì˜ ì‹±í¬ê¹Œì§€ì˜ ê°€ì¥ ê¸´ ê²½ë¡œì— ìˆëŠ” ëª…ë ¹ì–´ ì„ í˜¸
- <strong>í›„ê³„ì ìˆ˜(Number of successors)</strong>: ì˜ì¡´í•˜ëŠ” í›„ê³„ìê°€ ë§ì€ ëª…ë ¹ì–´ ì„ í˜¸
- <strong>ì§€ì—° ì‹œê°„(Latency)</strong>: ì§€ì—° ì‹œê°„ì´ ë†’ì€ ëª…ë ¹ì–´ ì„ í˜¸ (ë” ì¼ì° ì‹œì‘)</p>
<h3 id="43">4.3 ì˜ˆì‹œ: ë¦¬ìŠ¤íŠ¸ ìŠ¤ì¼€ì¤„ë§<a class="header-link" href="#43" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nl">Instructions</span><span class="p">:</span>
<span class="w">  </span><span class="nl">I1</span><span class="p">:</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">addr1</span><span class="o">]</span><span class="w">   </span><span class="p">;</span><span class="w"> </span><span class="n">latency</span><span class="w"> </span><span class="mi">4</span>
<span class="w">  </span><span class="nl">I2</span><span class="p">:</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="n">R2</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">addr2</span><span class="o">]</span><span class="w">   </span><span class="p">;</span><span class="w"> </span><span class="n">latency</span><span class="w"> </span><span class="mi">4</span>
<span class="w">  </span><span class="nl">I3</span><span class="p">:</span><span class="w"> </span><span class="k">ADD</span><span class="w">  </span><span class="n">R3</span><span class="p">,</span><span class="w"> </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="n">R2</span><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="n">latency</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">I1</span><span class="p">,</span><span class="w"> </span><span class="n">I2</span>
<span class="w">  </span><span class="nl">I4</span><span class="p">:</span><span class="w"> </span><span class="n">MUL</span><span class="w">  </span><span class="n">R4</span><span class="p">,</span><span class="w"> </span><span class="n">R3</span><span class="p">,</span><span class="w"> </span><span class="n">R1</span><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="n">latency</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">I3</span><span class="p">,</span><span class="w"> </span><span class="n">I1</span>
<span class="w">  </span><span class="nl">I5</span><span class="p">:</span><span class="w"> </span><span class="n">STORE</span><span class="w"> </span><span class="n">R4</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">addr3</span><span class="o">]</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">latency</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">I4</span>

<span class="n">Dependency</span><span class="w"> </span><span class="nl">DAG</span><span class="p">:</span>
<span class="w">  </span><span class="n">I1</span><span class="w"> </span><span class="err">â”€â”€</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">I3</span>
<span class="w">  </span><span class="n">I2</span><span class="w"> </span><span class="err">â”€â”€</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">I3</span>
<span class="w">  </span><span class="n">I3</span><span class="w"> </span><span class="err">â”€â”€</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">I4</span>
<span class="w">  </span><span class="n">I1</span><span class="w"> </span><span class="err">â”€â”€</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">I4</span>
<span class="w">  </span><span class="n">I4</span><span class="w"> </span><span class="err">â”€â”€</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="n">I5</span>

<span class="n">Unscheduled</span><span class="w"> </span><span class="p">(</span><span class="ow">all</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="n">sequentially</span><span class="p">)</span><span class="err">:</span>
<span class="w">  </span><span class="k">Cycle</span><span class="w"> </span><span class="mi">0</span><span class="err">:</span><span class="w"> </span><span class="n">I1</span><span class="w"> </span><span class="p">(</span><span class="k">LOAD</span><span class="p">)</span>
<span class="w">  </span><span class="k">Cycle</span><span class="w"> </span><span class="mi">1</span><span class="o">-</span><span class="mi">3</span><span class="err">:</span><span class="w"> </span><span class="n">stall</span><span class="w"> </span><span class="p">(</span><span class="n">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">I1</span><span class="p">)</span>
<span class="w">  </span><span class="k">Cycle</span><span class="w"> </span><span class="mi">4</span><span class="err">:</span><span class="w"> </span><span class="n">I2</span><span class="w"> </span><span class="p">(</span><span class="k">LOAD</span><span class="p">)</span>
<span class="w">  </span><span class="k">Cycle</span><span class="w"> </span><span class="mi">5</span><span class="o">-</span><span class="mi">7</span><span class="err">:</span><span class="w"> </span><span class="n">stall</span><span class="w"> </span><span class="p">(</span><span class="n">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">I2</span><span class="p">)</span>
<span class="w">  </span><span class="k">Cycle</span><span class="w"> </span><span class="mi">8</span><span class="err">:</span><span class="w"> </span><span class="n">I3</span><span class="w"> </span><span class="p">(</span><span class="k">ADD</span><span class="p">)</span>
<span class="w">  </span><span class="k">Cycle</span><span class="w"> </span><span class="mi">9</span><span class="err">:</span><span class="w"> </span><span class="n">I4</span><span class="w"> </span><span class="p">(</span><span class="n">MUL</span><span class="p">)</span>
<span class="w">  </span><span class="k">Cycle</span><span class="w"> </span><span class="mi">10</span><span class="o">-</span><span class="mi">11</span><span class="err">:</span><span class="w"> </span><span class="n">stall</span>
<span class="w">  </span><span class="k">Cycle</span><span class="w"> </span><span class="mi">12</span><span class="err">:</span><span class="w"> </span><span class="n">I5</span><span class="w"> </span><span class="p">(</span><span class="n">STORE</span><span class="p">)</span>
<span class="w">  </span><span class="nl">Total</span><span class="p">:</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="n">cycles</span>

<span class="n">Scheduled</span><span class="w"> </span><span class="p">(</span><span class="n">list</span><span class="w"> </span><span class="n">scheduling</span><span class="p">)</span><span class="err">:</span>
<span class="w">  </span><span class="k">Cycle</span><span class="w"> </span><span class="mi">0</span><span class="err">:</span><span class="w"> </span><span class="n">I1</span><span class="w"> </span><span class="p">(</span><span class="k">LOAD</span><span class="w"> </span><span class="n">R1</span><span class="p">)</span>
<span class="w">  </span><span class="k">Cycle</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">I2</span><span class="w"> </span><span class="p">(</span><span class="k">LOAD</span><span class="w"> </span><span class="n">R2</span><span class="p">)</span><span class="w">    </span><span class="err">â†</span><span class="w"> </span><span class="n">issued</span><span class="w"> </span><span class="n">during</span><span class="w"> </span><span class="n">I1</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">latency</span>
<span class="w">  </span><span class="k">Cycle</span><span class="w"> </span><span class="mi">4</span><span class="err">:</span><span class="w"> </span><span class="n">I3</span><span class="w"> </span><span class="p">(</span><span class="k">ADD</span><span class="w"> </span><span class="n">R3</span><span class="p">)</span><span class="w">     </span><span class="err">â†</span><span class="w"> </span><span class="k">both</span><span class="w"> </span><span class="n">I1</span><span class="p">,</span><span class="w"> </span><span class="n">I2</span><span class="w"> </span><span class="n">ready</span>
<span class="w">  </span><span class="k">Cycle</span><span class="w"> </span><span class="mi">5</span><span class="err">:</span><span class="w"> </span><span class="n">I4</span><span class="w"> </span><span class="p">(</span><span class="n">MUL</span><span class="w"> </span><span class="n">R4</span><span class="p">)</span><span class="w">     </span><span class="err">â†</span><span class="w"> </span><span class="n">I3</span><span class="w"> </span><span class="n">ready</span>
<span class="w">  </span><span class="k">Cycle</span><span class="w"> </span><span class="mi">8</span><span class="err">:</span><span class="w"> </span><span class="n">I5</span><span class="w"> </span><span class="p">(</span><span class="n">STORE</span><span class="w"> </span><span class="n">R4</span><span class="p">)</span><span class="w">   </span><span class="err">â†</span><span class="w"> </span><span class="n">I4</span><span class="w"> </span><span class="n">ready</span>
<span class="w">  </span><span class="nl">Total</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">cycles</span><span class="w"> </span><span class="p">(</span><span class="n">saved</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">cycles</span><span class="p">)</span>
</code></pre></div>

<h3 id="44-software-pipelining">4.4 ì†Œí”„íŠ¸ì›¨ì–´ íŒŒì´í”„ë¼ì´ë‹(Software Pipelining) ê°œìš”<a class="header-link" href="#44-software-pipelining" title="Permanent link">&para;</a></h3>
<p><strong>ì†Œí”„íŠ¸ì›¨ì–´ íŒŒì´í”„ë¼ì´ë‹(software pipelining)</strong>ì€ í•˜ë“œì›¨ì–´ íŒŒì´í”„ë¼ì´ë‹ì´ ëª…ë ¹ì–´ ë‹¨ê³„ë¥¼ ê²¹ì¹˜ëŠ” ê²ƒì²˜ëŸ¼ ë£¨í”„ì˜ ë°˜ë³µì„ ê²¹ì¹˜ëŠ” ë£¨í”„ ìµœì í™” ê¸°ë²•ì…ë‹ˆë‹¤.</p>
<p><strong>ì•„ì´ë””ì–´</strong>: ë°˜ë³µ $i$ê°€ ì™„ë£Œë˜ê¸° ì „ì— ë°˜ë³µ $i+1$ì„ ì‹œì‘í•©ë‹ˆë‹¤:</p>
<div class="highlight"><pre><span></span><code>Without software pipelining:     With software pipelining:
  Iter 1: LOAD-ADD-STORE         Cycle 0: LOAD[1]
  Iter 2: LOAD-ADD-STORE         Cycle 1: LOAD[2], ADD[1]
  Iter 3: LOAD-ADD-STORE         Cycle 2: LOAD[3], ADD[2], STORE[1]
                                  Cycle 3: LOAD[4], ADD[3], STORE[2]
                                  ...
</code></pre></div>

<p>ì†Œí”„íŠ¸ì›¨ì–´ íŒŒì´í”„ë¼ì¸ì˜ ì •ìƒ ìƒíƒœ(steady-state)ëŠ” ì—¬ëŸ¬ ë°˜ë³µì˜ ì¼ë¶€ë¥¼ ë™ì‹œì— ì‹¤í–‰í•˜ì—¬ ëª¨ë“  ê¸°ëŠ¥ ìœ ë‹›ì„ ë°”ì˜ê²Œ ìœ ì§€í•©ë‹ˆë‹¤.</p>
<p>ì†Œí”„íŠ¸ì›¨ì–´ íŒŒì´í”„ë¼ì´ë‹ì€ ì£¼ë¡œ <strong>ëª¨ë“ˆë¡œ ìŠ¤ì¼€ì¤„ë§(modulo scheduling)</strong>ìœ¼ë¡œ êµ¬í˜„ë˜ë©°, ê³ ì •ëœ <strong>ì‹œì‘ ê°„ê²©(initiation interval, II)</strong>ìœ¼ë¡œ ë°˜ë³µí•  ë•Œ ìœ íš¨í•œ ê²¹ì¹¨ ìŠ¤ì¼€ì¤„ì´ ìƒì„±ë˜ëŠ” í•˜ë‚˜ì˜ ë°˜ë³µì— ëŒ€í•œ ìŠ¤ì¼€ì¤„ì„ ì°¾ìŠµë‹ˆë‹¤.</p>
<hr />
<h2 id="5-peephole-optimization">5. í•í™€ ìµœì í™”(Peephole Optimization)<a class="header-link" href="#5-peephole-optimization" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 í•í™€ ìµœì í™”ë€?<a class="header-link" href="#51" title="Permanent link">&para;</a></h3>
<p><strong>í•í™€ ìµœì í™”(peephole optimization)</strong>ëŠ” ì—°ì†ëœ ëª…ë ¹ì–´ë“¤ì˜ ì‘ì€ ìœˆë„ìš°("í•í™€")ë¥¼ ê²€ì‚¬í•˜ê³  ë” ë¹ ë¥´ê±°ë‚˜ ë” ì§§ì€ ë™ë“±í•œ ëª…ë ¹ì–´ë¡œ êµì²´í•©ë‹ˆë‹¤. ì½”ë“œ ìƒì„± í›„ ìµœì¢… ì •ë¦¬ íŒ¨ìŠ¤ë¡œ ì ìš©ë©ë‹ˆë‹¤.</p>
<h3 id="52">5.2 ì¼ë°˜ì ì¸ í•í™€ ìµœì í™”<a class="header-link" href="#52" title="Permanent link">&para;</a></h3>
<h4 id="redundant-loadstore-elimination">ì¤‘ë³µ ë¡œë“œ/ìŠ¤í† ì–´ ì œê±°(Redundant Load/Store Elimination)<a class="header-link" href="#redundant-loadstore-elimination" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">Before</span><span class="err">:</span><span class="w">                  </span><span class="k">After</span><span class="err">:</span>
<span class="w">  </span><span class="n">STORE</span><span class="w"> </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">addr</span><span class="o">]</span><span class="w">       </span><span class="n">STORE</span><span class="w"> </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">addr</span><span class="o">]</span>
<span class="w">  </span><span class="k">LOAD</span><span class="w">  </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">addr</span><span class="o">]</span><span class="w">       </span><span class="p">(</span><span class="k">load</span><span class="w"> </span><span class="n">eliminated</span><span class="w"> </span><span class="c1">-- R1 already has the value)</span>
</code></pre></div>

<h4 id="redundant-moves">ì¤‘ë³µ ì´ë™ ì œê±°(Redundant Moves)<a class="header-link" href="#redundant-moves" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">Before</span><span class="o">:</span><span class="w">                  </span><span class="n">After</span><span class="o">:</span>
<span class="w">  </span><span class="n">MOV</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="n">R2</span><span class="w">             </span><span class="o">(</span><span class="n">eliminated</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">R1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">R2</span><span class="o">,</span><span class="w"> </span><span class="n">or</span>
<span class="w">  </span><span class="n">MOV</span><span class="w"> </span><span class="n">R2</span><span class="o">,</span><span class="w"> </span><span class="n">R1</span><span class="w">              </span><span class="n">second</span><span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="n">eliminated</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">sufficient</span><span class="o">)</span>
</code></pre></div>

<h4 id="strength-reduction">ê°•ë„ ê°ì†Œ(Strength Reduction)<a class="header-link" href="#strength-reduction" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">Before</span><span class="o">:</span><span class="w">                  </span><span class="n">After</span><span class="o">:</span>
<span class="w">  </span><span class="n">MUL</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="n">R2</span><span class="o">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span><span class="w">         </span><span class="n">SHL</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="n">R2</span><span class="o">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="w">    </span><span class="o">(</span><span class="n">shift</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">cheaper</span><span class="o">)</span>
<span class="w">  </span><span class="n">MUL</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="n">R2</span><span class="o">,</span><span class="w"> </span><span class="err">#</span><span class="mi">8</span><span class="w">         </span><span class="n">SHL</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="n">R2</span><span class="o">,</span><span class="w"> </span><span class="err">#</span><span class="mi">3</span>
<span class="w">  </span><span class="n">DIV</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="n">R2</span><span class="o">,</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span><span class="w">         </span><span class="n">SHR</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="n">R2</span><span class="o">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span><span class="w">    </span><span class="o">(</span><span class="k">for</span><span class="w"> </span><span class="n">unsigned</span><span class="o">)</span>
</code></pre></div>

<h4 id="algebraic-simplification">ëŒ€ìˆ˜ì  ë‹¨ìˆœí™”(Algebraic Simplification)<a class="header-link" href="#algebraic-simplification" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">Before</span><span class="o">:</span><span class="w">                  </span><span class="n">After</span><span class="o">:</span>
<span class="w">  </span><span class="n">ADD</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="n">R2</span><span class="o">,</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span><span class="w">         </span><span class="n">MOV</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="n">R2</span><span class="w">         </span><span class="o">(</span><span class="n">or</span><span class="w"> </span><span class="n">eliminated</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">R1</span><span class="o">==</span><span class="n">R2</span><span class="o">)</span>
<span class="w">  </span><span class="n">MUL</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="n">R2</span><span class="o">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="w">         </span><span class="n">MOV</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="n">R2</span>
<span class="w">  </span><span class="n">MUL</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="n">R2</span><span class="o">,</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span><span class="w">         </span><span class="n">MOVI</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span>
<span class="w">  </span><span class="n">SUB</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="n">R2</span><span class="o">,</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span><span class="w">         </span><span class="n">MOV</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="n">R2</span>
</code></pre></div>

<h4 id="branch-optimization">ë¶„ê¸° ìµœì í™”(Branch Optimization)<a class="header-link" href="#branch-optimization" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">Before</span><span class="o">:</span><span class="w">                  </span><span class="n">After</span><span class="o">:</span>
<span class="w">  </span><span class="n">JMP</span><span class="w"> </span><span class="n">L1</span><span class="w">                 </span><span class="n">JMP</span><span class="w"> </span><span class="n">L2</span><span class="w">             </span><span class="o">(</span><span class="n">jump</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">jump</span><span class="w"> </span><span class="n">elimination</span><span class="o">)</span>
<span class="w">  </span><span class="o">...</span>
<span class="n">L1</span><span class="o">:</span><span class="w"> </span><span class="n">JMP</span><span class="w"> </span><span class="n">L2</span>

<span class="n">Before</span><span class="o">:</span><span class="w">                  </span><span class="n">After</span><span class="o">:</span>
<span class="w">  </span><span class="n">BEQ</span><span class="w"> </span><span class="n">L1</span><span class="w">                 </span><span class="n">BNE</span><span class="w"> </span><span class="n">L2</span><span class="w">             </span><span class="o">(</span><span class="n">branch</span><span class="o">-</span><span class="n">over</span><span class="o">-</span><span class="n">jump</span><span class="w"> </span><span class="n">elimination</span><span class="o">)</span>
<span class="w">  </span><span class="n">JMP</span><span class="w"> </span><span class="n">L2</span><span class="w">                 </span><span class="o">...</span>
<span class="n">L1</span><span class="o">:</span><span class="w"> </span><span class="o">...</span><span class="w">                  </span><span class="n">L2</span><span class="o">:</span><span class="w"> </span><span class="o">...</span>
</code></pre></div>

<h4 id="unreachable-code-elimination">ë„ë‹¬ ë¶ˆê°€ ì½”ë“œ ì œê±°(Unreachable Code Elimination)<a class="header-link" href="#unreachable-code-elimination" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">Before</span><span class="o">:</span><span class="w">                  </span><span class="n">After</span><span class="o">:</span>
<span class="w">  </span><span class="n">JMP</span><span class="w"> </span><span class="n">L1</span><span class="w">                 </span><span class="n">JMP</span><span class="w"> </span><span class="n">L1</span>
<span class="w">  </span><span class="n">ADD</span><span class="w"> </span><span class="n">R1</span><span class="o">,</span><span class="w"> </span><span class="n">R2</span><span class="o">,</span><span class="w"> </span><span class="n">R3</span><span class="w">         </span><span class="o">(</span><span class="n">unreachable</span><span class="o">,</span><span class="w"> </span><span class="n">eliminated</span><span class="o">)</span>
<span class="w">  </span><span class="n">MOV</span><span class="w"> </span><span class="n">R4</span><span class="o">,</span><span class="w"> </span><span class="n">R5</span><span class="w">             </span><span class="o">(</span><span class="n">unreachable</span><span class="o">,</span><span class="w"> </span><span class="n">eliminated</span><span class="o">)</span>
<span class="n">L1</span><span class="o">:</span><span class="w"> </span><span class="o">...</span><span class="w">                  </span><span class="n">L1</span><span class="o">:</span><span class="w"> </span><span class="o">...</span>
</code></pre></div>

<h3 id="53-python-peephole-optimizer">5.3 Python êµ¬í˜„: í•í™€ ìµœì í™”ê¸°(Peephole Optimizer)<a class="header-link" href="#53-python-peephole-optimizer" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Peephole optimizer for a simple instruction set.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Instruction</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A machine instruction for peephole optimization.&quot;&quot;&quot;</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span>       <span class="c1"># Full instruction text</span>
    <span class="n">opcode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">operands</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># If this is a label</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="s2">&quot;LABEL&quot;</span>
            <span class="k">return</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">operands</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">:&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span>


<span class="k">class</span><span class="w"> </span><span class="nc">PeepholeOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply peephole optimizations to a list of instructions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span> <span class="o">=</span> <span class="p">[</span><span class="n">Instruction</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">instr</span><span class="p">)</span> <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Track if any optimization was applied</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_passes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run peephole optimizations until no more changes occur.&quot;&quot;&quot;</span>
        <span class="n">pass_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="ow">and</span> <span class="n">pass_num</span> <span class="o">&lt;</span> <span class="n">max_passes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">pass_num</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_redundant_moves</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_redundant_load_after_store</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strength_reduction</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_algebraic_simplification</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_jump_to_jump</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unreachable_code</span><span class="p">()</span>
            <span class="c1"># Remove None entries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_redundant_moves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove MOV Rx, Rx (move to self).&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">instr</span> <span class="ow">and</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="s2">&quot;MOV&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_redundant_load_after_store</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove LOAD Rx, [addr] immediately after STORE Rx, [addr].&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">nxt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">curr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nxt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">curr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="s2">&quot;STORE&quot;</span> <span class="ow">and</span> <span class="n">nxt</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="s2">&quot;LOAD&quot;</span><span class="p">:</span>
                <span class="c1"># Check if same register and same address</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">nxt</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
                    <span class="ow">and</span> <span class="n">curr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nxt</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">curr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">nxt</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_strength_reduction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replace MUL/DIV by power of 2 with shifts.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">instr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="s2">&quot;MUL&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">imm</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">imm</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">imm</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">shift</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">new_text</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SHL </span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, #</span><span class="si">{</span><span class="n">shift</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Instruction</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">new_text</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="s2">&quot;DIV&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">imm</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">imm</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">imm</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">shift</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">new_text</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SHR </span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, #</span><span class="si">{</span><span class="n">shift</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Instruction</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">new_text</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_algebraic_simplification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simplify ADD x, y, #0 â†’ MOV x, y, etc.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">instr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="s2">&quot;ADD&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#0&quot;</span><span class="p">:</span>
                    <span class="n">new_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;  MOV </span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Instruction</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">new_text</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="s2">&quot;MUL&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#1&quot;</span><span class="p">:</span>
                    <span class="n">new_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;  MOV </span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Instruction</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">new_text</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#0&quot;</span><span class="p">:</span>
                    <span class="n">new_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;  MOVI </span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, #0&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Instruction</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">new_text</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="s2">&quot;SUB&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#0&quot;</span><span class="p">:</span>
                    <span class="n">new_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;  MOV </span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Instruction</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">new_text</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_jump_to_jump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replace JMP L1 where L1: JMP L2 with JMP L2.&quot;&quot;&quot;</span>
        <span class="c1"># Build label -&gt; index map</span>
        <span class="n">label_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">instr</span> <span class="ow">and</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="s2">&quot;LABEL&quot;</span><span class="p">:</span>
                <span class="n">label_map</span><span class="p">[</span><span class="n">instr</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">instr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="s2">&quot;JMP&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">label_map</span><span class="p">:</span>
                    <span class="n">target_idx</span> <span class="o">=</span> <span class="n">label_map</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
                    <span class="c1"># Find the next non-label instruction after the target</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">target_idx</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">)</span>
                           <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                           <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="s2">&quot;LABEL&quot;</span><span class="p">):</span>
                        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="s2">&quot;JMP&quot;</span><span class="p">):</span>
                        <span class="n">new_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">new_target</span> <span class="o">!=</span> <span class="n">target</span><span class="p">:</span>
                            <span class="n">new_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;  JMP </span><span class="si">{</span><span class="n">new_target</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Instruction</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">new_text</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_unreachable_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove instructions between an unconditional jump and the next label.&quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">):</span>
            <span class="n">instr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">instr</span> <span class="ow">and</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;JMP&quot;</span><span class="p">,</span> <span class="s2">&quot;RET&quot;</span><span class="p">):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">)</span>
                       <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                       <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">opcode</span> <span class="o">!=</span> <span class="s2">&quot;LABEL&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="k">def</span><span class="w"> </span><span class="nf">demo_peephole</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate peephole optimization.&quot;&quot;&quot;</span>
    <span class="n">instructions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;  MOVI R1, #5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  MOVI R2, #10&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  ADD  R3, R1, R2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  MOV  R3, R3&quot;</span><span class="p">,</span>           <span class="c1"># Redundant self-move</span>
        <span class="s2">&quot;  MUL  R4, R3, #8&quot;</span><span class="p">,</span>       <span class="c1"># Strength reduction: * 8 â†’ &lt;&lt; 3</span>
        <span class="s2">&quot;  ADD  R5, R4, #0&quot;</span><span class="p">,</span>       <span class="c1"># Algebraic: + 0 â†’ move</span>
        <span class="s2">&quot;  STORE R5, [R6]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  LOAD  R5, [R6]&quot;</span><span class="p">,</span>        <span class="c1"># Redundant load after store</span>
        <span class="s2">&quot;  MUL  R7, R5, #1&quot;</span><span class="p">,</span>       <span class="c1"># Algebraic: * 1 â†’ move</span>
        <span class="s2">&quot;  MUL  R8, R5, #0&quot;</span><span class="p">,</span>       <span class="c1"># Algebraic: * 0 â†’ 0</span>
        <span class="s2">&quot;  DIV  R9, R3, #4&quot;</span><span class="p">,</span>       <span class="c1"># Strength reduction: / 4 â†’ &gt;&gt; 2</span>
        <span class="s2">&quot;  JMP  L1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  ADD  R10, R1, R2&quot;</span><span class="p">,</span>      <span class="c1"># Unreachable code</span>
        <span class="s2">&quot;  SUB  R11, R3, R4&quot;</span><span class="p">,</span>      <span class="c1"># Unreachable code</span>
        <span class="s2">&quot;L1:&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  JMP  L2&quot;</span><span class="p">,</span>               <span class="c1"># Jump-to-jump target</span>
        <span class="s2">&quot;L2:&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  SUB  R12, R1, #0&quot;</span><span class="p">,</span>      <span class="c1"># Algebraic: - 0 â†’ move</span>
        <span class="s2">&quot;  RET&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Before Peephole Optimization ===&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">PeepholeOptimizer</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
    <span class="n">optimized</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== After Peephole Optimization ===&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">optimized</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">demo_peephole</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="6-code-generation-for-language-constructs">6. ì–¸ì–´ êµ¬ì„±ìš”ì†Œë¥¼ ìœ„í•œ ì½”ë“œ ìƒì„±(Code Generation for Language Constructs)<a class="header-link" href="#6-code-generation-for-language-constructs" title="Permanent link">&para;</a></h2>
<h3 id="61-expressions">6.1 ì‹(Expressions)<a class="header-link" href="#61-expressions" title="Permanent link">&para;</a></h3>
<p>ì‚°ìˆ  ì‹ì— ëŒ€í•œ ì½”ë“œ ìƒì„±ì€ ì‹ íŠ¸ë¦¬ì˜ êµ¬ì¡°ë¥¼ ë”°ë¦…ë‹ˆë‹¤. ì´í•­ ì—°ì‚° $a \;\text{op}\; b$ì˜ ê²½ìš°:</p>
<div class="highlight"><pre><span></span><code>generate(a)         â†’ result in R1
generate(b)         â†’ result in R2
 OP R3, R1, R2       â†’ R3 = R1 op R2
</code></pre></div>

<p>ê¹Šê²Œ ì¤‘ì²©ëœ ì‹ì˜ ê²½ìš° ë ˆì§€ìŠ¤í„°ë¥¼ ì‹ ì¤‘í•˜ê²Œ ê´€ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤. <strong>Sethi-Ullman ë²ˆí˜¸ ë§¤ê¸°ê¸°(Sethi-Ullman numbering)</strong> ì•Œê³ ë¦¬ì¦˜ì€ ì‹ íŠ¸ë¦¬ë¥¼ í‰ê°€í•˜ëŠ” ë° í•„ìš”í•œ ìµœì†Œ ë ˆì§€ìŠ¤í„° ìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
<p><strong>Sethi-Ullman ë²ˆí˜¸ ë§¤ê¸°ê¸°</strong>:
- ì™¼ìª½ ìì‹ì¸ ë¦¬í”„: ë ˆì´ë¸” = 1
- ì˜¤ë¥¸ìª½ ìì‹ì¸ ë¦¬í”„: ë ˆì´ë¸” = 0
- ë ˆì´ë¸” $l_1$ê³¼ $l_2$ë¥¼ ê°€ì§„ ìì‹ë“¤ì„ ê°€ì§„ ë‚´ë¶€ ë…¸ë“œ:</p>
<p>$$\text{label}(n) = \begin{cases} \max(l_1, l_2) & \text{if } l_1 \neq l_2 \\ l_1 + 1 & \text{if } l_1 = l_2 \end{cases}$$</p>
<p>ë£¨íŠ¸ì˜ ë ˆì´ë¸”ì´ í•„ìš”í•œ ìµœì†Œ ë ˆì§€ìŠ¤í„° ìˆ˜ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</p>
<h3 id="62-control-flow">6.2 ì œì–´ íë¦„(Control Flow)<a class="header-link" href="#62-control-flow" title="Permanent link">&para;</a></h3>
<h4 id="if-else">If-Else<a class="header-link" href="#if-else" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">then_body</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">else_body</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>ìƒì„±ëœ ì½”ë“œ:</p>
<div class="highlight"><pre><span></span><code>    &lt;evaluate condition into R1&gt;
    CMP R1, #0
    BEQ else_label
    &lt;then_body code&gt;
    JMP end_label
else_label:
    &lt;else_body code&gt;
end_label:
</code></pre></div>

<h4 id="while">While ë£¨í”„<a class="header-link" href="#while" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">body</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>ìƒì„±ëœ ì½”ë“œ:</p>
<div class="highlight"><pre><span></span><code>loop_start:
    &lt;evaluate condition into R1&gt;
    CMP R1, #0
    BEQ loop_end
    &lt;body code&gt;
    JMP loop_start
loop_end:
</code></pre></div>

<h4 id="for">For ë£¨í”„<a class="header-link" href="#for" title="Permanent link">&para;</a></h4>
<p>for ë£¨í”„ëŠ” ì¼ë°˜ì ìœ¼ë¡œ while ë£¨í”„ë¡œ ë³€í™˜ë©ë‹ˆë‹¤:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">init</span><span class="p">;</span><span class="w"> </span><span class="n">condition</span><span class="p">;</span><span class="w"> </span><span class="n">step</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">body</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>

<p>ë‹¤ìŒê³¼ ê°™ì´ ë©ë‹ˆë‹¤:</p>
<div class="highlight"><pre><span></span><code>    &lt;init code&gt;
loop_start:
    &lt;evaluate condition&gt;
    BEQ loop_end
    &lt;body code&gt;
    &lt;step code&gt;
    JMP loop_start
loop_end:
</code></pre></div>

<h4 id="short-circuit">ë‹¨ë½(Short-Circuit) ë¶ˆë¦¬ì–¸ í‰ê°€<a class="header-link" href="#short-circuit" title="Permanent link">&para;</a></h4>
<p><code>a &amp;&amp; b</code>ì˜ ê²½ìš°:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="o">&lt;</span><span class="nt">evaluate</span><span class="w"> </span><span class="nt">a</span><span class="o">&gt;</span>
<span class="w">    </span><span class="nt">CMP</span><span class="w"> </span><span class="nt">R1</span><span class="o">,</span><span class="w"> </span><span class="p">#</span><span class="nn">0</span>
<span class="w">    </span><span class="nt">BEQ</span><span class="w"> </span><span class="nt">false_label</span><span class="w">     </span><span class="o">;</span><span class="w"> </span><span class="nt">if</span><span class="w"> </span><span class="nt">a</span><span class="w"> </span><span class="nt">is</span><span class="w"> </span><span class="nt">false</span><span class="o">,</span><span class="w"> </span><span class="nt">skip</span><span class="w"> </span><span class="nt">b</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nt">evaluate</span><span class="w"> </span><span class="nt">b</span><span class="o">&gt;</span>
<span class="w">    </span><span class="nt">CMP</span><span class="w"> </span><span class="nt">R2</span><span class="o">,</span><span class="w"> </span><span class="p">#</span><span class="nn">0</span>
<span class="w">    </span><span class="nt">BEQ</span><span class="w"> </span><span class="nt">false_label</span><span class="w">     </span><span class="o">;</span><span class="w"> </span><span class="nt">if</span><span class="w"> </span><span class="nt">b</span><span class="w"> </span><span class="nt">is</span><span class="w"> </span><span class="nt">false</span>
<span class="w">    </span><span class="nt">MOVI</span><span class="w"> </span><span class="nt">R3</span><span class="o">,</span><span class="w"> </span><span class="p">#</span><span class="nn">1</span><span class="w">          </span><span class="o">;</span><span class="w"> </span><span class="nt">result</span><span class="w"> </span><span class="nt">is</span><span class="w"> </span><span class="nt">true</span>
<span class="w">    </span><span class="nt">JMP</span><span class="w"> </span><span class="nt">end_label</span>
<span class="nt">false_label</span><span class="o">:</span>
<span class="w">    </span><span class="nt">MOVI</span><span class="w"> </span><span class="nt">R3</span><span class="o">,</span><span class="w"> </span><span class="p">#</span><span class="nn">0</span><span class="w">          </span><span class="o">;</span><span class="w"> </span><span class="nt">result</span><span class="w"> </span><span class="nt">is</span><span class="w"> </span><span class="nt">false</span>
<span class="nt">end_label</span><span class="o">:</span>
</code></pre></div>

<p><code>a || b</code>ì˜ ê²½ìš°:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="o">&lt;</span><span class="nt">evaluate</span><span class="w"> </span><span class="nt">a</span><span class="o">&gt;</span>
<span class="w">    </span><span class="nt">CMP</span><span class="w"> </span><span class="nt">R1</span><span class="o">,</span><span class="w"> </span><span class="p">#</span><span class="nn">0</span>
<span class="w">    </span><span class="nt">BNE</span><span class="w"> </span><span class="nt">true_label</span><span class="w">       </span><span class="o">;</span><span class="w"> </span><span class="nt">if</span><span class="w"> </span><span class="nt">a</span><span class="w"> </span><span class="nt">is</span><span class="w"> </span><span class="nt">true</span><span class="o">,</span><span class="w"> </span><span class="nt">skip</span><span class="w"> </span><span class="nt">b</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nt">evaluate</span><span class="w"> </span><span class="nt">b</span><span class="o">&gt;</span>
<span class="w">    </span><span class="nt">CMP</span><span class="w"> </span><span class="nt">R2</span><span class="o">,</span><span class="w"> </span><span class="p">#</span><span class="nn">0</span>
<span class="w">    </span><span class="nt">BNE</span><span class="w"> </span><span class="nt">true_label</span><span class="w">       </span><span class="o">;</span><span class="w"> </span><span class="nt">if</span><span class="w"> </span><span class="nt">b</span><span class="w"> </span><span class="nt">is</span><span class="w"> </span><span class="nt">true</span>
<span class="w">    </span><span class="nt">MOVI</span><span class="w"> </span><span class="nt">R3</span><span class="o">,</span><span class="w"> </span><span class="p">#</span><span class="nn">0</span><span class="w">           </span><span class="o">;</span><span class="w"> </span><span class="nt">result</span><span class="w"> </span><span class="nt">is</span><span class="w"> </span><span class="nt">false</span>
<span class="w">    </span><span class="nt">JMP</span><span class="w"> </span><span class="nt">end_label</span>
<span class="nt">true_label</span><span class="o">:</span>
<span class="w">    </span><span class="nt">MOVI</span><span class="w"> </span><span class="nt">R3</span><span class="o">,</span><span class="w"> </span><span class="p">#</span><span class="nn">1</span><span class="w">           </span><span class="o">;</span><span class="w"> </span><span class="nt">result</span><span class="w"> </span><span class="nt">is</span><span class="w"> </span><span class="nt">true</span>
<span class="nt">end_label</span><span class="o">:</span>
</code></pre></div>

<h3 id="63-function-calls">6.3 í•¨ìˆ˜ í˜¸ì¶œ(Function Calls)<a class="header-link" href="#63-function-calls" title="Permanent link">&para;</a></h3>
<p>í•¨ìˆ˜ í˜¸ì¶œì„ ìœ„í•œ ì½”ë“œ ìƒì„±ì€ ë‹¤ìŒì„ í¬í•¨í•©ë‹ˆë‹¤:</p>
<div class="highlight"><pre><span></span><code><span class="p">;</span><span class="w"> </span><span class="n">Caller</span><span class="o">-</span><span class="n">saved</span><span class="w"> </span><span class="n">registers</span>
<span class="n">PUSH</span><span class="w"> </span><span class="n">R_caller_saved1</span>
<span class="n">PUSH</span><span class="w"> </span><span class="n">R_caller_saved2</span>

<span class="p">;</span><span class="w"> </span><span class="n">Arguments</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="nl">AMD64:</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="mh">6</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">registers</span><span class="p">)</span>
<span class="n">MOV</span><span class="w"> </span><span class="n">RDI</span><span class="p">,</span><span class="w"> </span><span class="n">arg1</span>
<span class="n">MOV</span><span class="w"> </span><span class="n">RSI</span><span class="p">,</span><span class="w"> </span><span class="n">arg2</span>
<span class="n">MOV</span><span class="w"> </span><span class="n">RDX</span><span class="p">,</span><span class="w"> </span><span class="n">arg3</span>
<span class="p">;</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mh">6</span><span class="w"> </span><span class="n">args</span>

<span class="p">;</span><span class="w"> </span><span class="n">Call</span>
<span class="n">CALL</span><span class="w"> </span><span class="n">function_label</span>

<span class="p">;</span><span class="w"> </span><span class="n">Return</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">RAX</span>
<span class="n">MOV</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">RAX</span>

<span class="p">;</span><span class="w"> </span><span class="n">Restore</span><span class="w"> </span><span class="n">caller</span><span class="o">-</span><span class="n">saved</span><span class="w"> </span><span class="n">registers</span>
<span class="n">POP</span><span class="w"> </span><span class="n">R_caller_saved2</span>
<span class="n">POP</span><span class="w"> </span><span class="n">R_caller_saved1</span>
</code></pre></div>

<hr />
<h2 id="7-stack-machine-code-generator">7. ìŠ¤íƒ ê¸°ê³„ ì½”ë“œ ìƒì„±ê¸°(Stack Machine Code Generator)<a class="header-link" href="#7-stack-machine-code-generator" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 ìŠ¤íƒ ê¸°ê³„ë€?<a class="header-link" href="#71" title="Permanent link">&para;</a></h3>
<p><strong>ìŠ¤íƒ ê¸°ê³„(stack machine)</strong>ëŠ” ë ˆì§€ìŠ¤í„° ëŒ€ì‹  í”¼ì—°ì‚°ì ìŠ¤íƒ(operand stack)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ëª…ë ¹ì–´ëŠ” ì•”ë¬µì ìœ¼ë¡œ ìŠ¤íƒ ìƒë‹¨ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤:</p>
<div class="highlight"><pre><span></span><code><span class="nt">PUSH</span><span class="w"> </span><span class="nt">5</span><span class="w">        </span><span class="o">;</span><span class="w"> </span><span class="nt">stack</span><span class="o">:</span><span class="w"> </span><span class="cp">[</span><span class="mi">5</span><span class="cp">]</span>
<span class="nt">PUSH</span><span class="w"> </span><span class="nt">3</span><span class="w">        </span><span class="o">;</span><span class="w"> </span><span class="nt">stack</span><span class="o">:</span><span class="w"> </span><span class="cp">[</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="cp">]</span>
<span class="nt">ADD</span><span class="w">           </span><span class="o">;</span><span class="w"> </span><span class="nt">stack</span><span class="o">:</span><span class="w"> </span><span class="cp">[</span><span class="mi">8</span><span class="cp">]</span><span class="w">       </span><span class="o">(</span><span class="nt">pop</span><span class="w"> </span><span class="nt">two</span><span class="o">,</span><span class="w"> </span><span class="nt">push</span><span class="w"> </span><span class="nt">sum</span><span class="o">)</span>
<span class="nt">PUSH</span><span class="w"> </span><span class="nt">2</span><span class="w">        </span><span class="o">;</span><span class="w"> </span><span class="nt">stack</span><span class="o">:</span><span class="w"> </span><span class="cp">[</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="cp">]</span>
<span class="nt">MUL</span><span class="w">           </span><span class="o">;</span><span class="w"> </span><span class="nt">stack</span><span class="o">:</span><span class="w"> </span><span class="cp">[</span><span class="mi">16</span><span class="cp">]</span><span class="w">      </span><span class="o">(</span><span class="nt">pop</span><span class="w"> </span><span class="nt">two</span><span class="o">,</span><span class="w"> </span><span class="nt">push</span><span class="w"> </span><span class="nt">product</span><span class="o">)</span>
</code></pre></div>

<p>ìŠ¤íƒ ê¸°ê³„ëŠ” ë ˆì§€ìŠ¤í„° í• ë‹¹ ë¬¸ì œê°€ ì—†ê¸° ë•Œë¬¸ì— ì½”ë“œ ìƒì„±ì´ ë” ë‹¨ìˆœí•©ë‹ˆë‹¤. ì˜ˆì‹œ: JVM ë°”ì´íŠ¸ì½”ë“œ, .NET CIL, Python ë°”ì´íŠ¸ì½”ë“œ, WebAssembly (ì¼ë¶€).</p>
<h3 id="72">7.2 ìŠ¤íƒ ê¸°ê³„ ëª…ë ¹ì–´ ì§‘í•©<a class="header-link" href="#72" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">Stack</span><span class="w"> </span><span class="n">operations</span><span class="p">:</span>
<span class="w">    </span><span class="n">PUSH</span><span class="w"> </span><span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="w">     </span><span class="p">;</span><span class="w"> </span><span class="n">Push</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="n">onto</span><span class="w"> </span><span class="n">stack</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="o">&lt;</span><span class="k">var</span><span class="o">&gt;</span><span class="w">       </span><span class="p">;</span><span class="w"> </span><span class="n">Push</span><span class="w"> </span><span class="n">variable</span><span class="s1">&#39;s value onto stack</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="o">&lt;</span><span class="k">var</span><span class="o">&gt;</span><span class="w">      </span><span class="p">;</span><span class="w"> </span><span class="n">Pop</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">variable</span>
<span class="w">    </span><span class="n">POP</span><span class="w">              </span><span class="p">;</span><span class="w"> </span><span class="n">Discard</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">stack</span>
<span class="w">    </span><span class="n">DUP</span><span class="w">              </span><span class="p">;</span><span class="w"> </span><span class="n">Duplicate</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">stack</span>

<span class="n">Arithmetic</span><span class="w"> </span><span class="p">(</span><span class="n">pop</span><span class="w"> </span><span class="n">operands</span><span class="p">,</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="n">ADD</span><span class="p">,</span><span class="w"> </span><span class="n">SUB</span><span class="p">,</span><span class="w"> </span><span class="n">MUL</span><span class="p">,</span><span class="w"> </span><span class="n">DIV</span><span class="p">,</span><span class="w"> </span><span class="n">MOD</span><span class="p">,</span><span class="w"> </span><span class="n">NEG</span>

<span class="n">Comparison</span><span class="w"> </span><span class="p">(</span><span class="n">pop</span><span class="w"> </span><span class="n">two</span><span class="p">,</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="n">boolean</span><span class="p">):</span>
<span class="w">    </span><span class="n">EQ</span><span class="p">,</span><span class="w"> </span><span class="n">NE</span><span class="p">,</span><span class="w"> </span><span class="n">LT</span><span class="p">,</span><span class="w"> </span><span class="n">GT</span><span class="p">,</span><span class="w"> </span><span class="n">LE</span><span class="p">,</span><span class="w"> </span><span class="n">GE</span>

<span class="n">Logic</span><span class="p">:</span>
<span class="w">    </span><span class="n">AND</span><span class="p">,</span><span class="w"> </span><span class="n">OR</span><span class="p">,</span><span class="w"> </span><span class="n">NOT</span>

<span class="n">Control</span><span class="w"> </span><span class="n">flow</span><span class="p">:</span>
<span class="w">    </span><span class="n">LABEL</span><span class="w"> </span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="w">     </span><span class="p">;</span><span class="w"> </span><span class="n">Define</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">label</span>
<span class="w">    </span><span class="n">JMP</span><span class="w"> </span><span class="o">&lt;</span><span class="n">label</span><span class="o">&gt;</span><span class="w">      </span><span class="p">;</span><span class="w"> </span><span class="n">Unconditional</span><span class="w"> </span><span class="n">jump</span>
<span class="w">    </span><span class="n">JMPF</span><span class="w"> </span><span class="o">&lt;</span><span class="n">label</span><span class="o">&gt;</span><span class="w">     </span><span class="p">;</span><span class="w"> </span><span class="n">Jump</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="bp">false</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="n">JMPT</span><span class="w"> </span><span class="o">&lt;</span><span class="n">label</span><span class="o">&gt;</span><span class="w">     </span><span class="p">;</span><span class="w"> </span><span class="n">Jump</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="bp">true</span><span class="w"> </span><span class="p">(</span><span class="n">non</span><span class="o">-</span><span class="mi">0</span><span class="p">)</span>

<span class="n">Functions</span><span class="p">:</span>
<span class="w">    </span><span class="n">CALL</span><span class="w"> </span><span class="o">&lt;</span><span class="k">func</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">nargs</span><span class="o">&gt;</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">Call</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">arguments</span>
<span class="w">    </span><span class="n">RET</span><span class="w">                  </span><span class="p">;</span><span class="w"> </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="n">top</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>

<span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="p">:</span>
<span class="w">    </span><span class="n">PRINT</span><span class="w">            </span><span class="p">;</span><span class="w"> </span><span class="n">Pop</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nb">print</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">stack</span>
<span class="w">    </span><span class="n">READ</span><span class="w">             </span><span class="p">;</span><span class="w"> </span><span class="n">Read</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="n">onto</span><span class="w"> </span><span class="n">stack</span>
</code></pre></div>

<h3 id="73">7.3 ì™„ì „í•œ ìŠ¤íƒ ê¸°ê³„ êµ¬í˜„<a class="header-link" href="#73" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Complete code generator and virtual machine for a stack-based target.</span>

<span class="sd">Compiles a simple language to stack machine bytecode and executes it.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">auto</span>


<span class="c1"># ============================================================</span>
<span class="c1"># Part 1: Source Language AST</span>
<span class="c1"># ============================================================</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NumLit</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BoolLit</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">VarRef</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BinaryExpr</span><span class="p">:</span>
    <span class="n">op</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">left</span><span class="p">:</span> <span class="s1">&#39;Expression&#39;</span>
    <span class="n">right</span><span class="p">:</span> <span class="s1">&#39;Expression&#39;</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UnaryExpr</span><span class="p">:</span>
    <span class="n">op</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">operand</span><span class="p">:</span> <span class="s1">&#39;Expression&#39;</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CallExpr</span><span class="p">:</span>
    <span class="n">func</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="nb">list</span>

<span class="n">Expression</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">NumLit</span><span class="p">,</span> <span class="n">BoolLit</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">,</span> <span class="n">BinaryExpr</span><span class="p">,</span> <span class="n">UnaryExpr</span><span class="p">,</span> <span class="n">CallExpr</span><span class="p">]</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AssignStmt</span><span class="p">:</span>
    <span class="n">target</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Expression</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PrintStmt</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Expression</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">IfStmt</span><span class="p">:</span>
    <span class="n">condition</span><span class="p">:</span> <span class="n">Expression</span>
    <span class="n">then_body</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">else_body</span><span class="p">:</span> <span class="nb">list</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">WhileStmt</span><span class="p">:</span>
    <span class="n">condition</span><span class="p">:</span> <span class="n">Expression</span>
    <span class="n">body</span><span class="p">:</span> <span class="nb">list</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ReturnStmt</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Expression</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FuncDef</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">params</span><span class="p">:</span> <span class="nb">list</span>  <span class="c1"># list of parameter names</span>
    <span class="n">body</span><span class="p">:</span> <span class="nb">list</span>    <span class="c1"># list of statements</span>

<span class="n">Statement</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">AssignStmt</span><span class="p">,</span> <span class="n">PrintStmt</span><span class="p">,</span> <span class="n">IfStmt</span><span class="p">,</span> <span class="n">WhileStmt</span><span class="p">,</span> <span class="n">ReturnStmt</span><span class="p">]</span>


<span class="c1"># ============================================================</span>
<span class="c1"># Part 2: Stack Machine Bytecode</span>
<span class="c1"># ============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Opcode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">PUSH</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">LOAD</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">STORE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">POP</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">DUP</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">ADD</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">SUB</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">MUL</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">DIV</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">MOD</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">NEG</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">EQ</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">NE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">LT</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">GT</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">LE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">GE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">AND</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">OR</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">NOT</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">JMP</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">JMPF</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">JMPT</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">CALL</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">RET</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">PRINT</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">LABEL</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">HALT</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BytecodeInstr</span><span class="p">:</span>
    <span class="n">opcode</span><span class="p">:</span> <span class="n">Opcode</span>
    <span class="n">operand</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">operand2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">opcode</span><span class="o">.</span><span class="n">name</span><span class="si">:</span><span class="s2">8s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">operand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operand</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">operand2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operand2</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>


<span class="c1"># ============================================================</span>
<span class="c1"># Part 3: Code Generator</span>
<span class="c1"># ============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CodeGenerator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate stack machine bytecode from AST.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BytecodeInstr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_label_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># func name -&gt; code address</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">new_label</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_label_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_label_counter</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opcode</span><span class="p">:</span> <span class="n">Opcode</span><span class="p">,</span> <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operand2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BytecodeInstr</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="n">operand</span><span class="p">,</span> <span class="n">operand2</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_program</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for a complete program.</span>
<span class="sd">        Program is a list of function definitions and statements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Separate functions from top-level statements</span>
        <span class="n">functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">program</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">FuncDef</span><span class="p">)]</span>
        <span class="n">statements</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">program</span>
                      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">FuncDef</span><span class="p">)]</span>

        <span class="c1"># Jump over function definitions to main code</span>
        <span class="n">main_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_label</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">JMP</span><span class="p">,</span> <span class="n">main_label</span><span class="p">)</span>

        <span class="c1"># Generate code for functions</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_function</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

        <span class="c1"># Generate main code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">LABEL</span><span class="p">,</span> <span class="n">main_label</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">statements</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_stmt</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">HALT</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">FuncDef</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate code for a function definition.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">LABEL</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;func_</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Function body</span>
        <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_stmt</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

        <span class="c1"># Implicit return 0 if no explicit return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">PUSH</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">RET</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate code for a statement.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">AssignStmt</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_expr</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">STORE</span><span class="p">,</span> <span class="n">stmt</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">PrintStmt</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_expr</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">PRINT</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">IfStmt</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_if</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">WhileStmt</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_while</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">ReturnStmt</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_expr</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">RET</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown statement type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate code for an expression (result pushed on stack).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">NumLit</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">PUSH</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">BoolLit</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">PUSH</span><span class="p">,</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">value</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">LOAD</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">BinaryExpr</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_expr</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_expr</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
            <span class="n">op_map</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;+&#39;</span><span class="p">:</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">ADD</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">SUB</span><span class="p">,</span>
                <span class="s1">&#39;*&#39;</span><span class="p">:</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">MUL</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">DIV</span><span class="p">,</span>
                <span class="s1">&#39;%&#39;</span><span class="p">:</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">MOD</span><span class="p">,</span>
                <span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">EQ</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">:</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">NE</span><span class="p">,</span>
                <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">LT</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">GT</span><span class="p">,</span>
                <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">LE</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">GE</span><span class="p">,</span>
                <span class="s1">&#39;and&#39;</span><span class="p">:</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">AND</span><span class="p">,</span> <span class="s1">&#39;or&#39;</span><span class="p">:</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">OR</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">op</span> <span class="ow">in</span> <span class="n">op_map</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">op_map</span><span class="p">[</span><span class="n">expr</span><span class="o">.</span><span class="n">op</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown operator: </span><span class="si">{</span><span class="n">expr</span><span class="o">.</span><span class="n">op</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">UnaryExpr</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_expr</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">operand</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">NEG</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;not&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">NOT</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">CallExpr</span><span class="p">):</span>
            <span class="c1"># Push arguments in order</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_generate_expr</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">CALL</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;func_</span><span class="si">{</span><span class="n">expr</span><span class="o">.</span><span class="n">func</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_if</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">:</span> <span class="n">IfStmt</span><span class="p">):</span>
        <span class="n">else_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_label</span><span class="p">()</span>
        <span class="n">end_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_label</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_expr</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">condition</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">JMPF</span><span class="p">,</span> <span class="n">else_label</span><span class="p">)</span>

        <span class="c1"># Then body</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stmt</span><span class="o">.</span><span class="n">then_body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_stmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">JMP</span><span class="p">,</span> <span class="n">end_label</span><span class="p">)</span>

        <span class="c1"># Else body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">LABEL</span><span class="p">,</span> <span class="n">else_label</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stmt</span><span class="o">.</span><span class="n">else_body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_stmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">LABEL</span><span class="p">,</span> <span class="n">end_label</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_while</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">:</span> <span class="n">WhileStmt</span><span class="p">):</span>
        <span class="n">loop_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_label</span><span class="p">()</span>
        <span class="n">end_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_label</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">LABEL</span><span class="p">,</span> <span class="n">loop_label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_expr</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">condition</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">JMPF</span><span class="p">,</span> <span class="n">end_label</span><span class="p">)</span>

        <span class="c1"># Body</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stmt</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_stmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">JMP</span><span class="p">,</span> <span class="n">loop_label</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Opcode</span><span class="o">.</span><span class="n">LABEL</span><span class="p">,</span> <span class="n">end_label</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pretty-print the generated bytecode.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">):</span>
            <span class="n">label_marker</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">LABEL</span><span class="p">:</span>
                <span class="n">label_marker</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">operand</span><span class="si">}</span><span class="s2">:&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">label_marker</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">instr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># ============================================================</span>
<span class="c1"># Part 4: Stack Machine Virtual Machine</span>
<span class="c1"># ============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">StackMachineVM</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute stack machine bytecode.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BytecodeInstr</span><span class="p">],</span>
                 <span class="n">functions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="n">functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>          <span class="c1"># Operand stack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c1"># Return addresses + saved state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="mi">0</span>                    <span class="c1"># Program counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># Captured output</span>

        <span class="c1"># Resolve labels to addresses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">LABEL</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label_map</span><span class="p">[</span><span class="n">instr</span><span class="o">.</span><span class="n">operand</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the bytecode program.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">):</span>
            <span class="n">instr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">LABEL</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  PC=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">instr</span><span class="si">}</span><span class="s2">  &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;stack=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">HALT</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">LABEL</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">PUSH</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">operand</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">LOAD</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">operand</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">STORE</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">operand</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">POP</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">DUP</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Arithmetic</span>
            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">ADD</span><span class="p">:</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">SUB</span><span class="p">:</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">MUL</span><span class="p">:</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">DIV</span><span class="p">:</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span> <span class="o">//</span> <span class="n">b</span> <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">MOD</span><span class="p">:</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span> <span class="o">%</span> <span class="n">b</span> <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">NEG</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>

            <span class="c1"># Comparison</span>
            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">EQ</span><span class="p">:</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">NE</span><span class="p">:</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">LT</span><span class="p">:</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">GT</span><span class="p">:</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">LE</span><span class="p">:</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">GE</span><span class="p">:</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Logic</span>
            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">AND</span><span class="p">:</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="ow">and</span> <span class="n">b</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">OR</span><span class="p">:</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="ow">or</span> <span class="n">b</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">NOT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Control flow</span>
            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">JMP</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_map</span><span class="p">[</span><span class="n">instr</span><span class="o">.</span><span class="n">operand</span><span class="p">]</span>
                <span class="k">continue</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">JMPF</span><span class="p">:</span>
                <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cond</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_map</span><span class="p">[</span><span class="n">instr</span><span class="o">.</span><span class="n">operand</span><span class="p">]</span>
                    <span class="k">continue</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">JMPT</span><span class="p">:</span>
                <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">cond</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_map</span><span class="p">[</span><span class="n">instr</span><span class="o">.</span><span class="n">operand</span><span class="p">]</span>
                    <span class="k">continue</span>

            <span class="c1"># Functions</span>
            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">CALL</span><span class="p">:</span>
                <span class="n">func_label</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">operand</span>
                <span class="n">nargs</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">operand2</span>

                <span class="c1"># Save state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;return_pc&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;saved_vars&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">),</span>
                <span class="p">})</span>

                <span class="c1"># Pop arguments and bind to params</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nargs</span><span class="p">):</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>

                <span class="c1"># Jump to function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_map</span><span class="p">[</span><span class="n">func_label</span><span class="p">]</span>

                <span class="c1"># Bind arguments (simplified: use positional names)</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">arg_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;__arg</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg_val</span>

                <span class="k">continue</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">RET</span><span class="p">:</span>
                <span class="n">ret_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="p">:</span>
                    <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;saved_vars&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;return_pc&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcode</span><span class="o">.</span><span class="n">PRINT</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  OUTPUT: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="c1"># ============================================================</span>
<span class="c1"># Part 5: Examples</span>
<span class="c1"># ============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">demo_fibonacci</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compile and run:</span>
<span class="sd">        n = 10</span>
<span class="sd">        a = 0</span>
<span class="sd">        b = 1</span>
<span class="sd">        i = 0</span>
<span class="sd">        while (i &lt; n) {</span>
<span class="sd">            print a</span>
<span class="sd">            temp = a + b</span>
<span class="sd">            a = b</span>
<span class="sd">            b = temp</span>
<span class="sd">            i = i + 1</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stack Machine: Fibonacci Sequence (first 10)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

    <span class="n">program</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">AssignStmt</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="n">NumLit</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span>
        <span class="n">AssignStmt</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">NumLit</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span>
        <span class="n">AssignStmt</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">NumLit</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
        <span class="n">AssignStmt</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">NumLit</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span>
        <span class="n">WhileStmt</span><span class="p">(</span>
            <span class="n">condition</span><span class="o">=</span><span class="n">BinaryExpr</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">),</span> <span class="n">VarRef</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">)),</span>
            <span class="n">body</span><span class="o">=</span><span class="p">[</span>
                <span class="n">PrintStmt</span><span class="p">(</span><span class="n">VarRef</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)),</span>
                <span class="n">AssignStmt</span><span class="p">(</span><span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="n">BinaryExpr</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">VarRef</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">))),</span>
                <span class="n">AssignStmt</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)),</span>
                <span class="n">AssignStmt</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">(</span><span class="s2">&quot;temp&quot;</span><span class="p">)),</span>
                <span class="n">AssignStmt</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">BinaryExpr</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">),</span> <span class="n">NumLit</span><span class="p">(</span><span class="mi">1</span><span class="p">))),</span>
            <span class="p">]</span>
        <span class="p">),</span>
    <span class="p">]</span>

    <span class="c1"># Generate code</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">CodeGenerator</span><span class="p">()</span>
    <span class="n">gen</span><span class="o">.</span><span class="n">generate_program</span><span class="p">(</span><span class="n">program</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Generated Bytecode ---&quot;</span><span class="p">)</span>
    <span class="n">gen</span><span class="o">.</span><span class="n">print_code</span><span class="p">()</span>

    <span class="c1"># Execute</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Execution ---&quot;</span><span class="p">)</span>
    <span class="n">vm</span> <span class="o">=</span> <span class="n">StackMachineVM</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">gen</span><span class="o">.</span><span class="n">functions</span><span class="p">)</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fibonacci output: </span><span class="si">{</span><span class="n">vm</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">demo_factorial</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compile and run:</span>
<span class="sd">        result = 1</span>
<span class="sd">        n = 7</span>
<span class="sd">        while (n &gt; 0) {</span>
<span class="sd">            result = result * n</span>
<span class="sd">            n = n - 1</span>
<span class="sd">        }</span>
<span class="sd">        print result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stack Machine: Factorial of 7&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

    <span class="n">program</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">AssignStmt</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">NumLit</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
        <span class="n">AssignStmt</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="n">NumLit</span><span class="p">(</span><span class="mi">7</span><span class="p">)),</span>
        <span class="n">WhileStmt</span><span class="p">(</span>
            <span class="n">condition</span><span class="o">=</span><span class="n">BinaryExpr</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">),</span> <span class="n">NumLit</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span>
            <span class="n">body</span><span class="o">=</span><span class="p">[</span>
                <span class="n">AssignStmt</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">,</span>
                    <span class="n">BinaryExpr</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">),</span> <span class="n">VarRef</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">))),</span>
                <span class="n">AssignStmt</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span>
                    <span class="n">BinaryExpr</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">),</span> <span class="n">NumLit</span><span class="p">(</span><span class="mi">1</span><span class="p">))),</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">PrintStmt</span><span class="p">(</span><span class="n">VarRef</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">)),</span>
    <span class="p">]</span>

    <span class="n">gen</span> <span class="o">=</span> <span class="n">CodeGenerator</span><span class="p">()</span>
    <span class="n">gen</span><span class="o">.</span><span class="n">generate_program</span><span class="p">(</span><span class="n">program</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Generated Bytecode ---&quot;</span><span class="p">)</span>
    <span class="n">gen</span><span class="o">.</span><span class="n">print_code</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Execution ---&quot;</span><span class="p">)</span>
    <span class="n">vm</span> <span class="o">=</span> <span class="n">StackMachineVM</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">gen</span><span class="o">.</span><span class="n">functions</span><span class="p">)</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">7! = </span><span class="si">{</span><span class="n">vm</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">demo_conditionals</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compile and run:</span>
<span class="sd">        x = 15</span>
<span class="sd">        if (x &gt; 10) {</span>
<span class="sd">            if (x &gt; 20) {</span>
<span class="sd">                print 3</span>
<span class="sd">            } else {</span>
<span class="sd">                print 2</span>
<span class="sd">            }</span>
<span class="sd">        } else {</span>
<span class="sd">            print 1</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stack Machine: Nested If-Else&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

    <span class="n">program</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">AssignStmt</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">NumLit</span><span class="p">(</span><span class="mi">15</span><span class="p">)),</span>
        <span class="n">IfStmt</span><span class="p">(</span>
            <span class="n">condition</span><span class="o">=</span><span class="n">BinaryExpr</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">NumLit</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span>
            <span class="n">then_body</span><span class="o">=</span><span class="p">[</span>
                <span class="n">IfStmt</span><span class="p">(</span>
                    <span class="n">condition</span><span class="o">=</span><span class="n">BinaryExpr</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">NumLit</span><span class="p">(</span><span class="mi">20</span><span class="p">)),</span>
                    <span class="n">then_body</span><span class="o">=</span><span class="p">[</span><span class="n">PrintStmt</span><span class="p">(</span><span class="n">NumLit</span><span class="p">(</span><span class="mi">3</span><span class="p">))],</span>
                    <span class="n">else_body</span><span class="o">=</span><span class="p">[</span><span class="n">PrintStmt</span><span class="p">(</span><span class="n">NumLit</span><span class="p">(</span><span class="mi">2</span><span class="p">))],</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="n">else_body</span><span class="o">=</span><span class="p">[</span><span class="n">PrintStmt</span><span class="p">(</span><span class="n">NumLit</span><span class="p">(</span><span class="mi">1</span><span class="p">))],</span>
        <span class="p">),</span>
    <span class="p">]</span>

    <span class="n">gen</span> <span class="o">=</span> <span class="n">CodeGenerator</span><span class="p">()</span>
    <span class="n">gen</span><span class="o">.</span><span class="n">generate_program</span><span class="p">(</span><span class="n">program</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Generated Bytecode ---&quot;</span><span class="p">)</span>
    <span class="n">gen</span><span class="o">.</span><span class="n">print_code</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Execution ---&quot;</span><span class="p">)</span>
    <span class="n">vm</span> <span class="o">=</span> <span class="n">StackMachineVM</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">gen</span><span class="o">.</span><span class="n">functions</span><span class="p">)</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Expected: 2, Got: </span><span class="si">{</span><span class="n">vm</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">demo_fibonacci</span><span class="p">()</span>
    <span class="n">demo_factorial</span><span class="p">()</span>
    <span class="n">demo_conditionals</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="8-machine-dependent-optimization">8. ê¸°ê³„ ì˜ì¡´ ìµœì í™”(Machine-Dependent Optimization)<a class="header-link" href="#8-machine-dependent-optimization" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 íŠ¹ìˆ˜ ëª…ë ¹ì–´ í™œìš©<a class="header-link" href="#81" title="Permanent link">&para;</a></h3>
<p>ë§ì€ í”„ë¡œì„¸ì„œì—ëŠ” ì½”ë“œ ìƒì„±ê¸°ê°€ í™œìš©í•  ìˆ˜ ìˆëŠ” íŠ¹ìˆ˜ ëª…ë ¹ì–´ê°€ ìˆìŠµë‹ˆë‹¤:</p>
<table>
<thead>
<tr>
<th>ìµœì í™”</th>
<th>ì˜ˆì‹œ</th>
</tr>
</thead>
<tbody>
<tr>
<td>ê³±ì…ˆ-ëˆ„ì‚°(Multiply-accumulate)</td>
<td><code>MADD Rd, Rs1, Rs2, Rs3</code> ($Rd = Rs1 + Rs2 \times Rs3$)</td>
</tr>
<tr>
<td>ì„ í–‰ 0 ê°œìˆ˜(Count leading zeros)</td>
<td><code>CLZ Rd, Rs</code> (log2ì— ìœ ìš©)</td>
</tr>
<tr>
<td>ë°”ì´íŠ¸ ìŠ¤ì™‘(Byte swap)</td>
<td><code>REV Rd, Rs</code> (ì—”ë””ì–¸ ë³€í™˜)</td>
</tr>
<tr>
<td>ì¡°ê±´ë¶€ ì´ë™(Conditional move)</td>
<td><code>CMOV Rd, Rs, cond</code> (ë¶„ê¸° ë°©ì§€)</td>
</tr>
<tr>
<td>SIMD</td>
<td><code>VADD.4S V0, V1, V2</code> (4ê°œ ë§ì…ˆ ë³‘ë ¬ ì²˜ë¦¬)</td>
</tr>
</tbody>
</table>
<h3 id="82-addressing-mode-selection">8.2 ì£¼ì†Œ ì§€ì • ëª¨ë“œ ì„ íƒ(Addressing Mode Selection)<a class="header-link" href="#82-addressing-mode-selection" title="Permanent link">&para;</a></h3>
<p>ë³µì¡í•œ ì£¼ì†Œ ì§€ì • ëª¨ë“œëŠ” ëª…ë ¹ì–´ ìˆ˜ë¥¼ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:</p>
<div class="highlight"><pre><span></span><code><span class="p">;</span><span class="w"> </span><span class="k">Without</span><span class="err">:</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">instructions</span>
<span class="n">MOV</span><span class="w">  </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="n">R_base</span>
<span class="k">ADD</span><span class="w">  </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="n">R_index</span><span class="p">,</span><span class="w"> </span><span class="n">LSL</span><span class="w"> </span><span class="n">#2</span><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span>
<span class="k">LOAD</span><span class="w"> </span><span class="n">R2</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">R1</span><span class="o">]</span>

<span class="p">;</span><span class="w"> </span><span class="k">With</span><span class="w"> </span><span class="n">indexed</span><span class="w"> </span><span class="nl">addressing</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">instruction</span>
<span class="k">LOAD</span><span class="w"> </span><span class="n">R2</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">R_base, R_index, LSL #2</span><span class="o">]</span>
</code></pre></div>

<h3 id="83-arm-conditional-execution">8.3 ì¡°ê±´ë¶€ ì‹¤í–‰(ARM) (Conditional Execution)<a class="header-link" href="#83-arm-conditional-execution" title="Permanent link">&para;</a></h3>
<p>ARM ì•„í‚¤í…ì²˜ëŠ” ì¡°ê±´ í”Œë˜ê·¸ê°€ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ ëª…ë ¹ì–´ê°€ ì‹¤í–‰ë˜ëŠ” ì¡°ê±´ë¶€ ì‹¤í–‰(predicated execution)ì„ ì§€ì›í•©ë‹ˆë‹¤:</p>
<div class="highlight"><pre><span></span><code><span class="o">;</span><span class="w"> </span><span class="nt">Standard</span><span class="w"> </span><span class="nt">if-else</span><span class="o">:</span>
<span class="nt">CMP</span><span class="w"> </span><span class="nt">R0</span><span class="o">,</span><span class="w"> </span><span class="p">#</span><span class="nn">0</span>
<span class="nt">BEQ</span><span class="w"> </span><span class="nt">else</span>
<span class="nt">ADD</span><span class="w"> </span><span class="nt">R1</span><span class="o">,</span><span class="w"> </span><span class="nt">R2</span><span class="o">,</span><span class="w"> </span><span class="nt">R3</span><span class="w">      </span><span class="o">;</span><span class="w"> </span><span class="nt">then</span><span class="w"> </span><span class="nt">branch</span>
<span class="nt">B</span><span class="w">   </span><span class="nt">endif</span>
<span class="nt">else</span><span class="o">:</span>
<span class="nt">SUB</span><span class="w"> </span><span class="nt">R1</span><span class="o">,</span><span class="w"> </span><span class="nt">R2</span><span class="o">,</span><span class="w"> </span><span class="nt">R3</span><span class="w">      </span><span class="o">;</span><span class="w"> </span><span class="nt">else</span><span class="w"> </span><span class="nt">branch</span>
<span class="nt">endif</span><span class="o">:</span>

<span class="o">;</span><span class="w"> </span><span class="nt">Predicated</span><span class="w"> </span><span class="o">(</span><span class="nt">no</span><span class="w"> </span><span class="nt">branches</span><span class="o">,</span><span class="w"> </span><span class="nt">no</span><span class="w"> </span><span class="nt">pipeline</span><span class="w"> </span><span class="nt">stalls</span><span class="o">):</span>
<span class="nt">CMP</span><span class="w"> </span><span class="nt">R0</span><span class="o">,</span><span class="w"> </span><span class="p">#</span><span class="nn">0</span>
<span class="nt">ADDNE</span><span class="w"> </span><span class="nt">R1</span><span class="o">,</span><span class="w"> </span><span class="nt">R2</span><span class="o">,</span><span class="w"> </span><span class="nt">R3</span><span class="w">    </span><span class="o">;</span><span class="w"> </span><span class="nt">execute</span><span class="w"> </span><span class="nt">if</span><span class="w"> </span><span class="nt">NE</span><span class="w"> </span><span class="o">(</span><span class="nt">not</span><span class="w"> </span><span class="nt">equal</span><span class="w"> </span><span class="nt">to</span><span class="w"> </span><span class="nt">0</span><span class="o">)</span>
<span class="nt">SUBEQ</span><span class="w"> </span><span class="nt">R1</span><span class="o">,</span><span class="w"> </span><span class="nt">R2</span><span class="o">,</span><span class="w"> </span><span class="nt">R3</span><span class="w">    </span><span class="o">;</span><span class="w"> </span><span class="nt">execute</span><span class="w"> </span><span class="nt">if</span><span class="w"> </span><span class="nt">EQ</span><span class="w"> </span><span class="o">(</span><span class="nt">equal</span><span class="w"> </span><span class="nt">to</span><span class="w"> </span><span class="nt">0</span><span class="o">)</span>
</code></pre></div>

<h3 id="84-branch-prediction-hints">8.4 ë¶„ê¸° ì˜ˆì¸¡ íŒíŠ¸(Branch Prediction Hints)<a class="header-link" href="#84-branch-prediction-hints" title="Permanent link">&para;</a></h3>
<p>ì¼ë¶€ ì•„í‚¤í…ì²˜ëŠ” ì»´íŒŒì¼ëŸ¬ê°€ ì˜ˆìƒë˜ëŠ” ë¶„ê¸° ë°©í–¥ì— ëŒ€í•œ íŒíŠ¸ë¥¼ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:</p>
<div class="highlight"><pre><span></span><code><span class="o">;</span><span class="w"> </span><span class="nt">x86</span><span class="w"> </span><span class="nt">branch</span><span class="w"> </span><span class="nt">hints</span><span class="w"> </span><span class="o">(</span><span class="nt">via</span><span class="w"> </span><span class="nt">instruction</span><span class="w"> </span><span class="nt">prefix</span><span class="o">)</span>
<span class="o">;</span><span class="w"> </span><span class="nt">Prefix</span><span class="w"> </span><span class="nt">0x3E</span><span class="o">:</span><span class="w"> </span><span class="nt">branch</span><span class="w"> </span><span class="nt">likely</span><span class="w"> </span><span class="nt">taken</span>
<span class="o">;</span><span class="w"> </span><span class="nt">Prefix</span><span class="w"> </span><span class="nt">0x2E</span><span class="o">:</span><span class="w"> </span><span class="nt">branch</span><span class="w"> </span><span class="nt">likely</span><span class="w"> </span><span class="nt">not</span><span class="w"> </span><span class="nt">taken</span>

<span class="o">;</span><span class="w"> </span><span class="nt">GCC</span><span class="w"> </span><span class="nt">built-in</span><span class="o">:</span>
<span class="nt">if</span><span class="w"> </span><span class="o">(</span><span class="nt">__builtin_expect</span><span class="o">(</span><span class="nt">error_condition</span><span class="o">,</span><span class="w"> </span><span class="nt">0</span><span class="o">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">unlikely</span><span class="w"> </span><span class="err">path</span>
<span class="w">    </span><span class="err">handle_error()</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="9">9. ìš”ì•½<a class="header-link" href="#9" title="Permanent link">&para;</a></h2>
<p>ì´ ë ˆìŠ¨ì—ì„œ ì½”ë“œ ìƒì„±ì˜ ì£¼ìš” ë‹¨ê³„ë¥¼ ë‹¤ë£¨ì—ˆìŠµë‹ˆë‹¤:</p>
<ol>
<li>
<p><strong>ëª©í‘œ ê¸°ê³„ ëª¨ë¸(Target machine model)</strong>: ì½”ë“œ ìƒì„± ê²°ì •ì„ ì•ˆë‚´í•˜ëŠ” ì—¬ëŸ¬ ì£¼ì†Œ ì§€ì • ëª¨ë“œì™€ ëª…ë ¹ì–´ ë¹„ìš©ì„ ê°€ì§„ ê°„ë‹¨í•œ RISCí˜• ëª…ë ¹ì–´ ì§‘í•©ì„ ì •ì˜í–ˆìŠµë‹ˆë‹¤.</p>
</li>
<li>
<p><strong>ëª…ë ¹ì–´ ì„ íƒ(Instruction selection)</strong>ì€ IR íŠ¸ë¦¬ë¥¼ ê¸°ê³„ ëª…ë ¹ì–´ë¡œ ë§¤í•‘í•©ë‹ˆë‹¤. íƒ€ì¼ì„ ì´ìš©í•œ <strong>íŠ¸ë¦¬ íŒ¨í„´ ë§¤ì¹­(tree pattern matching)</strong>ì€ ì²´ê³„ì ì¸ ì ‘ê·¼ ë°©ì‹ì„ ì œê³µí•©ë‹ˆë‹¤. <strong>ìµœëŒ€ í•œì…(Maximal Munch)</strong> ì•Œê³ ë¦¬ì¦˜ì€ ê° ë…¸ë“œì—ì„œ íƒìš•ì ìœ¼ë¡œ ê°€ì¥ í° ë§¤ì¹­ íƒ€ì¼ì„ ì„ íƒí•©ë‹ˆë‹¤.</p>
</li>
<li>
<p><strong>ë ˆì§€ìŠ¤í„° í• ë‹¹(Register allocation)</strong>ì€ ë¬¼ë¦¬ ë ˆì§€ìŠ¤í„°ë¥¼ ê°€ìƒ ë ˆì§€ìŠ¤í„°ì— ë°°ì •í•©ë‹ˆë‹¤. <strong>ê·¸ë˜í”„ ìƒ‰ì¹ (graph coloring)</strong>ì€ ìµœì  í• ë‹¹ì„ ì œê³µí•˜ì§€ë§Œ ë¹„ìš©ì´ í½ë‹ˆë‹¤. <strong>ì„ í˜• ìŠ¤ìº”(linear scan)</strong>ì€ JIT ì»´íŒŒì¼ëŸ¬ì— ì í•©í•œ ë¹ ë¥¸ ëŒ€ì•ˆì„ ì œê³µí•©ë‹ˆë‹¤. ìŠ¤í•„ë§(spilling)ì€ ë„˜ì¹˜ëŠ” ë³€ìˆ˜ë¥¼ ë©”ëª¨ë¦¬ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
</li>
<li>
<p><strong>ëª…ë ¹ì–´ ìŠ¤ì¼€ì¤„ë§(Instruction scheduling)</strong>ì€ íŒŒì´í”„ë¼ì¸ ìŠ¤í†¨ì„ ìµœì†Œí™”í•˜ê¸° ìœ„í•´ ëª…ë ¹ì–´ë¥¼ ì¬ì •ë ¬í•©ë‹ˆë‹¤. <strong>ë¦¬ìŠ¤íŠ¸ ìŠ¤ì¼€ì¤„ë§(list scheduling)</strong>ì€ ì˜ì¡´ì„± DAGì™€ ìš°ì„ ìˆœìœ„ íœ´ë¦¬ìŠ¤í‹±ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. <strong>ì†Œí”„íŠ¸ì›¨ì–´ íŒŒì´í”„ë¼ì´ë‹(software pipelining)</strong>ì€ ë£¨í”„ ë°˜ë³µì„ ê²¹ì¹©ë‹ˆë‹¤.</p>
</li>
<li>
<p><strong>í•í™€ ìµœì í™”(Peephole optimization)</strong>ëŠ” ì‘ì€ ëª…ë ¹ì–´ ìœˆë„ìš°ì— ë¡œì»¬ ë³€í™˜ì„ ì ìš©í•©ë‹ˆë‹¤: ê°•ë„ ê°ì†Œ, ì¤‘ë³µ ì½”ë“œ ì œê±°, ëŒ€ìˆ˜ì  ë‹¨ìˆœí™”, ë¶„ê¸° ìµœì í™”.</p>
</li>
<li>
<p><strong>ì–¸ì–´ êµ¬ì„±ìš”ì†Œë¥¼ ìœ„í•œ ì½”ë“œ ìƒì„±(Code generation for language constructs)</strong>ì€ ì˜ˆì¸¡ ê°€ëŠ¥í•œ íŒ¨í„´ì„ ë”°ë¦…ë‹ˆë‹¤: ì‹ì€ í›„ìœ„ ìˆœíšŒ(post-order traversal)ë¥¼ ì‚¬ìš©í•˜ê³ , ì œì–´ íë¦„ì€ ì¡°ê±´ë¶€ ë¶„ê¸°ì™€ ë ˆì´ë¸”ì„ ì‚¬ìš©í•˜ë©°, í•¨ìˆ˜ í˜¸ì¶œì€ í˜¸ì¶œ ê·œì•½(calling convention)ì„ ë”°ë¦…ë‹ˆë‹¤.</p>
</li>
<li>
<p><strong>ìŠ¤íƒ ê¸°ê³„(stack machine)</strong>ëŠ” ëª¨ë“  ì—°ì‚°ì´ ì•”ë¬µì  ìŠ¤íƒì„ ì‚¬ìš©í•˜ëŠ” ê°„ë‹¨í•œ ì½”ë“œ ìƒì„± ëª©í‘œë¥¼ ì œê³µí•˜ì—¬ ë ˆì§€ìŠ¤í„° í• ë‹¹ì˜ í•„ìš”ì„±ì„ ì—†ì•±ë‹ˆë‹¤.</p>
</li>
</ol>
<hr />
<h2 id="_3">ì—°ìŠµ ë¬¸ì œ<a class="header-link" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="1-maximal-munch">ì—°ìŠµ 1: ìµœëŒ€ í•œì…(Maximal Munch)<a class="header-link" href="#1-maximal-munch" title="Permanent link">&para;</a></h3>
<p>ë‹¤ìŒ IR íŠ¸ë¦¬ì— ìµœëŒ€ í•œì… ì•Œê³ ë¦¬ì¦˜ì„ ì ìš©í•˜ì—¬ ëª…ë ¹ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”. ê° ë‹¨ê³„ì™€ ìµœì¢… ëª…ë ¹ì–´ ì‹œí€€ìŠ¤ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”.</p>
<div class="highlight"><pre><span></span><code>        STORE
       /     \
      +       MEM
     / \       |
    FP  #-8   +
             / \
            <span class="k">*</span>   #4
           / \
          i   #4
</code></pre></div>

<p>ì‚¬ìš© ê°€ëŠ¥í•œ íƒ€ì¼: register, constant, ADD, ADDI, MUL, SHL (2ì˜ ê±°ë“­ì œê³± ê³±ì…ˆì„ ìœ„í•œ ì™¼ìª½ ì‹œí”„íŠ¸), LOAD with indexed addressing, STORE with indexed addressing.</p>
<h3 id="2-register-allocation">ì—°ìŠµ 2: ë ˆì§€ìŠ¤í„° í• ë‹¹(Register Allocation)<a class="header-link" href="#2-register-allocation" title="Permanent link">&para;</a></h3>
<p>ë‹¤ìŒ í™œì„± êµ¬ê°„ê³¼ 3ê°œì˜ ë¬¼ë¦¬ ë ˆì§€ìŠ¤í„°ê°€ ì£¼ì–´ì¡Œì„ ë•Œ, ì„ í˜• ìŠ¤ìº” ë ˆì§€ìŠ¤í„° í• ë‹¹ì„ ìˆ˜í–‰í•˜ì„¸ìš”. ì–´ë–¤ ë³€ìˆ˜ê°€ ìŠ¤í•„ë˜ë‚˜ìš”?</p>
<div class="highlight"><pre><span></span><code>a: [1, 15]
b: [2, 10]
c: [3, 12]
d: [5, 8]
e: [7, 20]
f: [13, 18]
</code></pre></div>

<h3 id="3-instruction-scheduling">ì—°ìŠµ 3: ëª…ë ¹ì–´ ìŠ¤ì¼€ì¤„ë§(Instruction Scheduling)<a class="header-link" href="#3-instruction-scheduling" title="Permanent link">&para;</a></h3>
<p>1ê°œì˜ ALU ìœ ë‹›ê³¼ 1ê°œì˜ ë¡œë“œ/ìŠ¤í† ì–´ ìœ ë‹›ì„ ê°€ì§„ ê¸°ê³„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë“¤ì„ ìŠ¤ì¼€ì¤„í•˜ì„¸ìš”. ë¡œë“œ ì§€ì—° ì‹œê°„ì€ 3ì‚¬ì´í´, ALU ì§€ì—° ì‹œê°„ì€ 1ì‚¬ì´í´ì…ë‹ˆë‹¤.</p>
<div class="highlight"><pre><span></span><code><span class="nl">I1</span><span class="p">:</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">addr1</span><span class="o">]</span><span class="w">      </span><span class="p">;</span><span class="w"> </span><span class="n">uses</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="n">unit</span><span class="p">,</span><span class="w"> </span><span class="n">latency</span><span class="w"> </span><span class="mi">3</span>
<span class="nl">I2</span><span class="p">:</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="n">R2</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">addr2</span><span class="o">]</span><span class="w">      </span><span class="p">;</span><span class="w"> </span><span class="n">uses</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="n">unit</span><span class="p">,</span><span class="w"> </span><span class="n">latency</span><span class="w"> </span><span class="mi">3</span>
<span class="nl">I3</span><span class="p">:</span><span class="w"> </span><span class="k">ADD</span><span class="w">  </span><span class="n">R3</span><span class="p">,</span><span class="w"> </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="n">R2</span><span class="w">       </span><span class="p">;</span><span class="w"> </span><span class="n">uses</span><span class="w"> </span><span class="n">ALU</span><span class="p">,</span><span class="w"> </span><span class="n">latency</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">I1</span><span class="p">,</span><span class="w"> </span><span class="n">I2</span>
<span class="nl">I4</span><span class="p">:</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="n">R4</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">addr3</span><span class="o">]</span><span class="w">      </span><span class="p">;</span><span class="w"> </span><span class="n">uses</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="n">unit</span><span class="p">,</span><span class="w"> </span><span class="n">latency</span><span class="w"> </span><span class="mi">3</span>
<span class="nl">I5</span><span class="p">:</span><span class="w"> </span><span class="n">MUL</span><span class="w">  </span><span class="n">R5</span><span class="p">,</span><span class="w"> </span><span class="n">R3</span><span class="p">,</span><span class="w"> </span><span class="n">R4</span><span class="w">       </span><span class="p">;</span><span class="w"> </span><span class="n">uses</span><span class="w"> </span><span class="n">ALU</span><span class="p">,</span><span class="w"> </span><span class="n">latency</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">I3</span><span class="p">,</span><span class="w"> </span><span class="n">I4</span>
<span class="nl">I6</span><span class="p">:</span><span class="w"> </span><span class="k">ADD</span><span class="w">  </span><span class="n">R6</span><span class="p">,</span><span class="w"> </span><span class="n">R5</span><span class="p">,</span><span class="w"> </span><span class="n">#1</span><span class="w">       </span><span class="p">;</span><span class="w"> </span><span class="n">uses</span><span class="w"> </span><span class="n">ALU</span><span class="p">,</span><span class="w"> </span><span class="n">latency</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">I5</span>
</code></pre></div>

<p>ìµœì†Œ ì‚¬ì´í´ ìˆ˜ëŠ” ì–¼ë§ˆì¸ê°€ìš”? ìŠ¤ì¼€ì¤„ì„ ê·¸ë ¤ë³´ì„¸ìš”.</p>
<h3 id="4-peephole-optimization">ì—°ìŠµ 4: í•í™€ ìµœì í™”(Peephole Optimization)<a class="header-link" href="#4-peephole-optimization" title="Permanent link">&para;</a></h3>
<p>ë‹¤ìŒ ì½”ë“œì— í•í™€ ìµœì í™”ë¥¼ ì ìš©í•˜ì„¸ìš”. ê° íŒ¨ìŠ¤ í›„ì˜ ê²°ê³¼ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”.</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="n">MOVI</span><span class="w"> </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="n">#10</span>
<span class="w">  </span><span class="k">ADD</span><span class="w">  </span><span class="n">R2</span><span class="p">,</span><span class="w"> </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="n">#0</span>
<span class="w">  </span><span class="n">MUL</span><span class="w">  </span><span class="n">R3</span><span class="p">,</span><span class="w"> </span><span class="n">R2</span><span class="p">,</span><span class="w"> </span><span class="n">#16</span>
<span class="w">  </span><span class="n">MOV</span><span class="w">  </span><span class="n">R4</span><span class="p">,</span><span class="w"> </span><span class="n">R4</span>
<span class="w">  </span><span class="n">STORE</span><span class="w"> </span><span class="n">R3</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">R5</span><span class="o">]</span>
<span class="w">  </span><span class="k">LOAD</span><span class="w">  </span><span class="n">R3</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">R5</span><span class="o">]</span>
<span class="w">  </span><span class="n">MUL</span><span class="w">  </span><span class="n">R6</span><span class="p">,</span><span class="w"> </span><span class="n">R3</span><span class="p">,</span><span class="w"> </span><span class="n">#1</span>
<span class="w">  </span><span class="n">DIV</span><span class="w">  </span><span class="n">R7</span><span class="p">,</span><span class="w"> </span><span class="n">R6</span><span class="p">,</span><span class="w"> </span><span class="n">#8</span>
<span class="w">  </span><span class="n">JMP</span><span class="w">  </span><span class="n">L1</span>
<span class="w">  </span><span class="k">ADD</span><span class="w">  </span><span class="n">R8</span><span class="p">,</span><span class="w"> </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="n">R2</span>
<span class="nl">L1</span><span class="p">:</span>
<span class="w">  </span><span class="n">JMP</span><span class="w">  </span><span class="n">L2</span>
<span class="nl">L2</span><span class="p">:</span>
<span class="w">  </span><span class="n">RET</span>
</code></pre></div>

<h3 id="5-stack-machine">ì—°ìŠµ 5: ìŠ¤íƒ ê¸°ê³„(Stack Machine)<a class="header-link" href="#5-stack-machine" title="Permanent link">&para;</a></h3>
<p>ë‹¤ìŒ ì‹ì„ ìŠ¤íƒ ê¸°ê³„ ë°”ì´íŠ¸ì½”ë“œë¡œ ì§ì ‘ ì»´íŒŒì¼í•˜ê³  ê° ëª…ë ¹ì–´ ì´í›„ì˜ ìŠ¤íƒ ë‚´ìš©ì„ ì¶”ì í•˜ì„¸ìš”:</p>
<div class="highlight"><pre><span></span><code>result = (3 + 4) * (10 - 2) / (1 + 1)
</code></pre></div>

<h3 id="6">ì—°ìŠµ 6: êµ¬í˜„ ë„ì „<a class="header-link" href="#6" title="Permanent link">&para;</a></h3>
<p>ìŠ¤íƒ ê¸°ê³„ ì½”ë“œ ìƒì„±ê¸°ì™€ VMì„ ë‹¤ìŒì„ ì§€ì›í•˜ë„ë¡ í™•ì¥í•˜ì„¸ìš”:
1. <strong>ë°°ì—´(Arrays)</strong>: <code>ALLOC n</code> (í¬ê¸° nì˜ ë°°ì—´ í• ë‹¹), <code>ALOAD</code> (ë°°ì—´ì—ì„œ ë¡œë“œ), <code>ASTORE</code> (ë°°ì—´ì— ì €ì¥)
2. <strong>For ë£¨í”„(For loops)</strong>: <code>for i = start to end { body }</code>ë¥¼ ì†ŒìŠ¤ ë ˆë²¨ êµ¬ì„±ìš”ì†Œë¡œ êµ¬í˜„</p>
<p>ë°°ì—´ì„ í• ë‹¹í•˜ê³  ì œê³±ìˆ˜ë¡œ ì±„ìš´ ë‹¤ìŒ ë‚´ìš©ì„ ì¶œë ¥í•˜ëŠ” í”„ë¡œê·¸ë¨ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.</p>
<hr />
<p><a href="./10_Runtime_Environments.md">Previous: 10_Runtime_Environments.md</a> | <a href="./12_Optimization_Local_and_Global.md">Next: 12_Optimization_Local_and_Global.md</a> | <a href="./00_Overview.md">Overview</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Compiler_Design/10_Runtime_Environments.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">ë ˆìŠ¨ 10: ëŸ°íƒ€ì„ í™˜ê²½(Runtime Environments)</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Compiler_Design/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Compiler_Design/12_Optimization_Local_and_Global.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">ë ˆìŠ¨ 12: ìµœì í™” -- ì§€ì—­ ìµœì í™”ì™€ ì „ì—­ ìµœì í™”</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'ko';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}