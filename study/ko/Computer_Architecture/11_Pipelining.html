{% raw %}
<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>파이프라이닝 (Pipelining) - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/ko/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/ko/" class="nav-item ">
                    <span class="nav-icon">🏠</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">💻</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/ko/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" >
                        English
                    </option>
                    
                    <option value="ko" selected>
                        한국어
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">☀️</span>
                    <span class="theme-icon dark">🌙</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/ko/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/ko/Computer_Architecture/">Computer Architecture</a>
    <span class="separator">/</span>
    <span class="current">파이프라이닝 (Pipelining)</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>파이프라이닝 (Pipelining)</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Computer_Architecture/10_Assembly_Language_Basics.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">어셈블리 언어 기초</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">🔗</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Computer_Architecture/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">📋</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Computer_Architecture/12_Branch_Prediction.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">분기 예측 (Branch Prediction)</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#_1">개요</a></li>
<li><a href="#_2">목차</a></li>
<li><a href="#1">1. 파이프라이닝 개념</a><ul>
<li><a href="#_3">기본 아이디어</a></li>
<li><a href="#_4">세탁기 비유</a></li>
</ul>
</li>
<li><a href="#2-5">2. 5단계 파이프라인</a><ul>
<li><a href="#mips-5">MIPS 5단계 파이프라인</a></li>
<li><a href="#_5">각 단계 설명</a></li>
<li><a href="#_6">파이프라인 레지스터</a></li>
<li><a href="#_7">명령어별 파이프라인 사용</a></li>
</ul>
</li>
<li><a href="#3">3. 파이프라인 성능</a><ul>
<li><a href="#_8">이상적인 속도 향상</a></li>
<li><a href="#_9">처리량 계산</a></li>
<li><a href="#100">예제: 100개 명령어 실행</a></li>
</ul>
</li>
<li><a href="#4">4. 파이프라인 해저드</a><ul>
<li><a href="#_10">해저드 유형</a></li>
<li><a href="#41">4.1 구조적 해저드</a></li>
<li><a href="#42">4.2 데이터 해저드</a></li>
<li><a href="#raw">RAW 해저드 예시</a></li>
<li><a href="#43">4.3 제어 해저드</a></li>
</ul>
</li>
<li><a href="#5">5. 해저드 해결 기법</a><ul>
<li><a href="#51-stalling">5.1 스톨링 (Stalling)</a></li>
<li><a href="#52">5.2 포워딩/바이패싱</a></li>
<li><a href="#_11">포워딩 경로</a></li>
<li><a href="#53-load-use">5.3 Load-Use 해저드</a></li>
<li><a href="#54">5.4 분기 예측</a></li>
<li><a href="#55-delayed-branch">5.5 지연 분기 (Delayed Branch)</a></li>
</ul>
</li>
<li><a href="#6">6. 연습 문제</a><ul>
<li><a href="#_12">기초 문제</a></li>
<li><a href="#_13">해저드 분석</a></li>
<li><a href="#_14">성능 계산</a></li>
</ul>
</li>
<li><a href="#_15">다음 단계</a></li>
<li><a href="#_16">참고 자료</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="pipelining">파이프라이닝 (Pipelining)<a class="header-link" href="#pipelining" title="Permanent link">&para;</a></h1>
<h2 id="_1">개요<a class="header-link" href="#_1" title="Permanent link">&para;</a></h2>
<p>파이프라이닝은 여러 명령어를 동시에 실행하여 CPU 처리량을 높이는 기술입니다. 세탁기-건조기 비유처럼, 하나의 작업이 끝나기 전에 다음 작업을 시작하여 전체 효율을 높입니다.</p>
<hr />
<h2 id="_2">목차<a class="header-link" href="#_2" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-파이프라이닝-개념">파이프라이닝 개념</a></li>
<li><a href="#2-5단계-파이프라인">5단계 파이프라인</a></li>
<li><a href="#3-파이프라인-성능">파이프라인 성능</a></li>
<li><a href="#4-파이프라인-해저드">파이프라인 해저드</a></li>
<li><a href="#5-해저드-해결-기법">해저드 해결 기법</a></li>
<li><a href="#6-연습-문제">연습 문제</a></li>
</ol>
<hr />
<h2 id="1">1. 파이프라이닝 개념<a class="header-link" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="_3">기본 아이디어<a class="header-link" href="#_3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">비파이프라인</span><span class="w"> </span><span class="p">(</span><span class="n">순차</span><span class="w"> </span><span class="n">실행</span><span class="p">)</span><span class="err">:</span>
<span class="err">┌─────┐</span><span class="w">     </span><span class="err">┌─────┐</span><span class="w">     </span><span class="err">┌─────┐</span>
<span class="err">│</span><span class="w"> </span><span class="n">I1</span><span class="w">  </span><span class="err">│────▶│</span><span class="w"> </span><span class="n">I2</span><span class="w">  </span><span class="err">│────▶│</span><span class="w"> </span><span class="n">I3</span><span class="w">  </span><span class="err">│</span>
<span class="err">└─────┘</span><span class="w">     </span><span class="err">└─────┘</span><span class="w">     </span><span class="err">└─────┘</span>
<span class="w">  </span><span class="mi">5</span><span class="n">ns</span><span class="w">         </span><span class="mi">5</span><span class="n">ns</span><span class="w">         </span><span class="mi">5</span><span class="n">ns</span><span class="w">      </span><span class="n">총</span><span class="w"> </span><span class="mi">15</span><span class="n">ns</span>

<span class="n">파이프라인</span><span class="w"> </span><span class="p">(</span><span class="n">병렬</span><span class="w"> </span><span class="n">실행</span><span class="p">)</span><span class="err">:</span>
<span class="nl">시간</span><span class="p">:</span><span class="w">  </span><span class="mi">1</span><span class="n">ns</span><span class="w">   </span><span class="mi">2</span><span class="n">ns</span><span class="w">   </span><span class="mi">3</span><span class="n">ns</span><span class="w">   </span><span class="mi">4</span><span class="n">ns</span><span class="w">   </span><span class="mi">5</span><span class="n">ns</span><span class="w">   </span><span class="mi">6</span><span class="n">ns</span><span class="w">   </span><span class="mi">7</span><span class="n">ns</span>
<span class="nl">I1</span><span class="p">:</span><span class="w">   </span><span class="o">[</span><span class="n">IF</span><span class="o">]</span><span class="err">─</span><span class="o">[</span><span class="n">ID</span><span class="o">]</span><span class="err">─</span><span class="o">[</span><span class="n">EX</span><span class="o">]</span><span class="err">─</span><span class="o">[</span><span class="n">MEM</span><span class="o">]</span><span class="err">─</span><span class="o">[</span><span class="n">WB</span><span class="o">]</span>
<span class="nl">I2</span><span class="p">:</span><span class="w">        </span><span class="o">[</span><span class="n">IF</span><span class="o">]</span><span class="err">─</span><span class="o">[</span><span class="n">ID</span><span class="o">]</span><span class="err">─</span><span class="o">[</span><span class="n">EX</span><span class="o">]</span><span class="err">─</span><span class="o">[</span><span class="n">MEM</span><span class="o">]</span><span class="err">─</span><span class="o">[</span><span class="n">WB</span><span class="o">]</span>
<span class="nl">I3</span><span class="p">:</span><span class="w">             </span><span class="o">[</span><span class="n">IF</span><span class="o">]</span><span class="err">─</span><span class="o">[</span><span class="n">ID</span><span class="o">]</span><span class="err">─</span><span class="o">[</span><span class="n">EX</span><span class="o">]</span><span class="err">─</span><span class="o">[</span><span class="n">MEM</span><span class="o">]</span><span class="err">─</span><span class="o">[</span><span class="n">WB</span><span class="o">]</span>
<span class="w">                                     </span><span class="n">총</span><span class="w"> </span><span class="mi">7</span><span class="n">ns</span>
</code></pre></div>

<h3 id="_4">세탁기 비유<a class="header-link" href="#_4" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">비파이프라인</span><span class="o">:</span>
<span class="err">세탁</span><span class="mi">1</span><span class="w"> </span><span class="err">──▶</span><span class="w"> </span><span class="err">건조</span><span class="mi">1</span><span class="w"> </span><span class="err">──▶</span><span class="w"> </span><span class="err">세탁</span><span class="mi">2</span><span class="w"> </span><span class="err">──▶</span><span class="w"> </span><span class="err">건조</span><span class="mi">2</span><span class="w"> </span><span class="err">──▶</span><span class="w"> </span><span class="err">세탁</span><span class="mi">3</span><span class="w"> </span><span class="err">──▶</span><span class="w"> </span><span class="err">건조</span><span class="mi">3</span>

<span class="err">파이프라인</span><span class="o">:</span>
<span class="err">시간</span><span class="o">:</span><span class="w">   </span><span class="mi">1</span><span class="w">    </span><span class="mi">2</span><span class="w">    </span><span class="mi">3</span><span class="w">    </span><span class="mi">4</span><span class="w">    </span><span class="mi">5</span><span class="w">    </span><span class="mi">6</span>
<span class="err">세탁</span><span class="mi">1</span><span class="w">   </span><span class="err">■</span>
<span class="err">건조</span><span class="mi">1</span><span class="w">        </span><span class="err">■</span>
<span class="err">세탁</span><span class="mi">2</span><span class="w">        </span><span class="err">■</span>
<span class="err">건조</span><span class="mi">2</span><span class="w">             </span><span class="err">■</span>
<span class="err">세탁</span><span class="mi">3</span><span class="w">             </span><span class="err">■</span>
<span class="err">건조</span><span class="mi">3</span><span class="w">                  </span><span class="err">■</span>

<span class="mi">3</span><span class="err">배</span><span class="w"> </span><span class="err">빨라짐</span><span class="o">!</span>
</code></pre></div>

<hr />
<h2 id="2-5">2. 5단계 파이프라인<a class="header-link" href="#2-5" title="Permanent link">&para;</a></h2>
<h3 id="mips-5">MIPS 5단계 파이프라인<a class="header-link" href="#mips-5" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>┌────────────────────────────────────────────────────────────┐
│<span class="w">                    </span><span class="mi">5</span><span class="o">-</span><span class="nv">Stage</span><span class="w"> </span><span class="nv">Pipeline</span><span class="w">                         </span>│
├───────┬───────┬───────┬───────┬───────┐<span class="w">                    </span>│
│<span class="w">  </span><span class="k">IF</span><span class="w">   </span>│<span class="w">  </span><span class="nv">ID</span><span class="w">   </span>│<span class="w">  </span><span class="nv">EX</span><span class="w">   </span>│<span class="w">  </span><span class="nv">MEM</span><span class="w">  </span>│<span class="w">  </span><span class="nv">WB</span><span class="w">   </span>│<span class="w">                    </span>│
│<span class="ss">(</span><span class="nv">Fetch</span><span class="ss">)</span>│<span class="ss">(</span><span class="nv">Decode</span>│<span class="ss">(</span><span class="k">Exec</span><span class="ss">)</span><span class="w"> </span>│<span class="ss">(</span><span class="nv">Memory</span>│<span class="ss">(</span><span class="nv">Write</span><span class="w"> </span>│<span class="w">                    </span>│
│<span class="w">       </span>│<span class="w">       </span>│<span class="w">       </span>│<span class="nv">Access</span><span class="ss">)</span>│<span class="w"> </span><span class="nv">Back</span><span class="ss">)</span><span class="w"> </span>│<span class="w">                    </span>│
└───────┴───────┴───────┴───────┴───────┘<span class="w">                    </span>│
└────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="_5">각 단계 설명<a class="header-link" href="#_5" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>단계</th>
<th>이름</th>
<th>동작</th>
</tr>
</thead>
<tbody>
<tr>
<td>IF</td>
<td>Instruction Fetch</td>
<td>PC가 가리키는 명령어를 메모리에서 가져옴</td>
</tr>
<tr>
<td>ID</td>
<td>Instruction Decode</td>
<td>명령어 해독, 레지스터 읽기</td>
</tr>
<tr>
<td>EX</td>
<td>Execute</td>
<td>ALU 연산 수행, 주소 계산</td>
</tr>
<tr>
<td>MEM</td>
<td>Memory Access</td>
<td>메모리 읽기/쓰기 (load/store)</td>
</tr>
<tr>
<td>WB</td>
<td>Write Back</td>
<td>연산 결과를 레지스터에 저장</td>
</tr>
</tbody>
</table>
<h3 id="_6">파이프라인 레지스터<a class="header-link" href="#_6" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>┌─────┐<span class="w">   </span>┌─────────┐<span class="w">   </span>┌─────────┐<span class="w">   </span>┌──────────┐<span class="w">   </span>┌─────────┐
│<span class="w"> </span><span class="k">IF</span><span class="w">  </span>│──▶│<span class="w"> </span><span class="k">IF</span><span class="o">/</span><span class="nv">ID</span><span class="w">   </span>│──▶│<span class="w"> </span><span class="nv">ID</span><span class="o">/</span><span class="nv">EX</span><span class="w">   </span>│──▶│<span class="w"> </span><span class="nv">EX</span><span class="o">/</span><span class="nv">MEM</span><span class="w">   </span>│──▶│<span class="w"> </span><span class="nv">MEM</span><span class="o">/</span><span class="nv">WB</span><span class="w">  </span>│
└─────┘<span class="w">   </span>│<span class="nv">Register</span><span class="w"> </span>│<span class="w">   </span>│<span class="nv">Register</span><span class="w"> </span>│<span class="w">   </span>│<span class="nv">Register</span><span class="w">  </span>│<span class="w">   </span>│<span class="nv">Register</span><span class="w"> </span>│
<span class="w">          </span>└─────────┘<span class="w">   </span>└─────────┘<span class="w">   </span>└──────────┘<span class="w">   </span>└─────────┘

파이프라인<span class="w"> </span>레지스터:<span class="w"> </span>각<span class="w"> </span>단계<span class="w"> </span>사이의<span class="w"> </span>데이터를<span class="w"> </span>임시<span class="w"> </span>저장
<span class="o">-</span><span class="w"> </span>클럭마다<span class="w"> </span>데이터가<span class="w"> </span>다음<span class="w"> </span>단계로<span class="w"> </span>전달
</code></pre></div>

<h3 id="_7">명령어별 파이프라인 사용<a class="header-link" href="#_7" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nx">명령어</span><span class="w"> </span><span class="nx">유형별</span><span class="w"> </span><span class="nx">단계</span><span class="w"> </span><span class="nx">사용</span><span class="p">:</span>

<span class="nx">R</span><span class="o">-</span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="nx">add</span><span class="p">,</span><span class="w"> </span><span class="nx">sub</span><span class="p">):</span>
<span class="nx">IF</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="nx">ID</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="nx">EX</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="o">---</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="nx">WB</span>

<span class="nx">Load</span><span class="w"> </span><span class="p">(</span><span class="nx">lw</span><span class="p">):</span>
<span class="nx">IF</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="nx">ID</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="nx">EX</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="nx">MEM</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="nx">WB</span>

<span class="nx">Store</span><span class="w"> </span><span class="p">(</span><span class="nx">sw</span><span class="p">):</span>
<span class="nx">IF</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="nx">ID</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="nx">EX</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="nx">MEM</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="o">---</span>

<span class="nx">Branch</span><span class="w"> </span><span class="p">(</span><span class="nx">beq</span><span class="p">):</span>
<span class="nx">IF</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="nx">ID</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="nx">EX</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="o">---</span><span class="w"> </span><span class="err">─▶</span><span class="w"> </span><span class="o">---</span>
</code></pre></div>

<hr />
<h2 id="3">3. 파이프라인 성능<a class="header-link" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="_8">이상적인 속도 향상<a class="header-link" href="#_8" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>속도 향상 = 파이프라인 단계 수 (이상적)

5단계 파이프라인 → 최대 5배 속도 향상

실제로는:
- 파이프라인 채우기/비우기 시간
- 해저드로 인한 스톨
- 단계 간 불균형
</code></pre></div>

<h3 id="_9">처리량 계산<a class="header-link" href="#_9" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>처리량 (Throughput) = 명령어 수 / 시간

비파이프라인:
- 1 명령어 / 5 사이클

파이프라인 (이상적):
- 1 명령어 / 1 사이클 (풀 파이프라인 상태)

CPI (Cycles Per Instruction):
- 이상적: CPI = 1
- 실제: CPI = 1 + 스톨 사이클
</code></pre></div>

<h3 id="100">예제: 100개 명령어 실행<a class="header-link" href="#100" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">비파이프라인</span><span class="o">:</span>
<span class="err">시간</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="w"> </span><span class="err">사이클</span>

<span class="mi">5</span><span class="err">단계</span><span class="w"> </span><span class="err">파이프라인</span><span class="o">:</span>
<span class="err">시간</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">(</span><span class="mi">100</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">104</span><span class="w"> </span><span class="err">사이클</span>
<span class="w">      </span><span class="err">↑첫</span><span class="w"> </span><span class="err">명령어</span><span class="w">   </span><span class="err">↑나머지</span><span class="w"> </span><span class="err">명령어</span>

<span class="err">속도</span><span class="w"> </span><span class="err">향상</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">104</span><span class="w"> </span><span class="err">≈</span><span class="w"> </span><span class="mf">4.8</span><span class="err">배</span>
</code></pre></div>

<hr />
<h2 id="4">4. 파이프라인 해저드<a class="header-link" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="_10">해저드 유형<a class="header-link" href="#_10" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────┐
│                   파이프라인 해저드                       │
├─────────────────┬─────────────────┬─────────────────────┤
│   구조적 해저드  │   데이터 해저드  │    제어 해저드      │
│  (Structural)   │    (Data)       │    (Control)        │
├─────────────────┼─────────────────┼─────────────────────┤
│ 하드웨어 자원   │ 데이터 의존성   │ 분기 명령어로       │
│ 충돌           │ 으로 인한 문제  │ 인한 문제           │
└─────────────────┴─────────────────┴─────────────────────┘
</code></pre></div>

<h3 id="41">4.1 구조적 해저드<a class="header-link" href="#41" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">문제</span><span class="o">:</span><span class="w"> </span><span class="err">같은</span><span class="w"> </span><span class="err">하드웨어</span><span class="w"> </span><span class="err">자원을</span><span class="w"> </span><span class="err">동시에</span><span class="w"> </span><span class="err">사용하려</span><span class="w"> </span><span class="err">함</span>

<span class="err">예</span><span class="o">:</span><span class="w"> </span><span class="err">단일</span><span class="w"> </span><span class="err">메모리</span><span class="w"> </span><span class="err">사용</span><span class="w"> </span><span class="err">시</span>
<span class="err">사이클</span><span class="w"> </span><span class="mi">4</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="err">명령어</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">MEM</span><span class="w"> </span><span class="err">단계</span><span class="w"> </span><span class="o">(</span><span class="err">데이터</span><span class="w"> </span><span class="err">메모리</span><span class="w"> </span><span class="err">접근</span><span class="o">)</span>
<span class="o">-</span><span class="w"> </span><span class="err">명령어</span><span class="w"> </span><span class="mi">4</span><span class="o">:</span><span class="w"> </span><span class="n">IF</span><span class="w"> </span><span class="err">단계</span><span class="w"> </span><span class="o">(</span><span class="err">명령어</span><span class="w"> </span><span class="err">메모리</span><span class="w"> </span><span class="err">접근</span><span class="o">)</span>

<span class="w">    </span><span class="n">I1</span><span class="o">:</span><span class="w"> </span><span class="n">IF</span><span class="err">─</span><span class="n">ID</span><span class="err">─</span><span class="n">EX</span><span class="err">─</span><span class="n">MEM</span><span class="err">─</span><span class="n">WB</span>
<span class="w">    </span><span class="n">I4</span><span class="o">:</span><span class="w">          </span><span class="n">IF</span><span class="w"> </span><span class="err">←</span><span class="w"> </span><span class="err">충돌</span><span class="o">!</span>

<span class="err">해결</span><span class="o">:</span><span class="w"> </span><span class="err">하버드</span><span class="w"> </span><span class="err">구조</span><span class="w"> </span><span class="o">(</span><span class="err">명령어</span><span class="o">/</span><span class="err">데이터</span><span class="w"> </span><span class="err">메모리</span><span class="w"> </span><span class="err">분리</span><span class="o">)</span>
</code></pre></div>

<h3 id="42">4.2 데이터 해저드<a class="header-link" href="#42" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>세 가지 유형:

1. RAW (Read After Write) - 가장 흔함
   add $s0, $t0, $t1    # $s0에 쓰기
   sub $t2, $s0, $t3    # $s0 읽기 ← 아직 안 써짐!

2. WAR (Write After Read)
   sub $t2, $s0, $t3    # $s0 읽기
   add $s0, $t0, $t1    # $s0에 쓰기

3. WAW (Write After Write)
   add $s0, $t0, $t1    # $s0에 쓰기
   sub $s0, $t2, $t3    # $s0에 쓰기
</code></pre></div>

<h3 id="raw">RAW 해저드 예시<a class="header-link" href="#raw" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">add</span><span class="w"> </span><span class="err">$</span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">t1</span>
<span class="n">sub</span><span class="w"> </span><span class="err">$</span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">t3</span>

<span class="nl">시간</span><span class="p">:</span><span class="w">    </span><span class="mi">1</span><span class="w">    </span><span class="mi">2</span><span class="w">    </span><span class="mi">3</span><span class="w">    </span><span class="mi">4</span><span class="w">    </span><span class="mi">5</span><span class="w">    </span><span class="mi">6</span><span class="w">    </span><span class="mi">7</span>
<span class="k">add</span><span class="err">:</span><span class="w">    </span><span class="k">IF</span><span class="w">   </span><span class="n">ID</span><span class="w">   </span><span class="n">EX</span><span class="w">  </span><span class="n">MEM</span><span class="w">  </span><span class="o">[</span><span class="n">WB</span><span class="o">]</span><span class="w"> </span><span class="err">←</span><span class="w"> </span><span class="err">$</span><span class="n">s0</span><span class="w"> </span><span class="n">기록</span>
<span class="nl">sub</span><span class="p">:</span><span class="w">         </span><span class="k">IF</span><span class="w">   </span><span class="n">ID</span><span class="w">  </span><span class="o">[</span><span class="n">EX</span><span class="o">]</span><span class="w"> </span><span class="err">←</span><span class="w"> </span><span class="err">$</span><span class="n">s0</span><span class="w"> </span><span class="n">필요</span><span class="err">!</span>
<span class="w">                       </span><span class="err">↑</span>
<span class="w">                   </span><span class="n">문제</span><span class="w"> </span><span class="n">발생</span><span class="err">!</span>

<span class="err">$</span><span class="n">s0는</span><span class="w"> </span><span class="n">사이클</span><span class="w"> </span><span class="mi">5</span><span class="n">에</span><span class="w"> </span><span class="n">기록되는데</span><span class="p">,</span>
<span class="n">sub는</span><span class="w"> </span><span class="n">사이클</span><span class="w"> </span><span class="mi">4</span><span class="n">에</span><span class="w"> </span><span class="err">$</span><span class="n">s0가</span><span class="w"> </span><span class="n">필요함</span>
</code></pre></div>

<h3 id="43">4.3 제어 해저드<a class="header-link" href="#43" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">beq</span><span class="w"> </span><span class="err">$</span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">분기</span><span class="w"> </span><span class="n">여부</span><span class="w"> </span><span class="n">결정</span>
<span class="k">add</span><span class="w"> </span><span class="err">$</span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">t4</span><span class="w">       </span><span class="err">#</span><span class="w"> </span><span class="n">실행해야</span><span class="w"> </span><span class="n">하나</span><span class="vm">?</span>
<span class="n">sub</span><span class="w"> </span><span class="err">$</span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">t7</span><span class="w">       </span><span class="err">#</span><span class="w"> </span><span class="n">실행해야</span><span class="w"> </span><span class="n">하나</span><span class="vm">?</span>

<span class="nl">시간</span><span class="p">:</span><span class="w">    </span><span class="mi">1</span><span class="w">    </span><span class="mi">2</span><span class="w">    </span><span class="mi">3</span><span class="w">    </span><span class="mi">4</span><span class="w">    </span><span class="mi">5</span>
<span class="nl">beq</span><span class="p">:</span><span class="w">    </span><span class="k">IF</span><span class="w">   </span><span class="n">ID</span><span class="w">  </span><span class="o">[</span><span class="n">EX</span><span class="o">]</span><span class="w"> </span><span class="err">←</span><span class="w"> </span><span class="n">분기</span><span class="w"> </span><span class="n">결정</span>
<span class="k">add</span><span class="err">:</span><span class="w">         </span><span class="k">IF</span><span class="w">   </span><span class="n">ID</span><span class="w">   </span><span class="err">←</span><span class="w"> </span><span class="n">잘못된</span><span class="w"> </span><span class="n">명령어</span><span class="vm">?</span>
<span class="nl">sub</span><span class="p">:</span><span class="w">              </span><span class="k">IF</span><span class="w">   </span><span class="err">←</span><span class="w"> </span><span class="n">잘못된</span><span class="w"> </span><span class="n">명령어</span><span class="vm">?</span>

<span class="n">분기</span><span class="w"> </span><span class="n">결정</span><span class="w"> </span><span class="n">전에</span><span class="w"> </span><span class="n">이미</span><span class="w"> </span><span class="n">다음</span><span class="w"> </span><span class="n">명령어들이</span><span class="w"> </span><span class="n">파이프라인에</span><span class="w"> </span><span class="n">진입</span>
</code></pre></div>

<hr />
<h2 id="5">5. 해저드 해결 기법<a class="header-link" href="#5" title="Permanent link">&para;</a></h2>
<h3 id="51-stalling">5.1 스톨링 (Stalling)<a class="header-link" href="#51-stalling" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>버블<span class="ss">(</span><span class="nv">NOP</span><span class="ss">)</span><span class="w"> </span>삽입으로<span class="w"> </span>파이프라인<span class="w"> </span>일시<span class="w"> </span>정지

<span class="nv">add</span><span class="w"> </span>$<span class="nv">s0</span>,<span class="w"> </span>$<span class="nv">t0</span>,<span class="w"> </span>$<span class="nv">t1</span>
<span class="nv">sub</span><span class="w"> </span>$<span class="nv">t2</span>,<span class="w"> </span>$<span class="nv">s0</span>,<span class="w"> </span>$<span class="nv">t3</span>

시간:<span class="w">    </span><span class="mi">1</span><span class="w">    </span><span class="mi">2</span><span class="w">    </span><span class="mi">3</span><span class="w">    </span><span class="mi">4</span><span class="w">    </span><span class="mi">5</span><span class="w">    </span><span class="mi">6</span><span class="w">    </span><span class="mi">7</span><span class="w">    </span><span class="mi">8</span><span class="w">    </span><span class="mi">9</span>
<span class="nv">add</span>:<span class="w">    </span><span class="k">IF</span><span class="w">   </span><span class="nv">ID</span><span class="w">   </span><span class="nv">EX</span><span class="w">  </span><span class="nv">MEM</span><span class="w">  </span><span class="nv">WB</span>
<span class="w">        </span><span class="o">---</span><span class="w"> </span><span class="nv">stall</span><span class="w"> </span><span class="o">---</span>
<span class="w">        </span><span class="o">---</span><span class="w"> </span><span class="nv">stall</span><span class="w"> </span><span class="o">---</span>
<span class="nv">sub</span>:<span class="w">              </span><span class="k">IF</span><span class="w">   </span><span class="nv">ID</span><span class="w">   </span><span class="nv">EX</span><span class="w">  </span><span class="nv">MEM</span><span class="w">  </span><span class="nv">WB</span>

<span class="mi">2</span><span class="w"> </span>사이클<span class="w"> </span>스톨<span class="w"> </span>발생<span class="w"> </span>→<span class="w"> </span>성능<span class="w"> </span>저하
</code></pre></div>

<h3 id="52">5.2 포워딩/바이패싱<a class="header-link" href="#52" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">ALU</span><span class="w"> </span><span class="n">결과를</span><span class="w"> </span><span class="n">바로</span><span class="w"> </span><span class="n">다음</span><span class="w"> </span><span class="n">명령어에</span><span class="w"> </span><span class="n">전달</span>

<span class="k">add</span><span class="w"> </span><span class="err">$</span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">t1</span>
<span class="n">sub</span><span class="w"> </span><span class="err">$</span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">t3</span>

<span class="nl">시간</span><span class="p">:</span><span class="w">    </span><span class="mi">1</span><span class="w">    </span><span class="mi">2</span><span class="w">    </span><span class="mi">3</span><span class="w">    </span><span class="mi">4</span><span class="w">    </span><span class="mi">5</span><span class="w">    </span><span class="mi">6</span>
<span class="k">add</span><span class="err">:</span><span class="w">    </span><span class="k">IF</span><span class="w">   </span><span class="n">ID</span><span class="w">  </span><span class="o">[</span><span class="n">EX</span><span class="o">]</span><span class="w"> </span><span class="n">MEM</span><span class="w">  </span><span class="n">WB</span>
<span class="w">                  </span><span class="err">│</span>
<span class="w">                  </span><span class="err">└─────▶</span><span class="w"> </span><span class="n">포워딩</span>
<span class="nl">sub</span><span class="p">:</span><span class="w">         </span><span class="k">IF</span><span class="w">   </span><span class="n">ID</span><span class="w">  </span><span class="o">[</span><span class="n">EX</span><span class="o">]</span><span class="w"> </span><span class="n">MEM</span><span class="w">  </span><span class="n">WB</span>
<span class="w">                       </span><span class="err">↑</span>
<span class="w">                    </span><span class="err">$</span><span class="n">s0</span><span class="w"> </span><span class="n">값</span><span class="w"> </span><span class="n">사용</span>

<span class="n">스톨</span><span class="w"> </span><span class="n">없이</span><span class="w"> </span><span class="n">실행</span><span class="w"> </span><span class="n">가능</span><span class="err">!</span>
</code></pre></div>

<h3 id="_11">포워딩 경로<a class="header-link" href="#_11" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────┐
│                    포워딩 유닛                           │
│                                                         │
│   EX/MEM.ALUResult ───────────────┐                     │
│                                   ▼                     │
│   MEM/WB.ALUResult ─────────────▶ MUX ──▶ ALU 입력      │
│                                   ▲                     │
│   ID/EX.RegisterRs ───────────────┘                     │
└─────────────────────────────────────────────────────────┘

포워딩 조건:
1. EX/MEM.RegisterRd == ID/EX.RegisterRs
2. MEM/WB.RegisterRd == ID/EX.RegisterRs
</code></pre></div>

<h3 id="53-load-use">5.3 Load-Use 해저드<a class="header-link" href="#53-load-use" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">포워딩으로도</span><span class="w"> </span><span class="n">해결</span><span class="w"> </span><span class="n">불가능한</span><span class="w"> </span><span class="nl">경우</span><span class="p">:</span>

<span class="n">lw</span><span class="w">  </span><span class="err">$</span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="err">$</span><span class="n">t0</span><span class="p">)</span><span class="w">     </span><span class="err">#</span><span class="w"> </span><span class="n">메모리에서</span><span class="w"> </span><span class="n">로드</span>
<span class="k">add</span><span class="w"> </span><span class="err">$</span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">t3</span><span class="w">   </span><span class="err">#</span><span class="w"> </span><span class="n">바로</span><span class="w"> </span><span class="n">사용</span>

<span class="nl">시간</span><span class="p">:</span><span class="w">    </span><span class="mi">1</span><span class="w">    </span><span class="mi">2</span><span class="w">    </span><span class="mi">3</span><span class="w">    </span><span class="mi">4</span><span class="w">    </span><span class="mi">5</span><span class="w">    </span><span class="mi">6</span><span class="w">    </span><span class="mi">7</span>
<span class="nl">lw</span><span class="p">:</span><span class="w">     </span><span class="k">IF</span><span class="w">   </span><span class="n">ID</span><span class="w">   </span><span class="n">EX</span><span class="w">  </span><span class="o">[</span><span class="n">MEM</span><span class="o">]</span><span class="w"> </span><span class="n">WB</span>
<span class="w">                       </span><span class="err">│</span>
<span class="w">                       </span><span class="err">└───▶</span><span class="w"> </span><span class="n">데이터</span><span class="w"> </span><span class="n">사용</span><span class="w"> </span><span class="n">가능</span>
<span class="k">add</span><span class="err">:</span><span class="w">         </span><span class="k">IF</span><span class="w">   </span><span class="n">ID</span><span class="w">  </span><span class="n">stall</span><span class="w"> </span><span class="o">[</span><span class="n">EX</span><span class="o">]</span><span class="w"> </span><span class="n">MEM</span><span class="w">  </span><span class="n">WB</span>
<span class="w">                   </span><span class="err">↑</span>
<span class="w">              </span><span class="n">데이터</span><span class="w"> </span><span class="n">필요하지만</span><span class="w"> </span><span class="n">아직</span><span class="w"> </span><span class="n">없음</span>

<span class="mi">1</span><span class="w"> </span><span class="n">사이클</span><span class="w"> </span><span class="n">스톨</span><span class="w"> </span><span class="n">필수</span><span class="w"> </span><span class="p">(</span><span class="k">Load</span><span class="o">-</span><span class="k">Use</span><span class="w"> </span><span class="n">Stall</span><span class="p">)</span>
</code></pre></div>

<h3 id="54">5.4 분기 예측<a class="header-link" href="#54" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>정적 예측:
- 항상 Not Taken: 분기 안 함으로 예측
- 항상 Taken: 분기 함으로 예측
- BTFN: 뒤로 가면 Taken, 앞으로 가면 Not Taken

동적 예측:
- 분기 기록을 기반으로 예측
- 다음 레슨에서 상세히 다룸
</code></pre></div>

<h3 id="55-delayed-branch">5.5 지연 분기 (Delayed Branch)<a class="header-link" href="#55-delayed-branch" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>분기 명령어 다음 슬롯에 항상 실행되는 명령어 배치

beq $t0, $t1, target
add $t2, $t3, $t4    # 지연 슬롯 (항상 실행)
...
target:
sub $t5, $t6, $t7

컴파일러가 분기와 무관한 명령어를 지연 슬롯에 배치
</code></pre></div>

<hr />
<h2 id="6">6. 연습 문제<a class="header-link" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="_12">기초 문제<a class="header-link" href="#_12" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>5단계 파이프라인의 각 단계 이름과 역할은?</p>
</li>
<li>
<p>100개 명령어를 5단계 파이프라인에서 실행할 때 필요한 사이클 수는? (해저드 없다고 가정)</p>
</li>
<li>
<p>다음 중 데이터 해저드의 유형이 아닌 것은?</p>
</li>
<li>(a) RAW</li>
<li>(b) RAR</li>
<li>(c) WAR</li>
<li>(d) WAW</li>
</ol>
<h3 id="_13">해저드 분석<a class="header-link" href="#_13" title="Permanent link">&para;</a></h3>
<ol>
<li>다음 코드에서 데이터 해저드를 찾으시오:</li>
</ol>
<div class="highlight"><pre><span></span><code>add $s0, $t0, $t1
sub $s1, $s0, $t2
and $s2, $s0, $s1
</code></pre></div>

<ol>
<li>포워딩으로 해결할 수 없는 해저드는?</li>
</ol>
<div class="highlight"><pre><span></span><code>lw  $s0, 0($t0)
add $t1, $s0, $t2
</code></pre></div>

<h3 id="_14">성능 계산<a class="header-link" href="#_14" title="Permanent link">&para;</a></h3>
<ol>
<li>1000개 명령어 중 30%가 분기이고, 분기 예측 실패율이 20%이며, 실패 시 3 사이클 페널티가 있다면 CPI는?</li>
</ol>
<details>
<summary>정답</summary>

1. IF(인출), ID(해독), EX(실행), MEM(메모리접근), WB(쓰기)

2. 5 + (100 - 1) = 104 사이클

3. (b) RAR - Read After Read는 해저드가 아님

4.
- add → sub: $s0에 대한 RAW
- add → and: $s0에 대한 RAW
- sub → and: $s1에 대한 RAW

5. Load-Use 해저드. lw의 MEM 단계 이후에야 데이터 사용 가능하므로 1 사이클 스톨 필요

6.
- 분기 명령어 수: 1000 × 0.3 = 300
- 예측 실패: 300 × 0.2 = 60
- 페널티 사이클: 60 × 3 = 180
- CPI = 1 + 180/1000 = 1.18

</details>

<hr />
<h2 id="_15">다음 단계<a class="header-link" href="#_15" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="./12_Branch_Prediction.md">12_Branch_Prediction.md</a> - 동적 분기 예측 기법</li>
</ul>
<hr />
<h2 id="_16">참고 자료<a class="header-link" href="#_16" title="Permanent link">&para;</a></h2>
<ul>
<li>Computer Organization and Design, Chapter 4 (Patterson &amp; Hennessy)</li>
<li><a href="https://www.youtube.com/watch?v=eVRdfl4zxfI">Pipeline Visualization</a></li>
<li><a href="http://www.cs.umd.edu/~meesh/411/mips-pipe/">MIPS Pipeline Simulator</a></li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Computer_Architecture/10_Assembly_Language_Basics.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">어셈블리 언어 기초</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">🔗</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Computer_Architecture/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">📋</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Computer_Architecture/12_Branch_Prediction.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">분기 예측 (Branch Prediction)</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">↑</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'ko';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}