{% raw %}
<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>데이터베이스 설계 사례 연구 - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/ko/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/ko/" class="nav-item ">
                    <span class="nav-icon">🏠</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">💻</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/ko/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" >
                        English
                    </option>
                    
                    <option value="ko" selected>
                        한국어
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">☀️</span>
                    <span class="theme-icon dark">🌙</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/ko/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/ko/Database_Theory/">Database Theory</a>
    <span class="separator">/</span>
    <span class="current">데이터베이스 설계 사례 연구</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>데이터베이스 설계 사례 연구</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Database_Theory/15_NewSQL_and_Modern_Trends.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">NewSQL과 현대 트렌드</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">🔗</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Database_Theory/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">📋</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#_2">목차</a></li>
<li><a href="#1">1. 설계 라이프사이클 개요</a></li>
<li><a href="#2-1">2. 단계 1: 요구사항 분석</a><ul>
<li><a href="#21">2.1 비즈니스 맥락</a></li>
<li><a href="#22">2.2 기능 요구사항</a></li>
<li><a href="#23">2.3 데이터 요구사항</a></li>
<li><a href="#24">2.4 물량 분석</a></li>
<li><a href="#25">2.5 쿼리 패턴</a></li>
<li><a href="#26">2.6 비기능 요구사항</a></li>
</ul>
</li>
<li><a href="#3-2-er">3. 단계 2: 개념적 설계 (ER 다이어그램)</a><ul>
<li><a href="#31">3.1 엔티티 식별</a></li>
<li><a href="#32-er">3.2 ER 다이어그램</a></li>
<li><a href="#33">3.3 카디널리티 요약</a></li>
</ul>
</li>
<li><a href="#4-3">4. 단계 3: 논리적 설계 (관계형 스키마)</a><ul>
<li><a href="#41-er">4.1 ER에서 관계형으로 매핑</a></li>
<li><a href="#42-ddl">4.2 완전한 DDL</a></li>
<li><a href="#43">4.3 정규화 검증</a></li>
<li><a href="#44">4.4 참조 무결성 요약</a></li>
</ul>
</li>
<li><a href="#5-4">5. 단계 4: 물리적 설계</a><ul>
<li><a href="#51">5.1 인덱싱 전략</a></li>
<li><a href="#52">5.2 파티셔닝 전략</a></li>
<li><a href="#53">5.3 비정규화 결정</a></li>
<li><a href="#54">5.4 저장소 고려사항</a></li>
</ul>
</li>
<li><a href="#6-5">6. 단계 5: 쿼리 최적화</a><ul>
<li><a href="#61-qp-01">6.1 제품 검색 (QP-01)</a></li>
<li><a href="#62-qp-02">6.2 제품 상세 페이지 (QP-02)</a></li>
<li><a href="#63-qp-05">6.3 주문 이력 (QP-05)</a></li>
<li><a href="#64-qp-06">6.4 판매자 대시보드 (QP-06)</a></li>
<li><a href="#65">6.5 쿼리 성능 요약</a></li>
</ul>
</li>
<li><a href="#7-6">7. 단계 6: 트랜잭션 설계</a><ul>
<li><a href="#71">7.1 중요 트랜잭션: 주문 생성</a></li>
<li><a href="#72">7.2 격리 수준 결정</a></li>
<li><a href="#73">7.3 잠금 전략</a></li>
<li><a href="#74">7.4 동시성 시나리오</a></li>
</ul>
</li>
<li><a href="#8">8. 대안 사례 연구: 소셜 미디어 플랫폼</a><ul>
<li><a href="#81">8.1 요구사항 요약</a></li>
<li><a href="#82">8.2 주요 엔티티</a></li>
<li><a href="#83">8.3 피드 문제</a></li>
<li><a href="#84">8.4 설계 트레이드오프</a></li>
</ul>
</li>
<li><a href="#9">9. 설계 검토 체크리스트</a><ul>
<li><a href="#91">9.1 스키마 설계</a></li>
<li><a href="#92">9.2 인덱싱</a></li>
<li><a href="#93">9.3 데이터 무결성</a></li>
<li><a href="#94">9.4 성능</a></li>
<li><a href="#95">9.5 트랜잭션</a></li>
<li><a href="#96">9.6 보안</a></li>
<li><a href="#97">9.7 운영</a></li>
</ul>
</li>
<li><a href="#10">10. 일반적인 설계 실수 및 회피 방법</a><ul>
<li><a href="#1-float">실수 1: 돈에 FLOAT 사용</a></li>
<li><a href="#2">실수 2: 외래 키 인덱스 누락</a></li>
<li><a href="#3">실수 3: 유지보수 전략 없이 파생 데이터 저장</a></li>
<li><a href="#4-offset">실수 4: OFFSET 기반 페이지네이션</a></li>
<li><a href="#5-eav">실수 5: 신 테이블 (EAV 안티패턴)</a></li>
<li><a href="#6">실수 6: 과거 데이터 캡처하지 않음</a></li>
<li><a href="#7">실수 7: 조기 비정규화</a></li>
<li><a href="#8-null">실수 8: NULL 의미론 무시</a></li>
<li><a href="#9_1">실수 9: 쉼표로 구분된 값 저장</a></li>
<li><a href="#10_1">실수 10: 스키마 진화 계획하지 않음</a></li>
</ul>
</li>
<li><a href="#11">11. 연습 문제</a><ul>
<li><a href="#1_1">연습 문제 1: 전자상거래 스키마 완성</a></li>
<li><a href="#2_1">연습 문제 2: 정규화 분석</a></li>
<li><a href="#3_1">연습 문제 3: 인덱스 설계 도전</a></li>
<li><a href="#4">연습 문제 4: 트랜잭션 설계</a></li>
<li><a href="#5">연습 문제 5: 자신만의 데이터베이스 설계</a></li>
<li><a href="#6_1">연습 문제 6: 이 설계 비평</a></li>
<li><a href="#7_1">연습 문제 7: 전자상거래 설계 확장</a></li>
<li><a href="#8_1">연습 문제 8: 소셜 미디어 피드 설계</a></li>
<li><a href="#9_2">연습 문제 9: 마이그레이션 계획</a></li>
<li><a href="#10_2">연습 문제 10: 설계 검토</a></li>
</ul>
</li>
<li><a href="#12">12. 참고문헌</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="_1">데이터베이스 설계 사례 연구<a class="header-link" href="#_1" title="Permanent link">&para;</a></h1>
<p><strong>이전</strong>: <a href="./15_NewSQL_and_Modern_Trends.md">15. NewSQL과 현대 트렌드</a></p>
<hr />
<p>이 종합 레슨은 앞선 15개 레슨의 모든 내용을 포괄적이고 종단간 데이터베이스 설계 연습으로 통합합니다. 요구사항 수집부터 최적화된 쿼리 작성까지 전자상거래 플랫폼의 완전한 설계 라이프사이클을 안내하며, ER 모델링, 정규화, 인덱싱, 트랜잭션 및 동시성 제어의 이론을 현실적인 시나리오에 적용합니다. 두 번째 미니 사례 연구(소셜 미디어 플랫폼)는 추가 연습을 제공하며, 레슨은 설계 검토 체크리스트와 일반적인 실수 카탈로그로 마무리됩니다.</p>
<p><strong>난이도</strong>: ⭐⭐⭐⭐</p>
<p><strong>학습 목표</strong>:
- 데이터베이스 시스템에 대한 요구사항 분석 수행
- 비즈니스 요구사항에서 완전한 ER 다이어그램 생성
- ER 모델을 관계형 스키마로 매핑하고 BCNF로 정규화
- 물리적 설계에 대한 정보에 입각한 결정 (인덱싱, 파티셔닝, 비정규화)
- 쿼리 플랜 분석 및 최적화 기술 적용
- 적절한 격리 수준으로 트랜잭션 전략 설계
- 설계 트레이드오프 평가 및 결정 문서화
- 일반적인 데이터베이스 설계 실수를 인식하고 회피</p>
<hr />
<h2 id="_2">목차<a class="header-link" href="#_2" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-설계-라이프사이클-개요">설계 라이프사이클 개요</a></li>
<li><a href="#2-단계-1-요구사항-분석">단계 1: 요구사항 분석</a></li>
<li><a href="#3-단계-2-개념적-설계-er-다이어그램">단계 2: 개념적 설계 (ER 다이어그램)</a></li>
<li><a href="#4-단계-3-논리적-설계-관계형-스키마">단계 3: 논리적 설계 (관계형 스키마)</a></li>
<li><a href="#5-단계-4-물리적-설계">단계 4: 물리적 설계</a></li>
<li><a href="#6-단계-5-쿼리-최적화">단계 5: 쿼리 최적화</a></li>
<li><a href="#7-단계-6-트랜잭션-설계">단계 6: 트랜잭션 설계</a></li>
<li><a href="#8-대안-사례-연구-소셜-미디어-플랫폼">대안 사례 연구: 소셜 미디어 플랫폼</a></li>
<li><a href="#9-설계-검토-체크리스트">설계 검토 체크리스트</a></li>
<li><a href="#10-일반적인-설계-실수-및-회피-방법">일반적인 설계 실수 및 회피 방법</a></li>
<li><a href="#11-연습-문제">연습 문제</a></li>
<li><a href="#12-참고문헌">참고문헌</a></li>
</ol>
<hr />
<h2 id="1">1. 설계 라이프사이클 개요<a class="header-link" href="#1" title="Permanent link">&para;</a></h2>
<p>데이터베이스 설계는 일회성 프로세스가 아닙니다. 피드백 루프가 있는 구조화된 라이프사이클을 따릅니다:</p>
<div class="highlight"><pre><span></span><code>┌──────────────────────────────────────────────────────────────┐
│                    데이터베이스 설계 라이프사이클              │
│                                                              │
│  단계 1            단계 2            단계 3                  │
│  요구사항     ──▶  개념적       ──▶  논리적                  │
│  분석               설계 (ER)        설계 (관계형)           │
│                                                              │
│       │                                    │                 │
│       │              ┌─────────────────────┘                 │
│       │              │                                       │
│       │              ▼                                       │
│       │         단계 4            단계 5                      │
│       │         물리적       ──▶  쿼리                        │
│       └────────▶설계              최적화                      │
│                                                              │
│                      │                 │                      │
│                      ▼                 ▼                      │
│                 단계 6                                        │
│                 트랜잭션 설계                                 │
│                                                              │
│                      │                                       │
│                      ▼                                       │
│              배포, 모니터링, 반복                             │
└──────────────────────────────────────────────────────────────┘
</code></pre></div>

<p>각 단계는 다음 단계로 전달되는 산출물을 생성합니다:</p>
<table>
<thead>
<tr>
<th>단계</th>
<th>입력</th>
<th>출력</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>1. 요구사항</strong></td>
<td>비즈니스 요구, 인터뷰</td>
<td>기능 및 데이터 요구사항</td>
</tr>
<tr>
<td><strong>2. 개념적</strong></td>
<td>요구사항</td>
<td>ER 다이어그램</td>
</tr>
<tr>
<td><strong>3. 논리적</strong></td>
<td>ER 다이어그램</td>
<td>정규화된 관계형 스키마 (DDL)</td>
</tr>
<tr>
<td><strong>4. 물리적</strong></td>
<td>관계형 스키마 + 쿼리 패턴</td>
<td>인덱스, 파티션, 비정규화</td>
</tr>
<tr>
<td><strong>5. 쿼리</strong></td>
<td>물리적 스키마 + 일반 쿼리</td>
<td>실행 계획이 있는 최적화된 쿼리</td>
</tr>
<tr>
<td><strong>6. 트랜잭션</strong></td>
<td>비즈니스 규칙 + 동시성 요구</td>
<td>격리 수준, 잠금 전략</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2-1">2. 단계 1: 요구사항 분석<a class="header-link" href="#2-1" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 비즈니스 맥락<a class="header-link" href="#21" title="Permanent link">&para;</a></h3>
<p>물리적 제품을 판매하는 온라인 전자상거래 플랫폼인 <strong>ShopWave</strong>의 데이터베이스를 설계하고 있습니다. 플랫폼은 여러 판매자, 제품 리뷰, 프로모션 및 표준 체크아웃 흐름을 지원합니다.</p>
<h3 id="22">2.2 기능 요구사항<a class="header-link" href="#22" title="Permanent link">&para;</a></h3>
<p>이해관계자와의 인터뷰 후, 다음과 같은 주요 비즈니스 기능을 식별합니다:</p>
<div class="highlight"><pre><span></span><code>FR-01: 고객 등록 및 인증
FR-02: 검색 및 필터링이 있는 제품 카탈로그 탐색
FR-03: 이미지, 사양 및 리뷰가 있는 제품 상세 페이지
FR-04: 장바구니 관리 (추가, 제거, 수량 업데이트)
FR-05: 여러 결제 방법으로 체크아웃
FR-06: 주문 추적 (주문부터 배송까지 상태 업데이트)
FR-07: 판매자 관리 (판매자가 제품을 나열하고 재고 관리)
FR-08: 제품 리뷰 및 평가 (1-5점, 텍스트 리뷰)
FR-09: 프로모션 및 할인 코드
FR-10: 위시리스트 (고객이 나중에 제품 저장)
FR-11: 주소 관리 (고객당 여러 배송 주소)
FR-12: 계층이 있는 제품 카테고리 (예: 전자제품 &gt; 전화기 &gt; 스마트폰)
</code></pre></div>

<h3 id="23">2.3 데이터 요구사항<a class="header-link" href="#23" title="Permanent link">&para;</a></h3>
<p>기능 요구사항에서 데이터 엔티티와 주요 속성을 추출합니다:</p>
<div class="highlight"><pre><span></span><code>DR-01: 고객
  - 이름, 이메일, 비밀번호 해시, 전화번호, 등록 날짜
  - 여러 배송 주소
  - 하나 이상의 결제 방법

DR-02: 제품
  - 이름, 설명, SKU, 가격, 무게, 치수
  - 여러 이미지 (URL)
  - 하나 이상의 카테고리에 속함
  - 정확히 한 판매자가 나열
  - 재고 수량 (재고)

DR-03: 카테고리
  - 이름, 설명
  - 계층적 (부모-자식 관계)

DR-04: 주문
  - 고객, 배송 주소, 주문 날짜, 상태
  - 하나 이상의 주문 항목 (제품, 수량, 주문 시점의 단가)
  - 결제 정보
  - 배송 방법 및 추적 번호

DR-05: 리뷰
  - 고객, 제품, 평가 (1-5), 텍스트, 날짜
  - 각 고객은 제품당 최대 한 번 리뷰 가능

DR-06: 판매자
  - 회사명, 연락처 이메일, 수수료율
  - 지급을 위한 은행 계좌

DR-07: 프로모션
  - 코드, 할인 유형 (백분율/고정), 금액, 유효 날짜
  - 특정 제품, 카테고리 또는 사이트 전체에 적용 가능
  - 사용 제한 (총 및 고객당)
</code></pre></div>

<h3 id="24">2.4 물량 분석<a class="header-link" href="#24" title="Permanent link">&para;</a></h3>
<p>데이터 볼륨 이해는 물리적 설계 결정에 도움이 됩니다:</p>
<table>
<thead>
<tr>
<th>엔티티</th>
<th>예상 볼륨</th>
<th>성장률</th>
</tr>
</thead>
<tbody>
<tr>
<td>고객</td>
<td>1백만</td>
<td>50K/월</td>
</tr>
<tr>
<td>제품</td>
<td>500,000</td>
<td>10K/월</td>
</tr>
<tr>
<td>주문</td>
<td>1천만</td>
<td>500K/월</td>
</tr>
<tr>
<td>주문 항목</td>
<td>2천5백만</td>
<td>1.25M/월</td>
</tr>
<tr>
<td>리뷰</td>
<td>2백만</td>
<td>100K/월</td>
</tr>
<tr>
<td>카테고리</td>
<td>1,000</td>
<td>거의 변경 없음</td>
</tr>
<tr>
<td>판매자</td>
<td>5,000</td>
<td>200/월</td>
</tr>
<tr>
<td>프로모션</td>
<td>한 번에 500개 활성</td>
<td>계절별 피크</td>
</tr>
</tbody>
</table>
<h3 id="25">2.5 쿼리 패턴<a class="header-link" href="#25" title="Permanent link">&para;</a></h3>
<p>가장 빈번하고 중요한 쿼리를 식별합니다:</p>
<div class="highlight"><pre><span></span><code>QP-01: [높은 빈도] 키워드 + 카테고리 + 가격 범위로 제품 검색
QP-02: [높은 빈도] 제품 상세 페이지 (제품 + 이미지 + 리뷰 + 판매자)
QP-03: [높은 빈도] 고객의 장바구니 내용
QP-04: [중요]  주문 생성 (재고 감소, 주문 + 항목 생성)
QP-05: [높은 빈도] 고객의 주문 이력 (상태 포함)
QP-06: [중간]    판매자 대시보드 (주문, 수익, 재고)
QP-07: [중간]    카테고리에서 최고 평가 제품
QP-08: [낮은 빈도]  관리자: 카테고리, 날짜 범위별 판매 보고서
QP-09: [중요]  프로모션 코드 적용 (검증, 할인 계산)
QP-10: [높은 빈도] 고객 위시리스트 표시
</code></pre></div>

<h3 id="26">2.6 비기능 요구사항<a class="header-link" href="#26" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>NFR-01: 응답 시간: 읽기 쿼리 &lt; 200ms, 쓰기 &lt; 500ms
NFR-02: 가용성: 99.9% 가동 시간
NFR-03: 데이터 내구성: 주문 및 결제에 대한 데이터 손실 없음
NFR-04: 동시성: 10,000명의 동시 사용자 지원
NFR-05: 확장성: 3년간 10배 성장 처리
NFR-06: 보안: 결제 데이터에 대한 PCI-DSS 준수
</code></pre></div>

<hr />
<h2 id="3-2-er">3. 단계 2: 개념적 설계 (ER 다이어그램)<a class="header-link" href="#3-2-er" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 엔티티 식별<a class="header-link" href="#31" title="Permanent link">&para;</a></h3>
<p>데이터 요구사항에서 다음 엔티티를 식별합니다:</p>
<div class="highlight"><pre><span></span><code>강한 엔티티:           약한 엔티티:            연관 엔티티:
├── Customer            ├── OrderItem          ├── Review
├── Product             ├── CartItem           ├── ProductCategory
├── Category            ├── ProductImage       ├── WishlistItem
├── Order               └── Address            └── PromotionUsage
├── Seller
├── Promotion
├── Cart
└── PaymentMethod
</code></pre></div>

<h3 id="32-er">3.2 ER 다이어그램<a class="header-link" href="#32-er" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="w">                                    </span><span class="err">┌──────────────┐</span>
<span class="w">                              </span><span class="err">┌─────│</span><span class="w">   </span><span class="nx">Category</span><span class="w">   </span><span class="err">│─────┐</span>
<span class="w">                              </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="nx">id</span><span class="w">           </span><span class="err">│</span><span class="w">     </span><span class="err">│</span>
<span class="w">                              </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="nx">name</span><span class="w">         </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="nx">parent_id</span>
<span class="w">                              </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="nx">description</span><span class="w">  </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="p">(</span><span class="kp">self</span><span class="o">-</span><span class="nx">ref</span><span class="p">)</span>
<span class="w">                              </span><span class="err">│</span><span class="w">     </span><span class="err">└──────────────┘─────┘</span>
<span class="w">                              </span><span class="err">│</span><span class="w">           </span><span class="err">│</span>
<span class="w">                              </span><span class="err">│</span><span class="w">     </span><span class="err">┌─────┴──────┐</span>
<span class="w">                              </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="nx">Product</span><span class="w">     </span><span class="err">│</span>
<span class="w">                              </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="nx">Category</span><span class="w">    </span><span class="err">│</span>
<span class="w">                              </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="p">(</span><span class="nx">M</span><span class="p">:</span><span class="nx">N</span><span class="p">)</span><span class="w">       </span><span class="err">│</span>
<span class="w">                              </span><span class="err">│</span><span class="w">     </span><span class="err">└─────┬──────┘</span>
<span class="w">                              </span><span class="err">│</span><span class="w">           </span><span class="err">│</span>
<span class="err">┌──────────────┐</span><span class="w">        </span><span class="err">┌─────┴──────────┴──┐</span><span class="w">        </span><span class="err">┌──────────────┐</span>
<span class="err">│</span><span class="w">   </span><span class="nx">Seller</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="mi">1</span><span class="w">   </span><span class="nx">M</span><span class="w">  </span><span class="err">│</span><span class="w">     </span><span class="nx">Product</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="mi">1</span><span class="w">   </span><span class="nx">M</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">ProductImage</span><span class="w"> </span><span class="err">│</span>
<span class="err">│</span><span class="w"> </span><span class="nx">id</span><span class="w">           </span><span class="err">│────────│</span><span class="w"> </span><span class="nx">id</span><span class="w">                </span><span class="err">│────────│</span><span class="w"> </span><span class="nx">id</span><span class="w">           </span><span class="err">│</span>
<span class="err">│</span><span class="w"> </span><span class="nx">company_name</span><span class="w"> </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">name</span><span class="w">              </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">product_id</span><span class="w">   </span><span class="err">│</span>
<span class="err">│</span><span class="w"> </span><span class="nx">email</span><span class="w">        </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">description</span><span class="w">       </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">url</span><span class="w">          </span><span class="err">│</span>
<span class="err">│</span><span class="w"> </span><span class="nx">commission</span><span class="w">   </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">sku</span><span class="w">               </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">alt_text</span><span class="w">     </span><span class="err">│</span>
<span class="err">│</span><span class="w"> </span><span class="nx">bank_account</span><span class="w"> </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">price</span><span class="w">             </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">position</span><span class="w">     </span><span class="err">│</span>
<span class="err">└──────────────┘</span><span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">weight</span><span class="w">            </span><span class="err">│</span><span class="w">        </span><span class="err">└──────────────┘</span>
<span class="w">                        </span><span class="err">│</span><span class="w"> </span><span class="nx">stock_quantity</span><span class="w">    </span><span class="err">│</span>
<span class="w">                        </span><span class="err">│</span><span class="w"> </span><span class="nx">seller_id</span><span class="w"> </span><span class="p">(</span><span class="nx">FK</span><span class="p">)</span><span class="w">    </span><span class="err">│</span>
<span class="w">                        </span><span class="err">└────────┬──────────┘</span>
<span class="w">                                 </span><span class="err">│</span>
<span class="w">              </span><span class="err">┌──────────────────┼──────────────────┐</span>
<span class="w">              </span><span class="err">│</span><span class="w">                  </span><span class="err">│</span><span class="w">                  </span><span class="err">│</span>
<span class="w">        </span><span class="err">┌─────┴──────┐</span><span class="w">   </span><span class="err">┌──────┴──────┐</span><span class="w">   </span><span class="err">┌──────┴──────┐</span>
<span class="w">        </span><span class="err">│</span><span class="w">  </span><span class="nx">Review</span><span class="w">    </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="nx">WishlistItem</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="nx">CartItem</span><span class="w">   </span><span class="err">│</span>
<span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">id</span><span class="w">         </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nx">id</span><span class="w">           </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nx">id</span><span class="w">          </span><span class="err">│</span>
<span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">customer_id</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nx">customer_id</span><span class="w">  </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nx">cart_id</span><span class="w">     </span><span class="err">│</span>
<span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">product_id</span><span class="w"> </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nx">product_id</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nx">product_id</span><span class="w">  </span><span class="err">│</span>
<span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">rating</span><span class="w">     </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nx">added_at</span><span class="w">     </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nx">quantity</span><span class="w">    </span><span class="err">│</span>
<span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">text</span><span class="w">       </span><span class="err">│</span><span class="w">   </span><span class="err">└─────────────┘</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nx">added_at</span><span class="w">    </span><span class="err">│</span>
<span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">created_at</span><span class="w"> </span><span class="err">│</span><span class="w">                      </span><span class="err">└──────┬──────┘</span>
<span class="w">        </span><span class="err">└─────┬──────┘</span><span class="w">                             </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w">                                    </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w">                              </span><span class="err">┌─────┴──────┐</span>
<span class="w">              </span><span class="err">│</span><span class="w">                              </span><span class="err">│</span><span class="w">    </span><span class="nx">Cart</span><span class="w">     </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w">                              </span><span class="err">│</span><span class="w"> </span><span class="nx">id</span><span class="w">          </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w">                              </span><span class="err">│</span><span class="w"> </span><span class="nx">customer_id</span><span class="w"> </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w">                              </span><span class="err">│</span><span class="w"> </span><span class="nx">created_at</span><span class="w">  </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w">                              </span><span class="err">└─────┬──────┘</span>
<span class="w">              </span><span class="err">│</span><span class="w">                                    </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w">                                    </span><span class="err">│</span>
<span class="w">        </span><span class="err">┌─────┴──────────────────────────────────┴──┐</span>
<span class="w">        </span><span class="err">│</span><span class="w">              </span><span class="nx">Customer</span><span class="w">                      </span><span class="err">│</span>
<span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">id</span><span class="w">                                         </span><span class="err">│</span>
<span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">email</span><span class="w">                                      </span><span class="err">│</span>
<span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">password_hash</span><span class="w">                              </span><span class="err">│</span>
<span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">first_name</span><span class="p">,</span><span class="w"> </span><span class="nx">last_name</span><span class="w">                      </span><span class="err">│</span>
<span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">phone</span><span class="w">                                      </span><span class="err">│</span>
<span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="nx">created_at</span><span class="w">                                 </span><span class="err">│</span>
<span class="w">        </span><span class="err">└────────────┬─────────────┬────────────────┘</span>
<span class="w">                     </span><span class="err">│</span><span class="w">             </span><span class="err">│</span>
<span class="w">              </span><span class="err">┌──────┴──────┐</span><span class="w"> </span><span class="err">┌───┴────────────┐</span>
<span class="w">              </span><span class="err">│</span><span class="w">   </span><span class="nx">Address</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">PaymentMethod</span><span class="w">  </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">id</span><span class="w">          </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">id</span><span class="w">             </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">customer_id</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">customer_id</span><span class="w">    </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">label</span><span class="w">       </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="k">type</span><span class="w">           </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">street</span><span class="w">      </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">last_four</span><span class="w">      </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">city</span><span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">token</span><span class="w">          </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">state</span><span class="w">       </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">is_default</span><span class="w">     </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">zip_code</span><span class="w">    </span><span class="err">│</span><span class="w"> </span><span class="err">└────────────────┘</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">country</span><span class="w">     </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">is_default</span><span class="w">  </span><span class="err">│</span>
<span class="w">              </span><span class="err">└──────┬──────┘</span>
<span class="w">                     </span><span class="err">│</span>
<span class="w">              </span><span class="err">┌──────┴──────────────────────────────┐</span>
<span class="w">              </span><span class="err">│</span><span class="w">              </span><span class="nx">Order</span><span class="w">                    </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">id</span><span class="w">                                   </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">customer_id</span><span class="w">                          </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">shipping_address_id</span><span class="w">                  </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">payment_method_id</span><span class="w">                    </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">status</span><span class="w">                               </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">subtotal</span><span class="p">,</span><span class="w"> </span><span class="nx">discount</span><span class="p">,</span><span class="w"> </span><span class="nx">tax</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="w">       </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">promotion_id</span><span class="w"> </span><span class="p">(</span><span class="nx">nullable</span><span class="p">)</span><span class="w">              </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">tracking_number</span><span class="w">                      </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">created_at</span><span class="p">,</span><span class="w"> </span><span class="nx">updated_at</span><span class="w">               </span><span class="err">│</span>
<span class="w">              </span><span class="err">└──────────┬──────────────────────────┘</span>
<span class="w">                         </span><span class="err">│</span>
<span class="w">              </span><span class="err">┌──────────┴──────────┐</span>
<span class="w">              </span><span class="err">│</span><span class="w">     </span><span class="nx">OrderItem</span><span class="w">       </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">id</span><span class="w">                  </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">order_id</span><span class="w">            </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">product_id</span><span class="w">          </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">quantity</span><span class="w">            </span><span class="err">│</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">unit_price</span><span class="w">          </span><span class="err">│</span><span class="w"> </span><span class="err">←</span><span class="w"> </span><span class="nx">주문</span><span class="w"> </span><span class="nx">시점의</span><span class="w"> </span><span class="nx">가격</span>
<span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="nx">subtotal</span><span class="w">            </span><span class="err">│</span><span class="w">   </span><span class="p">(</span><span class="nx">현재</span><span class="w"> </span><span class="nx">가격이</span><span class="w"> </span><span class="nx">아님</span><span class="p">!)</span>
<span class="w">              </span><span class="err">└─────────────────────┘</span>

<span class="err">┌──────────────┐</span>
<span class="err">│</span><span class="w">  </span><span class="nx">Promotion</span><span class="w">   </span><span class="err">│</span>
<span class="err">│</span><span class="w"> </span><span class="nx">id</span><span class="w">           </span><span class="err">│</span>
<span class="err">│</span><span class="w"> </span><span class="nx">code</span><span class="w">         </span><span class="err">│</span>
<span class="err">│</span><span class="w"> </span><span class="nx">discount_type</span><span class="err">│</span><span class="w">  </span><span class="p">(</span><span class="nx">percentage</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">fixed_amount</span><span class="p">)</span>
<span class="err">│</span><span class="w"> </span><span class="nx">amount</span><span class="w">       </span><span class="err">│</span>
<span class="err">│</span><span class="w"> </span><span class="nx">min_purchase</span><span class="w"> </span><span class="err">│</span>
<span class="err">│</span><span class="w"> </span><span class="nx">max_uses</span><span class="w">     </span><span class="err">│</span>
<span class="err">│</span><span class="w"> </span><span class="nx">uses_count</span><span class="w">   </span><span class="err">│</span>
<span class="err">│</span><span class="w"> </span><span class="nx">valid_from</span><span class="w">   </span><span class="err">│</span>
<span class="err">│</span><span class="w"> </span><span class="nx">valid_until</span><span class="w">  </span><span class="err">│</span>
<span class="err">│</span><span class="w"> </span><span class="nx">is_active</span><span class="w">    </span><span class="err">│</span>
<span class="err">└──────────────┘</span>
</code></pre></div>

<h3 id="33">3.3 카디널리티 요약<a class="header-link" href="#33" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>관계</th>
<th>카디널리티</th>
<th>참여</th>
</tr>
</thead>
<tbody>
<tr>
<td>Customer -- Address</td>
<td>1:M</td>
<td>전체 (주문을 위해 최소 하나의 주소 필요)</td>
</tr>
<tr>
<td>Customer -- PaymentMethod</td>
<td>1:M</td>
<td>부분 (결제 방법 없이 등록 가능)</td>
</tr>
<tr>
<td>Customer -- Order</td>
<td>1:M</td>
<td>부분</td>
</tr>
<tr>
<td>Customer -- Review</td>
<td>1:M</td>
<td>부분</td>
</tr>
<tr>
<td>Customer -- Cart</td>
<td>1:1</td>
<td>부분</td>
</tr>
<tr>
<td>Customer -- WishlistItem</td>
<td>1:M</td>
<td>부분</td>
</tr>
<tr>
<td>Order -- OrderItem</td>
<td>1:M</td>
<td>전체 (주문은 최소 하나의 항목 필요)</td>
</tr>
<tr>
<td>Product -- ProductImage</td>
<td>1:M</td>
<td>부분 (이미지 선택사항)</td>
</tr>
<tr>
<td>Product -- Review</td>
<td>1:M</td>
<td>부분</td>
</tr>
<tr>
<td>Product -- Category</td>
<td>M:N</td>
<td>전체 (제품은 최소 하나의 카테고리에 있어야 함)</td>
</tr>
<tr>
<td>Seller -- Product</td>
<td>1:M</td>
<td>전체</td>
</tr>
<tr>
<td>Category -- Category (self)</td>
<td>1:M</td>
<td>부분 (루트 카테고리는 부모 없음)</td>
</tr>
<tr>
<td>Order -- Promotion</td>
<td>M:1</td>
<td>부분 (주문에 프로모션이 없을 수 있음)</td>
</tr>
<tr>
<td>Customer + Product -- Review</td>
<td>고유 (고객당 제품당 하나의 리뷰)</td>
<td></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="4-3">4. 단계 3: 논리적 설계 (관계형 스키마)<a class="header-link" href="#4-3" title="Permanent link">&para;</a></h2>
<h3 id="41-er">4.1 ER에서 관계형으로 매핑<a class="header-link" href="#41-er" title="Permanent link">&para;</a></h3>
<p><a href="./04_ER_Modeling.md">레슨 4</a>의 표준 매핑 규칙을 적용합니다:</p>
<p><strong>규칙 1: 강한 엔티티는 테이블이 됩니다.</strong>
<strong>규칙 2: 약한 엔티티는 소유자의 PK가 PK의 일부 또는 FK로 테이블이 됩니다.</strong>
<strong>규칙 3: 1:M 관계는 "다(many)" 측에 FK가 됩니다.</strong>
<strong>규칙 4: M:N 관계는 접합 테이블이 됩니다.</strong></p>
<h3 id="42-ddl">4.2 완전한 DDL<a class="header-link" href="#42-ddl" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- ============================================================</span>
<span class="c1">-- 고객 및 인증</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">email</span><span class="w">           </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">password_hash</span><span class="w">   </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">first_name</span><span class="w">      </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">last_name</span><span class="w">       </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">phone</span><span class="w">           </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">addresses</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">label</span><span class="w">           </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;Home&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">-- &#39;Home&#39;, &#39;Work&#39;, etc.</span>
<span class="w">    </span><span class="n">street_line1</span><span class="w">    </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">street_line2</span><span class="w">    </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<span class="w">    </span><span class="n">city</span><span class="w">            </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">state</span><span class="w">           </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">zip_code</span><span class="w">        </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">country</span><span class="w">         </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">    </span><span class="c1">-- ISO 3166-1 alpha-2</span>
<span class="w">    </span><span class="n">is_default</span><span class="w">      </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">FALSE</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">payment_methods</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="k">type</span><span class="w">            </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;credit_card&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;debit_card&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;paypal&#39;</span><span class="p">)),</span>
<span class="w">    </span><span class="n">last_four</span><span class="w">       </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">token</span><span class="w">           </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- 결제 프로세서가 토큰화</span>
<span class="w">    </span><span class="n">expires_at</span><span class="w">      </span><span class="nb">DATE</span><span class="p">,</span>
<span class="w">    </span><span class="n">is_default</span><span class="w">      </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">FALSE</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">-- ============================================================</span>
<span class="c1">-- 판매자</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">sellers</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">company_name</span><span class="w">    </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">contact_email</span><span class="w">   </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">commission_rate</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">1500</span><span class="p">,</span><span class="w">  </span><span class="c1">-- 15.00%</span>
<span class="w">    </span><span class="n">bank_account</span><span class="w">    </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span><span class="w">  </span><span class="c1">-- 암호화 또는 토큰화</span>
<span class="w">    </span><span class="n">is_active</span><span class="w">       </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">TRUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">-- ============================================================</span>
<span class="c1">-- 제품 카탈로그</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">categories</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w">            </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">slug</span><span class="w">            </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">description</span><span class="w">     </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">parent_id</span><span class="w">       </span><span class="nb">INT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">categories</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">position</span><span class="w">        </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">seller_id</span><span class="w">       </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">sellers</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">name</span><span class="w">            </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">slug</span><span class="w">            </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">description</span><span class="w">     </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">sku</span><span class="w">             </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">price</span><span class="w">           </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">price</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">weight_grams</span><span class="w">    </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">stock_quantity</span><span class="w">  </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">stock_quantity</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">is_active</span><span class="w">       </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">TRUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">product_categories</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">product_id</span><span class="w">      </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">category_id</span><span class="w">     </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">categories</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="n">category_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">product_images</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">product_id</span><span class="w">      </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span><span class="w">             </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">alt_text</span><span class="w">        </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<span class="w">    </span><span class="k">position</span><span class="w">        </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">-- ============================================================</span>
<span class="c1">-- 장바구니</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">carts</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">session_id</span><span class="w">      </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span><span class="w">  </span><span class="c1">-- 익명 카트용</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">cart_owner</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">session_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cart_items</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">cart_id</span><span class="w">         </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">carts</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">product_id</span><span class="w">      </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">quantity</span><span class="w">        </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">quantity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">added_at</span><span class="w">        </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">cart_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- ============================================================</span>
<span class="c1">-- 프로모션</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">promotions</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">code</span><span class="w">            </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">discount_type</span><span class="w">   </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">discount_type</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;percentage&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fixed_amount&#39;</span><span class="p">)),</span>
<span class="w">    </span><span class="n">amount</span><span class="w">          </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">min_purchase</span><span class="w">    </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">max_uses</span><span class="w">        </span><span class="nb">INT</span><span class="p">,</span><span class="w">                     </span><span class="c1">-- NULL = 무제한</span>
<span class="w">    </span><span class="n">uses_count</span><span class="w">      </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">per_customer</span><span class="w">    </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="c1">-- 고객당 최대 사용 횟수</span>
<span class="w">    </span><span class="n">valid_from</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">valid_until</span><span class="w">     </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">is_active</span><span class="w">       </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">TRUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">valid_from</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">valid_until</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- ============================================================</span>
<span class="c1">-- 주문</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="n">order_status</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ENUM</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;confirmed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;processing&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;shipped&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;delivered&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;refunded&#39;</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">shipping_address_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">addresses</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">payment_method_id</span><span class="w">   </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">payment_methods</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">promotion_id</span><span class="w">    </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">promotions</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">status</span><span class="w">          </span><span class="n">order_status</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">subtotal</span><span class="w">        </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">discount_amount</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">tax_amount</span><span class="w">      </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">shipping_cost</span><span class="w">   </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">total</span><span class="w">           </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">tracking_number</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">notes</span><span class="w">           </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">order_items</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">order_id</span><span class="w">        </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">orders</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">product_id</span><span class="w">      </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">quantity</span><span class="w">        </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">quantity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">unit_price</span><span class="w">      </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- 주문 시점의 가격</span>
<span class="w">    </span><span class="n">subtotal</span><span class="w">        </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- quantity * unit_price</span>
<span class="w">    </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- ============================================================</span>
<span class="c1">-- 리뷰</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">reviews</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">product_id</span><span class="w">      </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">rating</span><span class="w">          </span><span class="nb">SMALLINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">rating</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span>
<span class="w">    </span><span class="n">title</span><span class="w">           </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<span class="w">    </span><span class="n">body</span><span class="w">            </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">is_verified</span><span class="w">     </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">FALSE</span><span class="p">,</span><span class="w">  </span><span class="c1">-- 검증된 구매</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p">)</span><span class="w">  </span><span class="c1">-- 고객당 제품당 하나의 리뷰</span>
<span class="p">);</span>

<span class="c1">-- ============================================================</span>
<span class="c1">-- 위시리스트</span>
<span class="c1">-- ============================================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">wishlist_items</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">product_id</span><span class="w">      </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">added_at</span><span class="w">        </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>

<h3 id="43">4.3 정규화 검증<a class="header-link" href="#43" title="Permanent link">&para;</a></h3>
<p>주요 테이블의 함수 종속성을 분석하여 스키마가 BCNF에 있는지 검증합니다.</p>
<p><strong>customers 테이블</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">FDs</span><span class="o">:</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">email</span><span class="o">,</span><span class="w"> </span><span class="n">password_hash</span><span class="o">,</span><span class="w"> </span><span class="n">first_name</span><span class="o">,</span><span class="w"> </span><span class="n">last_name</span><span class="o">,</span><span class="w"> </span><span class="n">phone</span><span class="o">,</span><span class="w"> </span><span class="n">created_at</span><span class="o">,</span><span class="w"> </span><span class="n">updated_at</span>
<span class="w">     </span><span class="n">email</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">id</span><span class="w">  </span><span class="o">(</span><span class="err">후보</span><span class="w"> </span><span class="err">키</span><span class="o">)</span>

<span class="err">후보</span><span class="w"> </span><span class="err">키</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="n">id</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="n">email</span><span class="o">}</span>
<span class="err">두</span><span class="w"> </span><span class="err">결정자</span><span class="w"> </span><span class="err">모두</span><span class="w"> </span><span class="err">슈퍼키</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">BCNF</span><span class="w"> </span><span class="err">✓</span>
</code></pre></div>

<p><strong>products 테이블</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">FDs</span><span class="o">:</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">seller_id</span><span class="o">,</span><span class="w"> </span><span class="n">name</span><span class="o">,</span><span class="w"> </span><span class="n">slug</span><span class="o">,</span><span class="w"> </span><span class="n">description</span><span class="o">,</span><span class="w"> </span><span class="n">sku</span><span class="o">,</span><span class="w"> </span><span class="n">price</span><span class="o">,</span><span class="w"> </span><span class="n">weight_grams</span><span class="o">,</span>
<span class="w">          </span><span class="n">stock_quantity</span><span class="o">,</span><span class="w"> </span><span class="n">is_active</span><span class="o">,</span><span class="w"> </span><span class="n">created_at</span><span class="o">,</span><span class="w"> </span><span class="n">updated_at</span>
<span class="w">     </span><span class="n">sku</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">(</span><span class="err">후보</span><span class="w"> </span><span class="err">키</span><span class="o">)</span>
<span class="w">     </span><span class="n">slug</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">(</span><span class="err">후보</span><span class="w"> </span><span class="err">키</span><span class="o">)</span>

<span class="err">후보</span><span class="w"> </span><span class="err">키</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="n">id</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="n">sku</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="n">slug</span><span class="o">}</span>
<span class="err">모든</span><span class="w"> </span><span class="err">결정자가</span><span class="w"> </span><span class="err">슈퍼키</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">BCNF</span><span class="w"> </span><span class="err">✓</span>
</code></pre></div>

<p><strong>order_items 테이블</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">FDs</span><span class="o">:</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">order_id</span><span class="o">,</span><span class="w"> </span><span class="n">product_id</span><span class="o">,</span><span class="w"> </span><span class="n">quantity</span><span class="o">,</span><span class="w"> </span><span class="n">unit_price</span><span class="o">,</span><span class="w"> </span><span class="n">subtotal</span>
<span class="w">     </span><span class="o">(</span><span class="n">order_id</span><span class="o">,</span><span class="w"> </span><span class="n">product_id</span><span class="o">)</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">id</span><span class="o">,</span><span class="w"> </span><span class="n">quantity</span><span class="o">,</span><span class="w"> </span><span class="n">unit_price</span><span class="o">,</span><span class="w"> </span><span class="n">subtotal</span>

<span class="err">후보</span><span class="w"> </span><span class="err">키</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="n">id</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="n">order_id</span><span class="o">,</span><span class="w"> </span><span class="n">product_id</span><span class="o">}</span>
<span class="err">모든</span><span class="w"> </span><span class="err">결정자가</span><span class="w"> </span><span class="err">슈퍼키</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">BCNF</span><span class="w"> </span><span class="err">✓</span>
</code></pre></div>

<p><strong>reviews 테이블</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">FDs</span><span class="o">:</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">customer_id</span><span class="o">,</span><span class="w"> </span><span class="n">product_id</span><span class="o">,</span><span class="w"> </span><span class="n">rating</span><span class="o">,</span><span class="w"> </span><span class="n">title</span><span class="o">,</span><span class="w"> </span><span class="n">body</span><span class="o">,</span><span class="w"> </span><span class="n">is_verified</span><span class="o">,</span><span class="w"> </span><span class="n">created_at</span>
<span class="w">     </span><span class="o">(</span><span class="n">customer_id</span><span class="o">,</span><span class="w"> </span><span class="n">product_id</span><span class="o">)</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">id</span><span class="o">,</span><span class="w"> </span><span class="n">rating</span><span class="o">,</span><span class="w"> </span><span class="n">title</span><span class="o">,</span><span class="w"> </span><span class="n">body</span><span class="o">,</span><span class="w"> </span><span class="n">is_verified</span><span class="o">,</span><span class="w"> </span><span class="n">created_at</span>

<span class="err">후보</span><span class="w"> </span><span class="err">키</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="n">id</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="n">customer_id</span><span class="o">,</span><span class="w"> </span><span class="n">product_id</span><span class="o">}</span>
<span class="err">모든</span><span class="w"> </span><span class="err">결정자가</span><span class="w"> </span><span class="err">슈퍼키</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">BCNF</span><span class="w"> </span><span class="err">✓</span>
</code></pre></div>

<p><strong>categories 테이블</strong> (자기 참조 계층):</p>
<div class="highlight"><pre><span></span><code><span class="n">FDs</span><span class="o">:</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">name</span><span class="o">,</span><span class="w"> </span><span class="n">slug</span><span class="o">,</span><span class="w"> </span><span class="n">description</span><span class="o">,</span><span class="w"> </span><span class="n">parent_id</span><span class="o">,</span><span class="w"> </span><span class="n">position</span><span class="o">,</span><span class="w"> </span><span class="n">created_at</span>
<span class="w">     </span><span class="n">slug</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">id</span>

<span class="err">후보</span><span class="w"> </span><span class="err">키</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="n">id</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="n">slug</span><span class="o">}</span>
<span class="err">모든</span><span class="w"> </span><span class="err">결정자가</span><span class="w"> </span><span class="err">슈퍼키</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">BCNF</span><span class="w"> </span><span class="err">✓</span>
</code></pre></div>

<p><strong>스키마는 BCNF에 있습니다</strong> -- 슈퍼키가 아닌 결정자를 가진 비자명 FD가 없습니다.</p>
<h3 id="44">4.4 참조 무결성 요약<a class="header-link" href="#44" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">┌─────────────────┐</span><span class="w">     </span><span class="err">┌─────────────────┐</span>
<span class="err">│</span><span class="w">    </span><span class="nx">customers</span><span class="w">     </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">     </span><span class="nx">sellers</span><span class="w">     </span><span class="err">│</span>
<span class="err">│</span><span class="w">    </span><span class="p">(</span><span class="nx">PK</span><span class="p">:</span><span class="w"> </span><span class="nx">id</span><span class="p">)</span><span class="w">      </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">    </span><span class="p">(</span><span class="nx">PK</span><span class="p">:</span><span class="w"> </span><span class="nx">id</span><span class="p">)</span><span class="w">     </span><span class="err">│</span>
<span class="err">└───────┬─────────┘</span><span class="w">     </span><span class="err">└───────┬─────────┘</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">              </span><span class="err">│</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">              </span><span class="err">│</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">┌─────────┴──────────┐</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">└───▶│</span><span class="w">     </span><span class="nx">products</span><span class="w">       </span><span class="err">│</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">         </span><span class="err">│</span><span class="w">  </span><span class="p">(</span><span class="nx">FK</span><span class="p">:</span><span class="w"> </span><span class="nx">seller_id</span><span class="p">)</span><span class="w">   </span><span class="err">│</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">         </span><span class="err">└──┬────────┬────────┘</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">            </span><span class="err">│</span><span class="w">        </span><span class="err">│</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">     </span><span class="err">┌──────┘</span><span class="w">        </span><span class="err">└──────┐</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">     </span><span class="err">▼</span><span class="w">                      </span><span class="err">▼</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">  </span><span class="err">┌────────────┐</span><span class="w">    </span><span class="err">┌──────────────┐</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="nx">product_cats</span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="nx">product_images</span><span class="err">│</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">  </span><span class="err">└────────────┘</span><span class="w">    </span><span class="err">└──────────────┘</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">└────▶┌──────────┐</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w">  </span><span class="nx">reviews</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="p">(</span><span class="nx">FK</span><span class="p">:</span><span class="w"> </span><span class="nx">customer_id</span><span class="p">,</span><span class="w"> </span><span class="nx">product_id</span><span class="p">)</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">          </span><span class="err">└──────────┘</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span>
<span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">└─────────▶┌──────────┐</span><span class="w">     </span><span class="err">┌─────────────┐</span>
<span class="w">   </span><span class="err">│</span><span class="w">               </span><span class="err">│</span><span class="w">  </span><span class="nx">orders</span><span class="w">   </span><span class="err">│────▶│</span><span class="w"> </span><span class="nx">order_items</span><span class="w">  </span><span class="err">│</span>
<span class="w">   </span><span class="err">│</span><span class="w">               </span><span class="err">└──────────┘</span><span class="w">     </span><span class="err">└─────────────┘</span>
<span class="w">   </span><span class="err">│</span>
<span class="w">   </span><span class="err">├──────────────▶┌──────────┐</span>
<span class="w">   </span><span class="err">│</span><span class="w">               </span><span class="err">│</span><span class="w"> </span><span class="nx">addresses</span><span class="err">│</span>
<span class="w">   </span><span class="err">├──────────────▶┌──────────┐</span>
<span class="w">   </span><span class="err">│</span><span class="w">               </span><span class="err">│</span><span class="nx">pay_methods</span><span class="err">│</span>
<span class="w">   </span><span class="err">├──────────────▶┌──────────┐</span>
<span class="w">   </span><span class="err">│</span><span class="w">               </span><span class="err">│</span><span class="w">   </span><span class="nx">carts</span><span class="w">   </span><span class="err">│────▶</span><span class="w"> </span><span class="nx">cart_items</span>
<span class="w">   </span><span class="err">└──────────────▶┌──────────┐</span>
<span class="w">                   </span><span class="err">│</span><span class="w"> </span><span class="nx">wishlist</span><span class="w">  </span><span class="err">│</span>
<span class="w">                   </span><span class="err">└──────────┘</span>
</code></pre></div>

<hr />
<h2 id="5-4">5. 단계 4: 물리적 설계<a class="header-link" href="#5-4" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 인덱싱 전략<a class="header-link" href="#51" title="Permanent link">&para;</a></h3>
<p>단계 1에서 식별한 쿼리 패턴을 기반으로 인덱스를 설계합니다.</p>
<p><strong>기본 키 인덱스</strong> (자동 생성):</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- 모든 테이블은 BIGSERIAL PRIMARY KEY에서 PK 인덱스를 이미 가짐</span>
<span class="c1">-- 유니크 제약조건도 자동으로 인덱스 생성:</span>
<span class="c1">--   customers(email), products(sku), products(slug), promotions(code)</span>
</code></pre></div>

<p><strong>빈번한 쿼리를 위한 보조 인덱스</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- QP-01: 카테고리 + 가격 범위로 제품 검색</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_products_active_price</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>

<span class="c1">-- 카테고리 기반 검색용 (접합 테이블을 통해)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_product_categories_category</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">product_categories</span><span class="p">(</span><span class="n">category_id</span><span class="p">);</span>

<span class="c1">-- QP-02: 제품 상세 페이지 (제품의 리뷰)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_reviews_product_rating</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">reviews</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="n">rating</span><span class="p">);</span>

<span class="c1">-- QP-03: 고객의 장바구니</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_carts_customer</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">carts</span><span class="p">(</span><span class="n">customer_id</span><span class="p">);</span>

<span class="c1">-- QP-04: 재고 확인 (제품의 stock_quantity)</span>
<span class="c1">-- products(id)의 PK로 충분</span>

<span class="c1">-- QP-05: 고객의 주문 이력</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_orders_customer_date</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">orders</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">);</span>

<span class="c1">-- QP-06: 판매자 대시보드</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_products_seller</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">seller_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_order_items_product</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">order_items</span><span class="p">(</span><span class="n">product_id</span><span class="p">);</span>

<span class="c1">-- QP-07: 카테고리에서 최고 평가 제품</span>
<span class="c1">-- idx_reviews_product_rating과 idx_product_categories_category가 도움</span>

<span class="c1">-- QP-09: 프로모션 검증</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_promotions_code_active</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">promotions</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>

<span class="c1">-- QP-10: 위시리스트 표시</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_wishlist_customer</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">wishlist_items</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">added_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">);</span>

<span class="c1">-- 제품 이름 및 설명에 대한 전체 텍스트 검색</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_products_search</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">products</span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="n">GIN</span><span class="w"> </span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)));</span>
</code></pre></div>

<h3 id="52">5.2 파티셔닝 전략<a class="header-link" href="#52" title="Permanent link">&para;</a></h3>
<p>수억 행으로 성장할 것으로 예상되는 테이블에 테이블 파티셔닝을 적용합니다.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- 월별로 주문 파티션 (범위 파티셔닝)</span>
<span class="c1">-- 다음에 도움:</span>
<span class="c1">--   1. 주문 이력 쿼리 (관련 월만 스캔)</span>
<span class="c1">--   2. 오래된 주문 아카이빙 (전체 파티션 삭제)</span>
<span class="c1">--   3. 유지보수 작업 (더 작은 파티션에서 VACUUM)</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">              </span><span class="n">BIGSERIAL</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="c1">-- ... 기타 열 ...</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span><span class="p">)</span><span class="w">  </span><span class="c1">-- 파티션 키는 PK에 있어야 함</span>
<span class="p">)</span><span class="w"> </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">RANGE</span><span class="w"> </span><span class="p">(</span><span class="n">created_at</span><span class="p">);</span>

<span class="c1">-- 파티션 생성</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders_2024_01</span><span class="w"> </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">orders</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;2024-02-01&#39;</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders_2024_02</span><span class="w"> </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">orders</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;2024-02-01&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;2024-03-01&#39;</span><span class="p">);</span>
<span class="c1">-- ... (pg_partman 확장으로 자동화)</span>

<span class="c1">-- 주문 날짜별로 order_items를 유사하게 파티션</span>
<span class="c1">-- 또는 이미 파티션된 주문에 대한 외래 키 사용</span>

<span class="c1">-- 리뷰 파티션 (매우 크게 성장하는 경우)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">reviews</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="c1">-- ...</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">)</span><span class="w"> </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">RANGE</span><span class="w"> </span><span class="p">(</span><span class="n">created_at</span><span class="p">);</span>
</code></pre></div>

<h3 id="53">5.3 비정규화 결정<a class="header-link" href="#53" title="Permanent link">&para;</a></h3>
<p>순수 정규화는 저장소와 업데이트 일관성을 최적화하지만 읽기 성능을 해칠 수 있습니다. 읽기 성능 이점이 업데이트 복잡성을 능가하는 곳에서 전략적으로 비정규화합니다.</p>
<p><strong>결정 1: order_items에 unit_price 저장</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">-- 스키마에 이미 있음: order_items.unit_price는 주문 시점의 가격 캡처</span>
<span class="c1">-- 이것은 성능을 위한 비정규화가 아님 -- 비즈니스 요구사항!</span>
<span class="c1">-- 제품 가격은 주문이 생성된 후 변경될 수 있음.</span>
<span class="c1">-- 이것 없이는 과거 주문 합계를 재구성할 수 없음.</span>
</code></pre></div>

<p><strong>결정 2: 구체화된 리뷰 통계</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">-- 모든 제품 페이지 로드에 대해 AVG(rating)과 COUNT(*)를 계산하는 대신,</span>
<span class="c1">-- products 테이블에 미리 계산된 값을 저장.</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">avg_rating</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">review_count</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="c1">-- 리뷰가 추가/수정될 때 트리거 또는 애플리케이션 코드를 통해 업데이트:</span>
<span class="c1">-- UPDATE products SET</span>
<span class="c1">--   avg_rating = (SELECT AVG(rating) FROM reviews WHERE product_id = $1),</span>
<span class="c1">--   review_count = (SELECT COUNT(*) FROM reviews WHERE product_id = $1)</span>
<span class="c1">-- WHERE id = $1;</span>
</code></pre></div>

<p><strong>결정 3: 주문에 total 저장</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">-- 스키마에 이미 있음: orders.total은 계산되지 않고 저장됨</span>
<span class="c1">-- 모든 읽기에서 order_items의 SUM(subtotal)을 계산하는 것은 낭비</span>
<span class="c1">-- 주문이 생성되면 total이 고정됨</span>
</code></pre></div>

<p><strong>결정 4: 카테고리 경로 구체화</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">-- 깊은 카테고리 계층의 경우, 재귀 쿼리가 느림</span>
<span class="c1">-- 표시를 위한 전체 경로를 구체화:</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">categories</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">;</span><span class="w">  </span><span class="c1">-- 예: &quot;Electronics/Phones/Smartphones&quot;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">categories</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="c1">-- 카테고리 생성/이동 시 업데이트:</span>
<span class="c1">-- path = parent.path || &#39;/&#39; || name</span>
<span class="c1">-- depth = parent.depth + 1</span>
</code></pre></div>

<p><strong>비정규화 결정 매트릭스</strong>:</p>
<table>
<thead>
<tr>
<th>비정규화</th>
<th>이점</th>
<th>비용</th>
<th>결정</th>
</tr>
</thead>
<tbody>
<tr>
<td>products의 avg_rating</td>
<td>모든 제품 페이지에서 집계 회피</td>
<td>리뷰 변경 시 업데이트</td>
<td>예 (높은 읽기:쓰기 비율)</td>
</tr>
<tr>
<td>orders의 total</td>
<td>모든 주문 표시에서 SUM 회피</td>
<td>order_items와 일치해야 함</td>
<td>예 (생성 후 불변)</td>
</tr>
<tr>
<td>카테고리 경로</td>
<td>재귀 쿼리 회피</td>
<td>카테고리 이동 시 업데이트</td>
<td>예 (카테고리가 거의 변경되지 않음)</td>
</tr>
<tr>
<td>orders의 고객 이름</td>
<td>주문 목록에 대한 JOIN 회피</td>
<td>이름 변경 시 업데이트</td>
<td>아니오 (인덱스를 사용한 JOIN이 빠름)</td>
</tr>
</tbody>
</table>
<h3 id="54">5.4 저장소 고려사항<a class="header-link" href="#54" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 저장 효율성을 위한 적절한 데이터 타입 사용</span>

<span class="c1">-- 좋음: 돈에 DECIMAL(10,2) (정확한 산술)</span>
<span class="c1">-- 나쁨:  돈에 FLOAT (반올림 오류!)</span>

<span class="c1">-- 좋음: 평가에 SMALLINT (1-5, 2바이트 사용)</span>
<span class="c1">-- 나쁨:  평가에 INT (4바이트 사용, 공간 낭비)</span>

<span class="c1">-- 좋음: 국가 코드에 VARCHAR(2)</span>
<span class="c1">-- 나쁨:  국가 코드에 TEXT (길이 제약 없음)</span>

<span class="c1">-- 좋음: 날짜에 TIMESTAMPTZ (타임존 인식)</span>
<span class="c1">-- 나쁨:  날짜에 TIMESTAMP (모호한 타임존)</span>

<span class="c1">-- 좋음: 고정된 상태 값에 ENUM</span>
<span class="c1">-- 나쁨:  상태에 VARCHAR (오타 허용)</span>

<span class="c1">-- 테이블 크기 추정:</span>
<span class="c1">-- customers: 1M 행 x ~300 바이트 ≈ 300 MB</span>
<span class="c1">-- products:  500K 행 x ~500 바이트 ≈ 250 MB</span>
<span class="c1">-- orders:    10M 행 x ~200 바이트 ≈ 2 GB</span>
<span class="c1">-- order_items: 25M 행 x ~100 바이트 ≈ 2.5 GB</span>
<span class="c1">-- reviews:   2M 행 x ~500 바이트 ≈ 1 GB</span>
<span class="c1">-- 총: ~6 GB (캐싱을 위해 RAM에 쉽게 맞음)</span>
</code></pre></div>

<hr />
<h2 id="6-5">6. 단계 5: 쿼리 최적화<a class="header-link" href="#6-5" title="Permanent link">&para;</a></h2>
<h3 id="61-qp-01">6.1 제품 검색 (QP-01)<a class="header-link" href="#61-qp-01" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 쿼리: 카테고리에서 키워드로 제품 검색, 가격 필터</span>
<span class="c1">-- 플랫폼에서 가장 빈번한 쿼리</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">avg_rating</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">review_count</span><span class="p">,</span>
<span class="w">       </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">product_images</span><span class="w"> </span><span class="n">pi</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">pi</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">pi</span><span class="p">.</span><span class="k">position</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">thumbnail</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">product_categories</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc</span><span class="p">.</span><span class="n">product_id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">pc</span><span class="p">.</span><span class="n">category_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">price</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">10</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="w">      </span><span class="o">@@</span><span class="w"> </span><span class="n">plainto_tsquery</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;wireless bluetooth headphones&#39;</span><span class="p">)</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">avg_rating</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="n">NULLS</span><span class="w"> </span><span class="k">LAST</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>

<p><strong>실행 계획 분석</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">EXPLAIN</span><span class="w"> </span><span class="p">(</span><span class="n">ANALYZE</span><span class="p">,</span><span class="w"> </span><span class="n">BUFFERS</span><span class="p">)</span>
<span class="o">--</span><span class="w"> </span><span class="err">예상</span><span class="w"> </span><span class="err">계획</span><span class="o">:</span>
<span class="o">--</span><span class="w"> </span><span class="kr">Limit</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="p">...</span><span class="w"> </span><span class="n">rows</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="o">--</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="nf">Sort</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="p">...</span><span class="w"> </span><span class="n">key</span><span class="o">:</span><span class="w"> </span><span class="n">avg_rating</span><span class="w"> </span><span class="n">DESC</span><span class="p">)</span>
<span class="o">--</span><span class="w">     </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Nested</span><span class="w"> </span><span class="nf">Loop</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="p">...)</span>
<span class="o">--</span><span class="w">       </span><span class="o">-&gt;</span><span class="w"> </span><span class="nf">Index</span><span class="w"> </span><span class="kr">Scan</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">product_categories</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="p">(</span><span class="n">category_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span>
<span class="o">--</span><span class="w">       </span><span class="o">-&gt;</span><span class="w"> </span><span class="nf">Index</span><span class="w"> </span><span class="kr">Scan</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc</span><span class="p">.</span><span class="n">product_id</span><span class="p">)</span>
<span class="o">--</span><span class="w">            </span><span class="n">Filter</span><span class="o">:</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="kr">AND</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="kr">BETWEEN</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="kr">AND</span><span class="w"> </span><span class="mi">100</span>
<span class="o">--</span><span class="w">            </span><span class="n">Filter</span><span class="o">:</span><span class="w"> </span><span class="n">tsvector</span><span class="w"> </span><span class="err">@@</span><span class="w"> </span><span class="n">tsquery</span>
</code></pre></div>

<p><strong>최적화</strong>: 전체 텍스트 검색과 카테고리를 모두 다루는 복합 GIN 인덱스 생성:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- 카테고리 기반 전체 텍스트 검색이 지배적인 패턴인 경우:</span>
<span class="c1">-- 제품과 카테고리를 미리 조인하는 구체화된 뷰 고려</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">MATERIALIZED</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">product_search</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">avg_rating</span><span class="p">,</span>
<span class="w">       </span><span class="n">p</span><span class="p">.</span><span class="n">review_count</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">is_active</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="p">.</span><span class="n">category_id</span><span class="p">,</span>
<span class="w">       </span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">search_vector</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">product_categories</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc</span><span class="p">.</span><span class="n">product_id</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_product_search_category</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">product_search</span><span class="p">(</span><span class="n">category_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_product_search_fts</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">product_search</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">GIN</span><span class="p">(</span><span class="n">search_vector</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_product_search_price</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">product_search</span><span class="p">(</span><span class="n">category_id</span><span class="p">,</span><span class="w"> </span><span class="n">price</span><span class="p">)</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>

<span class="c1">-- 주기적으로 또는 제품 변경 시 새로고침</span>
<span class="n">REFRESH</span><span class="w"> </span><span class="n">MATERIALIZED</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">CONCURRENTLY</span><span class="w"> </span><span class="n">product_search</span><span class="p">;</span>
</code></pre></div>

<h3 id="62-qp-02">6.2 제품 상세 페이지 (QP-02)<a class="header-link" href="#62-qp-02" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 한 쿼리로 이미지, 판매자 및 리뷰 요약과 함께 제품 가져오기</span>
<span class="k">SELECT</span>
<span class="w">  </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">sku</span><span class="p">,</span>
<span class="w">  </span><span class="n">p</span><span class="p">.</span><span class="n">stock_quantity</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">avg_rating</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">review_count</span><span class="p">,</span>
<span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">company_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">seller_name</span><span class="p">,</span>
<span class="w">  </span><span class="n">json_agg</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">jsonb_build_object</span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;url&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">pi</span><span class="p">.</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;alt_text&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">pi</span><span class="p">.</span><span class="n">alt_text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;position&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">pi</span><span class="p">.</span><span class="k">position</span>
<span class="w">  </span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">images</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">sellers</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">seller_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">id</span>
<span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">product_images</span><span class="w"> </span><span class="n">pi</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pi</span><span class="p">.</span><span class="n">product_id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>

<span class="c1">-- 리뷰를 별도로 가져오기 (페이지네이션)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">rating</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">created_at</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">is_verified</span><span class="p">,</span>
<span class="w">       </span><span class="k">c</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">LEFT</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">reviewer</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">reviews</span><span class="w"> </span><span class="n">r</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span><span class="p">;</span>
</code></pre></div>

<h3 id="63-qp-05">6.3 주문 이력 (QP-05)<a class="header-link" href="#63-qp-05" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 항목 요약과 함께 고객의 최근 주문</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">total</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">created_at</span><span class="p">,</span>
<span class="w">       </span><span class="k">COUNT</span><span class="p">(</span><span class="n">oi</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">item_count</span><span class="p">,</span>
<span class="w">       </span><span class="n">STRING_AGG</span><span class="p">(</span><span class="k">LEFT</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;, &#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">oi</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">item_preview</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">order_items</span><span class="w"> </span><span class="n">oi</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oi</span><span class="p">.</span><span class="n">order_id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">oi</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span><span class="p">;</span>

<span class="c1">-- 인덱스 사용: idx_orders_customer_date (customer_id, created_at DESC)</span>
<span class="c1">-- 파티션 가지치기: 최근 주문 쿼리 시, 최근 파티션만 스캔</span>
</code></pre></div>

<h3 id="64-qp-06">6.4 판매자 대시보드 (QP-06)<a class="header-link" href="#64-qp-06" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 판매자의 월별 수익 및 주문 수</span>
<span class="k">SELECT</span>
<span class="w">  </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">created_at</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">month</span><span class="p">,</span>
<span class="w">  </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">order_count</span><span class="p">,</span>
<span class="w">  </span><span class="k">SUM</span><span class="p">(</span><span class="n">oi</span><span class="p">.</span><span class="n">subtotal</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">revenue</span><span class="p">,</span>
<span class="w">  </span><span class="k">SUM</span><span class="p">(</span><span class="n">oi</span><span class="p">.</span><span class="n">subtotal</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">commission_rate</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">commission</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">sellers</span><span class="w"> </span><span class="n">s</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">seller_id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">order_items</span><span class="w"> </span><span class="n">oi</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oi</span><span class="p">.</span><span class="n">product_id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">oi</span><span class="p">.</span><span class="n">order_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span><span class="w">  </span><span class="c1">-- 시작 날짜</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="err">$</span><span class="mi">3</span><span class="w">   </span><span class="c1">-- 종료 날짜</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;cancelled&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;refunded&#39;</span><span class="p">)</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">month</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">month</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</code></pre></div>

<h3 id="65">6.5 쿼리 성능 요약<a class="header-link" href="#65" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>쿼리</th>
<th>예상 지연시간</th>
<th>주요 인덱스</th>
<th>비고</th>
</tr>
</thead>
<tbody>
<tr>
<td>제품 검색</td>
<td>&lt; 50ms</td>
<td>GIN (FTS) + 카테고리</td>
<td>구체화된 뷰가 도움</td>
</tr>
<tr>
<td>제품 상세</td>
<td>&lt; 10ms</td>
<td>PK + 판매자 FK</td>
<td>단일 행 + 이미지</td>
</tr>
<tr>
<td>장바구니 내용</td>
<td>&lt; 5ms</td>
<td>carts(customer_id)</td>
<td>작은 결과 집합</td>
</tr>
<tr>
<td>주문 생성</td>
<td>&lt; 100ms</td>
<td>재고 확인 + 삽입</td>
<td>트랜잭션 (단계 6 참조)</td>
</tr>
<tr>
<td>주문 이력</td>
<td>&lt; 20ms</td>
<td>orders(customer_id, date)</td>
<td>파티션 가지치기</td>
</tr>
<tr>
<td>판매자 대시보드</td>
<td>&lt; 200ms</td>
<td>products(seller_id) + order_items(product_id)</td>
<td>집계 쿼리</td>
</tr>
<tr>
<td>최고 평가 제품</td>
<td>&lt; 30ms</td>
<td>product_categories + avg_rating</td>
<td>비정규화된 평가 사용</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7-6">7. 단계 6: 트랜잭션 설계<a class="header-link" href="#7-6" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 중요 트랜잭션: 주문 생성<a class="header-link" href="#71" title="Permanent link">&para;</a></h3>
<p>이것은 시스템에서 가장 복잡하고 중요한 트랜잭션입니다. 다음을 수행해야 합니다:
1. 장바구니 항목이 재고에 있는지 검증
2. 합계 계산 (잠재적 프로모션 포함)
3. 재고 감소
4. 주문 및 주문 항목 생성
5. 장바구니 비우기
6. 결제 처리 (외부 API 호출)</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- 격리 수준: SERIALIZABLE 또는 명시적 잠금이 있는 READ COMMITTED</span>
<span class="c1">-- 더 나은 성능을 위해 명시적 잠금이 있는 READ COMMITTED 사용</span>

<span class="k">BEGIN</span><span class="p">;</span>

<span class="c1">-- 단계 1: 동시 수정 방지를 위해 장바구니 항목 잠금</span>
<span class="c1">-- 과다 판매를 방지하기 위해 제품 행도 잠금</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">stock_quantity</span><span class="p">,</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">quantity</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">cart_items</span><span class="w"> </span><span class="n">ci</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">cart_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">cart_id</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w">  </span><span class="c1">-- 제품 행 잠금</span>

<span class="c1">-- 단계 2: 재고 검증 (애플리케이션 확인: stock_quantity &gt;= ci.quantity)</span>
<span class="c1">-- 항목이 재고 부족이면 ROLLBACK하고 고객에게 알림</span>

<span class="c1">-- 단계 3: 프로모션 적용 (있는 경우)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">discount_type</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">min_purchase</span><span class="p">,</span><span class="w"> </span><span class="n">max_uses</span><span class="p">,</span><span class="w"> </span><span class="n">uses_count</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">promotions</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">promo_code</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">valid_from</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">valid_until</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="p">;</span><span class="w">  </span><span class="c1">-- max_uses를 초과한 동시 사용 방지를 위해 잠금</span>

<span class="c1">-- 단계 4: 주문 생성</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">shipping_address_id</span><span class="p">,</span><span class="w"> </span><span class="n">payment_method_id</span><span class="p">,</span>
<span class="w">                    </span><span class="n">promotion_id</span><span class="p">,</span><span class="w"> </span><span class="n">subtotal</span><span class="p">,</span><span class="w"> </span><span class="n">discount_amount</span><span class="p">,</span><span class="w"> </span><span class="n">tax_amount</span><span class="p">,</span>
<span class="w">                    </span><span class="n">shipping_cost</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">address_id</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">payment_id</span><span class="p">,</span>
<span class="w">        </span><span class="err">$</span><span class="n">promo_id</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">subtotal</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">discount</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">tax</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">shipping</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">total</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">)</span>
<span class="n">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">order_id</span><span class="p">;</span>

<span class="c1">-- 단계 5: 주문 항목 생성 및 재고 감소</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">order_items</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="n">quantity</span><span class="p">,</span><span class="w"> </span><span class="n">unit_price</span><span class="p">,</span><span class="w"> </span><span class="n">subtotal</span><span class="p">)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="err">$</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">quantity</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">quantity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">price</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">cart_items</span><span class="w"> </span><span class="n">ci</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">cart_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">cart_id</span><span class="p">;</span>

<span class="k">UPDATE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span>
<span class="k">SET</span><span class="w"> </span><span class="n">stock_quantity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stock_quantity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">quantity</span><span class="p">,</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">cart_items</span><span class="w"> </span><span class="n">ci</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">product_id</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="n">cart_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">cart_id</span><span class="p">;</span>

<span class="c1">-- 단계 6: 프로모션 사용 횟수 업데이트</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">promotions</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">uses_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uses_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">promo_id</span><span class="p">;</span>

<span class="c1">-- 단계 7: 장바구니 비우기</span>
<span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cart_items</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">cart_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">cart_id</span><span class="p">;</span>

<span class="c1">-- 단계 8: 결제 처리 (외부 API 호출)</span>
<span class="c1">-- 참고: 트랜잭션 외부에서 수행하거나 Saga 패턴 사용</span>
<span class="c1">-- 결제가 실패하면 전체 트랜잭션이 롤백됨</span>

<span class="k">COMMIT</span><span class="p">;</span>
</code></pre></div>

<p><strong>중요한 설계 결정</strong>: 결제 API 호출은 데이터베이스 트랜잭션 내부에 있어서는 안 됩니다:
1. 외부 API 호출이 느릴 수 있음 (초), 잠금을 너무 오래 유지
2. DB가 커밋되지만 결제가 실패하면 일관되지 않은 상태</p>
<p><strong>더 나은 접근: Saga 패턴</strong></p>
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">BEGIN</span><span class="p">;</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="err">&#39;</span><span class="n">pending_payment</span><span class="err">&#39;</span><span class="n">로</span><span class="w"> </span><span class="n">주문</span><span class="w"> </span><span class="n">생성</span><span class="p">;</span><span class="w"> </span><span class="n">재고</span><span class="w"> </span><span class="n">감소</span><span class="p">;</span><span class="w"> </span><span class="n">COMMIT</span><span class="p">;</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">결제</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">호출</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">결제</span><span class="w"> </span><span class="n">성공</span><span class="w"> </span><span class="n">시</span><span class="p">:</span><span class="w"> </span><span class="n">UPDATE</span><span class="w"> </span><span class="ow">or</span><span class="n">ders</span><span class="w"> </span><span class="n">SET</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="err">&#39;</span><span class="n">confirmed</span><span class="err">&#39;</span><span class="w"> </span><span class="n">WHERE</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="n">id</span><span class="p">;</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">결제</span><span class="w"> </span><span class="n">실패</span><span class="w"> </span><span class="n">시</span><span class="p">:</span><span class="w"> </span><span class="n">UPDATE</span><span class="w"> </span><span class="ow">or</span><span class="n">ders</span><span class="w"> </span><span class="n">SET</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="err">&#39;</span><span class="n">payment_failed</span><span class="err">&#39;</span><span class="w"> </span><span class="n">WHERE</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="err">$</span><span class="n">id</span><span class="p">;</span>
<span class="w">                 </span><span class="n">재고</span><span class="w"> </span><span class="n">복원</span><span class="w"> </span><span class="p">(</span><span class="n">보상</span><span class="w"> </span><span class="n">트랜잭션</span><span class="p">)</span>
</code></pre></div>

<h3 id="72">7.2 격리 수준 결정<a class="header-link" href="#72" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>트랜잭션</th>
<th>격리 수준</th>
<th>이유</th>
</tr>
</thead>
<tbody>
<tr>
<td>주문 생성</td>
<td>READ COMMITTED + FOR UPDATE</td>
<td>명시적 잠금이 과다 판매를 방지; RC가 Serializable보다 빠름</td>
</tr>
<tr>
<td>제품 탐색</td>
<td>READ COMMITTED</td>
<td>카탈로그에 대한 약간의 staleness 허용 가능</td>
</tr>
<tr>
<td>주문 이력 보기</td>
<td>READ COMMITTED</td>
<td>과거 데이터, 쓰기 충돌 없음</td>
</tr>
<tr>
<td>리뷰 제출</td>
<td>READ COMMITTED + UNIQUE 제약조건</td>
<td>UNIQUE(customer_id, product_id)가 중복 방지</td>
</tr>
<tr>
<td>프로모션 적용</td>
<td>READ COMMITTED + FOR UPDATE</td>
<td>max_uses 초과 방지를 위해 프로모션 행 잠금</td>
</tr>
<tr>
<td>관리자 보고서</td>
<td>REPEATABLE READ</td>
<td>장기 실행 집계 쿼리를 위한 일관된 스냅샷</td>
</tr>
</tbody>
</table>
<h3 id="73">7.3 잠금 전략<a class="header-link" href="#73" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 과다 판매 방지: 제품 행에 SELECT FOR UPDATE 사용</span>
<span class="c1">-- 행 수준 배타적 잠금 획득</span>

<span class="c1">-- 교착 상태 방지를 위한 순서대 잠금:</span>
<span class="c1">-- 여러 제품을 업데이트할 때 항상 id 순서로 잠금</span>

<span class="c1">-- 예: 장바구니에 제품 [42, 17, 88]이 있으면 [17, 42, 88] 순서로 잠금</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">stock_quantity</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">products</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="mi">88</span><span class="p">)</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">id</span><span class="w">    </span><span class="c1">-- 일관된 순서가 교착 상태 방지</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="p">;</span>
</code></pre></div>

<h3 id="74">7.4 동시성 시나리오<a class="header-link" href="#74" title="Permanent link">&para;</a></h3>
<p><strong>시나리오 1: 두 고객이 마지막 항목을 주문</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">고객</span><span class="w"> </span><span class="n">A</span><span class="w">                              </span><span class="n">고객</span><span class="w"> </span><span class="n">B</span>
<span class="k">BEGIN</span><span class="w">                               </span><span class="k">BEGIN</span>
<span class="k">SELECT</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="p">(</span><span class="n">stock</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">✓</span><span class="w">   </span><span class="k">SELECT</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">→</span><span class="w"> </span><span class="n">차단됨</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">0</span><span class="w">                    </span><span class="p">(</span><span class="n">A의</span><span class="w"> </span><span class="n">잠금을</span><span class="w"> </span><span class="n">기다림</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="n">order_item</span><span class="w">                   </span><span class="p">...</span>
<span class="k">COMMIT</span><span class="w"> </span><span class="n">→</span><span class="w"> </span><span class="n">잠금</span><span class="w"> </span><span class="n">해제</span><span class="w">                  </span><span class="n">→</span><span class="w"> </span><span class="n">차단</span><span class="w"> </span><span class="n">해제</span><span class="p">,</span><span class="w"> </span><span class="n">stock</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">읽음</span>
<span class="w">                                    </span><span class="n">→</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="err">&lt;</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="n">→</span><span class="w"> </span><span class="k">ROLLBACK</span>
<span class="w">                                    </span><span class="n">→</span><span class="w"> </span><span class="s2">&quot;재고 부족&quot;</span><span class="w"> </span><span class="n">메시지</span>
</code></pre></div>

<p><strong>시나리오 2: 고객이 체크아웃하는 동안 장바구니 업데이트</strong></p>
<div class="highlight"><pre><span></span><code><span class="err">체크아웃</span> <span class="err">트랜잭션</span>              <span class="err">장바구니</span> <span class="err">업데이트</span>
<span class="kr">BEGIN</span>                          <span class="kr">BEGIN</span>
<span class="n">SELECT</span> <span class="n">cart_items</span> <span class="kr">FOR</span> <span class="n">UPDATE</span> <span class="err">✓</span> <span class="n">UPDATE</span> <span class="n">cart_items</span> <span class="err">→</span> <span class="err">차단됨</span>
<span class="p">...</span>                            <span class="p">(</span><span class="err">체크아웃의</span> <span class="err">잠금을</span> <span class="err">기다림</span><span class="p">)</span>
<span class="p">...</span><span class="err">주문</span> <span class="err">처리</span> <span class="err">중</span><span class="p">...</span>             <span class="p">...</span>
<span class="n">DELETE</span> <span class="n">cart_items</span>              <span class="p">...</span>
<span class="n">COMMIT</span> <span class="err">→</span> <span class="err">잠금</span> <span class="err">해제</span>             <span class="err">→</span> <span class="err">행</span> <span class="err">삭제됨</span><span class="p">,</span> <span class="err">업데이트가</span> <span class="mi">0</span><span class="err">행에</span> <span class="err">영향</span>
                               <span class="err">→</span> <span class="n">COMMIT</span> <span class="p">(</span><span class="err">오류</span> <span class="err">없음</span><span class="p">,</span> <span class="err">장바구니는</span> <span class="err">비어</span> <span class="err">있음</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="8">8. 대안 사례 연구: 소셜 미디어 플랫폼<a class="header-link" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 요구사항 요약<a class="header-link" href="#81" title="Permanent link">&para;</a></h3>
<p><strong>SocialBuzz</strong>는 게시물, 팔로우, 좋아요 및 개인화된 피드를 지원하는 소셜 미디어 플랫폼입니다.</p>
<h3 id="82">8.2 주요 엔티티<a class="header-link" href="#82" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">          </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">username</span><span class="w">    </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">email</span><span class="w">       </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">display_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">bio</span><span class="w">         </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">avatar_url</span><span class="w">  </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">  </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">follows</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">follower_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">followee_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">  </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">follower_id</span><span class="p">,</span><span class="w"> </span><span class="n">followee_id</span><span class="p">),</span>
<span class="w">    </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">follower_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">followee_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">posts</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">          </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">user_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">content</span><span class="w">     </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">media_urls</span><span class="w">  </span><span class="nb">TEXT</span><span class="p">[],</span><span class="w">  </span><span class="c1">-- 미디어 URL 배열</span>
<span class="w">    </span><span class="n">like_count</span><span class="w">  </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">      </span><span class="c1">-- 비정규화</span>
<span class="w">    </span><span class="n">comment_count</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">    </span><span class="c1">-- 비정규화</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">  </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">likes</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">user_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">post_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">posts</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">  </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">post_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">comments</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w">          </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">post_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">posts</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">user_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">parent_id</span><span class="w">   </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">comments</span><span class="p">(</span><span class="n">id</span><span class="p">),</span><span class="w">  </span><span class="c1">-- 스레드 댓글</span>
<span class="w">    </span><span class="n">content</span><span class="w">     </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">  </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>

<h3 id="83">8.3 피드 문제<a class="header-link" href="#83" title="Permanent link">&para;</a></h3>
<p>가장 어려운 쿼리는 개인화된 피드입니다: "내가 팔로우하는 사람들의 최근 게시물을 보여주세요."</p>
<p><strong>풀 모델</strong> (읽기 시 팬아웃):</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- 읽기 시점에 팔로우하는 모든 사용자의 게시물 쿼리</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">display_name</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">avatar_url</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">posts</span><span class="w"> </span><span class="n">p</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">follows</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">followee_id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">follower_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">current_user_id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>

<span class="c1">-- 문제: 사용자가 1000명을 팔로우하면 큰 follows 목록을</span>
<span class="c1">-- 큰 posts 테이블과 조인. 활성 사용자에게 느림.</span>
</code></pre></div>

<p><strong>푸시 모델</strong> (쓰기 시 팬아웃):</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- 피드 테이블 생성 (비정규화된 타임라인)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">feed_items</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">user_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- 피드를 소유한 사용자</span>
<span class="w">    </span><span class="n">post_id</span><span class="w">     </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">author_id</span><span class="w">   </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w">  </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">post_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- 사용자 X가 게시물을 생성할 때:</span>
<span class="c1">-- X의 모든 팔로워에 대해 feed_item 삽입</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">feed_items</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">post_id</span><span class="p">,</span><span class="w"> </span><span class="n">author_id</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span><span class="p">)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">follower_id</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">post_id</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">author_id</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">created_at</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">follows</span><span class="w"> </span><span class="n">f</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">followee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">author_id</span><span class="p">;</span>

<span class="c1">-- 피드 읽기는 이제 간단:</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">fi</span><span class="p">.</span><span class="n">post_id</span><span class="p">,</span><span class="w"> </span><span class="n">fi</span><span class="p">.</span><span class="n">author_id</span><span class="p">,</span><span class="w"> </span><span class="n">fi</span><span class="p">.</span><span class="n">created_at</span><span class="p">,</span>
<span class="w">       </span><span class="n">p</span><span class="p">.</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">media_urls</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">like_count</span><span class="p">,</span>
<span class="w">       </span><span class="n">u</span><span class="p">.</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">avatar_url</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">feed_items</span><span class="w"> </span><span class="n">fi</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">posts</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">fi</span><span class="p">.</span><span class="n">post_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">fi</span><span class="p">.</span><span class="n">author_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">fi</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">current_user_id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">fi</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>

<span class="c1">-- 문제: 유명인이 1천만 팔로워를 가지고 있으면 게시물 생성에</span>
<span class="c1">-- 1천만 INSERT 작업이 필요. 인기 사용자에게 느림.</span>
</code></pre></div>

<p><strong>하이브리드 모델</strong> (Twitter/X가 사용):</p>
<div class="highlight"><pre><span></span><code>일반 사용자 (&lt; 10K 팔로워): 푸시 모델 (쓰기 시 팬아웃)
유명인 사용자 (&gt; 10K 팔로워): 풀 모델 (읽기 시 팬아웃)

피드 = Merge(feed_items 테이블, 팔로우한 유명인을 위한 실시간 쿼리)
</code></pre></div>

<h3 id="84">8.4 설계 트레이드오프<a class="header-link" href="#84" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>측면</th>
<th>전자상거래</th>
<th>소셜 미디어</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>중요 트랜잭션</strong></td>
<td>주문 생성 (ACID 필요)</td>
<td>게시물 생성 (최종 일관성 OK)</td>
</tr>
<tr>
<td><strong>주요 읽기 패턴</strong></td>
<td>ID로 제품 조회</td>
<td>타임라인 (피드)</td>
</tr>
<tr>
<td><strong>쓰기 패턴</strong></td>
<td>낮은 빈도, 높은 가치</td>
<td>높은 빈도, 낮은 가치</td>
</tr>
<tr>
<td><strong>비정규화</strong></td>
<td>보통 (avg_rating, totals)</td>
<td>많음 (feed_items, 카운터)</td>
</tr>
<tr>
<td><strong>일관성</strong></td>
<td>강함 (재고, 결제)</td>
<td>최종 (좋아요 수, 피드)</td>
</tr>
<tr>
<td><strong>확장 도전</strong></td>
<td>재고 경합</td>
<td>팬아웃 (인기 사용자)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="9">9. 설계 검토 체크리스트<a class="header-link" href="#9" title="Permanent link">&para;</a></h2>
<p>프로덕션에 데이터베이스 설계를 배포하기 전에 이 체크리스트를 사용하세요:</p>
<h3 id="91">9.1 스키마 설계<a class="header-link" href="#91" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">[</span><span class="w"> </span><span class="err">]</span><span class="w"> </span><span class="n">모든</span><span class="w"> </span><span class="n">테이블에</span><span class="w"> </span><span class="n">명확한</span><span class="w"> </span><span class="n">기본</span><span class="w"> </span><span class="n">키</span>
<span class="err">[</span><span class="w"> </span><span class="err">]</span><span class="w"> </span><span class="n">모든</span><span class="w"> </span><span class="n">관계에</span><span class="w"> </span><span class="n">대한</span><span class="w"> </span><span class="n">외래</span><span class="w"> </span><span class="n">키</span><span class="w"> </span><span class="n">정의</span>
<span class="err">[</span><span class="w"> </span><span class="err">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="err">/</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">작업</span><span class="w"> </span><span class="n">지정</span><span class="w"> </span><span class="p">(</span><span class="k">CASCADE</span><span class="p">,</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span><span class="w"> </span><span class="k">RESTRICT</span><span class="p">)</span>
<span class="err">[</span><span class="w"> </span><span class="err">]</span><span class="w"> </span><span class="n">필수</span><span class="w"> </span><span class="n">필드에</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">제약조건</span>
<span class="err">[</span><span class="w"> </span><span class="err">]</span><span class="w"> </span><span class="n">도메인</span><span class="w"> </span><span class="n">검증을</span><span class="w"> </span><span class="n">위한</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="n">제약조건</span><span class="w"> </span><span class="p">(</span><span class="n">예</span><span class="err">:</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="err">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">rating</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="err">[</span><span class="w"> </span><span class="err">]</span><span class="w"> </span><span class="n">자연</span><span class="w"> </span><span class="n">키에</span><span class="w"> </span><span class="n">대한</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="n">제약조건</span><span class="w"> </span><span class="p">(</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">SKU</span><span class="p">)</span>
<span class="err">[</span><span class="w"> </span><span class="err">]</span><span class="w"> </span><span class="n">적절한</span><span class="w"> </span><span class="n">데이터</span><span class="w"> </span><span class="n">타입</span><span class="w"> </span><span class="p">(</span><span class="n">돈에</span><span class="w"> </span><span class="k">DECIMAL</span><span class="p">,</span><span class="w"> </span><span class="n">날짜에</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="p">)</span>
<span class="err">[</span><span class="w"> </span><span class="err">]</span><span class="w"> </span><span class="n">비정규화가</span><span class="w"> </span><span class="n">문서화되고</span><span class="w"> </span><span class="n">정당화되지</span><span class="w"> </span><span class="n">않는</span><span class="w"> </span><span class="n">한</span><span class="w"> </span><span class="n">중복</span><span class="w"> </span><span class="n">열</span><span class="w"> </span><span class="n">없음</span>
<span class="err">[</span><span class="w"> </span><span class="err">]</span><span class="w"> </span><span class="n">스키마가</span><span class="w"> </span><span class="n">최소</span><span class="w"> </span><span class="n">3NF</span><span class="w"> </span><span class="p">(</span><span class="n">가급적</span><span class="w"> </span><span class="n">BCNF</span><span class="p">)</span>
<span class="err">[</span><span class="w"> </span><span class="err">]</span><span class="w"> </span><span class="n">계층을</span><span class="w"> </span><span class="n">위한</span><span class="w"> </span><span class="n">자기</span><span class="w"> </span><span class="n">참조</span><span class="w"> </span><span class="n">FK</span><span class="w"> </span><span class="p">(</span><span class="n">카테고리</span><span class="p">,</span><span class="w"> </span><span class="n">댓글</span><span class="p">)</span>
</code></pre></div>

<h3 id="92">9.2 인덱싱<a class="header-link" href="#92" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>[ ] 모든 외래 키에 인덱스 존재 (PostgreSQL은 FK 인덱스를 자동 생성하지 않음!)
[ ] 빈번한 쿼리의 WHERE, JOIN 및 ORDER BY 열을 인덱스가 다룸
[ ] 복합 인덱스가 왼쪽 접두사 규칙을 따름
[ ] 적절한 경우 부분 인덱스 사용 (WHERE is_active = TRUE)
[ ] 전체 텍스트 검색 및 배열 열을 위한 GIN 인덱스
[ ] 중복 인덱스 없음 (인덱스 (a, b)는 인덱스 (a)를 중복으로 만듦)
[ ] 인덱스 비대화 모니터링 계획
</code></pre></div>

<h3 id="93">9.3 데이터 무결성<a class="header-link" href="#93" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>[ ] 모든 돈 값이 DECIMAL 사용, FLOAT 안 함
[ ] 타임스탬프가 TIMESTAMPTZ 사용 (타임존 인식)
[ ] 상태 필드에 대한 Enum 타입 또는 CHECK 제약조건
[ ] 불변 필드가 보호됨 (주문 합계, 과거 가격)
[ ] 각 테이블에 대한 소프트 삭제 vs 하드 삭제 결정 문서화
[ ] 데이터 보존 정책 정의
</code></pre></div>

<h3 id="94">9.4 성능<a class="header-link" href="#94" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>[ ] 모든 중요 쿼리에 EXPLAIN ANALYZE 실행
[ ] 인덱스된 쿼리에 대한 대형 테이블에서 순차 스캔 없음
[ ] 페이지네이션이 OFFSET이 아닌 키셋 페이지네이션 사용
[ ] N+1 쿼리 패턴 제거 (JOIN 또는 배치 페칭 사용)
[ ] 연결 풀링 구성 (PgBouncer)
[ ] 적절한 work_mem 및 shared_buffers 설정
</code></pre></div>

<h3 id="95">9.5 트랜잭션<a class="header-link" href="#95" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>[ ] 각 트랜잭션 유형에 대한 격리 수준 선택
[ ] 잠금 전략 문서화 (어떤 행/테이블이 잠김)
[ ] 교착 상태 방지를 위한 잠금 순서 정의
[ ] 장기 실행 트랜잭션 회피 (트랜잭션 내부에 API 호출 없음)
[ ] 직렬화 실패를 위한 재시도 로직
[ ] 교착 상태 탐지 타임아웃 구성
</code></pre></div>

<h3 id="96">9.6 보안<a class="header-link" href="#96" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>[ ] 평문 비밀번호 없음 (bcrypt/argon2 해시 사용)
[ ] 카드 번호가 아닌 결제 토큰 저장 (PCI-DSS)
[ ] 다중 테넌트 데이터를 위한 행 수준 보안 (RLS)
[ ] 애플리케이션 사용자가 최소 권한 (SUPERUSER 없음)
[ ] SQL 인젝션 방지 (매개변수화된 쿼리만)
[ ] 민감한 작업에 대한 감사 로깅
</code></pre></div>

<h3 id="97">9.7 운영<a class="header-link" href="#97" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>[ ] 백업 전략 정의 (pg_dump 일정, WAL 아카이빙)
[ ] 시점 복구 (PITR) 테스트됨
[ ] 모니터링: 쿼리 지연시간, 연결 수, 테이블 비대화, 복제 지연
[ ] 스키마 마이그레이션 도구 사용 (Flyway, Alembic, golang-migrate)
[ ] 일반적인 장애 시나리오를 위한 런북 (디스크 가득 참, 복제 지연, 교착 상태)
</code></pre></div>

<hr />
<h2 id="10">10. 일반적인 설계 실수 및 회피 방법<a class="header-link" href="#10" title="Permanent link">&para;</a></h2>
<h3 id="1-float">실수 1: 돈에 FLOAT 사용<a class="header-link" href="#1-float" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 나쁨: 부동소수점 산술이 반올림 오류 발생</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">total</span><span class="w"> </span><span class="nb">FLOAT</span><span class="w">  </span><span class="c1">-- 0.1 + 0.2 = 0.30000000000000004</span>
<span class="p">);</span>

<span class="c1">-- 좋음: 정확한 십진수 타입 사용</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">total</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="c1">-- 0.1 + 0.2 = 0.30</span>
<span class="p">);</span>
</code></pre></div>

<h3 id="2">실수 2: 외래 키 인덱스 누락<a class="header-link" href="#2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- PostgreSQL은 PRIMARY KEY와 UNIQUE에 대한 인덱스를 생성하지만 FOREIGN KEY에는 안 함!</span>
<span class="c1">-- 이는 FK 열에 대한 JOIN 쿼리가 순차 스캔을 수행한다는 것을 의미.</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">order_items</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">order_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">orders</span><span class="p">(</span><span class="n">id</span><span class="p">),</span><span class="w">  </span><span class="c1">-- 자동 인덱스 없음!</span>
<span class="w">    </span><span class="n">product_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">  </span><span class="c1">-- 자동 인덱스 없음!</span>
<span class="p">);</span>

<span class="c1">-- 수정: 항상 FK 열에 인덱스 생성</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_order_items_order</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">order_items</span><span class="p">(</span><span class="n">order_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_order_items_product</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">order_items</span><span class="p">(</span><span class="n">product_id</span><span class="p">);</span>
</code></pre></div>

<h3 id="3">실수 3: 유지보수 전략 없이 파생 데이터 저장<a class="header-link" href="#3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 비정규화는 괜찮지만 일관성을 유지해야 함</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">avg_rating</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

<span class="c1">-- 나쁨: 수동 업데이트하고 개발자가 기억하기를 바람</span>
<span class="c1">-- 좋음: 트리거 사용</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">update_product_rating</span><span class="p">()</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">$$</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">SET</span>
<span class="w">        </span><span class="n">avg_rating</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">rating</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">reviews</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">product_id</span><span class="p">),</span>
<span class="w">        </span><span class="n">review_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">reviews</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">product_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">product_id</span><span class="p">;</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="k">NEW</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">trg_update_product_rating</span>
<span class="k">AFTER</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">reviews</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">update_product_rating</span><span class="p">();</span>
</code></pre></div>

<h3 id="4-offset">실수 4: OFFSET 기반 페이지네이션<a class="header-link" href="#4-offset" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 나쁨: OFFSET이 행을 스캔하고 버림. 페이지 1000이 20,000행 읽음!</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="mi">19980</span><span class="p">;</span>
<span class="c1">-- ↑ 20,000행 읽고, 19,980 버리고, 20 반환.</span>

<span class="c1">-- 좋음: 키셋 페이지네이션 (커서 기반)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="err">$</span><span class="n">last_seen_created_at</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>
<span class="c1">-- ↑ 인덱스 사용, 페이지 번호에 관계없이 정확히 20행 읽음.</span>
</code></pre></div>

<h3 id="5-eav">실수 5: 신 테이블 (EAV 안티패턴)<a class="header-link" href="#5-eav" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 나쁨: Entity-Attribute-Value 패턴</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">properties</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">entity_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span><span class="w">   </span><span class="c1">-- &#39;product&#39;, &#39;user&#39;, etc.</span>
<span class="w">    </span><span class="n">entity_id</span><span class="w">   </span><span class="nb">BIGINT</span><span class="p">,</span>
<span class="w">    </span><span class="k">key</span><span class="w">         </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span><span class="w">  </span><span class="c1">-- &#39;color&#39;, &#39;size&#39;, &#39;price&#39;</span>
<span class="w">    </span><span class="n">value</span><span class="w">       </span><span class="nb">TEXT</span><span class="w">           </span><span class="c1">-- 모든 것이 문자열!</span>
<span class="p">);</span>

<span class="c1">-- 문제:</span>
<span class="c1">-- 1. 타입 안전성 없음 (가격이 텍스트로 저장됨)</span>
<span class="c1">-- 2. 제약조건 없음 (&quot;price &gt;= 0&quot; 강제할 수 없음)</span>
<span class="c1">-- 3. 외래 키 없음</span>
<span class="c1">-- 4. 끔찍한 쿼리 성능 (피벗 쿼리가 느림)</span>
<span class="c1">-- 5. 스키마 문서화 없음</span>

<span class="c1">-- 좋음: 타입이 지정된 열이 있는 적절한 테이블 사용</span>
<span class="c1">-- 속성이 카테고리별로 다르면 고려:</span>
<span class="c1">--   1. 유연한 속성을 위한 PostgreSQL JSONB 열</span>
<span class="c1">--   2. 카테고리별 별도 테이블 (product_electronics, product_clothing)</span>
<span class="c1">--   3. 하이브리드: products의 공통 열 + 카테고리 특정을 위한 JSONB</span>
</code></pre></div>

<h3 id="6">실수 6: 과거 데이터 캡처하지 않음<a class="header-link" href="#6" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 나쁨: 현재 상태만 저장</span>
<span class="c1">-- 제품 가격이 변경되면 모든 과거 주문이 새 가격을 표시!</span>

<span class="c1">-- 좋음: 이벤트 시점의 상태 캡처</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">order_items</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">product_id</span><span class="w">  </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">quantity</span><span class="w">    </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">unit_price</span><span class="w">  </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w">  </span><span class="c1">-- 주문 시점의 가격, 현재 가격 아님</span>
<span class="w">    </span><span class="n">product_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w">    </span><span class="c1">-- 선택사항: 주문 시점의 제품 이름 스냅샷</span>
<span class="p">);</span>
</code></pre></div>

<h3 id="7">실수 7: 조기 비정규화<a class="header-link" href="#7" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">단계</span><span class="o">:</span><span class="w"> </span><span class="err">사용자가</span><span class="w"> </span><span class="err">없기</span><span class="w"> </span><span class="err">전</span>
<span class="err">개발자</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;성능을 위해 모든 것을 비정규화합시다!&quot;</span>

<span class="err">현실</span><span class="w"> </span><span class="err">확인</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="err">적절하게</span><span class="w"> </span><span class="err">인덱스된</span><span class="w"> </span><span class="n">PostgreSQL은</span><span class="w"> </span><span class="err">최대</span><span class="w"> </span><span class="mi">1</span><span class="err">억</span><span class="w"> </span><span class="err">행까지</span><span class="w"> </span><span class="err">대부분의</span><span class="w"> </span><span class="err">워크로드를</span><span class="w"> </span><span class="err">처리</span><span class="w"> </span><span class="err">가능</span>
<span class="o">-</span><span class="w"> </span><span class="err">정규화된</span><span class="w"> </span><span class="err">상태로</span><span class="w"> </span><span class="err">시작</span><span class="o">,</span><span class="w"> </span><span class="err">측정</span><span class="o">,</span><span class="w"> </span><span class="err">측정이</span><span class="w"> </span><span class="err">문제를</span><span class="w"> </span><span class="err">보이는</span><span class="w"> </span><span class="err">곳에서</span><span class="w"> </span><span class="err">비정규화</span>
<span class="o">-</span><span class="w"> </span><span class="err">조기</span><span class="w"> </span><span class="err">비정규화는</span><span class="w"> </span><span class="err">측정</span><span class="w"> </span><span class="err">가능한</span><span class="w"> </span><span class="err">이점</span><span class="w"> </span><span class="err">없이</span><span class="w"> </span><span class="err">유지보수</span><span class="w"> </span><span class="err">악몽을</span><span class="w"> </span><span class="err">만듦</span>

<span class="err">경험칙</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="err">천만</span><span class="w"> </span><span class="err">행</span><span class="w"> </span><span class="err">미만이고</span><span class="w"> </span><span class="err">쿼리가</span><span class="w"> </span><span class="err">인덱스를</span><span class="w"> </span><span class="err">사용하면</span>
<span class="err">비정규화가</span><span class="w"> </span><span class="err">필요</span><span class="w"> </span><span class="err">없을</span><span class="w"> </span><span class="err">가능성이</span><span class="w"> </span><span class="err">높음</span><span class="o">.</span>
</code></pre></div>

<h3 id="8-null">실수 8: NULL 의미론 무시<a class="header-link" href="#8-null" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 놀람: NULL 비교가 예상대로 작동하지 않음</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">category_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="c1">-- category_id가 NULL인 행을 반환하지 않음!</span>

<span class="c1">-- 수정: NULL을 명시적으로 처리</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">category_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">category_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
<span class="c1">-- 또는: WHERE category_id IS DISTINCT FROM 5;</span>

<span class="c1">-- 또한: COUNT(column)은 NULL을 무시, COUNT(*)는 모든 행을 세음</span>
<span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">phone</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="p">;</span><span class="w">  </span><span class="c1">-- NULL이 아닌 전화번호만 세음</span>
<span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="p">;</span><span class="w">      </span><span class="c1">-- 모든 고객 세음</span>
</code></pre></div>

<h3 id="9_1">실수 9: 쉼표로 구분된 값 저장<a class="header-link" href="#9_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 나쁨: 단일 열에 여러 값 저장</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">tags</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w">  </span><span class="c1">-- &quot;electronics,wireless,bluetooth&quot;</span>
<span class="p">);</span>

<span class="c1">-- 문제:</span>
<span class="c1">-- 1. 개별 태그를 효율적으로 인덱스할 수 없음</span>
<span class="c1">-- 2. 참조 무결성 강제할 수 없음</span>
<span class="c1">-- 3. &quot;태그 &#39;wireless&#39;가 있는 제품 찾기&quot;는 LIKE &#39;%wireless%&#39; 필요 (느리고, 부정확)</span>
<span class="c1">-- 4. tags 테이블과 JOIN할 수 없음</span>
<span class="c1">-- 5. 1NF 위반</span>

<span class="c1">-- 좋음: 접합 테이블 사용</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tags</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">product_tags</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">product_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">products</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">tag_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">tags</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="n">tag_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- 또는 GIN 인덱스와 함께 PostgreSQL 배열 사용</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">tags</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">[]</span>
<span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_products_tags</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">GIN</span><span class="p">(</span><span class="n">tags</span><span class="p">);</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">tags</span><span class="w"> </span><span class="o">@&gt;</span><span class="w"> </span><span class="nb">ARRAY</span><span class="p">[</span><span class="s1">&#39;wireless&#39;</span><span class="p">];</span>
</code></pre></div>

<h3 id="10_1">실수 10: 스키마 진화 계획하지 않음<a class="header-link" href="#10_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 나쁨: 마이그레이션 도구 없음, 프로덕션에서 수동 ALTER TABLE</span>

<span class="c1">-- 좋음: 마이그레이션 도구 사용 (Flyway, Alembic, golang-migrate)</span>
<span class="c1">-- 각 마이그레이션은 버전이 지정된 가역 SQL 파일:</span>

<span class="c1">-- V001__create_customers.sql</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="p">(...);</span>

<span class="c1">-- V002__add_phone_to_customers.sql</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">phone</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

<span class="c1">-- V003__create_orders.sql</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(...);</span>

<span class="c1">-- 이점:</span>
<span class="c1">-- 1. 모든 스키마 변경이 버전 제어됨</span>
<span class="c1">-- 2. 환경 간 재현 가능 (개발, 스테이징, 프로덕션)</span>
<span class="c1">-- 3. 롤백 기능</span>
<span class="c1">-- 4. 팀 협업 (충돌하는 수동 변경 없음)</span>
</code></pre></div>

<hr />
<h2 id="11">11. 연습 문제<a class="header-link" href="#11" title="Permanent link">&para;</a></h2>
<h3 id="1_1">연습 문제 1: 전자상거래 스키마 완성<a class="header-link" href="#1_1" title="Permanent link">&para;</a></h3>
<p>위의 ShopWave 스키마는 여러 기능이 누락되어 있습니다. 다음을 지원하도록 확장하세요:</p>
<ol>
<li><strong>제품 변형</strong>: 제품은 변형을 가질 수 있음 (예: "파란색, 대형", "빨간색, 소형") 각각 자체 가격, SKU 및 재고 수량. 테이블 설계.</li>
<li><strong>주문 상태 이력</strong>: 단일 상태 필드 대신, 타임스탬프와 변경한 사용자와 함께 모든 상태 변경을 추적.</li>
<li><strong>판매자 지급</strong>: 판매자를 위한 수수료 계산 및 지급 이력 추적.</li>
</ol>
<p>각 확장에 대한 CREATE TABLE 문을 작성하고 기존 스키마와 통합하는 방법을 설명하세요.</p>
<h3 id="2_1">연습 문제 2: 정규화 분석<a class="header-link" href="#2_1" title="Permanent link">&para;</a></h3>
<p>이 비정규화된 주문 테이블을 고려하세요:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">flat_orders</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">order_id</span><span class="w">        </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_name</span><span class="w">   </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">customer_email</span><span class="w">  </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<span class="w">    </span><span class="n">product_name</span><span class="w">    </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<span class="w">    </span><span class="n">product_sku</span><span class="w">     </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
<span class="w">    </span><span class="n">product_price</span><span class="w">   </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
<span class="w">    </span><span class="n">quantity</span><span class="w">        </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">order_total</span><span class="w">     </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
<span class="w">    </span><span class="n">order_date</span><span class="w">      </span><span class="nb">DATE</span><span class="p">,</span>
<span class="w">    </span><span class="n">shipping_street</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<span class="w">    </span><span class="n">shipping_city</span><span class="w">   </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">shipping_zip</span><span class="w">    </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>

<ol>
<li>모든 함수 종속성을 나열하세요.</li>
<li>후보 키를 식별하세요.</li>
<li>테이블이 1NF, 2NF, 3NF 및 BCNF에 있는지 결정하세요.</li>
<li>BCNF로 분해하고, 각 분해 단계를 보여주세요.</li>
<li>분해가 무손실 조인인지 확인하세요.</li>
</ol>
<h3 id="3_1">연습 문제 3: 인덱스 설계 도전<a class="header-link" href="#3_1" title="Permanent link">&para;</a></h3>
<p>ShopWave 스키마와 다음 쿼리 패턴을 고려:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Q1: 카테고리에서 판매 중인 제품 (price &lt; original_price)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">category_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">sale_price</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="p">(</span><span class="n">price</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sale_price</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>

<span class="c1">-- Q2: 날짜 범위에서 특정 상태의 고객 주문</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="err">$</span><span class="mi">3</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="err">$</span><span class="mi">4</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>

<span class="c1">-- Q3: 특정 고객이 리뷰한 제품</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">rating</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">created_at</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">reviews</span><span class="w"> </span><span class="n">r</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>

<span class="c1">-- Q4: 이번 달에 가장 많은 주문이 있는 판매자</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">company_name</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">order_count</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">sellers</span><span class="w"> </span><span class="n">s</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">seller_id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">order_items</span><span class="w"> </span><span class="n">oi</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oi</span><span class="p">.</span><span class="n">product_id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">oi</span><span class="p">.</span><span class="n">order_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="p">)</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_count</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</code></pre></div>

<p>각 쿼리에 대해:
1. 최적의 인덱스를 설계하세요.
2. 예상되는 EXPLAIN 계획을 작성하세요.
3. 각 술어의 선택도를 추정하세요.</p>
<h3 id="4">연습 문제 4: 트랜잭션 설계<a class="header-link" href="#4" title="Permanent link">&para;</a></h3>
<p>다음 비즈니스 작업을 위한 트랜잭션을 설계하세요:</p>
<p><strong>대량 할인 적용</strong>: 관리자가 "전자제품" 카테고리의 모든 제품 가격을 15% 인하하고, 제품당 할인을 $50로 제한하고, 변경을 감사 테이블에 기록하려고 합니다.</p>
<p>요구사항:
- 제품이 중간 상태에서 고객에게 보여서는 안 됨 (부분적으로 할인)
- 작업이 제품 읽기를 1초 이상 차단해서는 안 됨
- 모든 변경은 변경 전/후 값과 함께 기록되어야 함</p>
<p>트랜잭션 SQL을 작성하고 격리 수준을 지정하세요.</p>
<h3 id="5">연습 문제 5: 자신만의 데이터베이스 설계<a class="header-link" href="#5" title="Permanent link">&para;</a></h3>
<p>다음 시나리오 중 하나를 선택하고 전체 데이터베이스 설계를 완성하세요 (단계 1-6):</p>
<p><strong>옵션 A: 도서관 관리 시스템</strong>
- 이용자, 책 (여러 사본), 대출, 예약, 벌금
- 이용자는 14일간 최대 5권 대출 가능
- 연체 반납은 $0.25/일 벌금 발생
- 모든 사본이 대출 중이면 책을 예약 가능
- 사서는 책을 추가/제거하고 이용자 계정 관리 가능</p>
<p><strong>옵션 B: 레스토랑 예약 시스템</strong>
- 레스토랑, 테이블, 예약, 고객, 대기 목록
- 레스토랑은 다양한 크기의 테이블 (2, 4, 6, 8명)
- 예약은 특정 날짜/시간 및 인원수
- 테이블이 없으면 대기 목록
- 고객은 레스토랑 리뷰 남길 수 있음</p>
<p><strong>옵션 C: 온라인 학습 플랫폼</strong>
- 강좌, 레슨, 학생, 등록, 진도 추적, 퀴즈
- 강좌는 정의된 순서로 여러 레슨
- 학생은 진도 추적 (완료된 레슨, 퀴즈 점수)
- 강사는 강좌 생성 및 관리
- 강좌 완료 시 인증서 발급</p>
<p>선택한 시나리오에 대해 다음을 생성하세요:
1. 기능 요구사항 (최소 8개)
2. 물량 추정이 있는 데이터 요구사항
3. 카디널리티가 있는 ER 다이어그램
4. 정규화된 관계형 스키마 (CREATE TABLE 문)
5. 정당화가 있는 인덱싱 전략
6. 격리 수준 및 잠금 전략이 있는 두 개의 중요 트랜잭션
7. 예상 실행 계획이 있는 세 개의 대표 쿼리</p>
<h3 id="6_1">연습 문제 6: 이 설계 비평<a class="header-link" href="#6_1" title="Permanent link">&para;</a></h3>
<p>다음 스키마에서 최소 8개의 문제를 찾아 수정하세요:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">email</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">password</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">created</span><span class="w"> </span><span class="nb">DATE</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">title</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">price</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span>
<span class="w">    </span><span class="n">category</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">tags</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">  </span><span class="c1">-- 쉼표로 구분: &quot;electronics,sale,new&quot;</span>
<span class="w">    </span><span class="n">stock</span><span class="w"> </span><span class="nb">INT</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">user_email</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">product_ids</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">  </span><span class="c1">-- 쉼표로 구분: &quot;1,5,12&quot;</span>
<span class="w">    </span><span class="n">quantities</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">   </span><span class="c1">-- 쉼표로 구분: &quot;2,1,3&quot;</span>
<span class="w">    </span><span class="n">total</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="nb">date</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">);</span>
</code></pre></div>

<p>각 문제에 대해:
1. 문제를 식별하세요.
2. 문제가 있는 이유를 설명하세요.
3. 수정된 SQL을 제공하세요.</p>
<h3 id="7_1">연습 문제 7: 전자상거래 설계 확장<a class="header-link" href="#7_1" title="Permanent link">&para;</a></h3>
<p>ShopWave 플랫폼이 다음과 같이 성장했습니다:
- 5천만 고객
- 1천만 제품
- 5억 주문
- 15억 주문 항목
- 1억 리뷰</p>
<p>현재 단일 노드 PostgreSQL은 더 이상 부하를 처리할 수 없습니다. 확장 전략을 제안하세요:</p>
<ol>
<li>어떤 테이블을 파티션해야 합니까? 어떤 키로?</li>
<li>어떤 테이블에 읽기 복제본이 필요합니까?</li>
<li>어떤 데이터를 Redis로 이동해야 합니까 (캐싱)?</li>
<li>어떤 데이터를 다른 데이터베이스 타입으로 이동해야 합니까 (예: 검색을 위한 Elasticsearch, 주문 이력을 위한 Cassandra)? 정당화하세요.</li>
<li>다운타임 없이 단일 데이터베이스에서 분산 아키텍처로 전환을 어떻게 처리하시겠습니까?</li>
</ol>
<h3 id="8_1">연습 문제 8: 소셜 미디어 피드 설계<a class="header-link" href="#8_1" title="Permanent link">&para;</a></h3>
<p>섹션 8의 SocialBuzz 스키마를 사용:</p>
<ol>
<li>하이브리드 피드 모델을 구현하세요: 일반 사용자가 게시물을 생성하는 푸시 경로와 읽기 시점에 유명인 게시물을 병합하는 풀 경로 모두에 대한 SQL을 작성하세요.</li>
<li>5백만 팔로워를 가진 유명인이 사용자 이름을 변경합니다. feed_items 테이블을 효율적으로 어떻게 업데이트하시겠습니까?</li>
<li>"트렌딩 게시물" 기능을 설계하세요: 지난 24시간 동안 가장 많은 좋아요를 받은 50개 게시물 표시. 어떤 인덱스가 필요합니까? like_count의 쓰기 부하를 어떻게 처리하시겠습니까?</li>
<li>사용자가 다른 사용자를 차단합니다. 피드 시스템에 어떤 변경이 필요합니까?</li>
</ol>
<h3 id="9_2">연습 문제 9: 마이그레이션 계획<a class="header-link" href="#9_2" title="Permanent link">&para;</a></h3>
<p>실시간 ShopWave 데이터베이스에 "제품 변형" 기능을 추가해야 합니다 (연습 문제 1 참조). 다운타임 없는 마이그레이션 계획을 작성하세요:</p>
<ol>
<li>순서대로 마이그레이션 단계를 나열하세요.</li>
<li>각 단계에 대해, 잠금이 필요한지와 얼마나 오래 걸리는지 지정하세요.</li>
<li>마이그레이션 단계 간에 필요한 역호환 애플리케이션 변경을 설명하세요.</li>
<li>마이그레이션 중간에 문제가 발생하면 롤백 계획은 무엇입니까?</li>
</ol>
<h3 id="10_2">연습 문제 10: 설계 검토<a class="header-link" href="#10_2" title="Permanent link">&para;</a></h3>
<p>설계 검토 체크리스트 (섹션 9)에 대해 완전한 ShopWave 스키마 (단계 3 DDL)를 검토하세요. 아직 충족되지 않은 각 체크리스트 항목에 대해, 간격을 설명하고 SQL 수정을 제공하세요. 최소 5개의 간격을 찾으세요.</p>
<hr />
<h2 id="12">12. 참고문헌<a class="header-link" href="#12" title="Permanent link">&para;</a></h2>
<ol>
<li>Elmasri, R. &amp; Navathe, S. (2016). <em>Fundamentals of Database Systems</em>, 7th Edition. Pearson. Chapters 3-9.</li>
<li>Garcia-Molina, H., Ullman, J., &amp; Widom, J. (2008). <em>Database Systems: The Complete Book</em>, 2nd Edition. Pearson.</li>
<li>Kleppmann, M. (2017). <em>Designing Data-Intensive Applications</em>. O'Reilly Media. Chapters 2-3.</li>
<li>Winand, M. (2012). <em>SQL Performance Explained</em>. https://use-the-index-luke.com/</li>
<li>PostgreSQL Documentation. "Partitioning." https://www.postgresql.org/docs/current/ddl-partitioning.html</li>
<li>PostgreSQL Documentation. "Concurrency Control." https://www.postgresql.org/docs/current/mvcc.html</li>
<li>Karwin, B. (2010). <em>SQL Antipatterns</em>. Pragmatic Bookshelf.</li>
<li>Kleppmann, M. (2012). "Designing Data-Intensive Applications: Partitioning." Chapter 6.</li>
<li>Sadalage, P. &amp; Fowler, M. (2012). <em>NoSQL Distilled</em>. Addison-Wesley. (For polyglot persistence comparisons.)</li>
<li>Twitter Engineering Blog. (2013). "How Twitter Stores 250 Million Tweets a Day."</li>
</ol>
<hr />
<p><strong>이전</strong>: <a href="./15_NewSQL_and_Modern_Trends.md">15. NewSQL과 현대 트렌드</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Database_Theory/15_NewSQL_and_Modern_Trends.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">NewSQL과 현대 트렌드</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">🔗</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Database_Theory/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">📋</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">↑</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'ko';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}