{% raw %}
<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>33. 확산 모델(Diffusion Models, DDPM) - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/ko/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/ko/" class="nav-item ">
                    <span class="nav-icon">🏠</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">💻</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/ko/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" >
                        English
                    </option>
                    
                    <option value="ko" selected>
                        한국어
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">☀️</span>
                    <span class="theme-icon dark">🌙</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/ko/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/ko/Deep_Learning/">Deep Learning</a>
    <span class="separator">/</span>
    <span class="current">33. 확산 모델(Diffusion Models, DDPM)</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>33. 확산 모델(Diffusion Models, DDPM)</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Deep_Learning/32_Diffusion_Models.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">32. Diffusion Models</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">🔗</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Deep_Learning/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">📋</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Deep_Learning/34_CLIP_Multimodal.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">34. CLIP과 멀티모달 학습</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#_1">개요</a></li>
<li><a href="#_2">수학적 배경</a><ul>
<li><a href="#1-forward-diffusion-process">1. 순방향 확산 과정(Forward Diffusion Process)</a></li>
<li><a href="#2-reverse-diffusion-process">2. 역방향 확산 과정(Reverse Diffusion Process)</a></li>
<li><a href="#3-training-objective">3. 학습 목적 함수(Training Objective)</a></li>
<li><a href="#4-samplinggeneration">4. 샘플링(생성, Sampling/Generation)</a></li>
</ul>
</li>
<li><a href="#ddpm">DDPM 아키텍처</a><ul>
<li><a href="#unetunet-with-time-embedding">시간 임베딩을 갖는 UNet(UNet with Time Embedding)</a></li>
<li><a href="#resblockresblock-with-time-embedding">시간 임베딩을 갖는 ResBlock(ResBlock with Time Embedding)</a></li>
</ul>
</li>
<li><a href="#noise-schedule">노이즈 스케줄(Noise Schedule)</a><ul>
<li><a href="#linear-schedule">선형 스케줄(Linear Schedule)</a></li>
<li><a href="#cosine-schedule-improved">코사인 스케줄(개선된 버전, Cosine Schedule - Improved)</a></li>
</ul>
</li>
<li><a href="#_3">파일 구조</a></li>
<li><a href="#_4">핵심 개념</a><ul>
<li><a href="#1-ddpm-vs-ddim">1. DDPM vs DDIM 샘플링</a></li>
<li><a href="#2-classifier-guidance">2. 분류기 가이던스(Classifier Guidance)</a></li>
<li><a href="#3-classifier-free-guidance">3. 분류기 프리 가이던스(Classifier-Free Guidance)</a></li>
<li><a href="#4">4. 학습 팁</a></li>
</ul>
</li>
<li><a href="#_5">구현 레벨</a><ul>
<li><a href="#2-pytorch-pytorch_lowlevel">레벨 2: PyTorch 로우레벨 (pytorch_lowlevel/)</a></li>
<li><a href="#3-paper">레벨 3: 논문 구현 (paper/)</a></li>
</ul>
</li>
<li><a href="#_6">학습 루프</a></li>
<li><a href="#_7">샘플링 루프</a></li>
<li><a href="#_8">학습 체크리스트</a></li>
<li><a href="#_9">참고 문헌</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <p><a href="./32_Diffusion_Models.md">이전: Diffusion Models</a> | <a href="./34_CLIP_Multimodal.md">다음: CLIP과 멀티모달 학습</a></p>
<hr />
<h1 id="33-diffusion-models-ddpm">33. 확산 모델(Diffusion Models, DDPM)<a class="header-link" href="#33-diffusion-models-ddpm" title="Permanent link">&para;</a></h1>
<h2 id="_1">개요<a class="header-link" href="#_1" title="Permanent link">&para;</a></h2>
<p>디노이징 확산 확률 모델(Denoising Diffusion Probabilistic Models, DDPM)은 점진적인 노이즈 추가 과정을 역전시켜 데이터를 생성하는 강력한 생성 모델입니다. "Denoising Diffusion Probabilistic Models" (Ho et al., 2020)</p>
<hr />
<h2 id="_2">수학적 배경<a class="header-link" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="1-forward-diffusion-process">1. 순방향 확산 과정(Forward Diffusion Process)<a class="header-link" href="#1-forward-diffusion-process" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">목표</span><span class="o">:</span><span class="w"> </span><span class="err">데이터</span><span class="w"> </span><span class="n">x₀에</span><span class="w"> </span><span class="err">점진적으로</span><span class="w"> </span><span class="err">가우시안</span><span class="w"> </span><span class="err">노이즈</span><span class="w"> </span><span class="err">추가</span>

<span class="n">q</span><span class="o">(</span><span class="n">xₜ</span><span class="o">|</span><span class="n">xₜ</span><span class="err">₋₁</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="o">(</span><span class="n">xₜ</span><span class="o">;</span><span class="w"> </span><span class="err">√</span><span class="o">(</span><span class="mi">1</span><span class="o">-</span><span class="err">βₜ</span><span class="o">)</span><span class="n">xₜ</span><span class="err">₋₁</span><span class="o">,</span><span class="w"> </span><span class="err">βₜ</span><span class="n">I</span><span class="o">)</span>

<span class="err">여기서</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">x₀</span><span class="o">:</span><span class="w"> </span><span class="err">원본</span><span class="w"> </span><span class="err">데이터</span>
<span class="o">-</span><span class="w"> </span><span class="n">xₜ</span><span class="o">:</span><span class="w"> </span><span class="err">타임스텝</span><span class="w"> </span><span class="n">t에서의</span><span class="w"> </span><span class="err">노이즈가</span><span class="w"> </span><span class="err">있는</span><span class="w"> </span><span class="err">데이터</span>
<span class="o">-</span><span class="w"> </span><span class="err">βₜ</span><span class="o">:</span><span class="w"> </span><span class="err">노이즈</span><span class="w"> </span><span class="err">스케줄</span><span class="w"> </span><span class="o">(</span><span class="err">β₁</span><span class="o">,</span><span class="w"> </span><span class="o">...,</span><span class="w"> </span><span class="err">βₜ</span><span class="o">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">T</span><span class="o">:</span><span class="w"> </span><span class="err">전체</span><span class="w"> </span><span class="err">타임스텝</span><span class="w"> </span><span class="o">(</span><span class="err">일반적으로</span><span class="w"> </span><span class="mi">1000</span><span class="o">)</span>

<span class="err">닫힌</span><span class="w"> </span><span class="err">형식</span><span class="o">(</span><span class="n">Closed</span><span class="w"> </span><span class="n">form</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="err">αₜ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">βₜ</span><span class="o">,</span><span class="w"> </span><span class="err">ᾱₜ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">∏ᵢ₌₁ᵗ</span><span class="w"> </span><span class="err">αᵢ</span><span class="w"> </span><span class="err">사용</span><span class="o">):</span>
<span class="n">q</span><span class="o">(</span><span class="n">xₜ</span><span class="o">|</span><span class="n">x₀</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="o">(</span><span class="n">xₜ</span><span class="o">;</span><span class="w"> </span><span class="err">√ᾱₜ</span><span class="w"> </span><span class="n">x₀</span><span class="o">,</span><span class="w"> </span><span class="o">(</span><span class="mi">1</span><span class="o">-</span><span class="err">ᾱₜ</span><span class="o">)</span><span class="n">I</span><span class="o">)</span>

<span class="n">xₜ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">√ᾱₜ</span><span class="w"> </span><span class="n">x₀</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="err">√</span><span class="o">(</span><span class="mi">1</span><span class="o">-</span><span class="err">ᾱₜ</span><span class="o">)</span><span class="w"> </span><span class="err">ε</span><span class="o">,</span><span class="w">  </span><span class="err">ε</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">N</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="n">I</span><span class="o">)</span>

<span class="n">t</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">T일</span><span class="w"> </span><span class="err">때</span><span class="o">:</span><span class="w"> </span><span class="n">xₜ</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">N</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="n">I</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="err">순수</span><span class="w"> </span><span class="err">노이즈</span><span class="o">)</span>
</code></pre></div>

<h3 id="2-reverse-diffusion-process">2. 역방향 확산 과정(Reverse Diffusion Process)<a class="header-link" href="#2-reverse-diffusion-process" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">목표</span><span class="o">:</span><span class="w"> </span><span class="err">디노이징</span><span class="w"> </span><span class="n">p</span><span class="o">(</span><span class="n">xₜ</span><span class="err">₋₁</span><span class="o">|</span><span class="n">xₜ</span><span class="o">)</span><span class="w"> </span><span class="err">학습</span>

<span class="err">실제</span><span class="w"> </span><span class="err">사후</span><span class="w"> </span><span class="err">분포</span><span class="o">(</span><span class="n">Intractable</span><span class="o">):</span>
<span class="n">q</span><span class="o">(</span><span class="n">xₜ</span><span class="err">₋₁</span><span class="o">|</span><span class="n">xₜ</span><span class="o">,</span><span class="w"> </span><span class="n">x₀</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="o">(</span><span class="n">xₜ</span><span class="err">₋₁</span><span class="o">;</span><span class="w"> </span><span class="err">μ̃ₜ</span><span class="o">(</span><span class="n">xₜ</span><span class="o">,</span><span class="w"> </span><span class="n">x₀</span><span class="o">),</span><span class="w"> </span><span class="err">β̃ₜ</span><span class="n">I</span><span class="o">)</span>

<span class="err">여기서</span><span class="o">:</span>
<span class="err">μ̃ₜ</span><span class="o">(</span><span class="n">xₜ</span><span class="o">,</span><span class="w"> </span><span class="n">x₀</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="err">√ᾱₜ₋₁</span><span class="w"> </span><span class="err">βₜ</span><span class="o">)/(</span><span class="mi">1</span><span class="o">-</span><span class="err">ᾱₜ</span><span class="o">)</span><span class="w"> </span><span class="n">x₀</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">(</span><span class="err">√αₜ</span><span class="o">(</span><span class="mi">1</span><span class="o">-</span><span class="err">ᾱₜ₋₁</span><span class="o">))/(</span><span class="mi">1</span><span class="o">-</span><span class="err">ᾱₜ</span><span class="o">)</span><span class="w"> </span><span class="n">xₜ</span>
<span class="err">β̃ₜ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="mi">1</span><span class="o">-</span><span class="err">ᾱₜ₋₁</span><span class="o">)/(</span><span class="mi">1</span><span class="o">-</span><span class="err">ᾱₜ</span><span class="o">)</span><span class="w"> </span><span class="err">·</span><span class="w"> </span><span class="err">βₜ</span>

<span class="err">학습된</span><span class="w"> </span><span class="err">역방향</span><span class="w"> </span><span class="err">과정</span><span class="o">:</span>
<span class="n">pθ</span><span class="o">(</span><span class="n">xₜ</span><span class="err">₋₁</span><span class="o">|</span><span class="n">xₜ</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="o">(</span><span class="n">xₜ</span><span class="err">₋₁</span><span class="o">;</span><span class="w"> </span><span class="err">μθ</span><span class="o">(</span><span class="n">xₜ</span><span class="o">,</span><span class="w"> </span><span class="n">t</span><span class="o">),</span><span class="w"> </span><span class="err">Σθ</span><span class="o">(</span><span class="n">xₜ</span><span class="o">,</span><span class="w"> </span><span class="n">t</span><span class="o">))</span>

<span class="err">단순화</span><span class="o">:</span><span class="w"> </span><span class="err">평균</span><span class="w"> </span><span class="err">대신</span><span class="w"> </span><span class="err">노이즈</span><span class="w"> </span><span class="err">ε</span><span class="w"> </span><span class="err">예측</span>
<span class="err">εθ</span><span class="o">(</span><span class="n">xₜ</span><span class="o">,</span><span class="w"> </span><span class="n">t</span><span class="o">)</span><span class="w"> </span><span class="err">≈</span><span class="w"> </span><span class="err">ε</span>
</code></pre></div>

<h3 id="3-training-objective">3. 학습 목적 함수(Training Objective)<a class="header-link" href="#3-training-objective" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>변분 하한(Variational Lower Bound, ELBO):
L = Eₜ,x₀,ε[||ε - εθ(xₜ, t)||²]

여기서:
- t ~ Uniform(1, T)
- x₀ ~ q(x₀)
- ε ~ N(0, I)
- xₜ = √ᾱₜ x₀ + √(1-ᾱₜ) ε

예측된 노이즈에 대한 단순한 MSE 손실!

┌─────────────────────────────────────────┐
│  학습:                                  │
│  1. x₀, t, ε 샘플링                     │
│  2. xₜ = √ᾱₜ x₀ + √(1-ᾱₜ) ε 생성       │
│  3. ε̂ = εθ(xₜ, t) 예측                 │
│  4. 손실 = ||ε - ε̂||²                  │
└─────────────────────────────────────────┘
</code></pre></div>

<h3 id="4-samplinggeneration">4. 샘플링(생성, Sampling/Generation)<a class="header-link" href="#4-samplinggeneration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>xₜ ~ N(0, I)에서 시작

t = T, T-1, ..., 1에 대해:
    z ~ N(0, I) (t &gt; 1일 때), 그렇지 않으면 z = 0

    ε̂ = εθ(xₜ, t)

    xₜ₋₁ = 1/√αₜ (xₜ - (1-αₜ)/√(1-ᾱₜ) ε̂) + σₜz

여기서:
σₜ = √β̃ₜ 또는 √βₜ (분산 스케줄)

최종: x₀가 생성된 샘플
</code></pre></div>

<hr />
<h2 id="ddpm">DDPM 아키텍처<a class="header-link" href="#ddpm" title="Permanent link">&para;</a></h2>
<h3 id="unetunet-with-time-embedding">시간 임베딩을 갖는 UNet(UNet with Time Embedding)<a class="header-link" href="#unetunet-with-time-embedding" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>시간 임베딩(Sinusoidal Positional Encoding):
t (스칼라)
    ↓
PE(t, dim) = [sin(t/10000^(0/d)), cos(t/10000^(0/d)),
              sin(t/10000^(2/d)), cos(t/10000^(2/d)), ...]
    ↓
Linear(dim→4*dim) + SiLU + Linear(4*dim→4*dim)
    ↓
time_emb (공간 차원으로 브로드캐스트)


UNet 구조 (예: 32×32×3 이미지):

입력 xₜ (32×32×3) + time_emb
    ↓
┌─────────────────────────────────────────┐
│  인코더 (다운샘플링)                    │
├─────────────────────────────────────────┤
│ Conv(3→64) + TimeEmb + ResBlock         │ → skip1
│     ↓ Downsample                        │
│ Conv(64→128) + TimeEmb + ResBlock       │ → skip2
│     ↓ Downsample                        │
│ Conv(128→256) + TimeEmb + ResBlock      │ → skip3
│     ↓ Downsample                        │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  병목층(Bottleneck)                     │
│  Conv(256→512) + Attention + ResBlock   │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  디코더 (업샘플링)                      │
├─────────────────────────────────────────┤
│     ↑ Upsample + Concat(skip3)          │
│ Conv(512+256→256) + TimeEmb + ResBlock  │
│     ↑ Upsample + Concat(skip2)          │
│ Conv(256+128→128) + TimeEmb + ResBlock  │
│     ↑ Upsample + Concat(skip1)          │
│ Conv(128+64→64) + TimeEmb + ResBlock    │
└─────────────────────────────────────────┘
    ↓
Conv(64→3) + GroupNorm
    ↓
출력 εθ(xₜ, t) (32×32×3)
</code></pre></div>

<h3 id="resblockresblock-with-time-embedding">시간 임베딩을 갖는 ResBlock(ResBlock with Time Embedding)<a class="header-link" href="#resblockresblock-with-time-embedding" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>x, time_emb → ResBlock → out

┌─────────────────────────────────────────┐
│  GroupNorm → SiLU → Conv                │
│       ↓                                 │
│  + time_emb (브로드캐스트)              │
│       ↓                                 │
│  GroupNorm → SiLU → Conv                │
│       ↓                                 │
│  + skip connection (프로젝션 포함)      │
└─────────────────────────────────────────┘
</code></pre></div>

<hr />
<h2 id="noise-schedule">노이즈 스케줄(Noise Schedule)<a class="header-link" href="#noise-schedule" title="Permanent link">&para;</a></h2>
<h3 id="linear-schedule">선형 스케줄(Linear Schedule)<a class="header-link" href="#linear-schedule" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 선형 스케줄 (Ho et al., 2020)</span>
<span class="n">β</span><span class="err">₁</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">βₜ</span> <span class="o">=</span> <span class="mf">0.02</span>
<span class="n">βₜ</span> <span class="o">=</span> <span class="n">linear_interpolate</span><span class="p">(</span><span class="n">β</span><span class="err">₁</span><span class="p">,</span> <span class="n">βₜ</span><span class="p">,</span> <span class="n">t</span><span class="o">/</span><span class="n">T</span><span class="p">)</span>

<span class="c1"># 효율성을 위한 사전 계산</span>
<span class="n">αₜ</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">βₜ</span>
<span class="n">ᾱₜ</span> <span class="o">=</span> <span class="err">∏</span><span class="n">ᵢ</span><span class="err">₌₁</span><span class="n">ᵗ</span> <span class="n">αᵢ</span>
<span class="err">√</span><span class="n">ᾱₜ</span><span class="p">,</span> <span class="err">√</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ᾱₜ</span><span class="p">)</span>  <span class="c1"># 순방향 과정에서 사용</span>
</code></pre></div>

<h3 id="cosine-schedule-improved">코사인 스케줄(개선된 버전, Cosine Schedule - Improved)<a class="header-link" href="#cosine-schedule-improved" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 코사인 스케줄 (Nichol &amp; Dhariwal, 2021)</span>
<span class="n">s</span> <span class="o">=</span> <span class="mf">0.008</span>
<span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">=</span> <span class="n">cos</span><span class="err">²</span><span class="p">((</span><span class="n">t</span><span class="o">/</span><span class="n">T</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="err">·</span> <span class="n">π</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ᾱₜ</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">f</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">βₜ</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">αₜ</span><span class="o">/</span><span class="n">αₜ</span><span class="err">₋₁</span>

<span class="c1"># 더 부드러운 노이즈 스케줄, 고해상도에 더 적합</span>
</code></pre></div>

<hr />
<h2 id="_3">파일 구조<a class="header-link" href="#_3" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="mf">13</span><span class="n">_Diffusion</span><span class="o">/</span>
<span class="err">├──</span><span class="w"> </span><span class="kr">READ</span><span class="n">ME</span><span class="mf">.</span><span class="n">md</span>
<span class="err">├──</span><span class="w"> </span><span class="n">pytorch_lowlevel</span><span class="o">/</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">ddpm_mnist</span><span class="mf">.</span><span class="n">py</span><span class="w">         </span><span class="err">#</span><span class="w"> </span><span class="n">MNIST용</span><span class="w"> </span><span class="n">DDPM</span><span class="w"> </span><span class="p">(</span><span class="mf">28</span><span class="err">×</span><span class="mf">28</span><span class="p">)</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">ddpm_cifar</span><span class="mf">.</span><span class="n">py</span><span class="w">         </span><span class="err">#</span><span class="w"> </span><span class="n">CIFAR</span><span class="o">-</span><span class="mf">10</span><span class="n">용</span><span class="w"> </span><span class="n">DDPM</span><span class="w"> </span><span class="p">(</span><span class="mf">32</span><span class="err">×</span><span class="mf">32</span><span class="p">)</span>
<span class="err">├──</span><span class="w"> </span><span class="n">paper</span><span class="o">/</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">ddpm_paper</span><span class="mf">.</span><span class="n">py</span><span class="w">         </span><span class="err">#</span><span class="w"> </span><span class="n">전체</span><span class="w"> </span><span class="n">DDPM</span><span class="w"> </span><span class="n">구현</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">ddim_sampling</span><span class="mf">.</span><span class="n">py</span><span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="n">DDIM</span><span class="w"> </span><span class="n">빠른</span><span class="w"> </span><span class="n">샘플링</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="nb">cos</span><span class="n">ine_schedule</span><span class="mf">.</span><span class="n">py</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">개선된</span><span class="w"> </span><span class="n">노이즈</span><span class="w"> </span><span class="n">스케줄</span>
<span class="err">└──</span><span class="w"> </span><span class="n">exercises</span><span class="o">/</span>
<span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="mf">01</span><span class="n">_noise_schedule</span><span class="mf">.</span><span class="n">md</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">노이즈</span><span class="w"> </span><span class="n">스케줄</span><span class="w"> </span><span class="n">시각화</span>
<span class="w">    </span><span class="err">└──</span><span class="w"> </span><span class="mf">02</span><span class="n">_sampling_steps</span><span class="mf">.</span><span class="n">md</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">DDPM</span><span class="w"> </span><span class="n">vs</span><span class="w"> </span><span class="n">DDIM</span><span class="w"> </span><span class="n">비교</span>
</code></pre></div>

<hr />
<h2 id="_4">핵심 개념<a class="header-link" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="1-ddpm-vs-ddim">1. DDPM vs DDIM 샘플링<a class="header-link" href="#1-ddpm-vs-ddim" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>DDPM (Ho et al., 2020):
- 확률적 샘플링(각 단계에서 노이즈 z 추가)
- T 단계 필요 (예: 1000 단계)
- 고품질이지만 느림

DDIM (Song et al., 2020):
- 결정적 샘플링 (z = 0)
- 타임스텝 건너뛰기: 부분집합 사용 [τ₁, τ₂, ..., τₛ]
- 10-50배 빠름 (예: 50 단계)
- 품질 약간 저하

DDIM 업데이트:
xₜ₋₁ = √ᾱₜ₋₁ x̂₀ + √(1-ᾱₜ₋₁) εθ(xₜ, t)

여기서 x̂₀ = (xₜ - √(1-ᾱₜ)εθ(xₜ, t))/√ᾱₜ
</code></pre></div>

<h3 id="2-classifier-guidance">2. 분류기 가이던스(Classifier Guidance)<a class="header-link" href="#2-classifier-guidance" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">목표</span><span class="o">:</span><span class="w"> </span><span class="err">클래스</span><span class="w"> </span><span class="n">y에</span><span class="w"> </span><span class="err">조건화된</span><span class="w"> </span><span class="err">샘플</span><span class="w"> </span><span class="err">생성</span>

<span class="err">조건부</span><span class="w"> </span><span class="err">스코어</span><span class="o">:</span>
<span class="err">∇ₓ</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="n">p</span><span class="o">(</span><span class="n">xₜ</span><span class="o">|</span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="err">≈</span><span class="w"> </span><span class="err">∇ₓ</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="n">p</span><span class="o">(</span><span class="n">xₜ</span><span class="o">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="err">·∇ₓ</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="n">p</span><span class="o">(</span><span class="n">y</span><span class="o">|</span><span class="n">xₜ</span><span class="o">)</span>
<span class="w">                  </span><span class="err">─────────────</span><span class="w">   </span><span class="err">─────────────────</span>
<span class="w">                  </span><span class="err">무조건부</span><span class="w">         </span><span class="err">분류기</span><span class="w"> </span><span class="err">그래디언트</span>

<span class="err">가이드된</span><span class="w"> </span><span class="err">노이즈</span><span class="w"> </span><span class="err">예측</span><span class="o">:</span>
<span class="err">ε̂</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">εθ</span><span class="o">(</span><span class="n">xₜ</span><span class="o">,</span><span class="w"> </span><span class="n">t</span><span class="o">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">s</span><span class="err">·√</span><span class="o">(</span><span class="mi">1</span><span class="o">-</span><span class="err">ᾱₜ</span><span class="o">)</span><span class="err">·∇ₓ</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="n">pφ</span><span class="o">(</span><span class="n">y</span><span class="o">|</span><span class="n">xₜ</span><span class="o">)</span>

<span class="n">s</span><span class="o">:</span><span class="w"> </span><span class="err">가이던스</span><span class="w"> </span><span class="err">스케일</span><span class="w"> </span><span class="o">(</span><span class="n">s</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="err">더</span><span class="w"> </span><span class="err">강한</span><span class="w"> </span><span class="err">조건화</span><span class="o">)</span>
</code></pre></div>

<h3 id="3-classifier-free-guidance">3. 분류기 프리 가이던스(Classifier-Free Guidance)<a class="header-link" href="#3-classifier-free-guidance" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>별도의 분류기 불필요!

조건부와 무조건부 모두 처리하도록 모델 학습:
εθ(xₜ, t, c) (확률 p로)
εθ(xₜ, t, ∅) (확률 1-p로) (∅ = 널 클래스)

가이드된 예측:
ε̂ = εθ(xₜ, t, ∅) + w·(εθ(xₜ, t, c) - εθ(xₜ, t, ∅))

w: 가이던스 가중치 (w=0 → 무조건부, w&gt;1 → 더 강함)

사용처: Stable Diffusion, DALL-E 2, Imagen
</code></pre></div>

<h3 id="4">4. 학습 팁<a class="header-link" href="#4" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">EMA</span><span class="w"> </span><span class="p">(</span><span class="n">지수</span><span class="w"> </span><span class="n">이동</span><span class="w"> </span><span class="n">평균</span><span class="p">,</span><span class="w"> </span><span class="nb">Exp</span><span class="kr">on</span><span class="n">ential</span><span class="w"> </span><span class="n">Moving</span><span class="w"> </span><span class="n">Average</span><span class="p">):</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">θ_ema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.9999</span><span class="err">·</span><span class="n">θ_ema</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.0001</span><span class="err">·</span><span class="n">θ</span><span class="w"> </span><span class="n">유지</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">샘플링에</span><span class="w"> </span><span class="n">θ_ema</span><span class="w"> </span><span class="n">사용</span>

<span class="mf">2.</span><span class="w"> </span><span class="n">점진적</span><span class="w"> </span><span class="n">학습</span><span class="p">(</span><span class="n">Progressive</span><span class="w"> </span><span class="n">Training</span><span class="p">):</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">작은</span><span class="w"> </span><span class="n">해상도로</span><span class="w"> </span><span class="n">시작</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">점진적으로</span><span class="w"> </span><span class="n">증가</span><span class="w"> </span><span class="p">(</span><span class="mf">8</span><span class="err">×</span><span class="mf">8</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mf">16</span><span class="err">×</span><span class="mf">16</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mf">32</span><span class="err">×</span><span class="mf">32</span><span class="p">)</span>

<span class="mf">3.</span><span class="w"> </span><span class="n">데이터</span><span class="w"> </span><span class="n">증강</span><span class="p">:</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">무작위</span><span class="w"> </span><span class="n">수평</span><span class="w"> </span><span class="n">뒤집기</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="err">]</span><span class="n">로</span><span class="w"> </span><span class="n">정규화</span>

<span class="mf">4.</span><span class="w"> </span><span class="n">학습률</span><span class="p">:</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">MNIST</span><span class="o">/</span><span class="n">CIFAR</span><span class="p">:</span><span class="w"> </span><span class="mf">2</span><span class="n">e</span><span class="o">-</span><span class="mf">4</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">고해상도</span><span class="p">:</span><span class="w"> </span><span class="mf">1</span><span class="n">e</span><span class="o">-</span><span class="mf">4</span>

<span class="mf">5.</span><span class="w"> </span><span class="n">배치</span><span class="w"> </span><span class="n">크기</span><span class="p">:</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">작은</span><span class="w"> </span><span class="n">이미지</span><span class="p">:</span><span class="w"> </span><span class="mf">128</span><span class="o">-</span><span class="mf">256</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">큰</span><span class="w"> </span><span class="n">이미지</span><span class="p">:</span><span class="w"> </span><span class="mf">32</span><span class="o">-</span><span class="mf">64</span>
</code></pre></div>

<hr />
<h2 id="_5">구현 레벨<a class="header-link" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="2-pytorch-pytorch_lowlevel">레벨 2: PyTorch 로우레벨 (pytorch_lowlevel/)<a class="header-link" href="#2-pytorch-pytorch_lowlevel" title="Permanent link">&para;</a></h3>
<ul>
<li>순방향/역방향 확산 구현</li>
<li>노이즈 스케줄(선형) 구현</li>
<li>시간 임베딩이 있는 UNet 구축</li>
<li>MNIST (28×28) 및 CIFAR-10 (32×32)에서 학습</li>
</ul>
<h3 id="3-paper">레벨 3: 논문 구현 (paper/)<a class="header-link" href="#3-paper" title="Permanent link">&para;</a></h3>
<ul>
<li>코사인 스케줄을 갖는 전체 DDPM</li>
<li>DDIM 샘플링 (빠른 추론)</li>
<li>분류기 프리 가이던스</li>
<li>FID/IS 평가 메트릭</li>
</ul>
<hr />
<h2 id="_6">학습 루프<a class="header-link" href="#_6" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="c1"># 의사코드</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">x0</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
        <span class="c1"># 무작위 타임스텝 샘플링</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,))</span>

        <span class="c1"># 노이즈 샘플링</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

        <span class="c1"># 순방향 확산: 노이즈가 있는 이미지 생성</span>
        <span class="n">xt</span> <span class="o">=</span> <span class="n">sqrt_alpha_bar</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">sqrt_one_minus_alpha_bar</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">noise</span>

        <span class="c1"># 노이즈 예측</span>
        <span class="n">noise_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

        <span class="c1"># MSE 손실</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">noise_pred</span><span class="p">,</span> <span class="n">noise</span><span class="p">)</span>

        <span class="c1"># 역전파</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="_7">샘플링 루프<a class="header-link" href="#_7" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="c1"># DDPM 샘플링</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>  <span class="c1"># 노이즈에서 시작</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
    <span class="c1"># 노이즈 예측</span>
    <span class="n">t_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,),</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">noise_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">)</span>

    <span class="c1"># 평균 계산</span>
    <span class="n">alpha_t</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
    <span class="n">alpha_bar_t</span> <span class="o">=</span> <span class="n">alpha_bar</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha_t</span><span class="p">)</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha_bar_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">alpha_t</span><span class="p">)</span>

    <span class="c1"># 노이즈 추가 (마지막 단계 제외)</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">sigma_t</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">sigma_t</span> <span class="o">*</span> <span class="n">noise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mean</span>

<span class="c1"># x는 생성된 이미지</span>
</code></pre></div>

<hr />
<h2 id="_8">학습 체크리스트<a class="header-link" href="#_8" title="Permanent link">&para;</a></h2>
<ul>
<li>[ ] 순방향 확산 닫힌 형식 이해</li>
<li>[ ] ELBO에서 역방향 확산 유도</li>
<li>[ ] 노이즈 스케줄 구현 (선형, 코사인)</li>
<li>[ ] 시간 임베딩이 있는 UNet 구축</li>
<li>[ ] DDPM vs DDIM 샘플링 이해</li>
<li>[ ] 분류기 프리 가이던스 구현</li>
<li>[ ] 평가를 위한 FID 스코어 계산</li>
</ul>
<hr />
<h2 id="_9">참고 문헌<a class="header-link" href="#_9" title="Permanent link">&para;</a></h2>
<ul>
<li>Ho et al. (2020). "Denoising Diffusion Probabilistic Models"</li>
<li>Song et al. (2020). "Denoising Diffusion Implicit Models"</li>
<li>Nichol &amp; Dhariwal (2021). "Improved Denoising Diffusion Probabilistic Models"</li>
<li>Ho &amp; Salimans (2022). "Classifier-Free Diffusion Guidance"</li>
<li><a href="./32_Diffusion_Models.md">32_Diffusion_Models.md</a></li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Deep_Learning/32_Diffusion_Models.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">32. Diffusion Models</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">🔗</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Deep_Learning/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">📋</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Deep_Learning/34_CLIP_Multimodal.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">34. CLIP과 멀티모달 학습</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">↑</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'ko';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}