{% raw %}
<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>38. ê°ì²´ íƒì§€ (Object Detection) - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/ko/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/ko/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/ko/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" >
                        English
                    </option>
                    
                    <option value="ko" selected>
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/ko/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/ko/Deep_Learning/">Deep Learning</a>
    <span class="separator">/</span>
    <span class="current">38. ê°ì²´ íƒì§€ (Object Detection)</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>38. ê°ì²´ íƒì§€ (Object Detection)</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Deep_Learning/37_Modern_Architectures.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">37. í˜„ëŒ€ ë”¥ëŸ¬ë‹ ì•„í‚¤í…ì²˜</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Deep_Learning/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Deep_Learning/39_Practical_Image_Classification.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">39. ì‹¤ì „ ì´ë¯¸ì§€ ë¶„ë¥˜ í”„ë¡œì íŠ¸</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#_1">í•™ìŠµ ëª©í‘œ</a></li>
<li><a href="#1">1. ê°ì²´ íƒì§€ ê°œìš”</a><ul>
<li><a href="#11">1.1 ë¬¸ì œ ì •ì˜</a></li>
<li><a href="#12">1.2 íƒì§€ê¸° ë¶„ë¥˜</a></li>
<li><a href="#13">1.3 í‰ê°€ ì§€í‘œ</a></li>
</ul>
</li>
<li><a href="#2-r-cnn">2. R-CNN ê³„ì—´</a><ul>
<li><a href="#21-r-cnn">2.1 R-CNNì˜ ë°œì „</a></li>
<li><a href="#22-faster-r-cnn">2.2 Faster R-CNN êµ¬ì¡°</a></li>
<li><a href="#23-rpn-region-proposal-network">2.3 RPN (Region Proposal Network)</a></li>
</ul>
</li>
<li><a href="#3-yolo-you-only-look-once">3. YOLO (You Only Look Once)</a><ul>
<li><a href="#31-yolo">3.1 YOLO ë°œì „ì‚¬</a></li>
<li><a href="#32-ultralytics-yolov8">3.2 Ultralytics YOLOv8 ì‹¤ìŠµ</a></li>
<li><a href="#33-yolov8">3.3 YOLOv8 ì†ì‹¤ í•¨ìˆ˜</a></li>
</ul>
</li>
<li><a href="#4-detr-detection-transformer">4. DETR (Detection Transformer)</a><ul>
<li><a href="#41-detr">4.1 DETR ê°œë…</a></li>
<li><a href="#42-detr">4.2 DETR êµ¬í˜„</a></li>
<li><a href="#43-rt-detr-real-time-detr">4.3 RT-DETR (Real-Time DETR)</a></li>
</ul>
</li>
<li><a href="#5-instance-segmentation">5. ì¸ìŠ¤í„´ìŠ¤ ë¶„í•  (Instance Segmentation)</a><ul>
<li><a href="#51-mask-r-cnn">5.1 Mask R-CNN</a></li>
<li><a href="#52-sam-segment-anything-model">5.2 SAM (Segment Anything Model)</a></li>
</ul>
</li>
<li><a href="#6">6. ì‹¤ì „ íŒ</a><ul>
<li><a href="#61">6.1 ë°ì´í„°ì…‹ í˜•ì‹</a></li>
<li><a href="#62">6.2 í•™ìŠµ íŒ</a></li>
</ul>
</li>
<li><a href="#_2">ì •ë¦¬</a><ul>
<li><a href="#_3">íƒì§€ê¸° ì„ íƒ ê°€ì´ë“œ</a></li>
<li><a href="#_4">í•µì‹¬ ê°œë… ìš”ì•½</a></li>
<li><a href="#_5">ë‹¤ìŒ ë‹¨ê³„</a></li>
</ul>
</li>
<li><a href="#_6">ì°¸ê³  ìë£Œ</a><ul>
<li><a href="#_7">ë…¼ë¬¸</a></li>
<li><a href="#_8">ì½”ë“œ &amp; ìë£Œ</a></li>
</ul>
</li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <p><a href="./37_Modern_Architectures.md">ì´ì „: í˜„ëŒ€ ë”¥ëŸ¬ë‹ ì•„í‚¤í…ì²˜</a> | <a href="./39_Practical_Image_Classification.md">ë‹¤ìŒ: ì‹¤ì „ ì´ë¯¸ì§€ ë¶„ë¥˜ í”„ë¡œì íŠ¸</a></p>
<hr />
<h1 id="38-object-detection">38. ê°ì²´ íƒì§€ (Object Detection)<a class="header-link" href="#38-object-detection" title="Permanent link">&para;</a></h1>
<h2 id="_1">í•™ìŠµ ëª©í‘œ<a class="header-link" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li>Two-stage vs One-stage íƒì§€ê¸° ì°¨ì´ ì´í•´</li>
<li>YOLO ì•„í‚¤í…ì²˜ì™€ ë°œì „ ê³¼ì • í•™ìŠµ</li>
<li>Faster R-CNNì˜ êµ¬ì¡°ì™€ RPN ì´í•´</li>
<li>DETR (Detection Transformer) ê°œë… íŒŒì•…</li>
<li>PyTorch/Ultralyticsë¡œ ì‹¤ìŠµ</li>
</ul>
<hr />
<h2 id="1">1. ê°ì²´ íƒì§€ ê°œìš”<a class="header-link" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 ë¬¸ì œ ì •ì˜<a class="header-link" href="#11" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Computer Vision íƒœìŠ¤í¬ ë¹„êµ                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. ì´ë¯¸ì§€ ë¶„ë¥˜ (Image Classification)                           â”‚
â”‚     â””â”€ ì´ë¯¸ì§€ ì „ì²´ â†’ í•˜ë‚˜ì˜ í´ë˜ìŠ¤                                â”‚
â”‚     â””â”€ ì¶œë ¥: &quot;ê°•ì•„ì§€&quot;                                            â”‚
â”‚                                                                 â”‚
â”‚  2. ê°ì²´ íƒì§€ (Object Detection)                                 â”‚
â”‚     â””â”€ ì´ë¯¸ì§€ â†’ ì—¬ëŸ¬ ê°ì²´ì˜ ìœ„ì¹˜ + í´ë˜ìŠ¤                         â”‚
â”‚     â””â”€ ì¶œë ¥: [(x1,y1,x2,y2, &quot;ê°•ì•„ì§€&quot;, 0.95), ...]              â”‚
â”‚                                                                 â”‚
â”‚  3. ì‹œë§¨í‹± ë¶„í•  (Semantic Segmentation)                          â”‚
â”‚     â””â”€ í”½ì…€ë§ˆë‹¤ í´ë˜ìŠ¤ í• ë‹¹                                       â”‚
â”‚     â””â”€ ê°™ì€ í´ë˜ìŠ¤ì˜ ê°ì²´ë“¤ì€ êµ¬ë¶„ ì•ˆ ë¨                           â”‚
â”‚                                                                 â”‚
â”‚  4. ì¸ìŠ¤í„´ìŠ¤ ë¶„í•  (Instance Segmentation)                        â”‚
â”‚     â””â”€ ê°ì²´ íƒì§€ + ê° ê°ì²´ì˜ í”½ì…€ ë§ˆìŠ¤í¬                          â”‚
â”‚     â””â”€ ê°™ì€ í´ë˜ìŠ¤ë¼ë„ ê°œë³„ ê°ì²´ êµ¬ë¶„                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="12">1.2 íƒì§€ê¸° ë¶„ë¥˜<a class="header-link" href="#12" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">                    </span>íƒì§€ê¸°<span class="w"> </span>ë¶„ë¥˜<span class="w"> </span>ì²´ê³„<span class="w">                               </span>â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚<span class="w">                                                                 </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">           </span><span class="nv">Two</span><span class="o">-</span><span class="nv">Stage</span><span class="w"> </span><span class="nv">Detectors</span><span class="w">                            </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="mi">1</span>ë‹¨ê³„:<span class="w"> </span><span class="nv">Region</span><span class="w"> </span><span class="nv">Proposal</span><span class="w"> </span><span class="ss">(</span>í›„ë³´<span class="w"> </span>ì˜ì—­<span class="w"> </span>ìƒì„±<span class="ss">)</span><span class="w">                   </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="mi">2</span>ë‹¨ê³„:<span class="w"> </span><span class="nv">Classification</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">Regression</span><span class="w">                       </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">                                                           </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>ì˜ˆ:<span class="w"> </span><span class="nv">R</span><span class="o">-</span><span class="nv">CNN</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">Fast</span><span class="w"> </span><span class="nv">R</span><span class="o">-</span><span class="nv">CNN</span><span class="w"> </span>â†’<span class="w"> </span><span class="nv">Faster</span><span class="w"> </span><span class="nv">R</span><span class="o">-</span><span class="nv">CNN</span><span class="w">                   </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">      </span>ì¥ì :<span class="w"> </span>ë†’ì€<span class="w"> </span>ì •í™•ë„<span class="w">                                     </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">      </span>ë‹¨ì :<span class="w"> </span>ëŠë¦°<span class="w"> </span>ì†ë„<span class="w">                                       </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">   </span>â”‚
â”‚<span class="w">                                                                 </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">           </span><span class="nv">One</span><span class="o">-</span><span class="nv">Stage</span><span class="w"> </span><span class="nv">Detectors</span><span class="w">                            </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>ë‹¨ì¼<span class="w"> </span>ë„¤íŠ¸ì›Œí¬ë¡œ<span class="w"> </span>ìœ„ì¹˜<span class="w"> </span><span class="o">+</span><span class="w"> </span>í´ë˜ìŠ¤<span class="w"> </span>ë™ì‹œ<span class="w"> </span>ì˜ˆì¸¡<span class="w">                    </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">                                                           </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span>ì˜ˆ:<span class="w"> </span><span class="nv">YOLO</span>,<span class="w"> </span><span class="nv">SSD</span>,<span class="w"> </span><span class="nv">RetinaNet</span>,<span class="w"> </span><span class="nv">CenterNet</span><span class="w">                     </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">      </span>ì¥ì :<span class="w"> </span>ë¹ ë¥¸<span class="w"> </span>ì†ë„,<span class="w"> </span>ì‹¤ì‹œê°„<span class="w"> </span>ì²˜ë¦¬<span class="w"> </span>ê°€ëŠ¥<span class="w">                     </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">      </span>ë‹¨ì :<span class="w"> </span>ì‘ì€<span class="w"> </span>ê°ì²´<span class="w"> </span>íƒì§€<span class="w"> </span>ì–´ë ¤ì›€<span class="w"> </span><span class="ss">(</span>ê°œì„ ë¨<span class="ss">)</span><span class="w">                   </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">   </span>â”‚
â”‚<span class="w">                                                                 </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">           </span><span class="nv">Transformer</span><span class="o">-</span><span class="nv">based</span><span class="w"> </span><span class="nv">Detectors</span><span class="w">                    </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="nv">DETR</span>,<span class="w"> </span><span class="nv">Deformable</span><span class="w"> </span><span class="nv">DETR</span>,<span class="w"> </span><span class="nv">RT</span><span class="o">-</span><span class="nv">DETR</span><span class="w">                          </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="k">End</span><span class="o">-</span><span class="nv">to</span><span class="o">-</span><span class="k">end</span><span class="w"> </span>í•™ìŠµ,<span class="w"> </span><span class="nv">NMS</span><span class="w"> </span>ë¶ˆí•„ìš”<span class="w">                              </span>â”‚<span class="w">   </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">   </span>â”‚
â”‚<span class="w">                                                                 </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="13">1.3 í‰ê°€ ì§€í‘œ<a class="header-link" href="#13" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ê°ì²´ íƒì§€ í‰ê°€ ì§€í‘œ</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calculate_iou</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    IoU (Intersection over Union) ê³„ì‚°</span>

<span class="sd">    Args:</span>
<span class="sd">        box1, box2: [x1, y1, x2, y2] í˜•ì‹</span>

<span class="sd">    Returns:</span>
<span class="sd">        IoU ê°’ (0~1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># êµì§‘í•© ì¢Œí‘œ</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># êµì§‘í•© ë©´ì </span>
    <span class="n">inter_area</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span>

    <span class="c1"># í•©ì§‘í•© ë©´ì </span>
    <span class="n">box1_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">box2_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">union_area</span> <span class="o">=</span> <span class="n">box1_area</span> <span class="o">+</span> <span class="n">box2_area</span> <span class="o">-</span> <span class="n">inter_area</span>

    <span class="k">return</span> <span class="n">inter_area</span> <span class="o">/</span> <span class="n">union_area</span> <span class="k">if</span> <span class="n">union_area</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="c1"># ì˜ˆì‹œ</span>
<span class="n">pred_box</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
<span class="n">gt_box</span> <span class="o">=</span> <span class="p">[</span><span class="mi">120</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">210</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IoU: </span><span class="si">{</span><span class="n">calculate_iou</span><span class="p">(</span><span class="n">pred_box</span><span class="p">,</span><span class="w"> </span><span class="n">gt_box</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># ì•½ 0.68</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">mAP (mean Average Precision) ê³„ì‚° ê³¼ì •:</span>

<span class="sd">1. ê° í´ë˜ìŠ¤ë³„ë¡œ:</span>
<span class="sd">   - ì˜ˆì¸¡ì„ confidence ìˆœìœ¼ë¡œ ì •ë ¬</span>
<span class="sd">   - IoU &gt; thresholdì¸ ê²½ìš° TP, ì•„ë‹ˆë©´ FP</span>
<span class="sd">   - Precision-Recall ê³¡ì„  ê³„ì‚°</span>
<span class="sd">   - AP = ê³¡ì„  ì•„ë˜ ë©´ì </span>

<span class="sd">2. mAP = ëª¨ë“  í´ë˜ìŠ¤ APì˜ í‰ê· </span>

<span class="sd">COCO ë°ì´í„°ì…‹ ê¸°ì¤€:</span>
<span class="sd">- mAP@0.5: IoU=0.5 ê¸°ì¤€</span>
<span class="sd">- mAP@0.75: IoU=0.75 ê¸°ì¤€ (ì—„ê²©)</span>
<span class="sd">- mAP@[.5:.95]: 0.5~0.95 IoUì˜ í‰ê· </span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>

<hr />
<h2 id="2-r-cnn">2. R-CNN ê³„ì—´<a class="header-link" href="#2-r-cnn" title="Permanent link">&para;</a></h2>
<h3 id="21-r-cnn">2.1 R-CNNì˜ ë°œì „<a class="header-link" href="#21-r-cnn" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    R-CNN Family ë°œì „                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  R-CNN (2014):                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ì´ë¯¸ì§€    â”‚ â†’ â”‚ Selectiveâ”‚ â†’ â”‚ CNN      â”‚ â†’ â”‚ SVM     â”‚   â”‚
â”‚  â”‚          â”‚    â”‚ Search   â”‚    â”‚ (AlexNet)â”‚    â”‚ ë¶„ë¥˜ê¸°   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ (~2000ê°œ)â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚  ë¬¸ì œì : ~2000ë²ˆ CNN í†µê³¼ â†’ ë§¤ìš° ëŠë¦¼                            â”‚
â”‚                                                                 â”‚
â”‚  Fast R-CNN (2015):                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ì´ë¯¸ì§€    â”‚ â†’ â”‚ CNN      â”‚ â†’ â”‚ RoI      â”‚ â†’ â”‚ FC +    â”‚   â”‚
â”‚  â”‚          â”‚    â”‚ Feature  â”‚    â”‚ Pooling  â”‚    â”‚ Softmax â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ Map      â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  ê°œì„ : CNN 1ë²ˆë§Œ í†µê³¼, RoI Poolingìœ¼ë¡œ í›„ë³´ ì˜ì—­ ì¶”ì¶œ              â”‚
â”‚  ë¬¸ì œì : Selective Search ì—¬ì „íˆ ëŠë¦¼                            â”‚
â”‚                                                                 â”‚
â”‚  Faster R-CNN (2015):                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ì´ë¯¸ì§€    â”‚ â†’ â”‚ Backbone â”‚ â†’ â”‚ RPN      â”‚ â†’ â”‚ Head    â”‚   â”‚
â”‚  â”‚          â”‚    â”‚ (ResNet) â”‚    â”‚          â”‚    â”‚         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  í˜ì‹ : RPNìœ¼ë¡œ Region Proposalë„ í•™ìŠµ                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="22-faster-r-cnn">2.2 Faster R-CNN êµ¬ì¡°<a class="header-link" href="#22-faster-r-cnn" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torchvision</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models.detection</span><span class="w"> </span><span class="kn">import</span> <span class="n">fasterrcnn_resnet50_fpn_v2</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models.detection.faster_rcnn</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastRCNNPredictor</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CustomFasterRCNN</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Faster R-CNN ì»¤ìŠ¤í…€ ëª¨ë¸&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">pretrained</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            num_classes: ë°°ê²½ í¬í•¨ í´ë˜ìŠ¤ ìˆ˜ (ì˜ˆ: 10ê°œ ê°ì²´ â†’ 11)</span>
<span class="sd">            pretrained: COCO ì‚¬ì „í•™ìŠµ ê°€ì¤‘ì¹˜ ì‚¬ìš©</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ì‚¬ì „í•™ìŠµëœ ëª¨ë¸ ë¡œë“œ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">fasterrcnn_resnet50_fpn_v2</span><span class="p">(</span>
            <span class="n">weights</span><span class="o">=</span><span class="s2">&quot;DEFAULT&quot;</span> <span class="k">if</span> <span class="n">pretrained</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># Box predictor êµì²´ (í´ë˜ìŠ¤ ìˆ˜ ë§ì¶¤)</span>
        <span class="n">in_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_predictor</span><span class="o">.</span><span class="n">cls_score</span><span class="o">.</span><span class="n">in_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_predictor</span> <span class="o">=</span> <span class="n">FastRCNNPredictor</span><span class="p">(</span>
            <span class="n">in_features</span><span class="p">,</span> <span class="n">num_classes</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>


<span class="k">def</span><span class="w"> </span><span class="nf">train_faster_rcnn</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Faster R-CNN í•™ìŠµ ì˜ˆì œ&quot;&quot;&quot;</span>

    <span class="c1"># ëª¨ë¸ ìƒì„± (ë°°ê²½ + 10ê°œ í´ë˜ìŠ¤)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">CustomFasterRCNN</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">get_model</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="c1"># ê°€ìƒ ë°ì´í„°</span>
    <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>

    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;boxes&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span> <span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">]]),</span>
            <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>  <span class="c1"># í´ë˜ìŠ¤ ID</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;boxes&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">]]),</span>
            <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">3</span><span class="p">]),</span>
        <span class="p">}</span>
    <span class="p">]</span>

    <span class="c1"># ìˆœì „íŒŒ (í•™ìŠµ ëª¨ë“œì—ì„œëŠ” loss ë°˜í™˜)</span>
    <span class="n">loss_dict</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>

    <span class="c1"># ì†ì‹¤ ì¢…ë¥˜:</span>
    <span class="c1"># - loss_classifier: í´ë˜ìŠ¤ ë¶„ë¥˜ ì†ì‹¤</span>
    <span class="c1"># - loss_box_reg: ë°•ìŠ¤ íšŒê·€ ì†ì‹¤</span>
    <span class="c1"># - loss_objectness: RPNì˜ ê°ì²´/ë¹„ê°ì²´ ë¶„ë¥˜</span>
    <span class="c1"># - loss_rpn_box_reg: RPN ë°•ìŠ¤ íšŒê·€</span>

    <span class="n">total_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">loss</span> <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">loss_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total loss: </span><span class="si">{</span><span class="n">total_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">loss_dict</span>


<span class="k">def</span><span class="w"> </span><span class="nf">inference_faster_rcnn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Faster R-CNN ì¶”ë¡ &quot;&quot;&quot;</span>

    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">([</span><span class="n">image</span><span class="p">])</span>

    <span class="n">pred</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># threshold ì´ìƒì¸ ì˜ˆì¸¡ë§Œ í•„í„°ë§</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;boxes&quot;</span><span class="p">:</span> <span class="n">pred</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">][</span><span class="n">keep</span><span class="p">],</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">pred</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="n">keep</span><span class="p">],</span>
        <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">pred</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">][</span><span class="n">keep</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<h3 id="23-rpn-region-proposal-network">2.3 RPN (Region Proposal Network)<a class="header-link" href="#23-rpn-region-proposal-network" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">RPN í•µì‹¬ ê°œë…:</span>

<span class="sd">1. Anchor Boxes:</span>
<span class="sd">   - ê° ìœ„ì¹˜ì—ì„œ ì—¬ëŸ¬ í¬ê¸°/ë¹„ìœ¨ì˜ ë°•ìŠ¤ ë¯¸ë¦¬ ì •ì˜</span>
<span class="sd">   - ì˜ˆ: 3ê°œ í¬ê¸° Ã— 3ê°œ ë¹„ìœ¨ = 9ê°œ anchor</span>

<span class="sd">2. ì¶œë ¥:</span>
<span class="sd">   - objectness score: ê°ì²´ ì¡´ì¬ í™•ë¥  (2-class)</span>
<span class="sd">   - box regression: anchor â†’ ì‹¤ì œ ë°•ìŠ¤ ë³€í™˜</span>

<span class="sd">3. í•™ìŠµ:</span>
<span class="sd">   - Positive: IoU &gt; 0.7ì¸ anchor</span>
<span class="sd">   - Negative: IoU &lt; 0.3ì¸ anchor</span>
<span class="sd">   - ë¬´ì‹œ: 0.3~0.7 ì‚¬ì´</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SimpleRPN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ê°„ëµí™”ëœ RPN êµ¬í˜„&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">in_channels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
        <span class="n">num_anchors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>  <span class="c1"># 3 scales Ã— 3 ratios</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># 3Ã—3 convë¡œ feature ì²˜ë¦¬</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># objectness ì˜ˆì¸¡ (ê°ì²´/ë°°ê²½)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectness</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">num_anchors</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># bbox regression (dx, dy, dw, dh)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbox_reg</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">num_anchors</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_map</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            feature_map: (B, C, H, W)</span>

<span class="sd">        Returns:</span>
<span class="sd">            objectness: (B, num_anchors*2, H, W)</span>
<span class="sd">            bbox_deltas: (B, num_anchors*4, H, W)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">feature_map</span><span class="p">))</span>

        <span class="n">objectness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectness</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">bbox_deltas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_reg</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">objectness</span><span class="p">,</span> <span class="n">bbox_deltas</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_anchors</span><span class="p">(</span>
    <span class="n">feature_size</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
    <span class="n">anchor_scales</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">],</span>
    <span class="n">anchor_ratios</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>
    <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Anchor ë°•ìŠ¤ ìƒì„±</span>

<span class="sd">    Args:</span>
<span class="sd">        feature_size: (H, W) feature map í¬ê¸°</span>
<span class="sd">        anchor_scales: anchor ë©´ì ì˜ ì œê³±ê·¼</span>
<span class="sd">        anchor_ratios: ê°€ë¡œ/ì„¸ë¡œ ë¹„ìœ¨</span>
<span class="sd">        stride: ì›ë³¸ ì´ë¯¸ì§€ ëŒ€ë¹„ ì¶•ì†Œ ë¹„ìœ¨</span>

<span class="sd">    Returns:</span>
<span class="sd">        anchors: (H*W*num_anchors, 4) í˜•íƒœì˜ anchor ì¢Œí‘œ</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">feature_size</span>
    <span class="n">anchors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">H</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">W</span><span class="p">):</span>
            <span class="c1"># feature map ìœ„ì¹˜ â†’ ì›ë³¸ ì´ë¯¸ì§€ ì¢Œí‘œ</span>
            <span class="n">cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">stride</span>
            <span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">stride</span>

            <span class="k">for</span> <span class="n">scale</span> <span class="ow">in</span> <span class="n">anchor_scales</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">anchor_ratios</span><span class="p">:</span>
                    <span class="c1"># ë¹„ìœ¨ì— ë”°ë¥¸ ë„ˆë¹„/ë†’ì´</span>
                    <span class="n">anchor_w</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">anchor_h</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">/</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>

                    <span class="c1"># (x1, y1, x2, y2) í˜•ì‹</span>
                    <span class="n">anchors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                        <span class="n">cx</span> <span class="o">-</span> <span class="n">anchor_w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">cy</span> <span class="o">-</span> <span class="n">anchor_h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">cx</span> <span class="o">+</span> <span class="n">anchor_w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">cy</span> <span class="o">+</span> <span class="n">anchor_h</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="p">])</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>

<span class="c1"># ì˜ˆì‹œ</span>
<span class="n">anchors</span> <span class="o">=</span> <span class="n">generate_anchors</span><span class="p">((</span><span class="mi">38</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>  <span class="c1"># 600Ã—800 ì´ë¯¸ì§€, stride=16</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span><span class="si">}</span><span class="s2"> anchors&quot;</span><span class="p">)</span>  <span class="c1"># 38*50*9 = 17,100ê°œ</span>
</code></pre></div>

<hr />
<h2 id="3-yolo-you-only-look-once">3. YOLO (You Only Look Once)<a class="header-link" href="#3-yolo-you-only-look-once" title="Permanent link">&para;</a></h2>
<h3 id="31-yolo">3.1 YOLO ë°œì „ì‚¬<a class="header-link" href="#31-yolo" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    YOLO ë²„ì „ ë¹„êµ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  YOLOv1 (2016): ë‹¨ì¼ CNNìœ¼ë¡œ ê·¸ë¦¬ë“œ ê¸°ë°˜ íƒì§€                     â”‚
â”‚  YOLOv2 (2017): Batch Norm, Anchor Boxes ë„ì…                   â”‚
â”‚  YOLOv3 (2018): Darknet-53, FPN, 3ê°œ ìŠ¤ì¼€ì¼ ì˜ˆì¸¡                 â”‚
â”‚  YOLOv4 (2020): CSPDarknet, SPP, PANet                          â”‚
â”‚  YOLOv5 (2020): PyTorch êµ¬í˜„, Ultralytics                       â”‚
â”‚  YOLOv6 (2022): ì†ë„ ìµœì í™”, EfficientRep                       â”‚
â”‚  YOLOv7 (2022): E-ELAN, Auxiliary Head                          â”‚
â”‚  YOLOv8 (2023): Unified Framework, Anchor-free                  â”‚
â”‚  YOLOv9 (2024): GELAN, PGI                                      â”‚
â”‚  YOLOv10 (2024): NMS-free, Dual Assignments                     â”‚
â”‚  YOLO11 (2024): ë” ë¹ ë¥´ê³  ì •í™•í•œ ë²„ì „                             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ì„±ëŠ¥ (COCO val2017)           mAP50-95   Speed (ms)   â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  YOLOv8n                         37.3        1.2       â”‚   â”‚
â”‚  â”‚  YOLOv8s                         44.9        1.9       â”‚   â”‚
â”‚  â”‚  YOLOv8m                         50.2        4.3       â”‚   â”‚
â”‚  â”‚  YOLOv8l                         52.9        6.7       â”‚   â”‚
â”‚  â”‚  YOLOv8x                         53.9        9.8       â”‚   â”‚
â”‚  â”‚  YOLO11x                         54.7        11.3      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="32-ultralytics-yolov8">3.2 Ultralytics YOLOv8 ì‹¤ìŠµ<a class="header-link" href="#32-ultralytics-yolov8" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">ultralytics</span><span class="w"> </span><span class="kn">import</span> <span class="n">YOLO</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="c1"># ===============================</span>
<span class="c1"># 1. ëª¨ë¸ ë¡œë“œ</span>
<span class="c1"># ===============================</span>

<span class="c1"># ì‚¬ì „í•™ìŠµ ëª¨ë¸ ë¡œë“œ</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">YOLO</span><span class="p">(</span><span class="s2">&quot;yolov8n.pt&quot;</span><span class="p">)</span>  <span class="c1"># nano ë²„ì „ (ê°€ì¥ ë¹ ë¦„)</span>
<span class="c1"># model = YOLO(&quot;yolov8s.pt&quot;)  # small</span>
<span class="c1"># model = YOLO(&quot;yolov8m.pt&quot;)  # medium</span>
<span class="c1"># model = YOLO(&quot;yolov8l.pt&quot;)  # large</span>
<span class="c1"># model = YOLO(&quot;yolov8x.pt&quot;)  # extra-large</span>

<span class="c1"># ë¹ˆ ëª¨ë¸ ìƒì„± í›„ í•™ìŠµ</span>
<span class="c1"># model = YOLO(&quot;yolov8n.yaml&quot;)</span>


<span class="c1"># ===============================</span>
<span class="c1"># 2. ì¶”ë¡  (Inference)</span>
<span class="c1"># ===============================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">detect_objects</span><span class="p">(</span><span class="n">image_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">conf_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì´ë¯¸ì§€ì—ì„œ ê°ì²´ íƒì§€&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="n">conf_threshold</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">boxes</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;íƒì§€ëœ ê°ì²´ ìˆ˜: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
            <span class="c1"># ì¢Œí‘œ</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">xyxy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="c1"># í´ë˜ìŠ¤ì™€ confidence</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">cls</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">conf</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> at (</span><span class="si">{</span><span class="n">x1</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y1</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">x2</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y2</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># ì‚¬ìš© ì˜ˆì‹œ</span>
<span class="c1"># results = detect_objects(&quot;image.jpg&quot;)</span>

<span class="c1"># ê²°ê³¼ ì‹œê°í™”</span>
<span class="c1"># results[0].show()  # ì´ë¯¸ì§€ í‘œì‹œ</span>
<span class="c1"># results[0].save(&quot;result.jpg&quot;)  # ì €ì¥</span>


<span class="c1"># ===============================</span>
<span class="c1"># 3. ë¹„ë””ì˜¤/ì›¹ìº  íƒì§€</span>
<span class="c1"># ===============================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">detect_video</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ë¹„ë””ì˜¤ ë˜ëŠ” ì›¹ìº ì—ì„œ ì‹¤ì‹œê°„ íƒì§€</span>

<span class="sd">    Args:</span>
<span class="sd">        source: 0=ì›¹ìº , ë˜ëŠ” ë¹„ë””ì˜¤ íŒŒì¼ ê²½ë¡œ</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># generatorë¡œ ë°˜í™˜</span>

    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="c1"># í”„ë ˆì„ë³„ ì²˜ë¦¬</span>
        <span class="n">annotated_frame</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>  <span class="c1"># ë°•ìŠ¤ ê·¸ë ¤ì§„ í”„ë ˆì„</span>

        <span class="c1"># ì—¬ê¸°ì„œ cv2.imshow() ë“±ìœ¼ë¡œ í‘œì‹œ ê°€ëŠ¥</span>
        <span class="k">yield</span> <span class="n">annotated_frame</span>


<span class="c1"># ===============================</span>
<span class="c1"># 4. ì»¤ìŠ¤í…€ ë°ì´í„°ì…‹ í•™ìŠµ</span>
<span class="c1"># ===============================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">train_custom_model</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì»¤ìŠ¤í…€ ë°ì´í„°ì…‹ìœ¼ë¡œ YOLO í•™ìŠµ&quot;&quot;&quot;</span>

    <span class="c1"># ë°ì´í„°ì…‹ yaml íŒŒì¼ ì˜ˆì‹œ (data.yaml):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    path: /path/to/dataset</span>
<span class="sd">    train: images/train</span>
<span class="sd">    val: images/val</span>

<span class="sd">    names:</span>
<span class="sd">      0: cat</span>
<span class="sd">      1: dog</span>
<span class="sd">      2: bird</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ëª¨ë¸ í•™ìŠµ</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">YOLO</span><span class="p">(</span><span class="s2">&quot;yolov8n.pt&quot;</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="s2">&quot;data.yaml&quot;</span><span class="p">,</span>
        <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">imgsz</span><span class="o">=</span><span class="mi">640</span><span class="p">,</span>
        <span class="n">batch</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># GPU 0, ë˜ëŠ” &quot;cpu&quot;</span>
        <span class="n">patience</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>  <span class="c1"># Early stopping</span>
        <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">project</span><span class="o">=</span><span class="s2">&quot;runs/detect&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;custom_model&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>


<span class="c1"># ===============================</span>
<span class="c1"># 5. ëª¨ë¸ ë‚´ë³´ë‚´ê¸°</span>
<span class="c1"># ===============================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">export_model</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ë‹¤ì–‘í•œ í˜•ì‹ìœ¼ë¡œ ëª¨ë¸ ë‚´ë³´ë‚´ê¸°&quot;&quot;&quot;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">YOLO</span><span class="p">(</span><span class="s2">&quot;yolov8n.pt&quot;</span><span class="p">)</span>

    <span class="c1"># ONNXë¡œ ë‚´ë³´ë‚´ê¸°</span>
    <span class="n">model</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;onnx&quot;</span><span class="p">)</span>

    <span class="c1"># TensorRTë¡œ ë‚´ë³´ë‚´ê¸° (GPU ì¶”ë¡  ìµœì í™”)</span>
    <span class="c1"># model.export(format=&quot;engine&quot;)</span>

    <span class="c1"># CoreMLë¡œ ë‚´ë³´ë‚´ê¸° (Apple)</span>
    <span class="c1"># model.export(format=&quot;coreml&quot;)</span>

    <span class="c1"># TFLiteë¡œ ë‚´ë³´ë‚´ê¸° (ëª¨ë°”ì¼)</span>
    <span class="c1"># model.export(format=&quot;tflite&quot;)</span>
</code></pre></div>

<h3 id="33-yolov8">3.3 YOLOv8 ì†ì‹¤ í•¨ìˆ˜<a class="header-link" href="#33-yolov8" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">YOLOv8 ì†ì‹¤ í•¨ìˆ˜ êµ¬ì„±:</span>

<span class="sd">1. Box Loss (CIoU Loss):</span>
<span class="sd">   - ë°•ìŠ¤ ìœ„ì¹˜ì™€ í¬ê¸°ì˜ ì •í™•ë„</span>
<span class="sd">   - CIoU = IoU - (ê±°ë¦¬ í˜ë„í‹° + ì¢…íš¡ë¹„ í˜ë„í‹°)</span>

<span class="sd">2. Classification Loss (BCE):</span>
<span class="sd">   - ê° í´ë˜ìŠ¤ì— ëŒ€í•œ ì´ì§„ êµì°¨ ì—”íŠ¸ë¡œí”¼</span>
<span class="sd">   - Focal Loss ë³€í˜• ì‚¬ìš© ê°€ëŠ¥</span>

<span class="sd">3. DFL Loss (Distribution Focal Loss):</span>
<span class="sd">   - ë°•ìŠ¤ ê²½ê³„ì˜ ë¶„í¬ ì˜ˆì¸¡</span>
<span class="sd">   - YOLOv8ì˜ ìƒˆë¡œìš´ íšŒê·€ ë°©ì‹</span>

<span class="sd">Total Loss = Î»_box * L_box + Î»_cls * L_cls + Î»_dfl * L_dfl</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ciou_loss</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">,</span> <span class="n">target_boxes</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete IoU Loss</span>

<span class="sd">    Args:</span>
<span class="sd">        pred_boxes: (N, 4) ì˜ˆì¸¡ ë°•ìŠ¤ [x1, y1, x2, y2]</span>
<span class="sd">        target_boxes: (N, 4) ì •ë‹µ ë°•ìŠ¤</span>

<span class="sd">    Returns:</span>
<span class="sd">        CIoU loss</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># IoU ê³„ì‚°</span>
    <span class="n">inter_x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">inter_y1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">inter_x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">inter_y2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">])</span>

    <span class="n">inter_area</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">inter_x2</span> <span class="o">-</span> <span class="n">inter_x1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> \
                 <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">inter_y2</span> <span class="o">-</span> <span class="n">inter_y1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">pred_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> \
                <span class="p">(</span><span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">target_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> \
                  <span class="p">(</span><span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">union_area</span> <span class="o">=</span> <span class="n">pred_area</span> <span class="o">+</span> <span class="n">target_area</span> <span class="o">-</span> <span class="n">inter_area</span>
    <span class="n">iou</span> <span class="o">=</span> <span class="n">inter_area</span> <span class="o">/</span> <span class="p">(</span><span class="n">union_area</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>

    <span class="c1"># ì¤‘ì‹¬ì  ê±°ë¦¬</span>
    <span class="n">pred_cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">pred_cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">target_cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">target_cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">center_dist_sq</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred_cx</span> <span class="o">-</span> <span class="n">target_cx</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">pred_cy</span> <span class="o">-</span> <span class="n">target_cy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># ëŒ€ê°ì„  ê±°ë¦¬ (enclosing box)</span>
    <span class="n">enclose_x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">enclose_y1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">enclose_x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">enclose_y2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">])</span>

    <span class="n">enclose_diag_sq</span> <span class="o">=</span> <span class="p">(</span><span class="n">enclose_x2</span> <span class="o">-</span> <span class="n">enclose_x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> \
                      <span class="p">(</span><span class="n">enclose_y2</span> <span class="o">-</span> <span class="n">enclose_y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># ì¢…íš¡ë¹„ ì¼ê´€ì„±</span>
    <span class="n">pred_w</span> <span class="o">=</span> <span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">pred_h</span> <span class="o">=</span> <span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">pred_boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">target_w</span> <span class="o">=</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">target_h</span> <span class="o">=</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> \
        <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">target_w</span> <span class="o">/</span> <span class="p">(</span><span class="n">target_h</span> <span class="o">+</span> <span class="n">eps</span><span class="p">))</span> <span class="o">-</span>
         <span class="n">torch</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">pred_w</span> <span class="o">/</span> <span class="p">(</span><span class="n">pred_h</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)))</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">iou</span> <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>

    <span class="c1"># CIoU</span>
    <span class="n">ciou</span> <span class="o">=</span> <span class="n">iou</span> <span class="o">-</span> <span class="p">(</span><span class="n">center_dist_sq</span> <span class="o">/</span> <span class="p">(</span><span class="n">enclose_diag_sq</span> <span class="o">+</span> <span class="n">eps</span><span class="p">))</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">v</span>

    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ciou</span>
</code></pre></div>

<hr />
<h2 id="4-detr-detection-transformer">4. DETR (Detection Transformer)<a class="header-link" href="#4-detr-detection-transformer" title="Permanent link">&para;</a></h2>
<h3 id="41-detr">4.1 DETR ê°œë…<a class="header-link" href="#41-detr" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="nx">DETR</span><span class="w"> </span><span class="nx">ì•„í‚¤í…ì²˜</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">ê¸°ì¡´</span><span class="w"> </span><span class="nx">íƒì§€ê¸°</span><span class="w"> </span><span class="nx">ë¬¸ì œì </span><span class="p">:</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Anchor</span><span class="w"> </span><span class="nx">ì„¤ê³„</span><span class="w"> </span><span class="nx">í•„ìš”</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">NMS</span><span class="w"> </span><span class="p">(</span><span class="nx">Non</span><span class="o">-</span><span class="nx">Maximum</span><span class="w"> </span><span class="nx">Suppression</span><span class="p">)</span><span class="w"> </span><span class="nx">í›„ì²˜ë¦¬</span><span class="w"> </span><span class="nx">í•„ìš”</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">ë³µì¡í•œ</span><span class="w"> </span><span class="nx">íŒŒì´í”„ë¼ì¸</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">DETR</span><span class="w"> </span><span class="nx">í˜ì‹ </span><span class="p">:</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">End</span><span class="o">-</span><span class="nx">to</span><span class="o">-</span><span class="nx">end</span><span class="w"> </span><span class="nx">í•™ìŠµ</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Object</span><span class="w"> </span><span class="nx">Queryë¡œ</span><span class="w"> </span><span class="nx">ì§ì ‘</span><span class="w"> </span><span class="nx">ê°ì²´</span><span class="w"> </span><span class="nx">ì˜ˆì¸¡</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">Hungarian</span><span class="w"> </span><span class="nx">Matchingìœ¼ë¡œ</span><span class="w"> </span><span class="nx">í•™ìŠµ</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">NMS</span><span class="w"> </span><span class="nx">ë¶ˆí•„ìš”</span><span class="w">                                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Backbone</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Transformer</span><span class="err">â”‚</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">FFN</span><span class="w"> </span><span class="nx">Heads</span><span class="w">             </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="nx">ResNet</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Encoder</span><span class="o">/</span><span class="w">   </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="p">(</span><span class="kd">class</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">box</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">Decoder</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">                        </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">    </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â†“</span><span class="w">                 </span><span class="err">â†“</span><span class="w">                      </span><span class="err">â†“</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Feature</span><span class="w"> </span><span class="nx">Map</span><span class="w">    </span><span class="nx">Object</span><span class="w"> </span><span class="nx">Queries</span><span class="w"> </span><span class="p">(</span><span class="mi">100</span><span class="nx">ê°œ</span><span class="p">)</span><span class="w">    </span><span class="mi">100</span><span class="nx">ê°œ</span><span class="w"> </span><span class="nx">ì˜ˆì¸¡</span><span class="w"> </span><span class="nx">ì¶œë ¥</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="nx">Positional</span><span class="w">   </span><span class="err">â†“</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="nx">Encoding</span><span class="w">     </span><span class="k">Self</span><span class="o">-</span><span class="nx">attention</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">Cross</span><span class="o">-</span><span class="nx">attention</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                 </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="42-detr">4.2 DETR êµ¬í˜„<a class="header-link" href="#42-detr" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">resnet50</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DETR</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ê°„ëµí™”ëœ DETR êµ¬í˜„</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">num_queries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">hidden_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
        <span class="n">nheads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">num_encoder_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
        <span class="n">num_decoder_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Backbone</span>
        <span class="n">backbone</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="s2">&quot;DEFAULT&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">backbone</span><span class="o">.</span><span class="n">children</span><span class="p">())[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Feature map â†’ hidden_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Transformer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Transformer</span><span class="p">(</span>
            <span class="n">d_model</span><span class="o">=</span><span class="n">hidden_dim</span><span class="p">,</span>
            <span class="n">nhead</span><span class="o">=</span><span class="n">nheads</span><span class="p">,</span>
            <span class="n">num_encoder_layers</span><span class="o">=</span><span class="n">num_encoder_layers</span><span class="p">,</span>
            <span class="n">num_decoder_layers</span><span class="o">=</span><span class="n">num_decoder_layers</span><span class="p">,</span>
            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Object Queries (í•™ìŠµë˜ëŠ” ì„ë² ë”©)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_queries</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>

        <span class="c1"># ì¶œë ¥ í—¤ë“œ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">num_classes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># +1 for no-object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbox_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>  <span class="c1"># cx, cy, w, h</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="c1"># Positional Encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">hidden_dim</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">hidden_dim</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            x: (B, 3, H, W) ì…ë ¥ ì´ë¯¸ì§€</span>

<span class="sd">        Returns:</span>
<span class="sd">            class_logits: (B, num_queries, num_classes+1)</span>
<span class="sd">            bbox_pred: (B, num_queries, 4)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Backbone feature ì¶”ì¶œ</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># (B, 2048, H/32, W/32)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>  <span class="c1"># (B, 256, H/32, W/32)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Positional Encoding ìƒì„±</span>
        <span class="n">pos_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_positional_encoding</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">features</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Flatten for Transformer</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (B, H*W, 256)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">src</span> <span class="o">+</span> <span class="n">pos_embed</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Object Queries</span>
        <span class="n">query_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_embed</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Transformer</span>
        <span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">query_embed</span><span class="p">)</span>
        <span class="n">hs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span> <span class="o">+</span> <span class="n">query_embed</span><span class="p">)</span>  <span class="c1"># (B, num_queries, 256)</span>

        <span class="c1"># ì˜ˆì¸¡</span>
        <span class="n">class_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_head</span><span class="p">(</span><span class="n">hs</span><span class="p">)</span>
        <span class="n">bbox_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_head</span><span class="p">(</span><span class="n">hs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">class_logits</span><span class="p">,</span> <span class="n">bbox_pred</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_positional_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;2D Positional Encoding ìƒì„±&quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="n">x_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_embed</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c1"># (W, 128)</span>
        <span class="n">y_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_embed</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>  <span class="c1"># (H, 128)</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span>
            <span class="n">x_embed</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">y_embed</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (H, W, 256)</span>

        <span class="k">return</span> <span class="n">pos</span>


<span class="c1"># Hungarian Matching Loss (ê°„ëµí™”)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">HungarianMatcher</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ì˜ˆì¸¡ê³¼ GTë¥¼ ìµœì ìœ¼ë¡œ ë§¤ì¹­</span>

<span class="sd">    Cost = Î»_cls * L_cls + Î»_box * L_box + Î»_giou * L_giou</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cost_class</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cost_bbox</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">cost_giou</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_class</span> <span class="o">=</span> <span class="n">cost_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_bbox</span> <span class="o">=</span> <span class="n">cost_bbox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_giou</span> <span class="o">=</span> <span class="n">cost_giou</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        scipy.optimize.linear_sum_assignment ì‚¬ìš©í•˜ì—¬</span>
<span class="sd">        ì´ë¶„ ë§¤ì¹­ ìˆ˜í–‰</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># êµ¬í˜„ ìƒëµ (scipy ì‚¬ìš©)</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="43-rt-detr-real-time-detr">4.3 RT-DETR (Real-Time DETR)<a class="header-link" href="#43-rt-detr-real-time-detr" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">ultralytics</span><span class="w"> </span><span class="kn">import</span> <span class="n">RTDETR</span>

<span class="c1"># RT-DETR ì‚¬ìš© (Ultralytics)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RTDETR</span><span class="p">(</span><span class="s2">&quot;rtdetr-l.pt&quot;</span><span class="p">)</span>

<span class="c1"># ì¶”ë¡ </span>
<span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="s2">&quot;image.jpg&quot;</span><span class="p">)</span>

<span class="c1"># í•™ìŠµ</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;coco.yaml&quot;</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">RT-DETR íŠ¹ì§•:</span>
<span class="sd">- DETRì˜ end-to-end ì¥ì  ìœ ì§€</span>
<span class="sd">- ì‹¤ì‹œê°„ ì¶”ë¡  ê°€ëŠ¥ (YOLO ìˆ˜ì¤€ ì†ë„)</span>
<span class="sd">- Efficient Hybrid Encoder</span>
<span class="sd">- IoU-aware Query Selection</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>

<hr />
<h2 id="5-instance-segmentation">5. ì¸ìŠ¤í„´ìŠ¤ ë¶„í•  (Instance Segmentation)<a class="header-link" href="#5-instance-segmentation" title="Permanent link">&para;</a></h2>
<h3 id="51-mask-r-cnn">5.1 Mask R-CNN<a class="header-link" href="#51-mask-r-cnn" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models.detection</span><span class="w"> </span><span class="kn">import</span> <span class="n">maskrcnn_resnet50_fpn_v2</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models.detection.mask_rcnn</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaskRCNNPredictor</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_mask_rcnn</span><span class="p">(</span><span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ì»¤ìŠ¤í…€ Mask R-CNN ìƒì„±</span>

<span class="sd">    Mask R-CNN = Faster R-CNN + Mask Head</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">maskrcnn_resnet50_fpn_v2</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="s2">&quot;DEFAULT&quot;</span><span class="p">)</span>

    <span class="c1"># Box predictor êµì²´</span>
    <span class="n">in_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_predictor</span><span class="o">.</span><span class="n">cls_score</span><span class="o">.</span><span class="n">in_features</span>
    <span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_predictor</span> <span class="o">=</span> <span class="n">FastRCNNPredictor</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

    <span class="c1"># Mask predictor êµì²´</span>
    <span class="n">in_features_mask</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">mask_predictor</span><span class="o">.</span><span class="n">conv5_mask</span><span class="o">.</span><span class="n">in_channels</span>
    <span class="n">hidden_layer</span> <span class="o">=</span> <span class="mi">256</span>
    <span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">mask_predictor</span> <span class="o">=</span> <span class="n">MaskRCNNPredictor</span><span class="p">(</span>
        <span class="n">in_features_mask</span><span class="p">,</span> <span class="n">hidden_layer</span><span class="p">,</span> <span class="n">num_classes</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>


<span class="k">def</span><span class="w"> </span><span class="nf">inference_mask_rcnn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mask R-CNN ì¶”ë¡ &quot;&quot;&quot;</span>

    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">([</span><span class="n">image</span><span class="p">])</span>

    <span class="n">pred</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;boxes&quot;</span><span class="p">:</span> <span class="n">pred</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">][</span><span class="n">keep</span><span class="p">],</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">pred</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="n">keep</span><span class="p">],</span>
        <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">pred</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">][</span><span class="n">keep</span><span class="p">],</span>
        <span class="s2">&quot;masks&quot;</span><span class="p">:</span> <span class="n">pred</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">][</span><span class="n">keep</span><span class="p">],</span>  <span class="c1"># (N, 1, H, W) soft masks</span>
    <span class="p">}</span>

    <span class="c1"># Hard maskë¡œ ë³€í™˜</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (N, H, W)</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="c1"># YOLOv8-seg ì‚¬ìš©</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ultralytics</span><span class="w"> </span><span class="kn">import</span> <span class="n">YOLO</span>

<span class="n">seg_model</span> <span class="o">=</span> <span class="n">YOLO</span><span class="p">(</span><span class="s2">&quot;yolov8n-seg.pt&quot;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">seg_model</span><span class="p">(</span><span class="s2">&quot;image.jpg&quot;</span><span class="p">)</span>

<span class="c1"># ê²°ê³¼ì—ì„œ ë§ˆìŠ¤í¬ ì¶”ì¶œ</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">masks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># (N, H, W)</span>
</code></pre></div>

<h3 id="52-sam-segment-anything-model">5.2 SAM (Segment Anything Model)<a class="header-link" href="#52-sam-segment-anything-model" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">segment_anything</span><span class="w"> </span><span class="kn">import</span> <span class="n">sam_model_registry</span><span class="p">,</span> <span class="n">SamPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># SAM ëª¨ë¸ ë¡œë“œ</span>
<span class="n">sam</span> <span class="o">=</span> <span class="n">sam_model_registry</span><span class="p">[</span><span class="s2">&quot;vit_h&quot;</span><span class="p">](</span><span class="n">checkpoint</span><span class="o">=</span><span class="s2">&quot;sam_vit_h.pth&quot;</span><span class="p">)</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">SamPredictor</span><span class="p">(</span><span class="n">sam</span><span class="p">)</span>

<span class="c1"># ì´ë¯¸ì§€ ì„¤ì •</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">set_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>  <span class="c1"># (H, W, 3) numpy array</span>

<span class="c1"># Point promptë¡œ ë¶„í• </span>
<span class="n">input_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">375</span><span class="p">]])</span>  <span class="c1"># í´ë¦­ ì¢Œí‘œ</span>
<span class="n">input_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 1 = foreground</span>

<span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="n">point_coords</span><span class="o">=</span><span class="n">input_point</span><span class="p">,</span>
    <span class="n">point_labels</span><span class="o">=</span><span class="n">input_label</span><span class="p">,</span>
    <span class="n">multimask_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 3ê°œì˜ ë§ˆìŠ¤í¬ í›„ë³´ ë°˜í™˜</span>
<span class="p">)</span>

<span class="c1"># Box promptë¡œ ë¶„í• </span>
<span class="n">input_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span>  <span class="c1"># x1, y1, x2, y2</span>

<span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="n">box</span><span class="o">=</span><span class="n">input_box</span><span class="p">,</span>
    <span class="n">multimask_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">SAM íŠ¹ì§•:</span>
<span class="sd">- Promptable segmentation (point, box, text)</span>
<span class="sd">- Zero-shot generalization</span>
<span class="sd">- ë§¤ìš° ë†’ì€ ë¶„í•  í’ˆì§ˆ</span>
<span class="sd">- ëŒ€í˜• ëª¨ë¸ë¡œ ëŠë¦° ì†ë„ â†’ MobileSAM, FastSAM ë“± ê²½ëŸ‰í™” ë²„ì „ ì¡´ì¬</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>

<hr />
<h2 id="6">6. ì‹¤ì „ íŒ<a class="header-link" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 ë°ì´í„°ì…‹ í˜•ì‹<a class="header-link" href="#61" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ì£¼ìš” ë°ì´í„°ì…‹ í˜•ì‹:</span>

<span class="sd">1. COCO Format:</span>
<span class="sd">   - annotations.jsonì— ëª¨ë“  ì–´ë…¸í…Œì´ì…˜ ì €ì¥</span>
<span class="sd">   - ì´ë¯¸ì§€ì™€ ì–´ë…¸í…Œì´ì…˜ ë¶„ë¦¬</span>

<span class="sd">2. YOLO Format:</span>
<span class="sd">   - ê° ì´ë¯¸ì§€ë§ˆë‹¤ .txt íŒŒì¼</span>
<span class="sd">   - class x_center y_center width height (ì •ê·œí™”)</span>

<span class="sd">3. Pascal VOC Format:</span>
<span class="sd">   - XML íŒŒì¼ë¡œ ê° ì´ë¯¸ì§€ ì–´ë…¸í…Œì´ì…˜</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># YOLO format ì˜ˆì‹œ (labels/train/image001.txt)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">0 0.5 0.5 0.2 0.3</span>
<span class="sd">1 0.3 0.7 0.1 0.15</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># COCO to YOLO ë³€í™˜</span>
<span class="k">def</span><span class="w"> </span><span class="nf">coco_to_yolo</span><span class="p">(</span><span class="n">coco_box</span><span class="p">,</span> <span class="n">img_width</span><span class="p">,</span> <span class="n">img_height</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    COCO: [x_min, y_min, width, height]</span>
<span class="sd">    YOLO: [x_center, y_center, width, height] (ì •ê·œí™”)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">coco_box</span>

    <span class="n">x_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">img_width</span>
    <span class="n">y_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">img_height</span>
    <span class="n">w_norm</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="n">img_width</span>
    <span class="n">h_norm</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="n">img_height</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">w_norm</span><span class="p">,</span> <span class="n">h_norm</span><span class="p">]</span>
</code></pre></div>

<h3 id="62">6.2 í•™ìŠµ íŒ<a class="header-link" href="#62" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ê°ì²´ íƒì§€ í•™ìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸:</span>

<span class="sd">1. ë°ì´í„° í’ˆì§ˆ</span>
<span class="sd">   - ë¼ë²¨ ì •í™•ë„ í™•ì¸</span>
<span class="sd">   - í´ë˜ìŠ¤ ë¶ˆê· í˜• ì²˜ë¦¬ (Focal Loss, ì˜¤ë²„ìƒ˜í”Œë§)</span>
<span class="sd">   - ì ì ˆí•œ ì¦ê°• ì‚¬ìš©</span>

<span class="sd">2. í•˜ì´í¼íŒŒë¼ë¯¸í„°</span>
<span class="sd">   - í•™ìŠµë¥ : 1e-4 ~ 1e-3 (ì‚¬ì „í•™ìŠµ ì‹œì‘)</span>
<span class="sd">   - ë°°ì¹˜ í¬ê¸°: GPU ë©”ëª¨ë¦¬ì— ë§ì¶° ìµœëŒ€í•œ í¬ê²Œ</span>
<span class="sd">   - ì´ë¯¸ì§€ í¬ê¸°: ëª¨ë¸ ê¸°ë³¸ê°’ ì‚¬ìš© (YOLO: 640)</span>

<span class="sd">3. ì¦ê°• ì „ëµ</span>
<span class="sd">   - Mosaic: 4ê°œ ì´ë¯¸ì§€ í•©ì„± (YOLO)</span>
<span class="sd">   - MixUp: ì´ë¯¸ì§€ ë¸”ë Œë”©</span>
<span class="sd">   - ê¸°ë³¸: Flip, Scale, Color Jitter</span>

<span class="sd">4. ëª¨ë¸ ì„ íƒ</span>
<span class="sd">   - ì‹¤ì‹œê°„: YOLO (YOLOv8n, YOLOv8s)</span>
<span class="sd">   - ì •í™•ë„: Faster R-CNN, DETR</span>
<span class="sd">   - ë¶„í• : YOLOv8-seg, Mask R-CNN</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Ultralytics í•™ìŠµ ì˜ˆì‹œ</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ultralytics</span><span class="w"> </span><span class="kn">import</span> <span class="n">YOLO</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">YOLO</span><span class="p">(</span><span class="s2">&quot;yolov8n.pt&quot;</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="s2">&quot;data.yaml&quot;</span><span class="p">,</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">imgsz</span><span class="o">=</span><span class="mi">640</span><span class="p">,</span>
    <span class="n">batch</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>

    <span class="c1"># ì¦ê°•</span>
    <span class="n">mosaic</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>      <span class="c1"># Mosaic í™•ë¥ </span>
    <span class="n">mixup</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>       <span class="c1"># MixUp í™•ë¥ </span>
    <span class="n">hsv_h</span><span class="o">=</span><span class="mf">0.015</span><span class="p">,</span>     <span class="c1"># Hue ì¦ê°•</span>
    <span class="n">hsv_s</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>       <span class="c1"># Saturation ì¦ê°•</span>
    <span class="n">hsv_v</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>       <span class="c1"># Value ì¦ê°•</span>
    <span class="n">degrees</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>     <span class="c1"># íšŒì „</span>
    <span class="n">translate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>   <span class="c1"># ì´ë™</span>
    <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>       <span class="c1"># ìŠ¤ì¼€ì¼</span>
    <span class="n">fliplr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>      <span class="c1"># ì¢Œìš° ë°˜ì „</span>

    <span class="c1"># ì •ê·œí™”</span>
    <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>

    <span class="c1"># í•™ìŠµ ìŠ¤ì¼€ì¤„</span>
    <span class="n">warmup_epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">warmup_momentum</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">warmup_bias_lr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">lr0</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>        <span class="c1"># ì´ˆê¸° í•™ìŠµë¥ </span>
    <span class="n">lrf</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>        <span class="c1"># ìµœì¢… í•™ìŠµë¥  ë¹„ìœ¨</span>
<span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="_2">ì •ë¦¬<a class="header-link" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="_3">íƒì§€ê¸° ì„ íƒ ê°€ì´ë“œ<a class="header-link" href="#_3" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>ìš”êµ¬ì‚¬í•­</th>
<th>ì¶”ì²œ ëª¨ë¸</th>
</tr>
</thead>
<tbody>
<tr>
<td>ì‹¤ì‹œê°„ (30+ FPS)</td>
<td>YOLOv8n/s</td>
</tr>
<tr>
<td>ë†’ì€ ì •í™•ë„</td>
<td>YOLOv8x, Faster R-CNN</td>
</tr>
<tr>
<td>ì‘ì€ ê°ì²´</td>
<td>YOLO + SAHI, RetinaNet</td>
</tr>
<tr>
<td>ì¸ìŠ¤í„´ìŠ¤ ë¶„í• </td>
<td>YOLOv8-seg, Mask R-CNN</td>
</tr>
<tr>
<td>End-to-end</td>
<td>DETR, RT-DETR</td>
</tr>
<tr>
<td>Zero-shot</td>
<td>Grounding DINO, SAM</td>
</tr>
</tbody>
</table>
<h3 id="_4">í•µì‹¬ ê°œë… ìš”ì•½<a class="header-link" href="#_4" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>ê°œë…</th>
<th>ì„¤ëª…</th>
</tr>
</thead>
<tbody>
<tr>
<td>IoU</td>
<td>ë°•ìŠ¤ ê²¹ì¹¨ ì •ë„ (0~1)</td>
</tr>
<tr>
<td>mAP</td>
<td>í‰ê·  ì •ë°€ë„ (ì •í™•ë„ ì§€í‘œ)</td>
</tr>
<tr>
<td>NMS</td>
<td>ì¤‘ë³µ ë°•ìŠ¤ ì œê±° í›„ì²˜ë¦¬</td>
</tr>
<tr>
<td>Anchor</td>
<td>ì‚¬ì „ ì •ì˜ëœ ê¸°ì¤€ ë°•ìŠ¤</td>
</tr>
<tr>
<td>FPN</td>
<td>ë‹¤ì¤‘ ìŠ¤ì¼€ì¼ íŠ¹ì§• ì¶”ì¶œ</td>
</tr>
<tr>
<td>GIoU/CIoU</td>
<td>ê°œì„ ëœ IoU ì†ì‹¤ í•¨ìˆ˜</td>
</tr>
</tbody>
</table>
<h3 id="_5">ë‹¤ìŒ ë‹¨ê³„<a class="header-link" href="#_5" title="Permanent link">&para;</a></h3>
<ul>
<li>Computer Vision í† í”½ì—ì„œ ì‹œë§¨í‹± ë¶„í• (Semantic Segmentation)ì„ í•™ìŠµí•©ë‹ˆë‹¤.</li>
<li><a href="../../Computer_Vision/19_DNN_Module.md">Computer_Vision/19_DNN_Module.md</a>: OpenCV DNN</li>
</ul>
<hr />
<h2 id="_6">ì°¸ê³  ìë£Œ<a class="header-link" href="#_6" title="Permanent link">&para;</a></h2>
<h3 id="_7">ë…¼ë¬¸<a class="header-link" href="#_7" title="Permanent link">&para;</a></h3>
<ul>
<li>"Faster R-CNN" (Ren et al., 2015)</li>
<li>"YOLO: You Only Look Once" (Redmon et al., 2016)</li>
<li>"DETR: End-to-End Object Detection with Transformers" (Carion et al., 2020)</li>
<li>"Segment Anything" (Kirillov et al., 2023)</li>
</ul>
<h3 id="_8">ì½”ë“œ &amp; ìë£Œ<a class="header-link" href="#_8" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://github.com/ultralytics/ultralytics">Ultralytics YOLOv8</a></li>
<li><a href="https://pytorch.org/vision/stable/models.html#object-detection">torchvision detection</a></li>
<li><a href="https://cocodataset.org/">COCO Dataset</a></li>
<li><a href="https://roboflow.com/">Roboflow</a> - ë°ì´í„°ì…‹ ê´€ë¦¬</li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Deep_Learning/37_Modern_Architectures.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">37. í˜„ëŒ€ ë”¥ëŸ¬ë‹ ì•„í‚¤í…ì²˜</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Deep_Learning/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Deep_Learning/39_Practical_Image_Classification.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">39. ì‹¤ì „ ì´ë¯¸ì§€ ë¶„ë¥˜ í”„ë¡œì íŠ¸</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'ko';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}