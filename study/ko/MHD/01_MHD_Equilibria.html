{% raw %}
<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1. MHD 평형 - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/ko/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/ko/" class="nav-item ">
                    <span class="nav-icon">🏠</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">💻</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/ko/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" >
                        English
                    </option>
                    
                    <option value="ko" selected>
                        한국어
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">☀️</span>
                    <span class="theme-icon dark">🌙</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/ko/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/ko/MHD/">MHD</a>
    <span class="separator">/</span>
    <span class="current">1. MHD 평형</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>1. MHD 평형</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/MHD/00_Overview.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">자기유체역학 (MHD)</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">🔗</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/MHD/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">📋</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/MHD/02_Linear_Stability.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">2. 선형 안정성 이론</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#_1">학습 목표</a></li>
<li><a href="#1-mhd_1">1. MHD 평형 소개</a></li>
<li><a href="#2">2. 힘 균형 방정식 유도</a><ul>
<li><a href="#21-mhd">2.1 이상 MHD 운동량 방정식에서 시작</a></li>
<li><a href="#22">2.2 자기장으로 표현</a></li>
<li><a href="#23">2.3 물리적 해석</a></li>
</ul>
</li>
<li><a href="#3">3. 힘 균형의 결과</a><ul>
<li><a href="#31">3.1 플럭스 표면 상에서 압력 일정</a></li>
<li><a href="#32">3.2 압력 구배에 수직인 전류</a></li>
<li><a href="#33">3.3 플럭스 표면 좌표계</a></li>
</ul>
</li>
<li><a href="#4-1">4. 1차원 평형</a><ul>
<li><a href="#41-pinch">4.1 θ-Pinch (종방향 자기장)</a></li>
<li><a href="#42-z-pinch">4.2 Z-Pinch (방위각 자기장)</a></li>
<li><a href="#43-screw-pinch">4.3 Screw Pinch (결합 장)</a></li>
</ul>
</li>
<li><a href="#5-grad-shafranov">5. Grad-Shafranov 방정식</a><ul>
<li><a href="#51">5.1 축대칭 평형</a></li>
<li><a href="#52-grad-shafranov">5.2 Grad-Shafranov 방정식 유도</a></li>
<li><a href="#53">5.3 자유 함수</a></li>
<li><a href="#54-solovev">5.4 Solovev 평형 (해석적 해)</a></li>
<li><a href="#55">5.5 수치 해법</a></li>
</ul>
</li>
<li><a href="#6">6. 안전 인자</a><ul>
<li><a href="#61">6.1 정의</a></li>
<li><a href="#62">6.2 원통 근사</a></li>
<li><a href="#63">6.3 전류 밀도와의 관계</a></li>
<li><a href="#64">6.4 안정성에 대한 의미</a></li>
</ul>
</li>
<li><a href="#7-shafranov">7. 플럭스 표면과 Shafranov 이동</a><ul>
<li><a href="#71">7.1 중첩 플럭스 표면</a></li>
<li><a href="#72-shafranov">7.2 Shafranov 이동</a></li>
<li><a href="#73">7.3 플럭스 표면 성형</a></li>
</ul>
</li>
<li><a href="#8">8. 플라즈마 베타</a><ul>
<li><a href="#81">8.1 정의</a></li>
<li><a href="#82">8.2 베타들 사이의 관계</a></li>
<li><a href="#83">8.3 베타 한계</a></li>
<li><a href="#84">8.4 베타 최적화</a></li>
</ul>
</li>
<li><a href="#9-python-grad-shafranov">9. Python 구현: Grad-Shafranov 솔버</a><ul>
<li><a href="#91-solovev">9.1 간단한 Solovev 평형</a></li>
<li><a href="#92-grad-shafranov">9.2 수치적 Grad-Shafranov 솔버</a></li>
</ul>
</li>
<li><a href="#10">10. 베타 계산</a></li>
<li><a href="#_2">요약</a></li>
<li><a href="#_3">연습 문제</a><ul>
<li><a href="#1">문제 1: 원통형 플라즈마에서의 힘 균형</a></li>
<li><a href="#2-z-pinch-bennett">문제 2: Z-Pinch에 대한 Bennett 관계</a></li>
<li><a href="#3-grad-shafranov">문제 3: 일정 압력을 가진 Grad-Shafranov</a></li>
<li><a href="#4">문제 4: 안전 인자와 전류 프로파일</a></li>
<li><a href="#5">문제 5: 베타 한계</a></li>
</ul>
</li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="1-mhd">1. MHD 평형<a class="header-link" href="#1-mhd" title="Permanent link">&para;</a></h1>
<h2 id="_1">학습 목표<a class="header-link" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li>이상 MHD 운동량 방정식으로부터 MHD 힘 균형 방정식 유도</li>
<li>힘 균형의 결과 이해: 플럭스 표면 상에서 압력 일정</li>
<li>1차원 평형 분석: θ-pinch, Z-pinch, screw pinch 구성</li>
<li>축대칭 평형에 대한 Grad-Shafranov 방정식 수식화 및 풀이</li>
<li>안전 인자 q 계산 및 안정성에 대한 의미 이해</li>
<li>플라즈마 베타 계산 및 운영 한계 이해</li>
<li>간단한 평형 구성에 대한 수치 해 구현</li>
</ul>
<h2 id="1-mhd_1">1. MHD 평형 소개<a class="header-link" href="#1-mhd_1" title="Permanent link">&para;</a></h2>
<p>자기유체역학 평형은 모든 힘이 균형을 이루고 알짜 가속도가 없는 자화 플라즈마의 정상 상태 구성을 설명합니다. 평형을 이해하는 것은 핵융합 에너지 연구, 천체물리학 플라즈마 물리학, 그리고 갇힌 플라즈마와 관련된 모든 응용에 기본적입니다.</p>
<p>MHD 평형은 다음을 만족합니다:</p>
<div class="highlight"><pre><span></span><code>∂/∂t = 0  (시간 독립)
v = 0      (정지 플라즈마)
</code></pre></div>

<p>평형 상태는 다음 사이의 균형에 의해 지배됩니다:
- <strong>플라즈마 압력 구배 힘</strong>: ∇p (외부로 밀어냄)
- <strong>자기 장력</strong>: (B·∇)B/μ₀ (자기장선을 따라 당김)
- <strong>자기 압력 구배</strong>: -∇(B²/2μ₀) (높은 장에서 낮은 장으로 밀어냄)</p>
<p>힘 균형 방정식은 모든 평형 계산의 기초입니다.</p>
<h2 id="2">2. 힘 균형 방정식 유도<a class="header-link" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21-mhd">2.1 이상 MHD 운동량 방정식에서 시작<a class="header-link" href="#21-mhd" title="Permanent link">&para;</a></h3>
<p>이상 MHD 운동량 방정식은:</p>
<p>$$
\rho\frac{D\mathbf{v}}{Dt} = -\nabla p + \mathbf{J}\times\mathbf{B}
$$</p>
<p>평형에서 좌변은 사라집니다 (가속도 없음, 정지 플라즈마):</p>
<p>$$
\nabla p = \mathbf{J}\times\mathbf{B}
$$</p>
<p>이것이 <strong>기본 MHD 평형 방정식</strong>입니다.</p>
<h3 id="22">2.2 자기장으로 표현<a class="header-link" href="#22" title="Permanent link">&para;</a></h3>
<p>앙페르 법칙 사용 (변위 전류 무시):</p>
<p>$$
\mathbf{J} = \frac{1}{\mu_0}\nabla\times\mathbf{B}
$$</p>
<p>힘 균형은 다음과 같이 됩니다:</p>
<p>$$
\nabla p = \frac{1}{\mu_0}(\nabla\times\mathbf{B})\times\mathbf{B}
$$</p>
<p>벡터 항등식 사용:</p>
<p>$$
(\nabla\times\mathbf{B})\times\mathbf{B} = (\mathbf{B}\cdot\nabla)\mathbf{B} - \nabla\left(\frac{B^2}{2}\right)
$$</p>
<p>다음을 얻습니다:</p>
<p>$$
\nabla p = \frac{1}{\mu_0}\left[(\mathbf{B}\cdot\nabla)\mathbf{B} - \nabla\left(\frac{B^2}{2}\right)\right]
$$</p>
<p>재배열:</p>
<p>$$
\nabla\left(p + \frac{B^2}{2\mu_0}\right) = \frac{1}{\mu_0}(\mathbf{B}\cdot\nabla)\mathbf{B}
$$</p>
<p>좌변은 <strong>전체 압력</strong> (운동 + 자기)의 구배입니다:</p>
<p>$$
p_{total} = p + \frac{B^2}{2\mu_0}
$$</p>
<p>우변은 자기장선을 따른 <strong>자기 장력</strong>을 나타냅니다.</p>
<h3 id="23">2.3 물리적 해석<a class="header-link" href="#23" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>힘 균형 성분:
=======================

1. 압력 구배: ∇p
   - 높은 압력에서 낮은 압력으로 밀어냄
   - 등방성 힘

2. 자기 압력: -∇(B²/2μ₀)
   - 높은 장에서 낮은 장으로 밀어냄
   - B에 수직으로 작용

3. 자기 장력: (B·∇)B/μ₀
   - 굽은 자기장선을 따라 당김
   - 늘어난 고무줄처럼

알짜 힘: ∇p + ∇(B²/2μ₀) - (B·∇)B/μ₀ = 0
</code></pre></div>

<h2 id="3">3. 힘 균형의 결과<a class="header-link" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 플럭스 표면 상에서 압력 일정<a class="header-link" href="#31" title="Permanent link">&para;</a></h3>
<p>힘 균형 방정식을 <strong>B</strong>와 내적하면:</p>
<p>$$
\mathbf{B}\cdot\nabla p = \mathbf{B}\cdot(\mathbf{J}\times\mathbf{B}) = 0
$$</p>
<p>이는 다음을 의미합니다:</p>
<p>$$
\mathbf{B}\cdot\nabla p = 0
$$</p>
<p><strong>결과</strong>: 압력은 자기장선을 따라 일정합니다. 토로이달 구성에서 자기장선은 중첩된 플럭스 표면 위에 놓여있으므로 <strong>압력은 각 플럭스 표면에서 일정</strong>합니다.</p>
<h3 id="32">3.2 압력 구배에 수직인 전류<a class="header-link" href="#32" title="Permanent link">&para;</a></h3>
<p>힘 균형 방정식을 <strong>J</strong>와 내적하면:</p>
<p>$$
\mathbf{J}\cdot\nabla p = \mathbf{J}\cdot(\mathbf{J}\times\mathbf{B}) = 0
$$</p>
<p>이는 다음을 의미합니다:</p>
<p>$$
\mathbf{J}\cdot\nabla p = 0
$$</p>
<p><strong>결과</strong>: 전류는 압력 구배에 수직으로 흐르므로, 전류도 플럭스 표면 위에 놓입니다.</p>
<h3 id="33">3.3 플럭스 표면 좌표계<a class="header-link" href="#33" title="Permanent link">&para;</a></h3>
<p>위의 두 결과는 <strong>B</strong>와 <strong>J</strong> 모두 일정한 압력의 표면 위에 놓인다는 것을 의미합니다. 이 표면들을 <strong>자기 플럭스 표면</strong>이라고 합니다. 이것이 토카막 평형 계산에 사용되는 플럭스 표면 좌표계의 기초입니다.</p>
<div class="highlight"><pre><span></span><code>플럭스 표면 구조:
======================

        ┌─────────────┐
        │             │   외부 플럭스 표면 (낮은 p)
        │  ┌───────┐  │
        │  │       │  │   중간 플럭스 표면
        │  │   ┌─┐ │  │
        │  │   │·│ │  │   자기 축 (최고 p)
        │  │   └─┘ │  │
        │  │       │  │
        │  └───────┘  │
        │             │
        └─────────────┘

특성:
- p = p(ψ) 여기서 ψ는 플럭스 표면 레이블
- B는 플럭스 표면 내에 놓임
- J는 플럭스 표면 내에 놓임
</code></pre></div>

<h2 id="4-1">4. 1차원 평형<a class="header-link" href="#4-1" title="Permanent link">&para;</a></h2>
<h3 id="41-pinch">4.1 θ-Pinch (종방향 자기장)<a class="header-link" href="#41-pinch" title="Permanent link">&para;</a></h3>
<p>θ-pinch는 순수 종방향 (축) 자기장을 사용하여 플라즈마를 방사상으로 가둡니다.</p>
<p><strong>구성</strong>:
- 원통 기하학 (r, θ, z)
- $B_z(r)$, $p(r)$
- $B_r = B_θ = 0$
- 플라즈마에 전류 없음: $J_z = 0$</p>
<p><strong>힘 균형</strong>:</p>
<p>원통 좌표계에서:</p>
<p>$$
\frac{dp}{dr} = -\frac{1}{\mu_0}\frac{d}{dr}\left(\frac{B_z^2}{2}\right)
$$</p>
<p>$r$에서 $r=a$의 플라즈마 경계까지 적분 (여기서 $p(a)=0$):</p>
<p>$$
p(r) = \frac{B_z^2(a) - B_z^2(r)}{2\mu_0}
$$</p>
<p><strong>물리적 그림</strong>:
- 플라즈마 압력은 자기 압력에 의해 균형
- 자기 장력 없음 (직선 자기장선)
- 순수 방사상 가둠</p>
<p><strong>Bennett 관계</strong> (전체 압력 균형):</p>
<p>단면에 대해 적분:</p>
<p>$$
\int_0^a 2\pi r\, p(r)\, dr = \frac{\pi a^2 B_{ext}^2}{2\mu_0}
$$</p>
<p>여기서 $B_{ext}$는 외부 장입니다.</p>
<h3 id="42-z-pinch">4.2 Z-Pinch (방위각 자기장)<a class="header-link" href="#42-z-pinch" title="Permanent link">&para;</a></h3>
<p>Z-pinch는 축방향 전류로부터 자체 생성된 방위각 자기장을 사용합니다.</p>
<p><strong>구성</strong>:
- $B_θ(r)$, $p(r)$
- $J_z(r)$ (축방향 전류)
- $B_r = B_z = 0$</p>
<p><strong>앙페르 법칙</strong>:</p>
<p>$$
B_θ(r) = \frac{\mu_0}{2\pi r}\int_0^r J_z(r')2\pi r'\, dr' = \frac{\mu_0 I(r)}{2\pi r}
$$</p>
<p>여기서 $I(r)$은 반지름 $r$ 내에 둘러싸인 전류입니다.</p>
<p><strong>힘 균형</strong>:</p>
<p>$$
\frac{dp}{dr} = -\frac{1}{\mu_0}\frac{d}{dr}\left(\frac{B_θ^2}{2}\right) = -\frac{B_θ}{\mu_0 r}
$$</p>
<p>$B_θ = \mu_0 I/(2\pi r)$ 사용:</p>
<p>$$
\frac{dp}{dr} = -\frac{J_z B_θ}{\mu_0}
$$</p>
<p><strong>Bennett 관계</strong> (차원 분석):</p>
<p>균일한 전류 밀도 $J_z = I/(\pi a^2)$에 대해:</p>
<p>$$
I^2 = \frac{8\pi}{\mu_0}NkT
$$</p>
<p>여기서 $N$은 총 입자 수이고 $T$는 온도입니다.</p>
<p><strong>물리적 그림</strong>:
- 전류가 방위각 장 생성
- 자기 압력이 플라즈마를 안쪽으로 조임
- 플라즈마 압력이 바깥쪽으로 밀어냄
- 매우 불안정 (kink, sausage 불안정성)</p>
<h3 id="43-screw-pinch">4.3 Screw Pinch (결합 장)<a class="header-link" href="#43-screw-pinch" title="Permanent link">&para;</a></h3>
<p>Screw pinch는 개선된 안정성을 위해 축방향과 방위각 장을 결합합니다.</p>
<p><strong>구성</strong>:
- $B_z(r)$, $B_θ(r)$, $p(r)$
- $J_z(r)$, $J_θ(r)$</p>
<p><strong>힘 균형</strong>:</p>
<p>$$
\frac{dp}{dr} = -\frac{1}{\mu_0}\frac{d}{dr}\left(\frac{B_z^2 + B_θ^2}{2}\right)
$$</p>
<p><strong>안전 인자</strong> (자기장선의 피치):</p>
<p>$$
q(r) = \frac{rB_z}{RB_θ}
$$</p>
<p>여기서 $R$은 주요 반지름 (토로이달 시스템) 또는 특성 길이입니다.</p>
<p><strong>물리적 그림</strong>:
- $B_z$는 kink 모드에 대한 안정성 제공
- $B_θ$는 가둠 제공
- $q(r)$의 전단이 짧은 파장 모드 안정화
- 토카막 가둠의 기초</p>
<div class="highlight"><pre><span></span><code>Screw Pinch 자기장선:
======================

      z ^
        |    /
        |   / ← 자기장선 나선
        |  /
        | /
        |/________&gt; θ

q = Δz / (2πR) 폴로이달 회전당
</code></pre></div>

<h2 id="5-grad-shafranov">5. Grad-Shafranov 방정식<a class="header-link" href="#5-grad-shafranov" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 축대칭 평형<a class="header-link" href="#51" title="Permanent link">&para;</a></h3>
<p>축대칭 토로이달 시스템 (토카막, 단순화된 형태의 stellarator)에 대해, 평형은 단일 스칼라 함수로 설명될 수 있습니다: <strong>폴로이달 플럭스 함수</strong> $\psi(R,Z)$.</p>
<p><strong>원통 좌표계</strong>: $(R, \phi, Z)$ 여기서 $\phi$는 토로이달 각입니다.</p>
<p><strong>자기장 표현</strong>:</p>
<p>$$
\mathbf{B} = F(R,Z)\nabla\phi + \nabla\phi\times\nabla\psi
$$</p>
<p>여기서:
- $F(R,Z) = RB_\phi$ (토로이달 장 함수)
- $\psi$는 폴로이달 플럭스 함수</p>
<p>성분 형태로:</p>
<p>$$
B_R = \frac{1}{R}\frac{\partial\psi}{\partial Z}, \quad B_Z = -\frac{1}{R}\frac{\partial\psi}{\partial R}, \quad B_\phi = \frac{F}{R}
$$</p>
<h3 id="52-grad-shafranov">5.2 Grad-Shafranov 방정식 유도<a class="header-link" href="#52-grad-shafranov" title="Permanent link">&para;</a></h3>
<p>힘 균형에서 시작:</p>
<p>$$
\nabla p = \mathbf{J}\times\mathbf{B}
$$</p>
<p>그리고 $\mathbf{J} = \nabla\times\mathbf{B}/\mu_0$ 사용, 토로이달 성분은:</p>
<p>$$
\frac{dp}{d\psi} = -\frac{1}{\mu_0 R^2}\frac{dF}{d\psi}F
$$</p>
<p>폴로이달 성분은 <strong>Grad-Shafranov 방정식</strong>을 제공합니다:</p>
<p>$$
\Delta^*\psi \equiv R\frac{\partial}{\partial R}\left(\frac{1}{R}\frac{\partial\psi}{\partial R}\right) + \frac{\partial^2\psi}{\partial Z^2} = -\mu_0 R^2\frac{dp}{d\psi} - F\frac{dF}{d\psi}
$$</p>
<p>이것은 $\psi(R,Z)$에 대한 <strong>타원형 편미분 방정식</strong>입니다.</p>
<h3 id="53">5.3 자유 함수<a class="header-link" href="#53" title="Permanent link">&para;</a></h3>
<p>Grad-Shafranov 방정식은 두 개의 <strong>자유 함수</strong> 지정을 필요로 합니다:</p>
<ol>
<li><strong>압력 프로파일</strong>: $p(\psi)$</li>
<li><strong>토로이달 장 함수</strong>: $F(\psi)$ (또는 동등하게 $F^2(\psi)$)</li>
</ol>
<p>이 함수들은 다음에 의해 결정됩니다:
- 플라즈마 가열 및 전류 구동
- 경계 조건 (전도 벽, 외부 코일)
- 수송 과정 (MHD를 넘어서)</p>
<p>해석적 해에 대한 일반적인 선택:
- $p(\psi) = p_0(1 - \psi/\psi_0)^\alpha$
- $F^2(\psi) = F_0^2 + \beta(\psi - \psi_0)$</p>
<h3 id="54-solovev">5.4 Solovev 평형 (해석적 해)<a class="header-link" href="#54-solovev" title="Permanent link">&para;</a></h3>
<p>자유 함수에 대해:</p>
<p>$$
p(\psi) = 0, \quad F^2(\psi) = F_0^2 + c\psi
$$</p>
<p>Grad-Shafranov 방정식은 선형이 됩니다:</p>
<p>$$
\Delta^*\psi = -\mu_0 c R^2
$$</p>
<p><strong>Solovev 해</strong> (원형 단면에 대해):</p>
<p>$$
\psi(R,Z) = \frac{1}{8}c\mu_0\left[(R^2 - R_0^2)^2 + Z^2\right] + \psi_0
$$</p>
<p>이것은 Shafranov 이동만큼 바깥쪽으로 이동한 원형 플럭스 표면을 나타냅니다.</p>
<h3 id="55">5.5 수치 해법<a class="header-link" href="#55" title="Permanent link">&para;</a></h3>
<p>일반적인 $p(\psi)$와 $F(\psi)$에 대해, Grad-Shafranov 방정식은 수치적으로 풀어야 합니다:</p>
<p><strong>반복 스킴</strong>:
1. 초기 $\psi^{(0)}(R,Z)$ 추정
2. $p(\psi^{(n)})$과 $F(\psi^{(n)})$ 계산
3. 선형 타원 방정식 풀이:
   $$
   \Delta^*\psi^{(n+1)} = -\mu_0 R^2\frac{dp}{d\psi}\Big|_{\psi^{(n)}} - F\frac{dF}{d\psi}\Big|_{\psi^{(n)}}
   $$
4. 수렴할 때까지 반복: $|\psi^{(n+1)} - \psi^{(n)}| < \epsilon$</p>
<p><strong>이산화</strong>: $(R,Z)$ 그리드에서 유한 차분 또는 유한 요소 방법.</p>
<h2 id="6">6. 안전 인자<a class="header-link" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 정의<a class="header-link" href="#61" title="Permanent link">&para;</a></h3>
<p><strong>안전 인자</strong> $q(\psi)$는 플럭스 표면에서 자기장선의 피치를 측정합니다:</p>
<p>$$
q = \frac{1}{2\pi}\oint\frac{d\ell_\parallel}{Rd\phi}
$$</p>
<p>여기서 적분은 한 폴로이달 회전에 대한 것입니다.</p>
<p><strong>물리적 해석</strong>:
- $q$는 자기장선이 폴로이달 회전당 만드는 토로이달 회전 수
- 유리수 값 ($q = m/n$)은 섭동이 공명할 수 있는 <strong>공명 표면</strong>을 정의</p>
<h3 id="62">6.2 원통 근사<a class="header-link" href="#62" title="Permanent link">&para;</a></h3>
<p>큰 종횡비 토카막 ($R \approx R_0 + r\cos\theta$)에 대해:</p>
<p>$$
q(r) \approx \frac{rB_z}{R_0 B_θ}
$$</p>
<p>$B_θ = \mu_0 I(r)/(2\pi r)$ 사용:</p>
<p>$$
q(r) = \frac{2\pi r^2 B_z}{\mu_0 R_0 I(r)}
$$</p>
<h3 id="63">6.3 전류 밀도와의 관계<a class="header-link" href="#63" title="Permanent link">&para;</a></h3>
<p>미분:</p>
<p>$$
\frac{dq}{dr} = \frac{2\pi r B_z}{\mu_0 R_0}\left(\frac{2}{I} - \frac{r J_z}{I}\right)
$$</p>
<p><strong>자기 전단</strong>:</p>
<p>$$
s = \frac{r}{q}\frac{dq}{dr}
$$</p>
<p>양의 전단 ($dq/dr > 0$)은 일반적으로 안정화입니다.</p>
<h3 id="64">6.4 안정성에 대한 의미<a class="header-link" href="#64" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Kruskal-Shafranov 기준</strong>: 외부 kink 모드는 $q(a) > m/n$ 필요</li>
<li>$m=1, n=1$에 대해: $q(a) > 1$이 필요 (충분하지 않음)</li>
<li><strong>내부 kink</strong> (sawtooth 진동): $q(0) < 1$</li>
<li><strong>유리수 표면</strong> $q = m/n$: tearing 모드의 위치</li>
</ul>
<div class="highlight"><pre><span></span><code>토카막의 일반적인 q-프로파일:
============================

q |     ___________________  q(a) &gt; 2
  |    /
  |   /                     ← 단조 (양의 전단)
  |  /
  | /                       q(0) ~ 1
  |/________________________ r
  0                        a

특징:
<span class="k">-</span> q(0) ~ 1 (축 상)
<span class="k">-</span> q(a) &gt; 2-3 (가장자리, 안정성 위해)
<span class="k">-</span> 역전단: 중심부에서 dq/dr &lt; 0 (고급 시나리오)
</code></pre></div>

<h2 id="7-shafranov">7. 플럭스 표면과 Shafranov 이동<a class="header-link" href="#7-shafranov" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 중첩 플럭스 표면<a class="header-link" href="#71" title="Permanent link">&para;</a></h3>
<p>잘 갇힌 플라즈마에서 플럭스 표면은 중첩된 위상학적 토러스입니다. 자기 축 (가장 안쪽 표면)은 다음을 가진 표면입니다:
- 최고 압력
- $q(\psi_{axis})$ 최소
- $|\nabla\psi| = 0$</p>
<h3 id="72-shafranov">7.2 Shafranov 이동<a class="header-link" href="#72-shafranov" title="Permanent link">&para;</a></h3>
<p>토로이달 효과로 인해, 자기 축은 기하학적 중심에 대해 <strong>바깥쪽</strong> (더 큰 $R$)으로 이동합니다.</p>
<p><strong>물리적 기원</strong>:
- 안쪽에서 더 높은 장 → 더 높은 자기 압력
- 플라즈마 압력 구배가 균형을 위한 바깥쪽 이동 생성</p>
<p><strong>근사 공식</strong>:</p>
<p>$$
\Delta_{Shafranov} \approx \frac{a^2\beta_p}{2R_0}
$$</p>
<p>여기서 $\beta_p = 2\mu_0\langle p\rangle/B_p^2$는 폴로이달 베타입니다.</p>
<h3 id="73">7.3 플럭스 표면 성형<a class="header-link" href="#73" title="Permanent link">&para;</a></h3>
<p>현대 토카막은 비원형 단면을 사용합니다:
- <strong>늘림</strong> $\kappa = b/a$ (수직 늘림): 안정성과 가둠 개선
- <strong>삼각형성</strong> $\delta$: 안쪽 들여쓰기, ballooning 모드 안정화</p>
<h2 id="8">8. 플라즈마 베타<a class="header-link" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 정의<a class="header-link" href="#81" title="Permanent link">&para;</a></h3>
<p><strong>플라즈마 베타</strong>는 플라즈마 압력 대 자기 압력의 비율입니다:</p>
<p>$$
\beta = \frac{2\mu_0 p}{B^2}
$$</p>
<p><strong>체적 평균 베타</strong>:</p>
<p>$$
\langle\beta\rangle = \frac{2\mu_0\langle p\rangle}{\langle B^2\rangle}
$$</p>
<p><strong>폴로이달 베타</strong>:</p>
<p>$$
\beta_p = \frac{2\mu_0\langle p\rangle}{B_p^2}
$$</p>
<p><strong>토로이달 베타</strong>:</p>
<p>$$
\beta_t = \frac{2\mu_0\langle p\rangle}{B_t^2}
$$</p>
<h3 id="82">8.2 베타들 사이의 관계<a class="header-link" href="#82" title="Permanent link">&para;</a></h3>
<p>큰 종횡비 토카막에 대해:</p>
<p>$$
\beta_t \approx \beta_p\left(\frac{B_p}{B_t}\right)^2 \approx \beta_p\left(\frac{a}{R_0}\right)^2\frac{1}{q^2}
$$</p>
<h3 id="83">8.3 베타 한계<a class="header-link" href="#83" title="Permanent link">&para;</a></h3>
<p>높은 베타는 핵융합 로에 바람직하지만 (더 많은 핵융합 출력), MHD 안정성이 $\beta$를 제한합니다:</p>
<p><strong>Troyon 한계</strong> (경험적 스케일링):</p>
<p>$$
\beta_N \equiv \frac{\beta_t(\%)}{I_p/(aB_t)} \lesssim 2.8 - 3.5
$$</p>
<p>여기서 $I_p$는 플라즈마 전류 (MA), $a$는 미터, $B_t$는 Tesla입니다.</p>
<p><strong>물리적 기원</strong>:
- 높은 $\beta$ → 강한 압력 구배 → 압력 구동 불안정성
- 외부 kink 모드가 고정된 $q(a)$에서 $\beta$ 제한</p>
<h3 id="84">8.4 베타 최적화<a class="header-link" href="#84" title="Permanent link">&para;</a></h3>
<p>베타 한계를 높이는 전략:
- 높은 늘림 $\kappa$
- 높은 삼각형성 $\delta$
- 전도 벽 안정화
- 플라즈마 회전
- 고급 토카막 시나리오 (역전단, 수송 장벽)</p>
<h2 id="9-python-grad-shafranov">9. Python 구현: Grad-Shafranov 솔버<a class="header-link" href="#9-python-grad-shafranov" title="Permanent link">&para;</a></h2>
<h3 id="91-solovev">9.1 간단한 Solovev 평형<a class="header-link" href="#91-solovev" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">solve</span>

<span class="c1"># Solovev equilibrium solver</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SolovevEquilibrium</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">Bt0</span><span class="p">,</span> <span class="n">Ip</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        R0: major radius [m]</span>
<span class="sd">        a: minor radius [m]</span>
<span class="sd">        kappa: elongation</span>
<span class="sd">        delta: triangularity</span>
<span class="sd">        Bt0: toroidal field on axis [T]</span>
<span class="sd">        Ip: plasma current [A]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R0</span> <span class="o">=</span> <span class="n">R0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="n">kappa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bt0</span> <span class="o">=</span> <span class="n">Bt0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ip</span> <span class="o">=</span> <span class="n">Ip</span>

        <span class="c1"># Physical constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1e-7</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_psi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute poloidal flux function (Solovev solution)&quot;&quot;&quot;</span>
        <span class="c1"># Simplified Solovev: circular, low beta</span>
        <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ip</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Normalized coordinates</span>
        <span class="n">r_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">R</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">R0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Z</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>

        <span class="c1"># Flux function (normalized)</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="o">-</span><span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">R0</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">r_norm</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">8</span>

        <span class="k">return</span> <span class="n">psi</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_B</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute magnetic field components&quot;&quot;&quot;</span>
        <span class="c1"># Numerical derivatives</span>
        <span class="n">dR</span> <span class="o">=</span> <span class="mf">0.001</span>
        <span class="n">dZ</span> <span class="o">=</span> <span class="mf">0.001</span>

        <span class="n">dpsi_dR</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R</span><span class="o">+</span><span class="n">dR</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R</span><span class="o">-</span><span class="n">dR</span><span class="p">,</span> <span class="n">Z</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dR</span><span class="p">)</span>
        <span class="n">dpsi_dZ</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="o">+</span><span class="n">dZ</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="o">-</span><span class="n">dZ</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dZ</span><span class="p">)</span>

        <span class="n">BR</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">R</span> <span class="o">*</span> <span class="n">dpsi_dZ</span>
        <span class="n">BZ</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">R</span> <span class="o">*</span> <span class="n">dpsi_dR</span>
        <span class="n">Bphi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bt0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">R0</span> <span class="o">/</span> <span class="n">R</span>

        <span class="k">return</span> <span class="n">BR</span><span class="p">,</span> <span class="n">BZ</span><span class="p">,</span> <span class="n">Bphi</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psi_vals</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute safety factor profile&quot;&quot;&quot;</span>
        <span class="c1"># Simplified q-profile for circular equilibrium</span>
        <span class="n">psi_edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">psi_norm</span> <span class="o">=</span> <span class="n">psi_vals</span> <span class="o">/</span> <span class="n">psi_edge</span>

        <span class="c1"># Parabolic q-profile</span>
        <span class="n">q0</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># On-axis q</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="mf">3.0</span>  <span class="c1"># Edge q</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">q0</span> <span class="o">+</span> <span class="p">(</span><span class="n">qa</span> <span class="o">-</span> <span class="n">q0</span><span class="p">)</span> <span class="o">*</span> <span class="n">psi_norm</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">return</span> <span class="n">q</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_flux_surfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nr</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">nz</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot flux surfaces&quot;&quot;&quot;</span>
        <span class="n">R_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R0</span> <span class="o">-</span> <span class="mf">1.2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R0</span> <span class="o">+</span> <span class="mf">1.2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">nr</span><span class="p">)</span>
        <span class="n">Z_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">nz</span><span class="p">)</span>

        <span class="n">R_mesh</span><span class="p">,</span> <span class="n">Z_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">R_grid</span><span class="p">,</span> <span class="n">Z_grid</span><span class="p">)</span>
        <span class="n">psi_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R_mesh</span><span class="p">,</span> <span class="n">Z_mesh</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="c1"># Contour plot of flux surfaces</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">CS</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">R_mesh</span><span class="p">,</span> <span class="n">Z_mesh</span><span class="p">,</span> <span class="n">psi_mesh</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="c1"># Mark magnetic axis</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;r*&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Magnetic axis&#39;</span><span class="p">)</span>

        <span class="c1"># Mark last closed flux surface</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">R_lcfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="n">Z_lcfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">R_lcfs</span><span class="p">,</span> <span class="n">Z_lcfs</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;LCFS&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;R [m]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Z [m]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Flux Surfaces (Solovev Equilibrium)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_q_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot safety factor profile&quot;&quot;&quot;</span>
        <span class="c1"># Radial coordinate (minor radius)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">R_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R0</span> <span class="o">+</span> <span class="n">r</span>
        <span class="n">Z_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># Compute psi along midplane</span>
        <span class="n">psi_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">R_vals</span><span class="p">])</span>

        <span class="c1"># Compute q</span>
        <span class="n">q_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_q</span><span class="p">(</span><span class="n">psi_vals</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">q_vals</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;q = 1 (sawtooth)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;q = 2 (m=2 resonance)&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a (normalized radius)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;q (safety factor)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Safety Factor Profile&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_pressure_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot pressure and current density profiles&quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="c1"># Parabolic pressure profile</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="mf">1e5</span>  <span class="c1"># Central pressure [Pa]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># Current density (from force balance)</span>
        <span class="c1"># J_phi ~ dp/dr (simplified)</span>
        <span class="n">dp_dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">j_phi</span> <span class="o">=</span> <span class="o">-</span><span class="n">dp_dr</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bt0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">R0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span>  <span class="c1"># Normalized</span>

        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="c1"># Pressure</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pressure [kPa]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pressure Profile&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Current density</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">j_phi</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Current Density (normalized)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Toroidal Current Density Profile&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Example usage</span>
<span class="k">def</span><span class="w"> </span><span class="nf">example_tokamak_equilibrium</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ITER-like parameters&quot;&quot;&quot;</span>
    <span class="n">R0</span> <span class="o">=</span> <span class="mf">6.2</span>    <span class="c1"># Major radius [m]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span>     <span class="c1"># Minor radius [m]</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="mf">1.7</span> <span class="c1"># Elongation</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="mf">0.33</span><span class="c1"># Triangularity</span>
    <span class="n">Bt0</span> <span class="o">=</span> <span class="mf">5.3</span>   <span class="c1"># Toroidal field [T]</span>
    <span class="n">Ip</span> <span class="o">=</span> <span class="mf">15e6</span>   <span class="c1"># Plasma current [A]</span>

    <span class="n">eq</span> <span class="o">=</span> <span class="n">SolovevEquilibrium</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">Bt0</span><span class="p">,</span> <span class="n">Ip</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== ITER-like Tokamak Equilibrium ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Major radius R0 = </span><span class="si">{</span><span class="n">R0</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Minor radius a = </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aspect ratio A = </span><span class="si">{</span><span class="n">R0</span><span class="o">/</span><span class="n">a</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Elongation κ = </span><span class="si">{</span><span class="n">kappa</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Triangularity δ = </span><span class="si">{</span><span class="n">delta</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Toroidal field Bt0 = </span><span class="si">{</span><span class="n">Bt0</span><span class="si">}</span><span class="s2"> T&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plasma current Ip = </span><span class="si">{</span><span class="n">Ip</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MA&quot;</span><span class="p">)</span>

    <span class="c1"># Compute some equilibrium quantities</span>
    <span class="n">psi_axis</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">psi_edge</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">R0</span> <span class="o">+</span> <span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Flux at axis: </span><span class="si">{</span><span class="n">psi_axis</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2"> Wb&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flux at edge: </span><span class="si">{</span><span class="n">psi_edge</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2"> Wb&quot;</span><span class="p">)</span>

    <span class="c1"># Safety factor</span>
    <span class="n">q_axis</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">compute_q</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">psi_axis</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">q_edge</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">compute_q</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">psi_edge</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Safety factor q(0) = </span><span class="si">{</span><span class="n">q_axis</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Safety factor q(a) = </span><span class="si">{</span><span class="n">q_edge</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Plot results</span>
    <span class="n">fig1</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">plot_flux_surfaces</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/tmp/flux_surfaces.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Flux surfaces plot saved to /tmp/flux_surfaces.png&quot;</span><span class="p">)</span>

    <span class="n">fig2</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">plot_q_profile</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/tmp/q_profile.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;q-profile plot saved to /tmp/q_profile.png&quot;</span><span class="p">)</span>

    <span class="n">fig3</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">plot_pressure_profile</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/tmp/pressure_profile.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pressure profile plot saved to /tmp/pressure_profile.png&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">example_tokamak_equilibrium</span><span class="p">()</span>
</code></pre></div>

<h3 id="92-grad-shafranov">9.2 수치적 Grad-Shafranov 솔버<a class="header-link" href="#92-grad-shafranov" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">diags</span><span class="p">,</span> <span class="n">csr_matrix</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">spsolve</span>

<span class="k">class</span><span class="w"> </span><span class="nc">GradShafranovSolver</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Numerical solver for Grad-Shafranov equation&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R_min</span><span class="p">,</span> <span class="n">R_max</span><span class="p">,</span> <span class="n">Z_min</span><span class="p">,</span> <span class="n">Z_max</span><span class="p">,</span> <span class="n">nR</span><span class="p">,</span> <span class="n">nZ</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up computational domain</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_min</span> <span class="o">=</span> <span class="n">R_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_max</span> <span class="o">=</span> <span class="n">R_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z_min</span> <span class="o">=</span> <span class="n">Z_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z_max</span> <span class="o">=</span> <span class="n">Z_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nR</span> <span class="o">=</span> <span class="n">nR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nZ</span> <span class="o">=</span> <span class="n">nZ</span>

        <span class="c1"># Grid spacing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">=</span> <span class="p">(</span><span class="n">R_max</span> <span class="o">-</span> <span class="n">R_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nR</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dZ</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z_max</span> <span class="o">-</span> <span class="n">Z_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">R_min</span><span class="p">,</span> <span class="n">R_max</span><span class="p">,</span> <span class="n">nR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">Z_min</span><span class="p">,</span> <span class="n">Z_max</span><span class="p">,</span> <span class="n">nZ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>

        <span class="c1"># Initialize flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nZ</span><span class="p">,</span> <span class="n">nR</span><span class="p">))</span>

        <span class="c1"># Constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1e-7</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_free_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_func</span><span class="p">,</span> <span class="n">F_func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set pressure and toroidal field functions</span>
<span class="sd">        p_func: p(psi) callable</span>
<span class="sd">        F_func: F(psi) callable where F = R*B_phi</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span> <span class="o">=</span> <span class="n">p_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F_func</span> <span class="o">=</span> <span class="n">F_func</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_operator_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build discrete Grad-Shafranov operator matrix</span>
<span class="sd">        Δ* ψ = R ∂/∂R(1/R ∂ψ/∂R) + ∂²ψ/∂Z²</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nR</span>
        <span class="n">nZ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nZ</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">nR</span> <span class="o">*</span> <span class="n">nZ</span>

        <span class="c1"># Flatten index: (i,j) -&gt; i*nR + j</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">idx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">i</span> <span class="o">*</span> <span class="n">nR</span> <span class="o">+</span> <span class="n">j</span>

        <span class="c1"># Build sparse matrix</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nZ</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nR</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">idx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

                <span class="c1"># Interior points</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nZ</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nR</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># R derivatives: R ∂/∂R(1/R ∂ψ/∂R)</span>
                    <span class="c1"># = ∂²ψ/∂R² + (1/R)∂ψ/∂R - (ψ/R²)</span>
                    <span class="c1"># Discretize: centered differences</span>

                    <span class="c1"># ∂²ψ/∂R²</span>
                    <span class="n">coef_R_pp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dR</span><span class="o">**</span><span class="mi">2</span>
                    <span class="n">coef_R_0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dR</span><span class="o">**</span><span class="mi">2</span>
                    <span class="n">coef_R_mm</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dR</span><span class="o">**</span><span class="mi">2</span>

                    <span class="c1"># (1/R)∂ψ/∂R</span>
                    <span class="n">coef_R_p_1st</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">R</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dR</span><span class="p">)</span>
                    <span class="n">coef_R_m_1st</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">R</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dR</span><span class="p">)</span>

                    <span class="c1"># Z derivatives: ∂²ψ/∂Z²</span>
                    <span class="n">coef_Z_pp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dZ</span><span class="o">**</span><span class="mi">2</span>
                    <span class="n">coef_Z_0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dZ</span><span class="o">**</span><span class="mi">2</span>
                    <span class="n">coef_Z_mm</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dZ</span><span class="o">**</span><span class="mi">2</span>

                    <span class="c1"># Combine</span>
                    <span class="c1"># Center</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coef_R_0</span> <span class="o">+</span> <span class="n">coef_Z_0</span><span class="p">)</span>

                    <span class="c1"># R+1</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coef_R_pp</span> <span class="o">+</span> <span class="n">coef_R_p_1st</span><span class="p">)</span>

                    <span class="c1"># R-1</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coef_R_mm</span> <span class="o">+</span> <span class="n">coef_R_m_1st</span><span class="p">)</span>

                    <span class="c1"># Z+1</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coef_Z_pp</span><span class="p">)</span>

                    <span class="c1"># Z-1</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coef_Z_mm</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Boundary: ψ = 0</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">matrix</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">matrix</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solve_fixed_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psi_boundary</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve Grad-Shafranov with fixed boundary using Picard iteration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nR</span>
        <span class="n">nZ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nZ</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">nR</span> <span class="o">*</span> <span class="n">nZ</span>

        <span class="c1"># Build operator matrix (constant for linear problem)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_operator_matrix</span><span class="p">()</span>

        <span class="c1"># Picard iteration</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
            <span class="n">psi_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Compute RHS: -μ₀ R² dp/dψ - F dF/dψ</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nZ</span><span class="p">,</span> <span class="n">nR</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nZ</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nR</span><span class="p">):</span>
                    <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">psi_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                    <span class="c1"># Numerical derivatives of p and F</span>
                    <span class="n">dpsi</span> <span class="o">=</span> <span class="mf">1e-6</span>
                    <span class="n">dpdpsi</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">psi_val</span> <span class="o">+</span> <span class="n">dpsi</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">psi_val</span> <span class="o">-</span> <span class="n">dpsi</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dpsi</span><span class="p">)</span>

                    <span class="n">F_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_func</span><span class="p">(</span><span class="n">psi_val</span><span class="p">)</span>
                    <span class="n">dFdpsi</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F_func</span><span class="p">(</span><span class="n">psi_val</span> <span class="o">+</span> <span class="n">dpsi</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_func</span><span class="p">(</span><span class="n">psi_val</span> <span class="o">-</span> <span class="n">dpsi</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dpsi</span><span class="p">)</span>

                    <span class="n">rhs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mu0</span> <span class="o">*</span> <span class="n">R</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dpdpsi</span> <span class="o">-</span> <span class="n">F_val</span> <span class="o">*</span> <span class="n">dFdpsi</span>

            <span class="c1"># Apply boundary conditions</span>
            <span class="n">rhs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">psi_boundary</span>
            <span class="n">rhs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">psi_boundary</span>
            <span class="n">rhs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi_boundary</span>
            <span class="n">rhs</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi_boundary</span>

            <span class="c1"># Solve linear system</span>
            <span class="n">rhs_flat</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">psi_flat</span> <span class="o">=</span> <span class="n">spsolve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">rhs_flat</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi</span> <span class="o">=</span> <span class="n">psi_flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nZ</span><span class="p">,</span> <span class="n">nR</span><span class="p">))</span>

            <span class="c1"># Check convergence</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi</span> <span class="o">-</span> <span class="n">psi_old</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">: max error = </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converged in </span><span class="si">{</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> iterations&quot;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the computed equilibrium&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="c1"># Flux surfaces</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">CS</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;R [m]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Z [m]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Poloidal Flux Surfaces&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Pressure profile</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">psi_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">psi_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">psi_flat</span><span class="p">)</span>
        <span class="n">psi_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">psi_flat</span><span class="p">)</span>
        <span class="n">psi_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">psi_min</span><span class="p">,</span> <span class="n">psi_max</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">p_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span> <span class="k">for</span> <span class="n">psi</span> <span class="ow">in</span> <span class="n">psi_range</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">psi_range</span><span class="p">,</span> <span class="n">p_range</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;ψ [Wb]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pressure [kPa]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pressure Profile p(ψ)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Example: solve simple equilibrium</span>
<span class="k">def</span><span class="w"> </span><span class="nf">example_gs_solver</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Example Grad-Shafranov solution&quot;&quot;&quot;</span>

    <span class="c1"># Domain: tokamak-like geometry</span>
    <span class="n">R0</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Major radius</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.3</span>   <span class="c1"># Minor radius</span>

    <span class="n">R_min</span> <span class="o">=</span> <span class="n">R0</span> <span class="o">-</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">a</span>
    <span class="n">R_max</span> <span class="o">=</span> <span class="n">R0</span> <span class="o">+</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">a</span>
    <span class="n">Z_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5</span><span class="o">*</span><span class="n">a</span>
    <span class="n">Z_max</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">a</span>

    <span class="n">nR</span> <span class="o">=</span> <span class="mi">80</span>
    <span class="n">nZ</span> <span class="o">=</span> <span class="mi">80</span>

    <span class="n">solver</span> <span class="o">=</span> <span class="n">GradShafranovSolver</span><span class="p">(</span><span class="n">R_min</span><span class="p">,</span> <span class="n">R_max</span><span class="p">,</span> <span class="n">Z_min</span><span class="p">,</span> <span class="n">Z_max</span><span class="p">,</span> <span class="n">nR</span><span class="p">,</span> <span class="n">nZ</span><span class="p">)</span>

    <span class="c1"># Define free functions</span>
    <span class="c1"># Simple parabolic pressure</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="mf">1e5</span>  <span class="c1"># 100 kPa</span>
    <span class="n">psi0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">p_func</span><span class="p">(</span><span class="n">psi</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">psi</span> <span class="o">&gt;</span> <span class="n">psi0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">psi</span><span class="o">/</span><span class="n">psi0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1"># Constant F (uniform toroidal field)</span>
    <span class="n">Bt0</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># Tesla</span>
    <span class="n">F0</span> <span class="o">=</span> <span class="n">Bt0</span> <span class="o">*</span> <span class="n">R0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">F_func</span><span class="p">(</span><span class="n">psi</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">F0</span>

    <span class="n">solver</span><span class="o">.</span><span class="n">set_free_functions</span><span class="p">(</span><span class="n">p_func</span><span class="p">,</span> <span class="n">F_func</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Grad-Shafranov Solver ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid: </span><span class="si">{</span><span class="n">nR</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">nZ</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Domain: R ∈ [</span><span class="si">{</span><span class="n">R_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">R_max</span><span class="si">}</span><span class="s2">], Z ∈ [</span><span class="si">{</span><span class="n">Z_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">Z_max</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Central pressure: </span><span class="si">{</span><span class="n">p0</span><span class="o">/</span><span class="mf">1e3</span><span class="si">}</span><span class="s2"> kPa&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Toroidal field: </span><span class="si">{</span><span class="n">Bt0</span><span class="si">}</span><span class="s2"> T&quot;</span><span class="p">)</span>

    <span class="c1"># Solve</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve_fixed_boundary</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>

    <span class="c1"># Plot</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">plot_solution</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/tmp/gs_solution.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Solution plot saved to /tmp/gs_solution.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">example_gs_solver</span><span class="p">()</span>
</code></pre></div>

<h2 id="10">10. 베타 계산<a class="header-link" href="#10" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compute_beta</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">p_profile</span><span class="p">,</span> <span class="n">B_profiles</span><span class="p">,</span> <span class="n">nr</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute various beta values for a tokamak equilibrium</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    R0: major radius [m]</span>
<span class="sd">    a: minor radius [m]</span>
<span class="sd">    p_profile: function p(r) giving pressure profile</span>
<span class="sd">    B_profiles: dict with &#39;Bt&#39;, &#39;Bp&#39; functions of r</span>
<span class="sd">    nr: number of radial points</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dict with beta_p, beta_t, beta_N</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">nr</span><span class="p">)</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Volume element in torus: dV = 2π R₀ · 2πr dr</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">volume_element</span><span class="p">(</span><span class="n">r_val</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">R0</span> <span class="o">*</span> <span class="n">r_val</span> <span class="o">*</span> <span class="n">dr</span>

    <span class="c1"># Compute volume-averaged quantities</span>
    <span class="n">p_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p_profile</span><span class="p">(</span><span class="n">r_val</span><span class="p">)</span> <span class="k">for</span> <span class="n">r_val</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>
    <span class="n">Bt_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">B_profiles</span><span class="p">[</span><span class="s1">&#39;Bt&#39;</span><span class="p">](</span><span class="n">r_val</span><span class="p">)</span> <span class="k">for</span> <span class="n">r_val</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>
    <span class="n">Bp_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">B_profiles</span><span class="p">[</span><span class="s1">&#39;Bp&#39;</span><span class="p">](</span><span class="n">r_val</span><span class="p">)</span> <span class="k">for</span> <span class="n">r_val</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>

    <span class="c1"># Volume integrals</span>
    <span class="n">V_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">volume_element</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr</span><span class="p">)])</span>

    <span class="n">p_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">p_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">volume_element</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr</span><span class="p">)])</span> <span class="o">/</span> <span class="n">V_total</span>

    <span class="n">Bt2_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">Bt_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">volume_element</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr</span><span class="p">)])</span> <span class="o">/</span> <span class="n">V_total</span>
    <span class="n">Bp2_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">Bp_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">volume_element</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr</span><span class="p">)])</span> <span class="o">/</span> <span class="n">V_total</span>

    <span class="n">mu0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1e-7</span>

    <span class="c1"># Poloidal beta</span>
    <span class="n">beta_p</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu0</span> <span class="o">*</span> <span class="n">p_avg</span> <span class="o">/</span> <span class="n">Bp2_avg</span>

    <span class="c1"># Toroidal beta</span>
    <span class="n">beta_t</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu0</span> <span class="o">*</span> <span class="n">p_avg</span> <span class="o">/</span> <span class="n">Bt2_avg</span>

    <span class="c1"># For beta_N, need plasma current</span>
    <span class="c1"># I_p = ∮ J·dl ~ B_p * circumference / μ₀</span>
    <span class="n">Bp_edge</span> <span class="o">=</span> <span class="n">Bp_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Ip</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">Bp_edge</span> <span class="o">/</span> <span class="n">mu0</span>

    <span class="c1"># Troyon normalized beta</span>
    <span class="n">Bt_axis</span> <span class="o">=</span> <span class="n">Bt_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">beta_N</span> <span class="o">=</span> <span class="n">beta_t</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="n">Ip</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">Bt_axis</span><span class="p">))</span>  <span class="c1"># percentage</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;beta_p&#39;</span><span class="p">:</span> <span class="n">beta_p</span><span class="p">,</span>
        <span class="s1">&#39;beta_t&#39;</span><span class="p">:</span> <span class="n">beta_t</span><span class="p">,</span>
        <span class="s1">&#39;beta_N&#39;</span><span class="p">:</span> <span class="n">beta_N</span><span class="p">,</span>
        <span class="s1">&#39;p_avg&#39;</span><span class="p">:</span> <span class="n">p_avg</span><span class="p">,</span>
        <span class="s1">&#39;Ip&#39;</span><span class="p">:</span> <span class="n">Ip</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="k">def</span><span class="w"> </span><span class="nf">example_beta_calculation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Example beta calculation for tokamak&quot;&quot;&quot;</span>

    <span class="c1"># ITER-like parameters</span>
    <span class="n">R0</span> <span class="o">=</span> <span class="mf">6.2</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span>

    <span class="c1"># Parabolic pressure profile</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="mf">5e5</span>  <span class="c1"># 500 kPa</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">p_profile</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1"># Magnetic field profiles</span>
    <span class="n">Bt0</span> <span class="o">=</span> <span class="mf">5.3</span>  <span class="c1"># On-axis toroidal field</span>
    <span class="n">Ip</span> <span class="o">=</span> <span class="mf">15e6</span>  <span class="c1"># Plasma current</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Bt_profile</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Bt0</span> <span class="o">*</span> <span class="n">R0</span> <span class="o">/</span> <span class="p">(</span><span class="n">R0</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span>  <span class="c1"># 1/R dependence</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Bp_profile</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="n">mu0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1e-7</span>
        <span class="c1"># From Ampere&#39;s law, current ~ r² profile</span>
        <span class="n">I_enclosed</span> <span class="o">=</span> <span class="n">Ip</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">mu0</span> <span class="o">*</span> <span class="n">I_enclosed</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="n">B_profiles</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Bt&#39;</span><span class="p">:</span> <span class="n">Bt_profile</span><span class="p">,</span>
        <span class="s1">&#39;Bp&#39;</span><span class="p">:</span> <span class="n">Bp_profile</span>
    <span class="p">}</span>

    <span class="c1"># Compute betas</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">compute_beta</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">p_profile</span><span class="p">,</span> <span class="n">B_profiles</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Beta Calculation ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Major radius R0 = </span><span class="si">{</span><span class="n">R0</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Minor radius a = </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Central pressure p0 = </span><span class="si">{</span><span class="n">p0</span><span class="o">/</span><span class="mf">1e3</span><span class="si">}</span><span class="s2"> kPa&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Toroidal field Bt0 = </span><span class="si">{</span><span class="n">Bt0</span><span class="si">}</span><span class="s2"> T&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plasma current Ip = </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;Ip&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MA&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Average pressure &lt;p&gt; = </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;p_avg&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e3</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> kPa&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Poloidal beta β_p = </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;beta_p&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Toroidal beta β_t = </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;beta_t&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> %&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normalized beta β_N = </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;beta_N&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Troyon limit check</span>
    <span class="n">beta_N_limit</span> <span class="o">=</span> <span class="mf">3.5</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Troyon limit β_N &lt; </span><span class="si">{</span><span class="n">beta_N_limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;beta_N&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">beta_N_limit</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Within stability limit&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✗ Exceeds stability limit!&quot;</span><span class="p">)</span>

    <span class="c1"># Plot profiles</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p_profile</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>
    <span class="n">Bt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Bt_profile</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>
    <span class="n">Bp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Bp_profile</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Pressure</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pressure [kPa]&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pressure Profile&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Toroidal field</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">Bt</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;B_t [T]&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Toroidal Field&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Poloidal field</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">Bp</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;B_p [T]&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Poloidal Field&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Local beta</span>
    <span class="n">beta_local</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1e-7</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">Bt</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Bp</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="n">beta_local</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;m-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r/a&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;β [%]&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Local Beta Profile&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/tmp/beta_profiles.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Profiles plot saved to /tmp/beta_profiles.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">example_beta_calculation</span><span class="p">()</span>
</code></pre></div>

<h2 id="_2">요약<a class="header-link" href="#_2" title="Permanent link">&para;</a></h2>
<p>이 강의에서 MHD 평형의 기초를 다루었습니다:</p>
<ol>
<li>
<p><strong>힘 균형</strong>: 기본 방정식 $\nabla p = \mathbf{J}\times\mathbf{B}$가 플라즈마 압력 구배와 자기력 (압력 + 장력)의 균형을 맞춥니다.</p>
</li>
<li>
<p><strong>결과</strong>: 압력과 전류는 자기 플럭스 표면 위에 놓이며, 플럭스 표면 좌표계를 가능하게 합니다.</p>
</li>
<li>
<p><strong>1차원 평형</strong>: θ-pinch (순수 축방향 장), Z-pinch (자체 생성 방위각 장, Bennett 관계), screw pinch (전단을 가진 결합 장).</p>
</li>
<li>
<p><strong>Grad-Shafranov 방정식</strong>: 두 개의 자유 함수 $p(\psi)$와 $F(\psi)$ 지정이 필요한 축대칭 토로이달 평형을 지배하는 타원형 PDE.</p>
</li>
<li>
<p><strong>안전 인자</strong>: 자기장선 피치를 측정하는 매개변수 $q$, 안정성 분석에 중요 (Kruskal-Shafranov 한계, 유리수 표면).</p>
</li>
<li>
<p><strong>플럭스 표면</strong>: 압력이 일정한 중첩된 토로이달 표면, 토로이달 효과로 인한 Shafranov 이동.</p>
</li>
<li>
<p><strong>플라즈마 베타</strong>: 플라즈마 대 자기 압력의 비율, MHD 안정성이 설정한 운영 한계 (Troyon 한계).</p>
</li>
<li>
<p><strong>수치적 방법</strong>: 유한 차분과 반복 기법을 사용한 평형 솔버 구현.</p>
</li>
</ol>
<p>이러한 평형 개념은 플라즈마 안정성 (다음 강의), 수송, 그리고 핵융합 장치의 가둠을 이해하는 기초를 형성합니다.</p>
<h2 id="_3">연습 문제<a class="header-link" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="1">문제 1: 원통형 플라즈마에서의 힘 균형<a class="header-link" href="#1" title="Permanent link">&para;</a></h3>
<p>원통형 플라즈마 기둥이 다음 프로파일을 가집니다:
- 압력: $p(r) = p_0(1 - r^2/a^2)$ for $r < a$, $p=0$ for $r \geq a$
- 축방향 장: $B_z = B_0 = \text{const}$
- 방위각 장: $B_θ(r)$ 결정 필요</p>
<p><strong>(a)</strong> 방사상 힘 균형 방정식을 사용하여 $B_θ(r)$을 유도하세요.</p>
<p><strong>(b)</strong> 총 플라즈마 전류 $I_p$를 계산하세요.</p>
<p><strong>(c)</strong> 주요 반지름 $R_0 = 5a$를 가정하고 안전 인자 $q(r)$을 계산하세요.</p>
<p><strong>(d)</strong> 자기 축 ($r=0$)에서 $q$는 무엇입니까?</p>
<p><strong>힌트</strong>: 원통 좌표계에서 $\nabla p = \mathbf{J}\times\mathbf{B}$를 사용하세요.</p>
<h3 id="2-z-pinch-bennett">문제 2: Z-Pinch에 대한 Bennett 관계<a class="header-link" href="#2-z-pinch-bennett" title="Permanent link">&para;</a></h3>
<p>Z-pinch가 균일한 밀도 $n = 10^{20}$ m$^{-3}$, 온도 $T = 10$ keV, 길이 $L = 1$ m, 반지름 $a = 1$ cm를 가집니다.</p>
<p><strong>(a)</strong> 총 입자 수 $N = n \pi a^2 L$을 계산하세요.</p>
<p><strong>(b)</strong> Bennett 관계 $I^2 = (8\pi/\mu_0)NkT$를 사용하여 필요한 전류 $I_p$를 계산하세요.</p>
<p><strong>(c)</strong> 표면에서 자기장 $B_θ(a) = \mu_0 I_p/(2\pi a)$를 추정하세요.</p>
<p><strong>(d)</strong> 자기 압력 $B_θ^2/(2\mu_0)$를 계산하고 플라즈마 압력 $p = nkT$와 비교하세요.</p>
<p><strong>(e)</strong> 이 구성의 안정성 함의를 논의하세요.</p>
<h3 id="3-grad-shafranov">문제 3: 일정 압력을 가진 Grad-Shafranov<a class="header-link" href="#3-grad-shafranov" title="Permanent link">&para;</a></h3>
<p>다음을 가진 Grad-Shafranov 방정식을 고려하세요:
- $p(\psi) = p_0 = \text{const}$
- $F(\psi) = F_0 = \text{const}$</p>
<p><strong>(a)</strong> 방정식이 다음으로 축약됨을 보이세요:
$$
\Delta^*\psi = -\mu_0 p_0 R^2
$$</p>
<p><strong>(b)</strong> 큰 종횡비 원형 토카막 ($R \approx R_0$)에 대해 다음과 같이 근사하세요:
$$
\frac{1}{r}\frac{d}{dr}\left(r\frac{d\psi}{dr}\right) + \frac{d^2\psi}{dz^2} \approx -\mu_0 p_0 R_0^2
$$</p>
<p><strong>(c)</strong> 분리 가능한 해 $\psi(r,z) = R_r(r)Z_z(z)$를 제안하고 $R_r$과 $Z_z$에 대한 ODE를 유도하세요.</p>
<p><strong>(d)</strong> 원형 플럭스 표면 $\psi \propto r^2 + \kappa^2 z^2$에 대해 풀고 $\kappa$ (늘림)를 결정하세요.</p>
<h3 id="4">문제 4: 안전 인자와 전류 프로파일<a class="header-link" href="#4" title="Permanent link">&para;</a></h3>
<p>토카막이 주요 반지름 $R_0 = 3$ m, 소반지름 $a = 1$ m, 토로이달 장 $B_t = 5$ T (거의 일정)를 가집니다. 전류 밀도 프로파일은:</p>
<p>$$
J_z(r) = J_0\left(1 - \frac{r^2}{a^2}\right)
$$</p>
<p><strong>(a)</strong> 둘러싸인 전류 $I(r) = \int_0^r J_z(r') 2\pi r' dr'$를 계산하세요.</p>
<p><strong>(b)</strong> 앙페르 법칙을 사용하여 $B_θ(r) = \mu_0 I(r)/(2\pi r)$를 구하세요.</p>
<p><strong>(c)</strong> 안전 인자 프로파일 $q(r) = rB_t/(R_0 B_θ(r))$를 계산하세요.</p>
<p><strong>(d)</strong> $q(0)$ (축 상)과 $q(a)$ (가장자리)를 결정하세요.</p>
<p><strong>(e)</strong> $q(r_s) = 2$ ($m=2$ 유리수 표면)인 반지름 $r_s$를 구하세요.</p>
<p><strong>(f)</strong> $q(r)$을 플롯하고 안정성 관련 특징을 식별하세요.</p>
<h3 id="5">문제 5: 베타 한계<a class="header-link" href="#5" title="Permanent link">&para;</a></h3>
<p>실험 토카막이 다음으로 작동합니다:
- 소반지름 $a = 0.5$ m
- 토로이달 장 $B_t = 3$ T
- 플라즈마 전류 $I_p = 1$ MA
- 중심 압력 $p_0 = 10^5$ Pa
- 압력 프로파일 $p(r) = p_0(1 - r^2/a^2)^2$</p>
<p><strong>(a)</strong> 체적 평균 압력 $\langle p\rangle$을 계산하세요.</p>
<p><strong>(b)</strong> 토로이달 베타 $\beta_t = 2\mu_0\langle p\rangle/B_t^2$를 계산하세요.</p>
<p><strong>(c)</strong> 정규화된 베타 $\beta_N = \beta_t(\%)/(I_p[MA]/(a[m]B_t[T]))$를 계산하세요.</p>
<p><strong>(d)</strong> $\beta_N$을 Troyon 한계 $\beta_N < 3.5$와 비교하세요.</p>
<p><strong>(e)</strong> 실험이 압력을 두 배로 하려면 안정성을 유지하기 위해 $I_p$ 또는 $B_t$에 어떤 조정이 필요합니까?</p>
<p><strong>힌트</strong>: 원통에서 체적 평균: $\langle p\rangle = \frac{\int_0^a p(r) 2\pi r dr}{\pi a^2}$.</p>
<hr />
<p><strong>이전</strong>: <a href="./00_Overview.md">Overview</a> | <strong>다음</strong>: <a href="./02_Linear_Stability.md">Linear Stability</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/MHD/00_Overview.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">자기유체역학 (MHD)</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">🔗</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/MHD/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">📋</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/MHD/02_Linear_Stability.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">2. 선형 안정성 이론</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">↑</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'ko';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}