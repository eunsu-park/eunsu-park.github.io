{% raw %}
<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>16. ë³µì œì™€ ê³ ê°€ìš©ì„± (Replication & High Availability) - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/ko/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/ko/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/ko/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" >
                        English
                    </option>
                    
                    <option value="ko" selected>
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/ko/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/ko/PostgreSQL/">PostgreSQL</a>
    <span class="separator">/</span>
    <span class="current">16. ë³µì œì™€ ê³ ê°€ìš©ì„± (Replication & High Availability)</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>16. ë³µì œì™€ ê³ ê°€ìš©ì„± (Replication & High Availability)</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/PostgreSQL/15_Query_Optimization.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">15. PostgreSQL ì¿¼ë¦¬ ìµœì í™” ì‹¬í™”</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/PostgreSQL/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/PostgreSQL/17_Window_Functions.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">17. ìœˆë„ìš° í•¨ìˆ˜ì™€ ë¶„ì„ ì¿¼ë¦¬ (Window Functions & Analytics)</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#_1">í•™ìŠµ ëª©í‘œ</a></li>
<li><a href="#_2">ëª©ì°¨</a></li>
<li><a href="#1">1. ë³µì œ ê°œìš”</a><ul>
<li><a href="#11">1.1 ë³µì œì˜ ëª©ì </a></li>
<li><a href="#12">1.2 ë³µì œ ì¢…ë¥˜ ë¹„êµ</a></li>
<li><a href="#13-wal-write-ahead-logging">1.3 WAL (Write-Ahead Logging) ê¸°ì´ˆ</a></li>
</ul>
</li>
<li><a href="#2">2. ë¬¼ë¦¬ì  ë³µì œ (ìŠ¤íŠ¸ë¦¬ë° ë³µì œ)</a><ul>
<li><a href="#21">2.1 ì•„í‚¤í…ì²˜</a></li>
<li><a href="#22-primary">2.2 Primary ì„œë²„ ì„¤ì •</a></li>
<li><a href="#23-standby">2.3 Standby ì„œë²„ ì„¤ì •</a></li>
<li><a href="#24-vs">2.4 ë™ê¸° vs ë¹„ë™ê¸° ë³µì œ</a></li>
<li><a href="#25">2.5 ìºìŠ¤ì¼€ì´ë”© ë³µì œ</a></li>
</ul>
</li>
<li><a href="#3">3. ë…¼ë¦¬ì  ë³µì œ</a><ul>
<li><a href="#31">3.1 ë…¼ë¦¬ì  ë³µì œ ê°œìš”</a></li>
<li><a href="#32-publisher">3.2 Publisher ì„¤ì •</a></li>
<li><a href="#33-subscriber">3.3 Subscriber ì„¤ì •</a></li>
<li><a href="#34">3.4 ë…¼ë¦¬ì  ë³µì œ ì‚¬ìš© ì‚¬ë¡€</a></li>
<li><a href="#35">3.5 ì¶©ëŒ ì²˜ë¦¬</a></li>
</ul>
</li>
<li><a href="#4">4. ë³µì œ ëª¨ë‹ˆí„°ë§</a><ul>
<li><a href="#41">4.1 ë³µì œ ìƒíƒœ í™•ì¸</a></li>
<li><a href="#42">4.2 ë³µì œ ìŠ¬ë¡¯ ëª¨ë‹ˆí„°ë§</a></li>
<li><a href="#43">4.3 ëª¨ë‹ˆí„°ë§ ë·° ìƒì„±</a></li>
</ul>
</li>
<li><a href="#5">5. í˜ì¼ì˜¤ë²„ì™€ ìŠ¤ìœ„ì¹˜ì˜¤ë²„</a><ul>
<li><a href="#51">5.1 ê°œë… ì •ë¦¬</a></li>
<li><a href="#52">5.2 ìˆ˜ë™ í˜ì¼ì˜¤ë²„</a></li>
<li><a href="#53-pg_rewind-primary">5.3 pg_rewindë¥¼ ì‚¬ìš©í•œ ì´ì „ Primary ë³µêµ¬</a></li>
<li><a href="#54">5.4 ìë™ í˜ì¼ì˜¤ë²„ ìŠ¤í¬ë¦½íŠ¸ ì˜ˆì‹œ</a></li>
</ul>
</li>
<li><a href="#6">6. ê³ ê°€ìš©ì„± ì†”ë£¨ì…˜</a><ul>
<li><a href="#61-patroni">6.1 Patroni</a></li>
<li><a href="#62">6.2 ê³ ê°€ìš©ì„± ì•„í‚¤í…ì²˜</a></li>
<li><a href="#63-haproxy">6.3 HAProxy ì„¤ì •</a></li>
<li><a href="#64-pgbouncer">6.4 PgBouncerì™€ ì—°ë™</a></li>
<li><a href="#65">6.5 í´ë¼ìš°ë“œ í™˜ê²½ ê³ ê°€ìš©ì„±</a></li>
</ul>
</li>
<li><a href="#7">7. ì—°ìŠµ ë¬¸ì œ</a><ul>
<li><a href="#1_1">ì—°ìŠµ 1: ìŠ¤íŠ¸ë¦¬ë° ë³µì œ êµ¬ì„±</a></li>
<li><a href="#2_1">ì—°ìŠµ 2: ë…¼ë¦¬ ë³µì œ ì„¤ì •</a></li>
<li><a href="#3_1">ì—°ìŠµ 3: ë³µì œ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</a></li>
</ul>
</li>
<li><a href="#_3">ë‹¤ìŒ ë‹¨ê³„</a></li>
<li><a href="#_4">ì°¸ê³  ìë£Œ</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="16-replication-high-availability">16. ë³µì œì™€ ê³ ê°€ìš©ì„± (Replication &amp; High Availability)<a class="header-link" href="#16-replication-high-availability" title="Permanent link">&para;</a></h1>
<h2 id="_1">í•™ìŠµ ëª©í‘œ<a class="header-link" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li>PostgreSQL ë³µì œ ì•„í‚¤í…ì²˜ì™€ ì¢…ë¥˜ ì´í•´</li>
<li>ìŠ¤íŠ¸ë¦¬ë° ë³µì œ êµ¬ì„± ë° ê´€ë¦¬</li>
<li>ë…¼ë¦¬ ë³µì œë¥¼ í™œìš©í•œ ì„ íƒì  ë°ì´í„° ë³µì œ</li>
<li>í˜ì¼ì˜¤ë²„ ì „ëµê³¼ ìë™í™” êµ¬í˜„</li>
<li>ê³ ê°€ìš©ì„± í´ëŸ¬ìŠ¤í„° ì„¤ê³„</li>
</ul>
<h2 id="_2">ëª©ì°¨<a class="header-link" href="#_2" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-ë³µì œ-ê°œìš”">ë³µì œ ê°œìš”</a></li>
<li><a href="#2-ë¬¼ë¦¬ì -ë³µì œ-ìŠ¤íŠ¸ë¦¬ë°-ë³µì œ">ë¬¼ë¦¬ì  ë³µì œ (ìŠ¤íŠ¸ë¦¬ë° ë³µì œ)</a></li>
<li><a href="#3-ë…¼ë¦¬ì -ë³µì œ">ë…¼ë¦¬ì  ë³µì œ</a></li>
<li><a href="#4-ë³µì œ-ëª¨ë‹ˆí„°ë§">ë³µì œ ëª¨ë‹ˆí„°ë§</a></li>
<li><a href="#5-í˜ì¼ì˜¤ë²„ì™€-ìŠ¤ìœ„ì¹˜ì˜¤ë²„">í˜ì¼ì˜¤ë²„ì™€ ìŠ¤ìœ„ì¹˜ì˜¤ë²„</a></li>
<li><a href="#6-ê³ ê°€ìš©ì„±-ì†”ë£¨ì…˜">ê³ ê°€ìš©ì„± ì†”ë£¨ì…˜</a></li>
<li><a href="#7-ì—°ìŠµ-ë¬¸ì œ">ì—°ìŠµ ë¬¸ì œ</a></li>
</ol>
<hr />
<h2 id="1">1. ë³µì œ ê°œìš”<a class="header-link" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 ë³µì œì˜ ëª©ì <a class="header-link" href="#11" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ë³µì œ ëª©ì                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ê³ ê°€ìš©ì„± (HA)   â”‚ ì¥ì•  ì‹œ ìë™/ìˆ˜ë™ í˜ì¼ì˜¤ë²„ë¡œ ë‹¤ìš´íƒ€ì„ ìµœì†Œí™”      â”‚
â”‚ ì½ê¸° í™•ì¥       â”‚ ì½ê¸° ì¿¼ë¦¬ë¥¼ ìŠ¤íƒ ë°”ì´ë¡œ ë¶„ì‚°                      â”‚
â”‚ ì¬í•´ ë³µêµ¬ (DR)  â”‚ ì§€ë¦¬ì ìœ¼ë¡œ ë¶„ì‚°ëœ ë³µì œë³¸ìœ¼ë¡œ ì¬í•´ ëŒ€ë¹„           â”‚
â”‚ ë°±ì—…            â”‚ ìŠ¤íƒ ë°”ì´ì—ì„œ ë°±ì—… ìˆ˜í–‰, ìš´ì˜ ë¶€í•˜ ê°ì†Œ           â”‚
â”‚ ë°ì´í„° ë¶„ì„     â”‚ ë³µì œë³¸ì—ì„œ ë¬´ê±°ìš´ ë¶„ì„ ì¿¼ë¦¬ ì‹¤í–‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="12">1.2 ë³µì œ ì¢…ë¥˜ ë¹„êµ<a class="header-link" href="#12" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                â”‚   ë¬¼ë¦¬ì  ë³µì œ        â”‚   ë…¼ë¦¬ì  ë³µì œ        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ë³µì œ ë‹¨ìœ„      â”‚ ë°”ì´íŠ¸ ë ˆë²¨ (WAL)   â”‚ í–‰ ë‹¨ìœ„ ë³€ê²½ì‚¬í•­     â”‚
â”‚ ë³µì œ ëŒ€ìƒ      â”‚ ì „ì²´ í´ëŸ¬ìŠ¤í„°       â”‚ ì„ íƒì  (í…Œì´ë¸”)      â”‚
â”‚ ë²„ì „ í˜¸í™˜      â”‚ ë™ì¼ ë©”ì´ì € ë²„ì „    â”‚ ë‹¤ë¥¸ ë²„ì „ ê°€ëŠ¥       â”‚
â”‚ ìŠ¤íƒ ë°”ì´ ì¿¼ë¦¬  â”‚ ì½ê¸° ì „ìš©           â”‚ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥       â”‚
â”‚ ì„¤ì • ë³µì¡ë„   â”‚ ê°„ë‹¨                â”‚ ì¤‘ê°„                 â”‚
â”‚ ìš©ë„          â”‚ HA, ì½ê¸° í™•ì¥       â”‚ ë§ˆì´ê·¸ë ˆì´ì…˜, í†µí•©   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="13-wal-write-ahead-logging">1.3 WAL (Write-Ahead Logging) ê¸°ì´ˆ<a class="header-link" href="#13-wal-write-ahead-logging" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- WAL ì„¤ì • í™•ì¸</span>
<span class="k">SHOW</span><span class="w"> </span><span class="n">wal_level</span><span class="p">;</span><span class="w">           </span><span class="c1">-- replica ë˜ëŠ” logical</span>
<span class="k">SHOW</span><span class="w"> </span><span class="n">max_wal_senders</span><span class="p">;</span><span class="w">     </span><span class="c1">-- WAL ì†¡ì‹  í”„ë¡œì„¸ìŠ¤ ìˆ˜</span>
<span class="k">SHOW</span><span class="w"> </span><span class="n">max_replication_slots</span><span class="p">;</span>
<span class="k">SHOW</span><span class="w"> </span><span class="n">wal_keep_size</span><span class="p">;</span><span class="w">       </span><span class="c1">-- WAL ë³´ê´€ í¬ê¸°</span>

<span class="c1">-- WAL ìœ„ì¹˜ í™•ì¸</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">pg_current_wal_lsn</span><span class="p">();</span><span class="w">           </span><span class="c1">-- í˜„ì¬ WAL ìœ„ì¹˜</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">pg_walfile_name</span><span class="p">(</span><span class="n">pg_current_wal_lsn</span><span class="p">());</span><span class="w">  </span><span class="c1">-- WAL íŒŒì¼ëª…</span>
</code></pre></div>

<hr />
<h2 id="2">2. ë¬¼ë¦¬ì  ë³µì œ (ìŠ¤íŠ¸ë¦¬ë° ë³µì œ)<a class="header-link" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 ì•„í‚¤í…ì²˜<a class="header-link" href="#21" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ìŠ¤íŠ¸ë¦¬ë° ë³µì œ ì•„í‚¤í…ì²˜                          â”‚
â”‚                                                                 â”‚
â”‚   Primary                           Standby                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚             â”‚    WAL Stream     â”‚             â”‚           â”‚
â”‚   â”‚  PostgreSQL â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  PostgreSQL â”‚           â”‚
â”‚   â”‚   (R/W)     â”‚                   â”‚   (R/O)     â”‚           â”‚
â”‚   â”‚             â”‚                   â”‚             â”‚           â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚           â”‚
â”‚   â”‚ â”‚wal_senderâ”‚â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”‚wal_recv â”‚ â”‚           â”‚
â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                 â”‚
â”‚   [ë™ê¸°/ë¹„ë™ê¸° ì„ íƒ ê°€ëŠ¥]                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="22-primary">2.2 Primary ì„œë²„ ì„¤ì •<a class="header-link" href="#22-primary" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># postgresql.conf (Primary)</span>
<span class="nv">listen_addresses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;*&#39;</span>
<span class="nv">wal_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>replica
<span class="nv">max_wal_senders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<span class="nv">wal_keep_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>1GB
<span class="nv">max_replication_slots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>

<span class="c1"># ë™ê¸° ë³µì œ ì„¤ì • (ì„ íƒì )</span>
<span class="nv">synchronous_commit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>on
<span class="nv">synchronous_standby_names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;standby1&#39;</span>

<span class="c1"># pg_hba.conf (ë³µì œ ì ‘ì† í—ˆìš©)</span>
<span class="c1"># TYPE  DATABASE        USER            ADDRESS                 METHOD</span>
host<span class="w">    </span>replication<span class="w">     </span>replicator<span class="w">      </span><span class="m">192</span>.168.1.0/24<span class="w">          </span>scram-sha-256
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">-- ë³µì œ ì „ìš© ì‚¬ìš©ì ìƒì„±</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">replicator</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">REPLICATION</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;secure_password&#39;</span><span class="p">;</span>

<span class="c1">-- ë³µì œ ìŠ¬ë¡¯ ìƒì„± (ê¶Œì¥)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">pg_create_physical_replication_slot</span><span class="p">(</span><span class="s1">&#39;standby1_slot&#39;</span><span class="p">);</span>

<span class="c1">-- ë³µì œ ìŠ¬ë¡¯ í™•ì¸</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_replication_slots</span><span class="p">;</span>
</code></pre></div>

<h3 id="23-standby">2.3 Standby ì„œë²„ ì„¤ì •<a class="header-link" href="#23-standby" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. Primaryì—ì„œ ê¸°ë³¸ ë°±ì—… ìƒì„±</span>
pg_basebackup<span class="w"> </span>-h<span class="w"> </span>primary_host<span class="w"> </span>-U<span class="w"> </span>replicator<span class="w"> </span>-D<span class="w"> </span>/var/lib/postgresql/data<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-Fp<span class="w"> </span>-Xs<span class="w"> </span>-P<span class="w"> </span>-R

<span class="c1"># -R ì˜µì…˜: standby.signal íŒŒì¼ê³¼ primary_conninfo ìë™ ìƒì„±</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># postgresql.conf (Standby)</span>
<span class="nv">hot_standby</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>on<span class="w">                  </span><span class="c1"># ì½ê¸° ì¿¼ë¦¬ í—ˆìš©</span>
<span class="nv">hot_standby_feedback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>on<span class="w">         </span><span class="c1"># ì¿¼ë¦¬ ì¶©ëŒ ë°©ì§€</span>
<span class="nv">max_standby_streaming_delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>30s<span class="w"> </span><span class="c1"># ì¿¼ë¦¬ ëŒ€ê¸° ì‹œê°„</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># postgresql.auto.conf (pg_basebackup -Rë¡œ ìë™ ìƒì„±)</span>
<span class="nv">primary_conninfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;host=primary_host port=5432 user=replicator password=secure_password&#39;</span>
<span class="nv">primary_slot_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;standby1_slot&#39;</span>
</code></pre></div>

<h3 id="24-vs">2.4 ë™ê¸° vs ë¹„ë™ê¸° ë³µì œ<a class="header-link" href="#24-vs" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- ë¹„ë™ê¸° ë³µì œ (ê¸°ë³¸ê°’)</span>
<span class="c1">-- Primary ì»¤ë°‹ í›„ ì¦‰ì‹œ ë°˜í™˜, Standby ì§€ì—° ê°€ëŠ¥</span>
<span class="n">synchronous_commit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">on</span><span class="w">  </span><span class="c1">-- localë§Œ ë³´ì¥</span>

<span class="c1">-- ë™ê¸° ë³µì œ</span>
<span class="n">synchronous_commit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">on</span>
<span class="n">synchronous_standby_names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;FIRST 1 (standby1, standby2)&#39;</span>

<span class="c1">-- ë™ê¸° ë³µì œ ì˜µì…˜</span>
<span class="c1">-- remote_write: ì›ê²© OS ë²„í¼ê¹Œì§€</span>
<span class="c1">-- remote_apply: ì›ê²© ì ìš©ê¹Œì§€ (ê°€ì¥ ì•ˆì „, ê°€ì¥ ëŠë¦¼)</span>
<span class="n">synchronous_commit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remote_apply</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>ë™ê¸° ë³µì œ êµ¬ì„± ì˜ˆì‹œ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ synchronous_standby_names = &#39;FIRST 2 (s1, s2, s3)&#39;             â”‚
â”‚                                                                 â”‚
â”‚   - FIRST 2: ì²« 2ê°œ ìŠ¤íƒ ë°”ì´ì˜ í™•ì¸ í•„ìš”                        â”‚
â”‚   - ANY 2: ì•„ë¬´ 2ê°œ ìŠ¤íƒ ë°”ì´ì˜ í™•ì¸ í•„ìš”                        â”‚
â”‚   - s1, s2, s3: application_name ê¸°ë°˜ ìš°ì„ ìˆœìœ„                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="25">2.5 ìºìŠ¤ì¼€ì´ë”© ë³µì œ<a class="header-link" href="#25" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ìºìŠ¤ì¼€ì´ë”© ë³µì œ í† í´ë¡œì§€                          â”‚
â”‚                                                              â”‚
â”‚   Primary â”€â”€â–º Standby1 â”€â”€â–º Standby2 â”€â”€â–º Standby3           â”‚
â”‚              (ì¤‘ê³„)       (ì¤‘ê³„)       (ìµœì¢…)               â”‚
â”‚                                                              â”‚
â”‚   ì¥ì :                                                      â”‚
â”‚   - Primary ë¶€í•˜ ê°ì†Œ                                        â”‚
â”‚   - ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ íš¨ìœ¨í™”                                    â”‚
â”‚   - ì§€ë¦¬ì  ë¶„ì‚°ì— ìœ ë¦¬                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Standby1 (ì¤‘ê³„ ì„œë²„)</span>
<span class="c1"># postgresql.conf</span>
<span class="nv">hot_standby</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>on

<span class="c1"># Standby2 (Standby1ì—ì„œ ë³µì œ ë°›ìŒ)</span>
<span class="c1"># primary_conninfoì— Standby1 ì£¼ì†Œ ì„¤ì •</span>
<span class="nv">primary_conninfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;host=standby1_host ...&#39;</span>
</code></pre></div>

<hr />
<h2 id="3">3. ë…¼ë¦¬ì  ë³µì œ<a class="header-link" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 ë…¼ë¦¬ì  ë³µì œ ê°œìš”<a class="header-link" href="#31" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ë…¼ë¦¬ì  ë³µì œ ì•„í‚¤í…ì²˜                           â”‚
â”‚                                                                 â”‚
â”‚   Publisher                         Subscriber                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚ PostgreSQL  â”‚   Publication     â”‚ PostgreSQL  â”‚           â”‚
â”‚   â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚             â”‚           â”‚
â”‚   â”‚  í…Œì´ë¸” A   â”‚   Subscription    â”‚  í…Œì´ë¸” A   â”‚           â”‚
â”‚   â”‚  í…Œì´ë¸” B   â”‚                   â”‚  í…Œì´ë¸” B   â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                 â”‚
â”‚   íŠ¹ì§•:                                                         â”‚
â”‚   - í…Œì´ë¸” ë‹¨ìœ„ ì„ íƒì  ë³µì œ                                      â”‚
â”‚   - ë‹¤ë¥¸ PostgreSQL ë²„ì „ ê°„ ë³µì œ ê°€ëŠ¥                           â”‚
â”‚   - Subscriberë„ ì“°ê¸° ê°€ëŠ¥                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="32-publisher">3.2 Publisher ì„¤ì •<a class="header-link" href="#32-publisher" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- postgresql.conf</span>
<span class="c1">-- wal_level = logical  (í•„ìˆ˜)</span>

<span class="c1">-- Publication ìƒì„±</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">my_pub</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="p">,</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span>

<span class="c1">-- ëª¨ë“  í…Œì´ë¸” ë°œí–‰</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">all_tables_pub</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="p">;</span>

<span class="c1">-- íŠ¹ì • ì‘ì—…ë§Œ ë°œí–‰</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">insert_only_pub</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span>
<span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">publish</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;insert&#39;</span><span class="p">);</span>

<span class="c1">-- í–‰ í•„í„° (PostgreSQL 15+)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">active_users_pub</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;active&#39;</span><span class="p">);</span>

<span class="c1">-- ì—´ í•„í„° (PostgreSQL 15+)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">partial_pub</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">);</span>

<span class="c1">-- Publication í™•ì¸</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_publication</span><span class="p">;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_publication_tables</span><span class="p">;</span>
</code></pre></div>

<h3 id="33-subscriber">3.3 Subscriber ì„¤ì •<a class="header-link" href="#33-subscriber" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- ëŒ€ìƒ í…Œì´ë¸” ìƒì„± (ë™ì¼í•œ ìŠ¤í‚¤ë§ˆ í•„ìš”)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span><span class="k">LIKE</span><span class="w"> </span><span class="n">source_db</span><span class="p">.</span><span class="n">users</span><span class="w"> </span><span class="k">INCLUDING</span><span class="w"> </span><span class="k">ALL</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span><span class="k">LIKE</span><span class="w"> </span><span class="n">source_db</span><span class="p">.</span><span class="n">orders</span><span class="w"> </span><span class="k">INCLUDING</span><span class="w"> </span><span class="k">ALL</span><span class="p">);</span>

<span class="c1">-- Subscription ìƒì„±</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">my_sub</span>
<span class="k">CONNECTION</span><span class="w"> </span><span class="s1">&#39;host=publisher_host dbname=source_db user=replicator password=xxx&#39;</span>
<span class="n">PUBLICATION</span><span class="w"> </span><span class="n">my_pub</span><span class="p">;</span>

<span class="c1">-- ì´ˆê¸° ë°ì´í„° ë³µì‚¬ ì—†ì´ (ì´ë¯¸ ë™ê¸°í™”ëœ ê²½ìš°)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">my_sub</span>
<span class="k">CONNECTION</span><span class="w"> </span><span class="s1">&#39;...&#39;</span>
<span class="n">PUBLICATION</span><span class="w"> </span><span class="n">my_pub</span>
<span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">copy_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">);</span>

<span class="c1">-- Subscription ê´€ë¦¬</span>
<span class="k">ALTER</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">my_sub</span><span class="w"> </span><span class="n">DISABLE</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">my_sub</span><span class="w"> </span><span class="n">ENABLE</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">my_sub</span><span class="w"> </span><span class="n">REFRESH</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="p">;</span>

<span class="c1">-- Subscription ìƒíƒœ í™•ì¸</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_subscription</span><span class="p">;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_subscription</span><span class="p">;</span>
</code></pre></div>

<h3 id="34">3.4 ë…¼ë¦¬ì  ë³µì œ ì‚¬ìš© ì‚¬ë¡€<a class="header-link" href="#34" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 1. ë²„ì „ ì—…ê·¸ë ˆì´ë“œ (ìµœì†Œ ë‹¤ìš´íƒ€ì„)</span>
<span class="c1">-- êµ¬ë²„ì „ â†’ ì‹ ë²„ì „ìœ¼ë¡œ ë…¼ë¦¬ ë³µì œ ì„¤ì • í›„ ìŠ¤ìœ„ì¹˜ì˜¤ë²„</span>

<span class="c1">-- 2. ì„ íƒì  ë°ì´í„° ë³µì œ (ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">analytics_pub</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">sales</span><span class="p">,</span><span class="w"> </span><span class="n">customers</span><span class="p">,</span><span class="w"> </span><span class="n">products</span>
<span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;APAC&#39;</span><span class="p">);</span>

<span class="c1">-- 3. ë°ì´í„° í†µí•© (ì—¬ëŸ¬ ì†ŒìŠ¤ â†’ í•˜ë‚˜ì˜ íƒ€ê²Ÿ)</span>
<span class="c1">-- Source DB 1</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">region1_pub</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span>

<span class="c1">-- Source DB 2</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">region2_pub</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span>

<span class="c1">-- Target DB</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">sub1</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">region1_pub</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">sub2</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">region2_pub</span><span class="p">;</span>

<span class="c1">-- 4. ì‹¤ì‹œê°„ ë¦¬í¬íŒ… ë°ì´í„°ë² ì´ìŠ¤</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">reporting_pub</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">transactions</span><span class="p">,</span><span class="w"> </span><span class="n">accounts</span><span class="p">,</span><span class="w"> </span><span class="n">audit_logs</span><span class="p">;</span>
</code></pre></div>

<h3 id="35">3.5 ì¶©ëŒ ì²˜ë¦¬<a class="header-link" href="#35" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- ë…¼ë¦¬ ë³µì œ ì‹œ ì¶©ëŒ ë°œìƒ ê°€ëŠ¥</span>
<span class="c1">-- (Subscriberì—ì„œë„ ì“°ê¸° í—ˆìš©ë˜ë¯€ë¡œ)</span>

<span class="c1">-- ì¶©ëŒ í™•ì¸</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_subscription</span><span class="p">;</span>
<span class="c1">-- srsubstate: &#39;e&#39; = error</span>

<span class="c1">-- ì¶©ëŒ ì‹œ ì˜µì…˜:</span>
<span class="c1">-- 1. ì¶©ëŒ í–‰ ìˆ˜ë™ í•´ê²°</span>
<span class="c1">-- 2. í•´ë‹¹ íŠ¸ëœì­ì…˜ ê±´ë„ˆë›°ê¸°</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">pg_replication_origin_advance</span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;pg_&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">subid</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="w">  </span><span class="c1">-- origin name</span>
<span class="w">    </span><span class="s1">&#39;0/XXXXXXX&#39;</span><span class="p">::</span><span class="n">pg_lsn</span><span class="w">    </span><span class="c1">-- ê±´ë„ˆë›¸ LSN</span>
<span class="p">);</span>

<span class="c1">-- 3. ë³µì œ ì¬ì‹œì‘</span>
<span class="k">ALTER</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">my_sub</span><span class="w"> </span><span class="n">DISABLE</span><span class="p">;</span>
<span class="c1">-- ë¬¸ì œ í•´ê²° í›„</span>
<span class="k">ALTER</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">my_sub</span><span class="w"> </span><span class="n">ENABLE</span><span class="p">;</span>
</code></pre></div>

<hr />
<h2 id="4">4. ë³µì œ ëª¨ë‹ˆí„°ë§<a class="header-link" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 ë³µì œ ìƒíƒœ í™•ì¸<a class="header-link" href="#41" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Primary: WAL ì†¡ì‹  ìƒíƒœ</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">client_addr</span><span class="p">,</span>
<span class="w">    </span><span class="k">state</span><span class="p">,</span>
<span class="w">    </span><span class="n">sent_lsn</span><span class="p">,</span>
<span class="w">    </span><span class="n">write_lsn</span><span class="p">,</span>
<span class="w">    </span><span class="n">flush_lsn</span><span class="p">,</span>
<span class="w">    </span><span class="n">replay_lsn</span><span class="p">,</span>
<span class="w">    </span><span class="n">sync_state</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_wal_lsn_diff</span><span class="p">(</span><span class="n">sent_lsn</span><span class="p">,</span><span class="w"> </span><span class="n">replay_lsn</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">replay_lag_bytes</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_replication</span><span class="p">;</span>

<span class="c1">-- ë³µì œ ì§€ì—° ì‹œê°„ (Primary)</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">client_addr</span><span class="p">,</span>
<span class="w">    </span><span class="k">state</span><span class="p">,</span>
<span class="w">    </span><span class="n">write_lag</span><span class="p">,</span>
<span class="w">    </span><span class="n">flush_lag</span><span class="p">,</span>
<span class="w">    </span><span class="n">replay_lag</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_replication</span><span class="p">;</span>

<span class="c1">-- Standby: í˜„ì¬ ë³µì œ ìƒíƒœ</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">pg_is_in_recovery</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">is_standby</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_last_wal_receive_lsn</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">received_lsn</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_last_wal_replay_lsn</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">replayed_lsn</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_last_xact_replay_timestamp</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">last_replay_time</span><span class="p">,</span>
<span class="w">    </span><span class="k">EXTRACT</span><span class="p">(</span><span class="n">EPOCH</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pg_last_xact_replay_timestamp</span><span class="p">()))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">lag_seconds</span><span class="p">;</span>
</code></pre></div>

<h3 id="42">4.2 ë³µì œ ìŠ¬ë¡¯ ëª¨ë‹ˆí„°ë§<a class="header-link" href="#42" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- ë³µì œ ìŠ¬ë¡¯ ìƒíƒœ</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">slot_name</span><span class="p">,</span>
<span class="w">    </span><span class="n">slot_type</span><span class="p">,</span>
<span class="w">    </span><span class="n">active</span><span class="p">,</span>
<span class="w">    </span><span class="n">restart_lsn</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_wal_lsn_diff</span><span class="p">(</span><span class="n">pg_current_wal_lsn</span><span class="p">(),</span><span class="w"> </span><span class="n">restart_lsn</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">retained_bytes</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_replication_slots</span><span class="p">;</span>

<span class="c1">-- ë¹„í™œì„± ìŠ¬ë¡¯ìœ¼ë¡œ ì¸í•œ WAL ëˆ„ì  í™•ì¸</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">slot_name</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_wal_lsn_diff</span><span class="p">(</span><span class="n">pg_current_wal_lsn</span><span class="p">(),</span><span class="w"> </span><span class="n">restart_lsn</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">retained</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_replication_slots</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">active</span><span class="p">;</span>

<span class="c1">-- ë¹„í™œì„± ìŠ¬ë¡¯ ì •ë¦¬ (ì£¼ì˜!)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">pg_drop_replication_slot</span><span class="p">(</span><span class="s1">&#39;unused_slot&#39;</span><span class="p">);</span>
</code></pre></div>

<h3 id="43">4.3 ëª¨ë‹ˆí„°ë§ ë·° ìƒì„±<a class="header-link" href="#43" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- ì¢…í•© ë³µì œ ëª¨ë‹ˆí„°ë§ ë·°</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">v_replication_status</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="s1">&#39;physical&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">repl_type</span><span class="p">,</span>
<span class="w">    </span><span class="n">client_addr</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">application_name</span><span class="p">,</span>
<span class="w">    </span><span class="k">state</span><span class="p">,</span>
<span class="w">    </span><span class="n">sync_state</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_wal_lsn_diff</span><span class="p">(</span><span class="n">sent_lsn</span><span class="p">,</span><span class="w"> </span><span class="n">replay_lsn</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">lag_size</span><span class="p">,</span>
<span class="w">    </span><span class="k">COALESCE</span><span class="p">(</span><span class="n">replay_lag</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">lag_time</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_replication</span>

<span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span>

<span class="k">SELECT</span>
<span class="w">    </span><span class="s1">&#39;logical&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">repl_type</span><span class="p">,</span>
<span class="w">    </span><span class="n">subconninfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">subname</span><span class="p">,</span>
<span class="w">    </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">subenabled</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;active&#39;</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;disabled&#39;</span><span class="w"> </span><span class="k">END</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;async&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;N/A&#39;</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_subscription</span><span class="p">;</span>
</code></pre></div>

<hr />
<h2 id="5">5. í˜ì¼ì˜¤ë²„ì™€ ìŠ¤ìœ„ì¹˜ì˜¤ë²„<a class="header-link" href="#5" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 ê°œë… ì •ë¦¬<a class="header-link" href="#51" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ìŠ¤ìœ„ì¹˜ì˜¤ë²„ (Switchover)                                         â”‚
â”‚ - ê³„íšëœ ì—­í•  ì „í™˜                                              â”‚
â”‚ - ìœ ì§€ë³´ìˆ˜, ì—…ê·¸ë ˆì´ë“œ ì‹œ ì‚¬ìš©                                   â”‚
â”‚ - ë°ì´í„° ì†ì‹¤ ì—†ìŒ                                              â”‚
â”‚                                                                 â”‚
â”‚ í˜ì¼ì˜¤ë²„ (Failover)                                             â”‚
â”‚ - ì¥ì•  ì‹œ ë¹„ê³„íšì  ì—­í•  ì „í™˜                                     â”‚
â”‚ - Primary ì¥ì•  ì‹œ Standbyê°€ ìŠ¹ê²©                                â”‚
â”‚ - ë¹„ë™ê¸° ë³µì œ ì‹œ ë°ì´í„° ì†ì‹¤ ê°€ëŠ¥                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="52">5.2 ìˆ˜ë™ í˜ì¼ì˜¤ë²„<a class="header-link" href="#52" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Standbyì—ì„œ ìŠ¹ê²© (pg_ctl ì‚¬ìš©)</span>
pg_ctl<span class="w"> </span>promote<span class="w"> </span>-D<span class="w"> </span>/var/lib/postgresql/data

<span class="c1"># ë˜ëŠ” SQL ì‚¬ìš©</span>
SELECT<span class="w"> </span>pg_promote<span class="o">()</span><span class="p">;</span>

<span class="c1"># ë˜ëŠ” íŠ¸ë¦¬ê±° íŒŒì¼ ì‚¬ìš© (ë ˆê±°ì‹œ)</span>
touch<span class="w"> </span>/var/lib/postgresql/data/promote
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">-- ìŠ¹ê²© í›„ í™•ì¸</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">pg_is_in_recovery</span><span class="p">();</span><span class="w">  </span><span class="c1">-- falseë©´ Primary</span>
</code></pre></div>

<h3 id="53-pg_rewind-primary">5.3 pg_rewindë¥¼ ì‚¬ìš©í•œ ì´ì „ Primary ë³µêµ¬<a class="header-link" href="#53-pg_rewind-primary" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># ì¥ì•  í›„ ì´ì „ Primaryë¥¼ ìƒˆ Standbyë¡œ ë³€í™˜</span>
<span class="c1"># (íƒ€ì„ë¼ì¸ ë¶„ê¸° í•´ê²°)</span>

<span class="c1"># 1. ì´ì „ Primary ì •ì§€</span>
pg_ctl<span class="w"> </span>stop<span class="w"> </span>-D<span class="w"> </span>/var/lib/postgresql/data

<span class="c1"># 2. pg_rewind ì‹¤í–‰</span>
pg_rewind<span class="w"> </span>--target-pgdata<span class="o">=</span>/var/lib/postgresql/data<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>--source-server<span class="o">=</span><span class="s2">&quot;host=new_primary port=5432 user=replicator&quot;</span>

<span class="c1"># 3. standby.signal ìƒì„± ë° ì„¤ì •</span>
touch<span class="w"> </span>/var/lib/postgresql/data/standby.signal

<span class="c1"># 4. ì‹œì‘</span>
pg_ctl<span class="w"> </span>start<span class="w"> </span>-D<span class="w"> </span>/var/lib/postgresql/data
</code></pre></div>

<h3 id="54">5.4 ìë™ í˜ì¼ì˜¤ë²„ ìŠ¤í¬ë¦½íŠ¸ ì˜ˆì‹œ<a class="header-link" href="#54" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># simple_failover.sh</span>

<span class="nv">PRIMARY_HOST</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span>
<span class="nv">STANDBY_HOST</span><span class="o">=</span><span class="s2">&quot;standby&quot;</span>
<span class="nv">VIP</span><span class="o">=</span><span class="s2">&quot;192.168.1.100&quot;</span>

check_primary<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>pg_isready<span class="w"> </span>-h<span class="w"> </span><span class="nv">$PRIMARY_HOST</span><span class="w"> </span>-p<span class="w"> </span><span class="m">5432</span><span class="w"> </span>-q
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">$?</span>
<span class="o">}</span>

promote_standby<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>ssh<span class="w"> </span><span class="nv">$STANDBY_HOST</span><span class="w"> </span><span class="s2">&quot;pg_ctl promote -D /var/lib/postgresql/data&quot;</span>
<span class="o">}</span>

move_vip<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="c1"># ê¸°ì¡´ Primaryì—ì„œ VIP ì œê±°</span>
<span class="w">    </span>ssh<span class="w"> </span><span class="nv">$PRIMARY_HOST</span><span class="w"> </span><span class="s2">&quot;ip addr del </span><span class="nv">$VIP</span><span class="s2">/24 dev eth0&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null
<span class="w">    </span><span class="c1"># ìƒˆ Primaryì— VIP í• ë‹¹</span>
<span class="w">    </span>ssh<span class="w"> </span><span class="nv">$STANDBY_HOST</span><span class="w"> </span><span class="s2">&quot;ip addr add </span><span class="nv">$VIP</span><span class="s2">/24 dev eth0&quot;</span>
<span class="o">}</span>

<span class="c1"># ë©”ì¸ ë¡œì§</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>check_primary<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Primary ì¥ì•  ê°ì§€, í˜ì¼ì˜¤ë²„ ì‹œì‘...&quot;</span>
<span class="w">    </span>promote_standby
<span class="w">    </span>sleep<span class="w"> </span><span class="m">5</span>
<span class="w">    </span>move_vip
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;í˜ì¼ì˜¤ë²„ ì™„ë£Œ&quot;</span>
<span class="k">fi</span>
</code></pre></div>

<hr />
<h2 id="6">6. ê³ ê°€ìš©ì„± ì†”ë£¨ì…˜<a class="header-link" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="61-patroni">6.1 Patroni<a class="header-link" href="#61-patroni" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># patroni.yml</span>
<span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-cluster</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1</span>

<span class="nt">restapi</span><span class="p">:</span>
<span class="w">  </span><span class="nt">listen</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0.0.0:8008</span>
<span class="w">  </span><span class="nt">connect_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1:8008</span>

<span class="nt">etcd</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">etcd1:2379,etcd2:2379,etcd3:2379</span>

<span class="nt">bootstrap</span><span class="p">:</span>
<span class="w">  </span><span class="nt">dcs</span><span class="p">:</span>
<span class="w">    </span><span class="nt">ttl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<span class="w">    </span><span class="nt">loop_wait</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">    </span><span class="nt">retry_timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">    </span><span class="nt">maximum_lag_on_failover</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1048576</span>
<span class="w">    </span><span class="nt">postgresql</span><span class="p">:</span>
<span class="w">      </span><span class="nt">use_pg_rewind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">parameters</span><span class="p">:</span>
<span class="w">        </span><span class="nt">wal_level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replica</span>
<span class="w">        </span><span class="nt">hot_standby</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">on</span>
<span class="w">        </span><span class="nt">max_wal_senders</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">        </span><span class="nt">max_replication_slots</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">        </span><span class="nt">wal_keep_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1GB</span>

<span class="w">  </span><span class="nt">initdb</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">encoding</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">UTF8</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data-checksums</span>

<span class="nt">postgresql</span><span class="p">:</span>
<span class="w">  </span><span class="nt">listen</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0.0.0:5432</span>
<span class="w">  </span><span class="nt">connect_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1:5432</span>
<span class="w">  </span><span class="nt">data_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/postgresql/data</span>
<span class="w">  </span><span class="nt">authentication</span><span class="p">:</span>
<span class="w">    </span><span class="nt">replication</span><span class="p">:</span>
<span class="w">      </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replicator</span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rep_password</span>
<span class="w">    </span><span class="nt">superuser</span><span class="p">:</span>
<span class="w">      </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_password</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Patroni í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸</span>
patronictl<span class="w"> </span>-c<span class="w"> </span>/etc/patroni/patroni.yml<span class="w"> </span>list

<span class="c1"># ìˆ˜ë™ ìŠ¤ìœ„ì¹˜ì˜¤ë²„</span>
patronictl<span class="w"> </span>-c<span class="w"> </span>/etc/patroni/patroni.yml<span class="w"> </span>switchover

<span class="c1"># ìˆ˜ë™ í˜ì¼ì˜¤ë²„ (Primary ê°•ì œ ì œê±°)</span>
patronictl<span class="w"> </span>-c<span class="w"> </span>/etc/patroni/patroni.yml<span class="w"> </span>failover
</code></pre></div>

<h3 id="62">6.2 ê³ ê°€ìš©ì„± ì•„í‚¤í…ì²˜<a class="header-link" href="#62" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Patroni + HAProxy ì•„í‚¤í…ì²˜                      â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚   â”‚   HAProxy     â”‚ â—„â”€â”€ VIP                                    â”‚
â”‚   â”‚  (Load Bal)   â”‚                                            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚           â”‚                                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                              â”‚
â”‚     â”‚           â”‚                                              â”‚
â”‚   â”Œâ”€â”´â”€â”       â”Œâ”€â”´â”€â”       â”Œâ”€â”€â”€â”                               â”‚
â”‚   â”‚N1 â”‚       â”‚N2 â”‚       â”‚N3 â”‚    PostgreSQL + Patroni       â”‚
â”‚   â””â”€â”¬â”€â”˜       â””â”€â”¬â”€â”˜       â””â”€â”¬â”€â”˜                               â”‚
â”‚     â”‚           â”‚           â”‚                                   â”‚
â”‚   â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”                               â”‚
â”‚   â”‚      etcd Cluster          â”‚   ë¶„ì‚° í•©ì˜ ì €ì¥ì†Œ            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="63-haproxy">6.3 HAProxy ì„¤ì •<a class="header-link" href="#63-haproxy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> haproxy.cfg
global
    maxconn 1000

defaults
    mode tcp
    timeout connect 10s
    timeout client 30s
    timeout server 30s

listen postgres_write
    bind <span class="gs">*:5432</span>
<span class="gs">    option httpchk GET /master</span>
<span class="gs">    http-check expect status 200</span>
<span class="gs">    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions</span>
<span class="gs">    server node1 node1:5432 check port 8008</span>
<span class="gs">    server node2 node2:5432 check port 8008</span>
<span class="gs">    server node3 node3:5432 check port 8008</span>

<span class="gs">listen postgres_read</span>
<span class="gs">    bind *</span>:5433
    balance roundrobin
    option httpchk GET /replica
    http-check expect status 200
    default-server inter 3s fall 3 rise 2
    server node1 node1:5432 check port 8008
    server node2 node2:5432 check port 8008
    server node3 node3:5432 check port 8008
</code></pre></div>

<h3 id="64-pgbouncer">6.4 PgBouncerì™€ ì—°ë™<a class="header-link" href="#64-pgbouncer" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># pgbouncer.ini</span>
<span class="k">[databases]</span>
<span class="na">mydb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">host=haproxy_vip port=5432 dbname=mydb</span>

<span class="k">[pgbouncer]</span>
<span class="na">listen_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0.0.0.0</span>
<span class="na">listen_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">6432</span>
<span class="na">auth_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">scram-sha-256</span>
<span class="na">auth_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/etc/pgbouncer/userlist.txt</span>
<span class="na">pool_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">transaction</span>
<span class="na">max_client_conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1000</span>
<span class="na">default_pool_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">25</span>
</code></pre></div>

<h3 id="65">6.5 í´ë¼ìš°ë“œ í™˜ê²½ ê³ ê°€ìš©ì„±<a class="header-link" href="#65" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- AWS RDS: Multi-AZ ìë™ í˜ì¼ì˜¤ë²„</span>
<span class="c1">-- ì„¤ì • ì‹œ ìë™ êµ¬ì„±ë¨</span>

<span class="c1">-- Azure Database for PostgreSQL: HA ì˜µì…˜</span>
<span class="c1">-- Zone-redundant HA ì„ íƒ</span>

<span class="c1">-- GCP Cloud SQL: Regional HA</span>
<span class="c1">-- failover replica ìë™ êµ¬ì„±</span>

<span class="c1">-- ì• í”Œë¦¬ì¼€ì´ì…˜ ì—°ê²° ë¬¸ìì—´</span>
<span class="c1">-- ì½ê¸°/ì“°ê¸° ë¶„ë¦¬ ì˜ˆì‹œ</span>
<span class="c1">-- Primary: postgresql://primary.example.com:5432/mydb</span>
<span class="c1">-- Read: postgresql://read.example.com:5432/mydb</span>
</code></pre></div>

<hr />
<h2 id="7">7. ì—°ìŠµ ë¬¸ì œ<a class="header-link" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="1_1">ì—°ìŠµ 1: ìŠ¤íŠ¸ë¦¬ë° ë³µì œ êµ¬ì„±<a class="header-link" href="#1_1" title="Permanent link">&para;</a></h3>
<p>Dockerë¥¼ ì‚¬ìš©í•˜ì—¬ Primary-Standby êµ¬ì„±ì„ ì„¤ì •í•˜ì„¸ìš”.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># docker-compose.yml</span>
version:<span class="w"> </span><span class="s1">&#39;3.8&#39;</span>
services:
<span class="w">  </span>primary:
<span class="w">    </span>image:<span class="w"> </span>postgres:16
<span class="w">    </span>environment:
<span class="w">      </span>POSTGRES_PASSWORD:<span class="w"> </span>postgres
<span class="w">      </span>POSTGRES_INITDB_ARGS:<span class="w"> </span><span class="s2">&quot;--data-checksums&quot;</span>
<span class="w">    </span>command:<span class="w"> </span><span class="p">|</span>
<span class="w">      </span>postgres
<span class="w">      </span>-c<span class="w"> </span><span class="nv">wal_level</span><span class="o">=</span>replica
<span class="w">      </span>-c<span class="w"> </span><span class="nv">max_wal_senders</span><span class="o">=</span><span class="m">3</span>
<span class="w">      </span>-c<span class="w"> </span><span class="nv">max_replication_slots</span><span class="o">=</span><span class="m">3</span>
<span class="w">      </span>-c<span class="w"> </span><span class="nv">hot_standby</span><span class="o">=</span>on
<span class="w">    </span>ports:
<span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;5432:5432&quot;</span>
<span class="w">    </span>volumes:
<span class="w">      </span>-<span class="w"> </span>primary_data:/var/lib/postgresql/data

<span class="w">  </span>standby:
<span class="w">    </span>image:<span class="w"> </span>postgres:16
<span class="w">    </span>environment:
<span class="w">      </span>POSTGRES_PASSWORD:<span class="w"> </span>postgres
<span class="w">      </span>PGDATA:<span class="w"> </span>/var/lib/postgresql/data
<span class="w">    </span>depends_on:
<span class="w">      </span>-<span class="w"> </span>primary
<span class="w">    </span><span class="c1"># standby ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ í•„ìš”</span>
<span class="w">    </span>ports:
<span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;5433:5432&quot;</span>
<span class="w">    </span>volumes:
<span class="w">      </span>-<span class="w"> </span>standby_data:/var/lib/postgresql/data

volumes:
<span class="w">  </span>primary_data:
<span class="w">  </span>standby_data:
</code></pre></div>

<h3 id="2_1">ì—°ìŠµ 2: ë…¼ë¦¬ ë³µì œ ì„¤ì •<a class="header-link" href="#2_1" title="Permanent link">&para;</a></h3>
<p>íŠ¹ì • í…Œì´ë¸”ë§Œ ë³µì œí•˜ëŠ” ë…¼ë¦¬ ë³µì œë¥¼ êµ¬ì„±í•˜ì„¸ìš”.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Publisher (source_db)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">price</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
<span class="w">    </span><span class="n">category</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">category</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span>
<span class="w">    </span><span class="p">(</span><span class="s1">&#39;Laptop&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">999</span><span class="p">.</span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Electronics&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="p">(</span><span class="s1">&#39;Book&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="p">.</span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Books&#39;</span><span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="n">PUBLICATION</span><span class="w"> </span><span class="n">products_pub</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="p">;</span>

<span class="c1">-- Subscriber (target_db)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="p">(</span><span class="k">LIKE</span><span class="w"> </span><span class="n">source_db</span><span class="p">.</span><span class="n">products</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">SUBSCRIPTION</span><span class="w"> </span><span class="n">products_sub</span>
<span class="k">CONNECTION</span><span class="w"> </span><span class="s1">&#39;host=source_host dbname=source_db user=replicator&#39;</span>
<span class="n">PUBLICATION</span><span class="w"> </span><span class="n">products_pub</span><span class="p">;</span>
</code></pre></div>

<h3 id="3_1">ì—°ìŠµ 3: ë³µì œ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ<a class="header-link" href="#3_1" title="Permanent link">&para;</a></h3>
<p>ë³µì œ ìƒíƒœë¥¼ ì¢…í•©ì ìœ¼ë¡œ ë³´ì—¬ì£¼ëŠ” ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ì„¸ìš”.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- ì˜ˆì‹œ ë‹µì•ˆ</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="s1">&#39;Replication Lag&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">metric</span><span class="p">,</span>
<span class="w">    </span><span class="k">COALESCE</span><span class="p">(</span>
<span class="w">        </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_wal_lsn_diff</span><span class="p">(</span><span class="n">sent_lsn</span><span class="p">,</span><span class="w"> </span><span class="n">replay_lsn</span><span class="p">))</span>
<span class="w">         </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_replication</span>
<span class="w">         </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">        </span><span class="s1">&#39;No standby&#39;</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">value</span>
<span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="s1">&#39;Standby Count&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)::</span><span class="nb">text</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_replication</span><span class="p">)</span>
<span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="s1">&#39;Replication Slots&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)::</span><span class="nb">text</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_replication_slots</span><span class="p">);</span>
</code></pre></div>

<hr />
<h2 id="_3">ë‹¤ìŒ ë‹¨ê³„<a class="header-link" href="#_3" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="./17_Window_Functions.md">17. ìœˆë„ìš° í•¨ìˆ˜ì™€ ë¶„ì„</a></li>
<li><a href="./18_Table_Partitioning.md">18. í…Œì´ë¸” íŒŒí‹°ì…”ë‹</a></li>
</ul>
<h2 id="_4">ì°¸ê³  ìë£Œ<a class="header-link" href="#_4" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://www.postgresql.org/docs/current/high-availability.html">PostgreSQL Replication</a></li>
<li><a href="https://www.postgresql.org/docs/current/logical-replication.html">Logical Replication</a></li>
<li><a href="https://patroni.readthedocs.io/">Patroni Documentation</a></li>
<li><a href="https://www.postgresql.org/docs/current/app-pgbasebackup.html">pg_basebackup</a></li>
</ul>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/PostgreSQL/15_Query_Optimization.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">15. PostgreSQL ì¿¼ë¦¬ ìµœì í™” ì‹¬í™”</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/PostgreSQL/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/PostgreSQL/17_Window_Functions.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">17. ìœˆë„ìš° í•¨ìˆ˜ì™€ ë¶„ì„ ì¿¼ë¦¬ (Window Functions & Analytics)</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'ko';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}