{% raw %}
<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>05. 인증 시스템 - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/ko/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/ko/" class="nav-item ">
                    <span class="nav-icon">🏠</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">💻</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/ko/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" >
                        English
                    </option>
                    
                    <option value="ko" selected>
                        한국어
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">☀️</span>
                    <span class="theme-icon dark">🌙</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/ko/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/ko/Security/">Security</a>
    <span class="separator">/</span>
    <span class="current">05. 인증 시스템</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>05. 인증 시스템</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Security/04_TLS_and_PKI.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">TLS/SSL과 공개 키 인프라</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">🔗</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">📋</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Security/06_Authorization.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">06. 인가 및 접근 제어</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#_1">학습 목표</a></li>
<li><a href="#1">1. 비밀번호 기반 인증</a><ul>
<li><a href="#11">1.1 비밀번호 문제</a></li>
<li><a href="#12">1.2 평문 비밀번호를 저장하지 말아야 하는 이유</a></li>
<li><a href="#13">1.3 해싱, 솔팅, 키 스트레칭</a></li>
<li><a href="#14-python">1.4 Python 구현: 비밀번호 해싱</a></li>
<li><a href="#15">1.5 비밀번호 정책</a></li>
</ul>
</li>
<li><a href="#2-mfa">2. 다중 인증 (MFA)</a><ul>
<li><a href="#21">2.1 인증 요소</a></li>
<li><a href="#22-totp">2.2 TOTP (시간 기반 일회용 비밀번호)</a></li>
<li><a href="#23-fido2-webauthn">2.3 FIDO2 / WebAuthn</a></li>
</ul>
</li>
<li><a href="#3-oauth-20-openid-connect">3. OAuth 2.0 및 OpenID Connect</a><ul>
<li><a href="#31-oauth-20">3.1 OAuth 2.0 개요</a></li>
<li><a href="#32">3.2 권한 부여 코드 플로우 (가장 일반적)</a></li>
<li><a href="#33-pkce">3.3 PKCE를 사용한 권한 부여 코드 플로우</a></li>
<li><a href="#34-openid-connect-oidc">3.4 OpenID Connect (OIDC)</a></li>
<li><a href="#35-python-oauth-20">3.5 Python 예제: OAuth 2.0 클라이언트</a></li>
</ul>
</li>
<li><a href="#4">4. 세션 관리</a><ul>
<li><a href="#41">4.1 서버 측 세션 (쿠키 기반)</a></li>
<li><a href="#42">4.2 안전한 쿠키 속성</a></li>
<li><a href="#43">4.3 세션 보안 모범 사례</a></li>
</ul>
</li>
<li><a href="#5-json-jwt">5. JSON 웹 토큰 (JWT)</a><ul>
<li><a href="#51-jwt">5.1 JWT 구조</a></li>
<li><a href="#52-jwt">5.2 JWT 서명 알고리즘</a></li>
<li><a href="#53-python-jwt">5.3 Python JWT 구현</a></li>
<li><a href="#54-jwt">5.4 일반적인 JWT 함정</a></li>
</ul>
</li>
<li><a href="#6">6. 비밀번호 재설정 플로우</a><ul>
<li><a href="#61">6.1 안전한 비밀번호 재설정 설계</a></li>
<li><a href="#62">6.2 구현</a></li>
</ul>
</li>
<li><a href="#7">7. 생체 인증</a><ul>
<li><a href="#71">7.1 개요</a></li>
<li><a href="#72">7.2 생체 템플릿 보안</a></li>
<li><a href="#73">7.3 생체 트레이드오프</a></li>
</ul>
</li>
<li><a href="#8">8. 인증 아키텍처 패턴</a><ul>
<li><a href="#81">8.1 올바른 패턴 선택</a></li>
<li><a href="#82">8.2 중앙 인증 (인증 서비스 패턴)</a></li>
</ul>
</li>
<li><a href="#9">9. 연습 문제</a><ul>
<li><a href="#1_1">연습문제 1: 안전한 비밀번호 저장 구현</a></li>
<li><a href="#2-totp">연습문제 2: TOTP 통합</a></li>
<li><a href="#3-jwt">연습문제 3: JWT 보안 감사</a></li>
<li><a href="#4-oauth-20">연습문제 4: OAuth 2.0 플로우 구현</a></li>
<li><a href="#5">연습문제 5: 비밀번호 재설정 보안 검토</a></li>
</ul>
</li>
<li><a href="#10">10. 요약</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="05">05. 인증 시스템<a class="header-link" href="#05" title="Permanent link">&para;</a></h1>
<p><strong>이전</strong>: <a href="./04_TLS_and_PKI.md">04. TLS/SSL 및 공개키 기반 구조</a> | <strong>다음</strong>: <a href="06_Authorization.md">06. 접근 제어 및 권한 부여</a></p>
<hr />
<p>인증(Authentication)은 사용자나 시스템이 주장하는 신원을 확인하는 프로세스입니다. "당신은 누구입니까?"라는 질문에 답하며, 모든 접근 제어 결정의 기반이 됩니다. 잘못 구현된 인증 시스템은 가장 정교한 권한 부여 및 암호화조차 무용지물로 만들 수 있습니다. 이 강의는 비밀번호 기반 인증, 다중 인증, 토큰 기반 시스템, OAuth 2.0/OIDC, 세션 관리, 생체 인증 방식을 실용적인 Python 예제와 함께 다룹니다.</p>
<h2 id="_1">학습 목표<a class="header-link" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li>솔팅과 키 스트레칭을 사용한 안전한 비밀번호 저장 구현</li>
<li>다중 인증(TOTP, FIDO2/WebAuthn) 이해 및 구현</li>
<li>OAuth 2.0 및 OpenID Connect 인증/권한 부여 플로우 설명</li>
<li>쿠키, 토큰, JWT를 사용한 안전한 세션 관리</li>
<li>일반적인 JWT 함정 식별 및 회피</li>
<li>안전한 비밀번호 재설정 플로우 설계</li>
<li>생체 인증 개념 및 트레이드오프 이해</li>
</ul>
<hr />
<h2 id="1">1. 비밀번호 기반 인증<a class="header-link" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 비밀번호 문제<a class="header-link" href="#11" title="Permanent link">&para;</a></h3>
<p>비밀번호는 잘 알려진 약점에도 불구하고 가장 일반적인 인증 방법으로 남아있습니다.</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│               비밀번호 인증 플로우                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   사용자                  서버                                     │
│   ┌──────┐               ┌──────────┐                           │
│   │ 폼   │───────────────▶│ 수신     │                           │
│   │ 사용자│  username +    │ username │                           │
│   │ pass │  password      │ + pass   │                          │
│   └──────┘               └────┬─────┘                           │
│                                │                                 │
│                                ▼                                 │
│                         ┌──────────────┐                        │
│                         │  제공된      │                         │
│                         │  비밀번호    │                         │
│                         │  해시화      │                         │
│                         └──────┬───────┘                        │
│                                │                                 │
│                                ▼                                 │
│                    ┌────────────────────┐                       │
│                    │  DB에 저장된       │                        │
│                    │  해시와 비교       │                        │
│                    └────────┬───────────┘                       │
│                             │                                    │
│                      ┌──────┴──────┐                            │
│                      │             │                             │
│                   일치?         불일치?                           │
│                      │             │                             │
│                      ▼             ▼                             │
│                  ┌────────┐   ┌────────┐                        │
│                  │ 접근   │   │ 접근   │                         │
│                  │ 허용   │   │ 거부   │                         │
│                  └────────┘   └────────┘                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="12">1.2 평문 비밀번호를 저장하지 말아야 하는 이유<a class="header-link" href="#12" title="Permanent link">&para;</a></h3>
<p>공격자가 데이터베이스에 접근하게 되면(SQL 인젝션, 백업 도난, 내부자 위협 등을 통해) 평문 비밀번호는 즉시 노출됩니다. <strong>심층 방어(defense in depth)</strong> 원칙은 데이터베이스 침해가 발생하더라도 사용자 자격 증명이 직접 노출되지 않도록 요구합니다.</p>
<div class="highlight"><pre><span></span><code><span class="err">┌──────────────────────────────────────────────────────────────┐</span>
<span class="err">│</span><span class="w">  </span><span class="n">절대</span><span class="w"> </span><span class="n">이렇게</span><span class="w"> </span><span class="n">하지</span><span class="w"> </span><span class="nl">마세요</span><span class="p">:</span><span class="w">                                        </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                               </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="n">users</span><span class="w"> </span><span class="nl">테이블</span><span class="p">:</span><span class="w">                                                 </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">┌──────────┬────────────────┐</span><span class="w">                               </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="n">password</span><span class="w">       </span><span class="err">│</span><span class="w">                                </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">├──────────┼────────────────┤</span><span class="w">                                </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">alice</span><span class="w">    </span><span class="err">│</span><span class="w"> </span><span class="n">MyP</span><span class="nv">@ssw0rd</span><span class="err">!</span><span class="w">    </span><span class="err">│</span><span class="w">  </span><span class="err">←</span><span class="w"> </span><span class="n">평문</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">재앙</span><span class="w">                 </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">bob</span><span class="w">      </span><span class="err">│</span><span class="w"> </span><span class="n">hunter2</span><span class="w">        </span><span class="err">│</span><span class="w">                                </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">└──────────┴────────────────┘</span><span class="w">                               </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                               </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="n">대신</span><span class="w"> </span><span class="n">이렇게</span><span class="w"> </span><span class="nl">하세요</span><span class="p">:</span><span class="w">                                            </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                               </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="n">users</span><span class="w"> </span><span class="nl">테이블</span><span class="p">:</span><span class="w">                                                 </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">┌──────────┬──────────────────────────────────────────────┐</span><span class="w"> </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="n">password_hash</span><span class="w">                                </span><span class="err">│</span><span class="w">  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">├──────────┼──────────────────────────────────────────────┤</span><span class="w"> </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">alice</span><span class="w">    </span><span class="err">│</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span><span class="n">b</span><span class="err">$</span><span class="mi">12</span><span class="err">$</span><span class="n">LJ3m4ys3Lk0aB</span><span class="p">...</span><span class="w">  </span><span class="p">(</span><span class="n">bcrypt</span><span class="w"> </span><span class="n">해시</span><span class="p">)</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">bob</span><span class="w">      </span><span class="err">│</span><span class="w"> </span><span class="err">$</span><span class="n">argon2id</span><span class="err">$</span><span class="n">v</span><span class="o">=</span><span class="mi">19</span><span class="err">$</span><span class="n">m</span><span class="o">=</span><span class="mf">65536.</span><span class="p">..</span><span class="w"> </span><span class="p">(</span><span class="n">argon2</span><span class="w"> </span><span class="n">해시</span><span class="p">)</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">└──────────┴──────────────────────────────────────────────┘</span><span class="w"> </span><span class="err">│</span>
<span class="err">└──────────────────────────────────────────────────────────────┘</span>
</code></pre></div>

<h3 id="13">1.3 해싱, 솔팅, 키 스트레칭<a class="header-link" href="#13" title="Permanent link">&para;</a></h3>
<p><strong>해싱(Hashing)</strong>은 비밀번호를 고정 길이 문자열로 변환합니다. 하지만 단순 해싱(MD5, SHA-256)은 레인보우 테이블과 무차별 대입 공격에 취약합니다.</p>
<p><strong>솔팅(Salting)</strong>은 해싱 전에 각 비밀번호에 고유한 랜덤 값을 추가하여 레인보우 테이블을 무력화합니다.</p>
<p><strong>키 스트레칭(Key Stretching)</strong>은 해시 함수를 수천 또는 수백만 번 적용하여 무차별 대입 공격을 계산적으로 비용이 많이 들게 만듭니다.</p>
<div class="highlight"><pre><span></span><code><span class="err">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="err">│</span><span class="w">                  </span><span class="n">비밀번호</span><span class="w"> </span><span class="n">해싱</span><span class="w"> </span><span class="n">파이프라인</span><span class="w">                            </span><span class="err">│</span>
<span class="err">├─────────────────────────────────────────────────────────────────┤</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">   </span><span class="ss">&quot;MyP@ssw0rd!&quot;</span><span class="w">                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">                                                         </span><span class="err">│</span>
<span class="err">│</span><span class="w">        </span><span class="err">▼</span><span class="w">                                                         </span><span class="err">│</span>
<span class="err">│</span><span class="w">   </span><span class="err">┌──────────────┐</span><span class="w">                                              </span><span class="err">│</span>
<span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="n">랜덤</span><span class="w"> </span><span class="n">솔트</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="err">──▶</span><span class="w">  </span><span class="n">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;x9Kp2mQ...&quot;</span><span class="w">  </span><span class="p">(</span><span class="n">랜덤</span><span class="p">,</span><span class="w"> </span><span class="n">고유</span><span class="p">)</span><span class="w">      </span><span class="err">│</span>
<span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="n">생성</span><span class="w">        </span><span class="err">│</span><span class="w">                                               </span><span class="err">│</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──────┬───────┘</span><span class="w">                                              </span><span class="err">│</span>
<span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w">                                                       </span><span class="err">│</span>
<span class="err">│</span><span class="w">          </span><span class="err">▼</span><span class="w">                                                       </span><span class="err">│</span>
<span class="err">│</span><span class="w">   </span><span class="err">┌──────────────────┐</span><span class="w">                                          </span><span class="err">│</span>
<span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="n">연결</span><span class="w">            </span><span class="err">│</span><span class="w"> </span><span class="err">──▶</span><span class="w">  </span><span class="ss">&quot;x9Kp2mQ...&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;MyP@ssw0rd!&quot;</span><span class="w">      </span><span class="err">│</span>
<span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="n">salt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="err">│</span><span class="w">                                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──────┬───────────┘</span><span class="w">                                          </span><span class="err">│</span>
<span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w">                                                       </span><span class="err">│</span>
<span class="err">│</span><span class="w">          </span><span class="err">▼</span><span class="w">                                                       </span><span class="err">│</span>
<span class="err">│</span><span class="w">   </span><span class="err">┌──────────────────┐</span><span class="w">                                          </span><span class="err">│</span>
<span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="n">키</span><span class="w"> </span><span class="n">스트레칭</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="err">──▶</span><span class="w">  </span><span class="mi">100</span><span class="p">,</span><span class="mi">000</span><span class="o">+</span><span class="w"> </span><span class="n">회</span><span class="w"> </span><span class="n">반복</span><span class="w"> </span><span class="n">해시</span><span class="w">               </span><span class="err">│</span>
<span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="p">(</span><span class="n">bcrypt</span><span class="o">/</span><span class="n">argon2</span><span class="p">)</span><span class="w"> </span><span class="err">│</span><span class="w">      </span><span class="n">또는</span><span class="w"> </span><span class="n">메모리</span><span class="w"> </span><span class="n">하드</span><span class="w"> </span><span class="n">함수</span><span class="w">                </span><span class="err">│</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──────┬───────────┘</span><span class="w">                                          </span><span class="err">│</span>
<span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w">                                                       </span><span class="err">│</span>
<span class="err">│</span><span class="w">          </span><span class="err">▼</span><span class="w">                                                       </span><span class="err">│</span>
<span class="err">│</span><span class="w">   </span><span class="ss">&quot;$2b$12$x9Kp2mQ.../hashed_output&quot;</span><span class="w">                            </span><span class="err">│</span>
<span class="err">│</span><span class="w">   </span><span class="p">(</span><span class="n">솔트</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">해시가</span><span class="w"> </span><span class="n">함께</span><span class="w"> </span><span class="n">저장됨</span><span class="p">)</span><span class="w">                                     </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre></div>

<p><strong>권장 알고리즘 (우선순위 순서):</strong></p>
<table>
<thead>
<tr>
<th>알고리즘</th>
<th>유형</th>
<th>주요 특징</th>
<th>권장 파라미터</th>
</tr>
</thead>
<tbody>
<tr>
<td>Argon2id</td>
<td>메모리 하드</td>
<td>GPU/ASIC 저항</td>
<td>m=65536, t=3, p=4</td>
</tr>
<tr>
<td>bcrypt</td>
<td>CPU 하드</td>
<td>널리 지원됨</td>
<td>비용 계수 12+</td>
</tr>
<tr>
<td>scrypt</td>
<td>메모리 하드</td>
<td>좋은 대안</td>
<td>N=2^15, r=8, p=1</td>
</tr>
<tr>
<td>PBKDF2</td>
<td>반복 기반</td>
<td>NIST 승인</td>
<td>600,000+ 반복 (SHA-256)</td>
</tr>
</tbody>
</table>
<h3 id="14-python">1.4 Python 구현: 비밀번호 해싱<a class="header-link" href="#14-python" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">password_hashing.py - bcrypt와 argon2를 사용한 안전한 비밀번호 저장</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">bcrypt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># 방법 1: bcrypt (가장 널리 사용됨)</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">hash_password_bcrypt</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;자동 솔팅을 사용하여 bcrypt로 비밀번호 해시&quot;&quot;&quot;</span>
    <span class="c1"># bcrypt는 자동으로 솔트를 생성하고 출력에 포함시킴</span>
    <span class="c1"># 비용 계수(라운드)는 계산 시간을 제어: 2^라운드 반복</span>
    <span class="n">password_bytes</span> <span class="o">=</span> <span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">salt</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">gensalt</span><span class="p">(</span><span class="n">rounds</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>  <span class="c1"># 2^12 = 4096 반복</span>
    <span class="n">hashed</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">password_bytes</span><span class="p">,</span> <span class="n">salt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hashed</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">verify_password_bcrypt</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stored_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;bcrypt 해시에 대해 비밀번호 검증&quot;&quot;&quot;</span>
    <span class="n">password_bytes</span> <span class="o">=</span> <span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">stored_bytes</span> <span class="o">=</span> <span class="n">stored_hash</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="n">password_bytes</span><span class="p">,</span> <span class="n">stored_bytes</span><span class="p">)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># 방법 2: Argon2 (OWASP 권장)</span>
<span class="c1"># ==============================================================</span>

<span class="c1"># pip install argon2-cffi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">argon2</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHasher</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">argon2.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">VerifyMismatchError</span>

<span class="k">def</span><span class="w"> </span><span class="nf">hash_password_argon2</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Argon2id를 사용하여 비밀번호 해시&quot;&quot;&quot;</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">PasswordHasher</span><span class="p">(</span>
        <span class="n">time_cost</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>        <span class="c1"># 반복 횟수</span>
        <span class="n">memory_cost</span><span class="o">=</span><span class="mi">65536</span><span class="p">,</span>   <span class="c1"># 64 MB 메모리</span>
        <span class="n">parallelism</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>       <span class="c1"># 병렬 스레드 수</span>
        <span class="n">hash_len</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>         <span class="c1"># 해시 출력 길이</span>
        <span class="n">salt_len</span><span class="o">=</span><span class="mi">16</span>          <span class="c1"># 랜덤 솔트 길이</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ph</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">verify_password_argon2</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stored_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Argon2 해시에 대해 비밀번호 검증&quot;&quot;&quot;</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">PasswordHasher</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ph</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">stored_hash</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">VerifyMismatchError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># 방법 3: PBKDF2 (Python 내장, 외부 의존성 없음)</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">hash_password_pbkdf2</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;PBKDF2-HMAC-SHA256을 사용하여 비밀번호 해시&quot;&quot;&quot;</span>
    <span class="n">salt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>  <span class="c1"># 32바이트 랜덤 솔트</span>
    <span class="n">iterations</span> <span class="o">=</span> <span class="mi">600_000</span>   <span class="c1"># SHA-256에 대한 OWASP 권장 최소값</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">pbkdf2_hmac</span><span class="p">(</span>
        <span class="s1">&#39;sha256&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
        <span class="n">salt</span><span class="p">,</span>
        <span class="n">iterations</span><span class="p">,</span>
        <span class="n">dklen</span><span class="o">=</span><span class="mi">32</span>
    <span class="p">)</span>

    <span class="c1"># 솔트 + 반복 횟수 + 해시를 함께 저장</span>
    <span class="c1"># 형식: iterations$salt_hex$hash_hex</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="s2">$</span><span class="si">{</span><span class="n">salt</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">$</span><span class="si">{</span><span class="n">key</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">verify_password_pbkdf2</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stored</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;PBKDF2 해시에 대해 비밀번호 검증&quot;&quot;&quot;</span>
    <span class="n">iterations_str</span><span class="p">,</span> <span class="n">salt_hex</span><span class="p">,</span> <span class="n">hash_hex</span> <span class="o">=</span> <span class="n">stored</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)</span>
    <span class="n">iterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">iterations_str</span><span class="p">)</span>
    <span class="n">salt</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">salt_hex</span><span class="p">)</span>
    <span class="n">stored_key</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">hash_hex</span><span class="p">)</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">pbkdf2_hmac</span><span class="p">(</span>
        <span class="s1">&#39;sha256&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
        <span class="n">salt</span><span class="p">,</span>
        <span class="n">iterations</span><span class="p">,</span>
        <span class="n">dklen</span><span class="o">=</span><span class="mi">32</span>
    <span class="p">)</span>

    <span class="c1"># 타이밍 공격 방지를 위한 상수 시간 비교 사용</span>
    <span class="k">return</span> <span class="n">secrets</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">stored_key</span><span class="p">)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># 데모</span>
<span class="c1"># ==============================================================</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_password</span> <span class="o">=</span> <span class="s2">&quot;MySecureP@ssw0rd!&quot;</span>

    <span class="c1"># bcrypt</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== bcrypt ===&quot;</span><span class="p">)</span>
    <span class="n">hashed</span> <span class="o">=</span> <span class="n">hash_password_bcrypt</span><span class="p">(</span><span class="n">test_password</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash: </span><span class="si">{</span><span class="n">hashed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verify (correct): </span><span class="si">{</span><span class="n">verify_password_bcrypt</span><span class="p">(</span><span class="n">test_password</span><span class="p">,</span><span class="w"> </span><span class="n">hashed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verify (wrong):   </span><span class="si">{</span><span class="n">verify_password_bcrypt</span><span class="p">(</span><span class="s1">&#39;wrong&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">hashed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Argon2</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Argon2id ===&quot;</span><span class="p">)</span>
    <span class="n">hashed</span> <span class="o">=</span> <span class="n">hash_password_argon2</span><span class="p">(</span><span class="n">test_password</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash: </span><span class="si">{</span><span class="n">hashed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verify (correct): </span><span class="si">{</span><span class="n">verify_password_argon2</span><span class="p">(</span><span class="n">test_password</span><span class="p">,</span><span class="w"> </span><span class="n">hashed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verify (wrong):   </span><span class="si">{</span><span class="n">verify_password_argon2</span><span class="p">(</span><span class="s1">&#39;wrong&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">hashed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># PBKDF2</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== PBKDF2 ===&quot;</span><span class="p">)</span>
    <span class="n">hashed</span> <span class="o">=</span> <span class="n">hash_password_pbkdf2</span><span class="p">(</span><span class="n">test_password</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash: </span><span class="si">{</span><span class="n">hashed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verify (correct): </span><span class="si">{</span><span class="n">verify_password_pbkdf2</span><span class="p">(</span><span class="n">test_password</span><span class="p">,</span><span class="w"> </span><span class="n">hashed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verify (wrong):   </span><span class="si">{</span><span class="n">verify_password_pbkdf2</span><span class="p">(</span><span class="s1">&#39;wrong&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">hashed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="15">1.5 비밀번호 정책<a class="header-link" href="#15" title="Permanent link">&para;</a></h3>
<p>강력한 비밀번호만으로는 충분하지 않습니다. 포괄적인 비밀번호 정책은 다음을 포함합니다:</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│               현대 비밀번호 정책 (NIST SP 800-63B)                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  해야 할 것:                                                      │
│  ✓ 최소 8자 (12자 이상 권장)                                      │
│  ✓ 최대 64자 이상 허용                                            │
│  ✓ 모든 출력 가능한 ASCII + Unicode 문자 허용                      │
│  ✓ 침해된 비밀번호 목록 확인 (haveibeenpwned.com)                  │
│  ✓ 일반적인 비밀번호 확인 (password, 123456 등)                    │
│  ✓ 비밀번호 필드에 붙여넣기 허용 (비밀번호 관리자용)                │
│  ✓ 비밀번호 강도 측정기 표시                                       │
│                                                                  │
│  하지 말아야 할 것:                                                │
│  ✗ 임의의 복잡성 규칙 강제 (대문자 + 숫자 + ...)                   │
│  ✗ 정기적인 비밀번호 변경 강제 (침해 의심 시 제외)                  │
│  ✗ 비밀번호 힌트 또는 지식 기반 질문 사용                           │
│  ✗ 비밀번호 자동 자르기                                            │
│  ✗ 비밀번호 복구에 SMS 사용 (SIM 스와핑 공격)                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">password_policy.py - NIST 지침에 따른 현대적 비밀번호 검증</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span>


<span class="c1"># 일반 비밀번호 목록 (상위 20개 - 실제로는 훨씬 큰 목록 사용)</span>
<span class="n">COMMON_PASSWORDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">,</span> <span class="s2">&quot;123456789&quot;</span><span class="p">,</span> <span class="s2">&quot;12345678&quot;</span><span class="p">,</span> <span class="s2">&quot;12345&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1234567&quot;</span><span class="p">,</span> <span class="s2">&quot;qwerty&quot;</span><span class="p">,</span> <span class="s2">&quot;abc123&quot;</span><span class="p">,</span> <span class="s2">&quot;password1&quot;</span><span class="p">,</span> <span class="s2">&quot;111111&quot;</span><span class="p">,</span>
    <span class="s2">&quot;iloveyou&quot;</span><span class="p">,</span> <span class="s2">&quot;1234567890&quot;</span><span class="p">,</span> <span class="s2">&quot;123123&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;letmein&quot;</span><span class="p">,</span>
    <span class="s2">&quot;welcome&quot;</span><span class="p">,</span> <span class="s2">&quot;monkey&quot;</span><span class="p">,</span> <span class="s2">&quot;dragon&quot;</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">,</span> <span class="s2">&quot;000000&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_password_strength</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    현대 보안 지침에 따라 비밀번호 검증.</span>
<span class="sd">    (is_valid, 문제점_목록) 반환.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># 길이 확인 (NIST 최소: 8, 권장: 12+)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;비밀번호는 최소 8자 이상이어야 합니다&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
        <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;경고: 더 나은 보안을 위해 12자 이상 권장됩니다&quot;</span><span class="p">)</span>

    <span class="c1"># 일반 비밀번호 확인</span>
    <span class="k">if</span> <span class="n">password</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">COMMON_PASSWORDS</span><span class="p">:</span>
        <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;일반적으로 사용되는 비밀번호입니다&quot;</span><span class="p">)</span>

    <span class="c1"># 반복 패턴 확인</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(.)\1+$&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;비밀번호는 단일 반복 문자일 수 없습니다&quot;</span><span class="p">)</span>

    <span class="c1"># 순차 패턴 확인</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(012|123|234|345|456|567|678|789|890)&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;경고: 순차적 숫자 패턴 포함&quot;</span><span class="p">)</span>

    <span class="c1"># 컨텍스트별 확인 (사용자 이름, 이메일 등 포함)</span>
    <span class="c1"># 실제 환경에서는 사용자 개인 정보도 확인</span>

    <span class="n">is_valid</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
        <span class="ow">not</span> <span class="n">issue</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;경고&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">issues</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">is_valid</span><span class="p">,</span> <span class="n">issues</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_breached_password</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Have I Been Pwned API를 사용하여 알려진 침해에서</span>
<span class="sd">    비밀번호가 나타나는지 확인 (k-익명성 모델 - SHA-1 해시의</span>
<span class="sd">    처음 5자만 전송).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sha1</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;https://api.pwnedpasswords.com/range/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

        <span class="c1"># 응답은 &quot;SUFFIX:COUNT&quot; 형식의 라인들을 포함</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">hash_suffix</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hash_suffix</span> <span class="o">==</span> <span class="n">suffix</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># 비밀번호가 침해됨</span>

        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># 침해에서 발견되지 않음</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span><span class="p">:</span>
        <span class="c1"># API를 사용할 수 없으면 실패를 허용 (하지만 오류는 기록)</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_passwords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;short&quot;</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MyStr0ng&amp;Secure!Pass&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aaaaaaaaaaaa&quot;</span><span class="p">,</span>
        <span class="s2">&quot;12345678&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">pwd</span> <span class="ow">in</span> <span class="n">test_passwords</span><span class="p">:</span>
        <span class="n">is_valid</span><span class="p">,</span> <span class="n">issues</span> <span class="o">=</span> <span class="n">check_password_strength</span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;통과&quot;</span> <span class="k">if</span> <span class="n">is_valid</span> <span class="k">else</span> <span class="s2">&quot;실패&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">] &#39;</span><span class="si">{</span><span class="n">pwd</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">issues</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">issue</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="2-mfa">2. 다중 인증 (MFA)<a class="header-link" href="#2-mfa" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 인증 요소<a class="header-link" href="#21" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│                  인증 요소                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  요소 1: 아는 것 (Something You KNOW)                            │
│  ├── 비밀번호                                                     │
│  ├── PIN                                                         │
│  └── 보안 질문 (권장하지 않음)                                     │
│                                                                  │
│  요소 2: 가진 것 (Something You HAVE)                            │
│  ├── 스마트폰 (TOTP 앱)                                           │
│  ├── 하드웨어 보안 키 (YubiKey, Titan)                            │
│  ├── 스마트 카드                                                  │
│  └── SMS (약함 - SIM 스와핑 위험)                                 │
│                                                                  │
│  요소 3: 본인 자체 (Something You ARE)                            │
│  ├── 지문                                                        │
│  ├── 얼굴 인식                                                    │
│  ├── 홍채 스캔                                                    │
│  └── 음성 인식                                                    │
│                                                                  │
│  MFA = 2개 이상의 다른 요소 결합                                  │
│  (비밀번호 + TOTP = 2FA, 하지만 두 개의 비밀번호 ≠ 2FA)         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="22-totp">2.2 TOTP (시간 기반 일회용 비밀번호)<a class="header-link" href="#22-totp" title="Permanent link">&para;</a></h3>
<p>TOTP는 공유 비밀과 현재 시간을 기반으로 짧은 수명의 코드를 생성합니다. RFC 6238에 정의되어 있습니다.</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│                     TOTP 알고리즘                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  설정 (일회성):                                                   │
│  1. 서버가 랜덤 비밀 키 생성 (base32 인코딩)                       │
│  2. 서버가 QR 코드를 통해 사용자와 비밀 공유                        │
│  3. 사용자가 인증 앱으로 QR 코드 스캔                              │
│                                                                  │
│  검증 (각 로그인):                                                │
│                                                                  │
│       공유 비밀              현재 시간                              │
│            │                          │                          │
│            ▼                          ▼                          │
│       ┌─────────┐            ┌──────────────┐                   │
│       │ 비밀    │            │  T = floor   │                    │
│       │  키     │            │  (time / 30) │                    │
│       └────┬────┘            └──────┬───────┘                   │
│            │                        │                            │
│            └────────┬───────────────┘                            │
│                     │                                            │
│                     ▼                                            │
│              ┌─────────────┐                                    │
│              │ HMAC-SHA1   │                                    │
│              │ (secret, T) │                                    │
│              └──────┬──────┘                                    │
│                     │                                            │
│                     ▼                                            │
│              ┌─────────────┐                                    │
│              │ 6자리로     │                                    │
│              │  축약       │                                    │
│              └──────┬──────┘                                    │
│                     │                                            │
│                     ▼                                            │
│                  &quot;482916&quot;   (30초 동안 유효)                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">totp_example.py - pyotp를 사용한 TOTP 구현</span>
<span class="sd">pip install pyotp qrcode[pil]</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyotp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">qrcode</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TOTPManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;TOTP 기반 2단계 인증 관리&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secrets</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 실제 환경에서는 암호화된 데이터베이스에 저장</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">enroll_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">issuer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;MyApp&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        새 사용자를 위한 TOTP 비밀 생성.</span>
<span class="sd">        QR 코드 생성을 위한 프로비저닝 URI 반환.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 랜덤 base32 비밀 생성 (160 비트)</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="n">pyotp</span><span class="o">.</span><span class="n">random_base32</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secrets</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">secret</span>

        <span class="c1"># 인증 앱을 위한 프로비저닝 URI 생성</span>
        <span class="n">totp</span> <span class="o">=</span> <span class="n">pyotp</span><span class="o">.</span><span class="n">TOTP</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">totp</span><span class="o">.</span><span class="n">provisioning_uri</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
            <span class="n">issuer_name</span><span class="o">=</span><span class="n">issuer</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">uri</span><span class="p">,</span> <span class="n">secret</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_qr_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;totp_qr.png&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;프로비저닝 URI로부터 QR 코드 이미지 생성&quot;&quot;&quot;</span>
        <span class="n">qr</span> <span class="o">=</span> <span class="n">qrcode</span><span class="o">.</span><span class="n">QRCode</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">box_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">qr</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="n">qr</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">qr</span><span class="o">.</span><span class="n">make_image</span><span class="p">(</span><span class="n">fill_color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">back_color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;QR code saved to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">verify_totp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        주어진 사용자에 대한 TOTP 코드 검증.</span>
<span class="sd">        1 기간의 클럭 드리프트 허용 (±30초).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">secrets</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secrets</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
        <span class="n">totp</span> <span class="o">=</span> <span class="n">pyotp</span><span class="o">.</span><span class="n">TOTP</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span>

        <span class="c1"># valid_window=1은 t-1 및 t+1 기간의 코드 허용</span>
        <span class="k">return</span> <span class="n">totp</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">valid_window</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;현재 TOTP 코드 가져오기 (테스트 전용)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">secrets</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secrets</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
        <span class="n">totp</span> <span class="o">=</span> <span class="n">pyotp</span><span class="o">.</span><span class="n">TOTP</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">totp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>


<span class="c1"># 계정 복구를 위한 백업 코드</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_backup_codes</span><span class="p">(</span><span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    일회용 백업 코드 생성.</span>
<span class="sd">    각 코드는 8자, 영숫자.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
    <span class="n">codes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="c1"># 8개의 16진수 문자</span>
        <span class="c1"># 가독성을 위해 XXXX-XXXX 형식으로 포맷</span>
        <span class="n">formatted</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">code</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">code</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">codes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatted</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">codes</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">TOTPManager</span><span class="p">()</span>

    <span class="c1"># 사용자 등록</span>
    <span class="n">uri</span><span class="p">,</span> <span class="n">secret</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">enroll_user</span><span class="p">(</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Secret: </span><span class="si">{</span><span class="n">secret</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;URI: </span><span class="si">{</span><span class="n">uri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 현재 코드 생성</span>
    <span class="n">current_code</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_current_code</span><span class="p">(</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Current TOTP code: </span><span class="si">{</span><span class="n">current_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 검증</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verification: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">verify_totp</span><span class="p">(</span><span class="s1">&#39;alice@example.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">current_code</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong code:   </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">verify_totp</span><span class="p">(</span><span class="s1">&#39;alice@example.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;000000&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 백업 코드 생성</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Backup Codes:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">generate_backup_codes</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="23-fido2-webauthn">2.3 FIDO2 / WebAuthn<a class="header-link" href="#23-fido2-webauthn" title="Permanent link">&para;</a></h3>
<p>FIDO2(Fast Identity Online)와 그 웹 컴포넌트인 WebAuthn은 오늘날 사용 가능한 가장 강력한 인증 형태를 나타냅니다. 공개키 암호화를 사용하며 피싱에 저항력이 있습니다.</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│                  WebAuthn 등록 플로우                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   브라우저 (클라이언트)     서버 (신뢰 당사자)                       │
│        │                          │                              │
│        │   1. 챌린지 요청         │                              │
│        │ ──────────────────────▶  │                              │
│        │                          │                              │
│        │   2. 챌린지 +            │                              │
│        │      RP 정보 + 사용자 정보│                              │
│        │ ◀──────────────────────  │                              │
│        │                          │                              │
│   ┌────┴────┐                     │                              │
│   │ 브라우저│                     │                              │
│   │ 사용자에게│                    │                              │
│   │ 키 터치 │                     │                              │
│   │ 또는    │                     │                              │
│   │ 생체인증│                     │                              │
│   │ 사용    │                     │                              │
│   │ 프롬프트│                     │                              │
│   └────┬────┘                     │                              │
│        │                          │                              │
│   ┌────┴──────────────┐          │                              │
│   │ 인증기가          │          │                              │
│   │ 새 키 쌍 생성:     │          │                              │
│   │ - 개인 키         │          │                              │
│   │   (키에 저장)      │          │                              │
│   │ - 공개 키         │          │                              │
│   │   (서버로 전송)    │          │                              │
│   └────┬──────────────┘          │                              │
│        │                          │                              │
│        │   3. 공개 키 +           │                              │
│        │      서명된 챌린지       │                              │
│        │ ──────────────────────▶  │                              │
│        │                          │                              │
│        │                    ┌─────┴─────┐                       │
│        │                    │ 서명      │                        │
│        │                    │ 검증      │                        │
│        │                    │ 공개 키   │                        │
│        │                    │ 저장      │                        │
│        │                    └─────┬─────┘                       │
│        │                          │                              │
│        │   4. 등록 완료           │                              │
│        │ ◀──────────────────────  │                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<p><strong>WebAuthn의 주요 장점:</strong></p>
<table>
<thead>
<tr>
<th>특징</th>
<th>비밀번호</th>
<th>TOTP</th>
<th>WebAuthn/FIDO2</th>
</tr>
</thead>
<tbody>
<tr>
<td>피싱 저항</td>
<td>아니오</td>
<td>아니오</td>
<td>예</td>
</tr>
<tr>
<td>서버에 공유 비밀 없음</td>
<td>아니오</td>
<td>아니오</td>
<td>예 (공개 키만)</td>
</tr>
<tr>
<td>사용자 노력</td>
<td>높음 (암기)</td>
<td>중간 (코드 복사)</td>
<td>낮음 (터치/생체인증)</td>
</tr>
<tr>
<td>재생 공격</td>
<td>취약</td>
<td>시간 제한</td>
<td>불가능</td>
</tr>
<tr>
<td>침해 영향</td>
<td>높음</td>
<td>중간</td>
<td>최소</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3-oauth-20-openid-connect">3. OAuth 2.0 및 OpenID Connect<a class="header-link" href="#3-oauth-20-openid-connect" title="Permanent link">&para;</a></h2>
<h3 id="31-oauth-20">3.1 OAuth 2.0 개요<a class="header-link" href="#31-oauth-20" title="Permanent link">&para;</a></h3>
<p>OAuth 2.0은 <strong>권한 부여(authorization)</strong> 프레임워크입니다(인증이 아님). 사용자의 자격 증명을 공유하지 않고 제3자 애플리케이션이 사용자를 대신하여 리소스에 접근할 수 있도록 합니다.</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│                    OAuth 2.0 역할                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  리소스 소유자   = 데이터를 소유한 사용자                          │
│  클라이언트      = 접근을 요청하는 애플리케이션                     │
│  권한 부여       = 사용자를 인증하고                               │
│    서버            토큰을 발행하는 서버 (예: Google, GitHub)       │
│  리소스 서버     = 보호된 리소스를 보유한 API 서버                 │
│                                                                  │
│  예시:                                                           │
│  &quot;MyApp이 Google 캘린더에 접근하려고 합니다&quot;                       │
│                                                                  │
│  리소스 소유자    = 당신 (Google 사용자)                          │
│  클라이언트       = MyApp                                         │
│  권한 부여        = accounts.google.com                          │
│    서버                                                          │
│  리소스 서버      = calendar.googleapis.com                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="32">3.2 권한 부여 코드 플로우 (가장 일반적)<a class="header-link" href="#32" title="Permanent link">&para;</a></h3>
<p>서버 측 웹 애플리케이션에 권장되는 플로우입니다.</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│          OAuth 2.0 권한 부여 코드 플로우                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  사용자      클라이언트 앱     인증 서버      리소스 서버          │
│   │              │                │                  │            │
│   │  1. 클릭     │                │                  │            │
│   │  &quot;Google로   │                │                  │            │
│   │   로그인&quot;    │                │                  │            │
│   │─────────────▶│                │                  │            │
│   │              │                │                  │            │
│   │              │  2. 인증 URL로 │                  │            │
│   │              │  리디렉션      │                  │            │
│   │◀─────────────│                │                  │            │
│   │              │                │                  │            │
│   │  3. 사용자가 로그인하고       │                  │            │
│   │     권한 동의                 │                  │            │
│   │─────────────────────────────▶│                  │            │
│   │              │                │                  │            │
│   │  4. 권한 부여 코드와          │                  │            │
│   │     함께 리디렉션             │                  │            │
│   │◀─────────────────────────────│                  │            │
│   │              │                │                  │            │
│   │─────────────▶│                │                  │            │
│   │  (code)      │                │                  │            │
│   │              │  5. 코드를     │                  │            │
│   │              │  토큰으로      │                  │            │
│   │              │  교환          │                  │            │
│   │              │───────────────▶│                  │            │
│   │              │                │                  │            │
│   │              │  6. 접근 +     │                  │            │
│   │              │  갱신 토큰     │                  │            │
│   │              │◀───────────────│                  │            │
│   │              │                │                  │            │
│   │              │  7. 접근 토큰과 함께 API 요청     │            │
│   │              │──────────────────────────────────▶│            │
│   │              │                │                  │            │
│   │              │  8. 보호된 리소스                 │            │
│   │              │◀──────────────────────────────────│            │
│   │              │                │                  │            │
│   │  9. 응답     │                │                  │            │
│   │◀─────────────│                │                  │            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="33-pkce">3.3 PKCE를 사용한 권한 부여 코드 플로우<a class="header-link" href="#33-pkce" title="Permanent link">&para;</a></h3>
<p>PKCE(Proof Key for Code Exchange)는 공개 클라이언트(SPA, 모바일 앱)에 <strong>필수</strong>이며 모든 클라이언트에 권장됩니다.</p>
<div class="highlight"><pre><span></span><code><span class="err">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="err">│</span><span class="w">                      </span><span class="nx">PKCE</span><span class="w"> </span><span class="nx">확장</span><span class="w">                                   </span><span class="err">│</span>
<span class="err">├─────────────────────────────────────────────────────────────────┤</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="nx">리디렉션</span><span class="w"> </span><span class="nx">전</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="nx">단계</span><span class="p">):</span><span class="w">                                             </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="nx">클라이언트가</span><span class="w"> </span><span class="nx">랜덤</span><span class="w"> </span><span class="s">&quot;code_verifier&quot;</span><span class="w"> </span><span class="nx">생성</span><span class="w">                        </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="nx">code_verifier</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">random_string</span><span class="p">(</span><span class="mi">43</span><span class="o">-</span><span class="mi">128</span><span class="w"> </span><span class="nx">chars</span><span class="p">)</span><span class="w">                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="nx">클라이언트가</span><span class="w"> </span><span class="s">&quot;code_challenge&quot;</span><span class="w"> </span><span class="nx">계산</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="nx">code_challenge</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">BASE64URL</span><span class="p">(</span><span class="nx">SHA256</span><span class="p">(</span><span class="nx">code_verifier</span><span class="p">))</span><span class="w">            </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="nx">클라이언트가</span><span class="w"> </span><span class="nx">권한</span><span class="w"> </span><span class="nx">부여</span><span class="w"> </span><span class="nx">요청에</span><span class="w"> </span><span class="nx">code_challenge</span><span class="w"> </span><span class="nx">전송</span><span class="w">             </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">authorize</span><span class="p">?</span><span class="w">                                              </span><span class="err">│</span>
<span class="err">│</span><span class="w">       </span><span class="nx">response_type</span><span class="p">=</span><span class="nx">code</span><span class="o">&amp;</span><span class="w">                                        </span><span class="err">│</span>
<span class="err">│</span><span class="w">       </span><span class="nx">client_id</span><span class="p">=</span><span class="o">...&amp;</span><span class="w">                                             </span><span class="err">│</span>
<span class="err">│</span><span class="w">       </span><span class="nx">code_challenge</span><span class="p">=</span><span class="o">...&amp;</span><span class="w">                                        </span><span class="err">│</span>
<span class="err">│</span><span class="w">       </span><span class="nx">code_challenge_method</span><span class="p">=</span><span class="nx">S256</span><span class="w">                                 </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="nx">토큰</span><span class="w"> </span><span class="nx">교환</span><span class="w"> </span><span class="nx">시</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="nx">단계</span><span class="p">):</span><span class="w">                                            </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="nx">클라이언트가</span><span class="w"> </span><span class="nx">토큰</span><span class="w"> </span><span class="nx">요청과</span><span class="w"> </span><span class="nx">함께</span><span class="w"> </span><span class="nx">code_verifier</span><span class="w"> </span><span class="nx">전송</span><span class="w">              </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">token</span><span class="w">                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">       </span><span class="nx">grant_type</span><span class="p">=</span><span class="nx">authorization_code</span><span class="o">&amp;</span><span class="w">                             </span><span class="err">│</span>
<span class="err">│</span><span class="w">       </span><span class="nx">code</span><span class="p">=</span><span class="o">...&amp;</span><span class="w">                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">       </span><span class="nx">code_verifier</span><span class="p">=</span><span class="o">...</span><span class="w">                                          </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="nx">서버가</span><span class="w"> </span><span class="nx">검증</span><span class="p">:</span><span class="w">                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="nx">BASE64URL</span><span class="p">(</span><span class="nx">SHA256</span><span class="p">(</span><span class="nx">code_verifier</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">stored</span><span class="w"> </span><span class="nx">code_challenge</span><span class="w">    </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="nx">이유</span><span class="p">?</span><span class="w"> </span><span class="nx">권한</span><span class="w"> </span><span class="nx">부여</span><span class="w"> </span><span class="nx">코드</span><span class="w"> </span><span class="nx">가로채기</span><span class="w"> </span><span class="nx">공격</span><span class="w"> </span><span class="nx">방지</span><span class="p">.</span><span class="w">                          </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="nx">코드를</span><span class="w"> </span><span class="nx">훔친</span><span class="w"> </span><span class="nx">공격자는</span><span class="w"> </span><span class="nx">code_verifier</span><span class="w"> </span><span class="nx">없이는</span><span class="w"> </span><span class="nx">교환할</span><span class="w"> </span><span class="nx">수</span><span class="w"> </span><span class="nx">없음</span><span class="p">.</span><span class="w">         </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre></div>

<h3 id="34-openid-connect-oidc">3.4 OpenID Connect (OIDC)<a class="header-link" href="#34-openid-connect-oidc" title="Permanent link">&para;</a></h3>
<p>OpenID Connect는 OAuth 2.0 위에 구축된 <strong>인증(authentication)</strong> 레이어입니다. OAuth 2.0이 권한 부여를 제공하는 반면("이 앱은 캘린더에 접근할 수 있음"), OIDC는 인증을 제공합니다("이 사용자는 alice@example.com입니다").</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│<span class="w">              </span><span class="nv">OAuth</span><span class="w"> </span><span class="mi">2</span>.<span class="mi">0</span><span class="w"> </span><span class="nv">vs</span><span class="w"> </span><span class="nv">OpenID</span><span class="w"> </span><span class="k">Connect</span><span class="w">                         </span>│
├─────────────────────────────────────────────────────────────────┤
│<span class="w">                                                                  </span>│
│<span class="w">  </span><span class="nv">OAuth</span><span class="w"> </span><span class="mi">2</span>.<span class="mi">0</span>:<span class="w">                                                      </span>│
│<span class="w">  </span><span class="o">-</span><span class="w"> </span>목적:<span class="w"> </span>권한<span class="w"> </span>부여<span class="w"> </span><span class="ss">(</span>접근<span class="w"> </span>위임<span class="ss">)</span><span class="w">                                    </span>│
│<span class="w">  </span><span class="o">-</span><span class="w"> </span>토큰:<span class="w"> </span>접근<span class="w"> </span>토큰<span class="w"> </span><span class="ss">(</span>불투명<span class="w"> </span>또는<span class="w"> </span><span class="nv">JWT</span><span class="ss">)</span><span class="w">                              </span>│
│<span class="w">  </span><span class="o">-</span><span class="w"> </span>답하는<span class="w"> </span>질문:<span class="w"> </span><span class="s2">&quot;이 앱은 무엇을 할 수 있는가?&quot;</span><span class="w">                     </span>│
│<span class="w">                                                                  </span>│
│<span class="w">  </span><span class="nv">OpenID</span><span class="w"> </span><span class="k">Connect</span><span class="w"> </span><span class="ss">(</span><span class="nv">OIDC</span><span class="ss">)</span>:<span class="w">                                          </span>│
│<span class="w">  </span><span class="o">-</span><span class="w"> </span>목적:<span class="w"> </span>인증<span class="w"> </span><span class="ss">(</span>신원<span class="w"> </span>검증<span class="ss">)</span><span class="w">                                         </span>│
│<span class="w">  </span><span class="o">-</span><span class="w"> </span>토큰:<span class="w"> </span><span class="nv">ID</span><span class="w"> </span>토큰<span class="w"> </span><span class="ss">(</span>항상<span class="w"> </span><span class="nv">JWT</span><span class="ss">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>접근<span class="w"> </span>토큰<span class="w">                           </span>│
│<span class="w">  </span><span class="o">-</span><span class="w"> </span>답하는<span class="w"> </span>질문:<span class="w"> </span><span class="s2">&quot;이 사용자는 누구인가?&quot;</span><span class="w">                            </span>│
│<span class="w">  </span><span class="o">-</span><span class="w"> </span>추가:<span class="w"> </span><span class="nv">UserInfo</span><span class="w"> </span>엔드포인트,<span class="w"> </span>표준<span class="w"> </span>클레임<span class="w"> </span><span class="ss">(</span><span class="nv">sub</span>,<span class="w"> </span><span class="nv">email</span>,<span class="w"> </span><span class="nv">name</span><span class="ss">)</span><span class="w">      </span>│
│<span class="w">  </span><span class="o">-</span><span class="w"> </span>스코프:<span class="w"> </span><span class="s2">&quot;openid&quot;</span><span class="w"> </span><span class="ss">(</span>필수<span class="ss">)</span>,<span class="w"> </span><span class="s2">&quot;profile&quot;</span>,<span class="w"> </span><span class="s2">&quot;email&quot;</span><span class="w">                   </span>│
│<span class="w">                                                                  </span>│
│<span class="w">  </span><span class="nv">OIDC</span>는<span class="w"> </span><span class="nv">OAuth</span><span class="w"> </span><span class="mi">2</span>.<span class="mi">0</span><span class="w"> </span>위에<span class="w"> </span>구축됨:<span class="w">                                   </span>│
│<span class="w">  </span>┌─────────────────────────────────┐<span class="w">                            </span>│
│<span class="w">  </span>│<span class="w">       </span><span class="nv">OpenID</span><span class="w"> </span><span class="k">Connect</span><span class="w">            </span>│<span class="w">  </span>←<span class="w"> </span>인증<span class="w">                    </span>│
│<span class="w">  </span>│<span class="w">  </span>┌──────────────────────────┐<span class="w">   </span>│<span class="w">                            </span>│
│<span class="w">  </span>│<span class="w">  </span>│<span class="w">      </span><span class="nv">OAuth</span><span class="w"> </span><span class="mi">2</span>.<span class="mi">0</span><span class="w">           </span>│<span class="w">   </span>│<span class="w">  </span>←<span class="w"> </span>권한<span class="w"> </span>부여<span class="w">               </span>│
│<span class="w">  </span>│<span class="w">  </span>│<span class="w">  </span>┌───────────────────┐<span class="w">   </span>│<span class="w">   </span>│<span class="w">                            </span>│
│<span class="w">  </span>│<span class="w">  </span>│<span class="w">  </span>│<span class="w">     </span><span class="nv">HTTP</span><span class="o">/</span><span class="nv">TLS</span><span class="w">      </span>│<span class="w">   </span>│<span class="w">   </span>│<span class="w">  </span>←<span class="w"> </span>전송<span class="w">                    </span>│
│<span class="w">  </span>│<span class="w">  </span>│<span class="w">  </span>└───────────────────┘<span class="w">   </span>│<span class="w">   </span>│<span class="w">                            </span>│
│<span class="w">  </span>│<span class="w">  </span>└──────────────────────────┘<span class="w">   </span>│<span class="w">                            </span>│
│<span class="w">  </span>└─────────────────────────────────┘<span class="w">                            </span>│
│<span class="w">                                                                  </span>│
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="35-python-oauth-20">3.5 Python 예제: OAuth 2.0 클라이언트<a class="header-link" href="#35-python-oauth-20" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">oauth_client.py - PKCE를 사용한 OAuth 2.0 권한 부여 코드 플로우</span>
<span class="sd">requests-oauthlib 라이브러리 사용</span>
<span class="sd">pip install requests-oauthlib</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlencode</span><span class="p">,</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">parse_qs</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="c1"># OAuth 2.0 설정 (GitHub 예시)</span>
<span class="n">OAUTH_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OAUTH_CLIENT_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;your-client-id&quot;</span><span class="p">),</span>
    <span class="s2">&quot;client_secret&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OAUTH_CLIENT_SECRET&quot;</span><span class="p">,</span> <span class="s2">&quot;your-secret&quot;</span><span class="p">),</span>
    <span class="s2">&quot;authorize_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://github.com/login/oauth/authorize&quot;</span><span class="p">,</span>
    <span class="s2">&quot;token_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://github.com/login/oauth/access_token&quot;</span><span class="p">,</span>
    <span class="s2">&quot;userinfo_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.github.com/user&quot;</span><span class="p">,</span>
    <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="s2">&quot;http://localhost:5000/callback&quot;</span><span class="p">,</span>
    <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot;read:user user:email&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_pkce_pair</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;PKCE code_verifier 및 code_challenge 생성&quot;&quot;&quot;</span>
    <span class="c1"># code_verifier: 43-128자, 예약되지 않은 URI 문자</span>
    <span class="n">code_verifier</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span>
        <span class="n">secrets</span><span class="o">.</span><span class="n">token_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>

    <span class="c1"># code_challenge: BASE64URL(SHA256(code_verifier))</span>
    <span class="n">digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">code_verifier</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
    <span class="n">code_challenge</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">code_verifier</span><span class="p">,</span> <span class="n">code_challenge</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OAuth 2.0 권한 부여 코드 플로우 시작&quot;&quot;&quot;</span>
    <span class="c1"># PKCE 쌍 생성</span>
    <span class="n">code_verifier</span><span class="p">,</span> <span class="n">code_challenge</span> <span class="o">=</span> <span class="n">generate_pkce_pair</span><span class="p">()</span>

    <span class="c1"># CSRF 방지를 위한 state 생성</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

    <span class="c1"># 세션에 저장</span>
    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;oauth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;code_verifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code_verifier</span>

    <span class="c1"># 권한 부여 URL 구축</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">],</span>
        <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;redirect_uri&quot;</span><span class="p">],</span>
        <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">],</span>
        <span class="s2">&quot;response_type&quot;</span><span class="p">:</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span>
        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
        <span class="s2">&quot;code_challenge&quot;</span><span class="p">:</span> <span class="n">code_challenge</span><span class="p">,</span>
        <span class="s2">&quot;code_challenge_method&quot;</span><span class="p">:</span> <span class="s2">&quot;S256&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">auth_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s1">&#39;authorize_url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">auth_url</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/callback&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;권한 부여 코드와 함께 OAuth 2.0 콜백 처리&quot;&quot;&quot;</span>
    <span class="c1"># CSRF 방지를 위한 state 검증</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;oauth_state&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;State mismatch - possible CSRF attack&quot;</span><span class="p">,</span> <span class="mi">403</span>

    <span class="c1"># 오류 확인</span>
    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;OAuth error: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">400</span>

    <span class="c1"># 권한 부여 코드를 토큰으로 교환</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">)</span>
    <span class="n">token_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;token_url&quot;</span><span class="p">],</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;client_secret&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;client_secret&quot;</span><span class="p">],</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
            <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;redirect_uri&quot;</span><span class="p">],</span>
            <span class="s2">&quot;grant_type&quot;</span><span class="p">:</span> <span class="s2">&quot;authorization_code&quot;</span><span class="p">,</span>
            <span class="s2">&quot;code_verifier&quot;</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code_verifier&quot;</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="n">token_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="n">access_token</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;access_token&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">access_token</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Failed to obtain access token&quot;</span><span class="p">,</span> <span class="mi">400</span>

    <span class="c1"># 사용자 정보 가져오기</span>
    <span class="n">user_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;userinfo_url&quot;</span><span class="p">],</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="n">user_info</span> <span class="o">=</span> <span class="n">user_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="c1"># 세션에 사용자 저장</span>
    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
        <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">user_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">),</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">user_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">user_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># OAuth state 정리</span>
    <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;oauth_state&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;code_verifier&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/profile&quot;</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/profile&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">profile</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;사용자 프로필 표시 (보호된 경로)&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/logout&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;세션 지우고 로그아웃&quot;&quot;&quot;</span>
    <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="4">4. 세션 관리<a class="header-link" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 서버 측 세션 (쿠키 기반)<a class="header-link" href="#41" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="err">│</span><span class="w">                </span><span class="nt">서버</span><span class="w"> </span><span class="nt">측</span><span class="w"> </span><span class="nt">세션</span><span class="w"> </span><span class="nt">플로우</span><span class="w">                                 </span><span class="err">│</span>
<span class="err">├─────────────────────────────────────────────────────────────────┤</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="nt">브라우저</span><span class="w">                          </span><span class="nt">서버</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                                </span><span class="err">│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="nt">1</span><span class="o">.</span><span class="w"> </span><span class="nt">POST</span><span class="w"> </span><span class="o">/</span><span class="nt">login</span><span class="w">                </span><span class="err">│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="o">(</span><span class="nt">username</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nt">password</span><span class="o">)</span><span class="w">         </span><span class="err">│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│───────────────────────────────▶│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                                </span><span class="err">│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                          </span><span class="err">┌─────┴─────┐</span><span class="w">                    </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                          </span><span class="err">│</span><span class="w"> </span><span class="nt">검증</span><span class="w">      </span><span class="err">│</span><span class="w">                     </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                          </span><span class="err">│</span><span class="w"> </span><span class="nt">세션</span><span class="w">      </span><span class="err">│</span><span class="w">                     </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                          </span><span class="err">│</span><span class="w"> </span><span class="nt">생성</span><span class="w">      </span><span class="err">│</span><span class="w">                     </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                          </span><span class="err">│</span><span class="w"> </span><span class="nt">ID</span><span class="o">=</span><span class="nt">abc123</span><span class="w"> </span><span class="err">│</span><span class="w">                     </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                          </span><span class="err">│</span><span class="w"> </span><span class="nt">Redis</span><span class="o">/</span><span class="nt">DB에</span><span class="err">│</span><span class="w">                     </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                          </span><span class="err">│</span><span class="w"> </span><span class="nt">저장</span><span class="w">      </span><span class="err">│</span><span class="w">                     </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                          </span><span class="err">└─────┬─────┘</span><span class="w">                    </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                                </span><span class="err">│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="nt">2</span><span class="o">.</span><span class="w"> </span><span class="nt">Set-Cookie</span><span class="o">:</span><span class="w">                </span><span class="err">│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="nt">session_id</span><span class="o">=</span><span class="nt">abc123</span><span class="o">;</span><span class="w">            </span><span class="err">│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="nt">HttpOnly</span><span class="o">;</span><span class="w"> </span><span class="nt">Secure</span><span class="o">;</span><span class="w">             </span><span class="err">│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="nt">SameSite</span><span class="o">=</span><span class="nt">Lax</span><span class="w">                  </span><span class="err">│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│◀───────────────────────────────│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                                </span><span class="err">│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="nt">3</span><span class="o">.</span><span class="w"> </span><span class="nt">GET</span><span class="w"> </span><span class="o">/</span><span class="nt">dashboard</span><span class="w">             </span><span class="err">│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="nt">Cookie</span><span class="o">:</span><span class="w"> </span><span class="nt">session_id</span><span class="o">=</span><span class="nt">abc123</span><span class="w">     </span><span class="err">│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│───────────────────────────────▶│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                          </span><span class="err">┌─────┴─────┐</span><span class="w">                    </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                          </span><span class="err">│</span><span class="w"> </span><span class="nt">저장소에서</span><span class="err">│</span><span class="w">                     </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                          </span><span class="err">│</span><span class="w"> </span><span class="nt">세션</span><span class="w">      </span><span class="err">│</span><span class="w">                     </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                          </span><span class="err">│</span><span class="w"> </span><span class="nt">조회</span><span class="w">      </span><span class="err">│</span><span class="w">                     </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                          </span><span class="err">└─────┬─────┘</span><span class="w">                    </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="nt">4</span><span class="o">.</span><span class="w"> </span><span class="nt">사용자</span><span class="w"> </span><span class="nt">데이터와</span><span class="w"> </span><span class="nt">함께</span><span class="w"> </span><span class="nt">응답</span><span class="w">  </span><span class="err">│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│◀───────────────────────────────│</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre></div>

<h3 id="42">4.2 안전한 쿠키 속성<a class="header-link" href="#42" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nt">Set-Cookie</span><span class="o">:</span><span class="w"> </span><span class="nt">session_id</span><span class="o">=</span><span class="nt">abc123</span><span class="o">;</span>
<span class="w">            </span><span class="nt">HttpOnly</span><span class="o">;</span><span class="w">        </span><span class="err">←</span><span class="w"> </span><span class="nt">JavaScript로</span><span class="w"> </span><span class="nt">접근</span><span class="w"> </span><span class="nt">불가</span><span class="w"> </span><span class="o">(</span><span class="nt">XSS</span><span class="w"> </span><span class="nt">방지</span><span class="o">)</span>
<span class="w">            </span><span class="nt">Secure</span><span class="o">;</span><span class="w">          </span><span class="err">←</span><span class="w"> </span><span class="nt">HTTPS를</span><span class="w"> </span><span class="nt">통해서만</span><span class="w"> </span><span class="nt">전송</span>
<span class="w">            </span><span class="nt">SameSite</span><span class="o">=</span><span class="nt">Lax</span><span class="o">;</span><span class="w">    </span><span class="err">←</span><span class="w"> </span><span class="nt">CSRF</span><span class="w"> </span><span class="nt">방지</span><span class="w"> </span><span class="o">(</span><span class="nt">교차</span><span class="w"> </span><span class="nt">사이트</span><span class="w"> </span><span class="nt">POST에서</span><span class="w"> </span><span class="nt">전송</span><span class="w"> </span><span class="nt">안</span><span class="w"> </span><span class="nt">됨</span><span class="o">)</span>
<span class="w">            </span><span class="nt">Path</span><span class="o">=/;</span><span class="w">          </span><span class="err">←</span><span class="w"> </span><span class="nt">쿠키</span><span class="w"> </span><span class="nt">범위</span>
<span class="w">            </span><span class="nt">Max-Age</span><span class="o">=</span><span class="nt">3600</span><span class="o">;</span><span class="w">    </span><span class="err">←</span><span class="w"> </span><span class="nt">1시간</span><span class="w"> </span><span class="nt">후</span><span class="w"> </span><span class="nt">만료</span>
<span class="w">            </span><span class="nt">Domain</span><span class="o">=</span><span class="p">.</span><span class="nc">app</span><span class="p">.</span><span class="nc">com</span><span class="w">  </span><span class="err">←</span><span class="w"> </span><span class="nt">서브도메인에도</span><span class="w"> </span><span class="nt">전송</span>
</code></pre></div>

<table>
<thead>
<tr>
<th>속성</th>
<th>목적</th>
<th>권장 값</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>HttpOnly</code></td>
<td>XSS로부터 쿠키 읽기 방지</td>
<td>항상 설정</td>
</tr>
<tr>
<td><code>Secure</code></td>
<td>HTTPS 전용</td>
<td>프로덕션에서 항상 설정</td>
</tr>
<tr>
<td><code>SameSite</code></td>
<td>CSRF 방지</td>
<td><code>Lax</code> (또는 민감한 작업에 <code>Strict</code>)</td>
</tr>
<tr>
<td><code>Max-Age</code></td>
<td>세션 지속 시간</td>
<td>민감도에 따라 1-24시간</td>
</tr>
<tr>
<td><code>Path</code></td>
<td>URL 범위</td>
<td><code>/</code> 또는 특정 경로</td>
</tr>
</tbody>
</table>
<h3 id="43">4.3 세션 보안 모범 사례<a class="header-link" href="#43" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">session_security.py - Flask를 사용한 안전한 세션 관리</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># 세션 설정</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">SECRET_KEY</span><span class="o">=</span><span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
    <span class="n">SESSION_COOKIE_HTTPONLY</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>     <span class="c1"># JavaScript 접근 방지</span>
    <span class="n">SESSION_COOKIE_SECURE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>       <span class="c1"># HTTPS 전용</span>
    <span class="n">SESSION_COOKIE_SAMESITE</span><span class="o">=</span><span class="s1">&#39;Lax&#39;</span><span class="p">,</span>    <span class="c1"># CSRF 방지</span>
    <span class="n">PERMANENT_SESSION_LIFETIME</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># 세션 타임아웃</span>
    <span class="n">SESSION_COOKIE_NAME</span><span class="o">=</span><span class="s1">&#39;__Host-session&#39;</span><span class="p">,</span>  <span class="c1"># __Host- 접두사는 Secure+Path=/를 강제</span>
<span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">check_session_security</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;세션 보안 정책을 시행하는 미들웨어&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;user_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span>  <span class="c1"># 로그인하지 않음, 확인 건너뛰기</span>

    <span class="c1"># 1. 세션 타임아웃 (절대)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">created_at</span> <span class="o">&gt;</span> <span class="mi">3600</span><span class="p">:</span>  <span class="c1"># 1시간 절대 타임아웃</span>
        <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>

    <span class="c1"># 2. 유휴 타임아웃</span>
    <span class="n">last_active</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_active&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_active</span> <span class="o">&gt;</span> <span class="mi">900</span><span class="p">:</span>  <span class="c1"># 15분 유휴 타임아웃</span>
        <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>

    <span class="c1"># 3. 마지막 활동 시간 업데이트</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;last_active&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># 4. IP 바인딩 (선택사항 - 모바일 사용자에게 문제 발생 가능)</span>
    <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ip_address&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">:</span>
        <span class="c1"># 의심스러운 활동 기록</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;IP change detected for user </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ip_address&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">regenerate_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    인증 상태 변경 후 세션 ID 재생성.</span>
<span class="sd">    세션 고정 공격 방지.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 필요한 데이터 보존</span>
    <span class="n">old_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

    <span class="c1"># 이전 세션 지우기</span>
    <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># 새 ID로 새 세션 생성</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_id</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;last_active&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;ip_address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span>
    <span class="n">session</span><span class="o">.</span><span class="n">permanent</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># PERMANENT_SESSION_LIFETIME 사용</span>

    <span class="c1"># 참고: Flask는 세션이 지워진 후 수정될 때</span>
    <span class="c1"># 자동으로 새 세션 ID를 생성함</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>

    <span class="c1"># 자격 증명 검증 (단순화)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="c1"># 중요: 로그인 후 세션 재생성</span>
        <span class="n">regenerate_session</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;dashboard&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="s2">&quot;Invalid credentials&quot;</span><span class="p">,</span> <span class="mi">401</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;세션을 적절히 파괴&quot;&quot;&quot;</span>
    <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
    <span class="c1"># 명시적으로 쿠키 만료</span>
    <span class="n">response</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="s1">&#39;__Host-session&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<hr />
<h2 id="5-json-jwt">5. JSON 웹 토큰 (JWT)<a class="header-link" href="#5-json-jwt" title="Permanent link">&para;</a></h2>
<h3 id="51-jwt">5.1 JWT 구조<a class="header-link" href="#51-jwt" title="Permanent link">&para;</a></h3>
<p>JWT는 점으로 구분된 세 개의 Base64URL 인코딩 부분으로 구성됩니다.</p>
<div class="highlight"><pre><span></span><code><span class="err">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="err">│</span><span class="w">                     </span><span class="n">JWT</span><span class="w"> </span><span class="err">구조</span><span class="w">                                     </span><span class="err">│</span>
<span class="err">├─────────────────────────────────────────────────────────────────┤</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="n">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</span><span class="o">.</span><span class="w">                        </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="n">eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4iLCJpYXQiOjE2M</span><span class="o">.</span><span class="w">  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="n">SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span><span class="w">                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">┌──────────────────┐</span><span class="w">                                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">     </span><span class="n">HEADER</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">←</span><span class="w"> </span><span class="err">알고리즘</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="err">토큰</span><span class="w"> </span><span class="err">타입</span><span class="w">                    </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="p">{</span><span class="w">               </span><span class="err">│</span><span class="w">                                            </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="s2">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;HS256&quot;</span><span class="err">│</span><span class="w">    </span><span class="n">HMAC</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="s2">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT&quot;</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="n">JSON</span><span class="w"> </span><span class="n">Web</span><span class="w"> </span><span class="n">Token</span><span class="w">                         </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="p">}</span><span class="w">               </span><span class="err">│</span><span class="w">                                            </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">└──────────────────┘</span><span class="w">                                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">           </span><span class="o">.</span><span class="w">                                                      </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">┌──────────────────┐</span><span class="w">                                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">     </span><span class="n">PAYLOAD</span><span class="w">      </span><span class="err">│</span><span class="w">  </span><span class="err">←</span><span class="w"> </span><span class="err">클레임</span><span class="w"> </span><span class="p">(</span><span class="err">데이터</span><span class="p">)</span><span class="w">                         </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="p">{</span><span class="w">               </span><span class="err">│</span><span class="w">                                            </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="s2">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1234&quot;</span><span class="w"> </span><span class="err">│</span><span class="w">    </span><span class="err">주체</span><span class="w"> </span><span class="p">(</span><span class="err">사용자</span><span class="w"> </span><span class="n">ID</span><span class="p">)</span><span class="w">                        </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John&quot;</span><span class="err">│</span><span class="w">    </span><span class="err">커스텀</span><span class="w"> </span><span class="err">클레임</span><span class="w">                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="s2">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">163.</span><span class="o">..</span><span class="w"> </span><span class="err">│</span><span class="w">    </span><span class="err">발행</span><span class="w"> </span><span class="err">시간</span><span class="w">                               </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="s2">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">163.</span><span class="o">..</span><span class="w"> </span><span class="err">│</span><span class="w">    </span><span class="err">만료</span><span class="w">                                    </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="s2">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;myapp&quot;</span><span class="err">│</span><span class="w">    </span><span class="err">발행자</span><span class="w">                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="s2">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;api&quot;</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="err">대상</span><span class="w">                                    </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="p">}</span><span class="w">               </span><span class="err">│</span><span class="w">                                            </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">└──────────────────┘</span><span class="w">                                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">           </span><span class="o">.</span><span class="w">                                                      </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">┌──────────────────┐</span><span class="w">                                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="n">SIGNATURE</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="err">←</span><span class="w"> </span><span class="err">무결성</span><span class="w"> </span><span class="err">검증</span><span class="w">                             </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">                  </span><span class="err">│</span><span class="w">                                            </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="n">HMACSHA256</span><span class="p">(</span><span class="w">     </span><span class="err">│</span><span class="w">                                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="n">base64url</span><span class="p">(</span><span class="w">    </span><span class="err">│</span><span class="w">                                            </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">      </span><span class="n">header</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">   </span><span class="err">│</span><span class="w">                                            </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="s2">&quot;.&quot;</span><span class="w"> </span><span class="o">+</span><span class="w">         </span><span class="err">│</span><span class="w">                                            </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="n">base64url</span><span class="p">(</span><span class="w">    </span><span class="err">│</span><span class="w">                                            </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">      </span><span class="n">payload</span><span class="p">),</span><span class="w">   </span><span class="err">│</span><span class="w">                                            </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="n">secret</span><span class="w">        </span><span class="err">│</span><span class="w">                                            </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="p">)</span><span class="w">               </span><span class="err">│</span><span class="w">                                            </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">└──────────────────┘</span><span class="w">                                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre></div>

<h3 id="52-jwt">5.2 JWT 서명 알고리즘<a class="header-link" href="#52-jwt" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>알고리즘</th>
<th>유형</th>
<th>키</th>
<th>사용 사례</th>
</tr>
</thead>
<tbody>
<tr>
<td>HS256</td>
<td>대칭</td>
<td>공유 비밀</td>
<td>단일 서비스 (동일한 키로 서명 및 검증)</td>
</tr>
<tr>
<td>RS256</td>
<td>비대칭</td>
<td>RSA 키 쌍</td>
<td>마이크로서비스 (개인 키로 서명, 공개 키로 검증)</td>
</tr>
<tr>
<td>ES256</td>
<td>비대칭</td>
<td>ECDSA 키 쌍</td>
<td>RS256의 현대적 대안 (더 작은 키)</td>
</tr>
<tr>
<td>EdDSA</td>
<td>비대칭</td>
<td>Ed25519 쌍</td>
<td>최고 성능, 가장 작은 키</td>
</tr>
<tr>
<td><strong>none</strong></td>
<td><strong>없음</strong></td>
<td><strong>없음</strong></td>
<td><strong>절대 사용 금지 - 치명적 취약점</strong></td>
</tr>
</tbody>
</table>
<h3 id="53-python-jwt">5.3 Python JWT 구현<a class="header-link" href="#53-python-jwt" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">jwt_auth.py - JWT 생성, 검증 및 일반 패턴</span>
<span class="sd">pip install PyJWT cryptography</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># 대칭 (HS256) - 단일 서비스 애플리케이션용</span>
<span class="c1"># ==============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">JWTManagerSymmetric</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;HMAC-SHA256 (대칭 키)을 사용하는 JWT 관리자&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># 프로덕션에서는 환경 변수에서 로드</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">secret_key</span> <span class="ow">or</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">roles</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">expires_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;짧은 수명의 접근 토큰 생성&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>           <span class="c1"># 주체 (사용자 식별자)</span>
            <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>                <span class="c1"># 발행 시간</span>
            <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expires_minutes</span><span class="p">),</span>  <span class="c1"># 만료</span>
            <span class="s2">&quot;iss&quot;</span><span class="p">:</span> <span class="s2">&quot;myapp&quot;</span><span class="p">,</span>            <span class="c1"># 발행자</span>
            <span class="s2">&quot;aud&quot;</span><span class="p">:</span> <span class="s2">&quot;myapp-api&quot;</span><span class="p">,</span>        <span class="c1"># 대상</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;access&quot;</span><span class="p">,</span>          <span class="c1"># 토큰 타입</span>
            <span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="n">roles</span> <span class="ow">or</span> <span class="p">[],</span>      <span class="c1"># 사용자 역할</span>
            <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>  <span class="c1"># 고유 토큰 ID (폐기용)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_refresh_token</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">expires_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;긴 수명의 갱신 토큰 생성&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
            <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">expires_days</span><span class="p">),</span>
            <span class="s2">&quot;iss&quot;</span><span class="p">:</span> <span class="s2">&quot;myapp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;refresh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">verify_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expected_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;access&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        JWT 토큰 검증 및 디코딩.</span>
<span class="sd">        실패 시 jwt.InvalidTokenError 발생.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                <span class="n">token</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span>
                <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">],</span>  <span class="c1"># 중요: 항상 지정!</span>
                <span class="n">issuer</span><span class="o">=</span><span class="s2">&quot;myapp&quot;</span><span class="p">,</span>
                <span class="n">audience</span><span class="o">=</span><span class="s2">&quot;myapp-api&quot;</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;require&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="s2">&quot;iat&quot;</span><span class="p">,</span> <span class="s2">&quot;sub&quot;</span><span class="p">,</span> <span class="s2">&quot;iss&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;verify_exp&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;verify_iat&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;verify_iss&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># 토큰 타입 검증</span>
            <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">expected_type</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">expected_type</span><span class="si">}</span><span class="s2"> token, got </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">payload</span>

        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">ExpiredSignatureError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">(</span><span class="s2">&quot;Token has expired&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidAudienceError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">(</span><span class="s2">&quot;Invalid audience&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidIssuerError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">(</span><span class="s2">&quot;Invalid issuer&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">DecodeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">(</span><span class="s2">&quot;Token decode failed&quot;</span><span class="p">)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># 비대칭 (RS256) - 마이크로서비스용</span>
<span class="c1"># ==============================================================</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.asymmetric</span><span class="w"> </span><span class="kn">import</span> <span class="n">rsa</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">serialization</span>


<span class="k">class</span><span class="w"> </span><span class="nc">JWTManagerAsymmetric</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RSA-SHA256 (비대칭 키)을 사용하는 JWT 관리자&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key_pem</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">public_key_pem</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">private_key_pem</span> <span class="ow">and</span> <span class="n">public_key_pem</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span>
                <span class="n">private_key_pem</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_public_key</span><span class="p">(</span>
                <span class="n">public_key_pem</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 데모용 키 쌍 생성</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span>
                <span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span>
                <span class="n">key_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="s2">&quot;RS256&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;개인 키로 토큰 서명&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">verify_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;공개 키로 토큰 검증&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="n">token</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="p">,</span>
            <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_public_key_pem</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;공개 키 내보내기 (다른 서비스와 공유)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">PEM</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">PublicFormat</span><span class="o">.</span><span class="n">SubjectPublicKeyInfo</span>
        <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># 토큰 갱신 패턴</span>
<span class="c1"># ==============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TokenService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;갱신 플로우를 포함한 완전한 토큰 서비스&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span> <span class="o">=</span> <span class="n">JWTManagerSymmetric</span><span class="p">()</span>
        <span class="c1"># 프로덕션에서는 Redis 또는 데이터베이스 사용</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revoked_tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">roles</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;로그인 시 접근 및 갱신 토큰 발행&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span>
                <span class="n">user_id</span><span class="p">,</span> <span class="n">roles</span><span class="p">,</span> <span class="n">expires_minutes</span><span class="o">=</span><span class="mi">15</span>
            <span class="p">),</span>
            <span class="s2">&quot;refresh_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span><span class="o">.</span><span class="n">create_refresh_token</span><span class="p">(</span>
                <span class="n">user_id</span><span class="p">,</span> <span class="n">expires_days</span><span class="o">=</span><span class="mi">30</span>
            <span class="p">),</span>
            <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;expires_in&quot;</span><span class="p">:</span> <span class="mi">900</span><span class="p">,</span>  <span class="c1"># 초 단위 15분</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;갱신 토큰을 사용하여 새 접근 토큰 가져오기&quot;&quot;&quot;</span>
        <span class="c1"># 갱신 토큰 검증</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span><span class="o">.</span><span class="n">verify_token</span><span class="p">(</span>
            <span class="n">refresh_token</span><span class="p">,</span> <span class="n">expected_type</span><span class="o">=</span><span class="s2">&quot;refresh&quot;</span>
        <span class="p">)</span>

        <span class="c1"># 토큰이 폐기되었는지 확인</span>
        <span class="n">jti</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jti&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jti</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">revoked_tokens</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">(</span><span class="s2">&quot;Token has been revoked&quot;</span><span class="p">)</span>

        <span class="c1"># 이전 갱신 토큰 폐기 (순환)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revoked_tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">jti</span><span class="p">)</span>

        <span class="c1"># 새 토큰 쌍 발행</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="p">[])</span>  <span class="c1"># DB에서 역할 다시 가져오기</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">revoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;토큰 폐기 (로그아웃)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                <span class="n">token</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span>
                <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">],</span>
                <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;verify_exp&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>  <span class="c1"># 만료된 토큰 폐기 허용</span>
            <span class="p">)</span>
            <span class="n">jti</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jti&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">jti</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">revoked_tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">jti</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">DecodeError</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># 잘못된 토큰, 폐기할 것 없음</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># 데모</span>
<span class="c1"># ==============================================================</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== 대칭 JWT (HS256) ===&quot;</span><span class="p">)</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">JWTManagerSymmetric</span><span class="p">()</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;editor&quot;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token: </span><span class="si">{</span><span class="n">token</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payload: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== 토큰 서비스 ===&quot;</span><span class="p">)</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">TokenService</span><span class="p">()</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Access:  </span><span class="si">{</span><span class="n">tokens</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">][:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Refresh: </span><span class="si">{</span><span class="n">tokens</span><span class="p">[</span><span class="s1">&#39;refresh_token&#39;</span><span class="p">][:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="c1"># 갱신</span>
    <span class="n">new_tokens</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New access: </span><span class="si">{</span><span class="n">new_tokens</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">][:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== 비대칭 JWT (RS256) ===&quot;</span><span class="p">)</span>
    <span class="n">asym_manager</span> <span class="o">=</span> <span class="n">JWTManagerAsymmetric</span><span class="p">()</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">asym_manager</span><span class="o">.</span><span class="n">create_token</span><span class="p">({</span>
        <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="s2">&quot;user123&quot;</span><span class="p">,</span>
        <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">})</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token: </span><span class="si">{</span><span class="n">token</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">asym_manager</span><span class="o">.</span><span class="n">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payload: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Public key (share with other services):&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">asym_manager</span><span class="o">.</span><span class="n">get_public_key_pem</span><span class="p">()[:</span><span class="mi">100</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="54-jwt">5.4 일반적인 JWT 함정<a class="header-link" href="#54-jwt" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│                  JWT 보안 함정                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. 알고리즘 &quot;none&quot; 공격                                          │
│     ─────────────────────                                        │
│     공격자가 헤더를 {&quot;alg&quot;: &quot;none&quot;}으로 변경하고 서명 제거.       │
│     서버가 서명되지 않은 토큰 수락.                                │
│                                                                  │
│     수정: 허용된 알고리즘을 항상 지정:                             │
│     jwt.decode(token, key, algorithms=[&quot;HS256&quot;])                 │
│     절대 algorithms=[&quot;none&quot;]을 사용하거나 모든 알고리즘 허용 금지   │
│                                                                  │
│  2. 알고리즘 혼동 (RS256 → HS256)                                │
│     ──────────────────────────────────                           │
│     서버가 RS256 사용 (비대칭). 공격자가 HS256으로 변경하고       │
│     공개 키로 서명. 서버가 동일한 공개 키를 HMAC 비밀로 사용하여   │
│     검증 → 유효!                                                  │
│                                                                  │
│     수정: 예상 알고리즘 명시적 지정, &quot;모든&quot; 것이 아님             │
│     대칭/비대칭에 별도 키 사용                                    │
│                                                                  │
│  3. 만료 없음                                                     │
│     ─────────────                                                │
│     &quot;exp&quot; 클레임 없는 토큰은 영원히 유지됨.                       │
│                                                                  │
│     수정: 항상 exp 설정. 짧은 수명의 접근 토큰 사용 (15분)       │
│     긴 갱신 토큰과 함께.                                          │
│                                                                  │
│  4. 페이로드의 민감한 데이터                                       │
│     ─────────────────────────                                    │
│     JWT 페이로드는 Base64 인코딩됨, 암호화되지 않음.              │
│     누구나 디코딩하고 읽을 수 있음.                                │
│                                                                  │
│     수정: 비밀번호, PII 또는 비밀을 JWT 페이로드에 넣지 말 것     │
│     페이로드가 비공개여야 하면 JWE (JSON Web Encryption) 사용     │
│                                                                  │
│  5. 토큰을 폐기할 수 없음                                          │
│     ──────────────────                                           │
│     JWT는 상태 비저장 - 일단 발행되면 만료까지 유효함.             │
│     로그아웃이 토큰을 무효화하지 않음.                             │
│                                                                  │
│     수정: 짧은 만료 + 로그아웃용 토큰 블록리스트 (Redis) 사용     │
│     또는 &quot;jti&quot; 클레임 사용 및 폐기된 토큰 ID 추적                 │
│                                                                  │
│  6. JWT를 localStorage에 저장                                    │
│     ─────────────────────────                                    │
│     localStorage는 페이지의 모든 JavaScript로 접근 가능하여       │
│     XSS에 취약함.                                                 │
│                                                                  │
│     수정: HttpOnly 쿠키에 저장 (XSS 면역)                        │
│     또는 메모리 내 저장 + HttpOnly 쿠키의 갱신 토큰 사용         │
│                                                                  │
│  7. 약한 비밀 키                                                  │
│     ────────────────                                             │
│     HMAC 서명에 짧거나 추측 가능한 비밀 사용.                      │
│     공격자가 키를 무차별 대입할 수 있음.                           │
│                                                                  │
│     수정: 최소 256비트 엔트로피 사용:                             │
│     secret = secrets.token_hex(32)  # 256 비트                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<hr />
<h2 id="6">6. 비밀번호 재설정 플로우<a class="header-link" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 안전한 비밀번호 재설정 설계<a class="header-link" href="#61" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│              안전한 비밀번호 재설정 플로우                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  사용자                    서버                     이메일        │
│   │                          │                          │        │
│   │ 1. &quot;비밀번호 찾기&quot;       │                          │        │
│   │  (이메일 입력)           │                          │        │
│   │─────────────────────────▶│                          │        │
│   │                          │                          │        │
│   │                    ┌─────┴─────┐                   │        │
│   │                    │ 랜덤      │                    │        │
│   │                    │ 토큰      │                    │        │
│   │                    │ 생성      │                    │        │
│   │                    │ hash(tkn) │                    │        │
│   │                    │ 저장      │                    │        │
│   │                    │ + 만료    │                    │        │
│   │                    └─────┬─────┘                   │        │
│   │                          │                          │        │
│   │ 2. &quot;이메일 확인&quot;         │  3. 토큰과 함께         │        │
│   │  (이메일 존재 여부와     │  재설정 링크 전송       │        │
│   │   관계없이 동일한 응답!) │─────────────────────────▶│       │
│   │◀─────────────────────────│                          │        │
│   │                          │                          │        │
│   │ 4. 이메일에서 링크 클릭  │                          │        │
│   │  /reset?token=abc123     │                          │        │
│   │─────────────────────────▶│                          │        │
│   │                          │                          │        │
│   │ 5. 새 비밀번호 폼        │                          │        │
│   │◀─────────────────────────│                          │        │
│   │                          │                          │        │
│   │ 6. 새 비밀번호 제출      │                          │        │
│   │─────────────────────────▶│                          │        │
│   │                    ┌─────┴─────┐                   │        │
│   │                    │ 토큰      │                    │        │
│   │                    │ 검증      │                    │        │
│   │                    │ 비밀번호  │                    │        │
│   │                    │ 업데이트  │                    │        │
│   │                    │ 토큰      │                    │        │
│   │                    │ 무효화    │                    │        │
│   │                    │ 세션      │                    │        │
│   │                    │ 무효화    │                    │        │
│   │                    └─────┬─────┘                   │        │
│   │                          │                          │        │
│   │ 7. &quot;비밀번호 업데이트됨&quot; │                          │        │
│   │◀─────────────────────────│                          │        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="62">6.2 구현<a class="header-link" href="#62" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">password_reset.py - 안전한 비밀번호 재설정 구현</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ResetToken</span><span class="p">:</span>
    <span class="n">token_hash</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">expires_at</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">used</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span><span class="w"> </span><span class="nc">PasswordResetService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;안전한 비밀번호 재설정 토큰 관리&quot;&quot;&quot;</span>

    <span class="n">TOKEN_EXPIRY_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">MAX_REQUESTS_PER_HOUR</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 프로덕션에서는 데이터베이스 사용</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># token_hash -&gt; ResetToken</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># email -&gt; [timestamps]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">request_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        비밀번호 재설정 토큰 생성.</span>
<span class="sd">        토큰(이메일로 전송)을 반환하거나 속도 제한 시 None 반환.</span>

<span class="sd">        보안: 이메일 존재 여부와 관계없이 사용자에게</span>
<span class="sd">        항상 동일한 응답 반환.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 속도 제한</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">email</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">:</span>
            <span class="n">recent</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">[</span><span class="n">email</span><span class="p">]</span> <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">3600</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_REQUESTS_PER_HOUR</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># 속도 제한됨</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">[</span><span class="n">email</span><span class="p">]</span> <span class="o">=</span> <span class="n">recent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">[</span><span class="n">email</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">[</span><span class="n">email</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>

        <span class="c1"># 사용자가 존재하지 않으면 조용히 None 반환</span>
        <span class="c1"># (호출자는 여전히 &quot;이메일 확인&quot; 메시지 표시)</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># 암호학적으로 안전한 토큰 생성</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>  <span class="c1"># 256비트 엔트로피</span>

        <span class="c1"># 토큰의 해시 저장 (토큰 자체가 아님!)</span>
        <span class="c1"># 데이터베이스가 침해되어도 공격자가 해시를 사용할 수 없음</span>
        <span class="n">token_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="c1"># 이 사용자의 기존 토큰 무효화</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">h</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">user_id</span> <span class="o">!=</span> <span class="n">user_id</span>
        <span class="p">}</span>

        <span class="c1"># 새 토큰 저장</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">token_hash</span><span class="p">]</span> <span class="o">=</span> <span class="n">ResetToken</span><span class="p">(</span>
            <span class="n">token_hash</span><span class="o">=</span><span class="n">token_hash</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
            <span class="n">expires_at</span><span class="o">=</span><span class="n">now</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TOKEN_EXPIRY_MINUTES</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">token</span>  <span class="c1"># 이메일 링크에 이것을 보냄</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">verify_and_consume_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        재설정 토큰 검증 및 user_id 반환.</span>
<span class="sd">        토큰 사용됨 (일회용).</span>
<span class="sd">        토큰이 유효하지 않거나/만료되었거나/사용된 경우 None 반환.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">token_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="n">reset_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token_hash</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reset_token</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># 만료 확인</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">reset_token</span><span class="o">.</span><span class="n">expires_at</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">token_hash</span><span class="p">]</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># 이미 사용되었는지 확인</span>
        <span class="k">if</span> <span class="n">reset_token</span><span class="o">.</span><span class="n">used</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># 사용됨으로 표시</span>
        <span class="n">reset_token</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># 정리</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">token_hash</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">reset_token</span><span class="o">.</span><span class="n">user_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;만료된 토큰 제거 (주기적으로 실행)&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">h</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">&gt;</span> <span class="n">now</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">used</span>
        <span class="p">}</span>


<span class="c1"># Flask 라우트 예제</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">reset_service</span> <span class="o">=</span> <span class="n">PasswordResetService</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/forgot-password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">forgot_password</span><span class="p">():</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Email required&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># 사용자 조회 (찾지 못하면 None 반환 가능)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_user_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>  <span class="c1"># DB 조회</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">user</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">reset_service</span><span class="o">.</span><span class="n">request_reset</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">token</span> <span class="ow">and</span> <span class="n">user</span><span class="p">:</span>
        <span class="c1"># 재설정 링크가 포함된 이메일 전송</span>
        <span class="n">reset_link</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://myapp.com/reset-password?token=</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">send_reset_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">reset_link</span><span class="p">)</span>  <span class="c1"># 이메일 함수</span>

    <span class="c1"># 항상 동일한 응답 반환 (이메일 열거 방지)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;If that email is registered, you will receive a reset link.&quot;</span>
    <span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/reset-password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reset_password</span><span class="p">():</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
    <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new_password&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">new_password</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Token and new password required&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># 새 비밀번호 검증</span>
    <span class="c1"># (password_policy.check_password_strength 사용)</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">reset_service</span><span class="o">.</span><span class="n">verify_and_consume_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid or expired token&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># 비밀번호 업데이트</span>
    <span class="n">update_user_password</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">new_password</span><span class="p">)</span>  <span class="c1"># 해시 및 저장</span>

    <span class="c1"># 이 사용자의 모든 기존 세션 무효화</span>
    <span class="n">invalidate_all_sessions</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Password updated successfully&quot;</span><span class="p">})</span>
</code></pre></div>

<p><strong>주요 보안 속성:</strong></p>
<table>
<thead>
<tr>
<th>속성</th>
<th>구현</th>
</tr>
</thead>
<tbody>
<tr>
<td>토큰 엔트로피</td>
<td><code>secrets.token_urlsafe(32)</code> - 256비트</td>
</tr>
<tr>
<td>토큰 저장</td>
<td>해시만 저장, 평문 절대 안 됨</td>
</tr>
<tr>
<td>일회용</td>
<td>첫 사용 시 토큰 소비됨</td>
</tr>
<tr>
<td>시간 제한</td>
<td>30분 만료</td>
</tr>
<tr>
<td>속도 제한</td>
<td>이메일당 시간당 최대 3회 요청</td>
</tr>
<tr>
<td>열거 방지</td>
<td>이메일 존재 여부와 관계없이 동일한 응답</td>
</tr>
<tr>
<td>세션 무효화</td>
<td>재설정 후 모든 세션 지움</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7">7. 생체 인증<a class="header-link" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 개요<a class="header-link" href="#71" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="err">│</span><span class="w">              </span><span class="nt">생체</span><span class="w"> </span><span class="nt">인증</span><span class="w"> </span><span class="nt">유형</span><span class="w">                                       </span><span class="err">│</span>
<span class="err">├─────────────────────────────────────────────────────────────────┤</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="nt">생리적</span><span class="o">:</span><span class="w">                                                         </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">├──</span><span class="w"> </span><span class="nt">지문</span><span class="w">       </span><span class="nt">-</span><span class="w"> </span><span class="nt">가장</span><span class="w"> </span><span class="nt">일반적</span><span class="o">,</span><span class="w"> </span><span class="nt">성숙한</span><span class="w"> </span><span class="nt">기술</span><span class="w">                        </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">├──</span><span class="w"> </span><span class="nt">얼굴</span><span class="w">       </span><span class="nt">-</span><span class="w"> </span><span class="nt">모바일에서</span><span class="w"> </span><span class="nt">널리</span><span class="w"> </span><span class="nt">보급</span><span class="w"> </span><span class="o">(</span><span class="nt">Face</span><span class="w"> </span><span class="nt">ID</span><span class="o">)</span><span class="w">                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">├──</span><span class="w"> </span><span class="nt">홍채</span><span class="w">       </span><span class="nt">-</span><span class="w"> </span><span class="nt">높은</span><span class="w"> </span><span class="nt">정확도</span><span class="o">,</span><span class="w"> </span><span class="nt">비싸</span><span class="w">                              </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">├──</span><span class="w"> </span><span class="nt">망막</span><span class="w">       </span><span class="nt">-</span><span class="w"> </span><span class="nt">매우</span><span class="w"> </span><span class="nt">높은</span><span class="w"> </span><span class="nt">정확도</span><span class="o">,</span><span class="w"> </span><span class="nt">침습적</span><span class="w">                        </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">└──</span><span class="w"> </span><span class="nt">손바닥</span><span class="o">/</span><span class="nt">정맥</span><span class="w"> </span><span class="nt">-</span><span class="w"> </span><span class="nt">비접촉</span><span class="o">,</span><span class="w"> </span><span class="nt">점점</span><span class="w"> </span><span class="nt">인기</span><span class="w">                             </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="nt">행동</span><span class="o">:</span><span class="w">                                                           </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">├──</span><span class="w"> </span><span class="nt">음성</span><span class="w">       </span><span class="nt">-</span><span class="w"> </span><span class="nt">전화</span><span class="w"> </span><span class="nt">시스템에</span><span class="w"> </span><span class="nt">편리</span><span class="w">                              </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">├──</span><span class="w"> </span><span class="nt">타이핑</span><span class="w"> </span><span class="nt">리듬</span><span class="w"> </span><span class="nt">-</span><span class="w"> </span><span class="nt">지속적</span><span class="w"> </span><span class="nt">인증</span><span class="w">                                   </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">├──</span><span class="w"> </span><span class="nt">걸음걸이</span><span class="w">    </span><span class="nt">-</span><span class="w"> </span><span class="nt">걷는</span><span class="w"> </span><span class="nt">패턴</span><span class="w"> </span><span class="nt">인식</span><span class="w">                                </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">└──</span><span class="w"> </span><span class="nt">서명</span><span class="w">       </span><span class="nt">-</span><span class="w"> </span><span class="nt">동적</span><span class="w"> </span><span class="nt">분석</span><span class="w"> </span><span class="o">(</span><span class="nt">압력</span><span class="o">,</span><span class="w"> </span><span class="nt">속도</span><span class="o">)</span><span class="w">                         </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="nt">주요</span><span class="w"> </span><span class="nt">지표</span><span class="o">:</span><span class="w">                                                      </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">┌─────────────┬──────────────────────────────────────────┐</span><span class="w">     </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="nt">FAR</span><span class="w">         </span><span class="err">│</span><span class="w"> </span><span class="nt">거짓</span><span class="w"> </span><span class="nt">수락률</span><span class="w">                               </span><span class="err">│</span><span class="w">     </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">             </span><span class="err">│</span><span class="w"> </span><span class="o">(</span><span class="nt">사칭자를</span><span class="w"> </span><span class="nt">진짜로</span><span class="w"> </span><span class="nt">수락</span><span class="o">)</span><span class="w">                     </span><span class="err">│</span><span class="w">     </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">├─────────────┼──────────────────────────────────────────┤</span><span class="w">     </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="nt">FRR</span><span class="w">         </span><span class="err">│</span><span class="w"> </span><span class="nt">거짓</span><span class="w"> </span><span class="nt">거부율</span><span class="w">                               </span><span class="err">│</span><span class="w">     </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">             </span><span class="err">│</span><span class="w"> </span><span class="o">(</span><span class="nt">진짜</span><span class="w"> </span><span class="nt">사용자</span><span class="w"> </span><span class="nt">거부</span><span class="o">)</span><span class="w">                         </span><span class="err">│</span><span class="w">     </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">├─────────────┼──────────────────────────────────────────┤</span><span class="w">     </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="nt">EER</span><span class="w">         </span><span class="err">│</span><span class="w"> </span><span class="nt">동일</span><span class="w"> </span><span class="nt">오류율</span><span class="w">                               </span><span class="err">│</span><span class="w">     </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">             </span><span class="err">│</span><span class="w"> </span><span class="o">(</span><span class="nt">FAR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">FRR인</span><span class="w"> </span><span class="nt">지점</span><span class="o">;</span><span class="w"> </span><span class="nt">낮을수록</span><span class="w"> </span><span class="nt">좋음</span><span class="o">)</span><span class="w">         </span><span class="err">│</span><span class="w">     </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">└─────────────┴──────────────────────────────────────────┘</span><span class="w">     </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre></div>

<h3 id="72">7.2 생체 템플릿 보안<a class="header-link" href="#72" title="Permanent link">&para;</a></h3>
<p>생체 데이터는 <strong>변경할 수 없기</strong> 때문에 침해되면 비밀번호와 달리 특별한 처리가 필요합니다.</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│           생체 템플릿 보호                                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  잘못됨: 원시 생체 데이터 저장                                    │
│  ┌──────────┐    ┌──────────────┐                               │
│  │ 원시 스캔│───▶│ 데이터베이스에│  ← 침해 시, 게임 오버        │
│  └──────────┘    │ 이미지 저장  │    (지문 변경 불가)           │
│                  └──────────────┘                                │
│                                                                  │
│  올바름: 취소 가능한 생체 / 템플릿 보호                           │
│  ┌──────────┐    ┌──────────────┐    ┌─────────────┐           │
│  │ 원시 스캔│───▶│ 특징         │───▶│ 변환        │           │
│  └──────────┘    │ 추출         │    │ (일방향,    │           │
│                  │ (미뉴샤)     │    │  취소 가능) │            │
│                  └──────────────┘    └──────┬──────┘           │
│                                             │                    │
│                                      ┌──────▼──────┐           │
│                                      │ 템플릿      │            │
│                                      │ 저장        │            │
│                                      │ (폐기 가능) │            │
│                                      └─────────────┘           │
│                                                                  │
│  장치 내 처리 (선호):                                            │
│  - 생체 매칭이 장치에서 발생 (Secure Enclave)                   │
│  - 서버는 생체 데이터를 보지 못함                                │
│  - 매칭 시 장치가 암호화 키 릴리스                               │
│  - Apple Face ID 및 Touch ID가 작동하는 방식                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="73">7.3 생체 트레이드오프<a class="header-link" href="#73" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>요소</th>
<th>비밀번호</th>
<th>TOTP</th>
<th>생체 인증</th>
<th>FIDO2</th>
</tr>
</thead>
<tbody>
<tr>
<td>변경 가능</td>
<td>예</td>
<td>예 (재등록)</td>
<td><strong>아니오</strong></td>
<td>예 (재등록)</td>
</tr>
<tr>
<td>공유 가능</td>
<td>예 (나쁨)</td>
<td>예 (나쁨)</td>
<td>어려움</td>
<td>아니오</td>
</tr>
<tr>
<td>잊어버릴 수 있음</td>
<td>예</td>
<td>해당 없음</td>
<td>아니오</td>
<td>해당 없음</td>
</tr>
<tr>
<td>스푸핑 위험</td>
<td>피싱</td>
<td>피싱</td>
<td>프레젠테이션 공격</td>
<td>매우 낮음</td>
</tr>
<tr>
<td>개인정보 우려</td>
<td>낮음</td>
<td>낮음</td>
<td><strong>높음</strong></td>
<td>낮음</td>
</tr>
<tr>
<td>가장 좋은 용도</td>
<td>주요 요소</td>
<td>2차 요소</td>
<td>2차 요소 (로컬)</td>
<td>2차 요소 또는 비밀번호 없음</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8">8. 인증 아키텍처 패턴<a class="header-link" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 올바른 패턴 선택<a class="header-link" href="#81" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│          인증 패턴 결정 트리                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  어떤 유형의 애플리케이션?                                        │
│  │                                                               │
│  ├── 전통적인 웹 앱 (서버 렌더링)                                 │
│  │   └── 사용: 서버 측 세션 + HttpOnly 쿠키                      │
│  │                                                               │
│  ├── SPA (React, Vue 등)                                         │
│  │   └── 사용: OAuth 2.0 + PKCE                                 │
│  │       메모리에 접근 토큰 저장                                  │
│  │       HttpOnly 쿠키에 갱신 토큰 저장                          │
│  │                                                               │
│  ├── 모바일 앱                                                    │
│  │   └── 사용: OAuth 2.0 + PKCE + 보안 저장소                    │
│  │       (iOS Keychain, Android Keystore)                        │
│  │                                                               │
│  ├── API 간 (서비스 메시)                                         │
│  │   └── 사용: Client Credentials 플로우 + mTLS                 │
│  │       또는: 서비스 메시 (Istio) 자동 mTLS                      │
│  │                                                               │
│  └── 마이크로서비스                                               │
│      └── 사용: JWT (RS256) 중앙 인증 서비스                       │
│          인증 서비스가 토큰 발행                                   │
│          각 서비스가 공개 키로 검증                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="82">8.2 중앙 인증 (인증 서비스 패턴)<a class="header-link" href="#82" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│         마이크로서비스 인증 아키텍처                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│                    ┌──────────────┐                              │
│                    │   API        │                              │
│                    │   Gateway    │                              │
│                    └──────┬───────┘                              │
│                           │                                      │
│            ┌──────────────┼──────────────┐                      │
│            │              │              │                        │
│            ▼              ▼              ▼                        │
│     ┌──────────┐  ┌──────────┐  ┌──────────┐                   │
│     │ 서비스   │  │ 서비스   │  │ 서비스   │                    │
│     │    A     │  │    B     │  │    C     │                    │
│     └──────────┘  └──────────┘  └──────────┘                   │
│            │              │              │                        │
│            └──────────────┼──────────────┘                      │
│                           │                                      │
│                           ▼                                      │
│                    ┌──────────────┐                              │
│                    │  인증        │                              │
│                    │  서비스      │                              │
│                    │  ─────────── │                              │
│                    │  - 로그인    │                              │
│                    │  - 토큰      │                              │
│                    │    발행      │                              │
│                    │  - 사용자    │                              │
│                    │    관리      │                              │
│                    │  - JWKS      │                              │
│                    │    엔드포인트│                              │
│                    └──────────────┘                              │
│                                                                  │
│  플로우:                                                         │
│  1. 클라이언트가 인증 서비스로 인증 → JWT 받음                    │
│  2. 클라이언트가 API Gateway에 JWT 전송                          │
│  3. Gateway가 JWT 서명 검증 (JWKS의 공개 키 사용)               │
│  4. Gateway가 요청 + JWT 클레임을 서비스로 전달                  │
│  5. 서비스들이 재검증 없이 검증된 클레임 신뢰                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<hr />
<h2 id="9">9. 연습 문제<a class="header-link" href="#9" title="Permanent link">&para;</a></h2>
<h3 id="1_1">연습문제 1: 안전한 비밀번호 저장 구현<a class="header-link" href="#1_1" title="Permanent link">&para;</a></h3>
<p>완전한 사용자 등록 및 로그인 시스템 구축:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">연습문제: 다음 UserService 클래스를 구현하세요.</span>
<span class="sd">비밀번호 해싱에 argon2를 사용하세요.</span>
<span class="sd">입력 검증과 적절한 오류 처리를 포함하세요.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        새 사용자 등록.</span>
<span class="sd">        - 비밀번호 강도 검증 (최소 12자, 일반적이지 않음)</span>
<span class="sd">        - 사용자 이름/이메일 고유성 확인</span>
<span class="sd">        - argon2id로 비밀번호 해시</span>
<span class="sd">        - 사용자 정보 반환 (비밀번호 해시 제외)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        사용자 인증.</span>
<span class="sd">        - 자격 증명 검증</span>
<span class="sd">        - 5회 실패 후 계정 잠금 구현</span>
<span class="sd">        - 성공적인 로그인 시 세션 재생성</span>
<span class="sd">        - 접근 + 갱신 토큰 반환</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">change_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">old_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">new_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        사용자 비밀번호 변경.</span>
<span class="sd">        - 이전 비밀번호 검증</span>
<span class="sd">        - 새 비밀번호 검증</span>
<span class="sd">        - 모든 기존 세션 무효화</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="2-totp">연습문제 2: TOTP 통합<a class="header-link" href="#2-totp" title="Permanent link">&para;</a></h3>
<p>UserService에 TOTP 기반 2FA 추가:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">연습문제: UserService에 이 메서드들을 추가하세요.</span>
<span class="sd">pyotp 라이브러리를 사용하세요.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="c1"># ... (연습문제 1에서)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">enable_2fa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        사용자에 대해 TOTP 2FA 활성화.</span>
<span class="sd">        반환: {&quot;secret&quot;: ..., &quot;qr_uri&quot;: ..., &quot;backup_codes&quot;: [...]}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">verify_2fa_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;설정 확인을 위한 초기 TOTP 코드 검증&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">login_2fa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">totp_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        2FA로 로그인.</span>
<span class="sd">        - 먼저 비밀번호 검증</span>
<span class="sd">        - 그 다음 TOTP 코드 검증</span>
<span class="sd">        - 대체 수단으로 백업 코드 지원</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="3-jwt">연습문제 3: JWT 보안 감사<a class="header-link" href="#3-jwt" title="Permanent link">&para;</a></h3>
<p>이 코드의 보안 문제를 식별하고 수정:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">연습문제: 이 JWT 구현의 모든 보안 문제를 찾아 수정하세요.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="n">SECRET</span> <span class="o">=</span> <span class="s2">&quot;mysecret&quot;</span>  <span class="c1"># 문제 1: ???</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">get_user_password</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span>  <span class="c1"># 문제 2: ???</span>
        <span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">SECRET</span><span class="p">)</span>  <span class="c1"># 문제 3: ???</span>

<span class="k">def</span><span class="w"> </span><span class="nf">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">])</span>  <span class="c1"># 문제 4: ???</span>
        <span class="k">return</span> <span class="n">payload</span>
    <span class="k">except</span><span class="p">:</span>  <span class="c1"># 문제 5: ???</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">protected_route</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">):</span>  <span class="c1"># 문제 6: ???</span>
            <span class="k">return</span> <span class="n">admin_dashboard</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">user_dashboard</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="s2">&quot;Unauthorized&quot;</span>
</code></pre></div>

<h3 id="4-oauth-20">연습문제 4: OAuth 2.0 플로우 구현<a class="header-link" href="#4-oauth-20" title="Permanent link">&para;</a></h3>
<p>PKCE를 사용한 완전한 OAuth 2.0 클라이언트 구현:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">연습문제: 이 OAuth 2.0 클라이언트 구현을 완성하세요.</span>
<span class="sd">PKCE, state 검증, 안전한 토큰 저장을 포함하세요.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">OAuthClient</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">auth_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">token_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start_auth_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        권한 부여 URL 생성.</span>
<span class="sd">        PKCE code_challenge 및 state 파라미터 포함.</span>
<span class="sd">        사용자를 리디렉션할 URL 반환.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        OAuth 콜백 처리.</span>
<span class="sd">        - state 파라미터 검증</span>
<span class="sd">        - code_verifier를 사용하여 코드를 토큰으로 교환</span>
<span class="sd">        - 토큰 반환</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;만료된 접근 토큰 갱신&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="5">연습문제 5: 비밀번호 재설정 보안 검토<a class="header-link" href="#5" title="Permanent link">&para;</a></h3>
<p>이 비밀번호 재설정 플로우를 검토하고 모든 보안 문제 나열:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">연습문제: 이 코드의 모든 보안 취약점을 식별하세요.</span>
<span class="sd">수정된 버전을 작성하세요.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">string</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">reset_codes</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># email -&gt; code</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/forgot&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">forgot_password</span><span class="p">():</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">find_user</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Email not found&quot;</span><span class="p">,</span> <span class="mi">404</span>  <span class="c1"># 문제: ???</span>

    <span class="c1"># 4자리 재설정 코드 생성</span>
    <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>  <span class="c1"># 문제: ???</span>
    <span class="n">reset_codes</span><span class="p">[</span><span class="n">email</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>  <span class="c1"># 문제: ???</span>

    <span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Your reset code is: </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;Code sent&quot;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/reset&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reset_password</span><span class="p">():</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
    <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">reset_codes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">email</span><span class="p">)</span> <span class="o">==</span> <span class="n">code</span><span class="p">:</span>  <span class="c1"># 문제: ???</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">find_user</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">new_password</span>  <span class="c1"># 문제: ???</span>
        <span class="n">db</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;Password updated&quot;</span>

    <span class="k">return</span> <span class="s2">&quot;Invalid code&quot;</span><span class="p">,</span> <span class="mi">400</span>
</code></pre></div>

<hr />
<h2 id="10">10. 요약<a class="header-link" href="#10" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│              인증 시스템 요약                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  비밀번호 저장:                                                   │
│  - Argon2id 또는 bcrypt 사용 (MD5/SHA1/SHA256 단독 절대 안 됨)  │
│  - 자동 솔팅, 키 스트레칭                                         │
│  - NIST SP 800-63B 지침 따르기                                   │
│                                                                  │
│  다중 인증:                                                       │
│  - TOTP가 최소 권장 2차 요소                                      │
│  - FIDO2/WebAuthn이 황금 표준 (피싱 저항)                        │
│  - SMS는 가장 약한 2차 요소 (SIM 스와핑)                          │
│  - 계정 복구를 위해 항상 백업 코드 제공                            │
│                                                                  │
│  OAuth 2.0 / OIDC:                                              │
│  - PKCE와 함께 권한 부여 코드 플로우 사용                         │
│  - 항상 state 파라미터 검증 (CSRF)                               │
│  - OIDC가 OAuth 위에 신원 레이어 추가 (ID 토큰)                   │
│                                                                  │
│  세션 &amp; JWT:                                                     │
│  - HttpOnly + Secure + SameSite 쿠키                            │
│  - 로그인 후 세션 ID 재생성                                       │
│  - JWT: 짧은 수명 접근 + 긴 수명 갱신                             │
│  - JWT 검증에서 항상 허용 알고리즘 지정                           │
│  - JWT 페이로드에 민감한 데이터 절대 저장 금지                     │
│                                                                  │
│  비밀번호 재설정:                                                 │
│  - 암호학적으로 랜덤한 토큰 (256+ 비트)                           │
│  - 토큰 자체가 아닌 토큰의 해시 저장                              │
│  - 일회용, 시간 제한 (30분)                                       │
│  - 이메일 존재 여부와 관계없이 동일한 응답                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<hr />
<p><strong>이전</strong>: <a href="./04_TLS_and_PKI.md">04. TLS/SSL 및 공개키 기반 구조</a> | <strong>다음</strong>: <a href="06_Authorization.md">06. 접근 제어 및 권한 부여</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Security/04_TLS_and_PKI.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">TLS/SSL과 공개 키 인프라</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">🔗</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">📋</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Security/06_Authorization.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">06. 인가 및 접근 제어</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">↑</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'ko';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}