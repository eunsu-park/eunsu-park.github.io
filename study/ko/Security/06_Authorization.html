{% raw %}
<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>06. ì¸ê°€ ë° ì ‘ê·¼ ì œì–´ - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/ko/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/ko/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/ko/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" >
                        English
                    </option>
                    
                    <option value="ko" selected>
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/ko/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/ko/Security/">Security</a>
    <span class="separator">/</span>
    <span class="current">06. ì¸ê°€ ë° ì ‘ê·¼ ì œì–´</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>06. ì¸ê°€ ë° ì ‘ê·¼ ì œì–´</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Security/05_Authentication.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">05. ì¸ì¦ ì‹œìŠ¤í…œ</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Security/07_OWASP_Top10.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">07. OWASP Top 10 (2021)</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#_1">í•™ìŠµ ëª©í‘œ</a></li>
<li><a href="#1-vs">1. ì¸ì¦ vs ì¸ê°€</a></li>
<li><a href="#2-rbac">2. ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (RBAC)</a><ul>
<li><a href="#21-rbac">2.1 RBAC ê°œë…</a></li>
<li><a href="#22-python-rbac">2.2 Pythonì—ì„œ RBAC êµ¬í˜„</a></li>
<li><a href="#23-flask-rbac">2.3 Flask RBAC ë¯¸ë“¤ì›¨ì–´</a></li>
</ul>
</li>
<li><a href="#3-abac">3. ì†ì„± ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (ABAC)</a><ul>
<li><a href="#31-abac">3.1 ABAC ê°œë…</a></li>
<li><a href="#32-rbac-vs-abac">3.2 RBAC vs ABAC ì‚¬ìš© ì‹œì </a></li>
<li><a href="#33-abac">3.3 ABAC êµ¬í˜„</a></li>
</ul>
</li>
<li><a href="#4-acl">4. ì ‘ê·¼ ì œì–´ ëª©ë¡ (ACL)</a><ul>
<li><a href="#41-acl">4.1 ACL ê°œë…</a></li>
<li><a href="#42-acl">4.2 ACL êµ¬í˜„</a></li>
</ul>
</li>
<li><a href="#5-opa-open-policy-agent">5. ì •ì±… ì—”ì§„: OPA (Open Policy Agent)</a><ul>
<li><a href="#51-opa">5.1 OPAë€?</a></li>
<li><a href="#52-rego">5.2 Rego ì •ì±… ì–¸ì–´</a></li>
<li><a href="#53-python-opa">5.3 Pythonê³¼ OPA í†µí•©</a></li>
</ul>
</li>
<li><a href="#6-jwt">6. ì¸ê°€ë¥¼ ìœ„í•œ JWT í´ë ˆì„</a><ul>
<li><a href="#61">6.1 í‘œì¤€ ë° ì‚¬ìš©ì ì •ì˜ í´ë ˆì„</a></li>
<li><a href="#62">6.2 í´ë ˆì„ ê¸°ë°˜ ì¸ê°€ ë¯¸ë“¤ì›¨ì–´</a></li>
</ul>
</li>
<li><a href="#7-oauth-20">7. OAuth 2.0 ìŠ¤ì½”í”„</a><ul>
<li><a href="#71">7.1 ìŠ¤ì½”í”„ ì´í•´í•˜ê¸°</a></li>
<li><a href="#72">7.2 ìŠ¤ì½”í”„ ê°•ì œ</a></li>
</ul>
</li>
<li><a href="#8">8. ë¦¬ì†ŒìŠ¤ ìˆ˜ì¤€ ê¶Œí•œ</a><ul>
<li><a href="#81">8.1 ì—­í•  ê¸°ë°˜ì„ ë„˜ì–´ì„œ: ë¦¬ì†ŒìŠ¤ ì†Œìœ ê¶Œ</a></li>
<li><a href="#82">8.2 êµ¬í˜„: ë‹¤ì¸µ ì¸ê°€</a></li>
</ul>
</li>
<li><a href="#9">9. ì¼ë°˜ì ì¸ ì¸ê°€ ì·¨ì•½ì </a><ul>
<li><a href="#91-idor">9.1 IDOR (ì•ˆì „í•˜ì§€ ì•Šì€ ì§ì ‘ ê°ì²´ ì°¸ì¡°)</a></li>
<li><a href="#92">9.2 ê¶Œí•œ ìƒìŠ¹</a></li>
<li><a href="#93">9.3 ì¸ê°€ ì·¨ì•½ì  ì²´í¬ë¦¬ìŠ¤íŠ¸</a></li>
</ul>
</li>
<li><a href="#10">10. ì—°ìŠµ ë¬¸ì œ</a><ul>
<li><a href="#1-rbac">ì—°ìŠµ ë¬¸ì œ 1: RBAC ì‹œìŠ¤í…œ êµ¬í˜„</a></li>
<li><a href="#2-abac">ì—°ìŠµ ë¬¸ì œ 2: ABAC ì •ì±… ì—”ì§„ êµ¬ì¶•</a></li>
<li><a href="#3">ì—°ìŠµ ë¬¸ì œ 3: ì¸ê°€ ì·¨ì•½ì  ìˆ˜ì •</a></li>
<li><a href="#4">ì—°ìŠµ ë¬¸ì œ 4: ë‹¤ì¤‘ í…Œë„ŒíŠ¸ ì¸ê°€</a></li>
<li><a href="#5-opa">ì—°ìŠµ ë¬¸ì œ 5: OPA ì •ì±… ì‘ì„±</a></li>
</ul>
</li>
<li><a href="#11">11. ìš”ì•½</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="06">06. ì¸ê°€ ë° ì ‘ê·¼ ì œì–´<a class="header-link" href="#06" title="Permanent link">&para;</a></h1>
<p><strong>ì´ì „</strong>: <a href="05_Authentication.md">05. ì¸ì¦ ì‹œìŠ¤í…œ</a> | <strong>ë‹¤ìŒ</strong>: <a href="07_OWASP_Top10.md">07. OWASP Top 10 (2021)</a></p>
<hr />
<p>ì¸ê°€(Authorization)ëŠ” ì¸ì¦ëœ ì‚¬ìš©ìê°€ ë¬´ì—‡ì„ í•  ìˆ˜ ìˆëŠ”ì§€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤. ì¸ì¦ì´ "ë‹¹ì‹ ì€ ëˆ„êµ¬ì…ë‹ˆê¹Œ?"ë¼ëŠ” ì§ˆë¬¸ì— ë‹µí•œë‹¤ë©´, ì¸ê°€ëŠ” "ë‹¹ì‹ ì€ ë¬´ì—‡ì„ í•  ìˆ˜ ìˆìŠµë‹ˆê¹Œ?"ë¼ëŠ” ì§ˆë¬¸ì— ë‹µí•©ë‹ˆë‹¤. ê°•ë ¥í•œ ì¸ê°€ ì‹œìŠ¤í…œì€ ìµœì†Œ ê¶Œí•œì˜ ì›ì¹™ì„ ê°•ì œí•˜ì—¬, ì‚¬ìš©ìì™€ ì„œë¹„ìŠ¤ê°€ í•„ìš”í•œ ìµœì†Œí•œì˜ ê¶Œí•œë§Œ ê°€ì§€ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤. ì´ ë ˆìŠ¨ì—ì„œëŠ” ì£¼ìš” ì ‘ê·¼ ì œì–´ ëª¨ë¸(RBAC, ABAC, ACL), ì •ì±… ì—”ì§„, JWT ë° OAuth ìŠ¤ì½”í”„ë¥¼ ì‚¬ìš©í•œ í† í° ê¸°ë°˜ ì¸ê°€, Python/Flaskì—ì„œì˜ ì‹¤ìš©ì ì¸ êµ¬í˜„ íŒ¨í„´, ê·¸ë¦¬ê³  ì¼ë°˜ì ì¸ ì¸ê°€ ì·¨ì•½ì ì„ ë‹¤ë£¹ë‹ˆë‹¤.</p>
<h2 id="_1">í•™ìŠµ ëª©í‘œ<a class="header-link" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li>ì¸ì¦ê³¼ ì¸ê°€ì˜ ì°¨ì´ì  êµ¬ë¶„</li>
<li>ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´(RBAC) ì‹œìŠ¤í…œ êµ¬í˜„</li>
<li>ì†ì„± ê¸°ë°˜ ì ‘ê·¼ ì œì–´(ABAC)ì™€ ì‚¬ìš© ì‹œì  ì´í•´</li>
<li>ë¦¬ì†ŒìŠ¤ ìˆ˜ì¤€ ê¶Œí•œì„ ìœ„í•œ ì ‘ê·¼ ì œì–´ ëª©ë¡(ACL) ì‘ì—…</li>
<li>ì™¸ë¶€í™”ëœ ì¸ê°€ë¥¼ ìœ„í•œ OPA(Open Policy Agent)ì™€ ê°™ì€ ì •ì±… ì—”ì§„ ì‚¬ìš©</li>
<li>API ì¸ê°€ë¥¼ ìœ„í•œ JWT í´ë ˆì„ ë° OAuth 2.0 ìŠ¤ì½”í”„ í™œìš©</li>
<li>Flaskì—ì„œ ì¸ê°€ ë¯¸ë“¤ì›¨ì–´ ë° ë°ì½”ë ˆì´í„° êµ¬ì¶•</li>
<li>ì¼ë°˜ì ì¸ ì¸ê°€ ì·¨ì•½ì (IDOR, ê¶Œí•œ ìƒìŠ¹) ì‹ë³„ ë° ë°©ì§€</li>
</ul>
<hr />
<h2 id="1-vs">1. ì¸ì¦ vs ì¸ê°€<a class="header-link" href="#1-vs" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ì¸ì¦ vs ì¸ê°€                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ì¸ì¦ (AuthN)                   ì¸ê°€ (AuthZ)                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚  &quot;ë‹¹ì‹ ì€ ëˆ„êµ¬ì…ë‹ˆê¹Œ?&quot;          &quot;ë¬´ì—‡ì„ í•  ìˆ˜ ìˆìŠµë‹ˆê¹Œ?&quot;          â”‚
â”‚                                                                  â”‚
â”‚  ì‹ ì› í™•ì¸                      ê¶Œí•œ í™•ì¸                        â”‚
â”‚  ë¨¼ì € ë°œìƒ                      ì¸ì¦ í›„ ë°œìƒ                     â”‚
â”‚  401 Unauthorized              403 Forbidden                     â”‚
â”‚  (ì¸ì¦ë˜ì§€ ì•ŠìŒ)               (ì¸ì¦ëì§€ë§Œ í—ˆìš©ë˜ì§€ ì•ŠìŒ)        â”‚
â”‚                                                                  â”‚
â”‚                                                                  â”‚
â”‚  ìš”ì²­ íë¦„:                                                      â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  ìš”ì²­    â”‚â”€â”€â”€â–¶â”‚     ì¸ì¦     â”‚â”€â”€â”€â–¶â”‚    ì¸ê°€     â”‚           â”‚
â”‚  â”‚          â”‚    â”‚ &quot;ì´ ì‚¬ëŒì€   â”‚    â”‚ &quot;ì´ ì‘ì—…ì„  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ ëˆ„êµ¬ì¸ê°€?&quot;   â”‚    â”‚ í•  ìˆ˜ ìˆë‚˜?&quot;â”‚            â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                         â”‚                   â”‚                    â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”               â”‚
â”‚                    â”‚        â”‚          â”‚        â”‚                â”‚
â”‚                  ìœ íš¨   ë¬´íš¨         í—ˆìš©     ê±°ë¶€                â”‚
â”‚                    â”‚        â”‚          â”‚        â”‚                â”‚
â”‚                    â”‚    401 ì—ëŸ¬       â”‚    403 ì—ëŸ¬             â”‚
â”‚                    â”‚                   â”‚                          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                            â”‚                                     â”‚
â”‚                            â–¼                                     â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                     â”‚ ë¦¬ì†ŒìŠ¤   â”‚                                 â”‚
â”‚                     â”‚  ì ‘ê·¼    â”‚                                 â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="2-rbac">2. ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (RBAC)<a class="header-link" href="#2-rbac" title="Permanent link">&para;</a></h2>
<h3 id="21-rbac">2.1 RBAC ê°œë…<a class="header-link" href="#21-rbac" title="Permanent link">&para;</a></h3>
<p>RBACëŠ” ê¶Œí•œì„ <strong>ì—­í• (roles)</strong>ì— í• ë‹¹í•˜ê³ , ì‚¬ìš©ìëŠ” ì—­í• ì— í• ë‹¹ë©ë‹ˆë‹¤. ê°œë³„ ì‚¬ìš©ì ê¶Œí•œì´ ì•„ë‹Œ ì—­í• -ê¶Œí•œ ë§¤í•‘ì„ ê´€ë¦¬í•˜ê¸° ë•Œë¬¸ì— ê´€ë¦¬ê°€ ê°„ë‹¨í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RBAC ëª¨ë¸                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ì‚¬ìš©ì              ì—­í•               ê¶Œí•œ                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Alice  â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Admin   â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ create_user      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚          â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ delete_user      â”‚     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚          â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ view_reports     â”‚     â”‚
â”‚  â”‚  Bob   â”‚â”€â”€â”€â”    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â–¶â”‚ manage_settings  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚               â””â”€â”€â”€â–¶â”‚  Editor  â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚          â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ create_post      â”‚     â”‚
â”‚  â”‚ Carol  â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚          â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ edit_post        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â–¶â”‚ delete_own_post  â”‚     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”‚  Dan   â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Viewer  â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚          â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ view_post        â”‚     â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â–¶â”‚ view_reports     â”‚     â”‚
â”‚                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                  â”‚
â”‚  ê³„ì¸µ êµ¬ì¡° (ì„ íƒ ì‚¬í•­):                                         â”‚
â”‚  Admin â”€â”€â–¶ Editor â”€â”€â–¶ Viewer                                    â”‚
â”‚  (Adminì€ ëª¨ë“  Editor ë° Viewer ê¶Œí•œì„ ìƒì†)                   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="22-python-rbac">2.2 Pythonì—ì„œ RBAC êµ¬í˜„<a class="header-link" href="#22-python-rbac" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">rbac.py - Role-Based Access Control implementation</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Core RBAC Model</span>
<span class="c1"># ==============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Permission</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define all permissions in the system.&quot;&quot;&quot;</span>
    <span class="c1"># User management</span>
    <span class="n">CREATE_USER</span> <span class="o">=</span> <span class="s2">&quot;user:create&quot;</span>
    <span class="n">READ_USER</span> <span class="o">=</span> <span class="s2">&quot;user:read&quot;</span>
    <span class="n">UPDATE_USER</span> <span class="o">=</span> <span class="s2">&quot;user:update&quot;</span>
    <span class="n">DELETE_USER</span> <span class="o">=</span> <span class="s2">&quot;user:delete&quot;</span>

    <span class="c1"># Post management</span>
    <span class="n">CREATE_POST</span> <span class="o">=</span> <span class="s2">&quot;post:create&quot;</span>
    <span class="n">READ_POST</span> <span class="o">=</span> <span class="s2">&quot;post:read&quot;</span>
    <span class="n">UPDATE_POST</span> <span class="o">=</span> <span class="s2">&quot;post:update&quot;</span>
    <span class="n">DELETE_POST</span> <span class="o">=</span> <span class="s2">&quot;post:delete&quot;</span>
    <span class="n">PUBLISH_POST</span> <span class="o">=</span> <span class="s2">&quot;post:publish&quot;</span>

    <span class="c1"># Report management</span>
    <span class="n">VIEW_REPORTS</span> <span class="o">=</span> <span class="s2">&quot;report:view&quot;</span>
    <span class="n">EXPORT_REPORTS</span> <span class="o">=</span> <span class="s2">&quot;report:export&quot;</span>

    <span class="c1"># System</span>
    <span class="n">MANAGE_SETTINGS</span> <span class="o">=</span> <span class="s2">&quot;system:settings&quot;</span>
    <span class="n">VIEW_AUDIT_LOG</span> <span class="o">=</span> <span class="s2">&quot;system:audit&quot;</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Role</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A role is a named collection of permissions.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">permissions</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Permission</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">set</span><span class="p">)</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;Role&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># For role hierarchy</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">Permission</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all permissions including inherited ones.&quot;&quot;&quot;</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="n">perms</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_all_permissions</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">perms</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="n">Permission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this role has a specific permission.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">permission</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_permissions</span><span class="p">()</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A user with one or more roles.&quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">roles</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Role</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">set</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="n">Permission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if user has a specific permission through any role.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">role</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">permission</span><span class="p">)</span> <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if user has a specific role.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">role</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">role_name</span> <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">Permission</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all permissions from all roles.&quot;&quot;&quot;</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
            <span class="n">perms</span> <span class="o">|=</span> <span class="n">role</span><span class="o">.</span><span class="n">get_all_permissions</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">perms</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Role Definitions</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_default_roles</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Role</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the default role hierarchy.&quot;&quot;&quot;</span>

    <span class="c1"># Base role - everyone gets these</span>
    <span class="n">viewer</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;viewer&quot;</span><span class="p">,</span>
        <span class="n">permissions</span><span class="o">=</span><span class="p">{</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">READ_POST</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">READ_USER</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">VIEW_REPORTS</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Editor inherits from Viewer</span>
    <span class="n">editor</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;editor&quot;</span><span class="p">,</span>
        <span class="n">permissions</span><span class="o">=</span><span class="p">{</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">CREATE_POST</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">UPDATE_POST</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">DELETE_POST</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">PUBLISH_POST</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">EXPORT_REPORTS</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">viewer</span>
    <span class="p">)</span>

    <span class="c1"># Admin inherits from Editor</span>
    <span class="n">admin</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span>
        <span class="n">permissions</span><span class="o">=</span><span class="p">{</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">CREATE_USER</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">UPDATE_USER</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">DELETE_USER</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">MANAGE_SETTINGS</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">VIEW_AUDIT_LOG</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">editor</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;viewer&quot;</span><span class="p">:</span> <span class="n">viewer</span><span class="p">,</span>
        <span class="s2">&quot;editor&quot;</span><span class="p">:</span> <span class="n">editor</span><span class="p">,</span>
        <span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="n">admin</span><span class="p">,</span>
    <span class="p">}</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># RBAC Manager</span>
<span class="c1"># ==============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RBACManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Centralized RBAC management.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">create_default_roles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">User</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">role_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">User</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a user with specified roles.&quot;&quot;&quot;</span>
        <span class="n">roles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">role_names</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;viewer&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
                <span class="n">roles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown role: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="n">roles</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">assign_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">role_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign a role to a user.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">role_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Role </span><span class="si">{</span><span class="n">role_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">[</span><span class="n">role_name</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">revoke_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">role_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a role from a user.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">roles</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">role_name</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="n">Permission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a user has a specific permission.&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">permission</span><span class="p">)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Demo</span>
<span class="c1"># ==============================================================</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">rbac</span> <span class="o">=</span> <span class="n">RBACManager</span><span class="p">()</span>

    <span class="c1"># Create users</span>
    <span class="n">alice</span> <span class="o">=</span> <span class="n">rbac</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">])</span>
    <span class="n">bob</span> <span class="o">=</span> <span class="n">rbac</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;editor&quot;</span><span class="p">])</span>
    <span class="n">carol</span> <span class="o">=</span> <span class="n">rbac</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;carol&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;viewer&quot;</span><span class="p">])</span>

    <span class="c1"># Check permissions</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Permission Checks ===&quot;</span><span class="p">)</span>
    <span class="n">checks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">alice</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">DELETE_USER</span><span class="p">,</span> <span class="s2">&quot;Alice can delete users&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">alice</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">READ_POST</span><span class="p">,</span> <span class="s2">&quot;Alice can read posts (inherited)&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">bob</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">CREATE_POST</span><span class="p">,</span> <span class="s2">&quot;Bob can create posts&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">bob</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">DELETE_USER</span><span class="p">,</span> <span class="s2">&quot;Bob can delete users&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">carol</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">READ_POST</span><span class="p">,</span> <span class="s2">&quot;Carol can read posts&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">carol</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">CREATE_POST</span><span class="p">,</span> <span class="s2">&quot;Carol can create posts&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;ALLOWED&quot;</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="s2">&quot;DENIED&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># List all permissions</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Alice&#39;s permissions: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">alice</span><span class="o">.</span><span class="n">get_all_permissions</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">alice</span><span class="o">.</span><span class="n">get_all_permissions</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="23-flask-rbac">2.3 Flask RBAC ë¯¸ë“¤ì›¨ì–´<a class="header-link" href="#23-flask-rbac" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">flask_rbac.py - RBAC authorization middleware for Flask</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;your-secret-key&#39;</span>  <span class="c1"># Use env var in production</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Authorization Decorators</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">require_auth</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator: Require authenticated user.&quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Authentication required&quot;</span><span class="p">}),</span> <span class="mi">401</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                <span class="n">token</span><span class="p">,</span>
                <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">],</span>
                <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HS256&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">],</span>
                <span class="s1">&#39;roles&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="s1">&#39;permissions&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;permissions&#39;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Invalid token: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}),</span> <span class="mi">401</span>

        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">decorated</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_role</span><span class="p">(</span><span class="o">*</span><span class="n">allowed_roles</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator: Require user to have one of the specified roles.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="nd">@require_auth</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">user_roles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_roles</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">allowed_roles</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Forbidden&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Required roles: </span><span class="si">{</span><span class="n">allowed_roles</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">}),</span> <span class="mi">403</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_permission</span><span class="p">(</span><span class="o">*</span><span class="n">required_permissions</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator: Require user to have all specified permissions.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="nd">@require_auth</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">user_perms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;permissions&#39;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_permissions</span><span class="p">)</span> <span class="o">-</span> <span class="n">user_perms</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Forbidden&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Missing permissions: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">}),</span> <span class="mi">403</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Protected Routes</span>
<span class="c1"># ==============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_posts</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Any authenticated user can list posts.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;posts&quot;</span><span class="p">:</span> <span class="p">[]})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_permission</span><span class="p">(</span><span class="s1">&#39;post:create&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_post</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Only users with post:create permission.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="c1"># Create post logic...</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Post created&quot;</span><span class="p">}),</span> <span class="mi">201</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts/&lt;int:post_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@require_permission</span><span class="p">(</span><span class="s1">&#39;post:delete&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Only users with post:delete permission.&quot;&quot;&quot;</span>
    <span class="c1"># Additional check: can only delete own posts unless admin</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>  <span class="c1"># Your DB lookup</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span>
    <span class="n">is_admin</span> <span class="o">=</span> <span class="s1">&#39;admin&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">is_owner</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;author_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_admin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_owner</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Can only delete your own posts&quot;</span><span class="p">}),</span> <span class="mi">403</span>

    <span class="c1"># Delete post logic...</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Post deleted&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@require_role</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_users</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Admin-only endpoint.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[]})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/settings&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="nd">@require_role</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_settings</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Admin-only: modify system settings.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="c1"># Update settings logic...</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Settings updated&quot;</span><span class="p">})</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Dynamic Permission Check (for resource-level auth)</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">check_resource_access</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">resource_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a user can perform an action on a specific resource.</span>
<span class="sd">    This goes beyond role-based checks to resource-level authorization.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Example: Check if user owns the resource or has admin role</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">get_resource</span><span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Admin can do anything</span>
    <span class="k">if</span> <span class="s1">&#39;admin&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># Owner can read/update their own resources</span>
    <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># Check shared access</span>
    <span class="n">shared_with</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shared_with&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">for</span> <span class="n">share</span> <span class="ow">in</span> <span class="n">shared_with</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">share</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">share</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allowed_actions&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>

<hr />
<h2 id="3-abac">3. ì†ì„± ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (ABAC)<a class="header-link" href="#3-abac" title="Permanent link">&para;</a></h2>
<h3 id="31-abac">3.1 ABAC ê°œë…<a class="header-link" href="#31-abac" title="Permanent link">&para;</a></h3>
<p>ABACëŠ” ì£¼ì²´(ì‚¬ìš©ì), ë¦¬ì†ŒìŠ¤, ì‘ì—… ë° í™˜ê²½ì˜ <strong>ì†ì„±(attributes)</strong>ì„ ê¸°ë°˜ìœ¼ë¡œ ì ‘ê·¼ ê²°ì •ì„ ë‚´ë¦½ë‹ˆë‹¤. RBACë³´ë‹¤ ë” ìœ ì—°í•˜ì§€ë§Œ ë” ë³µì¡í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="nx">ABAC</span><span class="w"> </span><span class="nx">ëª¨ë¸</span><span class="w">                                     </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">ì ‘ê·¼</span><span class="w"> </span><span class="nx">ê²°ì •</span><span class="w"> </span><span class="p">=</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="nx">f</span><span class="p">(</span><span class="nx">ì£¼ì²´</span><span class="w"> </span><span class="nx">ì†ì„±</span><span class="p">,</span><span class="w"> </span><span class="nx">ë¦¬ì†ŒìŠ¤</span><span class="w"> </span><span class="nx">ì†ì„±</span><span class="p">,</span><span class="w">                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="nx">ì‘ì—…</span><span class="w"> </span><span class="nx">ì†ì„±</span><span class="p">,</span><span class="w"> </span><span class="nx">í™˜ê²½</span><span class="w"> </span><span class="nx">ì†ì„±</span><span class="p">)</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">ì£¼ì²´</span><span class="w"> </span><span class="nx">ì†ì„±</span><span class="p">:</span><span class="w">              </span><span class="nx">ë¦¬ì†ŒìŠ¤</span><span class="w"> </span><span class="nx">ì†ì„±</span><span class="p">:</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">role</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;doctor&quot;</span><span class="w">      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;medical_record&quot;</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">department</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ER&quot;</span><span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">department</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ER&quot;</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">clearance</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;L3&quot;</span><span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">sensitivity</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;L2&quot;</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">certification</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">owner</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;patient_123&quot;</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">ì‘ì—…</span><span class="w"> </span><span class="nx">ì†ì„±</span><span class="p">:</span><span class="w">              </span><span class="nx">í™˜ê²½</span><span class="w"> </span><span class="nx">ì†ì„±</span><span class="p">:</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;read&quot;</span><span class="w">        </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">time</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;14:30 UTC&quot;</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">purpose</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;treatment&quot;</span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">ip_address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.0.1.50&quot;</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                          </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">location</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;hospital_network&quot;</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                          </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">device_trust</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;managed&quot;</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">ì •ì±…</span><span class="w"> </span><span class="nx">ì˜ˆì‹œ</span><span class="p">:</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="s">&quot;ì‘ê¸‰ì‹¤ ë¶€ì„œì˜ ì˜ì‚¬ëŠ” ë³‘ì› ë„¤íŠ¸ì›Œí¬ì—ì„œ ê´€ë¦¬ë˜ëŠ” ê¸°ê¸°ë¥¼ í†µí•´    â”‚</span>
<span class="s">â”‚   ê·¼ë¬´ ì‹œê°„ ì¤‘ì— ì‘ê¸‰ì‹¤ ë¶€ì„œì˜ ì˜ë£Œ ê¸°ë¡ì„ ì½ì„ ìˆ˜ ìˆë‹¤.&quot;</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Subject</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;doctor&quot;</span><span class="w"> </span><span class="nx">AND</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Subject</span><span class="p">.</span><span class="nx">department</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">Resource</span><span class="p">.</span><span class="nx">department</span><span class="w"> </span><span class="nx">AND</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Action</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;read&quot;</span><span class="w"> </span><span class="nx">AND</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Environment</span><span class="p">.</span><span class="nx">time</span><span class="w"> </span><span class="nx">BETWEEN</span><span class="w"> </span><span class="s">&quot;07:00&quot;</span><span class="w"> </span><span class="nx">AND</span><span class="w"> </span><span class="s">&quot;19:00&quot;</span><span class="w"> </span><span class="nx">AND</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Environment</span><span class="p">.</span><span class="nx">location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;hospital_network&quot;</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="nx">ALLOW</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="32-rbac-vs-abac">3.2 RBAC vs ABAC ì‚¬ìš© ì‹œì <a class="header-link" href="#32-rbac-vs-abac" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>ê¸°ì¤€</th>
<th>RBAC</th>
<th>ABAC</th>
</tr>
</thead>
<tbody>
<tr>
<td>ì—­í•  ìˆ˜</td>
<td>ì†Œìˆ˜, ëª…í™•íˆ ì •ì˜ë¨</td>
<td>ë§ê±°ë‚˜ ë™ì </td>
</tr>
<tr>
<td>ì ‘ê·¼ ê²°ì •</td>
<td>ì—­í•  ë©¤ë²„ì‹­</td>
<td>ë‹¤ì¤‘ ì†ì„±</td>
</tr>
<tr>
<td>ë³µì¡ì„±</td>
<td>êµ¬í˜„ì´ ê°„ë‹¨</td>
<td>ë³µì¡í•˜ì§€ë§Œ ìœ ì—°í•¨</td>
</tr>
<tr>
<td>"ì—­í•  í­ë°œ"</td>
<td>ìœ„í—˜ (ì—­í• ì´ ë„ˆë¬´ ë§ìŒ)</td>
<td>ë¬¸ì œ ì—†ìŒ</td>
</tr>
<tr>
<td>ì»¨í…ìŠ¤íŠ¸ ì¸ì‹</td>
<td>ì—†ìŒ (ì •ì  ì—­í• )</td>
<td>ìˆìŒ (ì‹œê°„, ìœ„ì¹˜ ë“±)</td>
</tr>
<tr>
<td>ê·œì • ì¤€ìˆ˜</td>
<td>ê¸°ë³¸ ìš”êµ¬ì‚¬í•­</td>
<td>ê·œì œ ìš”êµ¬ì‚¬í•­</td>
</tr>
<tr>
<td>ì í•©í•œ ê²½ìš°</td>
<td>ëŒ€ë¶€ë¶„ì˜ ì›¹ ì•±, API</td>
<td>ì˜ë£Œ, ê¸ˆìœµ, ì •ë¶€</td>
</tr>
<tr>
<td>ì„±ëŠ¥</td>
<td>ë¹ ë¦„ (ì—­í•  ì¡°íšŒ)</td>
<td>ëŠë¦¼ (ì •ì±… í‰ê°€)</td>
</tr>
</tbody>
</table>
<h3 id="33-abac">3.3 ABAC êµ¬í˜„<a class="header-link" href="#33-abac" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">abac.py - Attribute-Based Access Control implementation</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Decision</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">ALLOW</span> <span class="o">=</span> <span class="s2">&quot;allow&quot;</span>
    <span class="n">DENY</span> <span class="o">=</span> <span class="s2">&quot;deny&quot;</span>
    <span class="n">NOT_APPLICABLE</span> <span class="o">=</span> <span class="s2">&quot;not_applicable&quot;</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AccessRequest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a request for access to a resource.&quot;&quot;&quot;</span>
    <span class="c1"># Subject attributes (who)</span>
    <span class="n">subject</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

    <span class="c1"># Resource attributes (what)</span>
    <span class="n">resource</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

    <span class="c1"># Action attributes (how)</span>
    <span class="n">action</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

    <span class="c1"># Environment attributes (context)</span>
    <span class="n">environment</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Policy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single ABAC policy.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># Lower = higher priority</span>
    <span class="n">effect</span><span class="p">:</span> <span class="n">Decision</span>  <span class="c1"># ALLOW or DENY</span>
    <span class="n">condition</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">AccessRequest</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">AccessRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decision</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate this policy against a request.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect</span>
            <span class="k">return</span> <span class="n">Decision</span><span class="o">.</span><span class="n">NOT_APPLICABLE</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Decision</span><span class="o">.</span><span class="n">NOT_APPLICABLE</span>


<span class="k">class</span><span class="w"> </span><span class="nc">PolicyEngine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluates access requests against a set of policies.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_decision</span><span class="p">:</span> <span class="n">Decision</span> <span class="o">=</span> <span class="n">Decision</span><span class="o">.</span><span class="n">DENY</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Policy</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_decision</span> <span class="o">=</span> <span class="n">default_decision</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">Policy</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a policy to the engine.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
        <span class="c1"># Keep sorted by priority</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">AccessRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decision</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate all policies. Uses deny-overrides combining algorithm:</span>
<span class="sd">        - If any policy says DENY, result is DENY</span>
<span class="sd">        - If at least one says ALLOW and none say DENY, result is ALLOW</span>
<span class="sd">        - Otherwise, use default decision</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">has_allow</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
            <span class="n">decision</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">decision</span> <span class="o">==</span> <span class="n">Decision</span><span class="o">.</span><span class="n">DENY</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Decision</span><span class="o">.</span><span class="n">DENY</span>  <span class="c1"># Deny overrides</span>

            <span class="k">if</span> <span class="n">decision</span> <span class="o">==</span> <span class="n">Decision</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">:</span>
                <span class="n">has_allow</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">Decision</span><span class="o">.</span><span class="n">ALLOW</span> <span class="k">if</span> <span class="n">has_allow</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_decision</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Example Policies</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_medical_policies</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PolicyEngine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create policies for a healthcare system.&quot;&quot;&quot;</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">PolicyEngine</span><span class="p">(</span><span class="n">default_decision</span><span class="o">=</span><span class="n">Decision</span><span class="o">.</span><span class="n">DENY</span><span class="p">)</span>

    <span class="c1"># Policy 1: Doctors can read patient records in their department</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="n">Policy</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;doctor_read_department_records&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Doctors can read records in their department&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">effect</span><span class="o">=</span><span class="n">Decision</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">,</span>
        <span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">req</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;doctor&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;read&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;medical_record&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;department&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;department&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">))</span>

    <span class="c1"># Policy 2: Doctors can write records for their patients</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="n">Policy</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;doctor_write_own_patients&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Doctors can update records of patients assigned to them&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">effect</span><span class="o">=</span><span class="n">Decision</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">,</span>
        <span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">req</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;doctor&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;write&quot;</span><span class="p">,</span> <span class="s2">&quot;update&quot;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;medical_record&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assigned_doctors&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="p">)</span>
    <span class="p">))</span>

    <span class="c1"># Policy 3: Nurses can read records in their department during shifts</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="n">Policy</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;nurse_read_during_shift&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Nurses can read records during their shift hours&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">effect</span><span class="o">=</span><span class="n">Decision</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">,</span>
        <span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">req</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;nurse&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;read&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;medical_record&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;department&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;department&quot;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">_is_during_shift</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">),</span>
                            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shift_start&quot;</span><span class="p">),</span>
                            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shift_end&quot;</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="p">))</span>

    <span class="c1"># Policy 4: No access from untrusted devices</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="n">Policy</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;deny_untrusted_devices&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Deny access from non-managed devices&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># High priority - evaluated first</span>
        <span class="n">effect</span><span class="o">=</span><span class="n">Decision</span><span class="o">.</span><span class="n">DENY</span><span class="p">,</span>
        <span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">req</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">req</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;high&quot;</span><span class="p">,</span> <span class="s2">&quot;critical&quot;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_trust&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;managed&quot;</span>
        <span class="p">)</span>
    <span class="p">))</span>

    <span class="c1"># Policy 5: Emergency override - on-duty doctors in ER</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="n">Policy</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;emergency_override&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ER doctors can access any record during emergency&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">effect</span><span class="o">=</span><span class="n">Decision</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">,</span>
        <span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">req</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;doctor&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;department&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;emergency&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;read&quot;</span> <span class="ow">and</span>
            <span class="n">req</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;emergency_mode&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="p">)</span>
    <span class="p">))</span>

    <span class="k">return</span> <span class="n">engine</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_is_during_shift</span><span class="p">(</span><span class="n">current_time</span><span class="p">,</span> <span class="n">shift_start</span><span class="p">,</span> <span class="n">shift_end</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if current time is within shift hours.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">current_time</span><span class="p">,</span> <span class="n">shift_start</span><span class="p">,</span> <span class="n">shift_end</span><span class="p">]):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_time</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">shift_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">shift_start</span><span class="p">)</span>
    <span class="n">shift_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">shift_end</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shift_start</span> <span class="o">&lt;=</span> <span class="n">shift_end</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">shift_start</span> <span class="o">&lt;=</span> <span class="n">current_time</span> <span class="o">&lt;=</span> <span class="n">shift_end</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Overnight shift</span>
        <span class="k">return</span> <span class="n">current_time</span> <span class="o">&gt;=</span> <span class="n">shift_start</span> <span class="ow">or</span> <span class="n">current_time</span> <span class="o">&lt;=</span> <span class="n">shift_end</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Demo</span>
<span class="c1"># ==============================================================</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_medical_policies</span><span class="p">()</span>

    <span class="c1"># Test Case 1: Doctor reading records in their department</span>
    <span class="n">request1</span> <span class="o">=</span> <span class="n">AccessRequest</span><span class="p">(</span>
        <span class="n">subject</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dr_smith&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;doctor&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;cardiology&quot;</span><span class="p">},</span>
        <span class="n">resource</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;medical_record&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;cardiology&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;sensitivity&quot;</span><span class="p">:</span> <span class="s2">&quot;high&quot;</span><span class="p">},</span>
        <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;read&quot;</span><span class="p">},</span>
        <span class="n">environment</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;device_trust&quot;</span><span class="p">:</span> <span class="s2">&quot;managed&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-01-15T10:30:00&quot;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Doctor reads own dept: </span><span class="si">{</span><span class="n">engine</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">request1</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Test Case 2: Doctor reading records in different department</span>
    <span class="n">request2</span> <span class="o">=</span> <span class="n">AccessRequest</span><span class="p">(</span>
        <span class="n">subject</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dr_smith&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;doctor&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;cardiology&quot;</span><span class="p">},</span>
        <span class="n">resource</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;medical_record&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;neurology&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;sensitivity&quot;</span><span class="p">:</span> <span class="s2">&quot;high&quot;</span><span class="p">},</span>
        <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;read&quot;</span><span class="p">},</span>
        <span class="n">environment</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;device_trust&quot;</span><span class="p">:</span> <span class="s2">&quot;managed&quot;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Doctor reads other dept: </span><span class="si">{</span><span class="n">engine</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">request2</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Test Case 3: Access from untrusted device (denied regardless)</span>
    <span class="n">request3</span> <span class="o">=</span> <span class="n">AccessRequest</span><span class="p">(</span>
        <span class="n">subject</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dr_smith&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;doctor&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;cardiology&quot;</span><span class="p">},</span>
        <span class="n">resource</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;medical_record&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;cardiology&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;sensitivity&quot;</span><span class="p">:</span> <span class="s2">&quot;high&quot;</span><span class="p">},</span>
        <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;read&quot;</span><span class="p">},</span>
        <span class="n">environment</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;device_trust&quot;</span><span class="p">:</span> <span class="s2">&quot;personal&quot;</span><span class="p">}</span>  <span class="c1"># Not managed!</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Untrusted device: </span><span class="si">{</span><span class="n">engine</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">request3</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Test Case 4: Emergency override</span>
    <span class="n">request4</span> <span class="o">=</span> <span class="n">AccessRequest</span><span class="p">(</span>
        <span class="n">subject</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dr_jones&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;doctor&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;emergency&quot;</span><span class="p">},</span>
        <span class="n">resource</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;medical_record&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">:</span> <span class="s2">&quot;cardiology&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;sensitivity&quot;</span><span class="p">:</span> <span class="s2">&quot;critical&quot;</span><span class="p">},</span>
        <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;read&quot;</span><span class="p">},</span>
        <span class="n">environment</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;device_trust&quot;</span><span class="p">:</span> <span class="s2">&quot;managed&quot;</span><span class="p">,</span> <span class="s2">&quot;emergency_mode&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Emergency override: </span><span class="si">{</span><span class="n">engine</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">request4</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="4-acl">4. ì ‘ê·¼ ì œì–´ ëª©ë¡ (ACL)<a class="header-link" href="#4-acl" title="Permanent link">&para;</a></h2>
<h3 id="41-acl">4.1 ACL ê°œë…<a class="header-link" href="#41-acl" title="Permanent link">&para;</a></h3>
<p>ACLì€ <strong>ê°œë³„ ë¦¬ì†ŒìŠ¤ ìˆ˜ì¤€</strong>ì—ì„œ ê¶Œí•œì„ ì •ì˜í•©ë‹ˆë‹¤. ê° ë¦¬ì†ŒìŠ¤ì—ëŠ” ì–´ë–¤ ì£¼ì²´(ì‚¬ìš©ì, ê·¸ë£¹)ê°€ ì–´ë–¤ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ”ì§€ ì§€ì •í•˜ëŠ” í•­ëª© ëª©ë¡ì´ ìˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ACL ëª¨ë¸                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ë¦¬ì†ŒìŠ¤: &quot;Project Plan.docx&quot;                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ACL í•­ëª©           â”‚ ê¶Œí•œ                             â”‚      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚  â”‚ alice (ì†Œìœ ì)      â”‚ read, write, delete, share      â”‚      â”‚
â”‚  â”‚ bob                 â”‚ read, write                     â”‚      â”‚
â”‚  â”‚ carol               â”‚ read                            â”‚      â”‚
â”‚  â”‚ engineering (ê·¸ë£¹)  â”‚ read, comment                   â”‚      â”‚
â”‚  â”‚ <span class="gs">* (ëª¨ë“  ì‚¬ëŒ)       â”‚ (ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ)                â”‚      â”‚</span>
<span class="gs">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚</span>
<span class="gs">â”‚                                                                  â”‚</span>
<span class="gs">â”‚  ë¦¬ì†ŒìŠ¤: &quot;Company Financials.xlsx&quot;                               â”‚</span>
<span class="gs">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚</span>
<span class="gs">â”‚  â”‚ ACL í•­ëª©           â”‚ ê¶Œí•œ                             â”‚      â”‚</span>
<span class="gs">â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚</span>
<span class="gs">â”‚  â”‚ alice (ì†Œìœ ì)      â”‚ read, write, delete, share      â”‚      â”‚</span>
<span class="gs">â”‚  â”‚ finance (ê·¸ë£¹)      â”‚ read, write                     â”‚      â”‚</span>
<span class="gs">â”‚  â”‚ ceo                 â”‚ read                            â”‚      â”‚</span>
<span class="gs">â”‚  â”‚ *</span> (ëª¨ë“  ì‚¬ëŒ)       â”‚ (ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ)                â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                  â”‚
â”‚  Unix íŒŒì¼ ê¶Œí•œ (ë‹¨ìˆœí™”ëœ ACL):                                 â”‚
â”‚  -rwxr-xr--  owner  group  file.txt                             â”‚
â”‚   â”‚â”‚â”‚ â”‚â”‚â”‚ â”‚â”‚â”‚                                                    â”‚
â”‚   â”‚â”‚â”‚ â”‚â”‚â”‚ â””â”´â”´â”€â”€ Others: ì½ê¸°ë§Œ                                 â”‚
â”‚   â”‚â”‚â”‚ â””â”´â”´â”€â”€â”€â”€â”€â”€ Group: ì½ê¸° + ì‹¤í–‰                             â”‚
â”‚   â””â”´â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Owner: ì½ê¸° + ì“°ê¸° + ì‹¤í–‰                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="42-acl">4.2 ACL êµ¬í˜„<a class="header-link" href="#42-acl" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">acl.py - Access Control List implementation for resource-level permissions</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flag</span><span class="p">,</span> <span class="n">auto</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ACLPermission</span><span class="p">(</span><span class="n">Flag</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Permission flags (combinable with bitwise OR).&quot;&quot;&quot;</span>
    <span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">READ</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">WRITE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">DELETE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">SHARE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">ADMIN</span> <span class="o">=</span> <span class="n">READ</span> <span class="o">|</span> <span class="n">WRITE</span> <span class="o">|</span> <span class="n">DELETE</span> <span class="o">|</span> <span class="n">SHARE</span>  <span class="c1"># All permissions combined</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ACLEntry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single ACL entry mapping a principal to permissions.&quot;&quot;&quot;</span>
    <span class="n">principal_type</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &quot;user&quot; or &quot;group&quot;</span>
    <span class="n">principal_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">permissions</span><span class="p">:</span> <span class="n">ACLPermission</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Resource</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A resource with an access control list.&quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">owner_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">acl</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ACLEntry</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">grant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">principal_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">principal_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">permissions</span><span class="p">:</span> <span class="n">ACLPermission</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Grant permissions to a principal.&quot;&quot;&quot;</span>
        <span class="c1"># Check if entry already exists</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">principal_type</span> <span class="o">==</span> <span class="n">principal_type</span> <span class="ow">and</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">principal_id</span> <span class="o">==</span> <span class="n">principal_id</span><span class="p">):</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">permissions</span> <span class="o">|=</span> <span class="n">permissions</span>  <span class="c1"># Add permissions</span>
                <span class="k">return</span>

        <span class="c1"># Create new entry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ACLEntry</span><span class="p">(</span>
            <span class="n">principal_type</span><span class="o">=</span><span class="n">principal_type</span><span class="p">,</span>
            <span class="n">principal_id</span><span class="o">=</span><span class="n">principal_id</span><span class="p">,</span>
            <span class="n">permissions</span><span class="o">=</span><span class="n">permissions</span><span class="p">,</span>
        <span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">revoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">principal_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">principal_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">permissions</span><span class="p">:</span> <span class="n">ACLPermission</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Revoke permissions (or all access) from a principal.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">permissions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Remove entire entry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acl</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">principal_type</span> <span class="o">==</span> <span class="n">principal_type</span> <span class="ow">and</span>
                       <span class="n">e</span><span class="o">.</span><span class="n">principal_id</span> <span class="o">==</span> <span class="n">principal_id</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">principal_type</span> <span class="o">==</span> <span class="n">principal_type</span> <span class="ow">and</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">principal_id</span> <span class="o">==</span> <span class="n">principal_id</span><span class="p">):</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">permissions</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">permissions</span>  <span class="c1"># Remove specific perms</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_groups</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                     <span class="n">required</span><span class="p">:</span> <span class="n">ACLPermission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a user has the required permissions.&quot;&quot;&quot;</span>
        <span class="c1"># Owner always has full access</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">effective_perms</span> <span class="o">=</span> <span class="n">ACLPermission</span><span class="o">.</span><span class="n">NONE</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">principal_type</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">principal_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
                <span class="n">effective_perms</span> <span class="o">|=</span> <span class="n">entry</span><span class="o">.</span><span class="n">permissions</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">principal_type</span> <span class="o">==</span> <span class="s2">&quot;group&quot;</span> <span class="ow">and</span>
                  <span class="n">entry</span><span class="o">.</span><span class="n">principal_id</span> <span class="ow">in</span> <span class="n">user_groups</span><span class="p">):</span>
                <span class="n">effective_perms</span> <span class="o">|=</span> <span class="n">entry</span><span class="o">.</span><span class="n">permissions</span>

        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">effective_perms</span> <span class="o">&amp;</span> <span class="n">required</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_effective_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">user_groups</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ACLPermission</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all effective permissions for a user.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ACLPermission</span><span class="o">.</span><span class="n">ADMIN</span>

        <span class="n">effective</span> <span class="o">=</span> <span class="n">ACLPermission</span><span class="o">.</span><span class="n">NONE</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">principal_type</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">principal_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
                <span class="n">effective</span> <span class="o">|=</span> <span class="n">entry</span><span class="o">.</span><span class="n">permissions</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">principal_type</span> <span class="o">==</span> <span class="s2">&quot;group&quot;</span> <span class="ow">and</span>
                  <span class="n">entry</span><span class="o">.</span><span class="n">principal_id</span> <span class="ow">in</span> <span class="n">user_groups</span><span class="p">):</span>
                <span class="n">effective</span> <span class="o">|=</span> <span class="n">entry</span><span class="o">.</span><span class="n">permissions</span>

        <span class="k">return</span> <span class="n">effective</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># ACL Manager with Database Backend (simplified)</span>
<span class="c1"># ==============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ACLManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manage ACLs across multiple resources.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Resource</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">owner_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Resource</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new resource.&quot;&quot;&quot;</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">resource_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="n">owner_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">resource_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span>
        <span class="k">return</span> <span class="n">resource</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_groups</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
              <span class="n">resource_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="n">ACLPermission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check access to a resource.&quot;&quot;&quot;</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">resource</span><span class="o">.</span><span class="n">check_access</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_groups</span><span class="p">,</span> <span class="n">permission</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">share</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">requesting_user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">target_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">permissions</span><span class="p">:</span> <span class="n">ACLPermission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Share a resource (only owner or users with SHARE can do this).&quot;&quot;&quot;</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check if requesting user can share</span>
        <span class="k">if</span> <span class="n">requesting_user_id</span> <span class="o">!=</span> <span class="n">resource</span><span class="o">.</span><span class="n">owner_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="o">.</span><span class="n">check_access</span><span class="p">(</span>
                <span class="n">requesting_user_id</span><span class="p">,</span> <span class="nb">set</span><span class="p">(),</span> <span class="n">ACLPermission</span><span class="o">.</span><span class="n">SHARE</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">resource</span><span class="o">.</span><span class="n">grant</span><span class="p">(</span><span class="n">target_type</span><span class="p">,</span> <span class="n">target_id</span><span class="p">,</span> <span class="n">permissions</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Demo</span>
<span class="c1"># ==============================================================</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ACLManager</span><span class="p">()</span>

    <span class="c1"># Create a document</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">create_resource</span><span class="p">(</span><span class="s2">&quot;doc1&quot;</span><span class="p">,</span> <span class="s2">&quot;Project Plan.docx&quot;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>

    <span class="c1"># Share with bob (read + write)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">share</span><span class="p">(</span><span class="s2">&quot;doc1&quot;</span><span class="p">,</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;bob&quot;</span><span class="p">,</span>
                  <span class="n">ACLPermission</span><span class="o">.</span><span class="n">READ</span> <span class="o">|</span> <span class="n">ACLPermission</span><span class="o">.</span><span class="n">WRITE</span><span class="p">)</span>

    <span class="c1"># Share with engineering group (read only)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">share</span><span class="p">(</span><span class="s2">&quot;doc1&quot;</span><span class="p">,</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="s2">&quot;engineering&quot;</span><span class="p">,</span> <span class="n">ACLPermission</span><span class="o">.</span><span class="n">READ</span><span class="p">)</span>

    <span class="c1"># Check access</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== ACL Checks ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alice (owner) read:  </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">set</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">READ</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alice (owner) delete: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">set</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">DELETE</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bob read:   </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">set</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">READ</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bob write:  </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">set</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">WRITE</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bob delete: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">set</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">DELETE</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Carol is in engineering group</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Carol (eng) read:  </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;carol&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;engineering&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">READ</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Carol (eng) write: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;carol&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;engineering&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">WRITE</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Dan has no access</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dan read: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;dan&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">set</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;doc1&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ACLPermission</span><span class="o">.</span><span class="n">READ</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="5-opa-open-policy-agent">5. ì •ì±… ì—”ì§„: OPA (Open Policy Agent)<a class="header-link" href="#5-opa-open-policy-agent" title="Permanent link">&para;</a></h2>
<h3 id="51-opa">5.1 OPAë€?<a class="header-link" href="#51-opa" title="Permanent link">&para;</a></h3>
<p>Open Policy Agent (OPA)ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì—ì„œ ì •ì±… ì˜ì‚¬ ê²°ì •ì„ ë¶„ë¦¬í•˜ëŠ” ë²”ìš© ì •ì±… ì—”ì§„ì…ë‹ˆë‹¤. ì •ì±…ì€ ì„ ì–¸ì  ì¿¼ë¦¬ ì–¸ì–´ì¸ <strong>Rego</strong>ë¡œ ì‘ì„±ë©ë‹ˆë‹¤.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">OPA</span><span class="w"> </span><span class="n">ì•„í‚¤í…ì²˜</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">       </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">ì• í”Œë¦¬ì¼€ì´ì…˜</span><span class="w">  </span><span class="err">â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚</span><span class="w">     </span><span class="n">OPA</span><span class="w">      </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="p">(</span><span class="n">Python</span><span class="p">,</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="n">Java</span><span class="p">,</span><span class="w">     </span><span class="err">â”‚â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â–¶â”‚</span><span class="w"> </span><span class="n">Rego</span><span class="w"> </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="k">Go</span><span class="p">...)</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="n">Policy</span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚â—€â”€â”€â”€â”€â”€â”€â”‚</span><span class="w">   </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">              </span><span class="err">â”‚</span><span class="n">Decision</span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">       </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="k">Data</span><span class="w"> </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                         </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="p">(</span><span class="n">JSON</span><span class="p">)</span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                         </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">   </span><span class="err">â”‚</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                         </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">ë°°í¬</span><span class="w"> </span><span class="nl">ì˜µì…˜</span><span class="p">:</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">ë¼ì´ë¸ŒëŸ¬ë¦¬</span><span class="w"> </span><span class="p">(</span><span class="n">ì•±ì—</span><span class="w"> </span><span class="n">ë‚´ì¥</span><span class="p">)</span><span class="w">                                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">ì‚¬ì´ë“œì¹´</span><span class="w"> </span><span class="p">(</span><span class="n">ì•±ê³¼</span><span class="w"> </span><span class="n">í•¨ê»˜</span><span class="w"> </span><span class="n">ì‹¤í–‰ë˜ëŠ”</span><span class="w"> </span><span class="n">ë°ëª¬</span><span class="p">)</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="n">ë…ë¦½</span><span class="w"> </span><span class="n">ì‹¤í–‰í˜•</span><span class="w"> </span><span class="n">ì„œë¹„ìŠ¤</span><span class="w"> </span><span class="p">(</span><span class="n">ì¤‘ì•™</span><span class="w"> </span><span class="n">ì§‘ì¤‘ì‹</span><span class="p">)</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">ì£¼ìš”</span><span class="w"> </span><span class="nl">ì´ì </span><span class="p">:</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">ì½”ë“œë¡œì„œì˜</span><span class="w"> </span><span class="n">ì •ì±…</span><span class="w"> </span><span class="p">(</span><span class="n">ë²„ì „</span><span class="w"> </span><span class="n">ê´€ë¦¬</span><span class="p">,</span><span class="w"> </span><span class="n">í…ŒìŠ¤íŠ¸</span><span class="p">,</span><span class="w"> </span><span class="n">ê°ì‚¬</span><span class="p">)</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">ì–¸ì–´</span><span class="w"> </span><span class="n">ë…ë¦½ì </span><span class="w"> </span><span class="p">(</span><span class="n">ëª¨ë“ </span><span class="w"> </span><span class="n">ì•±ì´</span><span class="w"> </span><span class="n">OPAë¥¼</span><span class="w"> </span><span class="n">ì¿¼ë¦¬</span><span class="w"> </span><span class="n">ê°€ëŠ¥</span><span class="p">)</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">ê´€ì‹¬ì‚¬</span><span class="w"> </span><span class="n">ë¶„ë¦¬</span><span class="w"> </span><span class="p">(</span><span class="n">ê°œë°œìëŠ”</span><span class="w"> </span><span class="n">ë¡œì§</span><span class="w"> </span><span class="n">ì‘ì„±</span><span class="p">,</span><span class="w"> </span><span class="n">ë³´ì•ˆíŒ€ì€</span><span class="w"> </span><span class="n">ì •ì±…</span><span class="w"> </span><span class="n">ì‘ì„±</span><span class="p">)</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="52-rego">5.2 Rego ì •ì±… ì–¸ì–´<a class="header-link" href="#52-rego" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># authz.rego - Example OPA policy for API authorization</span>

<span class="k">package</span><span class="w"> </span><span class="n">authz</span>

<span class="k">import</span><span class="w"> </span><span class="n">rego</span><span class="p">.</span><span class="n">v1</span>

<span class="c1"># Default deny all requests</span>
<span class="k">default</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">false</span>

<span class="c1"># Admin users can do anything</span>
<span class="n">allow</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">roles</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;admin&quot;</span>
<span class="p">}</span>

<span class="c1"># Users can read their own profile</span>
<span class="n">allow</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">action</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;read&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;profile&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">id</span>
<span class="p">}</span>

<span class="c1"># Editors can create and update posts</span>
<span class="n">allow</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">roles</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;editor&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">action</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;create&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;update&quot;</span><span class="p">}</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;post&quot;</span>
<span class="p">}</span>

<span class="c1"># Users can delete their own posts</span>
<span class="n">allow</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">action</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;delete&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;post&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">id</span>
<span class="p">}</span>

<span class="c1"># Time-based access: deny outside business hours for sensitive data</span>
<span class="n">deny</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">sensitivity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;high&quot;</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">is_business_hours</span>
<span class="p">}</span>

<span class="n">is_business_hours</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">hour</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">time</span><span class="p">.</span><span class="n">clock</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">now_ns</span><span class="p">())[</span><span class="m">0</span><span class="p">]</span>
<span class="w">    </span><span class="n">hour</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">8</span>
<span class="w">    </span><span class="n">hour</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">18</span>
<span class="p">}</span>

<span class="c1"># Final decision (deny overrides allow)</span>
<span class="n">decision</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;allow&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">allow</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">deny</span>
<span class="p">}</span>

<span class="n">decision</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;deny&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">allow</span>
<span class="p">}</span>

<span class="n">decision</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;deny&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">deny</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="53-python-opa">5.3 Pythonê³¼ OPA í†µí•©<a class="header-link" href="#53-python-opa" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">opa_integration.py - Integrating OPA with a Python/Flask application</span>
<span class="sd">pip install requests</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># OPA runs as a sidecar or standalone service</span>
<span class="n">OPA_URL</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8181/v1/data/authz/decision&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_opa_policy</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Query OPA for an authorization decision.&quot;&quot;&quot;</span>
    <span class="n">opa_input</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
            <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="n">resource</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">OPA_URL</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="n">opa_input</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Fail fast</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;allow&quot;</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OPA query failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Fail closed (deny on error)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_opa</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator that checks OPA policy before allowing access.</span>
<span class="sd">    resource_fn: function that builds resource dict from request context</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_user&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not authenticated&quot;</span><span class="p">}),</span> <span class="mi">401</span>

            <span class="c1"># Build resource context</span>
            <span class="k">if</span> <span class="n">resource_fn</span><span class="p">:</span>
                <span class="n">resource</span> <span class="o">=</span> <span class="n">resource_fn</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resource</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">}</span>

            <span class="c1"># Query OPA</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_opa_policy</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Access denied by policy&quot;</span><span class="p">}),</span> <span class="mi">403</span>

            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="c1"># Example resource builders</span>
<span class="k">def</span><span class="w"> </span><span class="nf">post_resource</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">post_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build resource dict for post endpoints.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">post_id</span><span class="p">:</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">get_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>  <span class="c1"># Your DB lookup</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">post_id</span><span class="p">,</span>
            <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author_id&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">post</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;sensitivity&quot;</span><span class="p">:</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;post&quot;</span><span class="p">}</span>


<span class="c1"># Protected routes using OPA</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_opa</span><span class="p">(</span><span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">req</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;post&quot;</span><span class="p">})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_post</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Post created&quot;</span><span class="p">}),</span> <span class="mi">201</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts/&lt;int:post_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@require_opa</span><span class="p">(</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">post_resource</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Post deleted&quot;</span><span class="p">})</span>
</code></pre></div>

<hr />
<h2 id="6-jwt">6. ì¸ê°€ë¥¼ ìœ„í•œ JWT í´ë ˆì„<a class="header-link" href="#6-jwt" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 í‘œì¤€ ë° ì‚¬ìš©ì ì •ì˜ í´ë ˆì„<a class="header-link" href="#61" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ì¸ê°€ë¥¼ ìœ„í•œ JWT í´ë ˆì„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  í‘œì¤€ (ë“±ë¡ëœ) í´ë ˆì„:                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ í´ë ˆì„     â”‚ ëª©ì                                       â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ sub        â”‚ ì£¼ì²´ (ì‚¬ìš©ì ID)                          â”‚     â”‚
â”‚  â”‚ iss        â”‚ ë°œê¸‰ì (í† í°ì„ ìƒì„±í•œ ì£¼ì²´)              â”‚     â”‚
â”‚  â”‚ aud        â”‚ ëŒ€ìƒì (í† í°ì„ ìˆ˜ë½í•´ì•¼ í•˜ëŠ” ì£¼ì²´)        â”‚     â”‚
â”‚  â”‚ exp        â”‚ ë§Œë£Œ ì‹œê°„                                 â”‚     â”‚
â”‚  â”‚ iat        â”‚ ë°œê¸‰ ì‹œê°„                                 â”‚     â”‚
â”‚  â”‚ nbf        â”‚ ì´ì „ ì‹œê°„                                 â”‚     â”‚
â”‚  â”‚ jti        â”‚ JWT ID (ê³ ìœ  ì‹ë³„ì)                      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                  â”‚
â”‚  ì‚¬ìš©ì ì •ì˜ ì¸ê°€ í´ë ˆì„:                                       â”‚
â”‚  {                                                               â”‚
â”‚    &quot;sub&quot;: &quot;user_123&quot;,                                            â”‚
â”‚    &quot;roles&quot;: [&quot;editor&quot;, &quot;reviewer&quot;],                              â”‚
â”‚    &quot;permissions&quot;: [&quot;post:create&quot;, &quot;post:update&quot;, &quot;post:read&quot;],   â”‚
â”‚    &quot;org_id&quot;: &quot;org_456&quot;,                                          â”‚
â”‚    &quot;department&quot;: &quot;engineering&quot;,                                  â”‚
â”‚    &quot;tier&quot;: &quot;premium&quot;,                                            â”‚
â”‚    &quot;scope&quot;: &quot;read write&quot;                                         â”‚
â”‚  }                                                               â”‚
â”‚                                                                  â”‚
â”‚  ê²½ê³ : JWT í˜ì´ë¡œë“œë¥¼ ì‘ê²Œ ìœ ì§€í•˜ì„¸ìš”!                          â”‚
â”‚  - JWTëŠ” ëª¨ë“  ìš”ì²­ê³¼ í•¨ê»˜ ì „ì†¡ë©ë‹ˆë‹¤ (Authorization í—¤ë”)       â”‚
â”‚  - í° í˜ì´ë¡œë“œëŠ” ëŒ€ì—­í­ê³¼ ì§€ì—° ì‹œê°„ì„ ì¦ê°€ì‹œí‚µë‹ˆë‹¤              â”‚
â”‚  - JWTì—ëŠ” ìµœì†Œí•œì˜ ì¸ì¦ ì •ë³´ë§Œ ë„£ê³ , ì„¸ë¶€ ì •ë³´ëŠ” DB/ìºì‹œì—ì„œ   â”‚
â”‚    ê°€ì ¸ì˜¤ì„¸ìš”                                                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="62">6.2 í´ë ˆì„ ê¸°ë°˜ ì¸ê°€ ë¯¸ë“¤ì›¨ì–´<a class="header-link" href="#62" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">jwt_authz.py - JWT claim-based authorization</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">JWT_SECRET</span> <span class="o">=</span> <span class="s2">&quot;your-256-bit-secret&quot;</span>  <span class="c1"># Use env var in production</span>


<span class="k">def</span><span class="w"> </span><span class="nf">decode_jwt</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decode and validate JWT.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
        <span class="n">token</span><span class="p">,</span>
        <span class="n">JWT_SECRET</span><span class="p">,</span>
        <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">],</span>
        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;require&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="s2">&quot;sub&quot;</span><span class="p">,</span> <span class="s2">&quot;iss&quot;</span><span class="p">]}</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_claims</span><span class="p">(</span><span class="o">**</span><span class="n">required_claims</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator that checks JWT claims match requirements.</span>

<span class="sd">    Usage:</span>
<span class="sd">        @require_claims(roles=[&quot;admin&quot;], tier=&quot;premium&quot;)</span>
<span class="sd">        @require_claims(permissions=[&quot;post:create&quot;])</span>
<span class="sd">        @require_claims(org_id=lambda v: v == g.resource_org_id)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Extract token</span>
            <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Missing token&quot;</span><span class="p">}),</span> <span class="mi">401</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">claims</span> <span class="o">=</span> <span class="n">decode_jwt</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">claims</span> <span class="o">=</span> <span class="n">claims</span>
            <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">401</span>

            <span class="c1"># Check each required claim</span>
            <span class="k">for</span> <span class="n">claim_name</span><span class="p">,</span> <span class="n">expected</span> <span class="ow">in</span> <span class="n">required_claims</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">actual</span> <span class="o">=</span> <span class="n">claims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">claim_name</span><span class="p">)</span>

                <span class="c1"># Callable check (custom validation function)</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">expected</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">expected</span><span class="p">(</span><span class="n">actual</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Claim &#39;</span><span class="si">{</span><span class="n">claim_name</span><span class="si">}</span><span class="s2">&#39; validation failed&quot;</span>
                        <span class="p">}),</span> <span class="mi">403</span>

                <span class="c1"># List check (user must have at least one matching value)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">user_values</span> <span class="o">=</span> <span class="n">actual</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">actual</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">user_values</span><span class="p">)):</span>
                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Required claim &#39;</span><span class="si">{</span><span class="n">claim_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">}),</span> <span class="mi">403</span>

                <span class="c1"># Direct value check</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">actual</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Claim &#39;</span><span class="si">{</span><span class="n">claim_name</span><span class="si">}</span><span class="s2">&#39; mismatch&quot;</span>
                        <span class="p">}),</span> <span class="mi">403</span>

            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="c1"># Route examples</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/dashboard&#39;</span><span class="p">)</span>
<span class="nd">@require_claims</span><span class="p">(</span><span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">admin_dashboard</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Welcome, admin&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/premium/features&#39;</span><span class="p">)</span>
<span class="nd">@require_claims</span><span class="p">(</span><span class="n">tier</span><span class="o">=</span><span class="s2">&quot;premium&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">premium_features</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;advanced_analytics&quot;</span><span class="p">,</span> <span class="s2">&quot;api_access&quot;</span><span class="p">]})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_claims</span><span class="p">(</span><span class="n">permissions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;post:create&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_post</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Post created&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/org/&lt;org_id&gt;/data&#39;</span><span class="p">)</span>
<span class="nd">@require_claims</span><span class="p">(</span><span class="n">org_id</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">view_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;org_id&#39;</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">org_data</span><span class="p">(</span><span class="n">org_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Only users belonging to this org can access.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;org_id&quot;</span><span class="p">:</span> <span class="n">org_id</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[]})</span>
</code></pre></div>

<hr />
<h2 id="7-oauth-20">7. OAuth 2.0 ìŠ¤ì½”í”„<a class="header-link" href="#7-oauth-20" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 ìŠ¤ì½”í”„ ì´í•´í•˜ê¸°<a class="header-link" href="#71" title="Permanent link">&para;</a></h3>
<p>OAuth 2.0 ìŠ¤ì½”í”„ëŠ” ì•¡ì„¸ìŠ¤ í† í°ì´ í•  ìˆ˜ ìˆëŠ” ì‘ì—…ì„ ì œí•œí•©ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì— <strong>ì‚¬ìš©ìê°€ ë¶€ì—¬í•œ ê¶Œí•œ</strong>ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</p>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="n">OAuth</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="n">ìŠ¤ì½”í”„</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">ë™ì˜</span><span class="w"> </span><span class="nl">í™”ë©´</span><span class="p">:</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="ss">&quot;MyApp&quot;</span><span class="n">ì´</span><span class="w"> </span><span class="n">ê·€í•˜ì˜</span><span class="w"> </span><span class="n">ê³„ì •ì—</span><span class="w"> </span><span class="n">ì ‘ê·¼í•˜ë ¤ê³ </span><span class="w"> </span><span class="nl">í•©ë‹ˆë‹¤</span><span class="p">:</span><span class="w">  </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                  </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="o">[</span><span class="n">x</span><span class="o">]</span><span class="w"> </span><span class="n">í”„ë¡œí•„</span><span class="w"> </span><span class="n">ì½ê¸°</span><span class="w"> </span><span class="p">(</span><span class="k">scope</span><span class="err">:</span><span class="w"> </span><span class="nl">profile</span><span class="p">:</span><span class="k">read</span><span class="p">)</span><span class="w">          </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="o">[</span><span class="n">x</span><span class="o">]</span><span class="w"> </span><span class="n">ì´ë©”ì¼</span><span class="w"> </span><span class="n">ì½ê¸°</span><span class="w"> </span><span class="p">(</span><span class="k">scope</span><span class="err">:</span><span class="w"> </span><span class="nl">email</span><span class="p">:</span><span class="k">read</span><span class="p">)</span><span class="w">            </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="o">[</span><span class="n"> </span><span class="o">]</span><span class="w"> </span><span class="n">ëŒ€ì‹ </span><span class="w"> </span><span class="n">ì´ë©”ì¼</span><span class="w"> </span><span class="n">ë³´ë‚´ê¸°</span><span class="w"> </span><span class="p">(</span><span class="nl">email</span><span class="p">:</span><span class="n">send</span><span class="p">)</span><span class="w">            </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="o">[</span><span class="n"> </span><span class="o">]</span><span class="w"> </span><span class="n">ë°ì´í„°</span><span class="w"> </span><span class="n">ì‚­ì œ</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="err">:</span><span class="k">delete</span><span class="p">)</span><span class="w">                  </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">                                                  </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">         </span><span class="o">[</span><span class="n">í—ˆìš©</span><span class="o">]</span><span class="w">    </span><span class="o">[</span><span class="n">ê±°ë¶€</span><span class="o">]</span><span class="w">                         </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">ê²°ê³¼</span><span class="w"> </span><span class="nl">í† í°</span><span class="p">:</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">{</span><span class="w">                                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="ss">&quot;scope&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;profile:read email:read&quot;</span><span class="p">,</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="ss">&quot;client_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;myapp&quot;</span><span class="p">,</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="ss">&quot;sub&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;user_123&quot;</span><span class="w">                                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">}</span><span class="w">                                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">ì¼ë°˜ì ì¸</span><span class="w"> </span><span class="n">ìŠ¤ì½”í”„</span><span class="w"> </span><span class="nl">íŒ¨í„´</span><span class="p">:</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">íŒ¨í„´</span><span class="w">             </span><span class="err">â”‚</span><span class="w"> </span><span class="n">ì˜ˆì‹œ</span><span class="w">                          </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nl">resource</span><span class="p">:</span><span class="k">action</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nl">posts</span><span class="p">:</span><span class="k">read</span><span class="p">,</span><span class="w"> </span><span class="nl">posts</span><span class="p">:</span><span class="k">write</span><span class="w">       </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">resource</span><span class="p">.</span><span class="k">action</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="k">user</span><span class="p">.</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="k">user</span><span class="p">.</span><span class="n">profile</span><span class="w">      </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">hierarchical</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="p">(</span><span class="n">ëª¨ë“ </span><span class="w"> </span><span class="n">ê²ƒì„</span><span class="w"> </span><span class="n">ì˜ë¯¸</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">OIDC</span><span class="w"> </span><span class="n">standard</span><span class="w">     </span><span class="err">â”‚</span><span class="w"> </span><span class="n">openid</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="w">         </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">GitHub</span><span class="w"> </span><span class="n">style</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="n">repo</span><span class="p">,</span><span class="w"> </span><span class="k">user</span><span class="p">,</span><span class="w"> </span><span class="n">gist</span><span class="w">              </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Google</span><span class="w"> </span><span class="n">style</span><span class="w">      </span><span class="err">â”‚</span><span class="w"> </span><span class="n">drive</span><span class="p">.</span><span class="n">readonly</span><span class="p">,</span><span class="w"> </span><span class="n">calendar</span><span class="w">       </span><span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="72">7.2 ìŠ¤ì½”í”„ ê°•ì œ<a class="header-link" href="#72" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">scope_enforcement.py - OAuth scope checking for APIs</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_scope</span><span class="p">(</span><span class="o">*</span><span class="n">required_scopes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator to enforce OAuth 2.0 scopes.</span>
<span class="sd">    Token must contain ALL required scopes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Token scopes are typically space-separated</span>
            <span class="n">token_scopes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">claims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scope&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="n">required</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_scopes</span><span class="p">)</span>

            <span class="n">missing</span> <span class="o">=</span> <span class="n">required</span> <span class="o">-</span> <span class="n">token_scopes</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;insufficient_scope&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error_description&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Missing scopes: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;required_scopes&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">required</span><span class="p">),</span>
                    <span class="s2">&quot;granted_scopes&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">token_scopes</span><span class="p">),</span>
                <span class="p">}),</span> <span class="mi">403</span>

            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/profile&#39;</span><span class="p">)</span>
<span class="nd">@require_scope</span><span class="p">(</span><span class="s1">&#39;profile:read&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_profile</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/profile&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="nd">@require_scope</span><span class="p">(</span><span class="s1">&#39;profile:read&#39;</span><span class="p">,</span> <span class="s1">&#39;profile:write&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_profile</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Profile updated&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/data/export&#39;</span><span class="p">)</span>
<span class="nd">@require_scope</span><span class="p">(</span><span class="s1">&#39;data:export&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">export_data</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;download_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://...&quot;</span><span class="p">})</span>
</code></pre></div>

<hr />
<h2 id="8">8. ë¦¬ì†ŒìŠ¤ ìˆ˜ì¤€ ê¶Œí•œ<a class="header-link" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 ì—­í•  ê¸°ë°˜ì„ ë„˜ì–´ì„œ: ë¦¬ì†ŒìŠ¤ ì†Œìœ ê¶Œ<a class="header-link" href="#81" title="Permanent link">&para;</a></h3>
<p>ë§ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ "ì‚¬ìš©ìê°€ ì ì ˆí•œ ì—­í• ì„ ê°€ì§€ê³  ìˆëŠ”ê°€"ë¿ë§Œ ì•„ë‹ˆë¼ "ì‚¬ìš©ìê°€ ì´ íŠ¹ì • ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ”ê°€"ë¥¼ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ë¦¬ì†ŒìŠ¤ ìˆ˜ì¤€ ê¶Œí•œ í™•ì¸                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ë ˆë²¨ 1: ì—­í•  í™•ì¸                                               â”‚
â”‚  &quot;ì‚¬ìš©ìê°€ í¸ì§‘ìì¸ê°€?&quot; â†’ ì˜ˆ/ì•„ë‹ˆì˜¤                             â”‚
â”‚                                                                  â”‚
â”‚  ë ˆë²¨ 2: ë¦¬ì†ŒìŠ¤ ì†Œìœ ê¶Œ                                           â”‚
â”‚  &quot;ì‚¬ìš©ìê°€ ì´ ê²Œì‹œë¬¼ì˜ ì†Œìœ ìì¸ê°€?&quot; â†’ ì˜ˆ/ì•„ë‹ˆì˜¤                 â”‚
â”‚                                                                  â”‚
â”‚  ë ˆë²¨ 3: ê³µìœ  ì ‘ê·¼                                               â”‚
â”‚  &quot;ê²Œì‹œë¬¼ì´ ì´ ì‚¬ìš©ìì™€ ê³µìœ ë˜ì—ˆëŠ”ê°€?&quot; â†’ ì˜ˆ/ì•„ë‹ˆì˜¤               â”‚
â”‚                                                                  â”‚
â”‚  ë ˆë²¨ 4: ì¡°ì§ ë²”ìœ„                                               â”‚
â”‚  &quot;ì‚¬ìš©ìê°€ ê°™ì€ ì¡°ì§ì— ì†í•˜ëŠ”ê°€?&quot; â†’ ì˜ˆ/ì•„ë‹ˆì˜¤                   â”‚
â”‚                                                                  â”‚
â”‚  ê²°í•©:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ ì—­í•  í™•ì¸  â”‚â”€â”€â”€â–¶â”‚ ë¦¬ì†ŒìŠ¤     â”‚â”€â”€â”€â–¶â”‚ ì¶”ê°€         â”‚          â”‚
â”‚  â”‚ (í¸ì§‘ì?)  â”‚    â”‚ ì†Œìœ ê¶Œ     â”‚    â”‚ ì œì•½ ì¡°ê±´    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ (ì†Œìœ ì?)  â”‚    â”‚ (ê°™ì€ ì¡°ì§?) â”‚          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="82">8.2 êµ¬í˜„: ë‹¤ì¸µ ì¸ê°€<a class="header-link" href="#82" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">resource_auth.py - Multi-layer authorization for resources</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Resource Authorization Framework</span>
<span class="c1"># ==============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ResourceAuthorizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multi-layer authorization for resources.</span>
<span class="sd">    Checks are performed in order: role â†’ ownership â†’ sharing â†’ custom.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_checks</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">check_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a custom authorization check for a resource type.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">resource_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_checks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">custom_checks</span><span class="p">[</span><span class="n">resource_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_checks</span><span class="p">[</span><span class="n">resource_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">check_fn</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">authorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                  <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if user can perform action on resource.</span>
<span class="sd">        Returns True if authorized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resource_type</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>

        <span class="c1"># Layer 1: Super admin bypass</span>
        <span class="k">if</span> <span class="s1">&#39;super_admin&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Layer 2: Resource ownership</span>
        <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Layer 3: Role-based for the resource type</span>
        <span class="n">role_permissions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_role_permissions</span><span class="p">(</span>
            <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">resource_type</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">role_permissions</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Layer 4: Shared access</span>
        <span class="n">shares</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shares&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">share</span> <span class="ow">in</span> <span class="n">shares</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">share</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">share</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;permissions&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">share</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group_id&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">share</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;permissions&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Layer 5: Custom checks</span>
        <span class="k">for</span> <span class="n">check_fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_checks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">check_fn</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_role_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">roles</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                               <span class="n">resource_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get permissions for roles on a resource type.&quot;&quot;&quot;</span>
        <span class="c1"># In production, this comes from a database</span>
        <span class="n">role_perms</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;admin&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;post&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;publish&#39;</span><span class="p">},</span>
                <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">},</span>
                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">},</span>
            <span class="p">},</span>
            <span class="s1">&#39;editor&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;post&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">},</span>
                <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">},</span>
            <span class="p">},</span>
            <span class="s1">&#39;viewer&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;post&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">},</span>
                <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="n">perms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">roles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">role_perms</span> <span class="ow">and</span> <span class="n">resource_type</span> <span class="ow">in</span> <span class="n">role_perms</span><span class="p">[</span><span class="n">role</span><span class="p">]:</span>
                <span class="n">perms</span> <span class="o">|=</span> <span class="n">role_perms</span><span class="p">[</span><span class="n">role</span><span class="p">][</span><span class="n">resource_type</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">perms</span>


<span class="c1"># Global authorizer instance</span>
<span class="n">authorizer</span> <span class="o">=</span> <span class="n">ResourceAuthorizer</span><span class="p">()</span>


<span class="c1"># ==============================================================</span>
<span class="c1"># Authorization Decorator</span>
<span class="c1"># ==============================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">authorize_resource</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource_loader</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator for resource-level authorization.</span>
<span class="sd">    resource_loader: function that returns the resource dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_user&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not authenticated&quot;</span><span class="p">}),</span> <span class="mi">401</span>

            <span class="n">resource</span> <span class="o">=</span> <span class="n">resource_loader</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Resource not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">authorizer</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Forbidden&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;You don&#39;t have &#39;</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&#39; access to this resource&quot;</span>
                <span class="p">}),</span> <span class="mi">403</span>

            <span class="n">g</span><span class="o">.</span><span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="c1"># Resource loaders</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a post from the database.&quot;&quot;&quot;</span>
    <span class="c1"># Simulated DB lookup</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;owner_id&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;org_id&quot;</span><span class="p">:</span> <span class="s2">&quot;org1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shares&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">]}]},</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;owner_id&quot;</span><span class="p">:</span> <span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="s2">&quot;org_id&quot;</span><span class="p">:</span> <span class="s2">&quot;org1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shares&quot;</span><span class="p">:</span> <span class="p">[]},</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">posts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>


<span class="c1"># Routes</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts/&lt;int:post_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authorize_resource</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">load_post</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">resource</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts/&lt;int:post_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="nd">@authorize_resource</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="n">load_post</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Updated&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts/&lt;int:post_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@authorize_resource</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">load_post</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Deleted&quot;</span><span class="p">})</span>
</code></pre></div>

<hr />
<h2 id="9">9. ì¼ë°˜ì ì¸ ì¸ê°€ ì·¨ì•½ì <a class="header-link" href="#9" title="Permanent link">&para;</a></h2>
<h3 id="91-idor">9.1 IDOR (ì•ˆì „í•˜ì§€ ì•Šì€ ì§ì ‘ ê°ì²´ ì°¸ì¡°)<a class="header-link" href="#91-idor" title="Permanent link">&para;</a></h3>
<p>IDORì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë‚´ë¶€ ê°ì²´ ì°¸ì¡°(ì˜ˆ: ë°ì´í„°ë² ì´ìŠ¤ ID)ë¥¼ ë…¸ì¶œí•˜ë©´ì„œ ìš”ì²­ ì‚¬ìš©ìê°€ ì ‘ê·¼í•  ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì§€ ì•Šì„ ë•Œ ë°œìƒí•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IDOR ì·¨ì•½ì                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ì·¨ì•½í•œ ê²½ìš°:                                                    â”‚
â”‚  GET /api/invoices/12345                                         â”‚
â”‚  â†’ invoice 12345 ë°˜í™˜ (ì†Œìœ ê¶Œ í™•ì¸ ì—†ìŒ!)                        â”‚
â”‚                                                                  â”‚
â”‚  ê³µê²©ìê°€ ID ë³€ê²½:                                               â”‚
â”‚  GET /api/invoices/12346                                         â”‚
â”‚  â†’ ë‹¤ë¥¸ ì‚¬ëŒì˜ invoice ë°˜í™˜! ğŸš¨                                  â”‚
â”‚                                                                  â”‚
â”‚  GET /api/users/100/profile â†’ ê³µê²©ìì˜ í”„ë¡œí•„                    â”‚
â”‚  GET /api/users/101/profile â†’ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ í”„ë¡œí•„!              â”‚
â”‚  GET /api/users/102/profile â†’ ë˜ ë‹¤ë¥¸ ì‚¬ìš©ì!                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">idor_example.py - IDOR vulnerability and fix</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># ============================================================</span>
<span class="c1"># VULNERABLE: No authorization check on resource access</span>
<span class="c1"># ============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/invoices/&lt;int:invoice_id&gt;&#39;</span><span class="p">)</span>
<span class="nd">@require_auth</span>  <span class="c1"># Only checks authentication, NOT authorization!</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_invoice_vulnerable</span><span class="p">(</span><span class="n">invoice_id</span><span class="p">):</span>
    <span class="c1"># Any authenticated user can access ANY invoice by ID</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_invoice</span><span class="p">(</span><span class="n">invoice_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">invoice</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">invoice</span><span class="p">)</span>  <span class="c1"># IDOR: No ownership check!</span>


<span class="c1"># ============================================================</span>
<span class="c1"># FIXED: Verify resource ownership</span>
<span class="c1"># ============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/invoices/&lt;int:invoice_id&gt;&#39;</span><span class="p">)</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_invoice_secure</span><span class="p">(</span><span class="n">invoice_id</span><span class="p">):</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_invoice</span><span class="p">(</span><span class="n">invoice_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">invoice</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="c1"># Check: Does this invoice belong to the current user?</span>
    <span class="k">if</span> <span class="n">invoice</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span>
        <span class="c1"># Return 404 (not 403) to avoid information disclosure</span>
        <span class="c1"># A 403 tells attacker &quot;the resource exists but you can&#39;t access it&quot;</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">invoice</span><span class="p">)</span>


<span class="c1"># ============================================================</span>
<span class="c1"># BETTER: Use indirect references</span>
<span class="c1"># ============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/my/invoices&#39;</span><span class="p">)</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_my_invoices</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Only return the current user&#39;s invoices.&quot;&quot;&quot;</span>
    <span class="n">invoices</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_invoices_for_user</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;invoices&quot;</span><span class="p">:</span> <span class="n">invoices</span><span class="p">})</span>
</code></pre></div>

<h3 id="92">9.2 ê¶Œí•œ ìƒìŠ¹<a class="header-link" href="#92" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ê¶Œí•œ ìƒìŠ¹ ìœ í˜•                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ìˆ˜ì§ ìƒìŠ¹ (ë” ë†’ì€ ê¶Œí•œ íšë“):                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚  ì¼ë°˜    â”‚ â”€â”€â”€â”€â”€â”€â–¶ â”‚  ê´€ë¦¬ì  â”‚                              â”‚
â”‚  â”‚ ì‚¬ìš©ì   â”‚  ê³µê²©   â”‚  ì‚¬ìš©ì  â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                  â”‚
â”‚  ì˜ˆì‹œ: JWT ì—­í•  í´ë ˆì„ ìˆ˜ì •                                     â”‚
â”‚  ì›ë³¸:     {&quot;sub&quot;: &quot;user1&quot;, &quot;role&quot;: &quot;user&quot;}                     â”‚
â”‚  ë³€ì¡°ë¨:   {&quot;sub&quot;: &quot;user1&quot;, &quot;role&quot;: &quot;admin&quot;}                    â”‚
â”‚                                                                  â”‚
â”‚  ìˆ˜í‰ ìƒìŠ¹ (ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë°ì´í„° ì ‘ê·¼):                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚ ì‚¬ìš©ì A â”‚ â”€â”€â”€â”€â”€â”€â–¶ â”‚ ì‚¬ìš©ì B â”‚                              â”‚
â”‚  â”‚  (ë³¸ì¸)  â”‚  ì ‘ê·¼   â”‚  (íƒ€ì¸)  â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                  â”‚
â”‚  ì˜ˆì‹œ: user_id íŒŒë¼ë¯¸í„° ë³€ê²½                                    â”‚
â”‚  ë³¸ì¸ ë°ì´í„°:    GET /api/users/100/settings                    â”‚
â”‚  íƒ€ì¸ ë°ì´í„°:    GET /api/users/101/settings                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">privilege_escalation.py - Privilege escalation vulnerabilities and fixes</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># ============================================================</span>
<span class="c1"># VULNERABLE: Role in client-controlled input</span>
<span class="c1"># ============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/register&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">register_vulnerable</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="n">user</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span>
        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">),</span>  <span class="c1"># Attacker sends role=admin!</span>
    <span class="p">}</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="mi">201</span>

<span class="c1"># Attack:</span>
<span class="c1"># POST /api/register</span>
<span class="c1"># {&quot;username&quot;: &quot;attacker&quot;, &quot;email&quot;: &quot;a@b.com&quot;, &quot;role&quot;: &quot;admin&quot;}</span>


<span class="c1"># ============================================================</span>
<span class="c1"># FIXED: Never trust client-supplied role</span>
<span class="c1"># ============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/register&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">register_secure</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="n">user</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span>
        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>  <span class="c1"># Always set server-side!</span>
    <span class="p">}</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="mi">201</span>


<span class="c1"># ============================================================</span>
<span class="c1"># VULNERABLE: Mass assignment (updating fields not intended)</span>
<span class="c1"># ============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/users/&lt;int:user_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PATCH&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_user_vulnerable</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="c1"># Blindly update all provided fields</span>
    <span class="n">db</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Attacker sends {&quot;role&quot;: &quot;admin&quot;}!</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Updated&quot;</span><span class="p">})</span>


<span class="c1"># ============================================================</span>
<span class="c1"># FIXED: Whitelist allowed fields</span>
<span class="c1"># ============================================================</span>

<span class="n">ALLOWED_UPDATE_FIELDS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;bio&#39;</span><span class="p">,</span> <span class="s1">&#39;avatar_url&#39;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/users/&lt;int:user_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PATCH&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_user_secure</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="c1"># Ensure user can only update their own profile</span>
    <span class="k">if</span> <span class="n">user_id</span> <span class="o">!=</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Forbidden&quot;</span><span class="p">}),</span> <span class="mi">403</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>

    <span class="c1"># Only allow whitelisted fields</span>
    <span class="n">safe_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ALLOWED_UPDATE_FIELDS</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">safe_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No valid fields to update&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">db</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="o">**</span><span class="n">safe_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Updated&quot;</span><span class="p">})</span>


<span class="c1"># ============================================================</span>
<span class="c1"># VULNERABLE: Broken function-level access control</span>
<span class="c1"># ============================================================</span>

<span class="c1"># Admin endpoint with no authorization check</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/delete-user/&lt;int:user_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>  <span class="c1"># Only checks if user is logged in, not if they&#39;re admin!</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_user_vulnerable</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;User deleted&quot;</span><span class="p">})</span>


<span class="c1"># ============================================================</span>
<span class="c1"># FIXED: Proper role check on admin endpoints</span>
<span class="c1"># ============================================================</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/delete-user/&lt;int:user_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@require_role</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>  <span class="c1"># Checks both auth AND admin role</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_user_secure</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="c1"># Additional safety: prevent deleting self or other admins</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="k">if</span> <span class="n">target</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Cannot delete yourself&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">if</span> <span class="s1">&#39;admin&#39;</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Cannot delete other admins via API&quot;</span><span class="p">}),</span> <span class="mi">403</span>

    <span class="n">db</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;User deleted&quot;</span><span class="p">})</span>
</code></pre></div>

<h3 id="93">9.3 ì¸ê°€ ì·¨ì•½ì  ì²´í¬ë¦¬ìŠ¤íŠ¸<a class="header-link" href="#93" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ì¸ê°€ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  [ ] ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ì— ëª…ì‹œì ì¸ ì¸ê°€ í™•ì¸ì´ ìˆìŒ                â”‚
â”‚  [ ] ì¸ê°€ëŠ” ì„œë²„ ì¸¡ì—ì„œ ê°•ì œë¨ (í´ë¼ì´ì–¸íŠ¸ ì „ìš© ê¸ˆì§€)           â”‚
â”‚  [ ] ì§ì ‘ ê°ì²´ ì°¸ì¡°ëŠ” ì†Œìœ ê¶Œì— ëŒ€í•´ ê²€ì¦ë¨                      â”‚
â”‚  [ ] ê´€ë¦¬ì ê¸°ëŠ¥ì€ ê´€ë¦¬ì ì—­í•  í™•ì¸ì´ í•„ìš”í•¨                    â”‚
â”‚  [ ] ì—­í• /ê¶Œí•œ ë³€ê²½ì€ ê´€ë¦¬ì ì¸ê°€ê°€ í•„ìš”í•¨                      â”‚
â”‚  [ ] ì‚¬ìš©ì ì…ë ¥ì€ ì—­í•  ë˜ëŠ” ê¶Œí•œ í• ë‹¹ì„ ì œì–´í•˜ì§€ ì•ŠìŒ          â”‚
â”‚  [ ] API ì‘ë‹µì€ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë°ì´í„°ë¥¼ ë…¸ì¶œí•˜ì§€ ì•ŠìŒ            â”‚
â”‚  [ ] ì‹¤íŒ¨í•œ ì¸ê°€ëŠ” 403 (ë˜ëŠ” IDORì˜ ê²½ìš° 404)ì„ ë°˜í™˜í•¨          â”‚
â”‚  [ ] ì¸ê°€ ë¡œì§ì€ ì¤‘ì•™ ì§‘ì¤‘í™”ë¨ (ì¤‘ë³µë˜ì§€ ì•ŠìŒ)                  â”‚
â”‚  [ ] ëŒ€ëŸ‰ í• ë‹¹ì´ ë°©ì§€ë¨ (í•„ë“œ í™”ì´íŠ¸ë¦¬ìŠ¤íŒ…)                     â”‚
â”‚  [ ] ìˆ˜í‰ ì ‘ê·¼ì´ í™•ì¸ë¨ (ì‚¬ìš©ì AëŠ” Bì˜ ë°ì´í„°ì— ì ‘ê·¼ ë¶ˆê°€)     â”‚
â”‚  [ ] ì¸ê°€ ê²°ì •ì´ ê°ì‚¬ë¥¼ ìœ„í•´ ë¡œê¹…ë¨                             â”‚
â”‚  [ ] ê¸°ë³¸ ê±°ë¶€ ì •ì±… (ëª…ì‹œì ìœ¼ë¡œ í—ˆìš©ë˜ì§€ ì•ŠëŠ” í•œ ê±°ë¶€)          â”‚
â”‚  [ ] í† í° ê¸°ë°˜ ì¸ì¦ì€ ìŠ¤ì½”í”„/í´ë ˆì„ì„ í™•ì¸í•¨                    â”‚
â”‚  [ ] ë‹¤ì¤‘ í…Œë„ŒíŠ¸ ê²©ë¦¬ê°€ ë°ì´í„° ê³„ì¸µì—ì„œ ê°•ì œë¨                  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="10">10. ì—°ìŠµ ë¬¸ì œ<a class="header-link" href="#10" title="Permanent link">&para;</a></h2>
<h3 id="1-rbac">ì—°ìŠµ ë¬¸ì œ 1: RBAC ì‹œìŠ¤í…œ êµ¬í˜„<a class="header-link" href="#1-rbac" title="Permanent link">&para;</a></h3>
<p>ì—­í•  ê³„ì¸µì„ ê°€ì§„ ì™„ì „í•œ RBAC ì‹œìŠ¤í…œ êµ¬ì¶•:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: Implement a complete RBAC system for a blogging platform.</span>

<span class="sd">Requirements:</span>
<span class="sd">- Roles: super_admin, admin, moderator, author, reader</span>
<span class="sd">- Role hierarchy: super_admin &gt; admin &gt; moderator &gt; author &gt; reader</span>
<span class="sd">- Permissions: user:*, post:*, comment:*, settings:*</span>
<span class="sd">- Users can have multiple roles</span>
<span class="sd">- Implement role assignment with authorization (only admin+ can assign)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BlogRBAC</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">permissions</span><span class="p">:</span> <span class="nb">set</span><span class="p">,</span>
                    <span class="n">parent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new role with optional parent.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">assign_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">admin_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">target_user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign role (only admins can do this).&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                         <span class="n">permission</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if user has permission (including inherited).&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_accessible_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                  <span class="n">resource_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all resources a user can access.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="2-abac">ì—°ìŠµ ë¬¸ì œ 2: ABAC ì •ì±… ì—”ì§„ êµ¬ì¶•<a class="header-link" href="#2-abac" title="Permanent link">&para;</a></h3>
<p>ì˜ë£Œ ABAC ì‹œìŠ¤í…œ ìƒì„±:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: Build an ABAC engine for a hospital system.</span>

<span class="sd">Policies to implement:</span>
<span class="sd">1. Doctors can read patient records in their department</span>
<span class="sd">2. Nurses can read records during their shift only</span>
<span class="sd">3. Emergency doctors can override department restrictions</span>
<span class="sd">4. No one can access records from non-hospital IP addresses</span>
<span class="sd">5. Psychiatry records require additional clearance level</span>
<span class="sd">6. Research access requires IRB approval attribute</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">HospitalABAC</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">condition</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>
                   <span class="n">effect</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                 <span class="n">action</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="3">ì—°ìŠµ ë¬¸ì œ 3: ì¸ê°€ ì·¨ì•½ì  ìˆ˜ì •<a class="header-link" href="#3" title="Permanent link">&para;</a></h3>
<p>ì´ ì½”ë“œì˜ ëª¨ë“  ì¸ê°€ ë¬¸ì œë¥¼ ì°¾ì•„ ìˆ˜ì •:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: This API has at least 7 authorization vulnerabilities.</span>
<span class="sd">Find and fix ALL of them.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_all_users</span><span class="p">():</span>
    <span class="c1"># Issue 1: ???</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_all_users</span><span class="p">())</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/users/&lt;int:id&gt;/password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">change_password</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="c1"># Issue 2: ???</span>
    <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
    <span class="n">db</span><span class="o">.</span><span class="n">update_password</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">new_password</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;updated&quot;</span><span class="p">})</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/posts/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_post</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_post</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="c1"># Issue 3: ???</span>
    <span class="n">db</span><span class="o">.</span><span class="n">delete_post</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;deleted&quot;</span><span class="p">})</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/promote&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">promote_user</span><span class="p">():</span>
    <span class="c1"># Issue 4: ???</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span>  <span class="c1"># Issue 5: ???</span>
    <span class="n">db</span><span class="o">.</span><span class="n">set_role</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">role</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;promoted&quot;</span><span class="p">})</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/files/&lt;path:filepath&gt;&#39;</span><span class="p">)</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">download_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="c1"># Issue 6: ???</span>
    <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/uploads/</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/settings&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_settings</span><span class="p">():</span>
    <span class="c1"># Issue 7: ???</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="n">db</span><span class="o">.</span><span class="n">update_all_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;updated&quot;</span><span class="p">})</span>
</code></pre></div>

<h3 id="4">ì—°ìŠµ ë¬¸ì œ 4: ë‹¤ì¤‘ í…Œë„ŒíŠ¸ ì¸ê°€<a class="header-link" href="#4" title="Permanent link">&para;</a></h3>
<p>ë‹¤ì¤‘ í…Œë„ŒíŠ¸ ì¸ê°€ ì‹œìŠ¤í…œ ì„¤ê³„ ë° êµ¬í˜„:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exercise: Build authorization for a multi-tenant SaaS application.</span>

<span class="sd">Requirements:</span>
<span class="sd">- Each tenant (organization) has isolated data</span>
<span class="sd">- Users belong to exactly one organization</span>
<span class="sd">- Roles are per-organization (admin in org A != admin in org B)</span>
<span class="sd">- Cross-tenant access is never allowed</span>
<span class="sd">- Super-admins (platform level) can access any tenant</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MultiTenantAuth</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_org</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">org_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">owner_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_tenant_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">org_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">resource_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ensure_tenant_isolation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                 <span class="n">user_org_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add tenant filter to database queries.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="5-opa">ì—°ìŠµ ë¬¸ì œ 5: OPA ì •ì±… ì‘ì„±<a class="header-link" href="#5-opa" title="Permanent link">&para;</a></h3>
<p>ë‹¤ìŒ ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€í•œ Rego ì •ì±… ì‘ì„±:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Exercise: Write Rego policies for:</span>
<span class="c1">#</span>
<span class="c1"># 1. Users can only access resources in their department</span>
<span class="c1"># 2. Managers can access resources in their department and</span>
<span class="c1">#    departments they manage</span>
<span class="c1"># 3. Financial reports require &quot;finance&quot; role AND &quot;senior&quot; level</span>
<span class="c1"># 4. API rate limiting: users with &quot;basic&quot; tier limited to 100 req/hour</span>
<span class="c1"># 5. Data classification: &quot;top_secret&quot; resources require MFA</span>
<span class="c1">#    authentication within the last 30 minutes</span>

<span class="k">package</span><span class="w"> </span><span class="n">exercise</span>

<span class="k">import</span><span class="w"> </span><span class="n">rego</span><span class="p">.</span><span class="n">v1</span>

<span class="c1"># Write your policies here:</span>

<span class="k">default</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">false</span>

<span class="c1"># Policy 1: Department access</span>
<span class="c1"># ...</span>

<span class="c1"># Policy 2: Manager cross-department access</span>
<span class="c1"># ...</span>

<span class="c1"># Policy 3: Financial reports</span>
<span class="c1"># ...</span>

<span class="c1"># Policy 4: Rate limiting</span>
<span class="c1"># ...</span>

<span class="c1"># Policy 5: MFA requirement for classified data</span>
<span class="c1"># ...</span>
</code></pre></div>

<hr />
<h2 id="11">11. ìš”ì•½<a class="header-link" href="#11" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ì¸ê°€ ë° ì ‘ê·¼ ì œì–´ ìš”ì•½                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ëª¨ë¸:                                                           â”‚
â”‚  - RBAC: ì—­í•  â†’ ê¶Œí•œ. ê°„ë‹¨í•˜ê³  ë„ë¦¬ ì‚¬ìš©ë¨.                     â”‚
â”‚  - ABAC: ì†ì„± â†’ ì •ì±… â†’ ê²°ì •. ìœ ì—°í•˜ê³  ì»¨í…ìŠ¤íŠ¸ ì¸ì‹.           â”‚
â”‚  - ACL: ë¦¬ì†ŒìŠ¤ë³„ ê¶Œí•œ ëª©ë¡. ì„¸ë°€í•œ ì œì–´.                        â”‚
â”‚  - ëª¨ë¸ ê²°í•© (RBAC + ë¦¬ì†ŒìŠ¤ ì†Œìœ ê¶Œì´ ì¼ë°˜ì )                    â”‚
â”‚                                                                  â”‚
â”‚  ì£¼ìš” ì›ì¹™:                                                      â”‚
â”‚  - ìµœì†Œ ê¶Œí•œ: í•„ìš”í•œ ìµœì†Œ ê¶Œí•œë§Œ ë¶€ì—¬                           â”‚
â”‚  - ê¸°ë³¸ ê±°ë¶€: ëª…ì‹œì ìœ¼ë¡œ í—ˆìš©ë˜ì§€ ì•Šì€ ëª¨ë“  ê²ƒì„ ì°¨ë‹¨           â”‚
â”‚  - ì§ë¬´ ë¶„ë¦¬: ë‹¨ì¼ ì—­í• ì´ ëª¨ë“  ê²ƒì„ í•  ìˆ˜ ì—†ìŒ                  â”‚
â”‚  - ì‹¬ì¸µ ë°©ì–´: ì—¬ëŸ¬ ê³„ì¸µì—ì„œ í™•ì¸                                â”‚
â”‚  - ì¤‘ì•™ ì§‘ì¤‘í™”: ì¸ê°€ ë¡œì§ì„ í•œ ê³³ì—                             â”‚
â”‚                                                                  â”‚
â”‚  êµ¬í˜„:                                                           â”‚
â”‚  - ì„œë²„ ì¸¡ ê°•ì œ (í´ë¼ì´ì–¸íŠ¸ë¥¼ ì ˆëŒ€ ì‹ ë¢°í•˜ì§€ ì•ŠìŒ)               â”‚
â”‚  - ìƒíƒœ ë¹„ì €ì¥ API ì¸ê°€ë¥¼ ìœ„í•œ JWT í´ë ˆì„                       â”‚
â”‚  - ì œ3ì ì ‘ê·¼ ìœ„ì„ì„ ìœ„í•œ OAuth ìŠ¤ì½”í”„                          â”‚
â”‚  - ë³µì¡í•˜ê±°ë‚˜ ì™¸ë¶€í™”ëœ ì •ì±…ì„ ìœ„í•œ ì •ì±… ì—”ì§„ (OPA)              â”‚
â”‚  - Flaskì—ì„œ DRY ì¸ê°€ë¥¼ ìœ„í•œ ë°ì½”ë ˆì´í„°/ë¯¸ë“¤ì›¨ì–´                â”‚
â”‚                                                                  â”‚
â”‚  ì¼ë°˜ì ì¸ ì·¨ì•½ì :                                                â”‚
â”‚  - IDOR: í•­ìƒ ë¦¬ì†ŒìŠ¤ ì†Œìœ ê¶Œì„ ê²€ì¦                              â”‚
â”‚  - ê¶Œí•œ ìƒìŠ¹: í´ë¼ì´ì–¸íŠ¸ê°€ ì œê³µí•œ ì—­í• ì„ ì ˆëŒ€ ì‹ ë¢°í•˜ì§€ ì•ŠìŒ     â”‚
â”‚  - ëŒ€ëŸ‰ í• ë‹¹: ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•œ í•„ë“œë¥¼ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë¡œ ê´€ë¦¬        â”‚
â”‚  - ê¸°ëŠ¥ ìˆ˜ì¤€ í™•ì¸ ëˆ„ë½: ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ì— ì¸ì¦ì´ í•„ìš”           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<p><strong>ì´ì „</strong>: <a href="05_Authentication.md">05. ì¸ì¦ ì‹œìŠ¤í…œ</a> | <strong>ë‹¤ìŒ</strong>: <a href="07_OWASP_Top10.md">07. OWASP Top 10 (2021)</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Security/05_Authentication.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">05. ì¸ì¦ ì‹œìŠ¤í…œ</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Security/07_OWASP_Top10.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">07. OWASP Top 10 (2021)</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'ko';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}