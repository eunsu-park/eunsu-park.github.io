{% raw %}
<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>07. OWASP Top 10 (2021) - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/ko/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/ko/" class="nav-item ">
                    <span class="nav-icon">🏠</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">💻</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/ko/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" >
                        English
                    </option>
                    
                    <option value="ko" selected>
                        한국어
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">☀️</span>
                    <span class="theme-icon dark">🌙</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/ko/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/ko/Security/">Security</a>
    <span class="separator">/</span>
    <span class="current">07. OWASP Top 10 (2021)</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>07. OWASP Top 10 (2021)</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Security/06_Authorization.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">06. 인가 및 접근 제어</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">🔗</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">📋</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Security/08_Injection_Attacks.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">08. 인젝션 공격과 방어</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#_1">학습 목표</a></li>
<li><a href="#1-2021-top-10">1. 개요: 2021 Top 10</a></li>
<li><a href="#2-a01">2. A01: 취약한 접근 제어</a><ul>
<li><a href="#21">2.1 설명</a></li>
<li><a href="#22">2.2 취약한 코드</a></li>
<li><a href="#23">2.3 수정된 코드</a></li>
<li><a href="#24">2.4 방어</a></li>
</ul>
</li>
<li><a href="#3-a02">3. A02: 암호화 실패</a><ul>
<li><a href="#31">3.1 설명</a></li>
<li><a href="#32">3.2 취약한 코드</a></li>
<li><a href="#33">3.3 수정된 코드</a></li>
<li><a href="#34">3.4 방어</a></li>
</ul>
</li>
<li><a href="#4-a03">4. A03: 인젝션</a><ul>
<li><a href="#41">4.1 설명</a></li>
<li><a href="#42-vs">4.2 취약 코드 vs 수정된 코드</a></li>
<li><a href="#43">4.3 방어</a></li>
</ul>
</li>
<li><a href="#5-a04">5. A04: 안전하지 않은 설계</a><ul>
<li><a href="#51">5.1 설명</a></li>
<li><a href="#52">5.2 실제 사례: 영화관 예약</a></li>
<li><a href="#53">5.3 방어</a></li>
</ul>
</li>
<li><a href="#6-a05">6. A05: 보안 구성 오류</a><ul>
<li><a href="#61">6.1 설명</a></li>
<li><a href="#62">6.2 취약한 구성</a></li>
<li><a href="#63">6.3 수정된 구성</a></li>
<li><a href="#64">6.4 방어</a></li>
</ul>
</li>
<li><a href="#7-a06">7. A06: 취약하고 오래된 구성 요소</a><ul>
<li><a href="#71">7.1 설명</a></li>
<li><a href="#72">7.2 종속성 감사</a></li>
<li><a href="#73">7.3 방어</a></li>
</ul>
</li>
<li><a href="#8-a07">8. A07: 식별 및 인증 실패</a><ul>
<li><a href="#81">8.1 설명</a></li>
<li><a href="#82-vs">8.2 취약 코드 vs 수정된 코드</a></li>
<li><a href="#83">8.3 방어</a></li>
</ul>
</li>
<li><a href="#9-a08">9. A08: 소프트웨어 및 데이터 무결성 실패</a><ul>
<li><a href="#91">9.1 설명</a></li>
<li><a href="#92">9.2 취약한 코드: 안전하지 않은 역직렬화</a></li>
<li><a href="#93">9.3 방어</a></li>
</ul>
</li>
<li><a href="#10-a09">10. A09: 보안 로깅 및 모니터링 실패</a><ul>
<li><a href="#101">10.1 설명</a></li>
<li><a href="#102">10.2 보안 로깅 구현</a></li>
<li><a href="#103">10.3 로그에 기록할 내용</a></li>
<li><a href="#104">10.4 방어</a></li>
</ul>
</li>
<li><a href="#11-a10-ssrf">11. A10: 서버 측 요청 위조 (SSRF)</a><ul>
<li><a href="#111">11.1 설명</a></li>
<li><a href="#112">11.2 취약한 코드</a></li>
<li><a href="#113">11.3 수정된 코드</a></li>
<li><a href="#114">11.4 방어</a></li>
</ul>
</li>
<li><a href="#12">12. 방어 체크리스트</a></li>
<li><a href="#13">13. 연습 문제</a><ul>
<li><a href="#1">연습 문제 1: 취약점 식별</a></li>
<li><a href="#2">연습 문제 2: 안전한 애플리케이션 설계</a></li>
<li><a href="#3">연습 문제 3: 보안 감사 보고서</a></li>
<li><a href="#4">연습 문제 4: 취약한 애플리케이션 수정</a></li>
<li><a href="#5-owasp-top-10">연습 문제 5: OWASP Top 10 매핑</a></li>
</ul>
</li>
<li><a href="#14">14. 요약</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="07-owasp-top-10-2021">07. OWASP Top 10 (2021)<a class="header-link" href="#07-owasp-top-10-2021" title="Permanent link">&para;</a></h1>
<p><strong>이전</strong>: <a href="06_Authorization.md">06. 인가와 접근 제어</a> | <strong>다음</strong>: <a href="08_Injection_Attacks.md">08. 인젝션 공격과 방어</a></p>
<hr />
<p>OWASP (Open Worldwide Application Security Project) Top 10은 웹 애플리케이션 보안 위험에 대해 가장 널리 인정받는 문서입니다. 실제 취약점 데이터를 기반으로 주기적으로 업데이트되며, 개발자와 보안 전문가를 위한 표준 인식 문서 역할을 합니다. 2021년 판은 위협 환경의 중대한 변화를 반영하여 세 가지 새로운 카테고리와 주요 재편성이 있습니다. 이 레슨에서는 설명, 실제 사례, 취약한 코드, 수정된 코드, 방어 전략과 함께 열 가지 카테고리 각각을 다룹니다.</p>
<h2 id="_1">학습 목표<a class="header-link" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li>OWASP Top 10 (2021) 모든 카테고리 이해하기</li>
<li>각 카테고리의 취약한 코드 패턴 식별하기</li>
<li>각 취약점 클래스를 방지하는 안전한 코드 작성하기</li>
<li>개발 및 코드 리뷰 시 보안 체크리스트로 OWASP Top 10 적용하기</li>
<li>각 취약점의 실제 영향 인식하기</li>
</ul>
<hr />
<h2 id="1-2021-top-10">1. 개요: 2021 Top 10<a class="header-link" href="#1-2021-top-10" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│                  OWASP Top 10 - 2021                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  #   카테고리                              2017년 대비 변화     │
│  ─── ──────────────────────────────────── ────────────────────  │
│  A01  취약한 접근 제어                      ↑ #5에서 상승        │
│  A02  암호화 실패                           ↑ #3에서 상승(이름변경)│
│  A03  인젝션                                ↓ #1에서 하락        │
│  A04  안전하지 않은 설계                    ★ 신규               │
│  A05  보안 구성 오류                        ↑ #6에서 상승        │
│  A06  취약하고 오래된 구성 요소             ↑ #9에서 상승(이름변경)│
│  A07  식별 및 인증 실패                     ↓ #2에서 하락(이름변경)│
│  A08  소프트웨어 및 데이터 무결성 실패      ★ 신규               │
│  A09  보안 로깅 및 모니터링 실패            ↑ #10에서 상승(이름변경)│
│  A10  서버 측 요청 위조 (SSRF)              ★ 신규               │
│                                                                  │
│  주요 트렌드:                                                    │
│  - 취약한 접근 제어가 1위 (테스트된 앱의 94%)                   │
│  - 인젝션이 #1에서 #3으로 하락 (프레임워크가 도움)             │
│  - 세 가지 새 카테고리가 현대 위협 반영                         │
│  - 공급망 및 무결성 우려 증가                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<hr />
<h2 id="2-a01">2. A01: 취약한 접근 제어<a class="header-link" href="#2-a01" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 설명<a class="header-link" href="#21" title="Permanent link">&para;</a></h3>
<p>접근 제어는 사용자가 의도된 권한을 벗어나 행동할 수 없도록 정책을 강제합니다. 취약한 접근 제어는 <strong>가장 일반적인</strong> 웹 애플리케이션 취약점으로, 테스트된 애플리케이션의 94%에서 발견됩니다.</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│              A01: 취약한 접근 제어                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  일반적인 약점:                                                  │
│  - URL/파라미터/API 수정으로 접근 제어 우회                     │
│  - 다른 사람의 계정 보기 또는 편집 (IDOR)                       │
│  - 접근 제어가 누락된 API 접근 (POST/PUT/DELETE)                │
│  - 권한 상승 (로그인 없이 관리자로 행동)                        │
│  - 메타데이터 조작 (JWT 재생, 쿠키 변조)                        │
│  - 무단 API 접근을 허용하는 CORS 구성 오류                      │
│  - 인증되지 않은/관리자 페이지로 강제 브라우징                  │
│                                                                  │
│  영향: 데이터 도난, 무단 데이터 수정,                            │
│        계정 탈취, 전체 시스템 침해                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="22">2.2 취약한 코드<a class="header-link" href="#22" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 취약: 관리자 엔드포인트에 접근 제어 없음</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/admin/users/&lt;int:user_id&gt;/delete&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="c1"># 이 URL을 아는 사람은 누구나 사용자를 삭제할 수 있음!</span>
    <span class="n">db</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;deleted&quot;</span><span class="p">})</span>


<span class="c1"># 취약: IDOR - 소유권 확인 없음</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/orders/&lt;int:order_id&gt;&#39;</span><span class="p">)</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">):</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>  <span class="c1"># 사용자 A가 사용자 B의 주문을 볼 수 있음</span>
</code></pre></div>

<h3 id="23">2.3 수정된 코드<a class="header-link" href="#23" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 수정: 적절한 인가 확인</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/admin/users/&lt;int:user_id&gt;/delete&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_role</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>  <span class="c1"># 관리자만 접근 가능</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;deleted&quot;</span><span class="p">})</span>


<span class="c1"># 수정: 소유권 검증</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/orders/&lt;int:order_id&gt;&#39;</span><span class="p">)</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">):</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="c1"># 주문이 인증된 사용자에게 속하는지 검증</span>
    <span class="k">if</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>  <span class="c1"># 403이 아닌 404</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</code></pre></div>

<h3 id="24">2.4 방어<a class="header-link" href="#24" title="Permanent link">&para;</a></h3>
<ul>
<li>공개 리소스를 제외하고 기본적으로 거부</li>
<li>접근 제어 메커니즘을 한 번 구현하고 모든 곳에서 재사용</li>
<li>레코드 소유권 강제 (사용자가 제공한 ID에만 의존하지 않기)</li>
<li>웹 서버 디렉토리 목록 비활성화</li>
<li>접근 제어 실패를 로그에 기록하고 관리자에게 알림</li>
<li>자동화된 스캔 피해를 최소화하기 위해 API 접근 속도 제한</li>
<li>로그아웃 시 JWT 토큰 무효화 (서버 측 토큰 차단 목록)</li>
</ul>
<hr />
<h2 id="3-a02">3. A02: 암호화 실패<a class="header-link" href="#3-a02" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 설명<a class="header-link" href="#31" title="Permanent link">&para;</a></h3>
<p>이전에는 "민감한 데이터 노출"이라고 불렸으며, 이 카테고리는 민감한 데이터 노출로 이어지는 암호화 관련 실패에 초점을 맞춥니다. 보호해야 할 데이터를 암호화하지 않는 것과 약하거나 오래된 암호화 알고리즘 사용을 모두 포함합니다.</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│              A02: 암호화 실패                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  스스로에게 물어보세요:                                          │
│  1. 어떤 데이터가 평문으로 전송되거나 저장되는가?               │
│  2. 오래되거나 약한 암호화 알고리즘이나 프로토콜이 사용되는가? │
│  3. 기본 암호화 키가 사용되거나 키가 순환되지 않는가?          │
│  4. 암호화가 강제되지 않는가 (HTTPS 리디렉션 누락)?            │
│  5. 적절한 HTTP 보안 헤더가 누락되어 있는가?                   │
│  6. 서버 인증서가 올바르게 검증되는가?                          │
│  7. 비밀번호에 대해 deprecated 해싱이 사용되는가 (MD5, SHA1)?  │
│                                                                  │
│  민감한 데이터 카테고리:                                         │
│  - 비밀번호, 신용카드 번호, 건강 기록                           │
│  - 개인 데이터, 비즈니스 비밀                                   │
│  - 개인정보 보호 규정에 의해 보호되는 데이터 (GDPR, HIPAA, PCI)│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="32">3.2 취약한 코드<a class="header-link" href="#32" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 취약: MD5로 비밀번호 저장</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>

<span class="k">def</span><span class="w"> </span><span class="nf">store_password</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
    <span class="c1"># MD5는 비밀번호 해싱에 깨졌음!</span>
    <span class="n">hash_value</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">hash_value</span><span class="p">)</span>

<span class="c1"># 취약: 하드코딩된 암호화 키</span>
<span class="n">ENCRYPTION_KEY</span> <span class="o">=</span> <span class="s2">&quot;my-secret-key-123&quot;</span>  <span class="c1"># 소스 제어에 커밋됨!</span>

<span class="c1"># 취약: ECB 모드 사용 (패턴 드러남)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Crypto.Cipher</span><span class="w"> </span><span class="kn">import</span> <span class="n">AES</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_ECB</span><span class="p">)</span>  <span class="c1"># ECB 모드는 안전하지 않음!</span>
<span class="n">encrypted</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># 취약: 민감한 데이터에 HTTP 사용</span>
<span class="c1"># HTTP에서 HTTPS로의 리디렉션 없음</span>
<span class="c1"># HSTS 헤더 없음</span>
</code></pre></div>

<h3 id="33">3.3 수정된 코드<a class="header-link" href="#33" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 수정: 비밀번호에 Argon2 사용</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">argon2</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHasher</span>
<span class="n">ph</span> <span class="o">=</span> <span class="n">PasswordHasher</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">store_password</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
    <span class="n">hash_value</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>  <span class="c1"># 자동 솔팅을 사용한 Argon2id</span>
    <span class="n">db</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">hash_value</span><span class="p">)</span>

<span class="c1"># 수정: 환경에서 키 가져오기, 소스 코드에서 가져오지 않기</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">ENCRYPTION_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ENCRYPTION_KEY&#39;</span><span class="p">]</span>  <span class="c1"># 256비트 키</span>

<span class="c1"># 수정: GCM 모드 사용 (인증된 암호화)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.ciphers.aead</span><span class="w"> </span><span class="kn">import</span> <span class="n">AESGCM</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">AESGCM</span><span class="o">.</span><span class="n">generate_key</span><span class="p">(</span><span class="n">bit_length</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="n">aesgcm</span> <span class="o">=</span> <span class="n">AESGCM</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">nonce</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>  <span class="c1"># nonce를 절대 재사용하지 마세요</span>
<span class="n">encrypted</span> <span class="o">=</span> <span class="n">aesgcm</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">associated_data</span><span class="p">)</span>

<span class="c1"># 수정: HTTPS 강제 및 보안 헤더 추가</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">set_security_headers</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Strict-Transport-Security&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="s1">&#39;max-age=31536000; includeSubDomains&#39;</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Content-Type-Options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nosniff&#39;</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Frame-Options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DENY&#39;</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<h3 id="34">3.4 방어<a class="header-link" href="#34" title="Permanent link">&para;</a></h3>
<ul>
<li>민감도에 따라 데이터 분류; 분류별로 제어 적용</li>
<li>불필요한 민감한 데이터를 저장하지 마세요; 가능한 한 빨리 폐기</li>
<li>모든 민감한 데이터를 저장 시 및 전송 시 암호화 (TLS 1.2+)</li>
<li>강력하고 표준 알고리즘 사용 (AES-256-GCM, RSA-2048+, Ed25519)</li>
<li>인증된 암호화 사용 (GCM, ChaCha20-Poly1305), ECB는 절대 사용 안 함</li>
<li>Argon2id, bcrypt 또는 scrypt를 사용하여 비밀번호 저장</li>
<li>암호학적으로 안전한 난수 생성기를 사용하여 키 생성</li>
<li>민감한 데이터가 포함된 페이지의 캐싱 비활성화</li>
</ul>
<hr />
<h2 id="4-a03">4. A03: 인젝션<a class="header-link" href="#4-a03" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 설명<a class="header-link" href="#41" title="Permanent link">&para;</a></h3>
<p>인젝션 결함은 신뢰할 수 없는 데이터가 명령 또는 쿼리의 일부로 인터프리터에 전송될 때 발생합니다. 공격자의 악의적인 데이터는 인터프리터를 속여 의도하지 않은 명령을 실행하거나 권한 없이 데이터에 접근하게 할 수 있습니다. SQL 인젝션, NoSQL 인젝션, OS 명령 인젝션, LDAP 인젝션은 모두 이 취약점의 형태입니다.</p>
<blockquote>
<p><strong>참고</strong>: 인젝션은 레슨 08에서 훨씬 더 자세히 다룹니다. 이 섹션은 요약을 제공합니다.</p>
</blockquote>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│              A03: 인젝션                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  인젝션 유형:                                                    │
│  ├── SQL 인젝션           (가장 일반적)                          │
│  ├── NoSQL 인젝션         (MongoDB 등)                           │
│  ├── 명령 인젝션          (os.system, subprocess)                │
│  ├── LDAP 인젝션          (디렉토리 서비스)                      │
│  ├── XPath 인젝션         (XML 쿼리)                             │
│  ├── 템플릿 인젝션        (Jinja2, Twig SSTI)                   │
│  └── 표현 언어            (Spring EL, OGNL)                      │
│                                                                  │
│  근본 원인:                                                      │
│  사용자 입력이 매개변수화되거나 적절히 이스케이프되는 대신       │
│  쿼리/명령에 연결됨                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="42-vs">4.2 취약 코드 vs 수정된 코드<a class="header-link" href="#42-vs" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 취약: SQL 인젝션</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/search&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">():</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
    <span class="c1"># 문자열 연결 = SQL 인젝션!</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT * FROM products WHERE name LIKE &#39;%</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">%&#39;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># 공격: /search?q=&#39; OR &#39;1&#39;=&#39;1&#39; --</span>


<span class="c1"># 수정: 매개변수화된 쿼리</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/search&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;SELECT * FROM products WHERE name LIKE :query&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">}</span>  <span class="c1"># 파라미터 바인딩</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>

<h3 id="43">4.3 방어<a class="header-link" href="#43" title="Permanent link">&para;</a></h3>
<ul>
<li>매개변수화된 쿼리 / 준비된 문 사용 (항상)</li>
<li>매개변수화를 처리하는 ORM 프레임워크 사용 (SQLAlchemy, Django ORM)</li>
<li>모든 입력 검증 및 정제 (화이트리스트 검증)</li>
<li>특정 인터프리터에 대한 특수 문자 이스케이프</li>
<li>인젝션 시 대량 공개를 방지하기 위해 쿼리에 LIMIT 사용</li>
</ul>
<hr />
<h2 id="5-a04">5. A04: 안전하지 않은 설계<a class="header-link" href="#5-a04" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 설명<a class="header-link" href="#51" title="Permanent link">&para;</a></h3>
<p>이것은 2021년의 <strong>새로운 카테고리</strong>로 설계 및 아키텍처 결함과 관련된 위험에 초점을 맞춥니다. 위협 모델링, 보안 설계 패턴 및 참조 아키텍처의 더 많은 사용을 요구합니다. 안전하지 않은 설계는 완벽한 구현으로도 수정할 수 없습니다 - 결함이 있는 설계는 본질적으로 취약합니다.</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│              A04: 안전하지 않은 설계                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  안전하지 않은 설계 ≠ 안전하지 않은 구현                        │
│                                                                  │
│  ┌──────────────────┐    ┌──────────────────┐                   │
│  │ 안전하지 않은    │    │ 안전하지 않은    │                   │
│  │ 설계             │    │ 구현             │                   │
│  │                  │    │                  │                    │
│  │ 청사진이 결함이  │    │ 청사진은 좋지만  │                    │
│  │ 있음. 코드 수정  │    │ 코드에 버그가    │                    │
│  │ 으로 도움 안됨.  │    │ 있음.            │                    │
│  │                  │    │                  │                    │
│  │ 예시:            │    │ 예시:            │                    │
│  │ 비밀번호 재설정  │    │ 로그인 폼의      │                    │
│  │ 이메일로 평문    │    │ SQL 인젝션       │                    │
│  │ 비밀번호 전송    │    │                  │                    │
│  │ (설계상)         │    │                  │                    │
│  └──────────────────┘    └──────────────────┘                   │
│                                                                  │
│  안전하지 않은 설계의 예:                                        │
│  - 인증에 속도 제한 없음 (무차별 대입 공격 가능)                │
│  - 비밀번호 복구의 유일한 방법으로 보안 질문 사용               │
│  - 입력 검증 아키텍처 없음 (각 개발자가 자신의 방식으로 구현)  │
│  - 설계상 소스 코드에 비밀 저장                                 │
│  - 다중 테넌트 시스템에서 테넌트 데이터 간 분리 없음            │
│  - 요구사항에서 남용 사례 누락 (행복한 경로만)                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="52">5.2 실제 사례: 영화관 예약<a class="header-link" href="#52" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 안전하지 않은 설계: 속도 제한 없는 영화 티켓 예약</span>
<span class="c1"># 설계상 봇이 인기 영화의 모든 티켓을 예약할 수 있음</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/book&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">book_ticket</span><span class="p">():</span>
    <span class="n">movie_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;movie_id&#39;</span><span class="p">]</span>
    <span class="n">seats</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;seats&#39;</span><span class="p">]</span>  <span class="c1"># 좌석 수 제한 없음!</span>

    <span class="c1"># 사용자당 속도 제한 없음</span>
    <span class="c1"># 거래당 최대 좌석 수 없음</span>
    <span class="c1"># 수요가 많은 이벤트에 CAPTCHA 없음</span>
    <span class="c1"># 사기 탐지 없음</span>

    <span class="n">booking</span> <span class="o">=</span> <span class="n">create_booking</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">movie_id</span><span class="p">,</span> <span class="n">seats</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">booking</span><span class="p">)</span>


<span class="c1"># 안전한 설계: 적절한 보호 장치 포함</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/book&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span>
<span class="nd">@rate_limit</span><span class="p">(</span><span class="n">max_requests</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">per_minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 속도 제한</span>
<span class="k">def</span><span class="w"> </span><span class="nf">book_ticket</span><span class="p">():</span>
    <span class="n">movie_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;movie_id&#39;</span><span class="p">]</span>
    <span class="n">seats</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;seats&#39;</span><span class="p">]</span>

    <span class="c1"># 설계 수준 제어</span>
    <span class="n">MAX_SEATS_PER_BOOKING</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seats</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_SEATS_PER_BOOKING</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;예약당 최대 </span><span class="si">{</span><span class="n">MAX_SEATS_PER_BOOKING</span><span class="si">}</span><span class="s2">석&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># 사용자가 이 상영회에 너무 많은 좌석을 이미 예약했는지 확인</span>
    <span class="n">existing</span> <span class="o">=</span> <span class="n">get_user_bookings</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">movie_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># 영화당 사용자당 최대 2개 예약</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;이 영화에 대한 최대 예약 수에 도달했습니다&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># 수요가 많은 이벤트의 경우 추가 검증 필요</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="n">get_movie</span><span class="p">(</span><span class="n">movie_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">movie</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;high_demand&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_captcha</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;captcha_token&#39;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;CAPTCHA 검증 필요&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">booking</span> <span class="o">=</span> <span class="n">create_booking</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">movie_id</span><span class="p">,</span> <span class="n">seats</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">booking</span><span class="p">)</span>
</code></pre></div>

<h3 id="53">5.3 방어<a class="header-link" href="#53" title="Permanent link">&para;</a></h3>
<ul>
<li>중요한 인증, 접근 제어 및 비즈니스 로직에 위협 모델링 사용</li>
<li>사용자 스토리에 보안 언어 및 제어 통합</li>
<li>모든 중요한 흐름이 남용에 저항하는지 검증하는 단위 및 통합 테스트 작성</li>
<li>실패를 위한 설계: 사용자/세션당 리소스 소비 제한</li>
<li>신뢰 경계를 분리하기 위해 애플리케이션 레이어 계층화</li>
<li>보안 설계 패턴 사용 (예: 무상태 세션 관리, 입력 검증 프레임워크)</li>
</ul>
<hr />
<h2 id="6-a05">6. A05: 보안 구성 오류<a class="header-link" href="#6-a05" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 설명<a class="header-link" href="#61" title="Permanent link">&para;</a></h3>
<p>보안 구성 오류는 실제로 가장 흔히 볼 수 있는 문제입니다. 잘못 구성된 권한, 불필요한 기능 활성화, 기본 계정/비밀번호 미변경, 지나치게 자세한 오류 메시지, 보안 강화 누락이 포함됩니다.</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│              A05: 보안 구성 오류                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  일반적인 구성 오류:                                             │
│  ┌──────────────────────────────────────────────────┐           │
│  │ 문제                     │ 위험                   │           │
│  ├──────────────────────────┼───────────────────────┤           │
│  │ 프로덕션에서 디버그 모드 │ 스택 추적 노출         │           │
│  │ 기본 admin:admin         │ 즉시 침해              │           │
│  │ 디렉토리 목록 활성화     │ 소스/구성 노출         │           │
│  │ 불필요한 서비스          │ 공격 표면 증가         │           │
│  │ 자세한 오류 메시지       │ 정보 공개              │           │
│  │ 보안 헤더 누락           │ XSS, 클릭재킹          │           │
│  │ CORS: Access-Control-    │ 교차 출처 공격         │           │
│  │   Allow-Origin: *        │                         │           │
│  │ 오래된 소프트웨어        │ 알려진 취약점          │           │
│  │ S3 버킷 공개             │ 데이터 침해            │           │
│  │ .git 폴더 노출           │ 소스 코드 유출         │           │
│  └──────────────────────────────────────────────────┘           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="62">6.2 취약한 구성<a class="header-link" href="#62" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 취약: 프로덕션에서 Flask 디버그 모드</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 대화형 디버거 노출!</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dev&#39;</span>  <span class="c1"># 약한/기본 비밀 키</span>

<span class="c1"># 취약: 지나치게 허용적인 CORS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORS</span>
<span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">origins</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>  <span class="c1"># 모든 웹사이트가 요청할 수 있음!</span>

<span class="c1"># 취약: 자세한 오류 메시지</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_error</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span>
        <span class="s2">&quot;traceback&quot;</span><span class="p">:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span>  <span class="c1"># 내부 정보 유출!</span>
        <span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;DATABASE_URI&#39;</span><span class="p">],</span>  <span class="c1"># 자격 증명 유출!</span>
    <span class="p">}),</span> <span class="mi">500</span>
</code></pre></div>

<h3 id="63">6.3 수정된 구성<a class="header-link" href="#63" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># 수정: 환경 기반 구성</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;TESTING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span>  <span class="c1"># 강력하고 무작위</span>

<span class="c1"># 수정: 제한적인 CORS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORS</span>
<span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">origins</span><span class="o">=</span><span class="p">[</span>
    <span class="s2">&quot;https://myapp.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://www.myapp.com&quot;</span><span class="p">,</span>
<span class="p">])</span>

<span class="c1"># 수정: 프로덕션에서 일반적인 오류 메시지</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_error</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="c1"># 전체 오류를 내부적으로 로그</span>
    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Internal error: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 사용자에게 일반 메시지 반환</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;내부 오류가 발생했습니다&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="n">generate_error_reference_id</span><span class="p">(),</span>  <span class="c1"># 지원 티켓용</span>
    <span class="p">}),</span> <span class="mi">500</span>

<span class="c1"># 수정: 보안 헤더</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_security_headers</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Content-Type-Options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nosniff&#39;</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Frame-Options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DENY&#39;</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-XSS-Protection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>  <span class="c1"># 레거시 XSS 필터 비활성화</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Referrer-Policy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;strict-origin-when-cross-origin&#39;</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Security-Policy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;default-src &#39;self&#39;; &quot;</span>
        <span class="s2">&quot;script-src &#39;self&#39;; &quot;</span>
        <span class="s2">&quot;style-src &#39;self&#39; &#39;unsafe-inline&#39;; &quot;</span>
        <span class="s2">&quot;img-src &#39;self&#39; data:; &quot;</span>
        <span class="s2">&quot;font-src &#39;self&#39;; &quot;</span>
        <span class="s2">&quot;frame-ancestors &#39;none&#39;&quot;</span>
    <span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Permissions-Policy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;camera=(), microphone=(), geolocation=()&#39;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_secure</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Strict-Transport-Security&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;max-age=31536000; includeSubDomains; preload&#39;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<h3 id="64">6.4 방어<a class="header-link" href="#64" title="Permanent link">&para;</a></h3>
<ul>
<li>모든 환경에 대해 반복 가능한 강화 프로세스 구현</li>
<li>불필요한 기능, 프레임워크 및 구성 요소 제거 또는 설치하지 않기</li>
<li>패치 관리 프로세스의 일부로 구성 검토 및 업데이트</li>
<li>일관되고 감사 가능한 배포를 위해 인프라를 코드로 사용</li>
<li>CI/CD에서 자동화된 보안 구성 검증 구현</li>
<li>다른 자격 증명으로 환경 분리 (개발, 스테이징, 프로덕션)</li>
</ul>
<hr />
<h2 id="7-a06">7. A06: 취약하고 오래된 구성 요소<a class="header-link" href="#7-a06" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 설명<a class="header-link" href="#71" title="Permanent link">&para;</a></h3>
<p>알려진 취약점이 있는 구성 요소 (라이브러리, 프레임워크, OS)를 사용하는 애플리케이션은 악용될 수 있습니다. 이것은 점점 더 중요해지는 공급망 위험입니다.</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│          A06: 취약하고 오래된 구성 요소                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  다음과 같은 경우 취약합니다:                                    │
│  - 사용된 모든 구성 요소의 버전을 모름                          │
│  - 소프트웨어가 지원되지 않거나 패치되지 않음                   │
│  - 정기적으로 취약점을 스캔하지 않음                            │
│  - 적시에 수정하거나 업그레이드하지 않음                        │
│  - 개발자가 업데이트된 라이브러리의 호환성을 테스트하지 않음    │
│  - 구성 요소 구성이 보안되지 않음 (A05 참조)                    │
│                                                                  │
│  실제 영향:                                                      │
│  - Log4Shell (CVE-2021-44228): Log4j의 치명적 RCE              │
│  - Equifax 침해 (2017): 패치되지 않은 Apache Struts             │
│  - Event-Stream (2018): 악의적인 npm 패키지                     │
│  - ua-parser-js (2021): npm의 공급망 공격                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="72">7.2 종속성 감사<a class="header-link" href="#72" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Python: 알려진 취약점 확인</span>
pip<span class="w"> </span>install<span class="w"> </span>pip-audit
pip-audit<span class="w">                        </span><span class="c1"># 설치된 패키지 스캔</span>
pip-audit<span class="w"> </span>-r<span class="w"> </span>requirements.txt<span class="w">    </span><span class="c1"># requirements 파일 스캔</span>

<span class="c1"># Python: safety로 대체</span>
pip<span class="w"> </span>install<span class="w"> </span>safety
safety<span class="w"> </span>check<span class="w">                     </span><span class="c1"># 설치된 패키지 확인</span>

<span class="c1"># Node.js: 내장 감사</span>
npm<span class="w"> </span>audit
npm<span class="w"> </span>audit<span class="w"> </span>fix<span class="w">                    </span><span class="c1"># 가능한 경우 자동 수정</span>

<span class="c1"># 일반: OWASP Dependency-Check</span>
<span class="c1"># 여러 언어 스캔 (Java, .NET, Python, JS 등)</span>
<span class="c1"># https://owasp.org/www-project-dependency-check/</span>

<span class="c1"># GitHub: Dependabot (취약한 종속성에 대한 자동 PR)</span>
<span class="c1"># GitLab: CI/CD 파이프라인의 종속성 스캔</span>

<span class="c1"># 해시 검증으로 종속성 고정 (Python)</span>
pip<span class="w"> </span>install<span class="w"> </span>--require-hashes<span class="w"> </span>-r<span class="w"> </span>requirements.txt
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># 고정된 버전과 해시가 있는 requirements.txt</span>
<span class="c1"># 생성: pip-compile --generate-hashes requirements.in</span>
<span class="n">flask</span><span class="o">==</span><span class="mf">3.0.0</span> \
    <span class="o">--</span><span class="nb">hash</span><span class="o">=</span><span class="n">sha256</span><span class="p">:</span><span class="mi">21128</span><span class="n">f47e</span><span class="o">...</span>
<span class="n">werkzeug</span><span class="o">==</span><span class="mf">3.0.1</span> \
    <span class="o">--</span><span class="nb">hash</span><span class="o">=</span><span class="n">sha256</span><span class="p">:</span><span class="mi">5</span><span class="n">a7b12abc</span><span class="o">...</span>
</code></pre></div>

<h3 id="73">7.3 방어<a class="header-link" href="#73" title="Permanent link">&para;</a></h3>
<ul>
<li>사용하지 않는 종속성, 기능, 구성 요소, 파일 및 문서 제거</li>
<li>도구를 사용하여 구성 요소 버전을 지속적으로 목록화 (pip-audit, npm audit, OWASP Dependency-Check)</li>
<li>취약점 알림을 위해 CVE 및 NVD와 같은 소스 모니터링</li>
<li>공식 소스에서만 보안 링크를 통해 구성 요소 얻기</li>
<li>유지 관리되지 않는 라이브러리 모니터링 (보안 패치 없음)</li>
<li>패치 계획 수립: 업데이트를 신속하게 테스트하고 배포</li>
</ul>
<hr />
<h2 id="8-a07">8. A07: 식별 및 인증 실패<a class="header-link" href="#8-a07" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 설명<a class="header-link" href="#81" title="Permanent link">&para;</a></h3>
<p>사용자 신원 확인, 인증 및 세션 관리는 인증 관련 공격으로부터 보호하는 데 중요합니다. 이것은 이전에 "취약한 인증"이라고 불렸습니다.</p>
<blockquote>
<p><strong>참고</strong>: 포괄적인 인증 내용은 레슨 05를 참조하세요.</p>
</blockquote>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│          A07: 식별 및 인증 실패                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  약점:                                                           │
│  - 무차별 대입 또는 크레덴셜 스터핑 허용                        │
│  - 약하거나 잘 알려진 비밀번호 허용                             │
│  - 약한 크레덴셜 복구 사용 (&quot;당신의 애완동물 이름은?&quot;)         │
│  - 평문 또는 약하게 해시된 비밀번호 사용                        │
│  - 다중 인증 누락 또는 비효율적                                 │
│  - URL에 세션 ID 노출                                           │
│  - 로그인 후 세션 ID를 순환하지 않음                            │
│  - 로그아웃 시 세션을 적절히 무효화하지 않음                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="82-vs">8.2 취약 코드 vs 수정된 코드<a class="header-link" href="#82-vs" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 취약: 무차별 대입 보호 없음</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login_vulnerable</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">find_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">check_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">password_hash</span><span class="p">):</span>
        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>  <span class="c1"># 세션 재생성 없음!</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credentials&quot;</span><span class="p">}),</span> <span class="mi">401</span>


<span class="c1"># 수정: 속도 제한, 잠금 및 세션 관리 포함</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_limiter</span><span class="w"> </span><span class="kn">import</span> <span class="n">Limiter</span>

<span class="n">limiter</span> <span class="o">=</span> <span class="n">Limiter</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">default_limits</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;200 per day&quot;</span><span class="p">])</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="s2">&quot;5 per minute&quot;</span><span class="p">)</span>  <span class="c1"># 로그인 시도 속도 제한</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login_secure</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>

    <span class="c1"># 계정 잠금 확인</span>
    <span class="k">if</span> <span class="n">is_account_locked</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;계정이 일시적으로 잠겼습니다&quot;</span><span class="p">}),</span> <span class="mi">429</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">find_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">check_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">password_hash</span><span class="p">):</span>
        <span class="c1"># 실패 시도 재설정</span>
        <span class="n">reset_failed_attempts</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

        <span class="c1"># 세션 재생성 (세션 고정 방지)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">permanent</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">})</span>

    <span class="c1"># 실패 시도 증가</span>
    <span class="n">record_failed_attempt</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

    <span class="c1"># 일반 오류 (사용자 이름 존재 여부 공개 안 함)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credentials&quot;</span><span class="p">}),</span> <span class="mi">401</span>
</code></pre></div>

<h3 id="83">8.3 방어<a class="header-link" href="#83" title="Permanent link">&para;</a></h3>
<ul>
<li>다중 인증 구현 (TOTP 또는 FIDO2)</li>
<li>로그인 엔드포인트에 속도 제한 및 계정 잠금 사용</li>
<li>유출된 비밀번호 데이터베이스와 비밀번호 확인</li>
<li>안전한 비밀번호 저장 사용 (Argon2id, bcrypt)</li>
<li>로그인 후 세션 ID 재생성</li>
<li>적절한 세션 타임아웃 및 무효화 구현</li>
</ul>
<hr />
<h2 id="9-a08">9. A08: 소프트웨어 및 데이터 무결성 실패<a class="header-link" href="#9-a08" title="Permanent link">&para;</a></h2>
<h3 id="91">9.1 설명<a class="header-link" href="#91" title="Permanent link">&para;</a></h3>
<p>이 <strong>새로운 카테고리</strong>는 무결성을 검증하지 않고 소프트웨어 업데이트, 중요한 데이터 및 CI/CD 파이프라인에 대한 가정을 하는 데 초점을 맞춥니다. 이전 "안전하지 않은 역직렬화" 카테고리를 포함합니다.</p>
<div class="highlight"><pre><span></span><code><span class="err">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="err">│</span><span class="w">          </span><span class="n">A08</span><span class="p">:</span><span class="w"> </span><span class="err">소프트웨어</span><span class="w"> </span><span class="err">및</span><span class="w"> </span><span class="err">데이터</span><span class="w"> </span><span class="err">무결성</span><span class="w"> </span><span class="err">실패</span><span class="w">                    </span><span class="err">│</span>
<span class="err">├─────────────────────────────────────────────────────────────────┤</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="err">공격</span><span class="w"> </span><span class="err">벡터</span><span class="p">:</span><span class="w">                                                      </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">CI</span><span class="o">/</span><span class="n">CD</span><span class="w"> </span><span class="err">파이프라인</span><span class="w"> </span><span class="err">침해</span><span class="p">:</span><span class="w">                                       </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">공격자가</span><span class="w"> </span><span class="err">빌드</span><span class="w"> </span><span class="err">파이프라인을</span><span class="w"> </span><span class="err">수정하여</span><span class="w"> </span><span class="err">악의적인</span><span class="w"> </span><span class="err">코드</span><span class="w"> </span><span class="err">주입</span><span class="w">       </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">┌──────┐</span><span class="w">    </span><span class="err">┌──────┐</span><span class="w">    </span><span class="err">┌──────┐</span><span class="w">    </span><span class="err">┌──────┐</span><span class="w">              </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="err">│───▶│</span><span class="n">Build</span><span class="w"> </span><span class="err">│───▶│</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="err">│───▶│</span><span class="n">Deploy</span><span class="err">│</span><span class="w">              </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">              </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">└──────┘</span><span class="w">    </span><span class="err">└──┬───┘</span><span class="w">    </span><span class="err">└──────┘</span><span class="w">    </span><span class="err">└──────┘</span><span class="w">              </span><span class="err">│</span>
<span class="err">│</span><span class="w">                    </span><span class="err">│</span><span class="w">                                             </span><span class="err">│</span>
<span class="err">│</span><span class="w">                    </span><span class="err">▼</span><span class="w"> </span><span class="err">공격자가</span><span class="w"> </span><span class="err">여기에</span><span class="w"> </span><span class="err">백도어</span><span class="w"> </span><span class="err">주입</span><span class="w">                 </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="err">검증</span><span class="w"> </span><span class="err">없는</span><span class="w"> </span><span class="err">자동</span><span class="w"> </span><span class="err">업데이트</span><span class="p">:</span><span class="w">                                     </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">앱이</span><span class="w"> </span><span class="err">디지털</span><span class="w"> </span><span class="err">서명</span><span class="w"> </span><span class="err">검증</span><span class="w"> </span><span class="err">없이</span><span class="w"> </span><span class="err">업데이트</span><span class="w"> </span><span class="err">다운로드</span><span class="w">                </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">공격자가</span><span class="w"> </span><span class="n">MITM을</span><span class="w"> </span><span class="err">수행하여</span><span class="w"> </span><span class="err">악의적인</span><span class="w"> </span><span class="err">업데이트</span><span class="w"> </span><span class="err">제공</span><span class="w">             </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="err">안전하지</span><span class="w"> </span><span class="err">않은</span><span class="w"> </span><span class="err">역직렬화</span><span class="p">:</span><span class="w">                                      </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">앱이</span><span class="w"> </span><span class="err">신뢰할</span><span class="w"> </span><span class="err">수</span><span class="w"> </span><span class="err">없는</span><span class="w"> </span><span class="err">데이터를</span><span class="w"> </span><span class="err">역직렬화하여</span><span class="w"> </span><span class="n">RCE</span><span class="w"> </span><span class="err">발생</span><span class="w">          </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span><span class="w">  </span><span class="err">←</span><span class="w"> </span><span class="err">원격</span><span class="w"> </span><span class="err">코드</span><span class="w"> </span><span class="err">실행</span><span class="o">!</span><span class="w">                 </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">│</span><span class="w">  </span><span class="mf">4.</span><span class="w"> </span><span class="err">종속성</span><span class="w"> </span><span class="err">혼동</span><span class="p">:</span><span class="w">                                                 </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">공격자가</span><span class="w"> </span><span class="err">공개</span><span class="w"> </span><span class="err">레지스트리에</span><span class="w"> </span><span class="err">내부</span><span class="w"> </span><span class="err">패키지와</span><span class="w"> </span><span class="err">같은</span><span class="w"> </span><span class="err">이름으로</span><span class="w">       </span><span class="err">│</span>
<span class="err">│</span><span class="w">     </span><span class="err">악의적인</span><span class="w"> </span><span class="err">패키지</span><span class="w"> </span><span class="err">게시</span><span class="w">                                         </span><span class="err">│</span>
<span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span>
<span class="err">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre></div>

<h3 id="92">9.2 취약한 코드: 안전하지 않은 역직렬화<a class="header-link" href="#92" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>

<span class="c1"># 취약: pickle로 신뢰할 수 없는 데이터 역직렬화</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/import&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">import_data_vulnerable</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># RCE! 공격자가 임의 코드 실행 가능</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;imported&quot;</span><span class="p">})</span>

<span class="c1"># 공격 페이로드:</span>
<span class="c1"># import pickle, os</span>
<span class="c1"># class Exploit:</span>
<span class="c1">#     def __reduce__(self):</span>
<span class="c1">#         return (os.system, (&#39;rm -rf /&#39;,))</span>
<span class="c1"># pickle.dumps(Exploit())</span>


<span class="c1"># 취약: YAML load (임의 Python 객체 허용)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/config&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_config_vulnerable</span><span class="p">():</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 안전하지 않음! 코드 실행 가능</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>


<span class="c1"># 수정: 안전한 대안 사용</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/import&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">import_data_secure</span><span class="p">():</span>
    <span class="c1"># 데이터 교환에 pickle 대신 JSON 사용</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">validate_schema</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>  <span class="c1"># 구조 검증</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;잘못된 데이터 형식&quot;</span><span class="p">}),</span> <span class="mi">400</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;imported&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/config&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_config_secure</span><span class="p">():</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># safe_load는 코드 실행 차단</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>

<h3 id="93">9.3 방어<a class="header-link" href="#93" title="Permanent link">&para;</a></h3>
<ul>
<li>소프트웨어/데이터 무결성을 검증하기 위해 디지털 서명 또는 유사한 방법 사용</li>
<li>라이브러리 및 종속성이 신뢰할 수 있는 저장소를 사용하도록 보장</li>
<li>소프트웨어 공급망 보안 도구 사용 (SLSA, Sigstore)</li>
<li>무단 액세스 또는 수정에 대해 CI/CD 파이프라인 검토</li>
<li>신뢰할 수 없는 클라이언트에 서명되지 않거나 암호화되지 않은 직렬화된 데이터 전송 안 함</li>
<li>신뢰할 수 없는 데이터에 <code>pickle</code>, <code>marshal</code> 또는 <code>yaml.load()</code> 절대 사용 안 함</li>
</ul>
<hr />
<h2 id="10-a09">10. A09: 보안 로깅 및 모니터링 실패<a class="header-link" href="#10-a09" title="Permanent link">&para;</a></h2>
<h3 id="101">10.1 설명<a class="header-link" href="#101" title="Permanent link">&para;</a></h3>
<p>충분한 로깅 및 모니터링이 없으면 침해를 제때 감지할 수 없습니다. 대부분의 성공적인 공격은 취약점 탐색으로 시작하며, 이러한 탐색이 계속되도록 허용하면 성공적인 악용 가능성이 높아질 수 있습니다.</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│      A09: 보안 로깅 및 모니터링 실패                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  문제:                                                           │
│  - 로그인 실패가 로깅되지 않음                                  │
│  - 경고 및 오류가 로그 메시지를 생성하지 않거나 불명확함        │
│  - 로그가 로컬에만 저장 (서버가 침해되면 손실)                  │
│  - 알림 임계값 또는 효과적인 에스컬레이션 없음                  │
│  - 침투 테스트 및 DAST 스캔이 알림을 트리거하지 않음            │
│  - 애플리케이션이 공격을 탐지, 에스컬레이션 또는 알림 불가      │
│  - 로그 인젝션: 공격자가 가짜 로그 항목 작성                    │
│                                                                  │
│  침해 탐지 평균 시간: 287일 (IBM 2021)                          │
│  &lt;200일 내 탐지된 침해 비용: $3.6M                              │
│  &gt;200일 후 탐지된 침해 비용: $4.9M                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="102">10.2 보안 로깅 구현<a class="header-link" href="#102" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">security_logging.py - 포괄적인 보안 이벤트 로깅</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># ==============================================================</span>
<span class="c1"># 보안 이벤트 로거</span>
<span class="c1"># ==============================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SecurityLogger</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;구조화된 보안 이벤트 로깅.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;security.</span><span class="si">{</span><span class="n">app_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="c1"># 구조화된 로깅을 위한 JSON 포매터</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">severity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;구조화된 보안 이벤트 로그.&quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="n">event_type</span><span class="p">,</span>
            <span class="s2">&quot;severity&quot;</span><span class="p">:</span> <span class="n">severity</span><span class="p">,</span>
            <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span> <span class="k">if</span> <span class="n">request</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;user_agent&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">request</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;current_user&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">login_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_event</span><span class="p">(</span><span class="s2">&quot;auth.login.success&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">login_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_event</span><span class="p">(</span><span class="s2">&quot;auth.login.failure&quot;</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">,</span>
                       <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sanitize</span><span class="p">(</span><span class="n">username</span><span class="p">),</span>
                       <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">access_denied</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_event</span><span class="p">(</span><span class="s2">&quot;authz.denied&quot;</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">,</span>
                       <span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">suspicious_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">details</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_event</span><span class="p">(</span><span class="s2">&quot;security.suspicious&quot;</span><span class="p">,</span> <span class="s2">&quot;HIGH&quot;</span><span class="p">,</span>
                       <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">details</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">data_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_event</span><span class="p">(</span><span class="s2">&quot;data.access&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                       <span class="n">resource_type</span><span class="o">=</span><span class="n">resource_type</span><span class="p">,</span>
                       <span class="n">resource_id</span><span class="o">=</span><span class="n">resource_id</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_sanitize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;로그 인젝션을 방지하기 위해 로그 입력 정제.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="c1"># 개행 및 제어 문자 제거</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">r&#39;</span><span class="p">)</span>


<span class="n">sec_log</span> <span class="o">=</span> <span class="n">SecurityLogger</span><span class="p">(</span><span class="s2">&quot;myapp&quot;</span><span class="p">)</span>


<span class="c1"># 라우트에서 사용</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">sec_log</span><span class="o">.</span><span class="n">login_success</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sec_log</span><span class="o">.</span><span class="n">login_failure</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;invalid_credentials&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credentials&quot;</span><span class="p">}),</span> <span class="mi">401</span>


<span class="c1"># 무차별 대입 모니터링</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">detect_brute_force</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;잠재적인 무차별 대입 시도 탐지 및 알림.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;/login&#39;</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span>
        <span class="n">recent_failures</span> <span class="o">=</span> <span class="n">get_recent_login_failures</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">recent_failures</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">sec_log</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">(</span>
                <span class="s2">&quot;무차별 대입 공격 가능성&quot;</span><span class="p">,</span>
                <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
                <span class="n">failure_count</span><span class="o">=</span><span class="n">recent_failures</span><span class="p">,</span>
                <span class="n">timeframe_minutes</span><span class="o">=</span><span class="mi">5</span>
            <span class="p">)</span>
            <span class="c1"># 선택적: IP 차단, CAPTCHA 요구, SOC 알림</span>
</code></pre></div>

<h3 id="103">10.3 로그에 기록할 내용<a class="header-link" href="#103" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>이벤트</th>
<th>심각도</th>
<th>포함할 세부 정보</th>
</tr>
</thead>
<tbody>
<tr>
<td>로그인 성공/실패</td>
<td>INFO/WARNING</td>
<td>사용자 이름, IP, 타임스탬프, 사용자 에이전트</td>
</tr>
<tr>
<td>인가 실패</td>
<td>WARNING</td>
<td>사용자, 리소스, 시도한 작업</td>
</tr>
<tr>
<td>입력 검증 실패</td>
<td>WARNING</td>
<td>엔드포인트, 잘못된 입력 유형</td>
</tr>
<tr>
<td>관리자 작업</td>
<td>INFO</td>
<td>관리자 사용자, 작업, 대상</td>
</tr>
<tr>
<td>비밀번호 변경</td>
<td>INFO</td>
<td>사용자 ID (비밀번호는 절대 안 됨)</td>
</tr>
<tr>
<td>계정 잠금</td>
<td>WARNING</td>
<td>사용자 이름, 실패 횟수</td>
</tr>
<tr>
<td>데이터 내보내기/다운로드</td>
<td>INFO</td>
<td>사용자, 데이터 유형, 볼륨</td>
</tr>
<tr>
<td>API 속도 제한 트리거</td>
<td>WARNING</td>
<td>클라이언트, 엔드포인트, 속도</td>
</tr>
<tr>
<td>시스템 오류</td>
<td>ERROR</td>
<td>오류 유형, 스택 추적 (클라이언트에는 안 됨)</td>
</tr>
</tbody>
</table>
<h3 id="104">10.4 방어<a class="header-link" href="#104" title="Permanent link">&para;</a></h3>
<ul>
<li>모든 로그인, 접근 제어 및 서버 측 입력 검증 실패 로그</li>
<li>포렌식 분석을 위한 충분한 컨텍스트가 로그에 있는지 확인</li>
<li>기계 파싱 가능성을 위해 구조화된 로깅 사용 (JSON)</li>
<li>중앙 집중식 로그 관리 구현 (ELK, Splunk, CloudWatch)</li>
<li>에스컬레이션이 있는 효과적인 모니터링 및 알림 설정</li>
<li>인시던트 대응 계획 수립 및 연습</li>
<li>변조로부터 로그 보호 (한 번 쓰기 저장소, 무결성 확인)</li>
</ul>
<hr />
<h2 id="11-a10-ssrf">11. A10: 서버 측 요청 위조 (SSRF)<a class="header-link" href="#11-a10-ssrf" title="Permanent link">&para;</a></h2>
<h3 id="111">11.1 설명<a class="header-link" href="#111" title="Permanent link">&para;</a></h3>
<p>SSRF 결함은 웹 애플리케이션이 사용자가 제공한 URL을 검증하지 않고 원격 리소스를 가져올 때 발생합니다. 이를 통해 공격자는 애플리케이션이 방화벽, VPN 또는 네트워크 ACL로 보호되는 경우에도 예상치 못한 대상으로 조작된 요청을 보내도록 강제할 수 있습니다. 이것은 2021년의 <strong>새로운 카테고리</strong>입니다.</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│              A10: 서버 측 요청 위조 (SSRF)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  정상:                                                           │
│  User ──▶ Server ──▶ https://api.external.com/data              │
│                                                                  │
│  SSRF 공격:                                                      │
│  User ──▶ Server ──▶ http://169.254.169.254/metadata            │
│                       (AWS 인스턴스 메타데이터!)                 │
│                                                                  │
│  User ──▶ Server ──▶ http://localhost:6379/                     │
│                       (내부 Redis 서버!)                         │
│                                                                  │
│  User ──▶ Server ──▶ http://10.0.0.5:8080/admin                │
│                       (내부 관리자 패널!)                        │
│                                                                  │
│  User ──▶ Server ──▶ file:///etc/passwd                         │
│                       (로컬 파일 읽기!)                          │
│                                                                  │
│  영향:                                                           │
│  - 클라우드 인스턴스 메타데이터 접근 (자격 증명 도용)           │
│  - 내부 네트워크 스캔                                            │
│  - 내부 서비스 접근 (Redis, 데이터베이스, 관리자 패널)          │
│  - 로컬 파일 읽기                                                │
│  - Capital One 침해 (2019): SSRF → 메타데이터 → S3 접근        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="112">11.2 취약한 코드<a class="header-link" href="#112" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>

<span class="c1"># 취약: 임의 URL 가져오기</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/fetch-url&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_url_vulnerable</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
    <span class="c1"># 검증 없음! 사용자가 내부 서비스에 접근 가능</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">})</span>

<span class="c1"># 공격 예시:</span>
<span class="c1"># {&quot;url&quot;: &quot;http://169.254.169.254/latest/meta-data/iam/security-credentials/&quot;}</span>
<span class="c1"># {&quot;url&quot;: &quot;http://localhost:6379/CONFIG SET dir /tmp&quot;}</span>
<span class="c1"># {&quot;url&quot;: &quot;file:///etc/passwd&quot;}</span>


<span class="c1"># 취약: 검증 없는 이미지 프록시</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/proxy-image&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">proxy_image_vulnerable</span><span class="p">():</span>
    <span class="n">image_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">)}</span>
</code></pre></div>

<h3 id="113">11.3 수정된 코드<a class="header-link" href="#113" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">ipaddress</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="c1"># 허용된 도메인의 화이트리스트</span>
<span class="n">ALLOWED_DOMAINS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;api.example.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;images.example.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cdn.trusted-partner.com&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># 차단된 IP 범위 (내부 네트워크)</span>
<span class="n">BLOCKED_IP_RANGES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="s2">&quot;10.0.0.0/8&quot;</span><span class="p">),</span>
    <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="s2">&quot;172.16.0.0/12&quot;</span><span class="p">),</span>
    <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="s2">&quot;192.168.0.0/16&quot;</span><span class="p">),</span>
    <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="s2">&quot;127.0.0.0/8&quot;</span><span class="p">),</span>
    <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="s2">&quot;169.254.0.0/16&quot;</span><span class="p">),</span>     <span class="c1"># Link-local (AWS 메타데이터)</span>
    <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="s2">&quot;0.0.0.0/8&quot;</span><span class="p">),</span>
    <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="s2">&quot;100.64.0.0/10&quot;</span><span class="p">),</span>       <span class="c1"># Carrier-grade NAT</span>
    <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="s2">&quot;fd00::/8&quot;</span><span class="p">),</span>             <span class="c1"># IPv6 private</span>
    <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="s2">&quot;::1/128&quot;</span><span class="p">),</span>              <span class="c1"># IPv6 loopback</span>
<span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">is_safe_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;URL이 가져오기에 안전한지 검증.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="c1"># HTTP(S) 스킴만 허용</span>
        <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">hostname</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">hostname</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hostname</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># 옵션 A: 화이트리스트 접근 (가장 강력)</span>
        <span class="k">if</span> <span class="n">hostname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_DOMAINS</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># 옵션 B: 블랙리스트 접근 (화이트리스트가 불가능한 경우)</span>
        <span class="c1"># 호스트 이름을 IP로 해석하고 차단된 범위와 비교</span>
        <span class="n">resolved_ips</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">family</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">sockaddr</span> <span class="ow">in</span> <span class="n">resolved_ips</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_address</span><span class="p">(</span><span class="n">sockaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">blocked_range</span> <span class="ow">in</span> <span class="n">BLOCKED_IP_RANGES</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">blocked_range</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># 수정: 가져오기 전 URL 검증</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/fetch-url&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_url_secure</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_safe_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;URL이 허용되지 않습니다&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># 내부 서비스로의 리디렉션 방지</span>
        <span class="p">)</span>

        <span class="c1"># 리디렉션이 있는 경우 대상도 검증</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">is_redirect</span><span class="p">:</span>
            <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_safe_url</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;차단된 URL로의 리디렉션&quot;</span><span class="p">}),</span> <span class="mi">400</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">10000</span><span class="p">]})</span>  <span class="c1"># 응답 크기 제한</span>

    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;URL을 가져오지 못했습니다&quot;</span><span class="p">}),</span> <span class="mi">400</span>
</code></pre></div>

<h3 id="114">11.4 방어<a class="header-link" href="#114" title="Permanent link">&para;</a></h3>
<ul>
<li>모든 클라이언트 제공 입력 URL을 정제하고 검증</li>
<li>긍정적 허용 목록으로 URL 스킴, 포트 및 대상 강제</li>
<li>원시 응답을 클라이언트에 보내지 않기</li>
<li>HTTP 리디렉션 비활성화</li>
<li>네트워크 수준 세그먼테이션 사용 (서버-내부 트래픽을 방지하는 방화벽 규칙)</li>
<li>클라우드 환경의 경우: 인스턴스 메타데이터에 대해 IMDSv1 대신 IMDSv2 사용 (토큰 필요)</li>
</ul>
<hr />
<h2 id="12">12. 방어 체크리스트<a class="header-link" href="#12" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│          OWASP Top 10 방어 체크리스트                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  A01 - 취약한 접근 제어:                                         │
│  [ ] 기본 거부 접근 제어                                        │
│  [ ] 리소스 소유권 검증                                          │
│  [ ] 민감한 엔드포인트의 속도 제한                               │
│  [ ] CORS 적절히 구성                                           │
│                                                                  │
│  A02 - 암호화 실패:                                              │
│  [ ] 민감도별로 데이터 분류                                     │
│  [ ] 모든 전송 중 데이터에 TLS 1.2+                             │
│  [ ] 저장 중 데이터에 AES-256-GCM 또는 ChaCha20                │
│  [ ] 비밀번호에 Argon2id/bcrypt                                 │
│                                                                  │
│  A03 - 인젝션:                                                   │
│  [ ] 모든 곳에서 매개변수화된 쿼리                               │
│  [ ] 데이터베이스 접근에 ORM 사용                               │
│  [ ] 입력 검증 (화이트리스트 방식)                              │
│  [ ] 컨텍스트에 맞는 출력 인코딩                                │
│                                                                  │
│  A04 - 안전하지 않은 설계:                                       │
│  [ ] 위협 모델링 수행                                           │
│  [ ] 요구사항에 남용 사례 포함                                  │
│  [ ] 민감한 플로우에 속도 제한, CAPTCHA                         │
│  [ ] 보안 설계 리뷰                                             │
│                                                                  │
│  A05 - 보안 구성 오류:                                           │
│  [ ] 각 환경에 대한 강화 체크리스트                             │
│  [ ] 프로덕션에서 디버그 모드 OFF                               │
│  [ ] 보안 헤더 구성                                             │
│  [ ] 기본 크레덴셜 없음                                          │
│                                                                  │
│  A06 - 취약한 구성 요소:                                         │
│  [ ] CI/CD에서 종속성 스캔                                      │
│  [ ] 정기적인 업데이트 및 패치                                  │
│  [ ] 신뢰할 수 있는 소스의 구성 요소만                          │
│  [ ] SBOM(소프트웨어 자재 명세서) 유지                          │
│                                                                  │
│  A07 - 인증 실패:                                                │
│  [ ] MFA 활성화 (특히 관리자 계정)                              │
│  [ ] 실패한 시도 후 계정 잠금                                   │
│  [ ] 로그인 후 세션 재생성                                      │
│  [ ] 유출된 비밀번호 확인                                       │
│                                                                  │
│  A08 - 무결성 실패:                                              │
│  [ ] 업데이트/배포에 대한 디지털 서명                           │
│  [ ] 접근 제어로 CI/CD 파이프라인 보안                          │
│  [ ] 신뢰할 수 없는 데이터의 역직렬화 금지                      │
│  [ ] 외부 스크립트에 대한 SRI(하위 리소스 무결성)               │
│                                                                  │
│  A09 - 로깅 및 모니터링:                                         │
│  [ ] 충분한 컨텍스트로 보안 이벤트 로깅                         │
│  [ ] 중앙 집중식 로그 관리                                      │
│  [ ] 의심스러운 패턴에 대한 알림                                │
│  [ ] 인시던트 대응 계획 테스트                                  │
│                                                                  │
│  A10 - SSRF:                                                     │
│  [ ] URL 검증 (화이트리스트 선호)                               │
│  [ ] 네트워크 세그먼테이션                                      │
│  [ ] 불필요한 URL 스킴 비활성화                                 │
│  [ ] 클라우드 메타데이터에 IMDSv2                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<hr />
<h2 id="13">13. 연습 문제<a class="header-link" href="#13" title="Permanent link">&para;</a></h2>
<h3 id="1">연습 문제 1: 취약점 식별<a class="header-link" href="#1" title="Permanent link">&para;</a></h3>
<p>다음 Flask 애플리케이션을 검토하고 각 취약점에 해당하는 OWASP Top 10 카테고리를 식별하세요.</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">연습 문제: 번호가 매겨진 각 문제에 대한 OWASP Top 10 카테고리를 식별하세요.</span>
<span class="sd">일부 줄에는 여러 문제가 있을 수 있습니다.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">send_file</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>                        <span class="c1"># 문제 1: ???</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;development&#39;</span>          <span class="c1"># 문제 2: ???</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/search&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">():</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;app.db&#39;</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;SELECT * FROM products WHERE name LIKE &#39;%</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">%&#39;&quot;</span>  <span class="c1"># 문제 3: ???</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/&lt;int:user_id&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>                            <span class="c1"># 문제 4: ???</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/import&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">import_data</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>             <span class="c1"># 문제 5: ???</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;imported&quot;</span><span class="p">})</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/fetch&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>                      <span class="c1"># 문제 6: ???</span>
    <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/config&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_config</span><span class="p">():</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>              <span class="c1"># 문제 7: ???</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">find_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">==</span> <span class="n">password</span><span class="p">:</span>         <span class="c1"># 문제 8: ???</span>
        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2"> not found or wrong password&quot;</span><span class="p">}),</span>  <span class="mi">401</span>  <span class="c1"># 문제 9: ???</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">error</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
        <span class="s2">&quot;trace&quot;</span><span class="p">:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>           <span class="c1"># 문제 10: ???</span>
    <span class="p">}),</span> <span class="mi">500</span>
</code></pre></div>

<h3 id="2">연습 문제 2: 안전한 애플리케이션 설계<a class="header-link" href="#2" title="Permanent link">&para;</a></h3>
<p>파일 공유 애플리케이션에 대한 보안 제어를 설계하고 구현하세요.</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">연습 문제: 각 OWASP Top 10 카테고리에 대한 보안 제어를 구현하세요.</span>
<span class="sd">애플리케이션은 사용자가 파일을 업로드, 공유 및 다운로드할 수 있습니다.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SecureFileSharing</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">upload_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
                    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        안전한 파일 업로드.</span>
<span class="sd">        고려 사항: A03 (파일 이름을 통한 인젝션), A04 (파일 크기 제한),</span>
<span class="sd">                  A05 (파일 유형 검증), A08 (무결성 확인)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">share_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">target_user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">permissions</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        다른 사용자와 파일 공유.</span>
<span class="sd">        고려 사항: A01 (접근 제어), A04 (공유 제한)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">download_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        파일 다운로드.</span>
<span class="sd">        고려 사항: A01 (접근 제어), A09 (로깅),</span>
<span class="sd">                  A10 (파일이 외부 URL을 참조하는 경우)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_external_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        외부 URL에서 파일 가져오기.</span>
<span class="sd">        고려 사항: A10 (SSRF), A06 (URL 라이브러리 검증)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="3">연습 문제 3: 보안 감사 보고서<a class="header-link" href="#3" title="Permanent link">&para;</a></h3>
<p>시뮬레이션된 보안 감사 수행:</p>
<div class="highlight"><pre><span></span><code>연습 문제: 다음과 같은 특성을 가진 웹 애플리케이션이 주어졌을 때:
- Python/Flask 백엔드
- PostgreSQL 데이터베이스
- JWT 인증
- 파일 업로드 기능
- 웹훅 통합 (외부 URL 가져오기)
- 15개의 Python 종속성 사용 (6개월 동안 감사되지 않음)
- 로컬 파일에만 기록된 로그
- 속도 제한 없음
- AWS EC2에서 실행

각 OWASP Top 10 카테고리에 대해:
1. 이 애플리케이션에 대한 특정 위험 식별
2. 위험 등급 평가 (Critical/High/Medium/Low)
3. 구체적인 해결 단계 제안
4. 구현 노력 추정

발견 사항을 구조화된 보안 감사 보고서로 작성하세요.
</code></pre></div>

<h3 id="4">연습 문제 4: 취약한 애플리케이션 수정<a class="header-link" href="#4" title="Permanent link">&para;</a></h3>
<p>연습 문제 1의 코드를 가져와서 모든 취약점을 수정하여 다시 작성하세요. 수정된 버전은 모든 OWASP Top 10 카테고리를 다루어야 합니다.</p>
<h3 id="5-owasp-top-10">연습 문제 5: OWASP Top 10 매핑<a class="header-link" href="#5-owasp-top-10" title="Permanent link">&para;</a></h3>
<p>다음 실제 침해 사례를 OWASP Top 10 카테고리에 매핑하세요.</p>
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">Equifax</span><span class="w"> </span><span class="p">(</span><span class="mf">2017</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">패치되지</span><span class="w"> </span><span class="n">않은</span><span class="w"> </span><span class="n">Apache</span><span class="w"> </span><span class="n">Struts</span><span class="w"> </span><span class="n">취약점</span>
<span class="w">   </span><span class="err">→</span><span class="w"> </span><span class="n">A0</span><span class="err">?</span><span class="p">:</span><span class="w"> </span><span class="n">___</span>

<span class="mf">2.</span><span class="w"> </span><span class="n">Capital</span><span class="w"> </span><span class="kr">On</span><span class="n">e</span><span class="w"> </span><span class="p">(</span><span class="mf">2019</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">AWS</span><span class="w"> </span><span class="n">메타데이터</span><span class="w"> </span><span class="n">접근을</span><span class="w"> </span><span class="n">위한</span><span class="w"> </span><span class="n">SSRF</span>
<span class="w">   </span><span class="err">→</span><span class="w"> </span><span class="n">A0</span><span class="err">?</span><span class="p">:</span><span class="w"> </span><span class="n">___</span>

<span class="mf">3.</span><span class="w"> </span><span class="n">SolarWinds</span><span class="w"> </span><span class="p">(</span><span class="mf">2020</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">침해된</span><span class="w"> </span><span class="n">빌드</span><span class="w"> </span><span class="n">파이프라인</span>
<span class="w">   </span><span class="err">→</span><span class="w"> </span><span class="n">A0</span><span class="err">?</span><span class="p">:</span><span class="w"> </span><span class="n">___</span>

<span class="mf">4.</span><span class="w"> </span><span class="n">Facebook</span><span class="w"> </span><span class="p">(</span><span class="mf">2019</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">보호되지</span><span class="w"> </span><span class="n">않은</span><span class="w"> </span><span class="n">S3의</span><span class="w"> </span><span class="mf">5</span><span class="n">억</span><span class="w"> </span><span class="mf">4</span><span class="n">천만</span><span class="w"> </span><span class="n">사용자</span><span class="w"> </span><span class="n">레코드</span>
<span class="w">   </span><span class="err">→</span><span class="w"> </span><span class="n">A0</span><span class="err">?</span><span class="p">:</span><span class="w"> </span><span class="n">___</span>

<span class="mf">5.</span><span class="w"> </span><span class="n">Uber</span><span class="w"> </span><span class="p">(</span><span class="mf">2016</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">GitHub</span><span class="w"> </span><span class="n">저장소에</span><span class="w"> </span><span class="n">하드코딩된</span><span class="w"> </span><span class="n">AWS</span><span class="w"> </span><span class="n">자격</span><span class="w"> </span><span class="n">증명</span>
<span class="w">   </span><span class="err">→</span><span class="w"> </span><span class="n">A0</span><span class="err">?</span><span class="p">:</span><span class="w"> </span><span class="n">___</span>

<span class="mf">6.</span><span class="w"> </span><span class="n">British</span><span class="w"> </span><span class="n">Airways</span><span class="w"> </span><span class="p">(</span><span class="mf">2018</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">결제</span><span class="w"> </span><span class="n">페이지의</span><span class="w"> </span><span class="n">Magecart</span><span class="w"> </span><span class="n">XSS</span>
<span class="w">   </span><span class="err">→</span><span class="w"> </span><span class="n">A0</span><span class="err">?</span><span class="p">:</span><span class="w"> </span><span class="n">___</span>

<span class="mf">7.</span><span class="w"> </span><span class="n">Marriott</span><span class="w"> </span><span class="p">(</span><span class="mf">2018</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">4</span><span class="n">년</span><span class="w"> </span><span class="n">동안</span><span class="w"> </span><span class="n">감지되지</span><span class="w"> </span><span class="n">않은</span><span class="w"> </span><span class="n">침해</span>
<span class="w">   </span><span class="err">→</span><span class="w"> </span><span class="n">A0</span><span class="err">?</span><span class="p">:</span><span class="w"> </span><span class="n">___</span>

<span class="mf">8.</span><span class="w"> </span><span class="n">Yahoo</span><span class="w"> </span><span class="p">(</span><span class="mf">2013</span><span class="o">-</span><span class="mf">2014</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">사용자</span><span class="w"> </span><span class="n">데이터의</span><span class="w"> </span><span class="n">약한</span><span class="o">/</span><span class="n">암호화</span><span class="w"> </span><span class="n">없음</span>
<span class="w">   </span><span class="err">→</span><span class="w"> </span><span class="n">A0</span><span class="err">?</span><span class="p">:</span><span class="w"> </span><span class="n">___</span>
</code></pre></div>

<hr />
<h2 id="14">14. 요약<a class="header-link" href="#14" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────────────────────────────┐
│                OWASP Top 10 (2021) 요약                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  A01: 취약한 접근 제어 - 1위 위협. 기본 거부.                   │
│  A02: 암호화 실패 - 민감한 모든 것을 암호화.                    │
│  A03: 인젝션 - 모든 쿼리를 매개변수화.                          │
│  A04: 안전하지 않은 설계 - 보안은 코드가 아닌 설계에서 시작.   │
│  A05: 보안 구성 오류 - 모든 것을 강화.                          │
│  A06: 취약한 구성 요소 - 종속성을 알고 업데이트.                │
│  A07: 인증 실패 - MFA, 속도 제한, 강력한 비밀번호.              │
│  A08: 무결성 실패 - 모든 것에 서명, pickle 사용 금지.           │
│  A09: 로깅 실패 - 보안 이벤트 로깅, 알림, 대응.                 │
│  A10: SSRF - 모든 URL 검증, 네트워크 세그먼트.                  │
│                                                                  │
│  OWASP Top 10은 시작점이지 완전한 목록이 아닙니다.              │
│  애플리케이션 보안을 위한 최소 기준선으로 사용하세요.            │
│                                                                  │
│  리소스:                                                         │
│  - https://owasp.org/Top10/                                     │
│  - OWASP Application Security Verification Standard (ASVS)     │
│  - OWASP Testing Guide                                          │
│  - OWASP Cheat Sheet Series                                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre></div>

<hr />
<p><strong>이전</strong>: <a href="06_Authorization.md">06. 인가와 접근 제어</a> | <strong>다음</strong>: <a href="08_Injection_Attacks.md">08. 인젝션 공격과 방어</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Security/06_Authorization.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">06. 인가 및 접근 제어</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">🔗</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">📋</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Security/08_Injection_Attacks.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">08. 인젝션 공격과 방어</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">↑</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'ko';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}