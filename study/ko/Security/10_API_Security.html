{% raw %}
<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API ë³´ì•ˆ - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/ko/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/ko/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/ko/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" >
                        English
                    </option>
                    
                    <option value="ko" selected>
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/ko/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/ko/Security/">Security</a>
    <span class="separator">/</span>
    <span class="current">API ë³´ì•ˆ</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>API ë³´ì•ˆ</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Security/09_Web_Security_Headers.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Web Security Headersì™€ CSP</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Security/11_Secrets_Management.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Secrets Managementì™€ í™˜ê²½ ì„¤ì •</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#_1">í•™ìŠµ ëª©í‘œ</a></li>
<li><a href="#1-api">1. API ìœ„í˜‘ í™˜ê²½</a><ul>
<li><a href="#11-owasp-api-top-10-2023">1.1 OWASP API ë³´ì•ˆ Top 10 (2023)</a></li>
<li><a href="#12-api">1.2 API ê³µê²© í‘œë©´</a></li>
</ul>
</li>
<li><a href="#2-api">2. API ì¸ì¦ íŒ¨í„´</a><ul>
<li><a href="#21-api">2.1 API í‚¤</a></li>
<li><a href="#22-oauth-20">2.2 OAuth 2.0</a></li>
<li><a href="#23-jwt-json-web-tokens">2.3 JWT (JSON Web Tokens)</a></li>
<li><a href="#24-jwt">2.4 JWT ë³´ì•ˆ ëª¨ë²” ì‚¬ë¡€</a></li>
</ul>
</li>
<li><a href="#3">3. ì†ë„ ì œí•œ</a><ul>
<li><a href="#31">3.1 ì†ë„ ì œí•œ ì•Œê³ ë¦¬ì¦˜</a></li>
<li><a href="#32-flask-limiter-flask">3.2 Flask-Limiterë¥¼ ì‚¬ìš©í•œ Flask ì†ë„ ì œí•œ</a></li>
<li><a href="#33">3.3 ì‚¬ìš©ì ì •ì˜ í† í° ë²„í‚· êµ¬í˜„</a></li>
</ul>
</li>
<li><a href="#4">4. ì…ë ¥ ê²€ì¦ ë° ì •ì œ</a><ul>
<li><a href="#41">4.1 ê²€ì¦ ì•„í‚¤í…ì²˜</a></li>
<li><a href="#42-marshmallow">4.2 Marshmallowë¥¼ ì‚¬ìš©í•œ ìŠ¤í‚¤ë§ˆ ê²€ì¦</a></li>
<li><a href="#43-pydantic">4.3 Pydantic ê²€ì¦ (ëŒ€ì•ˆ)</a></li>
</ul>
</li>
<li><a href="#5-cors-cross-origin-resource-sharing">5. CORS (Cross-Origin Resource Sharing)</a><ul>
<li><a href="#51-cors">5.1 CORS ì‘ë™ ë°©ì‹</a></li>
<li><a href="#52-flask-cors">5.2 Flask CORS êµ¬ì„±</a></li>
</ul>
</li>
<li><a href="#6-graphql">6. GraphQL ë³´ì•ˆ</a><ul>
<li><a href="#61-graphql">6.1 GraphQL íŠ¹ì • ìœ„í˜‘</a></li>
<li><a href="#62-graphql">6.2 GraphQL ë³´ì•ˆ ì™„í™”</a></li>
</ul>
</li>
<li><a href="#7-api">7. API ê²Œì´íŠ¸ì›¨ì´ ë³´ì•ˆ</a><ul>
<li><a href="#71">7.1 ê²Œì´íŠ¸ì›¨ì´ ì•„í‚¤í…ì²˜</a></li>
<li><a href="#72">7.2 ìš”ì²­/ì‘ë‹µ í•„í„°ë§</a></li>
</ul>
</li>
<li><a href="#8-openapi">8. OpenAPI ë³´ì•ˆ ì •ì˜</a><ul>
<li><a href="#81-openapi-30">8.1 OpenAPI 3.0ì˜ ë³´ì•ˆ ìŠ¤í‚´</a></li>
<li><a href="#82-api">8.2 API ë²„ì „ ê´€ë¦¬ ë³´ì•ˆ</a></li>
</ul>
</li>
<li><a href="#9">9. ìš”ì²­/ì‘ë‹µ ì•”í˜¸í™”</a><ul>
<li><a href="#91">9.1 ì „ì†¡ ê³„ì¸µ ë³´ì•ˆ</a></li>
</ul>
</li>
<li><a href="#10">10. ì—°ìŠµ ë¬¸ì œ</a><ul>
<li><a href="#1-jwt">ì—°ìŠµ 1: ì•ˆì „í•œ JWT ì¸ì¦ ì„œë¹„ìŠ¤</a></li>
<li><a href="#2-cors">ì—°ìŠµ 2: CORS ë³´ì•ˆ ê°ì‚¬</a></li>
<li><a href="#3-graphql">ì—°ìŠµ 3: GraphQL ë³´ì•ˆ ë¯¸ë“¤ì›¨ì–´</a></li>
<li><a href="#4_1">ì—°ìŠµ 4: ìŠ¬ë¼ì´ë”© ìœˆë„ìš°ê°€ ìˆëŠ” ì†ë„ ì œí•œê¸°</a></li>
<li><a href="#5-api">ì—°ìŠµ 5: API ì…ë ¥ ê²€ì¦ í”„ë ˆì„ì›Œí¬</a></li>
<li><a href="#6-api">ì—°ìŠµ 6: API ë³´ì•ˆ ìŠ¤ìºë„ˆ</a></li>
</ul>
</li>
<li><a href="#_2">ìš”ì•½</a><ul>
<li><a href="#api_1">API ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸</a></li>
<li><a href="#_3">í•µì‹¬ ìš”ì </a></li>
</ul>
</li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="api">API ë³´ì•ˆ<a class="header-link" href="#api" title="Permanent link">&para;</a></h1>
<p><strong>ì´ì „</strong>: <a href="./09_Web_Security_Headers.md">09_Web_Security_Headers.md</a> | <strong>ë‹¤ìŒ</strong>: <a href="./11_Secrets_Management.md">11_Secrets_Management.md</a></p>
<hr />
<p>APIëŠ” í˜„ëŒ€ ì†Œí”„íŠ¸ì›¨ì–´ ì‹œìŠ¤í…œì˜ í•µì‹¬ì…ë‹ˆë‹¤. ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¥¼ ì—°ê²°í•˜ê³ , ëª¨ë°”ì¼ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬ë™í•˜ë©°, íƒ€ì‚¬ í†µí•©ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤. APIëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ê³¼ ë°ì´í„°ë¥¼ ì§ì ‘ ë…¸ì¶œí•˜ê¸° ë•Œë¬¸ì— ê³µê²©ìì˜ ì£¼ìš” í‘œì ì…ë‹ˆë‹¤. ë‹¨ì¼ ì—”ë“œí¬ì¸íŠ¸ì˜ ì˜ëª»ëœ êµ¬ì„±ìœ¼ë¡œ ìˆ˜ë°±ë§Œ ê°œì˜ ë ˆì½”ë“œê°€ ë…¸ì¶œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë ˆìŠ¨ì€ APIë¥¼ êµ¬ì¶•, ë°°í¬ ë° ìœ ì§€í•˜ê¸° ìœ„í•œ í•„ìˆ˜ ë³´ì•ˆ ê´€í–‰ì„ ë‹¤ë£¹ë‹ˆë‹¤ â€” ì¸ì¦ ë° ì†ë„ ì œí•œë¶€í„° ì…ë ¥ ê²€ì¦ ë° CORS êµ¬ì„±ê¹Œì§€.</p>
<h2 id="_1">í•™ìŠµ ëª©í‘œ<a class="header-link" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li>API í‚¤, OAuth 2.0 ë° JWTë¥¼ ì‚¬ìš©í•œ ê°•ë ¥í•œ API ì¸ì¦ êµ¬í˜„</li>
<li>ë‚¨ìš©ì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ì†ë„ ì œí•œ ì „ëµ ì„¤ê³„ ë° ë°°í¬</li>
<li>ì£¼ì… ê³µê²©ì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ëª¨ë“  API ì…ë ¥ ê²€ì¦ ë° ì •ì œ</li>
<li>cross-origin ì ‘ê·¼ì„ ì œì–´í•˜ê¸° ìœ„í•œ CORS ì˜¬ë°”ë¥´ê²Œ êµ¬ì„±</li>
<li>ì¼ë°˜ì ì¸ ê³µê²© íŒ¨í„´ìœ¼ë¡œë¶€í„° GraphQL ì—”ë“œí¬ì¸íŠ¸ ë³´í˜¸</li>
<li>OpenAPI/Swagger ëª…ì„¸ì—ì„œ ë³´ì•ˆ ìŠ¤í‚´ ì •ì˜</li>
<li>í”„ë¡œë•ì…˜ í™˜ê²½ì„ ìœ„í•œ API ê²Œì´íŠ¸ì›¨ì´ ë³´ì•ˆ íŒ¨í„´ ì ìš©</li>
</ul>
<hr />
<h2 id="1-api">1. API ìœ„í˜‘ í™˜ê²½<a class="header-link" href="#1-api" title="Permanent link">&para;</a></h2>
<h3 id="11-owasp-api-top-10-2023">1.1 OWASP API ë³´ì•ˆ Top 10 (2023)<a class="header-link" href="#11-owasp-api-top-10-2023" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 OWASP API ë³´ì•ˆ Top 10 (2023)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  API1  BOLA (Broken Object Level Authorization)                     â”‚
â”‚        ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë¦¬ì†ŒìŠ¤ ì ‘ê·¼                                     â”‚
â”‚        GET /api/users/OTHER_USER_ID/orders                           â”‚
â”‚                                                                      â”‚
â”‚  API2  Broken Authentication                                         â”‚
â”‚        ì•½í•œ ì¸ì¦ ë©”ì»¤ë‹ˆì¦˜, í† í° ìœ ì¶œ                                 â”‚
â”‚                                                                      â”‚
â”‚  API3  Broken Object Property Level Authorization                   â”‚
â”‚        ëŒ€ëŸ‰ í• ë‹¹, ë¯¼ê°í•œ ì†ì„± ë…¸ì¶œ                                   â”‚
â”‚                                                                      â”‚
â”‚  API4  Unrestricted Resource Consumption                            â”‚
â”‚        ì†ë„ ì œí•œ ì—†ìŒ, í° í˜ì´ë¡œë“œ, ë¹„ìš©ì´ ë§ì´ ë“œëŠ” ì¿¼ë¦¬            â”‚
â”‚                                                                      â”‚
â”‚  API5  Broken Function Level Authorization                          â”‚
â”‚        ì¼ë°˜ ì‚¬ìš©ìë¡œì„œ ê´€ë¦¬ ê¸°ëŠ¥ ì ‘ê·¼                                â”‚
â”‚        POST /api/admin/users/delete                                  â”‚
â”‚                                                                      â”‚
â”‚  API6  Unrestricted Access to Sensitive Business Flows              â”‚
â”‚        ë¹„ì¦ˆë‹ˆìŠ¤ ê¸°ëŠ¥ì˜ ìë™í™”ëœ ë‚¨ìš©                                 â”‚
â”‚                                                                      â”‚
â”‚  API7  Server-Side Request Forgery (SSRF)                           â”‚
â”‚        ê²€ì¦ ì—†ì´ ì‚¬ìš©ì ì…ë ¥ì—ì„œ URL ê°€ì ¸ì˜¤ê¸°                        â”‚
â”‚                                                                      â”‚
â”‚  API8  Security Misconfiguration                                    â”‚
â”‚        í—¤ë” ëˆ„ë½, ìì„¸í•œ ì˜¤ë¥˜, ê¸°ë³¸ ìê²© ì¦ëª…                        â”‚
â”‚                                                                      â”‚
â”‚  API9  Improper Inventory Management                                â”‚
â”‚        ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” API ë²„ì „, ì„€ë„ìš° API                            â”‚
â”‚                                                                      â”‚
â”‚  API10 Unsafe Consumption of APIs                                   â”‚
â”‚        íƒ€ì‚¬ API ì‘ë‹µì„ ë§¹ëª©ì ìœ¼ë¡œ ì‹ ë¢°                               â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="12-api">1.2 API ê³µê²© í‘œë©´<a class="header-link" href="#12-api" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API ê³µê²© í‘œë©´                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Client  â”‚â”€â”€â”€â–¶â”‚ Network  â”‚â”€â”€â”€â–¶â”‚ API      â”‚â”€â”€â”€â–¶â”‚ Database â”‚      â”‚
â”‚  â”‚          â”‚    â”‚          â”‚    â”‚ Server   â”‚    â”‚          â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                      â”‚
â”‚  ê° ê³„ì¸µì˜ ê³µê²© ë²¡í„°:                                                â”‚
â”‚                                                                      â”‚
â”‚  Client:     ë³€ì¡°ëœ ìš”ì²­, ë„ë‚œë‹¹í•œ í† í°, ì¬ìƒ ê³µê²©                   â”‚
â”‚  Network:    ì¤‘ê°„ì ê³µê²©, ë„ì²­, DNS í•˜ì´ì¬í‚¹                         â”‚
â”‚  API Server: ì£¼ì…, ì¸ì¦ ì†ìƒ, BOLA, ëŒ€ëŸ‰ í• ë‹¹                       â”‚
â”‚  Database:   SQL ì£¼ì…, ë°ì´í„° ìœ ì¶œ, ë¬´ë‹¨ ì ‘ê·¼                        â”‚
â”‚                                                                      â”‚
â”‚  í¬ê´„ì ì¸ ìš°ë ¤ ì‚¬í•­:                                                 â”‚
â”‚  â”œâ”€â”€ ì¸ì¦         (ë‹¹ì‹ ì€ ëˆ„êµ¬ì¸ê°€?)                                â”‚
â”‚  â”œâ”€â”€ ì¸ê°€         (ë¬´ì—‡ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‚˜?)                          â”‚
â”‚  â”œâ”€â”€ ì…ë ¥ ê²€ì¦    (ì´ ìš”ì²­ì€ ì•ˆì „í•œê°€?)                             â”‚
â”‚  â”œâ”€â”€ ì†ë„ ì œí•œ    (APIë¥¼ ë‚¨ìš©í•˜ê³  ìˆë‚˜?)                            â”‚
â”‚  â”œâ”€â”€ ì•”í˜¸í™”        (ì „ì†¡ ì¤‘ ë°ì´í„°ê°€ ë³´í˜¸ë˜ëŠ”ê°€?)                    â”‚
â”‚  â””â”€â”€ ë¡œê¹…/ëª¨ë‹ˆí„°ë§ (ê³µê²©ì„ ê°ì§€í•  ìˆ˜ ìˆë‚˜?)                          â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="2-api">2. API ì¸ì¦ íŒ¨í„´<a class="header-link" href="#2-api" title="Permanent link">&para;</a></h2>
<h3 id="21-api">2.1 API í‚¤<a class="header-link" href="#21-api" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">API í‚¤ ì¸ì¦ â€” ë‹¨ìˆœí•˜ì§€ë§Œ ì œí•œì .</span>
<span class="sd">ì„œë²„ ê°„ í†µì‹  ë° ì‚¬ìš© ì¶”ì ì´ ìˆëŠ” ê³µê°œ APIì— ì í•©.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># â”€â”€ API í‚¤ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_api_key</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API í‚¤ì™€ ì €ì¥ìš© í•´ì‹œë¥¼ ìƒì„±.&quot;&quot;&quot;</span>
    <span class="c1"># ì•”í˜¸í•™ì ìœ¼ë¡œ ì•ˆì „í•œ í‚¤ ìƒì„±</span>
    <span class="c1"># ì ‘ë‘ì‚¬ëŠ” í‚¤ ìœ í˜•ê³¼ ë²„ì „ì„ ì‹ë³„í•˜ëŠ” ë° ë„ì›€</span>
    <span class="n">raw_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sk_live_</span><span class="si">{</span><span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># ì›ì‹œ í‚¤ëŠ” ì ˆëŒ€ ì €ì¥í•˜ì§€ ë§ê³  í•´ì‹œë§Œ ì €ì¥</span>
    <span class="n">key_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">raw_key</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">raw_key</span><span class="p">,</span> <span class="n">key_hash</span>

<span class="c1"># raw_key: sk_live_Abc123...  (í´ë¼ì´ì–¸íŠ¸ì— í•œ ë²ˆ ì „ì†¡, ì €ì¥ ì•ˆ í•¨)</span>
<span class="c1"># key_hash: e3b0c4...         (ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥)</span>


<span class="c1"># â”€â”€ ì‹œë®¬ë ˆì´ì…˜ëœ í‚¤ ì €ì¥ì†Œ (í”„ë¡œë•ì…˜ì—ì„œëŠ” ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©) â”€â”€â”€â”€</span>
<span class="n">API_KEYS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># í•´ì‹œ -&gt; ë©”íƒ€ë°ì´í„°</span>
    <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;sk_live_test_key_12345&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">():</span> <span class="p">{</span>
        <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="s2">&quot;client_001&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Test Client&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rate_limit&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>       <span class="c1"># ë¶„ë‹¹ ìš”ì²­ ìˆ˜</span>
        <span class="s2">&quot;scopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="s2">&quot;write&quot;</span><span class="p">],</span>
        <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2025-01-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;last_used&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_api_key</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ìœ íš¨í•œ API í‚¤ë¥¼ ìš”êµ¬í•˜ëŠ” ë°ì½”ë ˆì´í„°.&quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># API í‚¤ë¥¼ ì—¬ëŸ¬ ìœ„ì¹˜ì—ì„œ í™•ì¸</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-API-Key&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;api_key&#39;</span><span class="p">)</span>  <span class="c1"># ëœ ì•ˆì „, ê°€ëŠ¥í•˜ë©´ í”¼í•˜ê¸°</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;missing_api_key&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. &quot;</span>
                           <span class="s2">&quot;X-API-Key í—¤ë”ì— ì „ë‹¬í•˜ì„¸ìš”.&quot;</span>
            <span class="p">}),</span> <span class="mi">401</span>

        <span class="c1"># ì œê³µëœ í‚¤ë¥¼ í•´ì‹œí•˜ê³  ì¡°íšŒ</span>
        <span class="n">key_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">api_key</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">key_data</span> <span class="o">=</span> <span class="n">API_KEYS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key_hash</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">key_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid_api_key&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;ì œê³µëœ API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.&quot;</span>
            <span class="p">}),</span> <span class="mi">401</span>

        <span class="c1"># ë§ˆì§€ë§‰ ì‚¬ìš© íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸</span>
        <span class="n">key_data</span><span class="p">[</span><span class="s2">&quot;last_used&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

        <span class="c1"># ìš”ì²­ ì»¨í…ìŠ¤íŠ¸ì— í‚¤ ë©”íƒ€ë°ì´í„° ì €ì¥</span>
        <span class="n">request</span><span class="o">.</span><span class="n">api_client</span> <span class="o">=</span> <span class="n">key_data</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decorated</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/data&#39;</span><span class="p">)</span>
<span class="nd">@require_api_key</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API í‚¤ê°€ í•„ìš”í•œ ë³´í˜¸ëœ ì—”ë“œí¬ì¸íŠ¸.&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">api_client</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;client&quot;</span><span class="p">:</span> <span class="n">client</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="p">})</span>


<span class="c1"># â”€â”€ API í‚¤ ë³´ì•ˆ ëª¨ë²” ì‚¬ë¡€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">1. ì „ì†¡:</span>
<span class="sd">   - í•­ìƒ HTTPS ì‚¬ìš©</span>
<span class="sd">   - ì¿¼ë¦¬ ë§¤ê°œë³€ìˆ˜ë³´ë‹¤ í—¤ë” ì„ í˜¸ (ì¿¼ë¦¬ ë§¤ê°œë³€ìˆ˜ëŠ” ë¡œê·¸ì— ë‚˜íƒ€ë‚¨)</span>
<span class="sd">   - X-API-Key í—¤ë” ë˜ëŠ” Authorization: Bearer &lt;key&gt; ì‚¬ìš©</span>

<span class="sd">2. ì €ì¥:</span>
<span class="sd">   - ì €ì¥í•˜ê¸° ì „ì— í‚¤ í•´ì‹œ (ìµœì†Œ SHA-256)</span>
<span class="sd">   - ì „ì²´ API í‚¤ë¥¼ ë¡œê·¸ì— ë‚¨ê¸°ì§€ ë§ ê²ƒ</span>
<span class="sd">   - UIì—ëŠ” ë§ˆì§€ë§‰ 4ìë§Œ í‘œì‹œ: sk_live_****5678</span>

<span class="sd">3. ìˆœí™˜:</span>
<span class="sd">   - í´ë¼ì´ì–¸íŠ¸ë‹¹ ì—¬ëŸ¬ í™œì„± í‚¤ ì§€ì›</span>
<span class="sd">   - ë‹¤ìš´íƒ€ì„ ì—†ì´ í‚¤ ìˆœí™˜ í—ˆìš©</span>
<span class="sd">   - í‚¤ì— ë§Œë£Œì¼ ì„¤ì •</span>

<span class="sd">4. ë²”ìœ„ ì§€ì •:</span>
<span class="sd">   - ê° í‚¤ì— ë²”ìœ„/ê¶Œí•œ í• ë‹¹</span>
<span class="sd">   - ì½ê¸° ëŒ€ ì“°ê¸° ì‘ì—…ì— ë³„ë„ í‚¤ ì‚¬ìš©</span>
<span class="sd">   - í…ŒìŠ¤íŠ¸ ëŒ€ í”„ë¡œë•ì…˜ì— ë³„ë„ í‚¤ ì‚¬ìš©</span>

<span class="sd">5. ì œí•œ ì‚¬í•­:</span>
<span class="sd">   - API í‚¤ëŠ” ì‚¬ìš©ìê°€ ì•„ë‹Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹ë³„</span>
<span class="sd">   - ë‚´ì¥ ë§Œë£Œê°€ ë¶€ì¡± (í† í°ê³¼ ë‹¬ë¦¬)</span>
<span class="sd">   - ìš”ì²­ë³„ë¡œ ì‰½ê²Œ ë²”ìœ„ë¥¼ ì§€ì •í•  ìˆ˜ ì—†ìŒ</span>
<span class="sd">   - ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸ ì¸ê°€ì—ëŠ” OAuth 2.0 ì‚¬ìš©</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>

<h3 id="22-oauth-20">2.2 OAuth 2.0<a class="header-link" href="#22-oauth-20" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="nx">OAuth</span><span class="w"> </span><span class="m m-Double">2.0</span><span class="w"> </span><span class="nx">Authorization</span><span class="w"> </span><span class="nx">Code</span><span class="w"> </span><span class="nx">íë¦„</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="nx">ì‚¬ìš©ìê°€</span><span class="w"> </span><span class="s">&quot;ì œê³µìë¡œ ë¡œê·¸ì¸&quot;</span><span class="w"> </span><span class="nx">í´ë¦­</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Client</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">Auth</span><span class="w"> </span><span class="nx">Server</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">authorize</span><span class="p">?</span><span class="nx">response_type</span><span class="p">=</span><span class="nx">code</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">client_id</span><span class="p">=</span><span class="nx">CLIENT_ID</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">redirect_uri</span><span class="p">=</span><span class="nx">CALLBACK_URL</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">scope</span><span class="p">=</span><span class="nx">read</span><span class="o">+</span><span class="nx">write</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">state</span><span class="p">=</span><span class="nx">RANDOM_STATE</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="nx">ì‚¬ìš©ì</span><span class="w"> </span><span class="nx">ì¸ì¦</span><span class="w"> </span><span class="nx">ë°</span><span class="w"> </span><span class="nx">ë²”ìœ„</span><span class="w"> </span><span class="nx">ìŠ¹ì¸</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Auth</span><span class="w"> </span><span class="nx">Server</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="nx">Callback</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">callback</span><span class="p">?</span><span class="nx">code</span><span class="p">=</span><span class="nx">AUTH_CODE</span><span class="o">&amp;</span><span class="nx">state</span><span class="p">=</span><span class="nx">RANDOM_STATE</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="nx">í´ë¼ì´ì–¸íŠ¸ê°€</span><span class="w"> </span><span class="nx">ì½”ë“œë¥¼</span><span class="w"> </span><span class="nx">í† í°ìœ¼ë¡œ</span><span class="w"> </span><span class="nx">êµí™˜</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Client</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">Auth</span><span class="w"> </span><span class="nx">Server</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">token</span><span class="w">                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="nx">grant_type</span><span class="p">=</span><span class="nx">authorization_code</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">code</span><span class="p">=</span><span class="nx">AUTH_CODE</span><span class="w">                                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">client_id</span><span class="p">=</span><span class="nx">CLIENT_ID</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">client_secret</span><span class="p">=</span><span class="nx">CLIENT_SECRET</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="o">&amp;</span><span class="nx">redirect_uri</span><span class="p">=</span><span class="nx">CALLBACK_URL</span><span class="w">                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="nx">ì¸ì¦</span><span class="w"> </span><span class="nx">ì„œë²„ê°€</span><span class="w"> </span><span class="nx">í† í°</span><span class="w"> </span><span class="nx">ë°˜í™˜</span><span class="w">                                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Auth</span><span class="w"> </span><span class="nx">Server</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">Client</span><span class="w">                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;access_token&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;...&quot;</span><span class="p">,</span><span class="w">                                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="s">&quot;refresh_token&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;...&quot;</span><span class="p">,</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="s">&quot;token_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Bearer&quot;</span><span class="p">,</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="s">&quot;expires_in&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span><span class="w"> </span><span class="p">}</span><span class="w">                                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="nx">í´ë¼ì´ì–¸íŠ¸ê°€</span><span class="w"> </span><span class="nx">ì•¡ì„¸ìŠ¤</span><span class="w"> </span><span class="nx">í† í°</span><span class="w"> </span><span class="nx">ì‚¬ìš©</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Client</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶</span><span class="w"> </span><span class="nx">Resource</span><span class="w"> </span><span class="nx">Server</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="nx">Authorization</span><span class="p">:</span><span class="w"> </span><span class="nx">Bearer</span><span class="w"> </span><span class="nx">ACCESS_TOKEN</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Flaskë¥¼ ì‚¬ìš©í•œ OAuth 2.0 êµ¬í˜„ (ì„œë²„ ì¸¡).</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlencode</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="c1"># OAuth 2.0 êµ¬ì„± (ì˜ˆ: GitHub)</span>
<span class="n">OAUTH_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="s2">&quot;your_client_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;client_secret&quot;</span><span class="p">:</span> <span class="s2">&quot;your_client_secret&quot;</span><span class="p">,</span>
    <span class="s2">&quot;authorize_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://github.com/login/oauth/authorize&quot;</span><span class="p">,</span>
    <span class="s2">&quot;token_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://github.com/login/oauth/access_token&quot;</span><span class="p">,</span>
    <span class="s2">&quot;api_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.github.com/user&quot;</span><span class="p">,</span>
    <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="s2">&quot;http://localhost:5000/callback&quot;</span><span class="p">,</span>
    <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot;read:user user:email&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OAuth 2.0 Authorization Code íë¦„ ì‹œì‘.&quot;&quot;&quot;</span>
    <span class="c1"># CSRFë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•œ state ë§¤ê°œë³€ìˆ˜ ìƒì„±</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;oauth_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>

    <span class="c1"># ì¸ê°€ URL êµ¬ì¶•</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">],</span>
        <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;redirect_uri&quot;</span><span class="p">],</span>
        <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">],</span>
        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
        <span class="s2">&quot;response_type&quot;</span><span class="p">:</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">auth_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s1">&#39;authorize_url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">auth_url</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/callback&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OAuth 2.0 ì½œë°± ì²˜ë¦¬.&quot;&quot;&quot;</span>
    <span class="c1"># â”€â”€ state ë§¤ê°œë³€ìˆ˜ í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;oauth_state&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;ìœ íš¨í•˜ì§€ ì•Šì€ state ë§¤ê°œë³€ìˆ˜&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># â”€â”€ ì˜¤ë¥˜ ì‘ë‹µ í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error_description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># â”€â”€ ì¸ê°€ ì½”ë“œë¥¼ í† í°ìœ¼ë¡œ êµí™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span>
    <span class="n">token_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;token_url&quot;</span><span class="p">],</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;client_secret&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;client_secret&quot;</span><span class="p">],</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
            <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;redirect_uri&quot;</span><span class="p">],</span>
            <span class="s2">&quot;grant_type&quot;</span><span class="p">:</span> <span class="s2">&quot;authorization_code&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">token_data</span> <span class="o">=</span> <span class="n">token_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">token_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">token_data</span><span class="p">),</span> <span class="mi">400</span>

    <span class="n">access_token</span> <span class="o">=</span> <span class="n">token_data</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>

    <span class="c1"># â”€â”€ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
    <span class="n">user_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">OAUTH_CONFIG</span><span class="p">[</span><span class="s2">&quot;api_url&quot;</span><span class="p">],</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">user_data</span> <span class="o">=</span> <span class="n">user_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="c1"># ì„¸ì…˜ì— ì €ì¥ (ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚¬ìš©ì ìƒì„±/ì—…ë°ì´íŠ¸)</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/dashboard&#39;</span><span class="p">)</span>


<span class="c1"># â”€â”€ OAuth 2.0 ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">1. í•­ìƒ state ë§¤ê°œë³€ìˆ˜ ì‚¬ìš© (CSRF ë°©ì§€)</span>
<span class="sd">2. redirect_urië¥¼ ì •í™•íˆ ê²€ì¦ (ì˜¤í”ˆ ë¦¬ë””ë ‰íŠ¸ ë°©ì§€)</span>
<span class="sd">3. ì„œë²„ ì•±ì— Authorization Code íë¦„ ì‚¬ìš© (Implicit ì•„ë‹˜)</span>
<span class="sd">4. í† í°ì„ ì•ˆì „í•˜ê²Œ ì €ì¥ (ì•”í˜¸í™”, ì„œë²„ ì¸¡)</span>
<span class="sd">5. ê³µê°œ í´ë¼ì´ì–¸íŠ¸(SPA, ëª¨ë°”ì¼ ì•±)ì— PKCE ì‚¬ìš©</span>
<span class="sd">6. ëª¨ë“  ìš”ì²­ì—ì„œ í† í° ë²”ìœ„ ê²€ì¦</span>
<span class="sd">7. ë‹¨ê¸° ì•¡ì„¸ìŠ¤ í† í° + ë¦¬í”„ë ˆì‹œ í† í° ì‚¬ìš©</span>
<span class="sd">8. ë¡œê·¸ì•„ì›ƒ ì‹œ í† í° íê¸°</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>

<h3 id="23-jwt-json-web-tokens">2.3 JWT (JSON Web Tokens)<a class="header-link" href="#23-jwt-json-web-tokens" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="n">JWT</span><span class="w"> </span><span class="err">êµ¬ì¡°</span><span class="w">                                          </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">eyJhbGci</span><span class="o">...</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">eyJzdWIi</span><span class="o">...</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">SflKxwRJ</span><span class="o">...</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">     </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">     </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="n">Header</span><span class="w">        </span><span class="n">Payload</span><span class="w">       </span><span class="n">Signature</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Header</span><span class="w"> </span><span class="p">(</span><span class="n">base64url</span><span class="p">):</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">{</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;RS256&quot;</span><span class="p">,</span><span class="w">                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT&quot;</span><span class="p">,</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;kid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;key-id-123&quot;</span><span class="w">                                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">}</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Payload</span><span class="w"> </span><span class="p">(</span><span class="n">base64url</span><span class="p">):</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">{</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user_123&quot;</span><span class="p">,</span><span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Subject</span><span class="w"> </span><span class="p">(</span><span class="err">ì‚¬ìš©ì</span><span class="w"> </span><span class="n">ID</span><span class="p">)</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;api.example.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Issuer</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;app.example.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Audience</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1700000000</span><span class="p">,</span><span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="err">ë§Œë£Œ</span><span class="w"> </span><span class="err">ì‹œê°„</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1699996400</span><span class="p">,</span><span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="err">ë°œê¸‰</span><span class="w"> </span><span class="err">ì‹œê°„</span><span class="w">                            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;nbf&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1699996400</span><span class="p">,</span><span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Not</span><span class="w"> </span><span class="n">before</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;unique-token-id&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">JWT</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="p">(</span><span class="err">íê¸°ìš©</span><span class="p">)</span><span class="w">                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;scope&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;read write&quot;</span><span class="p">,</span><span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="err">ì‚¬ìš©ì</span><span class="w"> </span><span class="err">ì •ì˜</span><span class="w"> </span><span class="err">í´ë ˆì„</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;admin&quot;</span><span class="w">                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">}</span><span class="w">                                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Signature</span><span class="p">:</span><span class="w">                                                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">RSASHA256</span><span class="p">(</span><span class="n">base64url</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;.&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">base64url</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">ì¤‘ìš”</span><span class="p">:</span><span class="w"> </span><span class="n">PayloadëŠ”</span><span class="w"> </span><span class="err">ì•”í˜¸í™”ë˜ì§€</span><span class="w"> </span><span class="err">ì•ŠìŒ</span><span class="w"> </span><span class="err">â€”</span><span class="w"> </span><span class="n">base64url</span><span class="w"> </span><span class="err">ì¸ì½”ë”©ë§Œ</span><span class="w"> </span><span class="err">ë¨</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">ëˆ„êµ¬ë‚˜</span><span class="w"> </span><span class="err">ì½ì„</span><span class="w"> </span><span class="err">ìˆ˜</span><span class="w"> </span><span class="err">ìˆìŒ</span><span class="o">.</span><span class="w"> </span><span class="n">JWTì—</span><span class="w"> </span><span class="err">ë¹„ë°€ì„</span><span class="w"> </span><span class="err">ì €ì¥í•˜ì§€</span><span class="w"> </span><span class="err">ë§</span><span class="w"> </span><span class="err">ê²ƒ</span><span class="o">.</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">PyJWTë¥¼ ì‚¬ìš©í•œ JWT ì¸ì¦ â€” ì•ˆì „í•œ êµ¬í˜„.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># â”€â”€ í‚¤ êµ¬ì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># í”„ë¡œë•ì…˜ì—ëŠ” RS256 (ë¹„ëŒ€ì¹­) ì‚¬ìš©</span>
<span class="c1"># ê°œì¸ í‚¤ëŠ” í† í°ì— ì„œëª…; ê³µê°œ í‚¤ëŠ” ê²€ì¦</span>
<span class="c1"># ì´ë¥¼ í†µí•´ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ê°€ ê°œì¸ í‚¤ ì—†ì´ ê²€ì¦ ê°€ëŠ¥</span>

<span class="c1"># ì´ ì˜ˆì œì—ì„œëŠ” ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ HS256 (ëŒ€ì¹­) ì‚¬ìš©</span>
<span class="n">JWT_SECRET</span> <span class="o">=</span> <span class="s2">&quot;your-256-bit-secret-change-this&quot;</span>  <span class="c1"># í”„ë¡œë•ì…˜ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©</span>
<span class="n">JWT_ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
<span class="n">JWT_ACCESS_TOKEN_EXPIRES</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">JWT_REFRESH_TOKEN_EXPIRES</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>


<span class="c1"># â”€â”€ í† í° ë¸”ë™ë¦¬ìŠ¤íŠ¸ (í”„ë¡œë•ì…˜ì—ì„œ Redis ì‚¬ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">revoked_tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                        <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ë‹¨ê¸° ì•¡ì„¸ìŠ¤ í† í° ìƒì„±.&quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="s2">&quot;iss&quot;</span><span class="p">:</span> <span class="s2">&quot;api.example.com&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aud&quot;</span><span class="p">:</span> <span class="s2">&quot;app.example.com&quot;</span><span class="p">,</span>
        <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
        <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">JWT_ACCESS_TOKEN_EXPIRES</span><span class="p">,</span>
        <span class="s2">&quot;nbf&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
        <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>        <span class="c1"># íê¸°ë¥¼ ìœ„í•œ ê³ ìœ  ID</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;access&quot;</span><span class="p">,</span>
        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
        <span class="s2">&quot;scopes&quot;</span><span class="p">:</span> <span class="n">scopes</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">JWT_SECRET</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">JWT_ALGORITHM</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_refresh_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì¥ê¸° ë¦¬í”„ë ˆì‹œ í† í° ìƒì„±.&quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="s2">&quot;iss&quot;</span><span class="p">:</span> <span class="s2">&quot;api.example.com&quot;</span><span class="p">,</span>
        <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
        <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">JWT_REFRESH_TOKEN_EXPIRES</span><span class="p">,</span>
        <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;refresh&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">JWT_SECRET</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">JWT_ALGORITHM</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">decode_token</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;JWT í† í° ë””ì½”ë“œ ë° ê²€ì¦.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="n">token</span><span class="p">,</span>
            <span class="n">JWT_SECRET</span><span class="p">,</span>
            <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">JWT_ALGORITHM</span><span class="p">],</span>
            <span class="n">issuer</span><span class="o">=</span><span class="s2">&quot;api.example.com&quot;</span><span class="p">,</span>
            <span class="n">audience</span><span class="o">=</span><span class="s2">&quot;app.example.com&quot;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;require&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="s2">&quot;iat&quot;</span><span class="p">,</span> <span class="s2">&quot;sub&quot;</span><span class="p">,</span> <span class="s2">&quot;iss&quot;</span><span class="p">,</span> <span class="s2">&quot;aud&quot;</span><span class="p">,</span> <span class="s2">&quot;jti&quot;</span><span class="p">],</span>
                <span class="s2">&quot;verify_exp&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;verify_iss&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;verify_aud&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;verify_nbf&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># í† í°ì´ íê¸°ë˜ì—ˆëŠ”ì§€ í™•ì¸</span>
        <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;jti&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">revoked_tokens</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">(</span><span class="s2">&quot;í† í°ì´ íê¸°ë˜ì—ˆìŠµë‹ˆë‹¤&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">payload</span>

    <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">ExpiredSignatureError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidAudienceError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ìœ íš¨í•˜ì§€ ì•Šì€ í† í° ëŒ€ìƒ&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidIssuerError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ìœ íš¨í•˜ì§€ ì•Šì€ í† í° ë°œê¸‰ì&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ìœ íš¨í•˜ì§€ ì•Šì€ í† í°: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_auth</span><span class="p">(</span><span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì„ íƒì  ë²”ìœ„ í™•ì¸ê³¼ í•¨ê»˜ JWT ì¸ì¦ì„ ìš”êµ¬í•˜ëŠ” ë°ì½”ë ˆì´í„°.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Authorization í—¤ë”ì—ì„œ í† í° ì¶”ì¶œ</span>
            <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;missing_token&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer í† í°ì´ ìˆëŠ” Authorization í—¤ë” í•„ìš”&quot;</span>
                <span class="p">}),</span> <span class="mi">401</span>

            <span class="n">token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid_token&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">}),</span> <span class="mi">401</span>

            <span class="c1"># í† í° ìœ í˜• í™•ì¸</span>
            <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;access&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;wrong_token_type&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;ì•¡ì„¸ìŠ¤ í† í° í•„ìš”&quot;</span>
                <span class="p">}),</span> <span class="mi">401</span>

            <span class="c1"># ë²”ìœ„ í™•ì¸</span>
            <span class="k">if</span> <span class="n">scopes</span><span class="p">:</span>
                <span class="n">token_scopes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scopes&quot;</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="n">required_scopes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">scopes</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">required_scopes</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">token_scopes</span><span class="p">):</span>
                    <span class="n">missing</span> <span class="o">=</span> <span class="n">required_scopes</span> <span class="o">-</span> <span class="n">token_scopes</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;insufficient_scope&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;ëˆ„ë½ëœ ë²”ìœ„: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">}),</span> <span class="mi">403</span>

            <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">payload</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="c1"># â”€â”€ ë¼ìš°íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì¸ì¦í•˜ê³  JWT í† í° ë°˜í™˜.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>

    <span class="c1"># ìê²© ì¦ëª… ê²€ì¦ (bcrypt/argon2 í•´ì‹œ ë¹„êµ ì‚¬ìš©)</span>
    <span class="c1"># ë‹¨ìˆœí™”ë¨ â€” ìì„¸í•œ ë‚´ìš©ì€ ì¸ì¦ ë ˆìŠ¨ ì°¸ì¡°</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="c1"># ì‚¬ìš©ì ì—´ê±° ë°©ì§€ë¥¼ ìœ„í•œ ì¼ê´€ëœ íƒ€ì´ë° ì‚¬ìš©</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid_credentials&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;ìœ íš¨í•˜ì§€ ì•Šì€ ì‚¬ìš©ì ì´ë¦„ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸&quot;</span>
        <span class="p">}),</span> <span class="mi">401</span>

    <span class="c1"># í† í° ìŒ ìƒì„±</span>
    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">role</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">],</span>
        <span class="n">scopes</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">create_refresh_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
        <span class="s2">&quot;refresh_token&quot;</span><span class="p">:</span> <span class="n">refresh_token</span><span class="p">,</span>
        <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;expires_in&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">JWT_ACCESS_TOKEN_EXPIRES</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()),</span>
    <span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/refresh&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">refresh</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ë¦¬í”„ë ˆì‹œ í† í°ì„ ìƒˆ ì•¡ì„¸ìŠ¤ í† í°ìœ¼ë¡œ êµí™˜.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refresh_token&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh_token</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;missing_refresh_token&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># ëŒ€ìƒ í™•ì¸ ì—†ì´ ë””ì½”ë“œ (ë¦¬í”„ë ˆì‹œ í† í°ì€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="n">refresh_token</span><span class="p">,</span>
            <span class="n">JWT_SECRET</span><span class="p">,</span>
            <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">JWT_ALGORITHM</span><span class="p">],</span>
            <span class="n">issuer</span><span class="o">=</span><span class="s2">&quot;api.example.com&quot;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;require&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="s2">&quot;sub&quot;</span><span class="p">,</span> <span class="s2">&quot;jti&quot;</span><span class="p">,</span> <span class="s2">&quot;iss&quot;</span><span class="p">]}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;refresh&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ë¦¬í”„ë ˆì‹œ í† í°ì´ ì•„ë‹˜&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;jti&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">revoked_tokens</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ë¦¬í”„ë ˆì‹œ í† í°ì´ íê¸°ë˜ì—ˆìŠµë‹ˆë‹¤&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid_refresh_token&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">401</span>

    <span class="c1"># ì˜¤ë˜ëœ ë¦¬í”„ë ˆì‹œ í† í° íê¸° (ìˆœí™˜)</span>
    <span class="n">revoked_tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;jti&quot;</span><span class="p">])</span>

    <span class="c1"># ìƒˆ í† í° ìŒ ë°œê¸‰</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">]</span>
    <span class="c1"># ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í˜„ì¬ ì‚¬ìš©ì ì—­í• /ë²”ìœ„ ì¡°íšŒ</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="n">new_access</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">role</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">],</span>
        <span class="n">scopes</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">new_refresh</span> <span class="o">=</span> <span class="n">create_refresh_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">new_access</span><span class="p">,</span>
        <span class="s2">&quot;refresh_token&quot;</span><span class="p">:</span> <span class="n">new_refresh</span><span class="p">,</span>
        <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;expires_in&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">JWT_ACCESS_TOKEN_EXPIRES</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()),</span>
    <span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/logout&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_auth</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;í˜„ì¬ ì•¡ì„¸ìŠ¤ í† í° íê¸°.&quot;&quot;&quot;</span>
    <span class="n">revoked_tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;jti&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;ì„±ê³µì ìœ¼ë¡œ ë¡œê·¸ì•„ì›ƒí–ˆìŠµë‹ˆë‹¤&quot;</span><span class="p">}),</span> <span class="mi">200</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/protected&#39;</span><span class="p">)</span>
<span class="nd">@require_auth</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">protected_resource</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&#39;read&#39; ë²”ìœ„ê°€ í•„ìš”í•œ ë³´í˜¸ëœ ì—”ë“œí¬ì¸íŠ¸.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">],</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;ì´ ë³´í˜¸ëœ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤&quot;</span>
    <span class="p">})</span>


<span class="c1"># ì™„ì „ì„±ì„ ìœ„í•œ í”Œë ˆì´ìŠ¤í™€ë” í•¨ìˆ˜</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;í”Œë ˆì´ìŠ¤í™€ë” â€” ì ì ˆí•œ ë¹„ë°€ë²ˆí˜¸ í•´ì‹±ìœ¼ë¡œ êµ¬í˜„.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_user_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;í”Œë ˆì´ìŠ¤í™€ë” â€” ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒë¡œ êµ¬í˜„.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;scopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">]}</span>
</code></pre></div>

<h3 id="24-jwt">2.4 JWT ë³´ì•ˆ ëª¨ë²” ì‚¬ë¡€<a class="header-link" href="#24-jwt" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">JWT ë³´ì•ˆ ëª¨ë²” ì‚¬ë¡€ ë° ì¼ë°˜ì ì¸ í•¨ì •.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># â”€â”€ í•¨ì • 1: &#39;none&#39; ì•Œê³ ë¦¬ì¦˜ ì‚¬ìš© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># ê³µê²©: í—¤ë”ë¥¼ {&quot;alg&quot;: &quot;none&quot;}ìœ¼ë¡œ ë³€ê²½í•˜ê³  ì„œëª… ì œê±°</span>
<span class="c1"># ë°©ì–´: í•­ìƒ í—ˆìš©ëœ ì•Œê³ ë¦¬ì¦˜ì„ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
    <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RS256&quot;</span><span class="p">],</span>  <span class="c1"># &quot;none&quot;ì„ ì ˆëŒ€ í¬í•¨í•˜ê±°ë‚˜ ëª¨ë‘ í—ˆìš©í•˜ì§€ ë§ ê²ƒ</span>
<span class="p">)</span>

<span class="c1"># â”€â”€ í•¨ì • 2: HS256ê³¼ RS256 í˜¼ë™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># ê³µê²©: ì„œë²„ê°€ RS256ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, ê³µê²©ìê°€:</span>
<span class="c1">#   1. ê³µê°œ í‚¤ ê°€ì ¸ì˜¤ê¸° (ê³µê°œì„)</span>
<span class="c1">#   2. ê³µê°œ í‚¤ë¥¼ ë¹„ë°€ë¡œ ì‚¬ìš©í•˜ì—¬ HS256ìœ¼ë¡œ ìƒˆ í† í° ì„œëª…</span>
<span class="c1">#   3. ì„œë²„ê°€ ê³µê°œ í‚¤ë¥¼ HMAC ë¹„ë°€ë¡œ ì·¨ê¸‰</span>
<span class="c1"># ë°©ì–´: í—¤ë”ì˜ ì•Œê³ ë¦¬ì¦˜ì„ ì—„ê²©í•˜ê²Œ ê²€ì¦</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">rsa_public_key</span><span class="p">,</span>
    <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RS256&quot;</span><span class="p">],</span>  <span class="c1"># ì˜ˆìƒëœ ì•Œê³ ë¦¬ì¦˜ë§Œ í—ˆìš©</span>
<span class="p">)</span>

<span class="c1"># â”€â”€ í•¨ì • 3: ë§Œë£Œ ëˆ„ë½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># exp í´ë ˆì„ì´ ì—†ëŠ” í† í°ì€ ì˜ì›íˆ ìœ íš¨</span>
<span class="c1"># ë°©ì–´: í•­ìƒ ì§§ì€ ë§Œë£Œ ì„¤ì •</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="s2">&quot;user_123&quot;</span><span class="p">,</span>
    <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1"># â”€â”€ í•¨ì • 4: í˜ì´ë¡œë“œì— ë¯¼ê°í•œ ë°ì´í„° ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># JWT í˜ì´ë¡œë“œëŠ” base64url ì¸ì½”ë”©ë˜ë©° ì•”í˜¸í™”ë˜ì§€ ì•ŠìŒ</span>
<span class="c1"># í‚¤ ì—†ì´ë„ ëˆ„êµ¬ë‚˜ ë””ì½”ë“œ ê°€ëŠ¥</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="n">header</span><span class="p">,</span> <span class="n">payload_b64</span><span class="p">,</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">decoded</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">payload_b64</span> <span class="o">+</span> <span class="s1">&#39;==&#39;</span><span class="p">)</span>
<span class="c1"># ì „ì²´ í˜ì´ë¡œë“œë¥¼ ì´ì œ ì½ì„ ìˆ˜ ìˆìŒ!</span>

<span class="c1"># ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ ê²ƒ: ë¹„ë°€ë²ˆí˜¸, SSN, ì‹ ìš©ì¹´ë“œ, PIIë¥¼ JWTì—</span>
<span class="c1"># í¬í•¨í•  ê²ƒë§Œ: ì‚¬ìš©ì ID, ì—­í• , ë²”ìœ„, ë§Œë£Œ</span>

<span class="c1"># â”€â”€ í•¨ì • 5: í† í° íê¸° ë©”ì»¤ë‹ˆì¦˜ ì—†ìŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># JWTëŠ” ìì²´ í¬í•¨ â€” ì„œë²„ê°€ ë¬´íš¨í™”í•  ìˆ˜ ì—†ìŒ</span>
<span class="c1"># í•´ê²°ì±…:</span>
<span class="c1"># 1. ë‹¨ê¸° ì•¡ì„¸ìŠ¤ í† í° (15ë¶„) + ë¦¬í”„ë ˆì‹œ í† í° ìˆœí™˜</span>
<span class="c1"># 2. í† í° ë¸”ë™ë¦¬ìŠ¤íŠ¸ (TTL = í† í° expê°€ ìˆëŠ” Redis)</span>
<span class="c1"># 3. í† í° ë²„ì „ ê´€ë¦¬ (DBì— í† í° ë²„ì „ ì €ì¥, ê° ìš”ì²­ì—ì„œ í™•ì¸)</span>
<span class="c1"># 4. ì„œëª… í‚¤ ë³€ê²½ (ëª¨ë“  í† í° ë¬´íš¨í™” â€” ê·¹ë‹¨ì  ì˜µì…˜)</span>

<span class="c1"># â”€â”€ RS256 ì„¤ì • (í”„ë¡œë•ì…˜ ê¶Œì¥) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># RSA í‚¤ ìŒ ìƒì„±</span>
<span class="sd">openssl genrsa -out private.pem 2048</span>
<span class="sd">openssl rsa -in private.pem -pubout -out public.pem</span>

<span class="sd"># ê°œì¸ í‚¤: ì¸ì¦ ì„œë²„ê°€ í† í°ì— ì„œëª…í•˜ëŠ” ë° ì‚¬ìš©</span>
<span class="sd"># ê³µê°œ í‚¤: ëª¨ë“  ì„œë¹„ìŠ¤ê°€ í† í°ì„ ê²€ì¦í•˜ëŠ” ë° ì‚¬ìš©</span>
<span class="sd"># ê³µê°œ í‚¤ë¥¼ ììœ ë¡­ê²Œ ê³µìœ ; ê°œì¸ í‚¤ ë³´í˜¸</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">serialization</span>

<span class="c1"># í‚¤ ë¡œë“œ</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;private.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">private_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;public.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">public_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_public_key</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="c1"># ê°œì¸ í‚¤ë¡œ ì„œëª…</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;RS256&quot;</span><span class="p">)</span>

<span class="c1"># ê³µê°œ í‚¤ë¡œ ê²€ì¦ (ëª¨ë“  ì„œë¹„ìŠ¤ê°€ í•  ìˆ˜ ìˆìŒ)</span>
<span class="n">decoded</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">public_key</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RS256&quot;</span><span class="p">])</span>
</code></pre></div>

<hr />
<h2 id="3">3. ì†ë„ ì œí•œ<a class="header-link" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 ì†ë„ ì œí•œ ì•Œê³ ë¦¬ì¦˜<a class="header-link" href="#31" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ì†ë„ ì œí•œ ì•Œê³ ë¦¬ì¦˜                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  1. ê³ ì • ìœˆë„ìš°                                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚     â”‚ Window 1 â”‚â”‚ Window 2 â”‚â”‚ Window 3 â”‚                            â”‚
â”‚     â”‚ â– â– â– â– â–     â”‚â”‚ â– â– â–       â”‚â”‚ â– â– â– â– â– â– â–   â”‚                           â”‚
â”‚     â”‚ 5/10     â”‚â”‚ 3/10     â”‚â”‚ 7/10     â”‚  (ì œí•œ: ìœˆë„ìš°ë‹¹ 10)      â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚     ì¥ì : ê°„ë‹¨.  ë‹¨ì : ìœˆë„ìš° ê²½ê³„ì—ì„œ ë²„ìŠ¤íŠ¸ (2ë°° ì œí•œ)             â”‚
â”‚                                                                      â”‚
â”‚  2. ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ë¡œê·¸                                             â”‚
â”‚     Time: â”€â”€â”€â”€â”€â”€â”€â”€â”€[====í˜„ì¬ ìœˆë„ìš°====]â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚     ê° ìš”ì²­ì˜ ì •í™•í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ì                                  â”‚
â”‚     ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ë‚´ ìš”ì²­ ì¹´ìš´íŠ¸                                   â”‚
â”‚     ì¥ì : ì •í™•.  ë‹¨ì : ë©”ëª¨ë¦¬ ì§‘ì•½ì  (ëª¨ë“  íƒ€ì„ìŠ¤íƒ¬í”„ ì €ì¥)          â”‚
â”‚                                                                      â”‚
â”‚  3. ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ì¹´ìš´í„°                                           â”‚
â”‚     ê³ ì • ìœˆë„ìš° ì¹´ìš´íŠ¸ë¥¼ ê°€ì¤‘ì¹˜ ì˜¤ë²„ë©ê³¼ ê²°í•©                        â”‚
â”‚     weight = (window_size - elapsed) / window_size                   â”‚
â”‚     count = prev_count * weight + current_count                      â”‚
â”‚     ì¥ì : ë©”ëª¨ë¦¬ íš¨ìœ¨ì .  ë‹¨ì : ê·¼ì‚¬ì¹˜                               â”‚
â”‚                                                                      â”‚
â”‚  4. í† í° ë²„í‚·                                                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚     â”‚ â— â— â— â— â”‚ â† ë²„í‚· (ìš©ëŸ‰: 10 í† í°)                             â”‚
â”‚     â”‚ â— â— â—   â”‚                                                     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚         â†‘                                                            â”‚
â”‚     ë¦¬í•„: ì´ˆë‹¹ 1 í† í°                                                â”‚
â”‚     ê° ìš”ì²­ì€ 1 í† í° ì†Œë¹„                                            â”‚
â”‚     ì¥ì : ë²„ìŠ¤íŠ¸ í—ˆìš©.  ë‹¨ì : ê´€ë¦¬í•  ìƒíƒœê°€ ë” ë§ìŒ                  â”‚
â”‚                                                                      â”‚
â”‚  5. ë¦¬í‚¤ ë²„í‚·                                                        â”‚
â”‚     ìš”ì²­ì´ í(ë²„í‚·)ì— ë“¤ì–´ê°                                         â”‚
â”‚     ê³ ì • ì†ë„ë¡œ ì²˜ë¦¬ (ëˆ„ì¶œ ì†ë„)                                     â”‚
â”‚     ì˜¤ë²„í”Œë¡œëŠ” ê±°ë¶€ë¨                                                â”‚
â”‚     ì¥ì : ë¶€ë“œëŸ¬ìš´ ì¶œë ¥ ì†ë„.  ë‹¨ì : ìš©ëŸ‰ì´ ìˆì–´ë„ ì§€ì—°              â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="32-flask-limiter-flask">3.2 Flask-Limiterë¥¼ ì‚¬ìš©í•œ Flask ì†ë„ ì œí•œ<a class="header-link" href="#32-flask-limiter-flask" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Flask-Limiterë¥¼ ì‚¬ìš©í•œ ì†ë„ ì œí•œ êµ¬í˜„.</span>
<span class="sd">pip install Flask-Limiter</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_limiter</span><span class="w"> </span><span class="kn">import</span> <span class="n">Limiter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_limiter.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_remote_address</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># â”€â”€ ê¸°ë³¸ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">limiter</span> <span class="o">=</span> <span class="n">Limiter</span><span class="p">(</span>
    <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span>
    <span class="n">key_func</span><span class="o">=</span><span class="n">get_remote_address</span><span class="p">,</span>       <span class="c1"># IP ì£¼ì†Œë¡œ ì†ë„ ì œí•œ</span>
    <span class="n">default_limits</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;200 per day&quot;</span><span class="p">,</span> <span class="s2">&quot;50 per hour&quot;</span><span class="p">],</span>
    <span class="n">storage_uri</span><span class="o">=</span><span class="s2">&quot;redis://localhost:6379&quot;</span><span class="p">,</span>  <span class="c1"># ë¶„ì‚°ìš© Redis ì‚¬ìš©</span>
    <span class="c1"># storage_uri=&quot;memory://&quot;,           # ê°œë°œìš© ì¸ë©”ëª¨ë¦¬</span>
    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;fixed-window-elastic-expiry&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="c1"># â”€â”€ ì „ì—­ ì†ë„ ì œí•œ (ëª¨ë“  ë¼ìš°íŠ¸ì— ì ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># ìœ„ default_limitsë¥¼ í†µí•´ ì´ë¯¸ ì„¤ì •ë¨</span>

<span class="c1"># â”€â”€ ë¼ìš°íŠ¸ë³„ ì†ë„ ì œí•œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/search&#39;</span><span class="p">)</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="s2">&quot;10 per minute&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ê²€ìƒ‰ ì—”ë“œí¬ì¸íŠ¸ â€” ìŠ¤í¬ë˜í•‘ ë°©ì§€ë¥¼ ìœ„í•œ ì—„ê²©í•œ ì œí•œ.&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[]})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="s2">&quot;5 per minute&quot;</span><span class="p">)</span>         <span class="c1"># ë¬´ì°¨ë³„ ëŒ€ì… ë°©ì§€</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ê³µê²©ì ì¸ ì†ë„ ì œí•œì´ ìˆëŠ” ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;login&quot;</span><span class="p">})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/data&#39;</span><span class="p">)</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="s2">&quot;100 per hour&quot;</span><span class="p">)</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="s2">&quot;10 per minute&quot;</span><span class="p">)</span>        <span class="c1"># ì—¬ëŸ¬ ì œí•œ</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ê³„ì¸µí™”ëœ ì†ë„ ì œí•œì´ ìˆëŠ” ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[]})</span>


<span class="c1"># â”€â”€ API í‚¤ í‹°ì–´ì— ë”°ë¥¸ ë™ì  ì†ë„ ì œí•œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_rate_limit_by_tier</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;í´ë¼ì´ì–¸íŠ¸ì˜ API í‹°ì–´ì— ë”°ë¼ ì†ë„ ì œí•œ ë¬¸ìì—´ ë°˜í™˜.&quot;&quot;&quot;</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-API-Key&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í‹°ì–´ ì¡°íšŒ (ë‹¨ìˆœí™”ë¨)</span>
    <span class="n">tiers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;free&quot;</span><span class="p">:</span> <span class="s2">&quot;100 per hour&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pro&quot;</span><span class="p">:</span> <span class="s2">&quot;1000 per hour&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enterprise&quot;</span><span class="p">:</span> <span class="s2">&quot;10000 per hour&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">tier</span> <span class="o">=</span> <span class="n">get_tier_for_key</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tier</span><span class="p">,</span> <span class="s2">&quot;50 per hour&quot;</span><span class="p">)</span>  <span class="c1"># ê¸°ë³¸ê°’ì€ free</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/premium&#39;</span><span class="p">)</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">get_rate_limit_by_tier</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">premium_endpoint</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;í‹°ì–´ ê¸°ë°˜ ì†ë„ ì œí•œì´ ìˆëŠ” ì—”ë“œí¬ì¸íŠ¸.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;premium&quot;</span><span class="p">})</span>


<span class="c1"># â”€â”€ ì†ë„ ì œí•œ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Flask-Limiterê°€ ìë™ìœ¼ë¡œ ì´ í—¤ë”ë“¤ì„ ì¶”ê°€:</span>
<span class="c1"># X-RateLimit-Limit: 100</span>
<span class="c1"># X-RateLimit-Remaining: 95</span>
<span class="c1"># X-RateLimit-Reset: 1699999999</span>
<span class="c1"># Retry-After: 60 (ì œí•œ ì´ˆê³¼ ì‹œ)</span>

<span class="c1"># â”€â”€ ì‚¬ìš©ì ì •ì˜ ì˜¤ë¥˜ í•¸ë“¤ëŸ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">429</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ratelimit_handler</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì†ë„ ì œí•œ ì´ˆê³¼ ì‹œ ì‚¬ìš©ì ì •ì˜ ì‘ë‹µ.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;rate_limit_exceeded&quot;</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;ë„ˆë¬´ ë§ì€ ìš”ì²­. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;retry_after&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
    <span class="p">}),</span> <span class="mi">429</span>


<span class="c1"># í”Œë ˆì´ìŠ¤í™€ë”</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_tier_for_key</span><span class="p">(</span><span class="n">api_key</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;free&quot;</span>
</code></pre></div>

<h3 id="33">3.3 ì‚¬ìš©ì ì •ì˜ í† í° ë²„í‚· êµ¬í˜„<a class="header-link" href="#33" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ì²˜ìŒë¶€í„° í† í° ë²„í‚· ì†ë„ ì œí•œê¸° êµ¬í˜„.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TokenBucket</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;í† í° ë²„í‚· ì†ë„ ì œí•œê¸°.</span>

<span class="sd">    Args:</span>
<span class="sd">        capacity: ë²„í‚·ì˜ ìµœëŒ€ í† í° ìˆ˜</span>
<span class="sd">        refill_rate: ì´ˆë‹¹ ì¶”ê°€ë˜ëŠ” í† í°</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">capacity</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">refill_rate</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">tokens</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">last_refill</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lock</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_refill</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_refill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ê²½ê³¼ ì‹œê°„ì— ë”°ë¼ í† í° ì¶”ê°€.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_refill</span>
        <span class="n">new_tokens</span> <span class="o">=</span> <span class="n">elapsed</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">refill_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">+</span> <span class="n">new_tokens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_refill</span> <span class="o">=</span> <span class="n">now</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;í† í° ì†Œë¹„ ì‹œë„. í—ˆìš©ë˜ë©´ True ë°˜í™˜.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_refill</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">&gt;=</span> <span class="n">tokens</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">-=</span> <span class="n">tokens</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">wait_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ìµœì†Œ 1ê°œì˜ í† í°ì„ ì‚¬ìš©í•  ìˆ˜ ìˆì„ ë•Œê¹Œì§€ì˜ ì´ˆ ë°˜í™˜.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_refill</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">refill_rate</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RateLimiterStore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;í´ë¼ì´ì–¸íŠ¸ í‚¤ë³„ ì†ë„ ì œí•œê¸° ê´€ë¦¬.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">refill_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refill_rate</span> <span class="o">=</span> <span class="n">refill_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buckets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TokenBucket</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenBucket</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ì£¼ì–´ì§„ í‚¤ì— ëŒ€í•œ í† í° ë²„í‚· ê°€ì ¸ì˜¤ê¸° ë˜ëŠ” ìƒì„±.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buckets</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buckets</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_buckets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">TokenBucket</span><span class="p">(</span>
                        <span class="n">capacity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span>
                        <span class="n">refill_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refill_rate</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buckets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ì£¼ì–´ì§„ í‚¤ì— ëŒ€í•œ ìš”ì²­ì´ í—ˆìš©ë˜ëŠ”ì§€ í™•ì¸.&quot;&quot;&quot;</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bucket</span><span class="o">.</span><span class="n">consume</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>


<span class="c1"># â”€â”€ Flaskì™€ í•¨ê»˜ ì‚¬ìš© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiterStore</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">refill_rate</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rate_limit</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">refill_rate</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì‚¬ìš©ì ì •ì˜ ì†ë„ ì œí•œ ë°ì½”ë ˆì´í„°.&quot;&quot;&quot;</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">RateLimiterStore</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="n">capacity</span><span class="p">,</span> <span class="n">refill_rate</span><span class="o">=</span><span class="n">refill_rate</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># IP + ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì†ë„ ì œí•œ í‚¤ë¡œ ì‚¬ìš©</span>
            <span class="n">client_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">bucket</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket</span><span class="o">.</span><span class="n">consume</span><span class="p">():</span>
                <span class="n">wait</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">wait_time</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;rate_limit_exceeded&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;retry_after&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">}),</span> <span class="mi">429</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/resource&#39;</span><span class="p">)</span>
<span class="nd">@rate_limit</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">refill_rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># 10 ë²„ìŠ¤íŠ¸, ì´ˆë‹¹ 1 ì§€ì†</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_resource</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;resource&quot;</span><span class="p">})</span>
</code></pre></div>

<hr />
<h2 id="4">4. ì…ë ¥ ê²€ì¦ ë° ì •ì œ<a class="header-link" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 ê²€ì¦ ì•„í‚¤í…ì²˜<a class="header-link" href="#41" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ì…ë ¥ ê²€ì¦ ê³„ì¸µ                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Request â”€â”¬â”€â”€ ê³„ì¸µ 1: ìŠ¤í‚¤ë§ˆ ê²€ì¦                                    â”‚
â”‚           â”‚   (êµ¬ì¡°, íƒ€ì…, í•„ìˆ˜ í•„ë“œ)                                â”‚
â”‚           â”‚                                                          â”‚
â”‚           â”œâ”€â”€ ê³„ì¸µ 2: ë¹„ì¦ˆë‹ˆìŠ¤ ê²€ì¦                                   â”‚
â”‚           â”‚   (ë²”ìœ„, í˜•ì‹, ì¼ê´€ì„±)                                   â”‚
â”‚           â”‚                                                          â”‚
â”‚           â”œâ”€â”€ ê³„ì¸µ 3: ì •ì œ                                            â”‚
â”‚           â”‚   (ê³µë°± ì œê±°, ì •ê·œí™”, ì¸ì½”ë”©)                            â”‚
â”‚           â”‚                                                          â”‚
â”‚           â””â”€â”€ ê³„ì¸µ 4: ë§¤ê°œë³€ìˆ˜í™”ëœ ì‘ì—…                              â”‚
â”‚               (SQL ë§¤ê°œë³€ìˆ˜í™”, í…œí”Œë¦¿ ì´ìŠ¤ì¼€ì´í”„)                    â”‚
â”‚                                                                      â”‚
â”‚  ì›ì¹™: ì¡°ê¸° ê²€ì¦, ë¹ ë¥¸ ì‹¤íŒ¨, í´ë¼ì´ì–¸íŠ¸ ë°ì´í„°ë¥¼ ì ˆëŒ€ ì‹ ë¢°í•˜ì§€ ë§ ê²ƒ. â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="42-marshmallow">4.2 Marshmallowë¥¼ ì‚¬ìš©í•œ ìŠ¤í‚¤ë§ˆ ê²€ì¦<a class="header-link" href="#42-marshmallow" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Marshmallow ìŠ¤í‚¤ë§ˆë¥¼ ì‚¬ìš©í•œ API ì…ë ¥ ê²€ì¦.</span>
<span class="sd">pip install marshmallow</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">marshmallow</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Schema</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">validate</span><span class="p">,</span> <span class="n">validates</span><span class="p">,</span> <span class="n">validates_schema</span><span class="p">,</span>
    <span class="n">ValidationError</span><span class="p">,</span> <span class="n">pre_load</span><span class="p">,</span> <span class="n">RAISE</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># â”€â”€ ìŠ¤í‚¤ë§ˆ ì •ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserCreateSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ìƒˆ ì‚¬ìš©ì ìƒì„±ìš© ìŠ¤í‚¤ë§ˆ.&quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="c1"># ì•Œ ìˆ˜ ì—†ëŠ” í•„ë“œì— ëŒ€í•´ ì˜¤ë¥˜ ë°œìƒ (ëŒ€ëŸ‰ í• ë‹¹ ë°©ì§€)</span>
        <span class="n">unknown</span> <span class="o">=</span> <span class="n">RAISE</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="p">[</span>
            <span class="n">validate</span><span class="o">.</span><span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>
            <span class="n">validate</span><span class="o">.</span><span class="n">Regexp</span><span class="p">(</span>
                <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_]+$&#39;</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="s2">&quot;ì‚¬ìš©ì ì´ë¦„ì€ ë¬¸ì, ìˆ«ì, ë°‘ì¤„ë§Œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤&quot;</span>
            <span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Email</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">load_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># ì§ë ¬í™”ëœ ì¶œë ¥ì— ì ˆëŒ€ í¬í•¨í•˜ì§€ ì•ŠìŒ</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">128</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">150</span><span class="p">),</span>
        <span class="n">load_default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">OneOf</span><span class="p">([</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;moderator&quot;</span><span class="p">]),</span>
        <span class="n">load_default</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="c1"># ì°¸ê³ : &quot;admin&quot;ì€ APIë¥¼ í†µí•´ í—ˆìš©ë˜ì§€ ì•ŠìŒ â€” ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í†µí•´ì„œë§Œ</span>
    <span class="p">)</span>

    <span class="nd">@validates</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_password_complexity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ë¹„ë°€ë²ˆí˜¸ ë³µì¡ì„± ìš”êµ¬ì‚¬í•­ ì ìš©.&quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ìµœì†Œ í•˜ë‚˜ì˜ ëŒ€ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ìµœì†Œ í•˜ë‚˜ì˜ ì†Œë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ìµœì†Œ í•˜ë‚˜ì˜ ìˆ«ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="s1">&#39;!@#$%^&amp;*()_+-=[]</span><span class="si">{}</span><span class="s1">|;:,.&lt;&gt;?&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ìµœì†Œ í•˜ë‚˜ì˜ íŠ¹ìˆ˜ ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

    <span class="nd">@pre_load</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ê²€ì¦ ì „ì— ì…ë ¥ ë°ì´í„° ì •ê·œí™”.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;email&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;username&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SearchQuerySchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ê²€ìƒ‰ ì¿¼ë¦¬ìš© ìŠ¤í‚¤ë§ˆ.&quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">unknown</span> <span class="o">=</span> <span class="n">RAISE</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">200</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1000</span><span class="p">),</span>
        <span class="n">load_default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">per_page</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">100</span><span class="p">),</span>
        <span class="n">load_default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">sort</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">OneOf</span><span class="p">([</span><span class="s2">&quot;relevance&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]),</span>
        <span class="n">load_default</span><span class="o">=</span><span class="s2">&quot;relevance&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">OneOf</span><span class="p">([</span><span class="s2">&quot;asc&quot;</span><span class="p">,</span> <span class="s2">&quot;desc&quot;</span><span class="p">]),</span>
        <span class="n">load_default</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="c1"># â”€â”€ ê²€ì¦ ë°ì½”ë ˆì´í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_input</span><span class="p">(</span><span class="n">schema_class</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ìŠ¤í‚¤ë§ˆì— ëŒ€í•´ ìš”ì²­ ì…ë ¥ì„ ê²€ì¦í•˜ëŠ” ë°ì½”ë ˆì´í„°.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">schema_class</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid_request&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;ìš”ì²­ ë³¸ë¬¸ì€ ìœ íš¨í•œ JSONì´ì–´ì•¼ í•©ë‹ˆë‹¤&quot;</span>
                    <span class="p">}),</span> <span class="mi">400</span>
            <span class="k">elif</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;args&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;form&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ì•Œ ìˆ˜ ì—†ëŠ” ìœ„ì¹˜: </span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">validated</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;validation_error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">err</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span>
                <span class="p">}),</span> <span class="mi">422</span>

            <span class="n">request</span><span class="o">.</span><span class="n">validated_data</span> <span class="o">=</span> <span class="n">validated</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="c1"># â”€â”€ ê²€ì¦ ë°ì½”ë ˆì´í„° ì‚¬ìš© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@validate_input</span><span class="p">(</span><span class="n">UserCreateSchema</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ê²€ì¦ëœ ì…ë ¥ìœ¼ë¡œ ìƒˆ ì‚¬ìš©ì ìƒì„±.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">validated_data</span>
    <span class="c1"># ì´ ì‹œì ì—ì„œ dataëŠ” ìœ íš¨í•¨ì´ ë³´ì¥ë¨</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;ì‚¬ìš©ì ìƒì„±ë¨&quot;</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
    <span class="p">}),</span> <span class="mi">201</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/search&#39;</span><span class="p">)</span>
<span class="nd">@validate_input</span><span class="p">(</span><span class="n">SearchQuerySchema</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;args&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ê²€ì¦ëœ ì¿¼ë¦¬ ë§¤ê°œë³€ìˆ˜ë¡œ ê²€ìƒ‰.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">validated_data</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">],</span>
        <span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;page&quot;</span><span class="p">],</span>
        <span class="s2">&quot;per_page&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;per_page&quot;</span><span class="p">],</span>
    <span class="p">})</span>
</code></pre></div>

<h3 id="43-pydantic">4.3 Pydantic ê²€ì¦ (ëŒ€ì•ˆ)<a class="header-link" href="#43-pydantic" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Pydantic v2ë¥¼ ì‚¬ìš©í•œ API ê²€ì¦.</span>
<span class="sd">pip install pydantic</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">field_validator</span><span class="p">,</span> <span class="n">model_validator</span><span class="p">,</span>
    <span class="n">EmailStr</span><span class="p">,</span> <span class="n">ConfigDict</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserCreate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì‚¬ìš©ì ìƒì„±ìš© Pydantic ëª¨ë¸.&quot;&quot;&quot;</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span>
        <span class="n">str_strip_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">extra</span><span class="o">=</span><span class="s1">&#39;forbid&#39;</span><span class="p">,</span>  <span class="c1"># ì•Œ ìˆ˜ ì—†ëŠ” í•„ë“œ ê±°ë¶€</span>
    <span class="p">)</span>

    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">min_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_]+$&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">age</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^(user|moderator)$&#39;</span><span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_password</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[A-Z]&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ëŒ€ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[a-z]&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ì†Œë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ìˆ«ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[!@#$%^&amp;*()_+\-=\[\]</span><span class="si">{}</span><span class="s1">|;:,.&lt;&gt;?]&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;íŠ¹ìˆ˜ ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_email</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>


<span class="c1"># â”€â”€ Flaskì—ì„œ ì‚¬ìš© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">PydanticValidationError</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">UserCreate</span><span class="p">(</span><span class="o">**</span><span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">())</span>
    <span class="k">except</span> <span class="n">PydanticValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;validation_error&quot;</span><span class="p">,</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">(),</span>
        <span class="p">}),</span> <span class="mi">422</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">}),</span> <span class="mi">201</span>
</code></pre></div>

<hr />
<h2 id="5-cors-cross-origin-resource-sharing">5. CORS (Cross-Origin Resource Sharing)<a class="header-link" href="#5-cors-cross-origin-resource-sharing" title="Permanent link">&para;</a></h2>
<h3 id="51-cors">5.1 CORS ì‘ë™ ë°©ì‹<a class="header-link" href="#51-cors" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CORS íë¦„                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  ê°„ë‹¨í•œ ìš”ì²­ (GET, HEAD, ê°„ë‹¨í•œ í—¤ë”ê°€ ìˆëŠ” POST):                   â”‚
â”‚                                                                      â”‚
â”‚  Browser â”€â”€â”€â”€GET /api/dataâ”€â”€â”€â”€â”€â”€â–¶ Server                            â”‚
â”‚  (origin: https://app.com)                                          â”‚
â”‚                                                                      â”‚
â”‚  Server â”€â”€â”€â”€Responseâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Browser                           â”‚
â”‚  Access-Control-Allow-Origin: https://app.com                        â”‚
â”‚  â”€â”€â”€ ë¸Œë¼ìš°ì €ê°€ ì‘ë‹µ í—ˆìš© âœ“                                         â”‚
â”‚                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚                                                                      â”‚
â”‚  í”„ë¦¬í”Œë¼ì´íŠ¸ ìš”ì²­ (PUT, DELETE, ì‚¬ìš©ì ì •ì˜ í—¤ë”, JSON):            â”‚
â”‚                                                                      â”‚
â”‚  ë‹¨ê³„ 1: ë¸Œë¼ìš°ì €ê°€ OPTIONS í”„ë¦¬í”Œë¼ì´íŠ¸ ì „ì†¡                        â”‚
â”‚  Browser â”€â”€â”€â”€OPTIONS /api/dataâ”€â”€â”€â–¶ Server                            â”‚
â”‚  Origin: https://app.com                                             â”‚
â”‚  Access-Control-Request-Method: PUT                                  â”‚
â”‚  Access-Control-Request-Headers: Content-Type, Authorization         â”‚
â”‚                                                                      â”‚
â”‚  ë‹¨ê³„ 2: ì„œë²„ê°€ í—ˆìš©ëœ ë©”ì„œë“œ/í—¤ë”ë¡œ ì‘ë‹µ                            â”‚
â”‚  Server â”€â”€â”€â”€204 No Contentâ”€â”€â”€â”€â”€â”€â”€â–¶ Browser                           â”‚
â”‚  Access-Control-Allow-Origin: https://app.com                        â”‚
â”‚  Access-Control-Allow-Methods: GET, POST, PUT, DELETE                â”‚
â”‚  Access-Control-Allow-Headers: Content-Type, Authorization           â”‚
â”‚  Access-Control-Max-Age: 86400                                       â”‚
â”‚                                                                      â”‚
â”‚  ë‹¨ê³„ 3: ë¸Œë¼ìš°ì €ê°€ ì‹¤ì œ ìš”ì²­ ì „ì†¡                                   â”‚
â”‚  Browser â”€â”€â”€â”€PUT /api/dataâ”€â”€â”€â”€â”€â”€â”€â–¶ Server                            â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="52-flask-cors">5.2 Flask CORS êµ¬ì„±<a class="header-link" href="#52-flask-cors" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Flaskì—ì„œ CORS êµ¬ì„±.</span>
<span class="sd">pip install flask-cors</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORS</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># â”€â”€ ì˜µì…˜ 1: íŠ¹ì • ì¶œì²˜ í—ˆìš© (ê¶Œì¥) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="p">{</span>
    <span class="sa">r</span><span class="s2">&quot;/api/*&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;origins&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;https://app.example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;https://admin.example.com&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">],</span>
        <span class="s2">&quot;allow_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Authorization&quot;</span><span class="p">],</span>
        <span class="s2">&quot;expose_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;X-Request-Id&quot;</span><span class="p">,</span> <span class="s2">&quot;X-RateLimit-Remaining&quot;</span><span class="p">],</span>
        <span class="s2">&quot;supports_credentials&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;max_age&quot;</span><span class="p">:</span> <span class="mi">86400</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="c1"># â”€â”€ ì˜µì…˜ 2: ë‹¤ë¥¸ ë¼ìš°íŠ¸ì— ëŒ€í•œ ë‹¤ë¥¸ CORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">app2</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># ê³µê°œ API: ëª¨ë“  ì¶œì²˜ í—ˆìš© (ìê²© ì¦ëª… ì—†ìŒ)</span>
<span class="n">CORS</span><span class="p">(</span><span class="n">app2</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="p">{</span>
    <span class="sa">r</span><span class="s2">&quot;/api/public/*&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;origins&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span>
        <span class="s2">&quot;allow_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">],</span>
        <span class="s2">&quot;supports_credentials&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># origin: *ì¸ ê²½ìš° Falseì—¬ì•¼ í•¨</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="c1"># ë¹„ê³µê°œ API: ìê²© ì¦ëª…ì´ ìˆëŠ” íŠ¹ì • ì¶œì²˜</span>
<span class="n">CORS</span><span class="p">(</span><span class="n">app2</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="p">{</span>
    <span class="sa">r</span><span class="s2">&quot;/api/private/*&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;origins&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;https://app.example.com&quot;</span><span class="p">],</span>
        <span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">],</span>
        <span class="s2">&quot;allow_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Authorization&quot;</span><span class="p">],</span>
        <span class="s2">&quot;supports_credentials&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;max_age&quot;</span><span class="p">:</span> <span class="mi">86400</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="c1"># â”€â”€ ì˜µì…˜ 3: ìˆ˜ë™ CORS êµ¬í˜„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">make_response</span>

<span class="n">app3</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">ALLOWED_ORIGINS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;https://app.example.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://admin.example.com&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="nd">@app3</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_cors_headers</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Origin&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">ALLOWED_ORIGINS</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Credentials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;GET, POST, PUT, DELETE, OPTIONS&#39;</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;Content-Type, Authorization, X-Requested-With&#39;</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Expose-Headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;X-Request-Id, X-RateLimit-Remaining&#39;</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Max-Age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;86400&#39;</span>
        <span class="c1"># Vary: Originì€ ìºì‹œì— ì‘ë‹µì´ ì¶œì²˜ì— ë”°ë¼ ë‹¬ë¼ì§„ë‹¤ê³  ì•Œë¦¼</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Vary&#39;</span><span class="p">,</span> <span class="s1">&#39;Origin&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>

<span class="nd">@app3</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/data&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">preflight</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CORS í”„ë¦¬í”Œë¼ì´íŠ¸ ìš”ì²­ ì²˜ë¦¬.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">204</span><span class="p">)</span>


<span class="c1"># â”€â”€ CORS ë³´ì•ˆ ê·œì¹™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">1. ìê²© ì¦ëª…ê³¼ í•¨ê»˜ Access-Control-Allow-Origin: *ë¥¼ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ</span>
<span class="sd">   - ì‹¤ì œë¡œ ë¸Œë¼ìš°ì €ì—ì„œ ì°¨ë‹¨ë¨</span>
<span class="sd">   - ìê²© ì¦ëª…ì´ í•„ìš”í•œ ê²½ìš° íŠ¹ì • ì¶œì²˜ ë‚˜ì—´</span>

<span class="sd">2. í™•ì¸ ì—†ì´ Origin í—¤ë”ë¥¼ Allow-Originìœ¼ë¡œ ì ˆëŒ€ ë°˜ì˜í•˜ì§€ ë§ ê²ƒ</span>
<span class="sd">   - ì´ëŠ” ëª¨ë“  ì¶œì²˜ë¥¼ í—ˆìš©í•˜ëŠ” ê²ƒê³¼ ë™ì¼</span>
<span class="sd">   - ë‚˜ì¨:  response.headers[&#39;ACAO&#39;] = request.headers[&#39;Origin&#39;]</span>
<span class="sd">   - ì¢‹ìŒ: ë¨¼ì € í—ˆìš© ëª©ë¡ì— ëŒ€í•´ í™•ì¸</span>

<span class="sd">3. Access-Control-Allow-Methodsë¥¼ ì‹¤ì œë¡œ í•„ìš”í•œ ê²ƒìœ¼ë¡œ ì œí•œ</span>
<span class="sd">   - ë¼ìš°íŠ¸ê°€ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš° DELETEë¥¼ í—ˆìš©í•˜ì§€ ë§ ê²ƒ</span>

<span class="sd">4. í”„ë¦¬í”Œë¼ì´íŠ¸ ìš”ì²­ì„ ì¤„ì´ê¸° ìœ„í•´ Access-Control-Max-Age ì„¤ì •</span>
<span class="sd">   - 86400 (24ì‹œê°„)ì´ í•©ë¦¬ì </span>

<span class="sd">5. ì‚¬ìš©ì ì •ì˜ í—¤ë”ì— Access-Control-Expose-Headers ì‚¬ìš©</span>
<span class="sd">   - ê¸°ë³¸ì ìœ¼ë¡œ ê°„ë‹¨í•œ í—¤ë”ë§Œ JavaScriptì—ì„œ ì½ì„ ìˆ˜ ìˆìŒ</span>

<span class="sd">6. ACAOê°€ ìš”ì²­ë³„ë¡œ ë³€ê²½ë˜ëŠ” ê²½ìš° í•­ìƒ Vary: Origin ì¶”ê°€</span>
<span class="sd">   - ìºì‹œ í¬ì´ì¦ˆë‹ ë°©ì§€</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>

<hr />
<h2 id="6-graphql">6. GraphQL ë³´ì•ˆ<a class="header-link" href="#6-graphql" title="Permanent link">&para;</a></h2>
<h3 id="61-graphql">6.1 GraphQL íŠ¹ì • ìœ„í˜‘<a class="header-link" href="#61-graphql" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="n">GraphQL</span><span class="w"> </span><span class="err">ë³´ì•ˆ</span><span class="w"> </span><span class="err">ìœ„í˜‘</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="err">ì¿¼ë¦¬</span><span class="w"> </span><span class="err">ê¹Šì´</span><span class="w"> </span><span class="err">ê³µê²©</span><span class="w">                                                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">posts</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">comments</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">posts</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="err">ê¹Šì´</span><span class="w"> </span><span class="err">ì¤‘ì²©</span><span class="w"> </span><span class="err">ì¿¼ë¦¬ê°€</span><span class="w"> </span><span class="err">ê¸°í•˜ê¸‰ìˆ˜ì </span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="err">ë¶€í•˜</span><span class="w"> </span><span class="err">ìœ ë°œ</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="err">ì¿¼ë¦¬</span><span class="w"> </span><span class="err">í­</span><span class="w"> </span><span class="err">ê³µê²©</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">user1</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p">(</span><span class="n">id</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="o">...</span><span class="p">}</span><span class="w"> </span><span class="n">user2</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p">(</span><span class="n">id</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="o">...</span><span class="p">}</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="p">}</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="err">ë§ì€</span><span class="w"> </span><span class="err">ë³„ì¹­ì´</span><span class="w"> </span><span class="err">ì¿¼ë¦¬</span><span class="w"> </span><span class="err">ë¹„ìš©ì„</span><span class="w"> </span><span class="err">ê³±í•¨</span><span class="w">                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="err">ì¸íŠ¸ë¡œìŠ¤í™ì…˜</span><span class="w"> </span><span class="err">ë‚¨ìš©</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">__schema</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="err">ê³µê²©ìì—ê²Œ</span><span class="w"> </span><span class="err">ì „ì²´</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="err">ìŠ¤í‚¤ë§ˆ</span><span class="w"> </span><span class="err">ë…¸ì¶œ</span><span class="w">                              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">4.</span><span class="w"> </span><span class="err">ë°°ì¹˜</span><span class="w"> </span><span class="err">ê³µê²©</span><span class="w">                                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="p">[{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">},</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">1000</span><span class="p">]</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="err">ë‹¨ì¼</span><span class="w"> </span><span class="err">ìš”ì²­ì—</span><span class="w"> </span><span class="err">ì—¬ëŸ¬</span><span class="w"> </span><span class="err">ì¿¼ë¦¬</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">5.</span><span class="w"> </span><span class="err">ë³€ìˆ˜ë¥¼</span><span class="w"> </span><span class="err">í†µí•œ</span><span class="w"> </span><span class="err">ì£¼ì…</span><span class="w">                                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">query</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">String</span><span class="o">!</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">user</span><span class="p">(</span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">variables</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1 OR 1=1&quot;</span><span class="w"> </span><span class="p">}</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">â”€â”€â–¶</span><span class="w"> </span><span class="err">ê²€ì¦ë˜ì§€</span><span class="w"> </span><span class="err">ì•Šì€</span><span class="w"> </span><span class="err">ë³€ìˆ˜ë¥¼</span><span class="w"> </span><span class="err">í†µí•œ</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="err">ì£¼ì…</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">6.</span><span class="w"> </span><span class="err">ì •ë³´</span><span class="w"> </span><span class="err">ë…¸ì¶œ</span><span class="w">                                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">ë‚´ë¶€</span><span class="w"> </span><span class="err">ì„¸ë¶€</span><span class="w"> </span><span class="err">ì •ë³´ë¥¼</span><span class="w"> </span><span class="err">ë“œëŸ¬ë‚´ëŠ”</span><span class="w"> </span><span class="err">ìì„¸í•œ</span><span class="w"> </span><span class="err">ì˜¤ë¥˜</span><span class="w"> </span><span class="err">ë©”ì‹œì§€</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">     </span><span class="err">í•„ë“œ</span><span class="w"> </span><span class="err">ì œì•ˆ</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;secretAdminFieldë¥¼ ì˜ë¯¸í•˜ì…¨ë‚˜ìš”?&quot;</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="62-graphql">6.2 GraphQL ë³´ì•ˆ ì™„í™”<a class="header-link" href="#62-graphql" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">graphene (Python)ì„ ì‚¬ìš©í•œ GraphQL ë³´ì•ˆ ì¡°ì¹˜.</span>
<span class="sd">pip install graphene flask-graphql</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># â”€â”€ 1. ì¿¼ë¦¬ ê¹Šì´ ì œí•œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DepthAnalyzer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;GraphQL ì¿¼ë¦¬ ê¹Šì´ ë¶„ì„ ë° ì œí•œ.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_ast</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ì¿¼ë¦¬ì˜ ìµœëŒ€ ê¹Šì´ ê³„ì‚°.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ì¿¼ë¦¬ ê¹Šì´ </span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s2">ê°€ í—ˆìš©ëœ ìµœëŒ€ê°’(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="si">}</span><span class="s2">)ì„ ì´ˆê³¼í•©ë‹ˆë‹¤&quot;</span>
            <span class="p">)</span>

        <span class="n">max_child_depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">query_ast</span><span class="p">,</span> <span class="s1">&#39;selection_set&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">query_ast</span><span class="o">.</span><span class="n">selection_set</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">selection</span> <span class="ow">in</span> <span class="n">query_ast</span><span class="o">.</span><span class="n">selection_set</span><span class="o">.</span><span class="n">selections</span><span class="p">:</span>
                <span class="n">child_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">max_child_depth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_child_depth</span><span class="p">,</span> <span class="n">child_depth</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">max_child_depth</span>


<span class="c1"># â”€â”€ 2. ì¿¼ë¦¬ ë¹„ìš© ë¶„ì„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="k">class</span><span class="w"> </span><span class="nc">QueryCostAnalyzer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;GraphQL ì¿¼ë¦¬ì˜ ë¹„ìš© ì¶”ì •.&quot;&quot;&quot;</span>

    <span class="c1"># í•„ë“œ ìœ í˜•ë³„ ë¹„ìš© ì •ì˜</span>
    <span class="n">FIELD_COSTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;posts&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>       <span class="c1"># ë¦¬ìŠ¤íŠ¸ í•„ë“œ, ì ì¬ì ìœ¼ë¡œ ë¹„ìŒˆ</span>
        <span class="s2">&quot;comments&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;search&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>     <span class="c1"># ì „ì²´ í…ìŠ¤íŠ¸ ê²€ìƒ‰ì€ ë¹„ìŒˆ</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_cost</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_cost</span> <span class="o">=</span> <span class="n">max_cost</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_ast</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ì˜ˆìƒ ì¿¼ë¦¬ ë¹„ìš© ê³„ì‚°.&quot;&quot;&quot;</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">query_ast</span><span class="p">,</span> <span class="s1">&#39;selection_set&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">query_ast</span><span class="o">.</span><span class="n">selection_set</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">selection</span> <span class="ow">in</span> <span class="n">query_ast</span><span class="o">.</span><span class="n">selection_set</span><span class="o">.</span><span class="n">selections</span><span class="p">:</span>
                <span class="n">field_name</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">value</span>
                <span class="n">field_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELD_COSTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># ë¹„ìš©ì„ ê³±í•˜ëŠ” í˜ì´ì§€ë„¤ì´ì…˜ ì¸ìˆ˜ í™•ì¸</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

                <span class="n">cost</span> <span class="o">=</span> <span class="n">field_cost</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>

                <span class="c1"># ìì‹ ì„ íƒìœ¼ë¡œ ì¬ê·€</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_cost</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">total_cost</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cost</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ì¿¼ë¦¬ ë¹„ìš© </span><span class="si">{</span><span class="n">total_cost</span><span class="si">}</span><span class="s2">ê°€ ìµœëŒ€ê°’(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cost</span><span class="si">}</span><span class="s2">)ì„ ì´ˆê³¼í•©ë‹ˆë‹¤&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">total_cost</span>


<span class="c1"># â”€â”€ 3. í”„ë¡œë•ì…˜ì—ì„œ ì¸íŠ¸ë¡œìŠ¤í™ì…˜ ë¹„í™œì„±í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ì¸íŠ¸ë¡œìŠ¤í™ì…˜ì€ ì „ì²´ API ìŠ¤í‚¤ë§ˆë¥¼ ë“œëŸ¬ëƒ…ë‹ˆë‹¤.</span>
<span class="sd">í”„ë¡œë•ì…˜ì—ì„œëŠ” ë¹„í™œì„±í™”í•˜ì„¸ìš”.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">graphql</span><span class="w"> </span><span class="kn">import</span> <span class="n">GraphQLError</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DisableIntrospection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;í”„ë¡œë•ì…˜ì—ì„œ ì¸íŠ¸ë¡œìŠ¤í™ì…˜ ì¿¼ë¦¬ë¥¼ ë¹„í™œì„±í™”í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">next</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># __schema ë° __type ì¿¼ë¦¬ ì°¨ë‹¨</span>
        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">field_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;__schema&#39;</span><span class="p">,</span> <span class="s1">&#39;__type&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">GraphQLError</span><span class="p">(</span><span class="s2">&quot;ì¸íŠ¸ë¡œìŠ¤í™ì…˜ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="c1"># â”€â”€ 4. ì†ë„ ì œí•œ + ë°°ì¹˜ ì œí•œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">MAX_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># ë°°ì¹˜ ìš”ì²­ë‹¹ ìµœëŒ€ ì¿¼ë¦¬ ìˆ˜</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">limit_batch_queries</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ë°°ì¹˜ ìš”ì²­ì˜ ì¿¼ë¦¬ ìˆ˜ ì œí•œ.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_json</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_BATCH_SIZE</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;batch_limit_exceeded&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;ë°°ì¹˜ë‹¹ ìµœëŒ€ </span><span class="si">{</span><span class="n">MAX_BATCH_SIZE</span><span class="si">}</span><span class="s2">ê°œ ì¿¼ë¦¬&quot;</span>
                <span class="p">}),</span> <span class="mi">400</span>


<span class="c1"># â”€â”€ 5. ì§€ì† ì¿¼ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ì„ì˜ì˜ ì¿¼ë¦¬ë¥¼ ìˆ˜ë½í•˜ëŠ” ëŒ€ì‹ , ì‚¬ì „ ë“±ë¡ëœ</span>
<span class="sd">ì¿¼ë¦¬ í•´ì‹œë§Œ ìˆ˜ë½í•©ë‹ˆë‹¤. ì´ëŠ” ì£¼ì… ë° ì¿¼ë¦¬ ì¡°ì‘ì„ ë°©ì§€í•©ë‹ˆë‹¤.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>

<span class="c1"># ì‚¬ì „ ë“±ë¡ëœ ì¿¼ë¦¬ (ë¹Œë“œ íƒ€ì„ì— ìƒì„±)</span>
<span class="n">PERSISTED_QUERIES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;abc123&quot;</span><span class="p">:</span> <span class="s2">&quot;query { users { id name } }&quot;</span><span class="p">,</span>
    <span class="s2">&quot;def456&quot;</span><span class="p">:</span> <span class="s2">&quot;query GetUser($id: ID!) { user(id: $id) { id name email } }&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/graphql&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">graphql_endpoint</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

    <span class="c1"># í”„ë¡œë•ì…˜ì—ì„œëŠ” ì§€ì† ì¿¼ë¦¬ë§Œ ìˆ˜ë½</span>
    <span class="n">query_hash</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extensions&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;persistedQuery&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sha256Hash&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">query_hash</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">PERSISTED_QUERIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_hash</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;query_not_found&quot;</span><span class="p">}),</span> <span class="mi">404</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># ê°œë°œì—ì„œëŠ” ì„ì˜ì˜ ì¿¼ë¦¬ í—ˆìš©</span>
        <span class="c1"># í”„ë¡œë•ì…˜ì—ì„œëŠ” ê±°ë¶€:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;persisted_queries_only&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;ì§€ì† ì¿¼ë¦¬ë§Œ ìˆ˜ë½ë©ë‹ˆë‹¤&quot;</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># ì¿¼ë¦¬ ì‹¤í–‰...</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}})</span>
</code></pre></div>

<hr />
<h2 id="7-api">7. API ê²Œì´íŠ¸ì›¨ì´ ë³´ì•ˆ<a class="header-link" href="#7-api" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 ê²Œì´íŠ¸ì›¨ì´ ì•„í‚¤í…ì²˜<a class="header-link" href="#71" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API ê²Œì´íŠ¸ì›¨ì´ ë³´ì•ˆ ì•„í‚¤í…ì²˜                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Client                                                              â”‚
â”‚    â”‚                                                                 â”‚
â”‚    â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚              API ê²Œì´íŠ¸ì›¨ì´                      â”‚                 â”‚
â”‚  â”‚                                                 â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚                 â”‚
â”‚  â”‚  â”‚   TLS    â”‚ â”‚   ì¸ì¦   â”‚ â”‚  ì†ë„    â”‚       â”‚                 â”‚
â”‚  â”‚  â”‚  ì¢…ë£Œ    â”‚ â”‚  ê²€ì¦    â”‚ â”‚  ì œí•œ    â”‚       â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                 â”‚
â”‚  â”‚                                                 â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚                 â”‚
â”‚  â”‚  â”‚  ì…ë ¥    â”‚ â”‚  ìš”ì²­    â”‚ â”‚  CORS    â”‚       â”‚                 â”‚
â”‚  â”‚  â”‚  ê²€ì¦    â”‚ â”‚  ë¡œê¹…    â”‚ â”‚  ì²˜ë¦¬    â”‚       â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                 â”‚
â”‚  â”‚                                                 â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚                 â”‚
â”‚  â”‚  â”‚  WAF     â”‚ â”‚ IP í—ˆìš©/ â”‚ â”‚  ì‘ë‹µ    â”‚       â”‚                 â”‚
â”‚  â”‚  â”‚  ê·œì¹™    â”‚ â”‚ ì°¨ë‹¨ ëª©ë¡â”‚ â”‚  í•„í„°ë§  â”‚       â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚           â”‚              â”‚              â”‚                             â”‚
â”‚           â–¼              â–¼              â–¼                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚    â”‚ì„œë¹„ìŠ¤ A  â”‚   â”‚ì„œë¹„ìŠ¤ B  â”‚   â”‚ì„œë¹„ìŠ¤ C  â”‚                       â”‚
â”‚    â”‚(ì‚¬ìš©ì)  â”‚   â”‚(ì£¼ë¬¸)    â”‚   â”‚(ê²€ìƒ‰)    â”‚                       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                      â”‚
â”‚  ì¤‘ì•™ ê²Œì´íŠ¸ì›¨ì´ì˜ ë³´ì•ˆ ì´ì :                                        â”‚
â”‚  â€¢ ì¸ì¦ ì ìš©ì„ ìœ„í•œ ë‹¨ì¼ ì§€ì                                         â”‚
â”‚  â€¢ ì„œë¹„ìŠ¤ ì „ë°˜ì— ê±¸ì¹œ ì¼ê´€ëœ ì†ë„ ì œí•œ                               â”‚
â”‚  â€¢ ì¤‘ì•™ ì§‘ì¤‘ì‹ ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§                                      â”‚
â”‚  â€¢ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ê°€ TLSë¥¼ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ                               â”‚
â”‚  â€¢ ë‹¨ìˆœí™”ëœ ë³´ì•ˆ ì •ì±… ê´€ë¦¬                                           â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="72">7.2 ìš”ì²­/ì‘ë‹µ í•„í„°ë§<a class="header-link" href="#72" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">API ê²Œì´íŠ¸ì›¨ì´ ìš”ì²­/ì‘ë‹µ í•„í„°ë§ ë¯¸ë“¤ì›¨ì–´.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;api_gateway&#39;</span><span class="p">)</span>


<span class="c1"># â”€â”€ ìš”ì²­ ID ì¶”ì  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_request_id</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì¶”ì ì„ ìœ„í•œ ê³ ìœ  ìš”ì²­ ID ì¶”ê°€.&quot;&quot;&quot;</span>
    <span class="n">g</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;X-Request-Id&#39;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">request_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_response_headers</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì‘ë‹µì— ë³´ì•ˆ ë° ì¶”ì  í—¤ë” ì¶”ê°€.&quot;&quot;&quot;</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Request-Id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">request_id</span>
    <span class="c1"># íƒ€ì´ë° ì¶”ê°€</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">g</span><span class="o">.</span><span class="n">request_start</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Response-Time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="c1"># â”€â”€ ìš”ì²­ í¬ê¸° ì œí•œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">MAX_CONTENT_LENGTH</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 1 MB</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MAX_CONTENT_LENGTH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX_CONTENT_LENGTH</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">check_content_length</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ê³¼ë„í•œ í¬ê¸°ì˜ ìš”ì²­ ê±°ë¶€.&quot;&quot;&quot;</span>
    <span class="n">content_length</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">content_length</span>
    <span class="k">if</span> <span class="n">content_length</span> <span class="ow">and</span> <span class="n">content_length</span> <span class="o">&gt;</span> <span class="n">MAX_CONTENT_LENGTH</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;payload_too_large&quot;</span><span class="p">,</span>
            <span class="s2">&quot;max_bytes&quot;</span><span class="p">:</span> <span class="n">MAX_CONTENT_LENGTH</span><span class="p">,</span>
        <span class="p">}),</span> <span class="mi">413</span>


<span class="c1"># â”€â”€ IP í—ˆìš© ëª©ë¡/ì°¨ë‹¨ ëª©ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">BLOCKED_IPS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;192.168.1.100&quot;</span><span class="p">,</span> <span class="s2">&quot;10.0.0.50&quot;</span><span class="p">}</span>
<span class="n">ADMIN_ALLOWED_IPS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;10.0.0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;10.0.0.2&quot;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">check_ip</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ê¸ˆì§€ëœ IPë¡œë¶€í„°ì˜ ìš”ì²­ ì°¨ë‹¨.&quot;&quot;&quot;</span>
    <span class="n">client_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span>

    <span class="k">if</span> <span class="n">client_ip</span> <span class="ow">in</span> <span class="n">BLOCKED_IPS</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ê¸ˆì§€ëœ IPì—ì„œ ìš”ì²­ ì°¨ë‹¨: </span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;forbidden&quot;</span><span class="p">}),</span> <span class="mi">403</span>

    <span class="c1"># ê´€ë¦¬ì ë¼ìš°íŠ¸ëŠ” íŠ¹ì • IP í•„ìš”</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/admin/&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">client_ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ADMIN_ALLOWED_IPS</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;forbidden&quot;</span><span class="p">}),</span> <span class="mi">403</span>


<span class="c1"># â”€â”€ ì‘ë‹µ ë°ì´í„° í•„í„°ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="n">SENSITIVE_FIELDS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;ssn&#39;</span><span class="p">,</span> <span class="s1">&#39;credit_card&#39;</span><span class="p">,</span> <span class="s1">&#39;secret_key&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="s1">&#39;api_key&#39;</span><span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">filter_sensitive_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì‘ë‹µ ë°ì´í„°ì—ì„œ ë¯¼ê°í•œ í•„ë“œë¥¼ ì¬ê·€ì ìœ¼ë¡œ ì œê±°.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">filter_sensitive_data</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SENSITIVE_FIELDS</span>
        <span class="p">}</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">filter_sensitive_data</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="c1"># â”€â”€ ê°ì‚¬ ë¡œê¹… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">audit_log</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ê°ì‚¬ ì¶”ì ì„ ìœ„í•œ ëª¨ë“  API ìš”ì²­ ë¡œê·¸.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;API ìš”ì²­: method=</span><span class="si">%s</span><span class="s2"> path=</span><span class="si">%s</span><span class="s2"> status=</span><span class="si">%s</span><span class="s2"> &quot;</span>
        <span class="s2">&quot;ip=</span><span class="si">%s</span><span class="s2"> user_agent=</span><span class="si">%s</span><span class="s2"> request_id=</span><span class="si">%s</span><span class="s2"> duration=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">user_agent</span><span class="o">.</span><span class="n">string</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span>
        <span class="n">g</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-Response-Time&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<hr />
<h2 id="8-openapi">8. OpenAPI ë³´ì•ˆ ì •ì˜<a class="header-link" href="#8-openapi" title="Permanent link">&para;</a></h2>
<h3 id="81-openapi-30">8.1 OpenAPI 3.0ì˜ ë³´ì•ˆ ìŠ¤í‚´<a class="header-link" href="#81-openapi-30" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># openapi.yaml - ë³´ì•ˆ ìŠ¤í‚´ ì •ì˜</span>
<span class="nt">openapi</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.0.3</span>
<span class="nt">info</span><span class="p">:</span>
<span class="w">  </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secure API</span>
<span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0.0</span>

<span class="c1"># â”€â”€ ë³´ì•ˆ ìŠ¤í‚´ ì •ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nt">components</span><span class="p">:</span>
<span class="w">  </span><span class="nt">securitySchemes</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># API í‚¤ ì¸ì¦</span>
<span class="w">    </span><span class="nt">ApiKeyAuth</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apiKey</span>
<span class="w">      </span><span class="nt">in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">header</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">X-API-Key</span>
<span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ì„œë²„ ê°„ í†µì‹ ì„ ìœ„í•œ API í‚¤</span>

<span class="w">    </span><span class="c1"># JWT Bearer í† í°</span>
<span class="w">    </span><span class="nt">BearerAuth</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="w">      </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bearer</span>
<span class="w">      </span><span class="nt">bearerFormat</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">JWT</span>
<span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">JWT ì•¡ì„¸ìŠ¤ í† í°</span>

<span class="w">    </span><span class="c1"># OAuth 2.0</span>
<span class="w">    </span><span class="nt">OAuth2</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">oauth2</span>
<span class="w">      </span><span class="nt">flows</span><span class="p">:</span>
<span class="w">        </span><span class="nt">authorizationCode</span><span class="p">:</span>
<span class="w">          </span><span class="nt">authorizationUrl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://auth.example.com/authorize</span>
<span class="w">          </span><span class="nt">tokenUrl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://auth.example.com/token</span>
<span class="w">          </span><span class="nt">refreshUrl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://auth.example.com/refresh</span>
<span class="w">          </span><span class="nt">scopes</span><span class="p">:</span>
<span class="w">            </span><span class="nt">read</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ë¦¬ì†ŒìŠ¤ ì½ê¸° ì ‘ê·¼</span>
<span class="w">            </span><span class="nt">write</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ë¦¬ì†ŒìŠ¤ ì“°ê¸° ì ‘ê·¼</span>
<span class="w">            </span><span class="nt">admin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ê´€ë¦¬ ì ‘ê·¼</span>

<span class="w">    </span><span class="c1"># OpenID Connect</span>
<span class="w">    </span><span class="nt">OpenIdConnect</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openIdConnect</span>
<span class="w">      </span><span class="nt">openIdConnectUrl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://auth.example.com/.well-known/openid-configuration</span>

<span class="c1"># â”€â”€ ì „ì—­ ë³´ì•ˆ (ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ì— ì ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nt">security</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">BearerAuth</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>

<span class="c1"># â”€â”€ ì—”ë“œí¬ì¸íŠ¸ë³„ ë³´ì•ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nt">paths</span><span class="p">:</span>
<span class="w">  </span><span class="nt">/api/public/status</span><span class="p">:</span>
<span class="w">    </span><span class="nt">get</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ìƒíƒœ í™•ì¸ (ì¸ì¦ ë¶ˆí•„ìš”)</span>
<span class="w">      </span><span class="nt">security</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w">  </span><span class="c1"># ì¬ì •ì˜: ì¸ì¦ ì—†ìŒ</span>
<span class="w">      </span><span class="nt">responses</span><span class="p">:</span>
<span class="w">        </span><span class="s">&#39;200&#39;</span><span class="p p-Indicator">:</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OK</span>

<span class="w">  </span><span class="nt">/api/users</span><span class="p">:</span>
<span class="w">    </span><span class="nt">get</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ì‚¬ìš©ì ëª©ë¡</span>
<span class="w">      </span><span class="nt">security</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">BearerAuth</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ApiKeyAuth</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w">  </span><span class="c1"># ëŒ€ì•ˆ ì¸ì¦ (OR)</span>
<span class="w">      </span><span class="nt">responses</span><span class="p">:</span>
<span class="w">        </span><span class="s">&#39;200&#39;</span><span class="p p-Indicator">:</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ì‚¬ìš©ì ëª©ë¡</span>

<span class="w">  </span><span class="nt">/api/admin/settings</span><span class="p">:</span>
<span class="w">    </span><span class="nt">put</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ì„¤ì • ì—…ë°ì´íŠ¸ (ê´€ë¦¬ìë§Œ)</span>
<span class="w">      </span><span class="nt">security</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">OAuth2</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">admin</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># &#39;admin&#39; ë²”ìœ„ í•„ìš”</span>
<span class="w">      </span><span class="nt">responses</span><span class="p">:</span>
<span class="w">        </span><span class="s">&#39;200&#39;</span><span class="p p-Indicator">:</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ì„¤ì • ì—…ë°ì´íŠ¸ë¨</span>

<span class="w">  </span><span class="nt">/api/data</span><span class="p">:</span>
<span class="w">    </span><span class="nt">post</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ë°ì´í„° ìƒì„± (read + write í•„ìš”)</span>
<span class="w">      </span><span class="nt">security</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">OAuth2</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">read</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">write</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># ë‘ ë²”ìœ„ ëª¨ë‘ í•„ìš”</span>
<span class="w">      </span><span class="nt">responses</span><span class="p">:</span>
<span class="w">        </span><span class="s">&#39;201&#39;</span><span class="p p-Indicator">:</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ë°ì´í„° ìƒì„±ë¨</span>
</code></pre></div>

<h3 id="82-api">8.2 API ë²„ì „ ê´€ë¦¬ ë³´ì•ˆ<a class="header-link" href="#82-api" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ë³´ì•ˆì„ ìœ„í•œ API ë²„ì „ ê´€ë¦¬ ê³ ë ¤ ì‚¬í•­.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># â”€â”€ URL ê²½ë¡œ ë²„ì „ ê´€ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># /api/v1/users  (êµ¬ë²„ì „, ì•Œë ¤ì§„ ì·¨ì•½ì ì´ ìˆì„ ìˆ˜ ìˆìŒ)</span>
<span class="c1"># /api/v2/users  (í˜„ì¬, íŒ¨ì¹˜ë¨)</span>

<span class="c1"># â”€â”€ í—¤ë” ë²„ì „ ê´€ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># Accept: application/vnd.example.v2+json</span>

<span class="c1"># â”€â”€ ë²„ì „ ê´€ë¦¬ì™€ ê´€ë ¨ëœ ë³´ì•ˆ ë¬¸ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">1. êµ¬ API ë²„ì „ì—ëŠ” ì•Œë ¤ì§„ ì·¨ì•½ì ì´ ìˆì„ ìˆ˜ ìˆìŒ</span>
<span class="sd">   - íê¸° ë‚ ì§œë¥¼ ì„¤ì •í•˜ê³  ì ìš©</span>
<span class="sd">   - Deprecation ë° Sunset í—¤ë” ë°˜í™˜</span>

<span class="sd">2. íê¸°ëœ ë²„ì „ì— ëŒ€í•´ ë³´ì•ˆ íŒ¨ì¹˜ë¥¼ ìœ ì§€í•˜ì§€ ë§ ê²ƒ</span>
<span class="sd">   - ìµœì‹  ë²„ì „ìœ¼ë¡œ ê°•ì œ ë§ˆì´ê·¸ë ˆì´ì…˜</span>

<span class="sd">3. íê¸°ëœ ë²„ì „ì˜ ì‚¬ìš© ëª¨ë‹ˆí„°ë§</span>
<span class="sd">   - êµ¬ë²„ì „ì´ ì—¬ì „íˆ ì‚¬ìš© ì¤‘ì¼ ë•Œ ê²½ê³ </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">API_VERSIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;v1&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;deprecated&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sunset&quot;</span><span class="p">:</span> <span class="s2">&quot;2025-06-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;successor&quot;</span><span class="p">:</span> <span class="s2">&quot;v2&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;v2&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;current&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sunset&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;successor&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">check_api_version</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;íê¸°ëœ API ë²„ì „ ê²½ê³  ë˜ëŠ” ì°¨ë‹¨.&quot;&quot;&quot;</span>
    <span class="c1"># URL ê²½ë¡œì—ì„œ ë²„ì „ ì¶”ì¶œ</span>
    <span class="n">path_parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">path_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;api&#39;</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">path_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">version_info</span> <span class="o">=</span> <span class="n">API_VERSIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">version_info</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid_version&quot;</span><span class="p">,</span>
                <span class="s2">&quot;supported&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">API_VERSIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="p">}),</span> <span class="mi">400</span>

        <span class="k">if</span> <span class="n">version_info</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;deprecated&quot;</span><span class="p">:</span>
            <span class="n">sunset_date</span> <span class="o">=</span> <span class="n">version_info</span><span class="p">[</span><span class="s2">&quot;sunset&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sunset_date</span><span class="p">:</span>
                <span class="c1"># ì¼ëª° ë‚ ì§œê°€ ì§€ë‚¬ëŠ”ì§€ í™•ì¸</span>
                <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">sunset_date</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;version_retired&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;API </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">ì€(ëŠ”) </span><span class="si">{</span><span class="n">sunset_date</span><span class="si">}</span><span class="s2">ì— íê¸°ë˜ì—ˆìŠµë‹ˆë‹¤&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;upgrade_to&quot;</span><span class="p">:</span> <span class="n">version_info</span><span class="p">[</span><span class="s2">&quot;successor&quot;</span><span class="p">],</span>
                    <span class="p">}),</span> <span class="mi">410</span>  <span class="c1"># 410 Gone</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_deprecation_headers</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì‘ë‹µ í—¤ë”ì— íê¸° ê²½ê³  ì¶”ê°€.&quot;&quot;&quot;</span>
    <span class="n">path_parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">path_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;api&#39;</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">path_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">version_info</span> <span class="o">=</span> <span class="n">API_VERSIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="n">version_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;deprecated&quot;</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Deprecation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
            <span class="k">if</span> <span class="n">version_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sunset&quot;</span><span class="p">):</span>
                <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Sunset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version_info</span><span class="p">[</span><span class="s2">&quot;sunset&quot;</span><span class="p">]</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;/api/</span><span class="si">{</span><span class="n">version_info</span><span class="p">[</span><span class="s2">&quot;successor&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&gt;; rel=&quot;successor-version&quot;&#39;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<hr />
<h2 id="9">9. ìš”ì²­/ì‘ë‹µ ì•”í˜¸í™”<a class="header-link" href="#9" title="Permanent link">&para;</a></h2>
<h3 id="91">9.1 ì „ì†¡ ê³„ì¸µ ë³´ì•ˆ<a class="header-link" href="#91" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">TLS êµ¬ì„± ë° ì¸ì¦ì„œ ê³ ì •.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># â”€â”€ TLSë¥¼ ì‚¬ìš©í•œ Flask (ê°œë°œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="c1"># ê°œë°œìš© ìì²´ ì„œëª… ì¸ì¦ì„œ ìƒì„±:</span>
<span class="c1"># openssl req -x509 -newkey rsa:4096 -nodes \</span>
<span class="c1">#   -out cert.pem -keyout key.pem -days 365</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># TLSë¡œ ì‹¤í–‰ (ê°œë°œ ì „ìš©)</span>
<span class="c1"># í”„ë¡œë•ì…˜ì—ì„œëŠ” TLSê°€ ì—­ë°©í–¥ í”„ë¡ì‹œ(nginx, ë¡œë“œ ë°¸ëŸ°ì„œ)ì—ì„œ ì²˜ë¦¬ë¨</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">ssl_context</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;cert.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;key.pem&#39;</span><span class="p">),</span>
        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="mi">443</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># â”€â”€ ì¸ì¦ì„œ ê³ ì • (API í´ë¼ì´ì–¸íŠ¸ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>

<span class="k">def</span><span class="w"> </span><span class="nf">verify_certificate_pin</span><span class="p">(</span><span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expected_pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì„œë²„ ì¸ì¦ì„œê°€ ì˜ˆìƒ í•€ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">host</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssock</span><span class="p">:</span>
            <span class="n">cert_der</span> <span class="o">=</span> <span class="n">ssock</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cert_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">cert_der</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">cert_hash</span> <span class="o">==</span> <span class="n">expected_pin</span>


<span class="c1"># â”€â”€ í˜ì´ë¡œë“œ ìˆ˜ì¤€ ì•”í˜¸í™” (ë¯¼ê°í•œ í•„ë“œìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.fernet</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fernet</span>

<span class="c1"># í‚¤ ìƒì„± (ì½”ë“œê°€ ì•„ë‹Œ ì•ˆì „í•˜ê²Œ ì €ì¥)</span>
<span class="n">encryption_key</span> <span class="o">=</span> <span class="n">Fernet</span><span class="o">.</span><span class="n">generate_key</span><span class="p">()</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">encryption_key</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">encrypt_sensitive_fields</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì‘ë‹µ í˜ì´ë¡œë“œì—ì„œ íŠ¹ì • í•„ë“œ ì•”í˜¸í™”.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span><span class="w"> </span><span class="nf">decrypt_sensitive_fields</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ìš”ì²­ í˜ì´ë¡œë“œì—ì„œ íŠ¹ì • í•„ë“œ ë³µí˜¸í™”.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<hr />
<h2 id="10">10. ì—°ìŠµ ë¬¸ì œ<a class="header-link" href="#10" title="Permanent link">&para;</a></h2>
<h3 id="1-jwt">ì—°ìŠµ 1: ì•ˆì „í•œ JWT ì¸ì¦ ì„œë¹„ìŠ¤<a class="header-link" href="#1-jwt" title="Permanent link">&para;</a></h3>
<p>ë‹¤ìŒì„ í¬í•¨í•˜ëŠ” Flaskë¥¼ ì‚¬ìš©í•œ ì™„ì „í•œ JWT ì¸ì¦ ì„œë¹„ìŠ¤ êµ¬ì¶•:</p>
<ol>
<li>ë¹„ë°€ë²ˆí˜¸ í•´ì‹±ì´ ìˆëŠ” ì‚¬ìš©ì ë“±ë¡ (argon2 ë˜ëŠ” bcrypt)</li>
<li>ì•¡ì„¸ìŠ¤ + ë¦¬í”„ë ˆì‹œ í† í°ì„ ë°˜í™˜í•˜ëŠ” ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸</li>
<li>ë¦¬í”„ë ˆì‹œ í† í° ìˆœí™˜ì´ ìˆëŠ” í† í° ë¦¬í”„ë ˆì‹œ ì—”ë“œí¬ì¸íŠ¸</li>
<li>í† í° ë¸”ë™ë¦¬ìŠ¤íŠ¸ê°€ ìˆëŠ” ë¡œê·¸ì•„ì›ƒ ì—”ë“œí¬ì¸íŠ¸ (Redis ë˜ëŠ” ì¸ë©”ëª¨ë¦¬ ì„¸íŠ¸ ì‚¬ìš©)</li>
<li>"admin" ë²”ìœ„ê°€ í•„ìš”í•œ ë³´í˜¸ëœ ì—”ë“œí¬ì¸íŠ¸</li>
<li>ë§Œë£Œ, ì˜ëª»ëœ í˜•ì‹ ë° íê¸°ëœ í† í°ì— ëŒ€í•œ ì ì ˆí•œ ì˜¤ë¥˜ ì²˜ë¦¬</li>
<li>ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸ì— ëŒ€í•œ ì†ë„ ì œí•œ (IPë‹¹ ë¶„ë‹¹ 5íšŒ ì‹œë„)</li>
</ol>
<h3 id="2-cors">ì—°ìŠµ 2: CORS ë³´ì•ˆ ê°ì‚¬<a class="header-link" href="#2-cors" title="Permanent link">&para;</a></h3>
<p>ë‹¤ìŒì„ ìˆ˜í–‰í•˜ëŠ” Python ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±:</p>
<ol>
<li>API URL ëª©ë¡ ê°€ì ¸ì˜¤ê¸°</li>
<li>ë‹¤ì–‘í•œ Origin í—¤ë”ë¡œ ìš”ì²­ ì „ì†¡</li>
<li>APIê°€ ì„ì˜ì˜ ì¶œì²˜ë¥¼ ë°˜ì˜í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸ (ì·¨ì•½ì )</li>
<li>ìê²© ì¦ëª…ì´ ì™€ì¼ë“œì¹´ë“œ ì¶œì²˜ì™€ í•¨ê»˜ í—ˆìš©ë˜ëŠ”ì§€ í™•ì¸</li>
<li>ì¼ë°˜ì ì¸ ë©”ì„œë“œ ë° í—¤ë”ì— ëŒ€í•œ í”„ë¦¬í”Œë¼ì´íŠ¸ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸</li>
<li>ê° ì—”ë“œí¬ì¸íŠ¸ì— ëŒ€í•œ ë³´ì•ˆ ë³´ê³ ì„œ ìƒì„±</li>
</ol>
<h3 id="3-graphql">ì—°ìŠµ 3: GraphQL ë³´ì•ˆ ë¯¸ë“¤ì›¨ì–´<a class="header-link" href="#3-graphql" title="Permanent link">&para;</a></h3>
<p>ë‹¤ìŒì„ ìˆ˜í–‰í•˜ëŠ” GraphQL ë³´ì•ˆ ë¯¸ë“¤ì›¨ì–´ êµ¬í˜„:</p>
<ol>
<li>êµ¬ì„± ê°€ëŠ¥í•œ ìµœëŒ€ê°’ìœ¼ë¡œ ì¿¼ë¦¬ ê¹Šì´ ì œí•œ (ê¸°ë³¸ê°’: 10)</li>
<li>ì¿¼ë¦¬ ë¹„ìš© ê³„ì‚° ë° ë¹„ìš©ì´ ë§ì´ ë“œëŠ” ì¿¼ë¦¬ ê±°ë¶€</li>
<li>í”„ë¡œë•ì…˜ì—ì„œ ì¸íŠ¸ë¡œìŠ¤í™ì…˜ ë¹„í™œì„±í™”</li>
<li>ë°°ì¹˜ ì¿¼ë¦¬ í¬ê¸° ì œí•œ</li>
<li>ë¹„ìš© ë° ì‹¤í–‰ ì‹œê°„ê³¼ í•¨ê»˜ ëª¨ë“  ì¿¼ë¦¬ ë¡œê·¸</li>
<li>í•´ì‹œ í—ˆìš© ëª©ë¡ì´ ìˆëŠ” ì§€ì† ì¿¼ë¦¬ êµ¬í˜„</li>
</ol>
<h3 id="4_1">ì—°ìŠµ 4: ìŠ¬ë¼ì´ë”© ìœˆë„ìš°ê°€ ìˆëŠ” ì†ë„ ì œí•œê¸°<a class="header-link" href="#4_1" title="Permanent link">&para;</a></h3>
<p>ë‹¤ìŒì„ ìˆ˜í–‰í•˜ëŠ” ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ë¡œê·¸ ì†ë„ ì œí•œê¸° êµ¬í˜„:</p>
<ol>
<li>Redisë¥¼ ë°±ì—… ì €ì¥ì†Œë¡œ ì‚¬ìš© (ë˜ëŠ” ì¸ë©”ëª¨ë¦¬ ì‹œë®¬ë ˆì´ì…˜)</li>
<li>ê° ìš”ì²­ì˜ ì •í™•í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ì </li>
<li>êµ¬ì„± ê°€ëŠ¥í•œ ìœˆë„ìš° ì§€ì› (ì´ˆë‹¹, ë¶„ë‹¹, ì‹œê°„ë‹¹)</li>
<li>ë‹¤ë¥¸ API í‚¤ í‹°ì–´ì— ëŒ€í•œ ë‹¤ë¥¸ ì œí•œ ì§€ì›</li>
<li>ì ì ˆí•œ ì†ë„ ì œí•œ í—¤ë” ë°˜í™˜ (X-RateLimit-Limit, Remaining, Reset)</li>
<li>ë¶„ì‚° ë°°í¬ ì²˜ë¦¬ (ì—¬ëŸ¬ ì„œë²„ ì¸ìŠ¤í„´ìŠ¤)</li>
</ol>
<h3 id="5-api">ì—°ìŠµ 5: API ì…ë ¥ ê²€ì¦ í”„ë ˆì„ì›Œí¬<a class="header-link" href="#5-api" title="Permanent link">&para;</a></h3>
<p>ë‹¤ìŒì„ ìˆ˜í–‰í•˜ëŠ” ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ê²€ì¦ í”„ë ˆì„ì›Œí¬ êµ¬ì¶•:</p>
<ol>
<li>ìŠ¤í‚¤ë§ˆì— ëŒ€í•œ JSON ìš”ì²­ ë³¸ë¬¸ ê²€ì¦</li>
<li>íƒ€ì… ê°•ì œë¥¼ ì‚¬ìš©í•œ ì¿¼ë¦¬ ë§¤ê°œë³€ìˆ˜ ê²€ì¦</li>
<li>ê²½ë¡œ ë§¤ê°œë³€ìˆ˜ ê²€ì¦</li>
<li>ì¤‘ì²© ê°ì²´ ê²€ì¦ ì§€ì›</li>
<li>ì¼ê´€ëœ ì˜¤ë¥˜ ì‘ë‹µ í˜•ì‹ ë°˜í™˜ (RFC 7807)</li>
<li>ëŒ€ëŸ‰ í• ë‹¹ìœ¼ë¡œë¶€í„° ë³´í˜¸ (ì•Œ ìˆ˜ ì—†ëŠ” í•„ë“œ ê±°ë¶€)</li>
<li>ë¬¸ìì—´ ì…ë ¥ ì •ì œ (ê³µë°± ì œê±°, ìœ ë‹ˆì½”ë“œ ì •ê·œí™”)</li>
</ol>
<h3 id="6-api">ì—°ìŠµ 6: API ë³´ì•ˆ ìŠ¤ìºë„ˆ<a class="header-link" href="#6-api" title="Permanent link">&para;</a></h3>
<p>ë‹¤ìŒì— ëŒ€í•œ APIë¥¼ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë³´ì•ˆ ìŠ¤ìºë‹ ë„êµ¬ ìƒì„±:</p>
<ol>
<li>ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì¸ì¦ ëˆ„ë½</li>
<li>ê¹¨ì§„ ê°ì²´ ìˆ˜ì¤€ ì¸ê°€ (BOLA/IDOR)</li>
<li>ì†ë„ ì œí•œ ëˆ„ë½</li>
<li>ë‚´ë¶€ ì„¸ë¶€ ì •ë³´ë¥¼ ë“œëŸ¬ë‚´ëŠ” ìì„¸í•œ ì˜¤ë¥˜ ë©”ì‹œì§€</li>
<li>ë³´ì•ˆ í—¤ë” ëˆ„ë½</li>
<li>CORS ì˜ëª»ëœ êµ¬ì„±</li>
<li>ì‹¬ê°ë„ ë“±ê¸‰ì´ ìˆëŠ” ë³´ê³ ì„œ ìƒì„±</li>
</ol>
<hr />
<h2 id="_2">ìš”ì•½<a class="header-link" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="api_1">API ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸<a class="header-link" href="#api_1" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>ë²”ì£¼</th>
<th>í•­ëª©</th>
<th>ìš°ì„ ìˆœìœ„</th>
</tr>
</thead>
<tbody>
<tr>
<td>ì¸ì¦</td>
<td>ì‚¬ìš©ìì—ê²Œ OAuth 2.0 ë˜ëŠ” JWT ì‚¬ìš© (API í‚¤ë§Œ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ)</td>
<td>Critical</td>
</tr>
<tr>
<td>ì¸ì¦</td>
<td>ë‹¨ê¸° ì•¡ì„¸ìŠ¤ í† í° (15ë¶„)</td>
<td>Critical</td>
</tr>
<tr>
<td>ì¸ì¦</td>
<td>ë¦¬í”„ë ˆì‹œ í† í° ìˆœí™˜</td>
<td>High</td>
</tr>
<tr>
<td>ì¸ê°€</td>
<td>ê°ì²´ ìˆ˜ì¤€ ê¶Œí•œ í™•ì¸ (BOLA ë°©ì§€)</td>
<td>Critical</td>
</tr>
<tr>
<td>ì¸ê°€</td>
<td>ëª¨ë“  ìš”ì²­ì—ì„œ ë²”ìœ„ ê²€ì¦</td>
<td>Critical</td>
</tr>
<tr>
<td>ì†ë„ ì œí•œ</td>
<td>IPë‹¹ ë° ì‚¬ìš©ìë‹¹ ì†ë„ ì œí•œ</td>
<td>High</td>
</tr>
<tr>
<td>ì†ë„ ì œí•œ</td>
<td>ì¸ì¦ ì—”ë“œí¬ì¸íŠ¸ì— ëŒ€í•œ ì—„ê²©í•œ ì œí•œ</td>
<td>High</td>
</tr>
<tr>
<td>ì…ë ¥ ê²€ì¦</td>
<td>ëª¨ë“  ì…ë ¥ì— ëŒ€í•œ ìŠ¤í‚¤ë§ˆ ê²€ì¦</td>
<td>Critical</td>
</tr>
<tr>
<td>ì…ë ¥ ê²€ì¦</td>
<td>ì•Œ ìˆ˜ ì—†ëŠ” í•„ë“œ ê±°ë¶€</td>
<td>High</td>
</tr>
<tr>
<td>CORS</td>
<td>íŠ¹ì • ì¶œì²˜ í—ˆìš© ëª©ë¡ (ìê²© ì¦ëª…ê³¼ í•¨ê»˜ ì™€ì¼ë“œì¹´ë“œ ì—†ìŒ)</td>
<td>Critical</td>
</tr>
<tr>
<td>CORS</td>
<td>Vary: Origin í—¤ë”</td>
<td>Medium</td>
</tr>
<tr>
<td>ì•”í˜¸í™”</td>
<td>ì–´ë””ì„œë‚˜ TLS (HTTPSë§Œ)</td>
<td>Critical</td>
</tr>
<tr>
<td>ë¡œê¹…</td>
<td>ê³ ìœ í•œ ìš”ì²­ IDë¡œ ëª¨ë“  ìš”ì²­ ë¡œê·¸</td>
<td>High</td>
</tr>
<tr>
<td>ë²„ì „ ê´€ë¦¬</td>
<td>ì¼ëª° ë‚ ì§œë¡œ êµ¬ë²„ì „ íê¸°</td>
<td>Medium</td>
</tr>
<tr>
<td>ê²Œì´íŠ¸ì›¨ì´</td>
<td>ì¤‘ì•™ ì§‘ì¤‘ì‹ ì¸ì¦ ë° ì†ë„ ì œí•œ</td>
<td>Recommended</td>
</tr>
</tbody>
</table>
<h3 id="_3">í•µì‹¬ ìš”ì <a class="header-link" href="#_3" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>ì‹¬ì¸µ ë°©ì–´</strong> â€” ëª¨ë“  ê³„ì¸µ(ë„¤íŠ¸ì›Œí¬, ê²Œì´íŠ¸ì›¨ì´, ì• í”Œë¦¬ì¼€ì´ì…˜, ë°ì´í„°ë² ì´ìŠ¤)ì—ì„œ ë³´ì•ˆ ì ìš©</li>
<li><strong>í´ë¼ì´ì–¸íŠ¸ ì…ë ¥ì„ ì ˆëŒ€ ì‹ ë¢°í•˜ì§€ ë§ ê²ƒ</strong> â€” ì„œë²„ì—ì„œ ëª¨ë“  ê²ƒì„ ë§¤ë²ˆ ê²€ì¦</li>
<li><strong>í™•ë¦½ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©</strong> â€” ìì²´ ì¸ì¦ ë˜ëŠ” ì•”í˜¸í™”ë¥¼ ë§Œë“¤ì§€ ë§ ê²ƒ</li>
<li><strong>ëª¨ë‹ˆí„°ë§ ë° ê²½ê³ </strong> â€” ëª¨ë‹ˆí„°ë§ ì—†ëŠ” ë³´ì•ˆì€ ë¶ˆì™„ì „í•¨</li>
<li><strong>API ë³´ì•ˆ ë¬¸ì„œí™”</strong> â€” ëª…í™•ì„±ì„ ìœ„í•´ OpenAPI ë³´ì•ˆ ìŠ¤í‚´ ì‚¬ìš©</li>
</ol>
<hr />
<p><strong>ì´ì „</strong>: <a href="./09_Web_Security_Headers.md">09_Web_Security_Headers.md</a> | <strong>ë‹¤ìŒ</strong>: <a href="./11_Secrets_Management.md">11_Secrets_Management.md</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Security/09_Web_Security_Headers.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">Web Security Headersì™€ CSP</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Security/11_Secrets_Management.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">Secrets Managementì™€ í™˜ê²½ ì„¤ì •</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'ko';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}