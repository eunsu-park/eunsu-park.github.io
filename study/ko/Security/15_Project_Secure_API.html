{% raw %}
<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œì íŠ¸: ì•ˆì „í•œ REST API êµ¬ì¶• - Study Materials</title>
    <link rel="stylesheet" href="/study/static/css/style.css">
    <link rel="stylesheet" href="/study/static/css/highlight.css">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/study/ko/" class="logo">Study Materials</a>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span></span>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="/study/ko/" class="nav-item ">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/study/examples/" class="nav-item ">
                    <span class="nav-icon">ğŸ’»</span>
                    <span class="nav-text">Examples</span>
                </a>
            </nav>

            <div class="sidebar-search">
                <form action="/study/ko/search.html" method="get" id="search-form">
                    <input type="search" name="q" placeholder="Search..." id="search-sidebar-input">
                </form>
            </div>

            <!-- Language Selector -->
            <div class="sidebar-lang">
                <select id="lang-select" class="lang-selector" onchange="switchLanguage(this.value)">
                    
                    <option value="en" >
                        English
                    </option>
                    
                    <option value="ko" selected>
                        í•œêµ­ì–´
                    </option>
                    
                </select>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon light">â˜€ï¸</span>
                    <span class="theme-icon dark">ğŸŒ™</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle" aria-label="Open menu">
                    <span></span>
                </button>
                
<nav class="breadcrumb">
    <a href="/study/ko/">Topics</a>
    <span class="separator">/</span>
    <a href="/study/ko/Security/">Security</a>
    <span class="separator">/</span>
    <span class="current">í”„ë¡œì íŠ¸: ì•ˆì „í•œ REST API êµ¬ì¶•</span>
</nav>

            </header>

            <div class="content">
                
<article class="lesson-article">
    <header class="lesson-header">
        <h1>í”„ë¡œì íŠ¸: ì•ˆì „í•œ REST API êµ¬ì¶•</h1>
    </header>

    
<div class="lesson-toolbar lesson-toolbar--top">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Security/14_Incident_Response.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">ì‚¬ê³  ëŒ€ì‘ ë° í¬ë Œì‹</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Security/16_Project_Vulnerability_Scanner.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">í”„ë¡œì íŠ¸: ì·¨ì•½ì  ìŠ¤ìºë„ˆ êµ¬ì¶•</span>
        </a>
        
    </div>
</div>


    
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        <div class="toc">
<ul>
<li><a href="#_1">í•™ìŠµ ëª©í‘œ</a></li>
<li><a href="#1">1. í”„ë¡œì íŠ¸ ê°œìš” ë° ì•„í‚¤í…ì²˜</a><ul>
<li><a href="#11">1.1 êµ¬ì¶•í•  ë‚´ìš©</a></li>
<li><a href="#12">1.2 í”„ë¡œì íŠ¸ êµ¬ì¡°</a></li>
<li><a href="#13">1.3 ì˜ì¡´ì„±</a></li>
</ul>
</li>
<li><a href="#2">2. ì„¤ì • ê´€ë¦¬</a><ul>
<li><a href="#21">2.1 ì•ˆì „í•œ ì„¤ì •</a></li>
<li><a href="#22">2.2 í™˜ê²½ íŒŒì¼</a></li>
</ul>
</li>
<li><a href="#3-argon2">3. Argon2ë¥¼ ì‚¬ìš©í•œ ë¹„ë°€ë²ˆí˜¸ í•´ì‹±</a><ul>
<li><a href="#31-argon2">3.1 Argon2ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ </a></li>
<li><a href="#32">3.2 ë¹„ë°€ë²ˆí˜¸ í•´ì‹± êµ¬í˜„</a></li>
</ul>
</li>
<li><a href="#4-jwt">4. ë¦¬í”„ë ˆì‹œ í† í°ì„ ì‚¬ìš©í•œ JWT ì¸ì¦</a><ul>
<li><a href="#41">4.1 í† í° ì•„í‚¤í…ì²˜</a></li>
<li><a href="#42">4.2 í† í° ì„œë¹„ìŠ¤ êµ¬í˜„</a></li>
</ul>
</li>
<li><a href="#5-rbac">5. ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (RBAC)</a><ul>
<li><a href="#51-rbac">5.1 RBAC ì„¤ê³„</a></li>
<li><a href="#52-rbac">5.2 RBAC êµ¬í˜„</a></li>
</ul>
</li>
<li><a href="#6-pydantic">6. Pydanticì„ ì‚¬ìš©í•œ ì…ë ¥ ê²€ì¦</a><ul>
<li><a href="#61">6.1 ì‚¬ìš©ì ìŠ¤í‚¤ë§ˆ</a></li>
<li><a href="#62">6.2 ì¸ì¦ ìŠ¤í‚¤ë§ˆ</a></li>
</ul>
</li>
<li><a href="#7">7. ë¯¸ë“¤ì›¨ì–´: ì†ë„ ì œí•œ</a><ul>
<li><a href="#71">7.1 ì†ë„ ì œí•œê¸°</a></li>
</ul>
</li>
<li><a href="#8">8. ë¯¸ë“¤ì›¨ì–´: ë³´ì•ˆ í—¤ë”</a><ul>
<li><a href="#81">8.1 ë³´ì•ˆ í—¤ë” ë¯¸ë“¤ì›¨ì–´</a></li>
</ul>
</li>
<li><a href="#9">9. ë¯¸ë“¤ì›¨ì–´: ìš”ì²­ ë¡œê¹…</a><ul>
<li><a href="#91">9.1 êµ¬ì¡°í™”ëœ ë³´ì•ˆ ë¡œê¹…</a></li>
<li><a href="#92">9.2 ìš”ì²­ ë¡œê¹… ë¯¸ë“¤ì›¨ì–´</a></li>
</ul>
</li>
<li><a href="#10">10. ì •ë³´ ìœ ì¶œ ì—†ëŠ” ì—ëŸ¬ ì²˜ë¦¬</a><ul>
<li><a href="#101">10.1 ì•ˆì „í•œ ì—ëŸ¬ ì²˜ë¦¬</a></li>
</ul>
</li>
<li><a href="#11_1">11. ì¸ì¦ ì—”ë“œí¬ì¸íŠ¸</a><ul>
<li><a href="#111">11.1 ì¸ì¦ ë¼ìš°í„°</a></li>
</ul>
</li>
<li><a href="#12_1">12. ì‚¬ìš©ì ì—”ë“œí¬ì¸íŠ¸</a><ul>
<li><a href="#121">12.1 ì‚¬ìš©ì ë¼ìš°í„°</a></li>
</ul>
</li>
<li><a href="#13_1">13. ë³´ì•ˆ í…ŒìŠ¤íŠ¸</a><ul>
<li><a href="#131">13.1 í…ŒìŠ¤íŠ¸ ì„¤ì •</a></li>
<li><a href="#132">13.2 ë³´ì•ˆ ì „ìš© í…ŒìŠ¤íŠ¸</a></li>
</ul>
</li>
<li><a href="#14">14. ë°°í¬ ê³ ë ¤ì‚¬í•­</a><ul>
<li><a href="#141">14.1 í”„ë¡œë•ì…˜ ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸</a></li>
<li><a href="#142-nginx">14.2 Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì •</a></li>
<li><a href="#143-docker">14.3 Docker ë°°í¬</a></li>
</ul>
</li>
<li><a href="#15">15. ì—°ìŠµ ë¬¸ì œ</a><ul>
<li><a href="#1-auth-service">ì—°ìŠµ ë¬¸ì œ 1: Auth Service êµ¬í˜„</a></li>
<li><a href="#2-2">ì—°ìŠµ ë¬¸ì œ 2: 2ë‹¨ê³„ ì¸ì¦ ì¶”ê°€</a></li>
<li><a href="#3-api">ì—°ìŠµ ë¬¸ì œ 3: API í‚¤ ì¸ì¦</a></li>
<li><a href="#4">ì—°ìŠµ ë¬¸ì œ 4: ì™„ì „í•œ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸</a></li>
<li><a href="#5">ì—°ìŠµ ë¬¸ì œ 5: ë³´ì•ˆ ê°ì‚¬</a></li>
<li><a href="#6">ì—°ìŠµ ë¬¸ì œ 6: í”„ë¡œë•ì…˜ ë°°í¬</a></li>
</ul>
</li>
<li><a href="#_2">ìš”ì•½</a></li>
</ul>
</div>

    </nav>
    

    <div class="lesson-content markdown-body">
        <h1 id="rest-api">í”„ë¡œì íŠ¸: ì•ˆì „í•œ REST API êµ¬ì¶•<a class="header-link" href="#rest-api" title="Permanent link">&para;</a></h1>
<hr />
<p>ì´ í”„ë¡œì íŠ¸ ë ˆìŠ¨ì€ FastAPIë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œë•ì…˜ ë ˆë²¨ì˜ ì•ˆì „í•œ REST APIë¥¼ ì²˜ìŒë¶€í„° êµ¬ì¶•í•˜ëŠ” ê³¼ì •ì„ ì•ˆë‚´í•©ë‹ˆë‹¤. Argon2ë¥¼ ì‚¬ìš©í•œ ì ì ˆí•œ ë¹„ë°€ë²ˆí˜¸ í•´ì‹±, ë¦¬í”„ë ˆì‹œ í† í°ì„ ì‚¬ìš©í•œ JWT ì¸ì¦, ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´, ì…ë ¥ ê²€ì¦, ì†ë„ ì œí•œ, ë³´ì•ˆ í—¤ë”, CORS ì„¤ì •, êµ¬ì¡°í™”ëœ ë¡œê¹…, ì•ˆì „í•œ ì˜¤ë¥˜ ì²˜ë¦¬ ë“± ëª¨ë“  ë³´ì•ˆ ê³„ì¸µì„ êµ¬í˜„í•  ê²ƒì…ë‹ˆë‹¤. ë ˆìŠ¨ì„ ë§ˆì¹˜ë©´ ë³´ì•ˆ ëª¨ë²” ì‚¬ë¡€ë¥¼ ë”°ë¥´ëŠ” ì™„ì „í•˜ê³  ë°°í¬ ê°€ëŠ¥í•œ APIë¥¼ ê°–ê²Œ ë©ë‹ˆë‹¤.</p>
<h2 id="_1">í•™ìŠµ ëª©í‘œ<a class="header-link" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li>ë³´ì•ˆì„ ìµœìš°ì„  ê´€ì‹¬ì‚¬ë¡œ í•˜ëŠ” REST API êµ¬ì¶•</li>
<li>ì ì ˆí•œ ì„¤ì •ìœ¼ë¡œ Argon2 ë¹„ë°€ë²ˆí˜¸ í•´ì‹± êµ¬í˜„</li>
<li>ì•¡ì„¸ìŠ¤ í† í° ë° ë¦¬í”„ë ˆì‹œ í† í° ë¡œí…Œì´ì…˜ì„ ì‚¬ìš©í•œ JWT ì¸ì¦ ìƒì„±</li>
<li>ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´(RBAC) ì„¤ê³„ ë° êµ¬í˜„</li>
<li>Pydantic ëª¨ë¸ì„ ì‚¬ìš©í•œ ëª¨ë“  ì…ë ¥ ê²€ì¦</li>
<li>ì†ë„ ì œí•œ, ë³´ì•ˆ í—¤ë”, CORS ì¶”ê°€</li>
<li>êµ¬ì¡°í™”ëœ ë³´ì•ˆ ë¡œê¹… êµ¬í˜„</li>
<li>ë¯¼ê°í•œ ì •ë³´ë¥¼ ë…¸ì¶œí•˜ì§€ ì•ŠëŠ” ì˜¤ë¥˜ ì²˜ë¦¬</li>
<li>ë³´ì•ˆ ì¤‘ì‹¬ í…ŒìŠ¤íŠ¸ ì‘ì„±</li>
<li>í”„ë¡œë•ì…˜ ë°°í¬ ì¤€ë¹„</li>
</ul>
<hr />
<h2 id="1">1. í”„ë¡œì íŠ¸ ê°œìš” ë° ì•„í‚¤í…ì²˜<a class="header-link" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 êµ¬ì¶•í•  ë‚´ìš©<a class="header-link" href="#11" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Secure REST API Architecture                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Client Request                                                  â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Rate Limiter     â”‚  â† Prevent brute force / DoS             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Security Headers â”‚  â† HSTS, CSP, X-Frame-Options           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  CORS Middleware  â”‚  â† Cross-origin request control          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Authentication   â”‚  â† JWT verification                      â”‚
â”‚  â”‚  Middleware       â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Authorization    â”‚  â† RBAC permission check                 â”‚
â”‚  â”‚  (RBAC)          â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Input Validation â”‚  â† Pydantic schema validation            â”‚
â”‚  â”‚  (Pydantic)      â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Business Logic   â”‚  â† Route handlers                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Database Layer   â”‚  â† Parameterized queries only            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Security Logger  â”‚  â† Audit trail (no PII in logs)          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="12">1.2 í”„ë¡œì íŠ¸ êµ¬ì¡°<a class="header-link" href="#12" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>secure_api/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py              # FastAPI application entry point
â”‚   â”œâ”€â”€ config.py            # Configuration management
â”‚   â”œâ”€â”€ database.py          # Database setup (SQLAlchemy)
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py          # User database model
â”‚   â”‚   â””â”€â”€ token.py         # Refresh token model
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py          # Pydantic user schemas
â”‚   â”‚   â”œâ”€â”€ auth.py          # Auth request/response schemas
â”‚   â”‚   â””â”€â”€ common.py        # Shared schemas
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth.py          # Authentication endpoints
â”‚   â”‚   â”œâ”€â”€ users.py         # User management endpoints
â”‚   â”‚   â””â”€â”€ admin.py         # Admin-only endpoints
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ security_headers.py
â”‚   â”‚   â”œâ”€â”€ rate_limiter.py
â”‚   â”‚   â””â”€â”€ request_logging.py
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth_service.py  # Authentication logic
â”‚   â”‚   â”œâ”€â”€ user_service.py  # User CRUD operations
â”‚   â”‚   â””â”€â”€ token_service.py # JWT creation/validation
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ password.py      # Argon2 hashing
â”‚       â”œâ”€â”€ security.py      # Security helpers
â”‚       â””â”€â”€ logging.py       # Structured logging
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py          # Test fixtures
â”‚   â”œâ”€â”€ test_auth.py         # Auth endpoint tests
â”‚   â”œâ”€â”€ test_users.py        # User endpoint tests
â”‚   â””â”€â”€ test_security.py     # Security-specific tests
â”œâ”€â”€ alembic/                 # Database migrations
â”‚   â””â”€â”€ ...
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ .env.example
â”œâ”€â”€ Dockerfile
â””â”€â”€ docker-compose.yml
</code></pre></div>

<h3 id="13">1.3 ì˜ì¡´ì„±<a class="header-link" href="#13" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">requirements</span><span class="p">.</span><span class="n">txt</span>
<span class="n">fastapi</span><span class="o">==</span><span class="mf">0.109.2</span>
<span class="n">uvicorn</span><span class="o">[</span><span class="n">standard</span><span class="o">]==</span><span class="mf">0.27.1</span>
<span class="n">sqlalchemy</span><span class="o">==</span><span class="mf">2.0.27</span>
<span class="n">alembic</span><span class="o">==</span><span class="mf">1.13.1</span>
<span class="n">asyncpg</span><span class="o">==</span><span class="mf">0.29.0</span>
<span class="n">python</span><span class="o">-</span><span class="n">jose</span><span class="o">[</span><span class="n">cryptography</span><span class="o">]==</span><span class="mf">3.3.0</span>
<span class="n">argon2</span><span class="o">-</span><span class="n">cffi</span><span class="o">==</span><span class="mf">23.1.0</span>
<span class="n">pydantic</span><span class="o">[</span><span class="n">email</span><span class="o">]==</span><span class="mf">2.6.1</span>
<span class="n">pydantic</span><span class="o">-</span><span class="n">settings</span><span class="o">==</span><span class="mf">2.1.0</span>
<span class="n">python</span><span class="o">-</span><span class="n">multipart</span><span class="o">==</span><span class="mf">0.0.9</span>
<span class="n">slowapi</span><span class="o">==</span><span class="mf">0.1.9</span>
<span class="n">structlog</span><span class="o">==</span><span class="mf">24.1.0</span>
<span class="n">httpx</span><span class="o">==</span><span class="mf">0.27.0</span>
<span class="n">pytest</span><span class="o">==</span><span class="mf">8.0.1</span>
<span class="n">pytest</span><span class="o">-</span><span class="n">asyncio</span><span class="o">==</span><span class="mf">0.23.5</span>
</code></pre></div>

<hr />
<h2 id="2">2. ì„¤ì • ê´€ë¦¬<a class="header-link" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 ì•ˆì „í•œ ì„¤ì •<a class="header-link" href="#21" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/config.py - Application configuration.</span>
<span class="sd">All secrets come from environment variables, never hardcoded.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic_settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseSettings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Application settings loaded from environment variables.</span>
<span class="sd">    Never hardcode secrets - use .env file for development,</span>
<span class="sd">    environment variables or secret manager for production.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Application</span>
    <span class="n">APP_NAME</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Secure API&quot;</span>
    <span class="n">APP_VERSION</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.0.0&quot;</span>
    <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ENVIRONMENT</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;production&quot;</span>  <span class="c1"># development, staging, production</span>

    <span class="c1"># Database</span>
    <span class="n">DATABASE_URL</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span>  <span class="c1"># Required - must be provided</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;PostgreSQL connection string&quot;</span>
    <span class="p">)</span>

    <span class="c1"># JWT Configuration</span>
    <span class="n">JWT_SECRET_KEY</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span>  <span class="c1"># Required</span>
        <span class="n">min_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Secret key for JWT signing (min 32 chars)&quot;</span>
    <span class="p">)</span>
    <span class="n">JWT_ALGORITHM</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
    <span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span>      <span class="c1"># Short-lived</span>
    <span class="n">REFRESH_TOKEN_EXPIRE_DAYS</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span>         <span class="c1"># Longer-lived</span>

    <span class="c1"># Password Hashing (Argon2)</span>
    <span class="n">ARGON2_TIME_COST</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>          <span class="c1"># Number of iterations</span>
    <span class="n">ARGON2_MEMORY_COST</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span>    <span class="c1"># Memory in KiB (64 MB)</span>
    <span class="n">ARGON2_PARALLELISM</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>        <span class="c1"># Number of threads</span>
    <span class="n">ARGON2_HASH_LENGTH</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>       <span class="c1"># Hash output length</span>
    <span class="n">ARGON2_SALT_LENGTH</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span>       <span class="c1"># Salt length</span>

    <span class="c1"># Rate Limiting</span>
    <span class="n">RATE_LIMIT_PER_MINUTE</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="n">LOGIN_RATE_LIMIT</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;5/minute&quot;</span>     <span class="c1"># Stricter for login</span>
    <span class="n">REGISTER_RATE_LIMIT</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;3/minute&quot;</span>  <span class="c1"># Stricter for registration</span>

    <span class="c1"># CORS</span>
    <span class="n">CORS_ORIGINS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;http://localhost:3000&quot;</span><span class="p">]</span>
    <span class="n">CORS_ALLOW_CREDENTIALS</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">CORS_ALLOW_METHODS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">]</span>
    <span class="n">CORS_ALLOW_HEADERS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span>

    <span class="c1"># Logging</span>
    <span class="n">LOG_LEVEL</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span>
    <span class="n">LOG_FORMAT</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span>  <span class="c1"># json or console</span>

    <span class="c1"># Security</span>
    <span class="n">ALLOWED_HOSTS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">]</span>
    <span class="n">SECURE_COOKIES</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">MAX_LOGIN_ATTEMPTS</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">ACCOUNT_LOCKOUT_MINUTES</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;env_file&quot;</span><span class="p">:</span> <span class="s2">&quot;.env&quot;</span><span class="p">,</span>
        <span class="s2">&quot;env_file_encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;case_sensitive&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>


<span class="nd">@lru_cache</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_settings</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Settings</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get cached settings instance.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Settings</span><span class="p">()</span>
</code></pre></div>

<h3 id="22">2.2 í™˜ê²½ íŒŒì¼<a class="header-link" href="#22" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># .env.example - Copy to .env and fill in values</span>
<span class="c1"># NEVER commit .env to version control!</span>

<span class="c1"># Application</span>
<span class="nv">APP_NAME</span><span class="o">=</span><span class="s2">&quot;Secure API&quot;</span>
<span class="nv">DEBUG</span><span class="o">=</span><span class="nb">false</span>
<span class="nv">ENVIRONMENT</span><span class="o">=</span>development

<span class="c1"># Database (use a strong password)</span>
<span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql+asyncpg://user:strong_password_here@localhost:5432/secure_api

<span class="c1"># JWT (generate with: python -c &quot;import secrets; print(secrets.token_hex(32))&quot;)</span>
<span class="nv">JWT_SECRET_KEY</span><span class="o">=</span>your-secret-key-at-least-32-characters-long-change-this

<span class="c1"># CORS</span>
<span class="nv">CORS_ORIGINS</span><span class="o">=[</span><span class="s2">&quot;http://localhost:3000&quot;</span>,<span class="s2">&quot;http://localhost:8080&quot;</span><span class="o">]</span>

<span class="c1"># Logging</span>
<span class="nv">LOG_LEVEL</span><span class="o">=</span>INFO
</code></pre></div>

<hr />
<h2 id="3-argon2">3. Argon2ë¥¼ ì‚¬ìš©í•œ ë¹„ë°€ë²ˆí˜¸ í•´ì‹±<a class="header-link" href="#3-argon2" title="Permanent link">&para;</a></h2>
<h3 id="31-argon2">3.1 Argon2ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ <a class="header-link" href="#31-argon2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">Password</span><span class="w"> </span><span class="n">Hashing</span><span class="w"> </span><span class="n">Algorithm</span><span class="w"> </span><span class="n">Comparison</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Algorithm</span><span class="w">      </span><span class="n">Memory</span><span class="w">   </span><span class="n">GPU</span><span class="w">       </span><span class="n">Status</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                 </span><span class="n">Hard</span><span class="err">?</span><span class="w">    </span><span class="n">Resistant</span><span class="err">?</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">  </span><span class="err">â”€â”€â”€â”€â”€â”€â”€</span><span class="w">  </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">  </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">MD5</span><span class="w">            </span><span class="n">No</span><span class="w">       </span><span class="n">No</span><span class="w">        </span><span class="n">BROKEN</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="n">use</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="w">        </span><span class="n">No</span><span class="w">       </span><span class="n">No</span><span class="w">        </span><span class="n">NOT</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">passwords</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">bcrypt</span><span class="w">         </span><span class="n">No</span><span class="w">       </span><span class="n">Partial</span><span class="w">   </span><span class="n">Good</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">aging</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">scrypt</span><span class="w">         </span><span class="n">Yes</span><span class="w">      </span><span class="n">Yes</span><span class="w">       </span><span class="n">Good</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Argon2id</span><span class="w">       </span><span class="n">Yes</span><span class="w">      </span><span class="n">Yes</span><span class="w">       </span><span class="n">RECOMMENDED</span><span class="w"> </span><span class="p">(</span><span class="n">PHC</span><span class="w"> </span><span class="n">winner</span><span class="p">)</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Argon2</span><span class="w"> </span><span class="n">variants</span><span class="p">:</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Argon2d</span><span class="p">:</span><span class="w">  </span><span class="n">Data</span><span class="o">-</span><span class="n">dependent</span><span class="w"> </span><span class="p">(</span><span class="n">GPU</span><span class="w"> </span><span class="n">resistant</span><span class="p">,</span><span class="w"> </span><span class="n">side</span><span class="o">-</span><span class="n">channel</span><span class="w"> </span><span class="n">risk</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Argon2i</span><span class="p">:</span><span class="w">  </span><span class="n">Data</span><span class="o">-</span><span class="n">independent</span><span class="w"> </span><span class="p">(</span><span class="n">side</span><span class="o">-</span><span class="n">channel</span><span class="w"> </span><span class="n">safe</span><span class="p">,</span><span class="w"> </span><span class="n">less</span><span class="w"> </span><span class="n">GPU</span><span class="o">-</span><span class="n">R</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Argon2id</span><span class="p">:</span><span class="w"> </span><span class="n">Hybrid</span><span class="w"> </span><span class="p">(</span><span class="n">RECOMMENDED</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">best</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">both</span><span class="p">)</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Argon2id</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">winner</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Password</span><span class="w"> </span><span class="n">Hashing</span><span class="w"> </span><span class="n">Competition</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="n">PHC</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">recommended</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">OWASP</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="n">storage</span><span class="o">.</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="32">3.2 ë¹„ë°€ë²ˆí˜¸ í•´ì‹± êµ¬í˜„<a class="header-link" href="#32" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/utils/password.py - Secure password hashing with Argon2id.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">argon2</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHasher</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">argon2.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">VerifyMismatchError</span><span class="p">,</span>
    <span class="n">VerificationError</span><span class="p">,</span>
    <span class="n">InvalidHashError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_settings</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">()</span>

<span class="c1"># Configure Argon2id hasher with secure parameters</span>
<span class="c1"># OWASP recommends: time_cost=2, memory_cost=19456 (19 MiB) minimum</span>
<span class="c1"># We use stronger parameters for better security</span>
<span class="n">_hasher</span> <span class="o">=</span> <span class="n">PasswordHasher</span><span class="p">(</span>
    <span class="n">time_cost</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ARGON2_TIME_COST</span><span class="p">,</span>       <span class="c1"># iterations</span>
    <span class="n">memory_cost</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ARGON2_MEMORY_COST</span><span class="p">,</span>   <span class="c1"># KiB (64 MB)</span>
    <span class="n">parallelism</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ARGON2_PARALLELISM</span><span class="p">,</span>   <span class="c1"># threads</span>
    <span class="n">hash_len</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ARGON2_HASH_LENGTH</span><span class="p">,</span>      <span class="c1"># output length</span>
    <span class="n">salt_len</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ARGON2_SALT_LENGTH</span><span class="p">,</span>       <span class="c1"># salt length</span>
    <span class="nb">type</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>                                     <span class="c1"># 2 = Argon2id</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">hash_password</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hash a password using Argon2id.</span>

<span class="sd">    Args:</span>
<span class="sd">        password: The plaintext password to hash.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Argon2id hash string including algorithm parameters and salt.</span>

<span class="sd">    Example output:</span>
<span class="sd">        $argon2id$v=19$m=65536,t=3,p=4$c2FsdHNhbHQ$hash...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_hasher</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="nb">hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify a password against an Argon2id hash.</span>

<span class="sd">    This function is constant-time to prevent timing attacks.</span>

<span class="sd">    Args:</span>
<span class="sd">        hash: The stored Argon2id hash string.</span>
<span class="sd">        password: The plaintext password to verify.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if password matches, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_hasher</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">VerifyMismatchError</span><span class="p">,</span> <span class="n">VerificationError</span><span class="p">,</span> <span class="n">InvalidHashError</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_needs_rehash</span><span class="p">(</span><span class="nb">hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a hash needs to be re-computed with updated parameters.</span>

<span class="sd">    Call this after successful password verification. If parameters</span>
<span class="sd">    have been updated (stronger settings), rehash the password.</span>

<span class="sd">    Args:</span>
<span class="sd">        hash: The stored Argon2id hash string.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if the hash should be recomputed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_hasher</span><span class="o">.</span><span class="n">check_needs_rehash</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>


<span class="c1"># â”€â”€â”€ Password Strength Validation â”€â”€â”€</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PasswordStrengthError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when password does not meet strength requirements.&quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="k">def</span><span class="w"> </span><span class="nf">validate_password_strength</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate password meets minimum strength requirements.</span>

<span class="sd">    Requirements:</span>
<span class="sd">    - Minimum 8 characters (NIST recommends allowing up to 64)</span>
<span class="sd">    - At least one uppercase letter</span>
<span class="sd">    - At least one lowercase letter</span>
<span class="sd">    - At least one digit</span>
<span class="sd">    - At least one special character</span>
<span class="sd">    - Not a commonly breached password</span>

<span class="sd">    Raises:</span>
<span class="sd">        PasswordStrengthError if password is too weak.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PasswordStrengthError</span><span class="p">(</span>
            <span class="s2">&quot;Password must be at least 8 characters long&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PasswordStrengthError</span><span class="p">(</span>
            <span class="s2">&quot;Password must not exceed 128 characters&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[A-Z]&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PasswordStrengthError</span><span class="p">(</span>
            <span class="s2">&quot;Password must contain at least one uppercase letter&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[a-z]&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PasswordStrengthError</span><span class="p">(</span>
            <span class="s2">&quot;Password must contain at least one lowercase letter&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PasswordStrengthError</span><span class="p">(</span>
            <span class="s2">&quot;Password must contain at least one digit&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[!@#$%^&amp;*()_+\-=\[\]</span><span class="si">{}</span><span class="s1">;:</span><span class="se">\&#39;</span><span class="s1">&quot;,.&lt;&gt;?/</span><span class="se">\\</span><span class="s1">|`~]&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PasswordStrengthError</span><span class="p">(</span>
            <span class="s2">&quot;Password must contain at least one special character&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Check against common passwords (simplified list)</span>
    <span class="c1"># In production, use a larger list (e.g., Have I Been Pwned API)</span>
    <span class="n">COMMON_PASSWORDS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;password1&#39;</span><span class="p">,</span> <span class="s1">&#39;12345678&#39;</span><span class="p">,</span> <span class="s1">&#39;qwerty123&#39;</span><span class="p">,</span>
        <span class="s1">&#39;admin123&#39;</span><span class="p">,</span> <span class="s1">&#39;letmein1&#39;</span><span class="p">,</span> <span class="s1">&#39;welcome1&#39;</span><span class="p">,</span> <span class="s1">&#39;monkey123&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dragon12&#39;</span><span class="p">,</span> <span class="s1">&#39;master12&#39;</span><span class="p">,</span> <span class="s1">&#39;password123&#39;</span><span class="p">,</span> <span class="s1">&#39;abc12345&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">password</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">COMMON_PASSWORDS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PasswordStrengthError</span><span class="p">(</span>
            <span class="s2">&quot;This password is too common. Please choose a stronger password.&quot;</span>
        <span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="4-jwt">4. ë¦¬í”„ë ˆì‹œ í† í°ì„ ì‚¬ìš©í•œ JWT ì¸ì¦<a class="header-link" href="#4-jwt" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 í† í° ì•„í‚¤í…ì²˜<a class="header-link" href="#41" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                </span><span class="n">JWT</span><span class="w"> </span><span class="n">Token</span><span class="w"> </span><span class="n">Architecture</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Access</span><span class="w"> </span><span class="n">Token</span><span class="w"> </span><span class="p">(</span><span class="n">short</span><span class="o">-</span><span class="n">lived</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="nb">min</span><span class="p">)</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Header</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;HS256&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT&quot;</span><span class="p">}</span><span class="w">        </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Payload</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">                                      </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user-uuid&quot;</span><span class="p">,</span><span class="w">                           </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="w">                               </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;access&quot;</span><span class="p">,</span><span class="w">                             </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1706000000</span><span class="p">,</span><span class="w">     </span><span class="err">â†</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="nb">min</span><span class="w"> </span><span class="n">expiry</span><span class="w">       </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1706000000</span><span class="p">,</span><span class="w">                            </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;unique-token-id&quot;</span><span class="w">                      </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="p">}</span><span class="w">                                               </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Signature</span><span class="p">:</span><span class="w"> </span><span class="n">HMAC</span><span class="o">-</span><span class="n">SHA256</span><span class="p">(</span><span class="n">header</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">)</span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Refresh</span><span class="w"> </span><span class="n">Token</span><span class="w"> </span><span class="p">(</span><span class="n">long</span><span class="o">-</span><span class="n">lived</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">days</span><span class="p">)</span><span class="w">                             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Stored</span><span class="w"> </span><span class="ow">in</span><span class="p">:</span><span class="w"> </span><span class="n">HTTP</span><span class="o">-</span><span class="n">only</span><span class="w"> </span><span class="n">secure</span><span class="w"> </span><span class="n">cookie</span><span class="w">              </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Payload</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">                                      </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user-uuid&quot;</span><span class="p">,</span><span class="w">                           </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;refresh&quot;</span><span class="p">,</span><span class="w">                            </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1706600000</span><span class="p">,</span><span class="w">     </span><span class="err">â†</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">day</span><span class="w"> </span><span class="n">expiry</span><span class="w">        </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">    </span><span class="s2">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;unique-token-id&quot;</span><span class="w">                      </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="p">}</span><span class="w">                                               </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Also</span><span class="w"> </span><span class="n">tracked</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">revocation</span><span class="w">               </span><span class="err">â”‚</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Token</span><span class="w"> </span><span class="n">Flow</span><span class="p">:</span><span class="w">                                                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">Login</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">access_token</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">refresh_token</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">2.</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">calls</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">access_token</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">Authorization</span><span class="w"> </span><span class="n">header</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">3.</span><span class="w"> </span><span class="n">access_token</span><span class="w"> </span><span class="n">expires</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">refresh_token</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">pair</span><span class="w">    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">4.</span><span class="w"> </span><span class="n">refresh_token</span><span class="w"> </span><span class="n">expires</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Must</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="n">again</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mf">5.</span><span class="w"> </span><span class="n">Logout</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Revoke</span><span class="w"> </span><span class="n">refresh_token</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">DB</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                                  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="42">4.2 í† í° ì„œë¹„ìŠ¤ êµ¬í˜„<a class="header-link" href="#42" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/services/token_service.py - JWT token creation and validation.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">jose</span><span class="w"> </span><span class="kn">import</span> <span class="n">jwt</span><span class="p">,</span> <span class="n">JWTError</span><span class="p">,</span> <span class="n">ExpiredSignatureError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_settings</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TokenPayload</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decoded token payload.&quot;&quot;&quot;</span>
    <span class="n">sub</span><span class="p">:</span> <span class="nb">str</span>                <span class="c1"># Subject (user ID)</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>      <span class="c1"># User role</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;access&quot;</span>    <span class="c1"># Token type: access or refresh</span>
    <span class="n">exp</span><span class="p">:</span> <span class="n">datetime</span>           <span class="c1"># Expiration time</span>
    <span class="n">iat</span><span class="p">:</span> <span class="n">datetime</span>           <span class="c1"># Issued at</span>
    <span class="n">jti</span><span class="p">:</span> <span class="nb">str</span>                <span class="c1"># JWT ID (unique identifier)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TokenPair</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Access + refresh token pair.&quot;&quot;&quot;</span>
    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">refresh_token</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bearer&quot;</span>
    <span class="n">expires_in</span><span class="p">:</span> <span class="nb">int</span>         <span class="c1"># Access token expiry in seconds</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a short-lived access token.</span>

<span class="sd">    Args:</span>
<span class="sd">        user_id: The user&#39;s unique identifier.</span>
<span class="sd">        role: The user&#39;s role for RBAC.</span>
<span class="sd">        expires_delta: Optional custom expiration time.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Encoded JWT string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">expire</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="p">(</span><span class="n">expires_delta</span> <span class="ow">or</span> <span class="n">timedelta</span><span class="p">(</span>
        <span class="n">minutes</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span>
    <span class="p">))</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;access&quot;</span><span class="p">,</span>
        <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">,</span>
        <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
        <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
        <span class="n">payload</span><span class="p">,</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">JWT_SECRET_KEY</span><span class="p">,</span>
        <span class="n">algorithm</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">JWT_ALGORITHM</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_refresh_token</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a long-lived refresh token.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (encoded JWT string, token JTI for DB storage).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">expire</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="p">(</span><span class="n">expires_delta</span> <span class="ow">or</span> <span class="n">timedelta</span><span class="p">(</span>
        <span class="n">days</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REFRESH_TOKEN_EXPIRE_DAYS</span>
    <span class="p">))</span>

    <span class="n">jti</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;refresh&quot;</span><span class="p">,</span>
        <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">,</span>
        <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
        <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="n">jti</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
        <span class="n">payload</span><span class="p">,</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">JWT_SECRET_KEY</span><span class="p">,</span>
        <span class="n">algorithm</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">JWT_ALGORITHM</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">token</span><span class="p">,</span> <span class="n">jti</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_token_pair</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenPair</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create both access and refresh tokens.&quot;&quot;&quot;</span>
    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">role</span><span class="p">)</span>
    <span class="n">refresh_token</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_refresh_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">TokenPair</span><span class="p">(</span>
        <span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span>
        <span class="n">refresh_token</span><span class="o">=</span><span class="n">refresh_token</span><span class="p">,</span>
        <span class="n">expires_in</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">decode_token</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expected_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;access&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenPayload</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decode and validate a JWT token.</span>

<span class="sd">    Args:</span>
<span class="sd">        token: The JWT string to decode.</span>
<span class="sd">        expected_type: Expected token type (&quot;access&quot; or &quot;refresh&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Decoded token payload.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If token is invalid, expired, or wrong type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="n">token</span><span class="p">,</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">JWT_SECRET_KEY</span><span class="p">,</span>
            <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">JWT_ALGORITHM</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">ExpiredSignatureError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Token has expired&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">JWTError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid token: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Validate token type</span>
    <span class="n">token_type</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">token_type</span> <span class="o">!=</span> <span class="n">expected_type</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid token type: expected </span><span class="si">{</span><span class="n">expected_type</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">token_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Validate required fields</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Token missing subject claim&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">TokenPayload</span><span class="p">(</span>
        <span class="n">sub</span><span class="o">=</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">],</span>
        <span class="n">role</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
        <span class="n">exp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">],</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
        <span class="n">iat</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;iat&quot;</span><span class="p">],</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
        <span class="n">jti</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jti&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="5-rbac">5. ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (RBAC)<a class="header-link" href="#5-rbac" title="Permanent link">&para;</a></h2>
<h3 id="51-rbac">5.1 RBAC ì„¤ê³„<a class="header-link" href="#51-rbac" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RBAC Permission Matrix                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Role         Permissions                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚  admin        users:read, users:write, users:delete,            â”‚
â”‚               admin:read, admin:write, system:manage             â”‚
â”‚                                                                  â”‚
â”‚  moderator    users:read, users:write,                           â”‚
â”‚               content:read, content:write, content:delete        â”‚
â”‚                                                                  â”‚
â”‚  user         self:read, self:write,                             â”‚
â”‚               content:read, content:write                        â”‚
â”‚                                                                  â”‚
â”‚  viewer       self:read, content:read                            â”‚
â”‚                                                                  â”‚
â”‚                                                                  â”‚
â”‚  Endpoint              Required Permission     Roles Allowed     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  GET  /users           users:read              admin, moderator  â”‚
â”‚  POST /users           users:write             admin             â”‚
â”‚  GET  /users/me        self:read               all               â”‚
â”‚  PUT  /users/me        self:write              all               â”‚
â”‚  DEL  /users/{id}      users:delete            admin             â”‚
â”‚  GET  /admin/stats     admin:read              admin             â”‚
â”‚  POST /admin/config    admin:write             admin             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="52-rbac">5.2 RBAC êµ¬í˜„<a class="header-link" href="#52-rbac" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/utils/security.py - RBAC and authentication dependencies.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">Request</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPBearer</span><span class="p">,</span> <span class="n">HTTPAuthorizationCredentials</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.services.token_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">decode_token</span><span class="p">,</span> <span class="n">TokenPayload</span>


<span class="c1"># â”€â”€â”€ Role and Permission Definitions â”€â”€â”€</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Role</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;User roles in order of privilege.&quot;&quot;&quot;</span>
    <span class="n">ADMIN</span> <span class="o">=</span> <span class="s2">&quot;admin&quot;</span>
    <span class="n">MODERATOR</span> <span class="o">=</span> <span class="s2">&quot;moderator&quot;</span>
    <span class="n">USER</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
    <span class="n">VIEWER</span> <span class="o">=</span> <span class="s2">&quot;viewer&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Permission</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fine-grained permissions.&quot;&quot;&quot;</span>
    <span class="n">USERS_READ</span> <span class="o">=</span> <span class="s2">&quot;users:read&quot;</span>
    <span class="n">USERS_WRITE</span> <span class="o">=</span> <span class="s2">&quot;users:write&quot;</span>
    <span class="n">USERS_DELETE</span> <span class="o">=</span> <span class="s2">&quot;users:delete&quot;</span>
    <span class="n">SELF_READ</span> <span class="o">=</span> <span class="s2">&quot;self:read&quot;</span>
    <span class="n">SELF_WRITE</span> <span class="o">=</span> <span class="s2">&quot;self:write&quot;</span>
    <span class="n">CONTENT_READ</span> <span class="o">=</span> <span class="s2">&quot;content:read&quot;</span>
    <span class="n">CONTENT_WRITE</span> <span class="o">=</span> <span class="s2">&quot;content:write&quot;</span>
    <span class="n">CONTENT_DELETE</span> <span class="o">=</span> <span class="s2">&quot;content:delete&quot;</span>
    <span class="n">ADMIN_READ</span> <span class="o">=</span> <span class="s2">&quot;admin:read&quot;</span>
    <span class="n">ADMIN_WRITE</span> <span class="o">=</span> <span class="s2">&quot;admin:write&quot;</span>
    <span class="n">SYSTEM_MANAGE</span> <span class="o">=</span> <span class="s2">&quot;system:manage&quot;</span>


<span class="c1"># Role â†’ Permissions mapping</span>
<span class="n">ROLE_PERMISSIONS</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Role</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="n">Permission</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Role</span><span class="o">.</span><span class="n">ADMIN</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">USERS_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">USERS_WRITE</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">USERS_DELETE</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">SELF_READ</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">SELF_WRITE</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_READ</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_WRITE</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_DELETE</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">ADMIN_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">ADMIN_WRITE</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">SYSTEM_MANAGE</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">Role</span><span class="o">.</span><span class="n">MODERATOR</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">USERS_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">USERS_WRITE</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">SELF_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">SELF_WRITE</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_WRITE</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_DELETE</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">Role</span><span class="o">.</span><span class="n">USER</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">SELF_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">SELF_WRITE</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_WRITE</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">Role</span><span class="o">.</span><span class="n">VIEWER</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">SELF_READ</span><span class="p">,</span> <span class="n">Permission</span><span class="o">.</span><span class="n">CONTENT_READ</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">has_permission</span><span class="p">(</span><span class="n">role</span><span class="p">:</span> <span class="n">Role</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="n">Permission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a role has a specific permission.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">permission</span> <span class="ow">in</span> <span class="n">ROLE_PERMISSIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>


<span class="c1"># â”€â”€â”€ FastAPI Dependencies â”€â”€â”€</span>

<span class="n">security_scheme</span> <span class="o">=</span> <span class="n">HTTPBearer</span><span class="p">(</span>
    <span class="n">scheme_name</span><span class="o">=</span><span class="s2">&quot;JWT&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enter your JWT access token&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
    <span class="n">credentials</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
        <span class="n">HTTPAuthorizationCredentials</span><span class="p">,</span>
        <span class="n">Depends</span><span class="p">(</span><span class="n">security_scheme</span><span class="p">)</span>
    <span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenPayload</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dependency: Extract and validate JWT from Authorization header.</span>
<span class="sd">    Returns the decoded token payload.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">credentials</span><span class="p">,</span> <span class="n">expected_type</span><span class="o">=</span><span class="s2">&quot;access&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid or expired token&quot;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">},</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">payload</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_role</span><span class="p">(</span><span class="o">*</span><span class="n">allowed_roles</span><span class="p">:</span> <span class="n">Role</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dependency factory: Require user to have one of the specified roles.</span>

<span class="sd">    Usage:</span>
<span class="sd">        @router.get(&quot;/admin&quot;, dependencies=[Depends(require_role(Role.ADMIN))])</span>
<span class="sd">        async def admin_endpoint():</span>
<span class="sd">            ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">role_checker</span><span class="p">(</span>
        <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">TokenPayload</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenPayload</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_role</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">role</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid role&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">user_role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_roles</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Insufficient permissions&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">current_user</span>

    <span class="k">return</span> <span class="n">role_checker</span>


<span class="k">def</span><span class="w"> </span><span class="nf">require_permission</span><span class="p">(</span><span class="n">permission</span><span class="p">:</span> <span class="n">Permission</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dependency factory: Require user to have a specific permission.</span>

<span class="sd">    Usage:</span>
<span class="sd">        @router.delete(&quot;/users/{id}&quot;,</span>
<span class="sd">                       dependencies=[Depends(require_permission(Permission.USERS_DELETE))])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">permission_checker</span><span class="p">(</span>
        <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">TokenPayload</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenPayload</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_role</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">role</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid role&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_permission</span><span class="p">(</span><span class="n">user_role</span><span class="p">,</span> <span class="n">permission</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Insufficient permissions&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">current_user</span>

    <span class="k">return</span> <span class="n">permission_checker</span>


<span class="c1"># Type alias for convenience</span>
<span class="n">CurrentUser</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">TokenPayload</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]</span>
</code></pre></div>

<hr />
<h2 id="6-pydantic">6. Pydanticì„ ì‚¬ìš©í•œ ì…ë ¥ ê²€ì¦<a class="header-link" href="#6-pydantic" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 ì‚¬ìš©ì ìŠ¤í‚¤ë§ˆ<a class="header-link" href="#61" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/schemas/user.py - Pydantic schemas for user data validation.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseModel</span><span class="p">,</span>
    <span class="n">EmailStr</span><span class="p">,</span>
    <span class="n">Field</span><span class="p">,</span>
    <span class="n">field_validator</span><span class="p">,</span>
    <span class="n">model_validator</span><span class="p">,</span>
    <span class="n">ConfigDict</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserCreate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Schema for user registration.&quot;&quot;&quot;</span>

    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span>
        <span class="n">min_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_-]+$&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Username (alphanumeric, underscores, hyphens only)&quot;</span><span class="p">,</span>
        <span class="n">examples</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;john_doe&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Valid email address&quot;</span><span class="p">,</span>
        <span class="n">examples</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span>
        <span class="n">min_length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Password (min 8 chars, must include upper, lower, digit, special)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">full_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Full name (optional)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">username_not_reserved</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure username is not a reserved name.&quot;&quot;&quot;</span>
        <span class="n">reserved</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;administrator&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span>
            <span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="s1">&#39;www&#39;</span><span class="p">,</span> <span class="s1">&#39;mail&#39;</span><span class="p">,</span> <span class="s1">&#39;support&#39;</span><span class="p">,</span> <span class="s1">&#39;help&#39;</span><span class="p">,</span>
            <span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="s1">&#39;undefined&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">reserved</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Username &#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39; is reserved&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">email_normalize</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize email to lowercase.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s1">&#39;full_name&#39;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sanitize_full_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sanitize full name to prevent injection.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;[^&gt;]*&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\x00-\x1f\x7f-\x9f]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserUpdate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Schema for updating user profile.&quot;&quot;&quot;</span>

    <span class="n">full_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span>
    <span class="p">)</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EmailStr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s1">&#39;full_name&#39;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sanitize_full_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;[^&gt;]*&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\x00-\x1f\x7f-\x9f]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Schema for user data in responses. Never include password hash.&quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">full_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">from_attributes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserListResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Paginated user list response.&quot;&quot;&quot;</span>
    <span class="n">users</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">UserResponse</span><span class="p">]</span>
    <span class="n">total</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">page</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">per_page</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">pages</span><span class="p">:</span> <span class="nb">int</span>


<span class="k">class</span><span class="w"> </span><span class="nc">PasswordChange</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Schema for password change request.&quot;&quot;&quot;</span>

    <span class="n">current_password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">new_password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;after&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">passwords_different</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure new password differs from current.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_password</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_password</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;New password must be different from current password&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>

<h3 id="62">6.2 ì¸ì¦ ìŠ¤í‚¤ë§ˆ<a class="header-link" href="#62" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/schemas/auth.py - Authentication request/response schemas.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span><span class="p">,</span> <span class="n">Field</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LoginRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Login request schema.&quot;&quot;&quot;</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TokenResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Token response after successful authentication.&quot;&quot;&quot;</span>
    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bearer&quot;</span>
    <span class="n">expires_in</span><span class="p">:</span> <span class="nb">int</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RefreshRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Token refresh request.&quot;&quot;&quot;</span>
    <span class="n">refresh_token</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MessageResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generic message response.&quot;&quot;&quot;</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</code></pre></div>

<hr />
<h2 id="7">7. ë¯¸ë“¤ì›¨ì–´: ì†ë„ ì œí•œ<a class="header-link" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 ì†ë„ ì œí•œê¸°<a class="header-link" href="#71" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/middleware/rate_limiter.py - Rate limiting middleware.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">slowapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Limiter</span><span class="p">,</span> <span class="n">_rate_limit_exceeded_handler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">slowapi.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_remote_address</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">slowapi.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">RateLimitExceeded</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_client_ip</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    í”„ë¡ì‹œ í—¤ë”ë¥¼ ê³ ë ¤í•˜ì—¬ ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ IPë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.</span>

<span class="sd">    ì¤‘ìš”: ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” í”„ë¡ì‹œ ë’¤ì— ìˆì„ ë•Œë§Œ X-Forwarded-Forë¥¼ ì‹ ë¢°í•˜ì„¸ìš”.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">forwarded_for</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Forwarded-For&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">forwarded_for</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">forwarded_for</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span>

    <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>


<span class="n">limiter</span> <span class="o">=</span> <span class="n">Limiter</span><span class="p">(</span>
    <span class="n">key_func</span><span class="o">=</span><span class="n">get_client_ip</span><span class="p">,</span>
    <span class="n">default_limits</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;60/minute&quot;</span><span class="p">],</span>
    <span class="n">storage_uri</span><span class="o">=</span><span class="s2">&quot;memory://&quot;</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="8">8. ë¯¸ë“¤ì›¨ì–´: ë³´ì•ˆ í—¤ë”<a class="header-link" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 ë³´ì•ˆ í—¤ë” ë¯¸ë“¤ì›¨ì–´<a class="header-link" href="#81" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/middleware/security_headers.py - Add security headers to all responses.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">starlette.middleware.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseHTTPMiddleware</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SecurityHeadersMiddleware</span><span class="p">(</span><span class="n">BaseHTTPMiddleware</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ëª¨ë“  ì‘ë‹µì— ë³´ì•ˆ í—¤ë”ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># í´ë¦­ì¬í‚¹ ë°©ì§€</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Frame-Options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DENY&quot;</span>

        <span class="c1"># MIME íƒ€ì… ìŠ¤ë‹ˆí•‘ ë°©ì§€</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Content-Type-Options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;nosniff&quot;</span>

        <span class="c1"># ë¦¬í¼ëŸ¬ ì •ë³´ ì œì–´</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Referrer-Policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;strict-origin-when-cross-origin&quot;</span>

        <span class="c1"># ì½˜í…ì¸  ë³´ì•ˆ ì •ì±…</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Security-Policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;default-src &#39;none&#39;; &quot;</span>
            <span class="s2">&quot;frame-ancestors &#39;none&#39;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># ê¶Œí•œ ì •ì±… (ë¶ˆí•„ìš”í•œ ë¸Œë¼ìš°ì € ê¸°ëŠ¥ ë¹„í™œì„±í™”)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Permissions-Policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;camera=(), &quot;</span>
            <span class="s2">&quot;microphone=(), &quot;</span>
            <span class="s2">&quot;geolocation=(), &quot;</span>
            <span class="s2">&quot;payment=()&quot;</span>
        <span class="p">)</span>

        <span class="c1"># HSTS (HTTPS ì „ìš©)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Strict-Transport-Security&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;max-age=31536000; includeSubDomains&quot;</span>
        <span class="p">)</span>

        <span class="c1"># ì¸ì¦ëœ ì‘ë‹µì˜ ìºì‹± ë°©ì§€</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Authorization&quot;</span><span class="p">):</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Cache-Control&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;no-store, no-cache, must-revalidate, private&quot;</span>
            <span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Pragma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;no-cache&quot;</span>

        <span class="c1"># ì„œë²„ ì‹ë³„ í—¤ë” ì œê±°</span>
        <span class="k">if</span> <span class="s2">&quot;server&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<hr />
<h2 id="9">9. ë¯¸ë“¤ì›¨ì–´: ìš”ì²­ ë¡œê¹…<a class="header-link" href="#9" title="Permanent link">&para;</a></h2>
<h3 id="91">9.1 êµ¬ì¡°í™”ëœ ë³´ì•ˆ ë¡œê¹…<a class="header-link" href="#91" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/utils/logging.py - Structured security logging.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">structlog</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_settings</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">setup_logging</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;êµ¬ì¡°í™”ëœ ë¡œê¹…ì„ ì„¤ì •í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
    <span class="n">structlog</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="n">processors</span><span class="o">=</span><span class="p">[</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">contextvars</span><span class="o">.</span><span class="n">merge_contextvars</span><span class="p">,</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">filter_by_level</span><span class="p">,</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">add_logger_name</span><span class="p">,</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">add_log_level</span><span class="p">,</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">PositionalArgumentsFormatter</span><span class="p">(),</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">processors</span><span class="o">.</span><span class="n">TimeStamper</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;iso&quot;</span><span class="p">),</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">processors</span><span class="o">.</span><span class="n">StackInfoRenderer</span><span class="p">(),</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">processors</span><span class="o">.</span><span class="n">UnicodeDecoder</span><span class="p">(),</span>
            <span class="n">structlog</span><span class="o">.</span><span class="n">processors</span><span class="o">.</span><span class="n">JSONRenderer</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">LOG_FORMAT</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span>
            <span class="k">else</span> <span class="n">structlog</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">ConsoleRenderer</span><span class="p">(),</span>
        <span class="p">],</span>
        <span class="n">wrapper_class</span><span class="o">=</span><span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">BoundLogger</span><span class="p">,</span>
        <span class="n">context_class</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
        <span class="n">logger_factory</span><span class="o">=</span><span class="n">structlog</span><span class="o">.</span><span class="n">PrintLoggerFactory</span><span class="p">(),</span>
        <span class="n">cache_logger_on_first_use</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_security_logger</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">structlog</span><span class="o">.</span><span class="n">BoundLogger</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ë³´ì•ˆ ì´ë²¤íŠ¸ìš© ë¡œê±°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;security&quot;</span><span class="p">)</span>


<span class="c1"># â”€â”€â”€ ë³´ì•ˆ ì´ë²¤íŠ¸ë³„ ë¡œê±° â”€â”€â”€</span>

<span class="k">def</span><span class="w"> </span><span class="nf">log_authentication_event</span><span class="p">(</span>
    <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ì¸ì¦ ì´ë²¤íŠ¸ë¥¼ ë¡œê¹…í•©ë‹ˆë‹¤ (ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒ, í† í° ê°±ì‹ ).</span>

<span class="sd">    ì¤‘ìš”: ë¹„ë°€ë²ˆí˜¸ë‚˜ í† í°ì€ ì ˆëŒ€ ë¡œê¹…í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
    <span class="n">log_func</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="n">logger</span><span class="o">.</span><span class="n">warning</span>

    <span class="n">log_func</span><span class="p">(</span>
        <span class="s2">&quot;authentication_event&quot;</span><span class="p">,</span>
        <span class="n">event_type</span><span class="o">=</span><span class="n">event_type</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="n">_mask_email</span><span class="p">(</span><span class="n">email</span><span class="p">),</span>
        <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
        <span class="n">user_agent</span><span class="o">=</span><span class="n">user_agent</span><span class="p">[:</span><span class="mi">200</span><span class="p">],</span>
        <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">log_authorization_event</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">granted</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì¸ê°€ ê²°ì •ì„ ë¡œê¹…í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
    <span class="n">log_func</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="k">if</span> <span class="n">granted</span> <span class="k">else</span> <span class="n">logger</span><span class="o">.</span><span class="n">warning</span>

    <span class="n">log_func</span><span class="p">(</span>
        <span class="s2">&quot;authorization_event&quot;</span><span class="p">,</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
        <span class="n">granted</span><span class="o">=</span><span class="n">granted</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">log_security_violation</span><span class="p">(</span>
    <span class="n">violation_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">details</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">severity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;HIGH&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ë³´ì•ˆ ìœ„ë°˜ì„ ë¡œê¹…í•©ë‹ˆë‹¤ (ì†ë„ ì œí•œ, ë¬´íš¨ í† í° ë“±).&quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="s2">&quot;security_violation&quot;</span><span class="p">,</span>
        <span class="n">violation_type</span><span class="o">=</span><span class="n">violation_type</span><span class="p">,</span>
        <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">severity</span><span class="o">=</span><span class="n">severity</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">log_data_access</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">resource_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">resource_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ê°ì‚¬ ì¶”ì ì„ ìœ„í•œ ë°ì´í„° ì ‘ê·¼ì„ ë¡œê¹…í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;data_access&quot;</span><span class="p">,</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">resource_type</span><span class="o">=</span><span class="n">resource_type</span><span class="p">,</span>
        <span class="n">resource_id</span><span class="o">=</span><span class="n">resource_id</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_mask_email</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ë¡œê¹…ìš© ì´ë©”ì¼ ë§ˆìŠ¤í‚¹ (ì²« ê¸€ìì™€ ë„ë©”ì¸ë§Œ í‘œì‹œ).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;@&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">email</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;***&#39;</span>
    <span class="n">local</span><span class="p">,</span> <span class="n">domain</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">masked_local</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">masked_local</span> <span class="o">=</span> <span class="n">local</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">masked_local</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<h3 id="92">9.2 ìš”ì²­ ë¡œê¹… ë¯¸ë“¤ì›¨ì–´<a class="header-link" href="#92" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/middleware/request_logging.py - Log all HTTP requests.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">starlette.middleware.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseHTTPMiddleware</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_security_logger</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RequestLoggingMiddleware</span><span class="p">(</span><span class="n">BaseHTTPMiddleware</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ëª¨ë“  HTTP ìš”ì²­ì„ íƒ€ì´ë° ë° ë³´ì•ˆ ê´€ë ¨ ì •ë³´ì™€ í•¨ê»˜ ë¡œê¹…í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Request-ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_id</span>

        <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
        <span class="n">log_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="n">request_id</span><span class="p">,</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">)</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="s2">&quot;duration_ms&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
            <span class="s2">&quot;user_agent&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user-agent&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)[:</span><span class="mi">200</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;http_request&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">log_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;http_request&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">log_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;http_request&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">log_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<hr />
<h2 id="10">10. ì •ë³´ ìœ ì¶œ ì—†ëŠ” ì—ëŸ¬ ì²˜ë¦¬<a class="header-link" href="#10" title="Permanent link">&para;</a></h2>
<h3 id="101">10.1 ì•ˆì „í•œ ì—ëŸ¬ ì²˜ë¦¬<a class="header-link" href="#101" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/main.py - Application setup with safe error handling.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestValidationError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">slowapi.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">RateLimitExceeded</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.middleware.security_headers</span><span class="w"> </span><span class="kn">import</span> <span class="n">SecurityHeadersMiddleware</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.middleware.rate_limiter</span><span class="w"> </span><span class="kn">import</span> <span class="n">limiter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.middleware.request_logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestLoggingMiddleware</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.routers</span><span class="w"> </span><span class="kn">import</span> <span class="n">auth</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">admin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_logging</span><span class="p">,</span> <span class="n">get_security_logger</span><span class="p">,</span> <span class="n">log_security_violation</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">()</span>


<span class="nd">@asynccontextmanager</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘/ì¢…ë£Œ ì´ë²¤íŠ¸.&quot;&quot;&quot;</span>
    <span class="n">setup_logging</span><span class="p">()</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;application_start&quot;</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ENVIRONMENT</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;application_shutdown&quot;</span><span class="p">)</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">APP_NAME</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">APP_VERSION</span><span class="p">,</span>
    <span class="n">docs_url</span><span class="o">=</span><span class="s2">&quot;/docs&quot;</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">redoc_url</span><span class="o">=</span><span class="s2">&quot;/redoc&quot;</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">openapi_url</span><span class="o">=</span><span class="s2">&quot;/openapi.json&quot;</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lifespan</span><span class="o">=</span><span class="n">lifespan</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># â”€â”€â”€ ë¯¸ë“¤ì›¨ì–´ (ìˆœì„œ ì¤‘ìš”: ë§ˆì§€ë§‰ì— ì¶”ê°€ëœ ê²ƒì´ ë¨¼ì € ì‹¤í–‰) â”€â”€â”€</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">RequestLoggingMiddleware</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">SecurityHeadersMiddleware</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
    <span class="n">CORSMiddleware</span><span class="p">,</span>
    <span class="n">allow_origins</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CORS_ORIGINS</span><span class="p">,</span>
    <span class="n">allow_credentials</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CORS_ALLOW_CREDENTIALS</span><span class="p">,</span>
    <span class="n">allow_methods</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CORS_ALLOW_METHODS</span><span class="p">,</span>
    <span class="n">allow_headers</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CORS_ALLOW_HEADERS</span><span class="p">,</span>
    <span class="n">expose_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X-Request-ID&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">limiter</span> <span class="o">=</span> <span class="n">limiter</span>


<span class="c1"># â”€â”€â”€ ì—ëŸ¬ í•¸ë“¤ëŸ¬ â”€â”€â”€</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">RateLimitExceeded</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rate_limit_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">RateLimitExceeded</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì†ë„ ì œí•œ ì´ˆê³¼ ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">log_security_violation</span><span class="p">(</span>
        <span class="n">violation_type</span><span class="o">=</span><span class="s2">&quot;RATE_LIMIT_EXCEEDED&quot;</span><span class="p">,</span>
        <span class="n">details</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Rate limit exceeded on </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;rate_limit_exceeded&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Too many requests. Please try again later.&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Retry-After&quot;</span><span class="p">:</span> <span class="s2">&quot;60&quot;</span><span class="p">},</span>
    <span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">RequestValidationError</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validation_error_handler</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">RequestValidationError</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ê²€ì¦ ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.</span>

<span class="sd">    ì¤‘ìš”: ì¼ë°˜ì ì¸ ë©”ì‹œì§€ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ê³µê²©ìê°€ í˜ì´ë¡œë“œë¥¼ ë§Œë“œëŠ” ë°</span>
<span class="sd">    ë„ì›€ì´ ë  ìˆ˜ ìˆëŠ” ë‚´ë¶€ ê²€ì¦ ì„¸ë¶€ì‚¬í•­ì„ ë…¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
        <span class="s2">&quot;validation_error&quot;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
        <span class="n">errors</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">errors</span><span class="p">())[:</span><span class="mi">500</span><span class="p">],</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_422_UNPROCESSABLE_ENTITY</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;validation_error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Request validation failed&quot;</span><span class="p">,</span>
                <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">err</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">]),</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">err</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">exc</span><span class="o">.</span><span class="n">errors</span><span class="p">()</span>
                <span class="p">],</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_422_UNPROCESSABLE_ENTITY</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;validation_error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid request data&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">general_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    í¬ê´„ì  ì—ëŸ¬ í•¸ë“¤ëŸ¬.</span>

<span class="sd">    ì¤‘ìš”: ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤, ë‚´ë¶€ ê²½ë¡œ, ë°ì´í„°ë² ì´ìŠ¤ ì„¸ë¶€ì‚¬í•­ ë˜ëŠ”</span>
<span class="sd">    êµ¬í˜„ ì„¸ë¶€ì‚¬í•­ì„ í´ë¼ì´ì–¸íŠ¸ì— ì ˆëŒ€ ë…¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_security_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="s2">&quot;unhandled_exception&quot;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
        <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="n">error_message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)[:</span><span class="mi">500</span><span class="p">],</span>
        <span class="n">traceback</span><span class="o">=</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()[:</span><span class="mi">2000</span><span class="p">],</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;internal_server_error&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;An unexpected error occurred. Please try again later.&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>


<span class="c1"># â”€â”€â”€ ë¼ìš°í„° â”€â”€â”€</span>

<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1/auth&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Authentication&quot;</span><span class="p">])</span>
<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1/users&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Users&quot;</span><span class="p">])</span>
<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1/admin&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Admin&quot;</span><span class="p">])</span>


<span class="c1"># â”€â”€â”€ í—¬ìŠ¤ ì²´í¬ â”€â”€â”€</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Health&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ê³µê°œ í—¬ìŠ¤ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ (ì¸ì¦ ë¶ˆí•„ìš”).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">APP_VERSION</span><span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="11_1">11. ì¸ì¦ ì—”ë“œí¬ì¸íŠ¸<a class="header-link" href="#11_1" title="Permanent link">&para;</a></h2>
<h3 id="111">11.1 ì¸ì¦ ë¼ìš°í„°<a class="header-link" href="#111" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/routers/auth.py - Authentication endpoints.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSession</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_db</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.middleware.rate_limiter</span><span class="w"> </span><span class="kn">import</span> <span class="n">limiter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.schemas.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoginRequest</span><span class="p">,</span> <span class="n">TokenResponse</span><span class="p">,</span> <span class="n">MessageResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.schemas.user</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserCreate</span><span class="p">,</span> <span class="n">UserResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.services.auth_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">AuthService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_authentication_event</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils.password</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_password_strength</span><span class="p">,</span> <span class="n">PasswordStrengthError</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">()</span>
<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s2">&quot;/register&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">UserResponse</span><span class="p">,</span>
    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">REGISTER_RATE_LIMIT</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">user_data</span><span class="p">:</span> <span class="n">UserCreate</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ìƒˆ ì‚¬ìš©ì ê³„ì •ì„ ë“±ë¡í•©ë‹ˆë‹¤.</span>

<span class="sd">    ë‚¨ìš© ë°©ì§€ë¥¼ ìœ„í•´ ì†ë„ ì œí•œì´ ì ìš©ë©ë‹ˆë‹¤.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">validate_password_strength</span><span class="p">(</span><span class="n">user_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">PasswordStrengthError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="n">auth_service</span> <span class="o">=</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="n">existing</span> <span class="o">=</span> <span class="k">await</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">get_user_by_email</span><span class="p">(</span><span class="n">user_data</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
        <span class="c1"># ì¤‘ìš”: ì´ë©”ì¼ ì¡´ì¬ ì—¬ë¶€ë¥¼ ë…¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</span>
        <span class="c1"># ì‚¬ìš©ì ì—´ê±°ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì¼ë°˜ì ì¸ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Unable to create account with provided information&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">log_authentication_event</span><span class="p">(</span>
        <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;registration&quot;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="n">user_data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
        <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
        <span class="n">user_agent</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user-agent&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">user</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">TokenResponse</span><span class="p">)</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOGIN_RATE_LIMIT</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">login_data</span><span class="p">:</span> <span class="n">LoginRequest</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ì‚¬ìš©ìë¥¼ ì¸ì¦í•˜ê³  JWT í† í°ì„ ë°˜í™˜í•©ë‹ˆë‹¤.</span>

<span class="sd">    ì•¡ì„¸ìŠ¤ í† í°ì€ ì‘ë‹µ ë³¸ë¬¸ì—, ë¦¬í”„ë ˆì‹œ í† í°ì€ HTTP-only ì¿ í‚¤ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">user_agent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user-agent&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">auth_service</span> <span class="o">=</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span>
        <span class="n">login_data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">login_data</span><span class="o">.</span><span class="n">password</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">log_authentication_event</span><span class="p">(</span>
            <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;login&quot;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="n">login_data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
            <span class="n">user_agent</span><span class="o">=</span><span class="n">user_agent</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;invalid_credentials&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># ì¤‘ìš”: ì¼ë°˜ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ - ì´ë©”ì¼ ì¡´ì¬ ì—¬ë¶€ë‚˜</span>
        <span class="c1"># ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜ë¥¼ ë…¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid email or password&quot;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">},</span>
        <span class="p">)</span>

    <span class="n">user</span><span class="p">,</span> <span class="n">token_pair</span> <span class="o">=</span> <span class="n">result</span>

    <span class="c1"># ë¦¬í”„ë ˆì‹œ í† í°ì„ HTTP-only ë³´ì•ˆ ì¿ í‚¤ë¡œ ì„¤ì •</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">token_pair</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">,</span>
        <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>             <span class="c1"># JavaScript ì ‘ê·¼ ë¶ˆê°€</span>
        <span class="n">secure</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SECURE_COOKIES</span><span class="p">,</span>  <span class="c1"># í”„ë¡œë•ì…˜ì—ì„œ HTTPS ì „ìš©</span>
        <span class="n">samesite</span><span class="o">=</span><span class="s2">&quot;lax&quot;</span><span class="p">,</span>           <span class="c1"># CSRF ë³´í˜¸</span>
        <span class="n">max_age</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REFRESH_TOKEN_EXPIRE_DAYS</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/v1/auth&quot;</span><span class="p">,</span>      <span class="c1"># ì¸ì¦ ì—”ë“œí¬ì¸íŠ¸ì—ë§Œ ì „ì†¡</span>
    <span class="p">)</span>

    <span class="n">log_authentication_event</span><span class="p">(</span>
        <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;login&quot;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="n">login_data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
        <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
        <span class="n">user_agent</span><span class="o">=</span><span class="n">user_agent</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">TokenResponse</span><span class="p">(</span>
        <span class="n">access_token</span><span class="o">=</span><span class="n">token_pair</span><span class="o">.</span><span class="n">access_token</span><span class="p">,</span>
        <span class="n">expires_in</span><span class="o">=</span><span class="n">token_pair</span><span class="o">.</span><span class="n">expires_in</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/refresh&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">TokenResponse</span><span class="p">)</span>
<span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="s2">&quot;10/minute&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">refresh_token</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ì¿ í‚¤ì˜ ë¦¬í”„ë ˆì‹œ í† í°ì„ ì‚¬ìš©í•˜ì—¬ ì•¡ì„¸ìŠ¤ í† í°ì„ ê°±ì‹ í•©ë‹ˆë‹¤.</span>

<span class="sd">    í† í° ë¡œí…Œì´ì…˜ êµ¬í˜„: ê¸°ì¡´ ë¦¬í”„ë ˆì‹œ í† í°ì€ ë¬´íš¨í™”ë˜ê³ </span>
<span class="sd">    ìƒˆ ë¦¬í”„ë ˆì‹œ í† í°ì´ ë°œê¸‰ë©ë‹ˆë‹¤.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh_token</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Refresh token not found&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">auth_service</span> <span class="o">=</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">refresh_tokens</span><span class="p">(</span><span class="n">refresh_token</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/v1/auth&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid or expired refresh token&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">new_token_pair</span> <span class="o">=</span> <span class="n">result</span>

    <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">new_token_pair</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">,</span>
        <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">secure</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SECURE_COOKIES</span><span class="p">,</span>
        <span class="n">samesite</span><span class="o">=</span><span class="s2">&quot;lax&quot;</span><span class="p">,</span>
        <span class="n">max_age</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REFRESH_TOKEN_EXPIRE_DAYS</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/v1/auth&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">TokenResponse</span><span class="p">(</span>
        <span class="n">access_token</span><span class="o">=</span><span class="n">new_token_pair</span><span class="o">.</span><span class="n">access_token</span><span class="p">,</span>
        <span class="n">expires_in</span><span class="o">=</span><span class="n">new_token_pair</span><span class="o">.</span><span class="n">expires_in</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/logout&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">MessageResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ë¡œê·¸ì•„ì›ƒ: ë¦¬í”„ë ˆì‹œ í† í°ì„ íê¸°í•˜ê³  ì¿ í‚¤ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_token</span><span class="p">:</span>
        <span class="n">auth_service</span> <span class="o">=</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">revoke_refresh_token</span><span class="p">(</span><span class="n">refresh_token</span><span class="p">)</span>

    <span class="n">response</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/v1/auth&quot;</span><span class="p">)</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">log_authentication_event</span><span class="p">(</span>
        <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;logout&quot;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
        <span class="n">user_agent</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user-agent&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">MessageResponse</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Successfully logged out&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="12_1">12. ì‚¬ìš©ì ì—”ë“œí¬ì¸íŠ¸<a class="header-link" href="#12_1" title="Permanent link">&para;</a></h2>
<h3 id="121">12.1 ì‚¬ìš©ì ë¼ìš°í„°<a class="header-link" href="#121" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app/routers/users.py - User management endpoints.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSession</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_db</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.schemas.user</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">UserResponse</span><span class="p">,</span> <span class="n">UserUpdate</span><span class="p">,</span> <span class="n">UserListResponse</span><span class="p">,</span> <span class="n">PasswordChange</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.services.user_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CurrentUser</span><span class="p">,</span> <span class="n">require_role</span><span class="p">,</span> <span class="n">require_permission</span><span class="p">,</span>
    <span class="n">Role</span><span class="p">,</span> <span class="n">Permission</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils.password</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_password_strength</span><span class="p">,</span> <span class="n">PasswordStrengthError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_data_access</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="c1"># â”€â”€â”€ ì…€í”„ ì„œë¹„ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ (ì¸ì¦ëœ ëª¨ë“  ì‚¬ìš©ì) â”€â”€â”€</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/me&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">UserResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user_profile</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">CurrentUser</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;í˜„ì¬ ì‚¬ìš©ìì˜ í”„ë¡œí•„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.&quot;&quot;&quot;</span>
    <span class="n">user_service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User not found&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">user</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;/me&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">UserResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_current_user_profile</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">update_data</span><span class="p">:</span> <span class="n">UserUpdate</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">CurrentUser</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;í˜„ì¬ ì‚¬ìš©ìì˜ í”„ë¡œí•„ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
    <span class="n">user_service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_service</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span> <span class="n">update_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User not found&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">log_data_access</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
        <span class="n">resource_type</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="n">resource_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;update_profile&quot;</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">user</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/me/change-password&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">change_password</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">password_data</span><span class="p">:</span> <span class="n">PasswordChange</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">CurrentUser</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;í˜„ì¬ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">validate_password_strength</span><span class="p">(</span><span class="n">password_data</span><span class="o">.</span><span class="n">new_password</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">PasswordStrengthError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="n">user_service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_service</span><span class="o">.</span><span class="n">change_password</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
        <span class="n">current_password</span><span class="o">=</span><span class="n">password_data</span><span class="o">.</span><span class="n">current_password</span><span class="p">,</span>
        <span class="n">new_password</span><span class="o">=</span><span class="n">password_data</span><span class="o">.</span><span class="n">new_password</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Current password is incorrect&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">log_data_access</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
        <span class="n">resource_type</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="n">resource_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;change_password&quot;</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Password changed successfully&quot;</span><span class="p">}</span>


<span class="c1"># â”€â”€â”€ ê´€ë¦¬ì ì—”ë“œí¬ì¸íŠ¸ â”€â”€â”€</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s2">&quot;/&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">UserListResponse</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">require_permission</span><span class="p">(</span><span class="n">Permission</span><span class="o">.</span><span class="n">USERS_READ</span><span class="p">))],</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_users</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">per_page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">CurrentUser</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ëª¨ë“  ì‚¬ìš©ìë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤ (ê´€ë¦¬ì/ëª¨ë”ë ˆì´í„° ì „ìš©).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">per_page</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">per_page</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="n">user_service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">users</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_service</span><span class="o">.</span><span class="n">list_users</span><span class="p">(</span>
        <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">per_page</span>
    <span class="p">)</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">log_data_access</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
        <span class="n">resource_type</span><span class="o">=</span><span class="s2">&quot;user_list&quot;</span><span class="p">,</span>
        <span class="n">resource_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;page=</span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;list&quot;</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">UserListResponse</span><span class="p">(</span>
        <span class="n">users</span><span class="o">=</span><span class="n">users</span><span class="p">,</span>
        <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span>
        <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
        <span class="n">per_page</span><span class="o">=</span><span class="n">per_page</span><span class="p">,</span>
        <span class="n">pages</span><span class="o">=</span><span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">per_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">per_page</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s2">&quot;/</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">UserResponse</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">require_permission</span><span class="p">(</span><span class="n">Permission</span><span class="o">.</span><span class="n">USERS_READ</span><span class="p">))],</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">CurrentUser</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;íŠ¹ì • ì‚¬ìš©ìë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤ (ê´€ë¦¬ì/ëª¨ë”ë ˆì´í„° ì „ìš©).&quot;&quot;&quot;</span>
    <span class="n">user_service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User not found&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">user</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
    <span class="s2">&quot;/</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">require_permission</span><span class="p">(</span><span class="n">Permission</span><span class="o">.</span><span class="n">USERS_DELETE</span><span class="p">))],</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_user</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">CurrentUser</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì‚¬ìš©ìë¥¼ ì‚­ì œí•©ë‹ˆë‹¤ (ê´€ë¦¬ì ì „ìš©).&quot;&quot;&quot;</span>
    <span class="c1"># ìê¸° ìì‹  ì‚­ì œ ë°©ì§€</span>
    <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Cannot delete your own account via this endpoint&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">user_service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User not found&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">log_data_access</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
        <span class="n">resource_type</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="n">resource_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;User deleted successfully&quot;</span><span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="13_1">13. ë³´ì•ˆ í…ŒìŠ¤íŠ¸<a class="header-link" href="#13_1" title="Permanent link">&para;</a></h2>
<h3 id="131">13.1 í…ŒìŠ¤íŠ¸ ì„¤ì •<a class="header-link" href="#131" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">tests/conftest.py - Test fixtures and configuration.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncGenerator</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest_asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">httpx</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncClient</span><span class="p">,</span> <span class="n">ASGITransport</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">create_async_engine</span><span class="p">,</span>
    <span class="n">async_sessionmaker</span><span class="p">,</span>
    <span class="n">AsyncSession</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">app.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_db</span><span class="p">,</span> <span class="n">Base</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_settings</span>

<span class="n">TEST_DATABASE_URL</span> <span class="o">=</span> <span class="s2">&quot;sqlite+aiosqlite:///./test.db&quot;</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">event_loop</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ë¹„ë™ê¸° í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">loop</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="nd">@pytest_asyncio</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">db_session</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">AsyncSession</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;í…ŒìŠ¤íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span><span class="n">TEST_DATABASE_URL</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">)</span>

    <span class="n">session_factory</span> <span class="o">=</span> <span class="n">async_sessionmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">session_factory</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">session</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>


<span class="nd">@pytest_asyncio</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="n">db_session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">AsyncClient</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì˜ì¡´ì„± ì˜¤ë²„ë¼ì´ë“œê°€ í¬í•¨ëœ í…ŒìŠ¤íŠ¸ HTTP í´ë¼ì´ì–¸íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">override_get_db</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">db_session</span>

    <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">get_db</span><span class="p">]</span> <span class="o">=</span> <span class="n">override_get_db</span>

    <span class="n">transport</span> <span class="o">=</span> <span class="n">ASGITransport</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncClient</span><span class="p">(</span><span class="n">transport</span><span class="o">=</span><span class="n">transport</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;http://test&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">c</span>

    <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<span class="nd">@pytest_asyncio</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">registered_user</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ë“±ë¡ëœ ì‚¬ìš©ìë¥¼ ìƒì„±í•˜ê³  ìê²© ì¦ëª…ì„ ë°˜í™˜í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
    <span class="n">user_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser&quot;</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;TestPass123!&quot;</span><span class="p">,</span>
        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Test User&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/register&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">user_data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="k">return</span> <span class="n">user_data</span>


<span class="nd">@pytest_asyncio</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">auth_headers</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">,</span> <span class="n">registered_user</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ë“±ë¡ëœ ì‚¬ìš©ìì˜ ì¸ì¦ í—¤ë”ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.&quot;&quot;&quot;</span>
    <span class="n">login_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">registered_user</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
        <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">registered_user</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/login&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">login_data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
</code></pre></div>

<h3 id="132">13.2 ë³´ì•ˆ ì „ìš© í…ŒìŠ¤íŠ¸<a class="header-link" href="#132" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">tests/test_security.py - Security-focused tests.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">httpx</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncClient</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestAuthenticationSecurity</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì¸ì¦ ë³´ì•ˆ ì¡°ì¹˜ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_login_wrong_password_generic_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">,</span>
                                                       <span class="n">registered_user</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸ ì‹œ ì¼ë°˜ì ì¸ ì—ëŸ¬ë¥¼ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/login&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">registered_user</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;WrongPassword123!&quot;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>
        <span class="k">assert</span> <span class="s2">&quot;Invalid email or password&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;detail&quot;</span><span class="p">]</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_login_nonexistent_email_generic_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ ì‹œ ë™ì¼í•œ ì—ëŸ¬ë¥¼ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/login&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;nonexistent@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;SomePassword123!&quot;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>
        <span class="k">assert</span> <span class="s2">&quot;Invalid email or password&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;detail&quot;</span><span class="p">]</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_registration_duplicate_email_generic_error</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">,</span> <span class="n">registered_user</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ì¤‘ë³µ ë“±ë¡ ì‹œ ì´ë©”ì¼ ì¡´ì¬ ì—¬ë¶€ë¥¼ ë…¸ì¶œí•˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/register&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;different_user&quot;</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">registered_user</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;NewPassword123!&quot;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
        <span class="k">assert</span> <span class="s2">&quot;Unable to create account&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;detail&quot;</span><span class="p">]</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_weak_password_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ì·¨ì•½í•œ ë¹„ë°€ë²ˆí˜¸ëŠ” ê±°ë¶€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
        <span class="n">weak_passwords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;short1!&quot;</span><span class="p">,</span>          <span class="c1"># ë„ˆë¬´ ì§§ìŒ</span>
            <span class="s2">&quot;alllowercase1!&quot;</span><span class="p">,</span>   <span class="c1"># ëŒ€ë¬¸ì ì—†ìŒ</span>
            <span class="s2">&quot;ALLUPPERCASE1!&quot;</span><span class="p">,</span>   <span class="c1"># ì†Œë¬¸ì ì—†ìŒ</span>
            <span class="s2">&quot;NoDigitsHere!&quot;</span><span class="p">,</span>    <span class="c1"># ìˆ«ì ì—†ìŒ</span>
            <span class="s2">&quot;NoSpecial123&quot;</span><span class="p">,</span>     <span class="c1"># íŠ¹ìˆ˜ë¬¸ì ì—†ìŒ</span>
            <span class="s2">&quot;password123!&quot;</span><span class="p">,</span>     <span class="c1"># ì¼ë°˜ì ì¸ ë¹„ë°€ë²ˆí˜¸</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">password</span> <span class="ow">in</span> <span class="n">weak_passwords</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/register&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test2@example.com&quot;</span><span class="p">,</span>
                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span><span class="p">,</span> \
                <span class="sa">f</span><span class="s2">&quot;Weak password accepted: </span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestAuthorizationSecurity</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì¸ê°€ ë° ì ‘ê·¼ ì œì–´ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_unauthenticated_access_denied</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ë³´í˜¸ëœ ì—”ë“œí¬ì¸íŠ¸ëŠ” ë¯¸ì¸ì¦ ìš”ì²­ì„ ê±°ë¶€í•´ì•¼ í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
        <span class="n">protected_endpoints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/api/v1/users/me&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;/api/v1/users/me&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/api/v1/users/&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/api/v1/admin/stats&quot;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">protected_endpoints</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="mi">403</span><span class="p">),</span> \
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> accessible without auth&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_expired_token_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ë§Œë£Œëœ í† í°ì€ ê±°ë¶€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">app.services.token_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_access_token</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>

        <span class="n">expired_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
            <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;test-id&quot;</span><span class="p">,</span>
            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
            <span class="n">expires_delta</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;/api/v1/users/me&quot;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">expired_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_malformed_token_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ì˜ëª»ëœ í˜•ì‹ì˜ í† í°ì€ ê±°ë¶€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
        <span class="n">malformed_tokens</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;not-a-jwt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eyJ.eyJ.invalid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Bearer &quot;</span><span class="p">,</span>
            <span class="s2">&quot;null&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">malformed_tokens</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;/api/v1/users/me&quot;</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestInputValidation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì…ë ¥ ê²€ì¦ ë° ì‚´ê· ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_sql_injection_in_login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;SQL ì¸ì ì…˜ í˜ì´ë¡œë“œê°€ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
        <span class="n">payloads</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;&#39; OR &#39;1&#39;=&#39;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&#39;; DROP TABLE users; --&quot;</span><span class="p">,</span>
            <span class="s2">&quot;admin&#39;--&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">payload</span> <span class="ow">in</span> <span class="n">payloads</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/login&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">,</span>
                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="mi">422</span><span class="p">),</span> \
                <span class="sa">f</span><span class="s2">&quot;SQLi payload caused error: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_xss_in_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ì‚¬ìš©ìëª…ì˜ XSS í˜ì´ë¡œë“œê°€ ê±°ë¶€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/register&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;xss@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;SafePassword123!&quot;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_oversized_input_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ê³¼ë„í•˜ê²Œ í° ì…ë ¥ì€ ê±°ë¶€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/register&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;big@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;BigPassword123!&quot;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestSecurityHeaders</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ë³´ì•ˆ í—¤ë” ì¡´ì¬ ì—¬ë¶€ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_security_headers_present</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ëª¨ë“  ë³´ì•ˆ í—¤ë”ê°€ ì„¤ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Frame-Options&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;DENY&quot;</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Content-Type-Options&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;nosniff&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;strict-origin&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Referrer-Policy&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Security-Policy&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_no_server_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Server í—¤ë”ê°€ êµ¬í˜„ ì„¸ë¶€ì‚¬í•­ì„ ë…¸ì¶œí•˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;server&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s2">&quot;uvicorn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s2">&quot;python&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestErrorHandling</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ì—ëŸ¬ ì²˜ë¦¬ê°€ ì •ë³´ë¥¼ ìœ ì¶œí•˜ì§€ ì•ŠëŠ”ì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_404_no_info_leak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">,</span> <span class="n">auth_headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;404 ì—ëŸ¬ê°€ ë‚´ë¶€ ê²½ë¡œë¥¼ ë…¸ì¶œí•˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;/api/v1/nonexistent&quot;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">auth_headers</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s2">&quot;/app/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s2">&quot;traceback&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s2">&quot;Traceback&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_500_no_stack_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;500 ì—ëŸ¬ê°€ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ë¥¼ ë…¸ì¶œí•˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">assert</span> <span class="s2">&quot;traceback&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">assert</span> <span class="s2">&quot;File &quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="14">14. ë°°í¬ ê³ ë ¤ì‚¬í•­<a class="header-link" href="#14" title="Permanent link">&para;</a></h2>
<h3 id="141">14.1 í”„ë¡œë•ì…˜ ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸<a class="header-link" href="#141" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              í”„ë¡œë•ì…˜ ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  HTTPS / TLS:                                                     â”‚
â”‚  [ ] TLS 1.2+ ì „ìš© (TLS 1.0, 1.1 ë¹„í™œì„±í™”)                     â”‚
â”‚  [ ] ê°•ë ¥í•œ ì•”í˜¸í™” ìŠ¤ìœ„íŠ¸                                         â”‚
â”‚  [ ] ìœ íš¨í•œ SSL ì¸ì¦ì„œ (Let&#39;s Encrypt ë˜ëŠ” CA ì„œëª…)              â”‚
â”‚  [ ] HSTS í—¤ë” í™œì„±í™”                                             â”‚
â”‚  [ ] HTTP â†’ HTTPS ë¦¬ë‹¤ì´ë ‰íŠ¸                                      â”‚
â”‚                                                                   â”‚
â”‚  ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ (nginx):                                           â”‚
â”‚  [ ] ë°±ì—”ë“œ ì„œë²„ í—¤ë” ìˆ¨ê¹€                                        â”‚
â”‚  [ ] í”„ë¡ì‹œ ë ˆë²¨ ì†ë„ ì œí•œ                                        â”‚
â”‚  [ ] ìš”ì²­ ë³¸ë¬¸ í¬ê¸° ì œí•œ                                          â”‚
â”‚  [ ] íƒ€ì„ì•„ì›ƒ ì„¤ì •                                                â”‚
â”‚  [ ] ì ‘ê·¼ ë¡œê¹…                                                    â”‚
â”‚                                                                   â”‚
â”‚  ì• í”Œë¦¬ì¼€ì´ì…˜:                                                     â”‚
â”‚  [ ] DEBUG = False                                                â”‚
â”‚  [ ] í”„ë¡œë•ì…˜ì—ì„œ API ë¬¸ì„œ ë¹„í™œì„±í™”                                â”‚
â”‚  [ ] í™˜ê²½ ë³€ìˆ˜ / ì‹œí¬ë¦¿ ë§¤ë‹ˆì €ì—ì„œ ë¹„ë°€ ê´€ë¦¬                      â”‚
â”‚  [ ] ëª¨ë“  ì˜ì¡´ì„± ê³ ì • ë° ê°ì‚¬ ì™„ë£Œ                                 â”‚
â”‚  [ ] ì—ëŸ¬ ì²˜ë¦¬: ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ë¯¸ë…¸ì¶œ                               â”‚
â”‚  [ ] ë¡œê¹…: êµ¬ì¡°í™”, PII/ë¹„ë°€ ë¯¸í¬í•¨                                â”‚
â”‚                                                                   â”‚
â”‚  ë°ì´í„°ë² ì´ìŠ¤:                                                     â”‚
â”‚  [ ] DB ì‚¬ìš©ìì— ê°•ë ¥í•œ ë¹„ë°€ë²ˆí˜¸                                   â”‚
â”‚  [ ] ìµœì†Œ DB ê¶Œí•œ (admin/superuser ì•„ë‹˜)                          â”‚
â”‚  [ ] ì•”í˜¸í™”ëœ ì—°ê²° (SSL/TLS)                                      â”‚
â”‚  [ ] ì •ê¸° ë°±ì—…                                                    â”‚
â”‚  [ ] ì»¤ë„¥ì…˜ í’€ë§ ì„¤ì •                                             â”‚
â”‚                                                                   â”‚
â”‚  ì¸í”„ë¼:                                                           â”‚
â”‚  [ ] ë°©í™”ë²½: í•„ìš”í•œ í¬íŠ¸ë§Œ ê°œë°©                                    â”‚
â”‚  [ ] SSH í‚¤ ê¸°ë°˜ ì¸ì¦ë§Œ í—ˆìš©                                       â”‚
â”‚  [ ] ì •ê¸°ì ì¸ OS íŒ¨ì¹˜                                              â”‚
â”‚  [ ] ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ì„¤ì •                                         â”‚
â”‚  [ ] ë¡œê·¸ ì§‘ê³„ (ELK, Datadog ë“±)                                  â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="142-nginx">14.2 Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì •<a class="header-link" href="#142-nginx" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># /etc/nginx/sites-available/secure-api</span>

<span class="c1"># HTTPë¥¼ HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸</span>
<span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">api.example.com</span><span class="p">;</span>
<span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="s">https://</span><span class="nv">$server_name$request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1"># HTTPS ì„œë²„</span>
<span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="w"> </span><span class="s">http2</span><span class="p">;</span>
<span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">api.example.com</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># SSL ì„¤ì •</span>
<span class="w">    </span><span class="kn">ssl_certificate</span><span class="w"> </span><span class="s">/etc/letsencrypt/live/api.example.com/fullchain.pem</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_certificate_key</span><span class="w"> </span><span class="s">/etc/letsencrypt/live/api.example.com/privkey.pem</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_protocols</span><span class="w"> </span><span class="s">TLSv1.2</span><span class="w"> </span><span class="s">TLSv1.3</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_ciphers</span><span class="w"> </span><span class="s">ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_prefer_server_ciphers</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_session_cache</span><span class="w"> </span><span class="s">shared:SSL:10m</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_session_timeout</span><span class="w"> </span><span class="mi">10m</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># ë³´ì•ˆ í—¤ë”</span>
<span class="w">    </span><span class="kn">add_header</span><span class="w"> </span><span class="s">X-Frame-Options</span><span class="w"> </span><span class="s">&quot;DENY&quot;</span><span class="w"> </span><span class="s">always</span><span class="p">;</span>
<span class="w">    </span><span class="kn">add_header</span><span class="w"> </span><span class="s">X-Content-Type-Options</span><span class="w"> </span><span class="s">&quot;nosniff&quot;</span><span class="w"> </span><span class="s">always</span><span class="p">;</span>
<span class="w">    </span><span class="kn">add_header</span><span class="w"> </span><span class="s">Strict-Transport-Security</span><span class="w"> </span><span class="s">&quot;max-age=31536000</span><span class="p">;</span><span class="w"> </span><span class="kn">includeSubDomains&quot;</span><span class="w"> </span><span class="s">always</span><span class="p">;</span>

<span class="w">    </span><span class="kn">server_tokens</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># ìš”ì²­ ì œí•œ</span>
<span class="w">    </span><span class="kn">client_max_body_size</span><span class="w"> </span><span class="mi">10m</span><span class="p">;</span>
<span class="w">    </span><span class="kn">client_body_timeout</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<span class="w">    </span><span class="kn">client_header_timeout</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># ì†ë„ ì œí•œ ì¡´</span>
<span class="w">    </span><span class="kn">limit_req_zone</span><span class="w"> </span><span class="nv">$binary_remote_addr</span><span class="w"> </span><span class="s">zone=api:10m</span><span class="w"> </span><span class="s">rate=60r/m</span><span class="p">;</span>

<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kn">limit_req</span><span class="w"> </span><span class="s">zone=api</span><span class="w"> </span><span class="s">burst=20</span><span class="w"> </span><span class="s">nodelay</span><span class="p">;</span>

<span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://127.0.0.1:8000</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w"> </span><span class="nv">$remote_addr</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-Proto</span><span class="w"> </span><span class="nv">$scheme</span><span class="p">;</span>

<span class="w">        </span><span class="kn">proxy_connect_timeout</span><span class="w"> </span><span class="s">5s</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_read_timeout</span><span class="w"> </span><span class="s">30s</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_send_timeout</span><span class="w"> </span><span class="s">30s</span><span class="p">;</span>

<span class="w">        </span><span class="kn">proxy_hide_header</span><span class="w"> </span><span class="s">X-Powered-By</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1"># ì¼ë°˜ì ì¸ ê³µê²© ê²½ë¡œ ì°¨ë‹¨</span>
<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">/\.(git|svn|env|htaccess)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kn">deny</span><span class="w"> </span><span class="s">all</span><span class="p">;</span>
<span class="w">        </span><span class="kn">return</span><span class="w"> </span><span class="mi">404</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kn">access_log</span><span class="w"> </span><span class="s">/var/log/nginx/api_access.log</span><span class="p">;</span>
<span class="w">    </span><span class="kn">error_log</span><span class="w"> </span><span class="s">/var/log/nginx/api_error.log</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="143-docker">14.3 Docker ë°°í¬<a class="header-link" href="#143-docker" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c"># Dockerfile - ë” ì‘ì€ ì´ë¯¸ì§€ë¥¼ ìœ„í•œ ë©€í‹° ìŠ¤í…Œì´ì§€ ë¹Œë“œ</span>

<span class="c"># 1ë‹¨ê³„: ì˜ì¡´ì„± ë¹Œë“œ</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.12-slim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">builder</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/build</span>
<span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span>.
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>--prefix<span class="o">=</span>/install<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="c"># 2ë‹¨ê³„: í”„ë¡œë•ì…˜ ì´ë¯¸ì§€</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.12-slim</span>

<span class="c"># ë³´ì•ˆ: ë¹„ë£¨íŠ¸ ì‚¬ìš©ìë¡œ ì‹¤í–‰</span>
<span class="k">RUN</span><span class="w"> </span>groupadd<span class="w"> </span>-r<span class="w"> </span>appuser<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>useradd<span class="w"> </span>-r<span class="w"> </span>-g<span class="w"> </span>appuser<span class="w"> </span>-d<span class="w"> </span>/app<span class="w"> </span>-s<span class="w"> </span>/sbin/nologin<span class="w"> </span>appuser

<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/install<span class="w"> </span>/usr/local

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<span class="k">COPY</span><span class="w"> </span>app/<span class="w"> </span>./app/
<span class="k">COPY</span><span class="w"> </span>alembic/<span class="w"> </span>./alembic/
<span class="k">COPY</span><span class="w"> </span>alembic.ini<span class="w"> </span>.

<span class="k">RUN</span><span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span>appuser:appuser<span class="w"> </span>/app

<span class="k">USER</span><span class="w"> </span><span class="s">appuser</span>

<span class="k">ENV</span><span class="w"> </span><span class="nv">PYTHONUNBUFFERED</span><span class="o">=</span><span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">PYTHONDONTWRITEBYTECODE</span><span class="o">=</span><span class="m">1</span>

<span class="k">HEALTHCHECK</span><span class="w"> </span>--interval<span class="o">=</span>30s<span class="w"> </span>--timeout<span class="o">=</span>5s<span class="w"> </span>--retries<span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="k">CMD</span><span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import urllib.request; urllib.request.urlopen(&#39;http://localhost:8000/health&#39;)&quot;</span>

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;uvicorn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;app.main:app&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--host&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--port&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;8000&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--workers&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;4&quot;</span><span class="p">]</span>
</code></pre></div>

<hr />
<h2 id="15">15. ì—°ìŠµ ë¬¸ì œ<a class="header-link" href="#15" title="Permanent link">&para;</a></h2>
<h3 id="1-auth-service">ì—°ìŠµ ë¬¸ì œ 1: Auth Service êµ¬í˜„<a class="header-link" href="#1-auth-service" title="Permanent link">&para;</a></h3>
<p>ë‹¤ìŒì„ ì²˜ë¦¬í•˜ëŠ” <code>AuthService</code> í´ë˜ìŠ¤ë¥¼ ì™„ì„±í•˜ì„¸ìš”:
1. Argon2 ë¹„ë°€ë²ˆí˜¸ í•´ì‹±ì„ ì‚¬ìš©í•œ ì‚¬ìš©ì ìƒì„±
2. ì¸ì¦ (ì´ë©”ì¼ + ë¹„ë°€ë²ˆí˜¸ í™•ì¸)
3. í† í° ìŒ ìƒì„± ë° ë¦¬í”„ë ˆì‹œ í† í° DB ì €ì¥
4. ë¦¬í”„ë ˆì‹œ í† í° ë¡œí…Œì´ì…˜ ë° íê¸°
5. NíšŒ ì‹¤íŒ¨ í›„ ê³„ì • ì ê¸ˆ</p>
<h3 id="2-2">ì—°ìŠµ ë¬¸ì œ 2: 2ë‹¨ê³„ ì¸ì¦ ì¶”ê°€<a class="header-link" href="#2-2" title="Permanent link">&para;</a></h3>
<p>ì¸ì¦ ì‹œìŠ¤í…œì„ TOTP ê¸°ë°˜ 2FAë¥¼ ì§€ì›í•˜ë„ë¡ í™•ì¥í•˜ì„¸ìš”:
1. QR ì½”ë“œ URLì„ ë°˜í™˜í•˜ëŠ” <code>/auth/2fa/setup</code> ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
2. ì„¤ì •ì„ í™•ì¸í•˜ëŠ” <code>/auth/2fa/verify</code> ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
3. 2FA í™œì„±í™” ì‹œ ë¡œê·¸ì¸ì— TOTP ì½”ë“œ ìš”êµ¬í•˜ë„ë¡ ìˆ˜ì •
4. ê³„ì • ë³µêµ¬ìš© ë°±ì—… ì½”ë“œ ì¶”ê°€</p>
<h3 id="3-api">ì—°ìŠµ ë¬¸ì œ 3: API í‚¤ ì¸ì¦<a class="header-link" href="#3-api" title="Permanent link">&para;</a></h3>
<p>JWTì™€ í•¨ê»˜ API í‚¤ ì¸ì¦ ì§€ì›ì„ ì¶”ê°€í•˜ì„¸ìš”:
1. API í‚¤ë¥¼ ìƒì„±í•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ ì‘ì„±
2. <code>X-API-Key</code> í—¤ë”ë¥¼ í†µí•œ API í‚¤ ì¸ì¦ ì§€ì›
3. í‚¤ë³„ ì†ë„ ì œí•œ êµ¬í˜„
4. API í‚¤ ë¡œí…Œì´ì…˜ ì§€ì› ì¶”ê°€
5. ëª¨ë“  API í‚¤ ì‚¬ìš© ë¡œê¹…</p>
<h3 id="4">ì—°ìŠµ ë¬¸ì œ 4: ì™„ì „í•œ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸<a class="header-link" href="#4" title="Permanent link">&para;</a></h3>
<p>ë‹¤ìŒì„ ë‹¤ë£¨ëŠ” ì¶”ê°€ í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”:
1. í† í° ê°±ì‹  í”Œë¡œìš° (ë¡œí…Œì´ì…˜ í¬í•¨)
2. ì‹¤íŒ¨ í›„ ê³„ì • ì ê¸ˆ
3. RBAC: ê° ì—­í• ì´ í—ˆìš©ëœ ì—”ë“œí¬ì¸íŠ¸ì—ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•œì§€ í™•ì¸
4. ì†ë„ ì œí•œ: ì œí•œì´ ì ìš©ë˜ëŠ”ì§€ í™•ì¸
5. CORS: í—ˆìš©ëœ ì¶œì²˜ë§Œ APIì— ì ‘ê·¼ ê°€ëŠ¥í•œì§€ í™•ì¸</p>
<h3 id="5">ì—°ìŠµ ë¬¸ì œ 5: ë³´ì•ˆ ê°ì‚¬<a class="header-link" href="#5" title="Permanent link">&para;</a></h3>
<p>ì „ì²´ í”„ë¡œì íŠ¸ì˜ ë³´ì•ˆ ê°ì‚¬ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”:
1. ëª¨ë“  ì†ŒìŠ¤ íŒŒì¼ì— ëŒ€í•´ Bandit ì‹¤í–‰
2. requirements.txtì— ëŒ€í•´ pip-audit ì‹¤í–‰
3. í•˜ë“œì½”ë”©ëœ ë¹„ë°€ ê²€ì‚¬
4. ëª¨ë“  ì—ëŸ¬ ì‘ë‹µì˜ ì •ë³´ ìœ ì¶œ ê²€í† 
5. ëª¨ë“  ì…ë ¥ ê²€ì¦ì´ í¬ê´„ì ì¸ì§€ í™•ì¸
6. ë°œê²¬ ì‚¬í•­ì„ ë¬¸ì„œí™”í•˜ê³  ìˆ˜ì • ë°©ë²• ì‘ì„±</p>
<h3 id="6">ì—°ìŠµ ë¬¸ì œ 6: í”„ë¡œë•ì…˜ ë°°í¬<a class="header-link" href="#6" title="Permanent link">&para;</a></h3>
<p>APIë¥¼ í´ë¼ìš°ë“œ ì œê³µì (ë˜ëŠ” ë¡œì»¬ Docker)ì— ë°°í¬í•˜ì„¸ìš”:
1. SSLì´ ì ìš©ëœ PostgreSQL ì„¤ì •
2. TLSê°€ ì ìš©ëœ nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì •
3. êµ¬ì¡°í™”ëœ ë¡œê·¸ ì§‘ê³„ ì„¤ì •
4. ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ì„¤ì •
5. ë°°í¬ëœ APIì— ëŒ€í•´ ë³´ì•ˆ ìŠ¤ìº” (ZAP ë² ì´ìŠ¤ë¼ì¸) ì‹¤í–‰
6. ë°°í¬ ì•„í‚¤í…ì²˜ ë¬¸ì„œí™”</p>
<hr />
<h2 id="_2">ìš”ì•½<a class="header-link" href="#_2" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ë³´ì•ˆ API í•µì‹¬ ìš”ì•½                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  1. ì‹¬ì¸µ ë°©ì–´: ë‹¨ì¼ì´ ì•„ë‹Œ ë‹¤ì¤‘ ë³´ì•ˆ ê³„ì¸µ                         â”‚
â”‚  2. Argon2id: SHA/MD5/bcryptê°€ ì•„ë‹Œ ì ì ˆí•œ ë¹„ë°€ë²ˆí˜¸ í•´ì‹± ì‚¬ìš©    â”‚
â”‚  3. JWT: ë‹¨ê¸° ì•¡ì„¸ìŠ¤ í† í° + ë¡œí…Œì´ì…˜ë˜ëŠ” ë¦¬í”„ë ˆì‹œ í† í°            â”‚
â”‚  4. RBAC: ì„¸ë¶„í™”ëœ ê¶Œí•œ, ìµœì†Œ ê¶Œí•œ ì›ì¹™                           â”‚
â”‚  5. ì…ë ¥ ê²€ì¦: ëª¨ë“  ì™¸ë¶€ ì…ë ¥ì„ ê²€ì¦í•˜ê³  ì‚´ê·                      â”‚
â”‚  6. ì†ë„ ì œí•œ: ë¡œê·¸ì¸, ë“±ë¡, ëª¨ë“  API ë³´í˜¸                        â”‚
â”‚  7. ë³´ì•ˆ í—¤ë”: HSTS, CSP, X-Frame-Optionsë¥¼ ëª¨ë“  ì‘ë‹µì— ì ìš©      â”‚
â”‚  8. ì—ëŸ¬ ì²˜ë¦¬: ì‚¬ìš©ìì—ê²Œ ì¼ë°˜ì  ì—ëŸ¬, ë‚´ë¶€ì ìœ¼ë¡œ ìƒì„¸ ë¡œê·¸       â”‚
â”‚  9. ë¡œê¹…: êµ¬ì¡°í™”ëœ ê°ì‚¬ ë¡œê·¸, ë¹„ë°€ì´ë‚˜ PII ë¯¸ë¡œê¹…                 â”‚
â”‚ 10. í…ŒìŠ¤íŒ…: ë³´ì•ˆ í…ŒìŠ¤íŠ¸ëŠ” ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ë§Œí¼ ì¤‘ìš”                    â”‚
â”‚ 11. ë°°í¬: HTTPS, ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ, ë¹„ë£¨íŠ¸ ì»¨í…Œì´ë„ˆ                   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<p><strong>ì´ì „</strong>: <a href="14_Incident_Response.md">14. ì‚¬ê³  ëŒ€ì‘ê³¼ í¬ë Œì‹</a> | <strong>ë‹¤ìŒ</strong>: <a href="16_Project_Vulnerability_Scanner.md">16. í”„ë¡œì íŠ¸: ì·¨ì•½ì  ìŠ¤ìºë„ˆ êµ¬ì¶•</a></p>
    </div>

    
<div class="lesson-toolbar lesson-toolbar--bottom">
    <div class="toolbar-nav toolbar-nav--prev">
        
        <a href="/study/ko/Security/14_Incident_Response.html" class="nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">ì‚¬ê³  ëŒ€ì‘ ë° í¬ë Œì‹</span>
        </a>
        
    </div>
    <div class="toolbar-actions">
        <button class="btn btn-copy-link" data-action="copy-link" title="Copy link">
            <span class="icon">ğŸ”—</span>
            <span class="text">Copy link</span>
        </button>
        <a href="/study/ko/Security/" class="btn btn-topic-link" title="Back to topic list">
            <span class="icon">ğŸ“‹</span>
            <span class="text">Topic list</span>
        </a>
    </div>
    <div class="toolbar-nav toolbar-nav--next">
        
        <a href="/study/ko/Security/16_Project_Vulnerability_Scanner.html" class="nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">í”„ë¡œì íŠ¸: ì·¨ì•½ì  ìŠ¤ìºë„ˆ êµ¬ì¶•</span>
        </a>
        
    </div>
</div>


    <div class="toolbar-keyboard-hint">
        <kbd>&larr;</kbd> <kbd>&rarr;</kbd> to navigate between lessons
    </div>
</article>

<!-- Scroll to top floating button -->
<button class="scroll-to-top" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">â†‘</button>

            </div>
        </main>
    </div>

    <script src="/study/static/js/app.js"></script>
    <script>
        function switchLanguage(newLang) {
            const path = window.location.pathname;
            const base = '/study';
            const currentLang = 'ko';
            const newPath = path.replace(base + '/' + currentLang + '/', base + '/' + newLang + '/');
            window.location.href = newPath + window.location.search;
        }
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy link - independent feedback per button
        document.querySelectorAll('[data-action="copy-link"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(window.location.href);
                var textEl = this.querySelector('.text');
                var originalText = textEl.textContent;
                textEl.textContent = 'Copied!';
                setTimeout(function() { textEl.textContent = originalText; }, 2000);
            });
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('.lesson-content pre').forEach(function(pre) {
            var copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy'; }, 2000);
            });
            pre.style.position = 'relative';
            pre.appendChild(copyBtn);
        });

        // Scroll to top button
        var scrollBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', function() {
            scrollBtn.classList.toggle('visible', window.scrollY > 300);
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Keyboard shortcuts: left/right arrows for lesson navigation
        document.addEventListener('keydown', function(e) {
            var tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            if (e.key === 'ArrowLeft') {
                var prevLink = document.querySelector('.nav-prev');
                if (prevLink) prevLink.click();
            } else if (e.key === 'ArrowRight') {
                var nextLink = document.querySelector('.nav-next');
                if (nextLink) nextLink.click();
            }
        });
    });
</script>

</body>
</html>
{% endraw %}